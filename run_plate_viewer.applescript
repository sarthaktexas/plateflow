-- AppleScript to run plate_viewer.py
-- The Python code is embedded directly in this script (base64 encoded)
-- Required packages will be installed automatically if needed

on run {input, parameters}
	try
		-- Get the selected folder from Finder or Automator
		if input is {} or input is missing value or (count of input) = 0 then
			set selectedFolder to choose folder with prompt "Select a folder containing .xlsx files:"
			if selectedFolder is {} then
				return
			end if
		else
			set selectedFolder to item 1 of input
		end if
		
		-- Get the folder path
		set folderPath to POSIX path of selectedFolder
		
		-- Remove trailing slash if present
		if folderPath ends with "/" then
			set folderPath to text 1 thru -2 of folderPath
		end if
		
		-- Install required Python packages if needed
		set requiredPackages to "pandas numpy scipy matplotlib openpyxl"
		
		-- Try installation with different methods (in order of preference)
		set installSuccess to false
		set lastError to ""
		
		-- Method 1: Try with --user flag (works on most systems, safest)
		try
			do shell script "python3 -m pip install --user " & requiredPackages & " 2>&1"
			set installSuccess to true
		on error installError1
			set lastError to installError1
			-- Method 2: Check Python version and try with --break-system-packages if supported
			try
				set pythonVersion to (do shell script "python3 --version 2>&1 | awk '{print $2}'")
				set pythonMajor to (do shell script "echo " & quoted form of pythonVersion & " | cut -d. -f1")
				set pythonMinor to (do shell script "echo " & quoted form of pythonVersion & " | cut -d. -f2")
				
				if (pythonMajor as integer) >= 3 and (pythonMinor as integer) >= 11 then
					-- Python 3.11+, try with --break-system-packages --user
					try
						do shell script "python3 -m pip install --break-system-packages --user " & requiredPackages & " 2>&1"
						set installSuccess to true
					on error installError2
						set lastError to installError2
						-- Try with --break-system-packages without --user
						try
							do shell script "python3 -m pip install --break-system-packages " & requiredPackages & " 2>&1"
							set installSuccess to true
						on error installError3
							set lastError to installError3
						end try
					end try
				end if
			on error
				-- Version check failed, continue to next method
			end try
			
			-- Method 3: If still not successful, try without any flags (may work if pip is configured)
			if not installSuccess then
				try
					do shell script "python3 -m pip install " & requiredPackages & " 2>&1"
					set installSuccess to true
				on error installError4
					set lastError to installError4
				end try
			end if
			
			-- If all methods failed, show warning but continue
			if not installSuccess then
				display alert "Warning" message "Could not install required packages automatically.\n\nLast error: " & lastError & "\n\nPlease install manually: " & requiredPackages & "\n\nRun: python3 -m pip install --user " & requiredPackages buttons {"Continue", "Cancel"} default button "Continue" as warning
				if button returned of result is "Cancel" then
					return
				end if
			end if
		end try
		
		-- Embedded Python code (base64 encoded)
		set pythonCodeBase64 to "IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwppbXBvcnQgb3MKaW1wb3J0IHN5cwppbXBvcnQganNvbgpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0CgppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCBudW1weSBhcyBucAoKIyAtLS0tLSBDT05GSUcgLS0tLS0KIyAzODQtd2VsbCBwbGF0ZTogMTYgcm93cyAoQS1QKSB4IDI0IGNvbHVtbnM7IGNoYW5nZSBpZiBuZWVkZWQuClBMQVRFX1JPV1MgPSAiQUJDREVGR0hJSktMTU5PUCIgICMgMTYgcm93cwpQTEFURV9DT0xTID0gMjQKClNIRUVUX05BTUVfUFJFRkVSUkVEID0gIlRhYmxlIEFsbCBEYXRhIHBvaW50cyIgICMgZnJvbSB5b3VyIGV4YW1wbGUKCiMgRGVmYXVsdCB3ZWxsIGxhYmVscyBhbmQgdHJpcGxpY2F0ZSBncm91cHMKREVGQVVMVF9XRUxMX0xBQkVMUyA9IHsKICAgICJCMTMiOiAiMjUwLTEwLTIiLAogICAgIkMxMyI6ICIyNTAtMTAtMiIsCiAgICAiRDEzIjogIjI1MC0xMC0yIiwKICAgICJFMTMiOiAiNTAwLTEwLTIiLAogICAgIkYxMyI6ICI1MDAtMTAtMiIsCiAgICAiRzEzIjogIjUwMC0xMC0yIiwKICAgICJIMTMiOiAiMjUwLTUtMiIsCiAgICAiSTEzIjogIjI1MC01LTIiLAogICAgIkoxMyI6ICIyNTAtNS0yIiwKICAgICJLMTMiOiAiNTAwLTUtMiIsCiAgICAiTDEzIjogIjUwMC01LTIiLAogICAgIk0xMyI6ICI1MDAtNS0yIiwKICAgICJOMTMiOiAiNTAwLTEwLTIiLAogICAgIk8xMyI6ICI1MDAtNS0yIgp9CgpERUZBVUxUX1RSSVBMSUNBVEVfR1JPVVBTID0gWwogICAgewogICAgICAgICJuYW1lIjogIjI1MC0xMC0yIiwKICAgICAgICAid2VsbHMiOiBbIkIiLCAiQyIsICJEIl0KICAgIH0sCiAgICB7CiAgICAgICAgIm5hbWUiOiAiNTAwLTEwLTIiLAogICAgICAgICJ3ZWxscyI6IFsiRSIsICJGIiwgIkciXQogICAgfSwKICAgIHsKICAgICAgICAibmFtZSI6ICIyNTAtNS0yIiwKICAgICAgICAid2VsbHMiOiBbIkgiLCAiSSIsICJKIl0KICAgIH0sCiAgICB7CiAgICAgICAgIm5hbWUiOiAiNTAwLTUtMiIsCiAgICAgICAgIndlbGxzIjogWyJLIiwgIkwiLCAiTSJdCiAgICB9Cl0KCiMgQ29sb3IgcGFsZXR0ZSBmb3IgdHJpcGxpY2F0ZSBncm91cHMgLSBtYXRjaGVzIHdlYiBpbnRlcmZhY2UKIyBFYWNoIGdyb3VwIGdldHMgYSBkaXN0aW5jdCBjb2xvciAodXNpbmcgYm9yZGVyIGNvbG9yIGZvciBwbG90cykKVFJJUExJQ0FURV9DT0xPUlMgPSBbCiAgICAiI2ZmNmI2YiIsICAjIFJlZAogICAgIiM0ZWNkYzQiLCAgIyBUZWFsCiAgICAiIzQ1YjdkMSIsICAjIEJsdWUKICAgICIjZjljYTI0IiwgICMgWWVsbG93CiAgICAiIzZjNWNlNyIsICAjIFB1cnBsZQogICAgIiNhMjliZmUiLCAgIyBMaWdodCBQdXJwbGUKICAgICIjZmQ3OWE4IiwgICMgUGluawogICAgIiMwMGI4OTQiLCAgIyBHcmVlbgogICAgIiNlMTcwNTUiLCAgIyBPcmFuZ2UKICAgICIjNzRiOWZmIiwgICMgTGlnaHQgQmx1ZQogICAgIiM1NWVmYzQiLCAgIyBNaW50CiAgICAiI2ZkY2I2ZSIgICAjIExpZ2h0IE9yYW5nZQpdCgpkZWYgaXNfY29udHJvbF93ZWxsKHdlbGxfaWQ6IHN0ciwgY29udHJvbF9yb3dzOiBMaXN0W3N0cl0gPSBOb25lKSAtPiBib29sOgogICAgIiIiCiAgICBDaGVjayBpZiBhIHdlbGwgaXMgYSBjb250cm9sIHdlbGwuCiAgICBEZWZhdWx0IGNvbnRyb2wgcm93cyBhcmUgTiBhbmQgTywgYnV0IHRoaXMgY2FuIGJlIGNvbmZpZ3VyZWQgdmlhIGNvbnRyb2xfcm93cyBwYXJhbWV0ZXIuCiAgICBDb250cm9sIHdlbGxzIHNob3VsZCBiZSBpbmRlcGVuZGVudGx5IHNlbGVjdGFibGUgYW5kIG5vdCBncm91cGVkIGFzIHRyaXBsaWNhdGVzLgogICAgIiIiCiAgICBpZiBub3Qgd2VsbF9pZDoKICAgICAgICByZXR1cm4gRmFsc2UKICAgIGlmIGNvbnRyb2xfcm93cyBpcyBOb25lOgogICAgICAgIGNvbnRyb2xfcm93cyA9IFsiTiIsICJPIl0gICMgRGVmYXVsdCBjb250cm9sIHJvd3MKICAgIHJvd19sZXR0ZXIgPSB3ZWxsX2lkWzBdIGlmIHdlbGxfaWRbMF0uaXNhbHBoYSgpIGVsc2UgIiIKICAgIHJldHVybiByb3dfbGV0dGVyIGluIGNvbnRyb2xfcm93cwoKCmRlZiB2YWxpZGF0ZV9maWxlbmFtZV9mb3JtYXQoZmlsZW5hbWU6IHN0cik6CiAgICAiIiIKICAgIFZhbGlkYXRlIHRoYXQgZmlsZW5hbWUgbWF0Y2hlcyB0aGUgZXhwZWN0ZWQgZm9ybWF0OgogICAgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJbX3NjaWVudGlzdF1bX251bWJlcl0ueGxzeAogICAgCiAgICBFeHBlY3RlZCBmb3JtYXQ6IEF0IGxlYXN0IDMgdW5kZXJzY29yZS1zZXBhcmF0ZWQgcGFydHMgYmVmb3JlIHRoZSAueGxzeCBleHRlbnNpb24uCiAgICBFeGFtcGxlczoKICAgIC0gUExDYl9XVF9DYV9NQy54bHN4ICg0IHBhcnRzKQogICAgLSBQTENiX1dUX0NhX01DXzEzLnhsc3ggKDUgcGFydHMpCiAgICAtIFBMQ2JfSDMzMkFfQ2FfU01fMTIueGxzeCAoNSBwYXJ0cykKICAgIAogICAgUmFpc2VzIFZhbHVlRXJyb3IgaWYgZm9ybWF0IGlzIGludmFsaWQuCiAgICAiIiIKICAgIGlmIG5vdCBmaWxlbmFtZS5sb3dlcigpLmVuZHN3aXRoKCcueGxzeCcpOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiSW52YWxpZCBmaWxlbmFtZSBmb3JtYXQ6ICd7ZmlsZW5hbWV9J1xuIgogICAgICAgICAgICBmIkV4cGVjdGVkIGZvcm1hdDogcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJbX3NjaWVudGlzdF1bX251bWJlcl0ueGxzeFxuIgogICAgICAgICAgICBmIkZpbGVuYW1lIG11c3QgZW5kIHdpdGggLnhsc3ggZXh0ZW5zaW9uLiIKICAgICAgICApCiAgICAKICAgICMgUmVtb3ZlIC54bHN4IGV4dGVuc2lvbgogICAgYmFzZV9uYW1lID0gb3MucGF0aC5zcGxpdGV4dChmaWxlbmFtZSlbMF0KICAgIAogICAgIyBTcGxpdCBieSB1bmRlcnNjb3JlCiAgICBwYXJ0cyA9IGJhc2VfbmFtZS5zcGxpdCgiXyIpCiAgICAKICAgIGlmIGxlbihwYXJ0cykgPCAzOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiSW52YWxpZCBmaWxlbmFtZSBmb3JtYXQ6ICd7ZmlsZW5hbWV9J1xuIgogICAgICAgICAgICBmIkV4cGVjdGVkIGZvcm1hdDogcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJbX3NjaWVudGlzdF1bX251bWJlcl0ueGxzeFxuIgogICAgICAgICAgICBmIlRoZSBmaWxlbmFtZSBtdXN0IGhhdmUgYXQgbGVhc3QgMyB1bmRlcnNjb3JlLXNlcGFyYXRlZCBwYXJ0cyBiZWZvcmUgdGhlIC54bHN4IGV4dGVuc2lvbi5cbiIKICAgICAgICAgICAgZiJGb3VuZCB7bGVuKHBhcnRzKX0gcGFydChzKToge3BhcnRzfVxuIgogICAgICAgICAgICBmIkV4YW1wbGUgdmFsaWQgZm9ybWF0czpcbiIKICAgICAgICAgICAgZiIgIC0gUExDYl9XVF9DYV9NQy54bHN4XG4iCiAgICAgICAgICAgIGYiICAtIFBMQ2JfV1RfQ2FfTUNfMTMueGxzeFxuIgogICAgICAgICAgICBmIiAgLSBQTENiX0gzMzJBX0NhX1NNXzEyLnhsc3giCiAgICAgICAgKQoKCmRlZiBwYXJzZV9jb2x1bW5fZ3JvdXBfZnJvbV9maWxlbmFtZShmaWxlbmFtZTogc3RyKSAtPiBEaWN0W3N0ciwgc3RyXToKICAgICIiIgogICAgUGFyc2UgY29sdW1uIGdyb3VwIGluZm9ybWF0aW9uIGZyb20gZmlsZW5hbWUgZm9ybWF0OgogICAgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJfaW5pdGlhbHMtb2Ytc2NpZW50aXN0X2FyYml0cmFyeS1udW1iZXIueGxzeAogICAgCiAgICBSZXR1cm5zIGEgZGljdGlvbmFyeSB3aXRoOgogICAgLSAiY29sdW1uX2dyb3VwIjogInByb3RlaW5fZ2Vub3R5cGVfYnVmZmVyIiAodXNlZCBmb3IgZ3JvdXBpbmcpCiAgICAtICJwcm90ZWluIjogcHJvdGVpbiBuYW1lCiAgICAtICJnZW5vdHlwZSI6IGdlbm90eXBlCiAgICAtICJidWZmZXIiOiBidWZmZXIKICAgIC0gInNjaWVudGlzdCI6IGluaXRpYWxzLW9mLXNjaWVudGlzdAogICAgLSAibnVtYmVyIjogYXJiaXRyYXJ5LW51bWJlcgogICAgIiIiCiAgICAjIFZhbGlkYXRlIGZpbGVuYW1lIGZvcm1hdCBmaXJzdAogICAgdmFsaWRhdGVfZmlsZW5hbWVfZm9ybWF0KGZpbGVuYW1lKQogICAgCiAgICAjIFJlbW92ZSAueGxzeCBleHRlbnNpb24KICAgIGJhc2VfbmFtZSA9IG9zLnBhdGguc3BsaXRleHQoZmlsZW5hbWUpWzBdCiAgICAKICAgICMgU3BsaXQgYnkgdW5kZXJzY29yZQogICAgcGFydHMgPSBiYXNlX25hbWUuc3BsaXQoIl8iKQogICAgCiAgICAjIEF0IHRoaXMgcG9pbnQgd2Uga25vdyB3ZSBoYXZlIGF0IGxlYXN0IDMgcGFydHMgZHVlIHRvIHZhbGlkYXRpb24KICAgICMgSWYgd2UgaGF2ZSBhdCBsZWFzdCAzIHBhcnRzLCB1c2UgZmlyc3QgMyBmb3IgY29sdW1uX2dyb3VwIChwcm90ZWluX2dlbm90eXBlX2J1ZmZlcikKICAgICMgVGhpcyBoYW5kbGVzIGNhc2VzIGxpa2UgIlBMQ2JfV1RfRUdUQV9NQyIgKDQgcGFydHMpIG9yICJQTENiX1dUX0VHVEFfTUNfMTMiICg1IHBhcnRzKQogICAgcHJvdGVpbiA9IHBhcnRzWzBdCiAgICBnZW5vdHlwZSA9IHBhcnRzWzFdCiAgICBidWZmZXIgPSBwYXJ0c1syXQogICAgc2NpZW50aXN0ID0gcGFydHNbM10gaWYgbGVuKHBhcnRzKSA+IDMgZWxzZSAiIgogICAgbnVtYmVyID0gcGFydHNbNF0gaWYgbGVuKHBhcnRzKSA+IDQgZWxzZSAiIgogICAgCiAgICAjIENvbHVtbiBncm91cCBpcyBhbHdheXMgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXIgKGZpcnN0IDMgcGFydHMpCiAgICBjb2x1bW5fZ3JvdXAgPSBmIntwcm90ZWlufV97Z2Vub3R5cGV9X3tidWZmZXJ9IgogICAgCiAgICByZXR1cm4gewogICAgICAgICJjb2x1bW5fZ3JvdXAiOiBjb2x1bW5fZ3JvdXAsCiAgICAgICAgInByb3RlaW4iOiBwcm90ZWluLAogICAgICAgICJnZW5vdHlwZSI6IGdlbm90eXBlLAogICAgICAgICJidWZmZXIiOiBidWZmZXIsCiAgICAgICAgInNjaWVudGlzdCI6IHNjaWVudGlzdCwKICAgICAgICAibnVtYmVyIjogbnVtYmVyCiAgICB9CiAgICAKICAgICMgSWYgd2UgaGF2ZSBhdCBsZWFzdCAzIHBhcnRzLCB1c2UgZmlyc3QgMyBmb3IgY29sdW1uX2dyb3VwIChwcm90ZWluX2dlbm90eXBlX2J1ZmZlcikKICAgICMgVGhpcyBoYW5kbGVzIGNhc2VzIGxpa2UgIlBMQ2JfV1RfRUdUQV9NQyIgKDQgcGFydHMpIG9yICJQTENiX1dUX0VHVEFfTUNfMTMiICg1IHBhcnRzKQogICAgcHJvdGVpbiA9IHBhcnRzWzBdCiAgICBnZW5vdHlwZSA9IHBhcnRzWzFdCiAgICBidWZmZXIgPSBwYXJ0c1syXQogICAgc2NpZW50aXN0ID0gcGFydHNbM10gaWYgbGVuKHBhcnRzKSA+IDMgZWxzZSAiIgogICAgbnVtYmVyID0gcGFydHNbNF0gaWYgbGVuKHBhcnRzKSA+IDQgZWxzZSAiIgogICAgCiAgICAjIENvbHVtbiBncm91cCBpcyBhbHdheXMgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXIgKGZpcnN0IDMgcGFydHMpCiAgICBjb2x1bW5fZ3JvdXAgPSBmIntwcm90ZWlufV97Z2Vub3R5cGV9X3tidWZmZXJ9IgogICAgCiAgICByZXR1cm4gewogICAgICAgICJjb2x1bW5fZ3JvdXAiOiBjb2x1bW5fZ3JvdXAsCiAgICAgICAgInByb3RlaW4iOiBwcm90ZWluLAogICAgICAgICJnZW5vdHlwZSI6IGdlbm90eXBlLAogICAgICAgICJidWZmZXIiOiBidWZmZXIsCiAgICAgICAgInNjaWVudGlzdCI6IHNjaWVudGlzdCwKICAgICAgICAibnVtYmVyIjogbnVtYmVyCiAgICB9CiAgICAKCgpkZWYgZmluZF9oZWFkZXJfYW5kX3RpbWVfcm93cyhkZjogcGQuRGF0YUZyYW1lKSAtPiAoaW50LCBpbnQpOgogICAgIiIiCiAgICBGaW5kIHRoZSAnV2VsbCcgaGVhZGVyIHJvdyBhbmQgdGhlICdUaW1lIFtzXScgcm93LgogICAgUmV0dXJucyAoaGVhZGVyX3Jvd19pbmRleCwgdGltZV9yb3dfaW5kZXgpLgogICAgIiIiCiAgICBoZWFkZXJfcm93X2lkeCA9IE5vbmUKICAgIHRpbWVfcm93X2lkeCA9IE5vbmUKCiAgICBmb3IgaSBpbiByYW5nZShsZW4oZGYpKToKICAgICAgICBjZWxsMCA9IHN0cihkZi5pYXRbaSwgMF0pIGlmIG5vdCBwZC5pc25hKGRmLmlhdFtpLCAwXSkgZWxzZSAiIgogICAgICAgIGNlbGwxID0gc3RyKGRmLmlhdFtpLCAxXSkgaWYgbm90IHBkLmlzbmEoZGYuaWF0W2ksIDFdKSBlbHNlICIiCiAgICAgICAgaWYgY2VsbDAuc3RyaXAoKSA9PSAiV2VsbCI6CiAgICAgICAgICAgIGhlYWRlcl9yb3dfaWR4ID0gaQogICAgICAgIGlmICJUaW1lIiBpbiBjZWxsMSBhbmQgIltzXSIgaW4gY2VsbDE6CiAgICAgICAgICAgIHRpbWVfcm93X2lkeCA9IGkKCiAgICBpZiBoZWFkZXJfcm93X2lkeCBpcyBOb25lIG9yIHRpbWVfcm93X2lkeCBpcyBOb25lOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIkNvdWxkIG5vdCBmaW5kICdXZWxsJyBoZWFkZXIgcm93IG9yICdUaW1lIFtzXScgcm93IGluIEV4Y2VsIHNoZWV0LiIpCgogICAgaWYgdGltZV9yb3dfaWR4ICE9IGhlYWRlcl9yb3dfaWR4ICsgMToKICAgICAgICAjIE5vdCBmYXRhbCwgYnV0IHdhcm4gaW4gY2FzZSBmb3JtYXQgZHJpZnRzCiAgICAgICAgcHJpbnQoZiJXYXJuaW5nOiBUaW1lIHJvdyAoaW5kZXgge3RpbWVfcm93X2lkeH0pIGlzIG5vdCBkaXJlY3RseSBhZnRlciBoZWFkZXIgcm93IChpbmRleCB7aGVhZGVyX3Jvd19pZHh9KS4iLAogICAgICAgICAgICAgIGZpbGU9c3lzLnN0ZGVycikKCiAgICByZXR1cm4gaGVhZGVyX3Jvd19pZHgsIHRpbWVfcm93X2lkeAoKCmRlZiBwYXJzZV9wbGF0ZV9maWxlKHhsc3hfcGF0aDogc3RyKSAtPiBwZC5EYXRhRnJhbWU6CiAgICAiIiIKICAgIFBhcnNlIGEgc2luZ2xlIEV4Y2VsIGZpbGUgaW50byBhIGxvbmctZm9ybWF0IERhdGFGcmFtZSB3aXRoIGNvbHVtbnM6CiAgICBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgIiIiCiAgICBwcmludChmIlBhcnNpbmcge29zLnBhdGguYmFzZW5hbWUoeGxzeF9wYXRoKX0uLi4iLCBmbHVzaD1UcnVlKQogICAgdHJ5OgogICAgICAgIHByaW50KGYiICBPcGVuaW5nIEV4Y2VsIGZpbGUuLi4iLCBmbHVzaD1UcnVlKQogICAgICAgICMgRXhwbGljaXRseSB1c2Ugb3BlbnB5eGwgZW5naW5lIGZvciAueGxzeCBmaWxlcyB0byBhdm9pZCBoYW5naW5nCiAgICAgICAgeGxzID0gcGQuRXhjZWxGaWxlKHhsc3hfcGF0aCwgZW5naW5lPSdvcGVucHl4bCcpCiAgICAgICAgaWYgU0hFRVRfTkFNRV9QUkVGRVJSRUQgaW4geGxzLnNoZWV0X25hbWVzOgogICAgICAgICAgICBzaGVldF9uYW1lID0gU0hFRVRfTkFNRV9QUkVGRVJSRUQKICAgICAgICBlbHNlOgogICAgICAgICAgICBzaGVldF9uYW1lID0geGxzLnNoZWV0X25hbWVzWzBdCiAgICAgICAgICAgIHByaW50KGYiICBTaGVldCAne1NIRUVUX05BTUVfUFJFRkVSUkVEfScgbm90IGZvdW5kOyB1c2luZyBmaXJzdCBzaGVldCAne3NoZWV0X25hbWV9JyBpbnN0ZWFkLiIsIGZsdXNoPVRydWUpCiAgICAgICAgcHJpbnQoZiIgIFJlYWRpbmcgc2hlZXQgJ3tzaGVldF9uYW1lfScuLi4iLCBmbHVzaD1UcnVlKQogICAgICAgICMgVXNlIHRoZSBzYW1lIGVuZ2luZSBmb3IgcmVhZF9leGNlbAogICAgICAgIGRmID0gcGQucmVhZF9leGNlbCh4bHN4X3BhdGgsIHNoZWV0X25hbWU9c2hlZXRfbmFtZSwgaGVhZGVyPU5vbmUsIGVuZ2luZT0nb3BlbnB5eGwnKQogICAgICAgIHByaW50KGYiICBTaGVldCBsb2FkZWQ6IHtsZW4oZGYpfSByb3dzLCB7bGVuKGRmLmNvbHVtbnMpfSBjb2x1bW5zIiwgZmx1c2g9VHJ1ZSkKICAgICAgICAjIENsb3NlIHRoZSBFeGNlbEZpbGUgdG8gZnJlZSByZXNvdXJjZXMKICAgICAgICB4bHMuY2xvc2UoKQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIkZpbGUgbm90IGZvdW5kOiB7eGxzeF9wYXRofSIpCiAgICBleGNlcHQgUGVybWlzc2lvbkVycm9yOgogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIlBlcm1pc3Npb24gZGVuaWVkOiB7eGxzeF9wYXRofSAoZmlsZSBtYXkgYmUgb3BlbiBpbiBhbm90aGVyIHByb2dyYW0pIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBlcnJvcl90eXBlID0gdHlwZShlKS5fX25hbWVfXwogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIkZhaWxlZCB0byByZWFkIHt4bHN4X3BhdGh9OiB7ZXJyb3JfdHlwZX06IHtlfSIpCgogICAgcHJpbnQoZiIgIEZpbmRpbmcgaGVhZGVyIGFuZCB0aW1lIHJvd3MuLi4iLCBmbHVzaD1UcnVlKQogICAgaGVhZGVyX3Jvd19pZHgsIHRpbWVfcm93X2lkeCA9IGZpbmRfaGVhZGVyX2FuZF90aW1lX3Jvd3MoZGYpCgogICAgIyBUaW1lIHJvdzogY29sdW1uIDEgaXMgIlRpbWUgW3NdIiwgbWVhc3VyZW1lbnQgdGltZXMgc3RhcnQgZnJvbSBjb2x1bW4gMiBvbndhcmQuCiAgICB0aW1lX3JvdyA9IGRmLmlsb2NbdGltZV9yb3dfaWR4XQogICAgdGltZV92YWx1ZXMgPSB0aW1lX3Jvdy5pbG9jWzI6XS50b2xpc3QoKQogICAgIyBDbGVhbiB1cCB0aW1lcwogICAgdGltZV92YWx1ZXNfY2xlYW4gPSBbXQogICAgZm9yIHQgaW4gdGltZV92YWx1ZXM6CiAgICAgICAgaWYgcGQuaXNuYSh0KToKICAgICAgICAgICAgYnJlYWsKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRpbWVfdmFsdWVzX2NsZWFuLmFwcGVuZChmbG9hdCh0KSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAjIFN0b3AgYXQgdGhlIGZpcnN0IG5vbi1udW1lcmljIC8gd2VpcmQgdGhpbmcKICAgICAgICAgICAgYnJlYWsKCiAgICBudW1fdGltZV9wb2ludHMgPSBsZW4odGltZV92YWx1ZXNfY2xlYW4pCiAgICBpZiBudW1fdGltZV9wb2ludHMgPT0gMDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiTm8gdGltZXBvaW50cyBwYXJzZWQgaW4ge3hsc3hfcGF0aH0uIikKCiAgICBwbGF0ZV9pZCA9IG9zLnBhdGguc3BsaXRleHQob3MucGF0aC5iYXNlbmFtZSh4bHN4X3BhdGgpKVswXQoKICAgIHJlY29yZHM6IExpc3RbRGljdFtzdHIsIEFueV1dID0gW10KCiAgICAjIERhdGEgcm93czogZnJvbSB0aW1lX3Jvd19pZHggKyAxIGRvd253YXJkcyB1bnRpbCB3ZSBoaXQgZW1wdHkgIldlbGwiIGNlbGwKICAgIHByaW50KGYiICBQcm9jZXNzaW5nIGRhdGEgcm93cyAoc3RhcnRpbmcgZnJvbSByb3cge3RpbWVfcm93X2lkeCArIDF9KS4uLiIsIGZsdXNoPVRydWUpCiAgICByb3dzX3Byb2Nlc3NlZCA9IDAKICAgIGZvciBpIGluIHJhbmdlKHRpbWVfcm93X2lkeCArIDEsIGxlbihkZikpOgogICAgICAgIHdlbGwgPSBkZi5pYXRbaSwgMF0KICAgICAgICBjb250ZW50ID0gZGYuaWF0W2ksIDFdCgogICAgICAgIGlmIHBkLmlzbmEod2VsbCkgb3Igc3RyKHdlbGwpLnN0cmlwKCkgPT0gIiI6CiAgICAgICAgICAgICMgQXNzdW1lIHdlJ3ZlIHJlYWNoZWQgdGhlIGVuZCBvZiBkYXRhCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHdlbGxfaWQgPSBzdHIod2VsbCkuc3RyaXAoKQogICAgICAgIGNvbnRlbnRfc3RyID0gIiIgaWYgcGQuaXNuYShjb250ZW50KSBlbHNlIHN0cihjb250ZW50KS5zdHJpcCgpCgogICAgICAgIHJvd192YWxzID0gZGYuaWxvY1tpLCAyOjIgKyBudW1fdGltZV9wb2ludHNdLnRvbGlzdCgpCiAgICAgICAgIyBFbnN1cmUgc2FtZSBsZW5ndGggYXMgdGltZSBsaXN0CiAgICAgICAgcm93X3ZhbHMgPSByb3dfdmFsc1s6bnVtX3RpbWVfcG9pbnRzXQoKICAgICAgICBmb3IgdCwgdiBpbiB6aXAodGltZV92YWx1ZXNfY2xlYW4sIHJvd192YWxzKToKICAgICAgICAgICAgaWYgcGQuaXNuYSh2KToKICAgICAgICAgICAgICAgICMgU2tpcCBtaXNzaW5nIHZhbHVlcywgYnV0IGtlZXAgdGltZXBvaW50IGluIG92ZXJhbGwgc2NoZW1lCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB2X2Zsb2F0ID0gZmxvYXQodikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICByZWNvcmRzLmFwcGVuZCgKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAicGxhdGVfaWQiOiBwbGF0ZV9pZCwKICAgICAgICAgICAgICAgICAgICAid2VsbCI6IHdlbGxfaWQsCiAgICAgICAgICAgICAgICAgICAgImNvbnRlbnQiOiBjb250ZW50X3N0ciwKICAgICAgICAgICAgICAgICAgICAidGltZV9zIjogZmxvYXQodCksCiAgICAgICAgICAgICAgICAgICAgInZhbHVlIjogdl9mbG9hdCwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgIAogICAgICAgIHJvd3NfcHJvY2Vzc2VkICs9IDEKICAgICAgICBpZiByb3dzX3Byb2Nlc3NlZCAlIDEwMCA9PSAwOgogICAgICAgICAgICBwcmludChmIiAgICBQcm9jZXNzZWQge3Jvd3NfcHJvY2Vzc2VkfSByb3dzLi4uIiwgZmx1c2g9VHJ1ZSkKCiAgICBwcmludChmIiAgUHJvY2Vzc2VkIHtyb3dzX3Byb2Nlc3NlZH0gcm93cywgY3JlYXRlZCB7bGVuKHJlY29yZHMpfSBkYXRhIHBvaW50cyIsIGZsdXNoPVRydWUpCgogICAgaWYgbm90IHJlY29yZHM6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIk5vIGRhdGEgcm93cyBmb3VuZCBpbiB7eGxzeF9wYXRofSBhZnRlciBwYXJzaW5nLiIpCgogICAgcHJpbnQoZiIgIENyZWF0aW5nIERhdGFGcmFtZS4uLiIsIGZsdXNoPVRydWUpCiAgICBsb25nX2RmID0gcGQuRGF0YUZyYW1lLmZyb21fcmVjb3JkcyhyZWNvcmRzKQogICAgcHJpbnQoZiIgIOKckyBDb21wbGV0ZWQgcGFyc2luZyB7b3MucGF0aC5iYXNlbmFtZSh4bHN4X3BhdGgpfSIsIGZsdXNoPVRydWUpCiAgICByZXR1cm4gbG9uZ19kZgoKCmRlZiBlbnN1cmVfZGlyKHBhdGg6IHN0cik6CiAgICBvcy5tYWtlZGlycyhwYXRoLCBleGlzdF9vaz1UcnVlKQoKCmRlZiB3cml0ZV9jc3ZzX2Zvcl9wbGF0ZShsb25nX2RmOiBwZC5EYXRhRnJhbWUsIGNzdl9yb290OiBzdHIsIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lLCBmaWxlbmFtZTogc3RyID0gTm9uZSk6CiAgICAiIiIKICAgIFdyaXRlIENTViBmaWxlczoKICAgICAgLSBjc3Zfcm9vdC88cGxhdGVfaWQ+LzxwbGF0ZV9pZD5fPHdlbGw+LmNzdiAocGVyIHdlbGwsIHdpdGhvdXQgU0VNKQogICAgICAtIGNzdl9yb290Lzxjb25kaXRpb24+Xzx0cmlwbGljYXRlX25hbWU+LmNzdiAocGVyIGNvbmRpdGlvbi10cmlwbGljYXRlIGNvbWJpbmF0aW9uLCB3aXRoIG1lYW4gYW5kIFNFTSkKICAgICIiIgogICAgcGxhdGVfaWQgPSBsb25nX2RmWyJwbGF0ZV9pZCJdLmlsb2NbMF0KICAgIHByaW50KGYiICBXcml0aW5nIENTVnMgZm9yIHtwbGF0ZV9pZH0uLi4iLCBmbHVzaD1UcnVlKQoKICAgICMgTG9hZCBjb25maWcgaWYgbm90IHByb3ZpZGVkCiAgICBpZiBjb25maWcgaXMgTm9uZToKICAgICAgICBzY3JpcHRfZGlyID0gb3MucGF0aC5kaXJuYW1lKG9zLnBhdGguYWJzcGF0aChfX2ZpbGVfXykpCiAgICAgICAgY29uZmlnX3BhdGggPSBvcy5wYXRoLmpvaW4oc2NyaXB0X2RpciwgInBsYXRlX2NvbmZpZy5qc29uIikKICAgICAgICBjb25maWcgPSBsb2FkX2NvbmZpZyhjb25maWdfcGF0aCkKICAgIAogICAgIyBQYXJzZSBjb2x1bW4gaW5mbyBmcm9tIGZpbGVuYW1lIGlmIHByb3ZpZGVkCiAgICBjb2x1bW5faW5mbyA9IE5vbmUKICAgIGlmIGZpbGVuYW1lOgogICAgICAgIHRyeToKICAgICAgICAgICAgY29sdW1uX2luZm8gPSBwYXJzZV9jb2x1bW5fZ3JvdXBfZnJvbV9maWxlbmFtZShmaWxlbmFtZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAKICAgICMgR2V0IHRyaXBsaWNhdGUgZ3JvdXBzIGZyb20gY29uZmlnCiAgICB0cmlwbGljYXRlX2dyb3VwcyA9IGNvbmZpZy5nZXQoInRyaXBsaWNhdGVfZ3JvdXBzIiwgREVGQVVMVF9UUklQTElDQVRFX0dST1VQUykKICAgIGNvbnRyb2xfcm93cyA9IGNvbmZpZy5nZXQoImNvbnRyb2xfcm93cyIsIFsiTiIsICJPIl0pCiAgICAKICAgICMgQnVpbGQgbWFwcGluZzogd2VsbF9pZCAtPiB0cmlwbGljYXRlIGdyb3VwIG5hbWUKICAgIHdlbGxfdG9fZ3JvdXAgPSB7fQogICAgZm9yIGdyb3VwIGluIHRyaXBsaWNhdGVfZ3JvdXBzOgogICAgICAgIGdyb3VwX25hbWUgPSBncm91cC5nZXQoIm5hbWUiLCAiIikKICAgICAgICBncm91cF93ZWxscyA9IGdyb3VwLmdldCgid2VsbHMiLCBbXSkKICAgICAgICBmb3Igd2VsbF9wYXR0ZXJuIGluIGdyb3VwX3dlbGxzOgogICAgICAgICAgICAjIEV4dHJhY3Qgcm93IGxldHRlciBmcm9tIHdlbGwgcGF0dGVybiAoZS5nLiwgIkIiIGZyb20gIkIiIG9yICJCMTMiKQogICAgICAgICAgICByb3dfbGV0dGVyID0gd2VsbF9wYXR0ZXJuWzBdIGlmIHdlbGxfcGF0dGVybiBhbmQgd2VsbF9wYXR0ZXJuWzBdLmlzYWxwaGEoKSBlbHNlICIiCiAgICAgICAgICAgIGlmIHJvd19sZXR0ZXI6CiAgICAgICAgICAgICAgICAjIEZpbmQgYWxsIHdlbGxzIGluIHRoaXMgcm93IGFjcm9zcyBhbGwgY29sdW1ucwogICAgICAgICAgICAgICAgZm9yIHdlbGxfaWQgaW4gbG9uZ19kZlsid2VsbCJdLnVuaXF1ZSgpOgogICAgICAgICAgICAgICAgICAgIGlmIHdlbGxfaWQgYW5kIHdlbGxfaWRbMF0gPT0gcm93X2xldHRlcjoKICAgICAgICAgICAgICAgICAgICAgICAgd2VsbF90b19ncm91cFt3ZWxsX2lkXSA9IGdyb3VwX25hbWUKICAgIAogICAgIyBQZXItd2VsbCBDU1ZzICh3aXRob3V0IFNFTSAtIFNFTSBvbmx5IGJlbG9uZ3MgaW4gdHJpcGxpY2F0ZSBDU1ZzKQogICAgcGxhdGVfZm9sZGVyID0gb3MucGF0aC5qb2luKGNzdl9yb290LCBwbGF0ZV9pZCkKICAgIGVuc3VyZV9kaXIocGxhdGVfZm9sZGVyKQogICAgCiAgICB3ZWxscyA9IGxvbmdfZGYuZ3JvdXBieSgid2VsbCIpCiAgICBwcmludChmIiAgICBXcml0aW5nIHtsZW4od2VsbHMpfSBwZXItd2VsbCBDU1ZzLi4uIiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgIyBXcml0ZSBwZXItd2VsbCBDU1ZzCiAgICBmb3IgaWR4LCAod2VsbF9pZCwgZykgaW4gZW51bWVyYXRlKHdlbGxzLCAxKToKICAgICAgICBzYWZlX3dlbGwgPSB3ZWxsX2lkLnJlcGxhY2UoIiAiLCAiIikucmVwbGFjZSgiOiIsICItIikKICAgICAgICBvdXRfcGF0aCA9IG9zLnBhdGguam9pbihwbGF0ZV9mb2xkZXIsIGYie3BsYXRlX2lkfV97c2FmZV93ZWxsfS5jc3YiKQogICAgICAgIGdfc29ydGVkID0gZy5zb3J0X3ZhbHVlcygidGltZV9zIikKICAgICAgICAKICAgICAgICAjIENyZWF0ZSBvdXRwdXQgRGF0YUZyYW1lIHdpdGggdGltZSBhbmQgdmFsdWUgb25seSAobm8gU0VNKQogICAgICAgIG91dHB1dF9kZiA9IHBkLkRhdGFGcmFtZSh7CiAgICAgICAgICAgICJ0aW1lX3MiOiBnX3NvcnRlZFsidGltZV9zIl0udmFsdWVzLAogICAgICAgICAgICAidmFsdWUiOiBnX3NvcnRlZFsidmFsdWUiXS52YWx1ZXMKICAgICAgICB9KQogICAgICAgIG91dHB1dF9kZi50b19jc3Yob3V0X3BhdGgsIGluZGV4PUZhbHNlKQogICAgICAgIAogICAgICAgIGlmIGlkeCAlIDUgPT0gMDoKICAgICAgICAgICAgcHJpbnQoZiIgICAgICBXcml0dGVuIHtpZHh9L3tsZW4od2VsbHMpfSB3ZWxscy4uLiIsIGZsdXNoPVRydWUpCiAgICAKICAgICMgV3JpdGUgY29uZGl0aW9uLXNwZWNpZmljIENTVnMgKGdlbm90eXBlLWJ1ZmZlci10cmlwbGljYXRlKQogICAgIyBPbmUgQ1NWIHBlciBjb25kaXRpb24tdHJpcGxpY2F0ZS1jb2x1bW4gY29tYmluYXRpb24KICAgIGlmIGNvbHVtbl9pbmZvOgogICAgICAgIHByaW50KGYiICAgIFdyaXRpbmcgY29uZGl0aW9uLXNwZWNpZmljIENTVnMuLi4iLCBmbHVzaD1UcnVlKQogICAgICAgIGdlbm90eXBlID0gY29sdW1uX2luZm8uZ2V0KCJnZW5vdHlwZSIsICIiKQogICAgICAgIGJ1ZmZlciA9IGNvbHVtbl9pbmZvLmdldCgiYnVmZmVyIiwgIiIpCiAgICAgICAgCiAgICAgICAgIyBHcm91cCBieSB0cmlwbGljYXRlIGdyb3VwIG5hbWUgYW5kIGNvbHVtbgogICAgICAgIGZvciBncm91cCBpbiB0cmlwbGljYXRlX2dyb3VwczoKICAgICAgICAgICAgZ3JvdXBfbmFtZSA9IGdyb3VwLmdldCgibmFtZSIsICIiKQogICAgICAgICAgICBpZiBub3QgZ3JvdXBfbmFtZToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdldCBhbGwgd2VsbHMgaW4gdGhpcyB0cmlwbGljYXRlIGdyb3VwIChhY3Jvc3MgYWxsIGNvbHVtbnMpCiAgICAgICAgICAgIGdyb3VwX3dlbGxzID0gW10KICAgICAgICAgICAgZm9yIHdlbGxfaWQgaW4gbG9uZ19kZlsid2VsbCJdLnVuaXF1ZSgpOgogICAgICAgICAgICAgICAgaWYgd2VsbF9pZCBpbiB3ZWxsX3RvX2dyb3VwIGFuZCB3ZWxsX3RvX2dyb3VwW3dlbGxfaWRdID09IGdyb3VwX25hbWU6CiAgICAgICAgICAgICAgICAgICAgZ3JvdXBfd2VsbHMuYXBwZW5kKHdlbGxfaWQpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgZ3JvdXBfd2VsbHM6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBHcm91cCB3ZWxscyBieSBjb2x1bW4gbnVtYmVyCiAgICAgICAgICAgIHdlbGxzX2J5X2NvbHVtbiA9IHt9CiAgICAgICAgICAgIGZvciB3ZWxsX2lkIGluIGdyb3VwX3dlbGxzOgogICAgICAgICAgICAgICAgIyBFeHRyYWN0IGNvbHVtbiBudW1iZXIgZnJvbSB3ZWxsIElEIChlLmcuLCAiQjEzIiAtPiAxMykKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBjb2x1bW5fbnVtID0gaW50KCcnLmpvaW4oZmlsdGVyKHN0ci5pc2RpZ2l0LCBzdHIod2VsbF9pZCkpKSkKICAgICAgICAgICAgICAgICAgICBpZiBjb2x1bW5fbnVtIG5vdCBpbiB3ZWxsc19ieV9jb2x1bW46CiAgICAgICAgICAgICAgICAgICAgICAgIHdlbGxzX2J5X2NvbHVtbltjb2x1bW5fbnVtXSA9IFtdCiAgICAgICAgICAgICAgICAgICAgd2VsbHNfYnlfY29sdW1uW2NvbHVtbl9udW1dLmFwcGVuZCh3ZWxsX2lkKQogICAgICAgICAgICAgICAgZXhjZXB0IChWYWx1ZUVycm9yLCBBdHRyaWJ1dGVFcnJvcik6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ3JlYXRlIG9uZSBDU1YgcGVyIGNvbHVtbiBmb3IgdGhpcyB0cmlwbGljYXRlIGdyb3VwCiAgICAgICAgICAgIGZvciBjb2x1bW5fbnVtIGluIHNvcnRlZCh3ZWxsc19ieV9jb2x1bW4ua2V5cygpKToKICAgICAgICAgICAgICAgIGNvbHVtbl93ZWxscyA9IHdlbGxzX2J5X2NvbHVtbltjb2x1bW5fbnVtXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEdldCBhbGwgdGltZSBwb2ludHMgZm9yIHRoaXMgY29sdW1uJ3Mgd2VsbHMKICAgICAgICAgICAgICAgIGFsbF90aW1lcyA9IHNvcnRlZChsb25nX2RmW2xvbmdfZGZbIndlbGwiXS5pc2luKGNvbHVtbl93ZWxscyldWyJ0aW1lX3MiXS51bmlxdWUoKSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBDYWxjdWxhdGUgbWVhbiBhbmQgU0VNIGZvciBlYWNoIHRpbWUgcG9pbnQgYWNyb3NzIHdlbGxzIGluIHRoaXMgdHJpcGxpY2F0ZSBncm91cCBmb3IgdGhpcyBjb2x1bW4KICAgICAgICAgICAgICAgIG1lYW5fdmFsdWVzID0gW10KICAgICAgICAgICAgICAgIHNlbV92YWx1ZXMgPSBbXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgdGltZSBpbiBhbGxfdGltZXM6CiAgICAgICAgICAgICAgICAgICAgdmFsdWVzX2F0X3RpbWUgPSBbXQogICAgICAgICAgICAgICAgICAgIGZvciB3ZWxsX2lkIGluIGNvbHVtbl93ZWxsczoKICAgICAgICAgICAgICAgICAgICAgICAgd2VsbF9kYXRhID0gbG9uZ19kZlsobG9uZ19kZlsid2VsbCJdID09IHdlbGxfaWQpICYgKGxvbmdfZGZbInRpbWVfcyJdID09IHRpbWUpXQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgd2VsbF9kYXRhLmVtcHR5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzX2F0X3RpbWUuYXBwZW5kKHdlbGxfZGF0YVsidmFsdWUiXS5pbG9jWzBdKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIGxlbih2YWx1ZXNfYXRfdGltZSkgPj0gMjoKICAgICAgICAgICAgICAgICAgICAgICAgbWVhbiA9IHN1bSh2YWx1ZXNfYXRfdGltZSkgLyBsZW4odmFsdWVzX2F0X3RpbWUpCiAgICAgICAgICAgICAgICAgICAgICAgIHZhcmlhbmNlID0gc3VtKCh2IC0gbWVhbikgKiogMiBmb3IgdiBpbiB2YWx1ZXNfYXRfdGltZSkgLyBsZW4odmFsdWVzX2F0X3RpbWUpCiAgICAgICAgICAgICAgICAgICAgICAgIHN0ZF9kZXYgPSB2YXJpYW5jZSAqKiAwLjUKICAgICAgICAgICAgICAgICAgICAgICAgc2VtID0gc3RkX2RldiAvIChsZW4odmFsdWVzX2F0X3RpbWUpICoqIDAuNSkKICAgICAgICAgICAgICAgICAgICAgICAgbWVhbl92YWx1ZXMuYXBwZW5kKG1lYW4pCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbV92YWx1ZXMuYXBwZW5kKHNlbSkKICAgICAgICAgICAgICAgICAgICBlbGlmIGxlbih2YWx1ZXNfYXRfdGltZSkgPT0gMToKICAgICAgICAgICAgICAgICAgICAgICAgbWVhbl92YWx1ZXMuYXBwZW5kKHZhbHVlc19hdF90aW1lWzBdKQogICAgICAgICAgICAgICAgICAgICAgICBzZW1fdmFsdWVzLmFwcGVuZChOb25lKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIG1lYW5fdmFsdWVzLmFwcGVuZChOb25lKQogICAgICAgICAgICAgICAgICAgICAgICBzZW1fdmFsdWVzLmFwcGVuZChOb25lKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENyZWF0ZSBjb25kaXRpb24gQ1NWIGZpbGVuYW1lOiBwbGF0ZV9pZF90cmlwbGljYXRlX25hbWVfY29se2NvbHVtbn0KICAgICAgICAgICAgICAgICMgUGxhdGUgSUQgYWxyZWFkeSBjb250YWlucyBnZW5vdHlwZSBhbmQgYnVmZmVyLCBzbyBqdXN0IHVzZSB0cmlwbGljYXRlIG5hbWUKICAgICAgICAgICAgICAgICMgS2VlcCBoeXBoZW5zIGluIGdyb3VwIG5hbWUgKGUuZy4sICIyNTAtMTAtMiIpLCBqdXN0IHNhbml0aXplIHNwYWNlcyBhbmQgY29sb25zCiAgICAgICAgICAgICAgICBzYWZlX2dyb3VwX25hbWUgPSBncm91cF9uYW1lLnJlcGxhY2UoIiAiLCAiXyIpLnJlcGxhY2UoIjoiLCAiLSIpCiAgICAgICAgICAgICAgICBjb25kaXRpb25fcGF0aCA9IG9zLnBhdGguam9pbihjc3Zfcm9vdCwgZiJ7cGxhdGVfaWR9X3tzYWZlX2dyb3VwX25hbWV9X2NvbHtjb2x1bW5fbnVtfS5jc3YiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFdyaXRlIGNvbmRpdGlvbiBDU1YKICAgICAgICAgICAgICAgIGNvbmRpdGlvbl9kZiA9IHBkLkRhdGFGcmFtZSh7CiAgICAgICAgICAgICAgICAgICAgInRpbWVfcyI6IGFsbF90aW1lcywKICAgICAgICAgICAgICAgICAgICAibWVhbiI6IG1lYW5fdmFsdWVzLAogICAgICAgICAgICAgICAgICAgICJzZW0iOiBzZW1fdmFsdWVzCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgY29uZGl0aW9uX2RmLnRvX2Nzdihjb25kaXRpb25fcGF0aCwgaW5kZXg9RmFsc2UpCiAgICAgICAgCiAgICAgICAgcHJpbnQoZiIgICAgICBXcml0dGVuIGNvbmRpdGlvbi1zcGVjaWZpYyBDU1ZzIiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgcHJpbnQoZiIgIOKckyBDb21wbGV0ZWQgd3JpdGluZyBDU1ZzIGZvciB7cGxhdGVfaWR9IiwgZmx1c2g9VHJ1ZSkKCgpkZWYgd3JpdGVfZGVmYXVsdF9jb25maWcoY29uZmlnX3BhdGg6IHN0cik6CiAgICAiIiJXcml0ZSBkZWZhdWx0IGNvbmZpZ3VyYXRpb24gZmlsZSBmcm9tIGRlZmF1bHRzLiIiIgogICAgIyBDb252ZXJ0IERFRkFVTFRfV0VMTF9MQUJFTFMgdG8gcm93LWJhc2VkIGZvcm1hdAogICAgd2VsbF9sYWJlbHMgPSB7fQogICAgZm9yIHdlbGxfaWQsIGxhYmVsIGluIERFRkFVTFRfV0VMTF9MQUJFTFMuaXRlbXMoKToKICAgICAgICBpZiB3ZWxsX2lkIGFuZCBsZW4od2VsbF9pZCkgPiAwIGFuZCB3ZWxsX2lkWzBdLmlzYWxwaGEoKToKICAgICAgICAgICAgcm93X2xldHRlciA9IHdlbGxfaWRbMF0KICAgICAgICAgICAgaWYgcm93X2xldHRlciBub3QgaW4gd2VsbF9sYWJlbHM6CiAgICAgICAgICAgICAgICB3ZWxsX2xhYmVsc1tyb3dfbGV0dGVyXSA9IGxhYmVsCiAgICAKICAgIGRlZmF1bHRfY29uZmlnID0gewogICAgICAgICJ3ZWxsX2xhYmVscyI6IHdlbGxfbGFiZWxzLAogICAgICAgICJ0cmlwbGljYXRlX2dyb3VwcyI6IERFRkFVTFRfVFJJUExJQ0FURV9HUk9VUFMsCiAgICAgICAgImNvbnRyb2xfcm93cyI6IFsiTiIsICJPIl0KICAgIH0KICAgIAogICAgdHJ5OgogICAgICAgIHdpdGggb3Blbihjb25maWdfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBqc29uLmR1bXAoZGVmYXVsdF9jb25maWcsIGYsIGluZGVudD0yKQogICAgICAgIHByaW50KGYiICBHZW5lcmF0ZWQgZGVmYXVsdCBjb25maWd1cmF0aW9uIGZpbGU6IHtvcy5wYXRoLmJhc2VuYW1lKGNvbmZpZ19wYXRoKX0iLCBmbHVzaD1UcnVlKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiICBXYXJuaW5nOiBDb3VsZCBub3Qgd3JpdGUgZGVmYXVsdCBjb25maWcgZmlsZToge2V9IiwgZmx1c2g9VHJ1ZSkKCgpkZWYgbG9hZF9jb25maWcoY29uZmlnX3BhdGg6IHN0cikgLT4gRGljdFtzdHIsIEFueV06CiAgICAiIiJMb2FkIHBsYXRlIGNvbmZpZ3VyYXRpb24gZmlsZSBpZiBpdCBleGlzdHMsIG90aGVyd2lzZSBnZW5lcmF0ZSBmcm9tIGRlZmF1bHRzLiIiIgogICAgaWYgb3MucGF0aC5leGlzdHMoY29uZmlnX3BhdGgpOgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGNvbmZpZ19wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBjb25maWcgPSBqc29uLmxvYWQoZikKICAgICAgICAgICAgICAgIHByaW50KGYiICBMb2FkZWQgY29uZmlndXJhdGlvbiBmcm9tIHtvcy5wYXRoLmJhc2VuYW1lKGNvbmZpZ19wYXRoKX0iLCBmbHVzaD1UcnVlKQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbmZpZwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiIgIFdhcm5pbmc6IENvdWxkIG5vdCBsb2FkIGNvbmZpZyBmaWxlOiB7ZX0iLCBmbHVzaD1UcnVlKQogICAgICAgICAgICAjIEdlbmVyYXRlIGRlZmF1bHQgY29uZmlnIGlmIGxvYWRpbmcgZmFpbHMKICAgICAgICAgICAgd3JpdGVfZGVmYXVsdF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgZWxzZToKICAgICAgICAjIEdlbmVyYXRlIGRlZmF1bHQgY29uZmlnIGZpbGUgaWYgaXQgZG9lc24ndCBleGlzdAogICAgICAgIHdyaXRlX2RlZmF1bHRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgICAgIHJldHVybiB7fQoKCmRlZiBidWlsZF92aWV3ZXJfanNvbihhbGxfcGxhdGVzOiBEaWN0W3N0ciwgcGQuRGF0YUZyYW1lXSwganNvbl9wYXRoOiBzdHIsIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lLCBwbGF0ZV9pZF90b19maWxlbmFtZTogRGljdFtzdHIsIHN0cl0gPSBOb25lKToKICAgICIiIgogICAgQnVpbGQgdmlld2VyX2RhdGEuanNvbiB3aXRoIHN0cnVjdHVyZToKICAgIHsKICAgICAgImNvbmZpZyI6IHsKICAgICAgICAid2VsbF9sYWJlbHMiOiB7Li4ufSwKICAgICAgICAidHJpcGxpY2F0ZV9ncm91cHMiOiBbLi4uXSwgICMgcm93LWxldHRlciBncm91cHMgKGFwcGxpZXMgdG8gYWxsIGNvbHVtbnMpCiAgICAgICAgImNvbHVtbl9ncm91cHMiOiB7Li4ufSAgIyBtYXBwaW5nIG9mIGNvbHVtbl9ncm91cCB0byBsaXN0IG9mIHBsYXRlX2lkcwogICAgICB9LAogICAgICAicGxhdGVzIjogWwogICAgICAgIHsKICAgICAgICAgICJpZCI6ICI8cGxhdGVfaWQ+IiwKICAgICAgICAgICJmaWxlIjogIjxvcmlnaW5hbF9maWxlX25hbWU+IiwKICAgICAgICAgICJjb2x1bW5fZ3JvdXAiOiAiPHByb3RlaW5fZ2Vub3R5cGVfYnVmZmVyPiIsCiAgICAgICAgICAiY29sdW1uX2luZm8iOiB7CiAgICAgICAgICAgICJwcm90ZWluIjogIi4uLiIsCiAgICAgICAgICAgICJnZW5vdHlwZSI6ICIuLi4iLAogICAgICAgICAgICAiYnVmZmVyIjogIi4uLiIsCiAgICAgICAgICAgICJzY2llbnRpc3QiOiAiLi4uIiwKICAgICAgICAgICAgIm51bWJlciI6ICIuLi4iCiAgICAgICAgICB9LAogICAgICAgICAgIndlbGxzIjogewogICAgICAgICAgICAiQjE1IjogewogICAgICAgICAgICAgICJjb250ZW50IjogIlNhbXBsZSBYMSIsCiAgICAgICAgICAgICAgImxhYmVsIjogIlNhbXBsZSBYMSIsICAjIGZyb20gY29uZmlnIGlmIGF2YWlsYWJsZQogICAgICAgICAgICAgICJ0aW1lX3MiOiBbLi4uXSwKICAgICAgICAgICAgICAidmFsdWVzIjogWy4uLl0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgLi4uCiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAuLi4KICAgICAgXQogICAgfQogICAgIiIiCiAgICBpZiBjb25maWcgaXMgTm9uZToKICAgICAgICBjb25maWcgPSB7fQogICAgaWYgcGxhdGVfaWRfdG9fZmlsZW5hbWUgaXMgTm9uZToKICAgICAgICBwbGF0ZV9pZF90b19maWxlbmFtZSA9IHt9CiAgICAKICAgICMgR2V0IGNvbnRyb2wgcm93cyBmcm9tIGNvbmZpZyAoZGVmYXVsdDogWyJOIiwgIk8iXSkKICAgIGNvbnRyb2xfcm93cyA9IGNvbmZpZy5nZXQoImNvbnRyb2xfcm93cyIsIFsiTiIsICJPIl0pCiAgICBpZiBub3QgaXNpbnN0YW5jZShjb250cm9sX3Jvd3MsIGxpc3QpOgogICAgICAgIGNvbnRyb2xfcm93cyA9IFsiTiIsICJPIl0gICMgRmFsbGJhY2sgdG8gZGVmYXVsdCBpZiBpbnZhbGlkCiAgICAKICAgICMgTWVyZ2UgZGVmYXVsdCB3ZWxsIGxhYmVscyB3aXRoIGNvbmZpZyBsYWJlbHMgKGNvbmZpZyB0YWtlcyBwcmVjZWRlbmNlKQogICAgIyBXZWxsIGxhYmVscyBhcmUgbm93IHJvdy1iYXNlZCAoZS5nLiwgIkIiOiAibGFiZWwiKSBpbnN0ZWFkIG9mIHdlbGwtc3BlY2lmaWMgKGUuZy4sICJCMTMiOiAibGFiZWwiKQogICAgIyBDb252ZXJ0IG9sZCBmb3JtYXQgdG8gbmV3IGZvcm1hdCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eQogICAgY29uZmlnX3dlbGxfbGFiZWxzID0gY29uZmlnLmdldCgid2VsbF9sYWJlbHMiLCB7fSkKICAgIHdlbGxfbGFiZWxzID0ge30KICAgIAogICAgIyBQcm9jZXNzIGNvbmZpZyBsYWJlbHMgLSBjb252ZXJ0IHdlbGwtc3BlY2lmaWMgdG8gcm93LWJhc2VkIGlmIG5lZWRlZAogICAgZm9yIGtleSwgdmFsdWUgaW4gY29uZmlnX3dlbGxfbGFiZWxzLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGtleSkgPiAxIGFuZCBrZXlbMF0uaXNhbHBoYSgpIGFuZCBrZXlbMTpdLmlzZGlnaXQoKToKICAgICAgICAgICAgIyBPbGQgZm9ybWF0OiAiQjEzIiAtPiBleHRyYWN0IHJvdyAiQiIKICAgICAgICAgICAgcm93X2xldHRlciA9IGtleVswXQogICAgICAgICAgICAjIFVzZSB0aGUgbGFzdCBub24tZW1wdHkgdmFsdWUgZm9yIGVhY2ggcm93IChpbiBjYXNlIG9mIGR1cGxpY2F0ZXMpCiAgICAgICAgICAgIGlmIHJvd19sZXR0ZXIgbm90IGluIHdlbGxfbGFiZWxzOgogICAgICAgICAgICAgICAgd2VsbF9sYWJlbHNbcm93X2xldHRlcl0gPSB2YWx1ZQogICAgICAgICAgICBlbGlmIG5vdCB3ZWxsX2xhYmVsc1tyb3dfbGV0dGVyXSBvciBub3Qgd2VsbF9sYWJlbHNbcm93X2xldHRlcl0uc3RyaXAoKToKICAgICAgICAgICAgICAgIHdlbGxfbGFiZWxzW3Jvd19sZXR0ZXJdID0gdmFsdWUKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIE5ldyBmb3JtYXQ6ICJCIiAtPiB1c2UgYXMgaXMKICAgICAgICAgICAgd2VsbF9sYWJlbHNba2V5XSA9IHZhbHVlCiAgICAKICAgICMgQWxzbyBjb252ZXJ0IERFRkFVTFRfV0VMTF9MQUJFTFMgdG8gcm93LWJhc2VkIGZvcm1hdAogICAgZGVmYXVsdF9yb3dfbGFiZWxzID0ge30KICAgIGZvciBrZXksIHZhbHVlIGluIERFRkFVTFRfV0VMTF9MQUJFTFMuaXRlbXMoKToKICAgICAgICBpZiBsZW4oa2V5KSA+IDEgYW5kIGtleVswXS5pc2FscGhhKCk6CiAgICAgICAgICAgIHJvd19sZXR0ZXIgPSBrZXlbMF0KICAgICAgICAgICAgaWYgcm93X2xldHRlciBub3QgaW4gZGVmYXVsdF9yb3dfbGFiZWxzOgogICAgICAgICAgICAgICAgZGVmYXVsdF9yb3dfbGFiZWxzW3Jvd19sZXR0ZXJdID0gdmFsdWUKICAgIAogICAgIyBNZXJnZSBkZWZhdWx0cyB3aXRoIGNvbmZpZyAoY29uZmlnIHRha2VzIHByZWNlZGVuY2UpCiAgICB3ZWxsX2xhYmVscyA9IHsqKmRlZmF1bHRfcm93X2xhYmVscywgKip3ZWxsX2xhYmVsc30KICAgIAogICAgIyBQYXJzZSBjb2x1bW4gZ3JvdXBzIGZyb20gZmlsZW5hbWVzCiAgICBjb2x1bW5fZ3JvdXBzOiBEaWN0W3N0ciwgTGlzdFtzdHJdXSA9IHt9ICAjIGNvbHVtbl9ncm91cCAtPiBsaXN0IG9mIHBsYXRlX2lkcwogICAgcGxhdGVfY29sdW1uX2luZm86IERpY3Rbc3RyLCBEaWN0W3N0ciwgc3RyXV0gPSB7fSAgIyBwbGF0ZV9pZCAtPiBjb2x1bW5faW5mbwogICAgCiAgICBmb3IgcGxhdGVfaWQsIGRmIGluIGFsbF9wbGF0ZXMuaXRlbXMoKToKICAgICAgICBmaWxlbmFtZSA9IHBsYXRlX2lkX3RvX2ZpbGVuYW1lLmdldChwbGF0ZV9pZCwgcGxhdGVfaWQgKyAiLnhsc3giKQogICAgICAgIGNvbHVtbl9pbmZvID0gcGFyc2VfY29sdW1uX2dyb3VwX2Zyb21fZmlsZW5hbWUoZmlsZW5hbWUpCiAgICAgICAgY29sdW1uX2dyb3VwID0gY29sdW1uX2luZm9bImNvbHVtbl9ncm91cCJdCiAgICAgICAgCiAgICAgICAgcGxhdGVfY29sdW1uX2luZm9bcGxhdGVfaWRdID0gY29sdW1uX2luZm8KICAgICAgICAKICAgICAgICBpZiBjb2x1bW5fZ3JvdXAgbm90IGluIGNvbHVtbl9ncm91cHM6CiAgICAgICAgICAgIGNvbHVtbl9ncm91cHNbY29sdW1uX2dyb3VwXSA9IFtdCiAgICAgICAgaWYgcGxhdGVfaWQgbm90IGluIGNvbHVtbl9ncm91cHNbY29sdW1uX2dyb3VwXToKICAgICAgICAgICAgY29sdW1uX2dyb3Vwc1tjb2x1bW5fZ3JvdXBdLmFwcGVuZChwbGF0ZV9pZCkKICAgIAogICAgIyBQcm9jZXNzIHRyaXBsaWNhdGUgZ3JvdXBzIC0gcm93IGxldHRlcnMgb25seSwgYXBwbGllcyB0byBhbGwgY29sdW1ucwogICAgIyBDb25maWcgZm9ybWF0OiB7Im5hbWUiOiAiLi4uIiwgIndlbGxzIjogWyJCIiwgIkMiLCAiRCJdfQogICAgIyBDb2x1bW4gZmllbGQgaXMgaWdub3JlZCBpZiBwcmVzZW50IChmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSkKICAgIGNvbmZpZ190cmlwbGljYXRlX2dyb3VwcyA9IGNvbmZpZy5nZXQoInRyaXBsaWNhdGVfZ3JvdXBzIiwgW10pCiAgICAKICAgIGlmIGNvbmZpZ190cmlwbGljYXRlX2dyb3VwcyBhbmQgbGVuKGNvbmZpZ190cmlwbGljYXRlX2dyb3VwcykgPiAwOgogICAgICAgICMgUHJvY2VzcyB0cmlwbGljYXRlIGdyb3VwcyAtIGFjY2VwdCByb3cgbGV0dGVycyBvbmx5IChlLmcuLCBbIkIiLCAiQyIsICJEIl0pCiAgICAgICAgIyBBbHNvIHN1cHBvcnQgYmFja3dhcmQgY29tcGF0aWJpbGl0eSB3aXRoIGZ1bGwgd2VsbCBJRHMgKGUuZy4sIFsiQjEzIiwgIkMxMyIsICJEMTMiXSkKICAgICAgICB0cmlwbGljYXRlX2dyb3VwcyA9IFtdCiAgICAgICAgZm9yIGdyb3VwIGluIGNvbmZpZ190cmlwbGljYXRlX2dyb3VwczoKICAgICAgICAgICAgd2VsbHMgPSBncm91cC5nZXQoIndlbGxzIiwgW10pCiAgICAgICAgICAgICMgRXh0cmFjdCByb3cgbGV0dGVycyBmcm9tIHdlbGxzIChoYW5kbGUgYm90aCBmb3JtYXRzKQogICAgICAgICAgICByb3dfbGV0dGVycyA9IFtdCiAgICAgICAgICAgIGZvciB3IGluIHdlbGxzOgogICAgICAgICAgICAgICAgIyBJZiBpdCdzIGEgZnVsbCB3ZWxsIElEIChlLmcuLCAiQjEzIiksIGV4dHJhY3Qgcm93IGxldHRlcgogICAgICAgICAgICAgICAgaWYgbGVuKHcpID4gMSBhbmQgd1swXS5pc2FscGhhKCkgYW5kIHdbMTpdLmlzZGlnaXQoKToKICAgICAgICAgICAgICAgICAgICByb3dfbGV0dGVyID0gd1swXQogICAgICAgICAgICAgICAgIyBJZiBpdCdzIGp1c3QgYSByb3cgbGV0dGVyIChlLmcuLCAiQiIpLCB1c2UgYXMgaXMKICAgICAgICAgICAgICAgIGVsaWYgbGVuKHcpID09IDEgYW5kIHcuaXNhbHBoYSgpOgogICAgICAgICAgICAgICAgICAgIHJvd19sZXR0ZXIgPSB3CiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlICAjIFNraXAgaW52YWxpZCBlbnRyaWVzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgRmlsdGVyIG91dCBjb250cm9sIHdlbGxzCiAgICAgICAgICAgICAgICBpZiBub3QgaXNfY29udHJvbF93ZWxsKHJvd19sZXR0ZXIsIGNvbnRyb2xfcm93cyk6CiAgICAgICAgICAgICAgICAgICAgaWYgcm93X2xldHRlciBub3QgaW4gcm93X2xldHRlcnM6CiAgICAgICAgICAgICAgICAgICAgICAgIHJvd19sZXR0ZXJzLmFwcGVuZChyb3dfbGV0dGVyKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcm93X2xldHRlcnM6CiAgICAgICAgICAgICAgICAjIFN0b3JlIHJvdyBsZXR0ZXJzIG9ubHkgLSBhcHBsaWVzIHRvIGFsbCBjb2x1bW5zCiAgICAgICAgICAgICAgICB0cmlwbGljYXRlX2dyb3Vwcy5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICJuYW1lIjogZ3JvdXAuZ2V0KCJuYW1lIiwgIiIpLAogICAgICAgICAgICAgICAgICAgICJ3ZWxscyI6IHNvcnRlZChyb3dfbGV0dGVycykgICMgU3RvcmUganVzdCByb3cgbGV0dGVycwogICAgICAgICAgICAgICAgfSkKICAgICAgICAKICAgICAgICBpZiB0cmlwbGljYXRlX2dyb3VwczoKICAgICAgICAgICAgcHJpbnQoZiIgIFVzaW5nIHtsZW4odHJpcGxpY2F0ZV9ncm91cHMpfSB0cmlwbGljYXRlIGdyb3VwKHMpIGZyb20gY29uZmlnIChyb3cgbGV0dGVycyBvbmx5LCBhcHBsaWVzIHRvIGFsbCBjb2x1bW5zKSIsIGZsdXNoPVRydWUpCiAgICBlbHNlOgogICAgICAgICMgQXV0by1nZW5lcmF0ZSBvciB1c2UgZGVmYXVsdHMKICAgICAgICAjIENvbGxlY3QgYWxsIHdlbGxzIGZyb20gYWxsIHBsYXRlcyB0byBhdXRvLWdlbmVyYXRlIHRyaXBsaWNhdGUgZ3JvdXBzCiAgICAgICAgY29udGVudF90b193ZWxsczogRGljdFtzdHIsIExpc3Rbc3RyXV0gPSB7fQogICAgICAgIAogICAgICAgIGZvciBwbGF0ZV9pZCwgZGYgaW4gYWxsX3BsYXRlcy5pdGVtcygpOgogICAgICAgICAgICBmb3Igd2VsbF9pZCwgZyBpbiBkZi5ncm91cGJ5KCJ3ZWxsIik6CiAgICAgICAgICAgICAgICBnX3NvcnRlZCA9IGcuc29ydF92YWx1ZXMoInRpbWVfcyIpCiAgICAgICAgICAgICAgICBjb250ZW50ID0gZ19zb3J0ZWRbImNvbnRlbnQiXS5pbG9jWzBdCiAgICAgICAgICAgICAgICBpZiBjb250ZW50IGFuZCBzdHIoY29udGVudCkuc3RyaXAoKToKICAgICAgICAgICAgICAgICAgICBpZiBjb250ZW50IG5vdCBpbiBjb250ZW50X3RvX3dlbGxzOgogICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50X3RvX3dlbGxzW2NvbnRlbnRdID0gW10KICAgICAgICAgICAgICAgICAgICBpZiB3ZWxsX2lkIG5vdCBpbiBjb250ZW50X3RvX3dlbGxzW2NvbnRlbnRdOgogICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50X3RvX3dlbGxzW2NvbnRlbnRdLmFwcGVuZCh3ZWxsX2lkKQogICAgICAgIAogICAgICAgICMgQXV0by1nZW5lcmF0ZSB0cmlwbGljYXRlIGdyb3VwczogZ3JvdXAgd2VsbHMgd2l0aCB0aGUgc2FtZSBjb250ZW50CiAgICAgICAgIyBFeHRyYWN0IHJvdyBwYXR0ZXJuIChlLmcuLCBCQ0QsIEVGRykgYW5kIGFwcGx5IHRvIGFsbCBjb2x1bW5zCiAgICAgICAgIyBFeGNsdWRlIGNvbnRyb2wgd2VsbHMgZnJvbSB0cmlwbGljYXRlIGdyb3VwcwogICAgICAgIGF1dG9fdHJpcGxpY2F0ZV9ncm91cHMgPSBbXQogICAgICAgIGZvciBjb250ZW50LCB3ZWxscyBpbiBjb250ZW50X3RvX3dlbGxzLml0ZW1zKCk6CiAgICAgICAgICAgICMgRmlsdGVyIG91dCBjb250cm9sIHdlbGxzCiAgICAgICAgICAgIG5vbl9jb250cm9sX3dlbGxzID0gW3cgZm9yIHcgaW4gd2VsbHMgaWYgbm90IGlzX2NvbnRyb2xfd2VsbCh3LCBjb250cm9sX3Jvd3MpXQogICAgICAgICAgICBpZiBsZW4obm9uX2NvbnRyb2xfd2VsbHMpID49IDI6ICAjIEF0IGxlYXN0IDIgbm9uLWNvbnRyb2wgd2VsbHMgd2l0aCBzYW1lIGNvbnRlbnQKICAgICAgICAgICAgICAgICMgRXh0cmFjdCByb3cgbGV0dGVycyAoZS5nLiwgWyJCMTMiLCAiQzEzIiwgIkQxMyJdIC0+IFsiQiIsICJDIiwgIkQiXSkKICAgICAgICAgICAgICAgIHJvd19sZXR0ZXJzID0gc29ydGVkKHNldChbd1swXSBmb3IgdyBpbiBub25fY29udHJvbF93ZWxscyBpZiB3IGFuZCB3WzBdLmlzYWxwaGEoKV0pKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIElmIHdlIGhhdmUgYSBwYXR0ZXJuIG9mIDMgY29uc2VjdXRpdmUgcm93cywgY3JlYXRlIGEgdHJpcGxpY2F0ZSBncm91cAogICAgICAgICAgICAgICAgIyBDaGVjayBmb3IgcGF0dGVybnMgbGlrZSBCQ0QsIEVGRywgSElKLCBldGMuCiAgICAgICAgICAgICAgICBpZiBsZW4ocm93X2xldHRlcnMpID49IDM6CiAgICAgICAgICAgICAgICAgICAgIyBTb3J0IHJvdyBsZXR0ZXJzIGFuZCBjaGVjayBpZiB0aGV5IGZvcm0gYSBjb25zZWN1dGl2ZSBwYXR0ZXJuCiAgICAgICAgICAgICAgICAgICAgcm93X2xldHRlcnNfc29ydGVkID0gc29ydGVkKHJvd19sZXR0ZXJzKQogICAgICAgICAgICAgICAgICAgICMgQ3JlYXRlIGdyb3VwIHdpdGggcm93IHBhdHRlcm4gKGFwcGxpZXMgdG8gYWxsIGNvbHVtbnMpCiAgICAgICAgICAgICAgICAgICAgYXV0b190cmlwbGljYXRlX2dyb3Vwcy5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICAgICAibmFtZSI6IGNvbnRlbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICJ3ZWxscyI6IHJvd19sZXR0ZXJzX3NvcnRlZFs6M10gICMgU3RvcmUgcm93IGxldHRlcnMgb25seQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBlbGlmIGxlbihyb3dfbGV0dGVycykgPj0gMjoKICAgICAgICAgICAgICAgICAgICAjIEZvciAyIHdlbGxzLCBzdGlsbCBjcmVhdGUgYSBncm91cAogICAgICAgICAgICAgICAgICAgIGF1dG9fdHJpcGxpY2F0ZV9ncm91cHMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiBjb250ZW50LAogICAgICAgICAgICAgICAgICAgICAgICAid2VsbHMiOiBzb3J0ZWQocm93X2xldHRlcnMpWzoyXSAgIyBTdG9yZSByb3cgbGV0dGVycyBvbmx5CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAKICAgICAgICAjIFNvcnQgdHJpcGxpY2F0ZSBncm91cHMgYnkgbmFtZQogICAgICAgIGF1dG9fdHJpcGxpY2F0ZV9ncm91cHMuc29ydChrZXk9bGFtYmRhIHg6IHguZ2V0KCJuYW1lIiwgIiIpKQogICAgICAgIAogICAgICAgIGlmIGF1dG9fdHJpcGxpY2F0ZV9ncm91cHM6CiAgICAgICAgICAgIHRyaXBsaWNhdGVfZ3JvdXBzID0gYXV0b190cmlwbGljYXRlX2dyb3VwcwogICAgICAgICAgICBwcmludChmIiAgQXV0by1nZW5lcmF0ZWQge2xlbih0cmlwbGljYXRlX2dyb3Vwcyl9IHRyaXBsaWNhdGUgZ3JvdXAocykgZnJvbSBkYXRhIChhcHBsaWVzIHRvIGFsbCBjb2x1bW5zKSIsIGZsdXNoPVRydWUpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBGYWxsIGJhY2sgdG8gZGVmYXVsdHMgLSBhbHJlYWR5IGluIHJvdyBsZXR0ZXIgZm9ybWF0CiAgICAgICAgICAgICMgRXhjbHVkZSBjb250cm9sIHdlbGxzIGZyb20gZGVmYXVsdCBncm91cHMKICAgICAgICAgICAgdHJpcGxpY2F0ZV9ncm91cHMgPSBbXQogICAgICAgICAgICBmb3IgZ3JvdXAgaW4gREVGQVVMVF9UUklQTElDQVRFX0dST1VQUzoKICAgICAgICAgICAgICAgIHdlbGxzID0gZ3JvdXAuZ2V0KCJ3ZWxscyIsIFtdKQogICAgICAgICAgICAgICAgIyBGaWx0ZXIgb3V0IGNvbnRyb2wgd2VsbHMKICAgICAgICAgICAgICAgIHJvd19sZXR0ZXJzID0gW3cgZm9yIHcgaW4gd2VsbHMgaWYgbm90IGlzX2NvbnRyb2xfd2VsbCh3LCBjb250cm9sX3Jvd3MpXQogICAgICAgICAgICAgICAgaWYgcm93X2xldHRlcnM6CiAgICAgICAgICAgICAgICAgICAgdHJpcGxpY2F0ZV9ncm91cHMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiBncm91cC5nZXQoIm5hbWUiLCAiIiksCiAgICAgICAgICAgICAgICAgICAgICAgICJ3ZWxscyI6IHNvcnRlZChyb3dfbGV0dGVycykgICMgQWxyZWFkeSByb3cgbGV0dGVycwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIGlmIHRyaXBsaWNhdGVfZ3JvdXBzOgogICAgICAgICAgICAgICAgcHJpbnQoZiIgIFVzaW5nIHtsZW4odHJpcGxpY2F0ZV9ncm91cHMpfSBkZWZhdWx0IHRyaXBsaWNhdGUgZ3JvdXAocykgKGFwcGxpZXMgdG8gYWxsIGNvbHVtbnMsIGNvbnRyb2wgd2VsbHMgZXhjbHVkZWQpIiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgIyBEZXRlY3QgZHVwbGljYXRlIHdlbGwgSURzIChzYW1lIHdlbGwgSUQgYXBwZWFycyBpbiBtdWx0aXBsZSBmaWxlcykKICAgICMgVGhpcyBtZWFucyBkdXBsaWNhdGUgY29sdW1ucyBpbiB0aGUgcGxhdGUgZ3JpZAogICAgd2VsbF9pZF90b19maWxlczogRGljdFtzdHIsIExpc3Rbc3RyXV0gPSB7fSAgIyB3ZWxsX2lkIC0+IGxpc3Qgb2YgZmlsZW5hbWVzCiAgICAKICAgIGZvciBwbGF0ZV9pZCwgZGYgaW4gYWxsX3BsYXRlcy5pdGVtcygpOgogICAgICAgIGZpbGVuYW1lID0gcGxhdGVfaWRfdG9fZmlsZW5hbWUuZ2V0KHBsYXRlX2lkLCBwbGF0ZV9pZCArICIueGxzeCIpCiAgICAgICAgIyBHZXQgYWxsIHVuaXF1ZSB3ZWxsIElEcyBmcm9tIHRoaXMgcGxhdGUKICAgICAgICB1bmlxdWVfd2VsbHMgPSBkZlsid2VsbCJdLnVuaXF1ZSgpCiAgICAgICAgZm9yIHdlbGxfaWQgaW4gdW5pcXVlX3dlbGxzOgogICAgICAgICAgICB3ZWxsX2lkX3N0ciA9IHN0cih3ZWxsX2lkKS5zdHJpcCgpCiAgICAgICAgICAgIGlmIHdlbGxfaWRfc3RyIG5vdCBpbiB3ZWxsX2lkX3RvX2ZpbGVzOgogICAgICAgICAgICAgICAgd2VsbF9pZF90b19maWxlc1t3ZWxsX2lkX3N0cl0gPSBbXQogICAgICAgICAgICBpZiBmaWxlbmFtZSBub3QgaW4gd2VsbF9pZF90b19maWxlc1t3ZWxsX2lkX3N0cl06CiAgICAgICAgICAgICAgICB3ZWxsX2lkX3RvX2ZpbGVzW3dlbGxfaWRfc3RyXS5hcHBlbmQoZmlsZW5hbWUpCiAgICAKICAgICMgR3JvdXAgZHVwbGljYXRlcyBieSBmaWxlIHBhaXJzIGZvciBjbGVhbmVyIG1lc3NhZ2luZwogICAgZHVwbGljYXRlX2NvbHVtbl93YXJuaW5ncyA9IFtdCiAgICBmaWxlX3BhaXJzX3RvX3dlbGxzOiBEaWN0W3N0ciwgTGlzdFtzdHJdXSA9IHt9ICAjICJmaWxlMXxmaWxlMiIgLT4gW3dlbGxfaWRzXQogICAgCiAgICBmb3Igd2VsbF9pZCwgZmlsZXMgaW4gd2VsbF9pZF90b19maWxlcy5pdGVtcygpOgogICAgICAgIGlmIGxlbihmaWxlcykgPiAxOgogICAgICAgICAgICAjIFNvcnQgZmlsZXMgYWxwaGFiZXRpY2FsbHkgZm9yIGNvbnNpc3RlbnQgb3JkZXJpbmcKICAgICAgICAgICAgc29ydGVkX2ZpbGVzID0gc29ydGVkKGZpbGVzKQogICAgICAgICAgICBmaWxlX2tleSA9ICJ8Ii5qb2luKHNvcnRlZF9maWxlcykKICAgICAgICAgICAgaWYgZmlsZV9rZXkgbm90IGluIGZpbGVfcGFpcnNfdG9fd2VsbHM6CiAgICAgICAgICAgICAgICBmaWxlX3BhaXJzX3RvX3dlbGxzW2ZpbGVfa2V5XSA9IFtdCiAgICAgICAgICAgIGZpbGVfcGFpcnNfdG9fd2VsbHNbZmlsZV9rZXldLmFwcGVuZCh3ZWxsX2lkKQogICAgCiAgICAjIEJ1aWxkIHdhcm5pbmdzIGdyb3VwZWQgYnkgZmlsZSBwYWlycwogICAgZm9yIGZpbGVfa2V5LCB3ZWxsX2lkcyBpbiBmaWxlX3BhaXJzX3RvX3dlbGxzLml0ZW1zKCk6CiAgICAgICAgZmlsZXMgPSBmaWxlX2tleS5zcGxpdCgifCIpCiAgICAgICAgc29ydGVkX3dlbGxzID0gc29ydGVkKHdlbGxfaWRzKQogICAgICAgIGR1cGxpY2F0ZV9jb2x1bW5fd2FybmluZ3MuYXBwZW5kKHsKICAgICAgICAgICAgImZpbGVzIjogZmlsZXMsCiAgICAgICAgICAgICJ3ZWxsX2lkcyI6IHNvcnRlZF93ZWxscwogICAgICAgIH0pCiAgICAgICAgCiAgICAgICAgIyBDb25zb2xlIG1lc3NhZ2UgLSBzaG9ydGVyIHZlcnNpb24KICAgICAgICBmaWxlc19zdHIgPSAiIGFuZCAiLmpvaW4oZmlsZXMpCiAgICAgICAgd2VsbHNfc3RyID0gIiwgIi5qb2luKHNvcnRlZF93ZWxsc1s6NV0pICAjIFNob3cgZmlyc3QgNQogICAgICAgIGlmIGxlbihzb3J0ZWRfd2VsbHMpID4gNToKICAgICAgICAgICAgd2VsbHNfc3RyICs9IGYiLCAuLi4gKHtsZW4oc29ydGVkX3dlbGxzKX0gdG90YWwpIgogICAgICAgIHByaW50KGYiICDimqDvuI8gIFdBUk5JTkc6IHtmaWxlc19zdHJ9IGhhdmUgZHVwbGljYXRlIHdlbGxzOiB7d2VsbHNfc3RyfSIsIGZsdXNoPVRydWUpCiAgICAgICAgcHJpbnQoZiIgICAgIE9ubHkgZGF0YSBmcm9tICd7ZmlsZXNbMF19JyAoZmlyc3QgYWxwaGFiZXRpY2FsbHkpIGlzIHVzZWQuIiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgZGF0YSA9IHsKICAgICAgICAiY29uZmlnIjogewogICAgICAgICAgICAid2VsbF9sYWJlbHMiOiB3ZWxsX2xhYmVscywKICAgICAgICAgICAgInRyaXBsaWNhdGVfZ3JvdXBzIjogdHJpcGxpY2F0ZV9ncm91cHMsCiAgICAgICAgICAgICJjb2x1bW5fZ3JvdXBzIjogY29sdW1uX2dyb3VwcywKICAgICAgICAgICAgImNvbnRyb2xfcm93cyI6IGNvbnRyb2xfcm93cywKICAgICAgICAgICAgIndhcm5pbmdzIjogewogICAgICAgICAgICAgICAgImR1cGxpY2F0ZV9jb2x1bW5zIjogZHVwbGljYXRlX2NvbHVtbl93YXJuaW5ncwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAicGxhdGVzIjogW10KICAgIH0KICAgIAogICAgZm9yIHBsYXRlX2lkLCBkZiBpbiBhbGxfcGxhdGVzLml0ZW1zKCk6CiAgICAgICAgd2VsbHNfZGljdDogRGljdFtzdHIsIEFueV0gPSB7fQogICAgICAgIGZvciB3ZWxsX2lkLCBnIGluIGRmLmdyb3VwYnkoIndlbGwiKToKICAgICAgICAgICAgZ19zb3J0ZWQgPSBnLnNvcnRfdmFsdWVzKCJ0aW1lX3MiKQogICAgICAgICAgICBjb250ZW50ID0gZ19zb3J0ZWRbImNvbnRlbnQiXS5pbG9jWzBdCiAgICAgICAgICAgICMgVXNlIHJvdy1iYXNlZCBsYWJlbCBmcm9tIGNvbmZpZyBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSB1c2UgY29udGVudAogICAgICAgICAgICAjIEV4dHJhY3Qgcm93IGxldHRlciBmcm9tIHdlbGxfaWQgKGUuZy4sICJCMTMiIC0+ICJCIikKICAgICAgICAgICAgcm93X2xldHRlciA9IHdlbGxfaWRbMF0gaWYgd2VsbF9pZCBhbmQgd2VsbF9pZFswXS5pc2FscGhhKCkgZWxzZSAiIgogICAgICAgICAgICBsYWJlbCA9IHdlbGxfbGFiZWxzLmdldChyb3dfbGV0dGVyLCBjb250ZW50KSBpZiByb3dfbGV0dGVyIGVsc2UgY29udGVudAogICAgICAgICAgICB3ZWxsc19kaWN0W3dlbGxfaWRdID0gewogICAgICAgICAgICAgICAgImNvbnRlbnQiOiBjb250ZW50LAogICAgICAgICAgICAgICAgImxhYmVsIjogbGFiZWwsCiAgICAgICAgICAgICAgICAidGltZV9zIjogZ19zb3J0ZWRbInRpbWVfcyJdLnRvbGlzdCgpLAogICAgICAgICAgICAgICAgInZhbHVlcyI6IGdfc29ydGVkWyJ2YWx1ZSJdLnRvbGlzdCgpLAogICAgICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZmlsZW5hbWUgPSBwbGF0ZV9pZF90b19maWxlbmFtZS5nZXQocGxhdGVfaWQsIHBsYXRlX2lkICsgIi54bHN4IikKICAgICAgICBjb2x1bW5faW5mbyA9IHBsYXRlX2NvbHVtbl9pbmZvLmdldChwbGF0ZV9pZCwgcGFyc2VfY29sdW1uX2dyb3VwX2Zyb21fZmlsZW5hbWUoZmlsZW5hbWUpKQogICAgICAgIAogICAgICAgIGRhdGFbInBsYXRlcyJdLmFwcGVuZCgKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgImlkIjogcGxhdGVfaWQsCiAgICAgICAgICAgICAgICAiZmlsZSI6IGZpbGVuYW1lLAogICAgICAgICAgICAgICAgImNvbHVtbl9ncm91cCI6IGNvbHVtbl9pbmZvWyJjb2x1bW5fZ3JvdXAiXSwKICAgICAgICAgICAgICAgICJjb2x1bW5faW5mbyI6IHsKICAgICAgICAgICAgICAgICAgICAicHJvdGVpbiI6IGNvbHVtbl9pbmZvWyJwcm90ZWluIl0sCiAgICAgICAgICAgICAgICAgICAgImdlbm90eXBlIjogY29sdW1uX2luZm9bImdlbm90eXBlIl0sCiAgICAgICAgICAgICAgICAgICAgImJ1ZmZlciI6IGNvbHVtbl9pbmZvWyJidWZmZXIiXSwKICAgICAgICAgICAgICAgICAgICAic2NpZW50aXN0IjogY29sdW1uX2luZm9bInNjaWVudGlzdCJdLAogICAgICAgICAgICAgICAgICAgICJudW1iZXIiOiBjb2x1bW5faW5mb1sibnVtYmVyIl0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAid2VsbHMiOiB3ZWxsc19kaWN0LAogICAgICAgICAgICB9CiAgICAgICAgKQoKICAgIHdpdGggb3Blbihqc29uX3BhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICBqc29uLmR1bXAoZGF0YSwgZiwgaW5kZW50PTIpCgoKSFRNTF9URU1QTEFURSA9IHIiIiI8IURPQ1RZUEUgaHRtbD4KPGh0bWwgbGFuZz0iZW4iPgo8aGVhZD4KICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgPHRpdGxlPlBsYXRlIFZpZXdlcjwvdGl0bGU+CiAgPHN0eWxlPgogICAgYm9keSB7CiAgICAgIGZvbnQtZmFtaWx5OiBzeXN0ZW0tdWksIC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgIlNlZ29lIFVJIiwgc2Fucy1zZXJpZjsKICAgICAgbWFyZ2luOiAwOwogICAgICBwYWRkaW5nOiAwOwogICAgICBkaXNwbGF5OiBmbGV4OwogICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgICBoZWlnaHQ6IDEwMHZoOwogICAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgfQogICAgI2NvbnRlbnQtd3JhcHBlciB7CiAgICAgIGRpc3BsYXk6IGdyaWQ7CiAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogMzIwcHggMWZyOwogICAgICBmbGV4OiAxOwogICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgfQogICAgYXNpZGUgewogICAgICBib3JkZXItcmlnaHQ6IDFweCBzb2xpZCAjY2NjOwogICAgICBwYWRkaW5nOiAxNnB4OwogICAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgICBiYWNrZ3JvdW5kOiAjZjdmN2Y3OwogICAgICBvdmVyZmxvdy15OiBhdXRvOwogICAgfQogICAgbWFpbiB7CiAgICAgIHBhZGRpbmc6IDE2cHg7CiAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICAgIG92ZXJmbG93OiBhdXRvOwogICAgfQogICAgaDEgewogICAgICBmb250LXNpemU6IDEuMnJlbTsKICAgICAgbWFyZ2luLXRvcDogMDsKICAgIH0KICAgIGxhYmVsIHsKICAgICAgZGlzcGxheTogYmxvY2s7CiAgICAgIG1hcmdpbi1ib3R0b206IDhweDsKICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgIH0KICAgIHNlbGVjdCB7CiAgICAgIHdpZHRoOiAxMDAlJTsKICAgICAgcGFkZGluZzogOHB4OwogICAgICBib3JkZXI6IDFweCBzb2xpZCAjZGRkOwogICAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICBmb250LXNpemU6IDAuOXJlbTsKICAgICAgbWFyZ2luLWJvdHRvbTogMTZweDsKICAgIH0KICAgICN3ZWxsLWluZm8gewogICAgICBtYXJnaW4tdG9wOiA4cHg7CiAgICAgIGZvbnQtc2l6ZTogMC45cmVtOwogICAgICBwYWRkaW5nOiA4cHg7CiAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7CiAgICB9CiAgICAjcGxhdGUtZ3JpZCB7CiAgICAgIGRpc3BsYXk6IGdyaWQ7CiAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogYXV0byByZXBlYXQoJShjb2xzKWQsIDFmcik7CiAgICAgIGdyaWQtYXV0by1yb3dzOiAzMnB4OwogICAgICBnYXA6IDJweDsKICAgICAgZm9udC1zaXplOiAxMXB4OwogICAgICBtYXJnaW4tYm90dG9tOiAxNnB4OwogICAgfQogICAgLmdyaWQtaGVhZGVyIHsKICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgfQogICAgLnJvdy1sYWJlbCwgLmNvbC1sYWJlbCB7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgfQogICAgLndlbGwgewogICAgICBib3JkZXI6IDFweCBzb2xpZCAjZGRkOwogICAgICBib3JkZXItcmFkaXVzOiAzcHg7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgIGJhY2tncm91bmQ6ICNmZmY7CiAgICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgICAgZm9udC1zaXplOiAxMHB4OwogICAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgICAgei1pbmRleDogMTsKICAgIH0KICAgIC53ZWxsW2RhdGEtaGFzLWRhdGE9InRydWUiXTpub3QoLnRyaXBsaWNhdGUtZ3JvdXApOm5vdCguY29udHJvbCkgewogICAgICBiYWNrZ3JvdW5kOiAjZTRmMGZmOwogICAgICBib3JkZXItY29sb3I6ICM2YzljZmY7CiAgICB9CiAgICAud2VsbC5zZWxlY3RlZCB7CiAgICAgIG91dGxpbmU6IDJweCBzb2xpZCAjMmE2Y2ZmOwogICAgICBvdXRsaW5lLW9mZnNldDogLTJweDsKICAgICAgYmFja2dyb3VuZDogI2U0ZjBmZjsKICAgIH0KICAgIC53ZWxsLnJlcGxpY2F0ZSB7CiAgICAgIGJvcmRlci1zdHlsZTogZGFzaGVkOwogICAgfQogICAgLndlbGwudHJpcGxpY2F0ZS1ncm91cCB7CiAgICAgIC8qIEJvcmRlcnMgYXJlIGFkZGVkIHZpYSBpbmxpbmUgc3R5bGVzIG9ubHkgd2hlbiBzZWxlY3RlZCAqLwogICAgfQogICAgLyogSW5kaXZpZHVhbCBjb2xvcnMgd2lsbCBiZSBhcHBsaWVkIHZpYSBpbmxpbmUgc3R5bGVzICovCiAgICAud2VsbC5jb250cm9sIHsKICAgICAgYmFja2dyb3VuZDogI2U4ZjVlOTsKICAgICAgYm9yZGVyOiAxcHggc29saWQgI2RkZDsKICAgIH0KICAgIC53ZWxsLmNvbnRyb2xbZGF0YS1oYXMtZGF0YT0idHJ1ZSJdIHsKICAgICAgYmFja2dyb3VuZDogI2M4ZTZjOTsKICAgICAgYm9yZGVyLWNvbG9yOiAjNmM5Y2ZmOwogICAgfQogICAgLndlbGwuY29udHJvbC5zZWxlY3RlZCB7CiAgICAgIGJhY2tncm91bmQ6ICNjOGU2Yzk7CiAgICAgIG91dGxpbmU6IDJweCBzb2xpZCAjMmE2Y2ZmOwogICAgICBvdXRsaW5lLW9mZnNldDogLTJweDsKICAgIH0KICAgIC53ZWxsLWxhYmVsIHsKICAgICAgZm9udC1zaXplOiA4cHg7CiAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgYm90dG9tOiAxcHg7CiAgICAgIGxlZnQ6IDFweDsKICAgICAgcmlnaHQ6IDFweDsKICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICB0ZXh0LW92ZXJmbG93OiBlbGxpcHNpczsKICAgICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgIHotaW5kZXg6IDI7CiAgICB9CiAgICAjY2hhcnQtY29udGFpbmVyIHsKICAgICAgbWFyZ2luLXRvcDogMTJweDsKICAgICAgaGVpZ2h0OiA4MDBweDsKICAgICAgbWluLWhlaWdodDogODAwcHg7CiAgICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIH0KICAgIGNhbnZhcyB7CiAgICAgIG1heC13aWR0aDogMTAwJSU7CiAgICAgIGhlaWdodDogODAwcHggIWltcG9ydGFudDsKICAgIH0KICAgIC5idG4gewogICAgICBwYWRkaW5nOiA2cHggMTJweDsKICAgICAgbWFyZ2luOiA0cHggMDsKICAgICAgYm9yZGVyOiAxcHggc29saWQgI2NjYzsKICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICBmb250LXNpemU6IDAuOXJlbTsKICAgIH0KICAgIC5idG46aG92ZXIgewogICAgICBiYWNrZ3JvdW5kOiAjZjBmMGYwOwogICAgfQogICAgLmJ0bi1wcmltYXJ5IHsKICAgICAgYmFja2dyb3VuZDogIzJhNmNmZjsKICAgICAgY29sb3I6IHdoaXRlOwogICAgICBib3JkZXItY29sb3I6ICMyYTZjZmY7CiAgICB9CiAgICAuYnRuLXByaW1hcnk6aG92ZXIgewogICAgICBiYWNrZ3JvdW5kOiAjMWE1Y2ZmOwogICAgfQogICAgI3dhcm5pbmctYmFubmVyIHsKICAgICAgYmFja2dyb3VuZDogI2ZmZjNjZDsKICAgICAgYm9yZGVyOiAycHggc29saWQgI2ZmYzEwNzsKICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICBwYWRkaW5nOiAxMnB4IDE2cHg7CiAgICAgIG1hcmdpbjogMTZweDsKICAgICAgbWFyZ2luLWJvdHRvbTogMDsKICAgICAgZm9udC1zaXplOiAwLjlyZW07CiAgICAgIGNvbG9yOiAjODU2NDA0OwogICAgICBkaXNwbGF5OiBub25lOwogICAgfQogICAgI3dhcm5pbmctYmFubmVyLnNob3cgewogICAgICBkaXNwbGF5OiBibG9jazsKICAgIH0KICAgICN3YXJuaW5nLWJhbm5lciBoMyB7CiAgICAgIG1hcmdpbjogMCAwIDhweCAwOwogICAgICBmb250LXNpemU6IDFyZW07CiAgICAgIGNvbG9yOiAjODU2NDA0OwogICAgfQogICAgI3dhcm5pbmctYmFubmVyIHVsIHsKICAgICAgbWFyZ2luOiA4cHggMCAwIDA7CiAgICAgIHBhZGRpbmctbGVmdDogMjBweDsKICAgIH0KICAgICN3YXJuaW5nLWJhbm5lciBsaSB7CiAgICAgIG1hcmdpbjogNHB4IDA7CiAgICB9CiAgICBpbnB1dFt0eXBlPSJjaGVja2JveCJdOmRpc2FibGVkIHsKICAgICAgb3BhY2l0eTogMC41OwogICAgICBjdXJzb3I6IG5vdC1hbGxvd2VkICFpbXBvcnRhbnQ7CiAgICB9CiAgICBpbnB1dFt0eXBlPSJjaGVja2JveCJdOmRpc2FibGVkICsgc3BhbiB7CiAgICAgIG9wYWNpdHk6IDAuNjsKICAgICAgY29sb3I6ICM5OTk7CiAgICB9CiAgPC9zdHlsZT4KICA8IS0tIENoYXJ0LmpzIHZpYSBDRE4gLS0+CiAgPHNjcmlwdCBzcmM9Imh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vY2hhcnQuanMiPjwvc2NyaXB0Pgo8L2hlYWQ+Cjxib2R5PgogIDxkaXYgaWQ9Indhcm5pbmctYmFubmVyIj48L2Rpdj4KICA8ZGl2IGlkPSJjb250ZW50LXdyYXBwZXIiPgogIDxhc2lkZT4KICAgIDxoMT5QbGF0ZSBWaWV3ZXI8L2gxPgogICAgPGxhYmVsPlNlbGVjdCBEYXRhc2V0IEdyb3VwOjwvbGFiZWw+CiAgICA8c2VsZWN0IGlkPSJkYXRhc2V0LXNlbGVjdCI+PC9zZWxlY3Q+CiAgICA8ZGl2IGlkPSJkYXRhc2V0LWluZm8iIHN0eWxlPSJtYXJnaW4tdG9wOiAxNnB4OyBwYWRkaW5nOiAxMnB4OyBiYWNrZ3JvdW5kOiB3aGl0ZTsgYm9yZGVyLXJhZGl1czogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBmb250LXNpemU6IDAuODVyZW07Ij4KICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyI+RGF0YXNldCBJbmZvcm1hdGlvbjwvZGl2PgogICAgICA8ZGl2IGlkPSJkYXRhc2V0LWRldGFpbHMiPlNlbGVjdCBhIGRhdGFzZXQgdG8gdmlldyBkZXRhaWxzLjwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IGlkPSJjb2x1bW4tbGVnZW5kIiBzdHlsZT0ibWFyZ2luLXRvcDogMTZweDsgcGFkZGluZzogMTJweDsgYmFja2dyb3VuZDogd2hpdGU7IGJvcmRlci1yYWRpdXM6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsgZm9udC1zaXplOiAwLjg1cmVtOyI+CiAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsiPlNlbGVjdCBEYXRhc2V0cyBieSBDb2x1bW48L2Rpdj4KICAgICAgPGRpdiBpZD0iY29sdW1uLWxlZ2VuZC1jb250ZW50IiBzdHlsZT0iZm9udC1zaXplOiAwLjhyZW07IGNvbG9yOiAjNjY2OyI+Tm8gY29sdW1uIGluZm9ybWF0aW9uIGF2YWlsYWJsZS48L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBpZD0id2VsbC1zZWxlY3RvciIgc3R5bGU9Im1hcmdpbi10b3A6IDE2cHg7IHBhZGRpbmc6IDEycHg7IGJhY2tncm91bmQ6IHdoaXRlOyBib3JkZXItcmFkaXVzOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7Ij4KICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgY3Vyc29yOiBwb2ludGVyOyBmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7IiBvbmNsaWNrPSJ0b2dnbGVXZWxsU2VsZWN0b3IoKSI+CiAgICAgICAgPHNwYW4gaWQ9IndlbGwtc2VsZWN0b3ItYXJyb3ciIHN0eWxlPSJtYXJnaW4tcmlnaHQ6IDhweDsiPuKWvDwvc3Bhbj4KICAgICAgICA8c3Bhbj5TZWxlY3QgV2VsbHMgKGNsaWNrIHRvIGV4Y2x1ZGUpPC9zcGFuPgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0id2VsbC1zZWxlY3Rvci1ncmlkLWNvbnRhaW5lciIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7Ij4KICAgICAgICA8ZGl2IGlkPSJ3ZWxsLXNlbGVjdG9yLWdyaWQiIHN0eWxlPSJkaXNwbGF5OiBncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IGF1dG8gcmVwZWF0KDI0LCAxZnIpOyBncmlkLWF1dG8tcm93czogMThweDsgZ2FwOiAxcHg7IGZvbnQtc2l6ZTogOHB4OyBtYXJnaW4tdG9wOiA4cHg7Ij48L2Rpdj4KICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiAxNnB4OyB0ZXh0LWFsaWduOiBjZW50ZXI7Ij4KICAgICAgICAgIENsaWNrIHdlbGxzIHRvIGV4Y2x1ZGUgdGhlbSAo4pyVID0gZXhjbHVkZWQpCiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tdG9wOiAxNnB4OyBwYWRkaW5nOiAxMnB4OyBiYWNrZ3JvdW5kOiB3aGl0ZTsgYm9yZGVyLXJhZGl1czogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyI+CiAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsgZm9udC1zaXplOiAwLjk1cmVtOyBjb2xvcjogIzMzMzsiPkRhdGEgUHJvY2Vzc2luZyBXb3JrZmxvdzwvZGl2PgogICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tYm90dG9tOiAxMnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsiPgogICAgICAgIDxzdHJvbmc+U3RlcCAxOjwvc3Ryb25nPiBOb3JtYWxpemUgdXNpbmcgZml0dGVkIGJhc2VsaW5lIChpZiBlbmFibGVkKTxicj4KICAgICAgICA8c3Ryb25nPlN0ZXAgMjo8L3N0cm9uZz4gR3JvdXAgd2VsbHMgaW50byB0cmlwbGljYXRlIGdyb3VwcyAoaWYgZW5hYmxlZCk8YnI+CiAgICAgICAgPHN0cm9uZz5TdGVwIDM6PC9zdHJvbmc+IEN1dG9mZiBkYXRhIHBvaW50cyBiZWZvcmUgZmlyc3QgdGltZXBvaW50IGFuZCBhZnRlciB0aW1lIHBvaW50IChpZiBlbmFibGVkKTxicj4KICAgICAgICA8c3Ryb25nPlN0ZXAgNDo8L3N0cm9uZz4gRml0IHJlZ3Jlc3Npb24gY3VydmUgdG8gZGF0YSBwb2ludHMgKGlmIGVuYWJsZWQpCiAgICAgIDwvZGl2PgogICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGN1cnNvcjogcG9pbnRlcjsgZm9udC1zaXplOiAwLjlyZW07Ij4KICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJub3JtYWxpemUtYmFzZWxpbmUtdG9nZ2xlIiBzdHlsZT0ibWFyZ2luLXJpZ2h0OiA4cHg7IGN1cnNvcjogcG9pbnRlcjsiIG9uY2hhbmdlPSJ1cGRhdGVDaGFydCgpOyI+CiAgICAgICAgPHNwYW4+PHN0cm9uZz5TdGVwIDE6PC9zdHJvbmc+IE5vcm1hbGl6ZSB1c2luZyBmaXR0ZWQgYmFzZWxpbmU8L3NwYW4+CiAgICAgIDwvbGFiZWw+CiAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDRweDsgbWFyZ2luLWJvdHRvbTogOHB4OyBtYXJnaW4tbGVmdDogMjRweDsiPgogICAgICAgIEZpdCBhIGJhc2VsaW5lIGZ1bmN0aW9uIChMT1dFU1MsIGNvbnN0YW50LCBvciBwb2x5bm9taWFsKSBvbiB0aGUgYmFzZWxpbmUgd2luZG93IGFuZCBub3JtYWxpemUgZWFjaCB3ZWxsIHVzaW5nIHRoZSBmaXR0ZWQgYmFzZWxpbmUuIFNlbGVjdCBtZXRob2QgYW5kIHBhcmFtZXRlcnMgaW4gdGhlICJCYXNlbGluZSBGaXR0aW5nICYgTm9ybWFsaXphdGlvbiBPcHRpb25zIiBzZWN0aW9uIGJlbG93LgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0ibm9ybWFsaXplLWJhc2VsaW5lLXBhcmFtZXRlcnMiIHN0eWxlPSJmb250LXNpemU6IDAuOHJlbTsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZjlmOWY5OyBib3JkZXItcmFkaXVzOiAzcHg7IGRpc3BsYXk6IG5vbmU7IG1hcmdpbi1sZWZ0OiAyNHB4OyBtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDEyMHB4OyI+QmFzZWxpbmUgd2luZG93IGVuZCAocyk6PC9zcGFuPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBpZD0ibm9ybWFsaXplLWJhc2VsaW5lLWVuZC10aW1lIiB2YWx1ZT0iMjQiIG1pbj0iMCIgc3RlcD0iMC4xIiBzdHlsZT0id2lkdGg6IDgwcHg7IHBhZGRpbmc6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsgYm9yZGVyLXJhZGl1czogM3B4OyBmb250LWZhbWlseTogbW9ub3NwYWNlOyIgb25jaGFuZ2U9InVwZGF0ZUNoYXJ0KCk7Ij4KICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLXRvcDogNHB4OyI+CiAgICAgICAgICBCYXNlbGluZSBmaXR0aW5nIG1ldGhvZCBhbmQgbm9ybWFsaXphdGlvbiBtb2RlIGFyZSBzZWxlY3RlZCBpbiB0aGUgIkJhc2VsaW5lIEZpdHRpbmcgJiBOb3JtYWxpemF0aW9uIE9wdGlvbnMiIHNlY3Rpb24gYmVsb3cuCiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBpZD0iY3VycmVudC1zZXR0aW5ncy1kaXNwbGF5IiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzMzMzsgbWFyZ2luLXRvcDogOHB4OyBwYWRkaW5nOiA2cHg7IGJhY2tncm91bmQ6ICNmMGYwZjA7IGJvcmRlci1yYWRpdXM6IDNweDsgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCAjMmE2Y2ZmOyI+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA0cHg7IGNvbG9yOiAjMmE2Y2ZmOyI+Q3VycmVudCBTZXR0aW5nczo8L2Rpdj4KICAgICAgICAgIDxkaXYgaWQ9ImN1cnJlbnQtc2V0dGluZ3MtY29udGVudCIgc3R5bGU9ImZvbnQtc2l6ZTogMC43cmVtOyBjb2xvcjogIzY2NjsiPgogICAgICAgICAgICBCYXNlbGluZTogPHNwYW4gaWQ9ImN1cnJlbnQtYmFzZWxpbmUtbWV0aG9kIj5Db25zdGFudDwvc3Bhbj4gfCBOb3JtYWxpemF0aW9uOiA8c3BhbiBpZD0iY3VycmVudC1ub3JtYWxpemF0aW9uLW1vZGUiPk11bHRpcGxpY2F0aXZlPC9zcGFuPiB8IEN1cnZlIEZpdDogPHNwYW4gaWQ9ImN1cnJlbnQtcmVncmVzc2lvbi10eXBlIj5Nb25vLWV4cG9uZW50aWFsIHBsYXRlYXU8L3NwYW4+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgY3Vyc29yOiBwb2ludGVyOyBmb250LXNpemU6IDAuOXJlbTsgbWFyZ2luLXRvcDogMTJweDsiPgogICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgaWQ9Imdyb3VwLXRyaXBsaWNhdGVzLXRvZ2dsZSIgc3R5bGU9Im1hcmdpbi1yaWdodDogOHB4OyBjdXJzb3I6IHBvaW50ZXI7IiBvbmNoYW5nZT0idXBkYXRlQ2hhcnQoKTsiPgogICAgICAgIDxzcGFuPjxzdHJvbmc+U3RlcCAyOjwvc3Ryb25nPiBHcm91cCB3ZWxscyBpbnRvIHRyaXBsaWNhdGUgZ3JvdXBzPC9zcGFuPgogICAgICA8L2xhYmVsPgogICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiA0cHg7IG1hcmdpbi1sZWZ0OiAyNHB4OyI+CiAgICAgICAgV2hlbiBlbmFibGVkLCB3ZWxscyB0aGF0IGFyZSBwYXJ0IG9mIHRyaXBsaWNhdGUgZ3JvdXBzIChlLmcuLCByb3dzIEIsIEMsIEQpIGFyZSBncm91cGVkIHRvZ2V0aGVyLiBXaGVuIGRpc2FibGVkLCBlYWNoIHdlbGwgaXMgc2hvd24gaW5kaXZpZHVhbGx5LiA8c3Ryb25nPk5vdGU6PC9zdHJvbmc+IFJlcXVpcmVzIFN0ZXAgMSAobm9ybWFsaXphdGlvbikgdG8gYmUgZW5hYmxlZC4KICAgICAgPC9kaXY+CiAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgY3Vyc29yOiBwb2ludGVyOyBmb250LXNpemU6IDAuOXJlbTsgbWFyZ2luLXRvcDogMTJweDsiPgogICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgaWQ9ImN1dG9mZi1iYXNlbGluZS10b2dnbGUiIHN0eWxlPSJtYXJnaW4tcmlnaHQ6IDhweDsgY3Vyc29yOiBwb2ludGVyOyIgb25jaGFuZ2U9InVwZGF0ZUNoYXJ0KCk7Ij4KICAgICAgICA8c3Bhbj48c3Ryb25nPlN0ZXAgMzo8L3N0cm9uZz4gQ3V0b2ZmIGRhdGEgcG9pbnRzIGJlZm9yZSBmaXJzdCB0aW1lcG9pbnQgYW5kIGFmdGVyIHRpbWUgcG9pbnQ8L3NwYW4+CiAgICAgIDwvbGFiZWw+CiAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDRweDsgbWFyZ2luLWxlZnQ6IDI0cHg7Ij4KICAgICAgICBXaGVuIGVuYWJsZWQsIGRhdGEgcG9pbnRzIGJlZm9yZSB0aGUgZmlyc3QgcmVhbCB0aW1lcG9pbnQgYW5kIGFmdGVyIHRoZSBjdXRvZmYgdGltZSB3aWxsIGJlIGV4Y2x1ZGVkIGZyb20gdGhlIGdyYXBoIGRpc3BsYXkuCiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGlkPSJjdXRvZmYtYmFzZWxpbmUtcGFyYW1ldGVycyIgc3R5bGU9ImZvbnQtc2l6ZTogMC44cmVtOyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsgZGlzcGxheTogbm9uZTsgbWFyZ2luLWxlZnQ6IDI0cHg7IG1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgPHNwYW4gc3R5bGU9Im1pbi13aWR0aDogMTIwcHg7Ij5DdXRvZmYgdGltZSAocyk6PC9zcGFuPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBpZD0iY3V0b2ZmLWJhc2VsaW5lLXRpbWUiIHZhbHVlPSIzNjAiIG1pbj0iMCIgc3RlcD0iMSIgc3R5bGU9IndpZHRoOiA4MHB4OyBwYWRkaW5nOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsiIG9uY2hhbmdlPSJ1cGRhdGVDaGFydCgpOyI+CiAgICAgICAgICA8L2xhYmVsPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDRweDsiPgogICAgICAgICAgRGF0YSBwb2ludHMgYmVmb3JlIHRoZSBmaXJzdCByZWFsIHRpbWVwb2ludCBhbmQgYWZ0ZXIgdGhpcyB0aW1lIHdpbGwgYmUgZXhjbHVkZWQgKGRlZmF1bHQ6IDYgbWludXRlcyA9IDM2MCBzZWNvbmRzKS4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgY3Vyc29yOiBwb2ludGVyOyBmb250LXNpemU6IDAuOXJlbTsgbWFyZ2luLXRvcDogMTJweDsiPgogICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgaWQ9ImZpdC1yZWdyZXNzaW9uLXRvZ2dsZSIgc3R5bGU9Im1hcmdpbi1yaWdodDogOHB4OyBjdXJzb3I6IHBvaW50ZXI7IiBvbmNoYW5nZT0idXBkYXRlUmVncmVzc2lvblR5cGVQYXJhbXModHJ1ZSk7IHVwZGF0ZUNoYXJ0KCk7Ij4KICAgICAgICA8c3Bhbj48c3Ryb25nPlN0ZXAgNDo8L3N0cm9uZz4gRml0IHJlZ3Jlc3Npb24gY3VydmUgdG8gZGF0YSBwb2ludHM8L3NwYW4+CiAgICAgIDwvbGFiZWw+CiAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDRweDsgbWFyZ2luLWxlZnQ6IDI0cHg7Ij4KICAgICAgICBXaGVuIGVuYWJsZWQsIGEgcmVncmVzc2lvbiBjdXJ2ZSB3aWxsIGJlIGZpdHRlZCB0byB0aGUgZGF0YSBwb2ludHMgYW5kIGRpc3BsYXllZCBvbiB0aGUgZ3JhcGguCiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGlkPSJmaXQtcmVncmVzc2lvbi1wYXJhbWV0ZXJzIiBzdHlsZT0iZm9udC1zaXplOiAwLjhyZW07IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyBkaXNwbGF5OiBub25lOyBtYXJnaW4tbGVmdDogMjRweDsgbWFyZ2luLWJvdHRvbTogOHB4OyI+CiAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogOHB4OyI+CiAgICAgICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICA8c3BhbiBzdHlsZT0ibWluLXdpZHRoOiAxNDBweDsiPlJlZ3Jlc3Npb24gdHlwZTo8L3NwYW4+CiAgICAgICAgICAgIDxzZWxlY3QgaWQ9InJlZ3Jlc3Npb24tdHlwZS1zZWxlY3QiIHN0eWxlPSJmbGV4OiAxOyBwYWRkaW5nOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1zaXplOiAwLjg1cmVtOyIgb25jaGFuZ2U9InVwZGF0ZVJlZ3Jlc3Npb25UeXBlUGFyYW1zKCk7Ij4KICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJsaW5lYXIiPkxpbmVhcjwvb3B0aW9uPgogICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9InBvbHlub21pYWwiPlBvbHlub21pYWw8L29wdGlvbj4KICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJleHBvbmVudGlhbCI+RXhwb25lbnRpYWw8L29wdGlvbj4KICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJsb2dhcml0aG1pYyI+TG9nYXJpdGhtaWM8L29wdGlvbj4KICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJtb25vLWV4cG9uZW50aWFsIiBzZWxlY3RlZD5Nb25vLWV4cG9uZW50aWFsIChyaXNlIHRvIHBsYXRlYXUpPC9vcHRpb24+CiAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgPC9sYWJlbD4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJyZWdyZXNzaW9uLXBvbHlub21pYWwtb3JkZXIiIHN0eWxlPSJtYXJnaW4tYm90dG9tOiA4cHg7IGRpc3BsYXk6IG5vbmU7Ij4KICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDE0MHB4OyI+UG9seW5vbWlhbCBvcmRlcjo8L3NwYW4+CiAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIGlkPSJwb2x5bm9taWFsLW9yZGVyLWlucHV0IiB2YWx1ZT0iMiIgbWluPSIyIiBtYXg9IjUiIHN0ZXA9IjEiIHN0eWxlPSJ3aWR0aDogODBweDsgcGFkZGluZzogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7IiBvbmNoYW5nZT0idXBkYXRlQ2hhcnQoKTsiPgogICAgICAgICAgPC9sYWJlbD4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiA0cHg7Ij4KICAgICAgICAgIFRoZSByZWdyZXNzaW9uIGN1cnZlIHdpbGwgYmUgb3ZlcmxhaWQgb24gdGhlIGRhdGEgcG9pbnRzLgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgaWQ9InJlZ3Jlc3Npb24taW5mby1wYW5lbCIgc3R5bGU9Im1hcmdpbi10b3A6IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2U4ZjRmZDsgYm9yZGVyLXJhZGl1czogM3B4OyBib3JkZXI6IDFweCBzb2xpZCAjMmE2Y2ZmOyBkaXNwbGF5OiBub25lOyI+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7IGNvbG9yOiAjMmE2Y2ZmOyI+TW9uby1leHBvbmVudGlhbCBGaXQgUGFyYW1ldGVyczwvZGl2PgogICAgICAgICAgPGRpdiBpZD0icmVncmVzc2lvbi1pbmZvLWNvbnRlbnQiIHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7Ij4KICAgICAgICAgICAgPCEtLSBQYXJhbWV0ZXJzIHdpbGwgYmUgcG9wdWxhdGVkIGhlcmUgLS0+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgc3R5bGU9Im1hcmdpbi10b3A6IDE2cHg7IHBhZGRpbmc6IDEycHg7IGJhY2tncm91bmQ6IHdoaXRlOyBib3JkZXItcmFkaXVzOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7Ij4KICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgY3Vyc29yOiBwb2ludGVyOyBmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7IGZvbnQtc2l6ZTogMC45NXJlbTsgY29sb3I6ICMzMzM7IiBvbmNsaWNrPSJ0b2dnbGVCYXNlbGluZU9wdGlvbnMoKSI+CiAgICAgICAgPHNwYW4gaWQ9ImJhc2VsaW5lLW9wdGlvbnMtYXJyb3ciIHN0eWxlPSJtYXJnaW4tcmlnaHQ6IDhweDsiPuKWvDwvc3Bhbj4KICAgICAgICA8c3Bhbj5CYXNlbGluZSBGaXR0aW5nICYgTm9ybWFsaXphdGlvbiBPcHRpb25zPC9zcGFuPgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0iYmFzZWxpbmUtb3B0aW9ucy1jb250ZW50IiBzdHlsZT0iZGlzcGxheTogbm9uZTsgZm9udC1zaXplOiAwLjhyZW07Ij4KICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNlOGY0ZmQ7IGJvcmRlci1yYWRpdXM6IDNweDsgYm9yZGVyOiAxcHggc29saWQgIzJhNmNmZjsiPgogICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyBjb2xvcjogIzJhNmNmZjsiPlNlbGVjdCBCYXNlbGluZSBGaXR0aW5nIE1ldGhvZDwvZGl2PgogICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogOHB4OyI+CiAgICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNHB4OyBmb250LXNpemU6IDAuODVyZW07Ij4KICAgICAgICAgICAgICA8c3BhbiBzdHlsZT0ibWluLXdpZHRoOiAxNDBweDsiPk1ldGhvZDo8L3NwYW4+CiAgICAgICAgICAgICAgPHNlbGVjdCBpZD0iYmFzZWxpbmUtbWV0aG9kLXNlbGVjdCIgc3R5bGU9ImZsZXg6IDE7IHBhZGRpbmc6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsgYm9yZGVyLXJhZGl1czogM3B4OyBmb250LXNpemU6IDAuODVyZW07IiBvbmNoYW5nZT0idXBkYXRlQmFzZWxpbmVNZXRob2RQYXJhbXMoKTsiPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibG93ZXNzIj5MT1dFU1M8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9ImNvbnN0YW50IiBzZWxlY3RlZD5Db25zdGFudDwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0icG9seW5vbWlhbCI+UG9seW5vbWlhbDwvb3B0aW9uPgogICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICA8L2xhYmVsPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGlkPSJiYXNlbGluZS1sb3dlc3MtcGFyYW1zIiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsgZGlzcGxheTogbm9uZTsiPgogICAgICAgICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDRweDsgZm9udC1zaXplOiAwLjg1cmVtOyI+CiAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9Im1pbi13aWR0aDogMTQwcHg7Ij5TbW9vdGhpbmcgZnJhY3Rpb24gKGZyYWMpOjwvc3Bhbj4KICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBpZD0iYmFzZWxpbmUtZnJhYy1pbnB1dCIgdmFsdWU9IjAuNSIgbWluPSIwLjEiIG1heD0iMS4wIiBzdGVwPSIwLjEiIHN0eWxlPSJmbGV4OiAxOyBwYWRkaW5nOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsgZm9udC1zaXplOiAwLjg1cmVtOyI+CiAgICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi1sZWZ0OiAxNDBweDsgbWFyZ2luLXRvcDogMnB4OyI+CiAgICAgICAgICAgICAgSGlnaGVyID0gc21vb3RoZXIgKDAuNy0wLjkpLCBMb3dlciA9IG1vcmUgbG9jYWwgKDAuMi0wLjQpCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGlkPSJiYXNlbGluZS1wb2x5bm9taWFsLXBhcmFtcyIgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7IGRpc3BsYXk6IG5vbmU7Ij4KICAgICAgICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBtYXJnaW4tYm90dG9tOiA0cHg7IGZvbnQtc2l6ZTogMC44NXJlbTsiPgogICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDE0MHB4OyI+UG9seW5vbWlhbCBvcmRlcjo8L3NwYW4+CiAgICAgICAgICAgICAgPGlucHV0IHR5cGU9Im51bWJlciIgaWQ9ImJhc2VsaW5lLXBvbHktb3JkZXItaW5wdXQiIHZhbHVlPSIxIiBtaW49IjEiIG1heD0iNSIgc3RlcD0iMSIgc3R5bGU9ImZsZXg6IDE7IHBhZGRpbmc6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsgYm9yZGVyLXJhZGl1czogM3B4OyBmb250LWZhbWlseTogbW9ub3NwYWNlOyBmb250LXNpemU6IDAuODVyZW07Ij4KICAgICAgICAgICAgPC9sYWJlbD4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLWxlZnQ6IDE0MHB4OyBtYXJnaW4tdG9wOiAycHg7Ij4KICAgICAgICAgICAgICAxID0gbGluZWFyLCAyID0gcXVhZHJhdGljLCAzKyA9IGhpZ2hlciBvcmRlcgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE2cHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2U4ZjRmZDsgYm9yZGVyLXJhZGl1czogM3B4OyBib3JkZXI6IDFweCBzb2xpZCAjMmE2Y2ZmOyI+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7IGNvbG9yOiAjMmE2Y2ZmOyI+U2VsZWN0IE5vcm1hbGl6YXRpb24gTWV0aG9kPC9kaXY+CiAgICAgICAgICA8ZGl2PgogICAgICAgICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDRweDsgZm9udC1zaXplOiAwLjg1cmVtOyI+CiAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9Im1pbi13aWR0aDogMTQwcHg7Ij5Ob3JtYWxpemF0aW9uIG1vZGU6PC9zcGFuPgogICAgICAgICAgICAgIDxzZWxlY3QgaWQ9Im5vcm1hbGl6YXRpb24tbW9kZS1zZWxlY3QiIHN0eWxlPSJmbGV4OiAxOyBwYWRkaW5nOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1zaXplOiAwLjg1cmVtOyIgb25jaGFuZ2U9InVwZGF0ZUN1cnJlbnRTZXR0aW5nc0Rpc3BsYXkoKTsiPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iZGVsdGFfZl9vdmVyX2YiPs6URi9GIChEZWx0YSBGIG92ZXIgRik8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9Im11bHRpcGxpY2F0aXZlIiBzZWxlY3RlZD5NdWx0aXBsaWNhdGl2ZTwvb3B0aW9uPgogICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICA8L2xhYmVsPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTZweDsiPgogICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyBjb2xvcjogIzJhNmNmZjsiPkJhc2VsaW5lIEZpdHRpbmcgTWV0aG9kczwvZGl2PgogICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTJweDsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZjlmOWY5OyBib3JkZXItcmFkaXVzOiAzcHg7Ij4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+MS4gTE9XRVNTIChMb2NhbGx5IFdlaWdodGVkIFNjYXR0ZXJwbG90IFNtb290aGluZyk8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+Rm9ybXVsYTo8L3N0cm9uZz4gZyh0KSA9IExPV0VTUyhGX2Jhc2VsaW5lLCB0X2Jhc2VsaW5lLCBmcmFjKQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+V2hlbiB0byB1c2U6PC9zdHJvbmc+IEJhc2VsaW5lIGhhcyBncmFkdWFsIGRyaWZ0IG9yIG5vbi1saW5lYXIgdHJlbmRzCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5CZXN0IGZvcjo8L3N0cm9uZz4gTm9uLWxpbmVhciBiYXNlbGluZXMgd2l0aCBzbW9vdGggdHJlbmRzCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5QYXJhbWV0ZXJzOjwvc3Ryb25nPgogICAgICAgICAgICAgIDx1bCBzdHlsZT0ibWFyZ2luOiA0cHggMCAwIDIwcHg7IHBhZGRpbmctbGVmdDogMDsiPgogICAgICAgICAgICAgICAgPGxpPjxzdHJvbmc+ZnJhYzo8L3N0cm9uZz4gRnJhY3Rpb24gb2YgZGF0YSB1c2VkIGZvciBzbW9vdGhpbmcgKGRlZmF1bHQ6IDAuNSkKICAgICAgICAgICAgICAgICAgPHVsIHN0eWxlPSJtYXJnaW46IDJweCAwIDAgMjBweDsgcGFkZGluZy1sZWZ0OiAwOyI+CiAgICAgICAgICAgICAgICAgICAgPGxpPkhpZ2hlciBmcmFjICgwLjctMC45KSA9IHNtb290aGVyLCBtb3JlIGdsb2JhbCBmaXQ8L2xpPgogICAgICAgICAgICAgICAgICAgIDxsaT5Mb3dlciBmcmFjICgwLjItMC40KSA9IG1vcmUgbG9jYWwsIGZvbGxvd3MgZGF0YSBjbG9zZWx5PC9saT4KICAgICAgICAgICAgICAgICAgPC91bD4KICAgICAgICAgICAgICAgIDwvbGk+CiAgICAgICAgICAgICAgPC91bD4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDRweDsiPjIuIENPTlNUQU5UICgwdGgtb3JkZXIgcG9seW5vbWlhbCk8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+Rm9ybXVsYTo8L3N0cm9uZz4gZyh0KSA9IG1lYW4oRl9iYXNlbGluZSkgZm9yIGFsbCB0CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5XaGVuIHRvIHVzZTo8L3N0cm9uZz4gQmFzZWxpbmUgaXMgc3RhYmxlL2ZsYXQgd2l0aCBtaW5pbWFsIGRyaWZ0CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5CZXN0IGZvcjo8L3N0cm9uZz4gU3RhYmxlIGJhc2VsaW5lcyB3aXRoIG5vIHRpbWUtZGVwZW5kZW50IHRyZW5kcwogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPlBhcmFtZXRlcnM6PC9zdHJvbmc+IE5vbmUKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDRweDsiPjMuIFBPTFlOT01JQUwgKDFzdC1vcmRlciBvciBoaWdoZXIpPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkZvcm11bGE6PC9zdHJvbmc+IGcodCkgPSBj4oKAICsgY+KCgXQgKyBj4oKCdMKyICsgLi4uCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5XaGVuIHRvIHVzZTo8L3N0cm9uZz4gQmFzZWxpbmUgaGFzIGxpbmVhciBvciBwb2x5bm9taWFsIGRyaWZ0CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5CZXN0IGZvcjo8L3N0cm9uZz4gQmFzZWxpbmVzIHdpdGgga25vd24gcG9seW5vbWlhbCB0cmVuZHMKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPlBhcmFtZXRlcnM6PC9zdHJvbmc+CiAgICAgICAgICAgICAgPHVsIHN0eWxlPSJtYXJnaW46IDRweCAwIDAgMjBweDsgcGFkZGluZy1sZWZ0OiAwOyI+CiAgICAgICAgICAgICAgICA8bGk+PHN0cm9uZz5wb2x5X29yZGVyOjwvc3Ryb25nPiBQb2x5bm9taWFsIG9yZGVyIChkZWZhdWx0OiAxID0gbGluZWFyKQogICAgICAgICAgICAgICAgICA8dWwgc3R5bGU9Im1hcmdpbjogMnB4IDAgMCAyMHB4OyBwYWRkaW5nLWxlZnQ6IDA7Ij4KICAgICAgICAgICAgICAgICAgICA8bGk+T3JkZXIgMTogTGluZWFyIGRyaWZ0IChnKHQpID0gY+KCgCArIGPigoF0KTwvbGk+CiAgICAgICAgICAgICAgICAgICAgPGxpPk9yZGVyIDI6IFF1YWRyYXRpYyBkcmlmdCAoZyh0KSA9IGPigoAgKyBj4oKBdCArIGPigoJ0wrIpPC9saT4KICAgICAgICAgICAgICAgICAgICA8bGk+SGlnaGVyIG9yZGVyczogTW9yZSBjb21wbGV4IHRyZW5kczwvbGk+CiAgICAgICAgICAgICAgICAgIDwvdWw+CiAgICAgICAgICAgICAgICA8L2xpPgogICAgICAgICAgICAgIDwvdWw+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTZweDsiPgogICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyBjb2xvcjogIzJhNmNmZjsiPk5vcm1hbGl6YXRpb24gTWV0aG9kczwvZGl2PgogICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTJweDsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZjlmOWY5OyBib3JkZXItcmFkaXVzOiAzcHg7Ij4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+MS4gREVMVEFfRl9PVkVSX0YgKM6URi9GKTwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5Gb3JtdWxhOjwvc3Ryb25nPiBGJyh0KSA9IChGKHQpIC0gZyh0KSkgLyBnKHQpCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5XaGVuIHRvIHVzZTo8L3N0cm9uZz4gTWVhc3VyZSByZWxhdGl2ZSBjaGFuZ2UgZnJvbSBiYXNlbGluZQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+QmVzdCBmb3I6PC9zdHJvbmc+IERldGVjdGluZyBpbmNyZWFzZXMvZGVjcmVhc2VzIHJlbGF0aXZlIHRvIGJhc2VsaW5lCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5JbnRlcnByZXRhdGlvbjo8L3N0cm9uZz4KICAgICAgICAgICAgICA8dWwgc3R5bGU9Im1hcmdpbjogNHB4IDAgMCAyMHB4OyBwYWRkaW5nLWxlZnQ6IDA7Ij4KICAgICAgICAgICAgICAgIDxsaT5GJyh0KSA9IDA6IE5vIGNoYW5nZSBmcm9tIGJhc2VsaW5lPC9saT4KICAgICAgICAgICAgICAgIDxsaT5GJyh0KSA+IDA6IEluY3JlYXNlIGFib3ZlIGJhc2VsaW5lIChlLmcuLCAwLjUgPSA1MCUlIGluY3JlYXNlKTwvbGk+CiAgICAgICAgICAgICAgICA8bGk+RicodCkgPCAwOiBEZWNyZWFzZSBiZWxvdyBiYXNlbGluZSAoZS5nLiwgLTAuMyA9IDMwJSUgZGVjcmVhc2UpPC9saT4KICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7Ij4KICAgICAgICAgICAgICBWYWx1ZXMgY2FuIGJlIG5lZ2F0aXZlIChiZWxvdyBiYXNlbGluZSkgb3IgcG9zaXRpdmUgKGFib3ZlIGJhc2VsaW5lKQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTJweDsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZjlmOWY5OyBib3JkZXItcmFkaXVzOiAzcHg7Ij4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+Mi4gTVVMVElQTElDQVRJVkU8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+Rm9ybXVsYTo8L3N0cm9uZz4gRl9ub3JtKHQpID0gRih0KSAvIGcodCkKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPldoZW4gdG8gdXNlOjwvc3Ryb25nPiBOb3JtYWxpemUgYnkgYmFzZWxpbmUgd2l0aG91dCBzdWJ0cmFjdGluZwogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+QmVzdCBmb3I6PC9zdHJvbmc+IEZvbGQtY2hhbmdlIGFuYWx5c2lzCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5JbnRlcnByZXRhdGlvbjo8L3N0cm9uZz4KICAgICAgICAgICAgICA8dWwgc3R5bGU9Im1hcmdpbjogNHB4IDAgMCAyMHB4OyBwYWRkaW5nLWxlZnQ6IDA7Ij4KICAgICAgICAgICAgICAgIDxsaT5GX25vcm0odCkgPSAxLjA6IE5vIGNoYW5nZSBmcm9tIGJhc2VsaW5lPC9saT4KICAgICAgICAgICAgICAgIDxsaT5GX25vcm0odCkgPSAyLjA6IDItZm9sZCBpbmNyZWFzZSAoMTAwJSUgaW5jcmVhc2UpPC9saT4KICAgICAgICAgICAgICAgIDxsaT5GX25vcm0odCkgPSAwLjU6IDItZm9sZCBkZWNyZWFzZSAoNTAlJSBvZiBiYXNlbGluZSk8L2xpPgogICAgICAgICAgICAgIDwvdWw+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsiPgogICAgICAgICAgICAgIFZhbHVlcyBhcmUgYWx3YXlzIHBvc2l0aXZlIChyYXRpbyB0byBiYXNlbGluZSkKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2PgogICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyBjb2xvcjogIzJhNmNmZjsiPlN0YXRpc3RpY3MgQ29tcHV0YXRpb248L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9InBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICAgICAgICAgIEZvciBlYWNoIGNvbmRpdGlvbiBhbmQgdGltZXBvaW50LCB0aGUgZm9sbG93aW5nIHN0YXRpc3RpY3MgYXJlIGNvbXB1dGVkOgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogNnB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5NZWFuOjwvc3Ryb25nPiDOvCh0KSA9ICgxL24pIMOXIM6jIEYnKHQpCiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IGZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7Ij4KICAgICAgICAgICAgICAgIEF2ZXJhZ2Ugbm9ybWFsaXplZCB2YWx1ZSBhY3Jvc3MgYWxsIHdlbGxzIGluIHRoZSBjb25kaXRpb24KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDZweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+U0Q6PC9zdHJvbmc+IM+DKHQpID0gc3FydCjOoyhGJyh0KSAtIM68KHQpKcKyIC8gKG4tMSkpCiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IGZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7Ij4KICAgICAgICAgICAgICAgIFNhbXBsZSBzdGFuZGFyZCBkZXZpYXRpb24gKGRkb2Y9MSkgYWNyb3NzIHdlbGxzCiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgIDxzdHJvbmc+U0VNOjwvc3Ryb25nPiBTRU0odCkgPSDPgyh0KSAvIHNxcnQobikKICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsiPgogICAgICAgICAgICAgICAgU3RhbmRhcmQgZXJyb3Igb2YgdGhlIG1lYW4gPSBTRCAvIHNxcnQobl93ZWxscykKICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLXRvcDogNHB4OyI+CiAgICAgICAgICAgICAgICA8c3Ryb25nPk5vdGU6PC9zdHJvbmc+IFNFTSBpcyBjb21wdXRlZCBhY3Jvc3Mgd2VsbHMsIG5vdCBwcm9wYWdhdGVkIGZyb20gYmFzZWxpbmUgZXJyb3IKICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tcHJpbWFyeSIgb25jbGljaz0idXBkYXRlQ2hhcnQoKSIgc3R5bGU9Im1hcmdpbi10b3A6IDE2cHg7Ij5VcGRhdGUgQ2hhcnQ8L2J1dHRvbj4KICAgIDxidXR0b24gY2xhc3M9ImJ0biIgb25jbGljaz0iY2xlYXJTZWxlY3Rpb24oKSI+Q2xlYXIgU2VsZWN0aW9uPC9idXR0b24+CiAgICA8ZGl2IGlkPSJ3ZWxsLWluZm8iIHN0eWxlPSJtYXJnaW4tdG9wOiAxNnB4OyI+Q2xpY2sgd2VsbHMgb24gdGhlIHBsYXRlIHRvIGFkZCB0aGVtIHRvIHRoZSBjaGFydC48L2Rpdj4KICA8L2FzaWRlPgogIDxtYWluPgogICAgPGRpdiBpZD0icGxhdGUtZ3JpZCI+PC9kaXY+CiAgICA8ZGl2IGlkPSJjaGFydC1jb250YWluZXIiPgogICAgICA8Y2FudmFzIGlkPSJ3ZWxsLWNoYXJ0Ij48L2NhbnZhcz4KICAgIDwvZGl2PgogIDwvbWFpbj4KICA8L2Rpdj4KCjxzY3JpcHQ+CmNvbnN0IFBMQVRFX1JPV1MgPSAiJShyb3dzKXMiLnNwbGl0KCIiKTsKY29uc3QgUExBVEVfQ09MUyA9ICUoY29scylkOwoKbGV0IHZpZXdlckRhdGEgPSBudWxsOwpsZXQgY2hhcnQgPSBudWxsOwpsZXQgc2VsZWN0ZWRXZWxscyA9IG5ldyBTZXQoKTsgLy8gU2V0IG9mIHtwbGF0ZUlkOndlbGxJZH0gc3RyaW5ncwpsZXQgYWxsV2VsbHNEYXRhID0ge307IC8vIENvbWJpbmVkIHdlbGxzIGZyb20gYWxsIHBsYXRlczoge3BsYXRlSWQ6IHt3ZWxsSWQ6IHsuLi59fX0KbGV0IHNlbGVjdGVkRGF0YXNldElkID0gbnVsbDsgLy8gQ3VycmVudGx5IHNlbGVjdGVkIGRhdGFzZXQgSUQKbGV0IGVuYWJsZWREYXRhc2V0cyA9IG5ldyBTZXQoKTsgLy8gU2V0IG9mIGVuYWJsZWQgZGF0YXNldCBJRHMgKGVtcHR5ID0gYWxsIGVuYWJsZWQpCmxldCBlbmFibGVkV2VsbHMgPSBuZXcgU2V0KCk7IC8vIFNldCBvZiBlbmFibGVkIHdlbGwgSURzIChlbXB0eSA9IGFsbCBlbmFibGVkKQpsZXQgZW5hYmxlZENvbHVtbnMgPSBuZXcgU2V0KCk7IC8vIFNldCBvZiBlbmFibGVkIGNvbHVtbiBudW1iZXJzIChlbXB0eSA9IGFsbCBlbmFibGVkKQoKLy8gUmVnaXN0ZXIgZXJyb3IgYmFyIHBsdWdpbiBnbG9iYWxseQpDaGFydC5yZWdpc3Rlcih7CiAgaWQ6ICJlcnJvckJhcnMiLAogIGFmdGVyRGF0YXNldHNEcmF3OiAoY2hhcnQpID0+IHsKICAgIGNvbnN0IGN0eCA9IGNoYXJ0LmN0eDsKICAgIGNoYXJ0LmRhdGEuZGF0YXNldHMuZm9yRWFjaCgoZGF0YXNldCwgZGF0YXNldEluZGV4KSA9PiB7CiAgICAgIGlmICghZGF0YXNldC5kYXRhIHx8IGRhdGFzZXQuZGF0YS5sZW5ndGggPT09IDApIHJldHVybjsKICAgICAgCiAgICAgIC8vIENoZWNrIGlmIGFueSBkYXRhIHBvaW50IGhhcyBlcnJvciBpbmZvcm1hdGlvbgogICAgICBjb25zdCBoYXNFcnJvcnMgPSBkYXRhc2V0LmRhdGEuc29tZShkID0+IGQgJiYgZC5lcnJvciAhPT0gdW5kZWZpbmVkICYmIGQuZXJyb3IgIT09IG51bGwpOwogICAgICBpZiAoIWhhc0Vycm9ycykgcmV0dXJuOwogICAgICAKICAgICAgY29uc3QgbWV0YSA9IGNoYXJ0LmdldERhdGFzZXRNZXRhKGRhdGFzZXRJbmRleCk7CiAgICAgIGN0eC5zYXZlKCk7CiAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGRhdGFzZXQuYm9yZGVyQ29sb3IgfHwgInJnYmEoMCwwLDAsMC41KSI7CiAgICAgIGN0eC5saW5lV2lkdGggPSAxOwogICAgICAKICAgICAgbWV0YS5kYXRhLmZvckVhY2goKHBvaW50LCBpbmRleCkgPT4gewogICAgICAgIGlmICghcG9pbnQgfHwgIWRhdGFzZXQuZGF0YVtpbmRleF0gfHwgZGF0YXNldC5kYXRhW2luZGV4XS5lcnJvciA9PT0gdW5kZWZpbmVkIHx8IGRhdGFzZXQuZGF0YVtpbmRleF0uZXJyb3IgPT09IG51bGwpIHJldHVybjsKICAgICAgICAKICAgICAgICBjb25zdCB4ID0gcG9pbnQueDsKICAgICAgICBjb25zdCB5ID0gcG9pbnQueTsKICAgICAgICBjb25zdCBlcnJvciA9IGRhdGFzZXQuZGF0YVtpbmRleF0uZXJyb3I7CiAgICAgICAgY29uc3QgeVNjYWxlID0gY2hhcnQuc2NhbGVzLnk7CiAgICAgICAgY29uc3QgZXJyb3JQaXhlbHMgPSBNYXRoLmFicyh5U2NhbGUuZ2V0UGl4ZWxGb3JWYWx1ZSh5ICsgZXJyb3IpIC0geVNjYWxlLmdldFBpeGVsRm9yVmFsdWUoeSkpOwogICAgICAgIAogICAgICAgIC8vIERyYXcgdmVydGljYWwgZXJyb3IgYmFyCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oeCwgeSAtIGVycm9yUGl4ZWxzKTsKICAgICAgICBjdHgubGluZVRvKHgsIHkgKyBlcnJvclBpeGVscyk7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIAogICAgICAgIC8vIERyYXcgaG9yaXpvbnRhbCBjYXBzCiAgICAgICAgY29uc3QgY2FwV2lkdGggPSA0OwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKHggLSBjYXBXaWR0aCwgeSAtIGVycm9yUGl4ZWxzKTsKICAgICAgICBjdHgubGluZVRvKHggKyBjYXBXaWR0aCwgeSAtIGVycm9yUGl4ZWxzKTsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oeCAtIGNhcFdpZHRoLCB5ICsgZXJyb3JQaXhlbHMpOwogICAgICAgIGN0eC5saW5lVG8oeCArIGNhcFdpZHRoLCB5ICsgZXJyb3JQaXhlbHMpOwogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgfSk7CiAgICAgIAogICAgICBjdHgucmVzdG9yZSgpOwogICAgfSk7CiAgfQp9KTsKCi8vIFJlZ2lzdGVyIGJhc2VsaW5lIGxhYmVsIHBsdWdpbiB0byBkaXNwbGF5IGJhc2VsaW5lIG51bWJlcnMgb24gdGhlIGNoYXJ0CkNoYXJ0LnJlZ2lzdGVyKHsKICBpZDogImJhc2VsaW5lTGFiZWxzIiwKICBhZnRlckRhdGFzZXRzRHJhdzogKGNoYXJ0KSA9PiB7CiAgICBjb25zdCBjdHggPSBjaGFydC5jdHg7CiAgICBjb25zdCB4U2NhbGUgPSBjaGFydC5zY2FsZXMueDsKICAgIGNvbnN0IHlTY2FsZSA9IGNoYXJ0LnNjYWxlcy55OwogICAgCiAgICBjaGFydC5kYXRhLmRhdGFzZXRzLmZvckVhY2goKGRhdGFzZXQsIGRhdGFzZXRJbmRleCkgPT4gewogICAgICAvLyBPbmx5IHByb2Nlc3MgYmFzZWxpbmUgbGluZXMgKGlkZW50aWZpZWQgYnkgaGF2aW5nIGV4YWN0bHkgMiBwb2ludHMgYW5kIG9yZGVyID09PSAxMDAwKQogICAgICBpZiAoIWRhdGFzZXQuZGF0YSB8fCBkYXRhc2V0LmRhdGEubGVuZ3RoICE9PSAyIHx8IGRhdGFzZXQub3JkZXIgIT09IDEwMDApIHJldHVybjsKICAgICAgCiAgICAgIC8vIEV4dHJhY3QgYmFzZWxpbmUgdmFsdWUgZnJvbSBsYWJlbCAoZm9ybWF0OiAibGFiZWwgKGJhc2VsaW5lOiB2YWx1ZSkiKQogICAgICBjb25zdCBiYXNlbGluZU1hdGNoID0gZGF0YXNldC5sYWJlbC5tYXRjaCgvXChiYXNlbGluZTpccyooW1xkLl0rKVwpLyk7CiAgICAgIGlmICghYmFzZWxpbmVNYXRjaCkgcmV0dXJuOwogICAgICAKICAgICAgY29uc3QgYmFzZWxpbmVWYWx1ZSA9IHBhcnNlRmxvYXQoYmFzZWxpbmVNYXRjaFsxXSk7CiAgICAgIGlmIChpc05hTihiYXNlbGluZVZhbHVlKSkgcmV0dXJuOwogICAgICAKICAgICAgLy8gR2V0IHRoZSB5IHBvc2l0aW9uIG9mIHRoZSBiYXNlbGluZQogICAgICBjb25zdCBiYXNlbGluZVkgPSBkYXRhc2V0LmRhdGFbMF0ueTsKICAgICAgY29uc3QgeVBpeGVsID0geVNjYWxlLmdldFBpeGVsRm9yVmFsdWUoYmFzZWxpbmVZKTsKICAgICAgCiAgICAgIC8vIFBvc2l0aW9uIHRleHQgYXQgdGhlIHJpZ2h0IGVkZ2Ugb2YgdGhlIGNoYXJ0LCBzbGlnaHRseSBvZmZzZXQgZnJvbSB0aGUgbGluZQogICAgICBjb25zdCBjaGFydEFyZWEgPSBjaGFydC5jaGFydEFyZWE7CiAgICAgIGNvbnN0IHRleHRYID0gY2hhcnRBcmVhLnJpZ2h0IC0gMTA7IC8vIDEwcHggZnJvbSByaWdodCBlZGdlCiAgICAgIGNvbnN0IHRleHRZID0geVBpeGVsIC0gNTsgLy8gNXB4IGFib3ZlIHRoZSBsaW5lCiAgICAgIAogICAgICBjdHguc2F2ZSgpOwogICAgICBjdHguZm9udCA9ICIxMnB4IEFyaWFsIjsKICAgICAgY3R4LmZpbGxTdHlsZSA9IGRhdGFzZXQuYm9yZGVyQ29sb3IgfHwgInJnYmEoMTI4LCAxMjgsIDEyOCwgMC43KSI7CiAgICAgIGN0eC50ZXh0QWxpZ24gPSAicmlnaHQiOwogICAgICBjdHgudGV4dEJhc2VsaW5lID0gImJvdHRvbSI7CiAgICAgIAogICAgICAvLyBEcmF3IGJhY2tncm91bmQgcmVjdGFuZ2xlIGZvciBiZXR0ZXIgcmVhZGFiaWxpdHkKICAgICAgY29uc3QgdGV4dCA9IGJhc2VsaW5lVmFsdWUudG9GaXhlZCgyKTsKICAgICAgY29uc3QgdGV4dE1ldHJpY3MgPSBjdHgubWVhc3VyZVRleHQodGV4dCk7CiAgICAgIGNvbnN0IHBhZGRpbmcgPSA0OwogICAgICBjdHguZmlsbFN0eWxlID0gInJnYmEoMjU1LCAyNTUsIDI1NSwgMC44KSI7CiAgICAgIGN0eC5maWxsUmVjdCgKICAgICAgICB0ZXh0WCAtIHRleHRNZXRyaWNzLndpZHRoIC0gcGFkZGluZywKICAgICAgICB0ZXh0WSAtIDEyIC0gcGFkZGluZywKICAgICAgICB0ZXh0TWV0cmljcy53aWR0aCArIHBhZGRpbmcgKiAyLAogICAgICAgIDEyICsgcGFkZGluZyAqIDIKICAgICAgKTsKICAgICAgCiAgICAgIC8vIERyYXcgdGhlIHRleHQKICAgICAgY3R4LmZpbGxTdHlsZSA9IGRhdGFzZXQuYm9yZGVyQ29sb3IgfHwgInJnYmEoMTI4LCAxMjgsIDEyOCwgMC45KSI7CiAgICAgIGN0eC5maWxsVGV4dCh0ZXh0LCB0ZXh0WCwgdGV4dFkpOwogICAgICAKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgIH0pOwogIH0KfSk7CgpmdW5jdGlvbiBkaXNwbGF5V2FybmluZ3MoKSB7CiAgY29uc3Qgd2FybmluZ0Jhbm5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ3YXJuaW5nLWJhbm5lciIpOwogIGlmICghd2FybmluZ0Jhbm5lciB8fCAhdmlld2VyRGF0YSB8fCAhdmlld2VyRGF0YS5jb25maWcpIHsKICAgIHJldHVybjsKICB9CiAgCiAgY29uc3Qgd2FybmluZ3MgPSB2aWV3ZXJEYXRhLmNvbmZpZy53YXJuaW5ncyB8fCB7fTsKICBjb25zdCBkdXBsaWNhdGVDb2x1bW5zID0gd2FybmluZ3MuZHVwbGljYXRlX2NvbHVtbnMgfHwgW107CiAgCiAgaWYgKGR1cGxpY2F0ZUNvbHVtbnMubGVuZ3RoID09PSAwKSB7CiAgICB3YXJuaW5nQmFubmVyLmNsYXNzTGlzdC5yZW1vdmUoInNob3ciKTsKICAgIHJldHVybjsKICB9CiAgCiAgLy8gQnVpbGQgd2FybmluZyBtZXNzYWdlIC0gc2hvcnRlciB2ZXJzaW9uCiAgbGV0IGh0bWwgPSAnPGgzPuKaoO+4jyBXYXJuaW5nOiBEdXBsaWNhdGUgV2VsbHMgRGV0ZWN0ZWQ8L2gzPic7CiAgCiAgZHVwbGljYXRlQ29sdW1ucy5mb3JFYWNoKHdhcm5pbmcgPT4gewogICAgY29uc3QgZmlsZXMgPSB3YXJuaW5nLmZpbGVzIHx8IFtdOwogICAgY29uc3Qgd2VsbElkcyA9IHdhcm5pbmcud2VsbF9pZHMgfHwgW107CiAgICBjb25zdCBmaWxlc1N0ciA9IGZpbGVzLmpvaW4oIiBhbmQgIik7CiAgICBjb25zdCB3ZWxsc1N0ciA9IHdlbGxJZHMubGVuZ3RoIDw9IDEwIAogICAgICA/IHdlbGxJZHMuam9pbigiLCAiKQogICAgICA6IHdlbGxJZHMuc2xpY2UoMCwgMTApLmpvaW4oIiwgIikgKyBgLCAuLi4gKCR7d2VsbElkcy5sZW5ndGh9IHRvdGFsKWA7CiAgICAKICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDhweDsiPjxzdHJvbmc+JHtmaWxlc1N0cn08L3N0cm9uZz4gaGF2ZSBkdXBsaWNhdGUgd2VsbHM6ICR7d2VsbHNTdHJ9PC9kaXY+YDsKICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxNnB4OyBmb250LXNpemU6IDAuODVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tYm90dG9tOiAxMnB4OyI+T25seSBkYXRhIGZyb20gJzxzdHJvbmc+JHtmaWxlc1swXX08L3N0cm9uZz4nIChmaXJzdCBhbHBoYWJldGljYWxseSkgaXMgdXNlZC48L2Rpdj5gOwogIH0pOwogIAogIHdhcm5pbmdCYW5uZXIuaW5uZXJIVE1MID0gaHRtbDsKICB3YXJuaW5nQmFubmVyLmNsYXNzTGlzdC5hZGQoInNob3ciKTsKfQoKYXN5bmMgZnVuY3Rpb24gbG9hZERhdGEoKSB7CiAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2goInZpZXdlcl9kYXRhLmpzb24iKTsKICB2aWV3ZXJEYXRhID0gYXdhaXQgcmVzLmpzb24oKTsKICBjb21iaW5lQWxsV2VsbHMoKTsKICAvLyBJbml0aWFsaXplIHRyaXBsaWNhdGUgZ3JvdXAgY29sb3JzIGJlZm9yZSByZW5kZXJpbmcKICBpbml0aWFsaXplVHJpcGxpY2F0ZUdyb3VwQ29sb3JzKCk7CiAgZGlzcGxheVdhcm5pbmdzKCk7CiAgaW5pdERhdGFzZXRTZWxlY3QoKTsKICByZW5kZXJQbGF0ZUdyaWQoKTsKfQoKZnVuY3Rpb24gY29tYmluZUFsbFdlbGxzKCkgewogIC8vIENvbWJpbmUgYWxsIHdlbGxzIGZyb20gYWxsIHBsYXRlcyBpbnRvIGEgc2luZ2xlIHN0cnVjdHVyZQogIGFsbFdlbGxzRGF0YSA9IHt9OwogIHZpZXdlckRhdGEucGxhdGVzLmZvckVhY2gocGxhdGUgPT4gewogICAgYWxsV2VsbHNEYXRhW3BsYXRlLmlkXSA9IHBsYXRlLndlbGxzOwogIH0pOwp9CgpmdW5jdGlvbiBpbml0RGF0YXNldFNlbGVjdCgpIHsKICBjb25zdCBzZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZGF0YXNldC1zZWxlY3QiKTsKICBzZWxlY3QuaW5uZXJIVE1MID0gIiI7CiAgCiAgLy8gR3JvdXAgcGxhdGVzIGJ5IGNvbHVtbl9ncm91cAogIGNvbnN0IHBsYXRlc0J5R3JvdXAgPSB7fTsKICB2aWV3ZXJEYXRhLnBsYXRlcy5mb3JFYWNoKHBsYXRlID0+IHsKICAgIGNvbnN0IGdyb3VwID0gcGxhdGUuY29sdW1uX2dyb3VwIHx8ICJPdGhlciI7CiAgICBpZiAoIXBsYXRlc0J5R3JvdXBbZ3JvdXBdKSB7CiAgICAgIHBsYXRlc0J5R3JvdXBbZ3JvdXBdID0gW107CiAgICB9CiAgICBwbGF0ZXNCeUdyb3VwW2dyb3VwXS5wdXNoKHBsYXRlKTsKICB9KTsKICAKICAvLyBTb3J0IGdyb3VwcyBhbHBoYWJldGljYWxseQogIGNvbnN0IHNvcnRlZEdyb3VwcyA9IE9iamVjdC5rZXlzKHBsYXRlc0J5R3JvdXApLnNvcnQoKTsKICAKICAvLyBDcmVhdGUgb3B0aW9ucyBmb3IgZWFjaCBncm91cCAodGhlIGdyb3VwIGl0c2VsZiBpcyBzZWxlY3RhYmxlKQogIHNvcnRlZEdyb3Vwcy5mb3JFYWNoKGdyb3VwTmFtZSA9PiB7CiAgICBjb25zdCBwbGF0ZXMgPSBwbGF0ZXNCeUdyb3VwW2dyb3VwTmFtZV07CiAgICAKICAgIGNvbnN0IG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpOwogICAgLy8gVXNlIHNwZWNpYWwgcHJlZml4IHRvIGlkZW50aWZ5IGdyb3VwIHNlbGVjdGlvbnMKICAgIG9wdGlvbi52YWx1ZSA9IGBncm91cDoke2dyb3VwTmFtZX1gOwogICAgCiAgICAvLyBDcmVhdGUgZnJpZW5kbHkgbmFtZSBmcm9tIGZpcnN0IHBsYXRlJ3MgY29sdW1uIGluZm8KICAgIGNvbnN0IGZpcnN0UGxhdGUgPSBwbGF0ZXNbMF07CiAgICBjb25zdCBjb2x1bW5JbmZvID0gZmlyc3RQbGF0ZS5jb2x1bW5faW5mbyB8fCB7fTsKICAgIGNvbnN0IHBhcnRzID0gW107CiAgICBpZiAoY29sdW1uSW5mby5wcm90ZWluKSBwYXJ0cy5wdXNoKGNvbHVtbkluZm8ucHJvdGVpbik7CiAgICBpZiAoY29sdW1uSW5mby5nZW5vdHlwZSkgcGFydHMucHVzaChjb2x1bW5JbmZvLmdlbm90eXBlKTsKICAgIGlmIChjb2x1bW5JbmZvLmJ1ZmZlcikgcGFydHMucHVzaChjb2x1bW5JbmZvLmJ1ZmZlcik7CiAgICAKICAgIC8vIEFkZCBjb3VudCBpZiBtdWx0aXBsZSBkYXRhc2V0cwogICAgaWYgKHBsYXRlcy5sZW5ndGggPiAxKSB7CiAgICAgIG9wdGlvbi50ZXh0Q29udGVudCA9IHBhcnRzLmxlbmd0aCA+IDAgCiAgICAgICAgPyBgJHtwYXJ0cy5qb2luKCIgLSAiKX0gKCR7cGxhdGVzLmxlbmd0aH0gZGF0YXNldHMpYAogICAgICAgIDogYCR7Z3JvdXBOYW1lfSAoJHtwbGF0ZXMubGVuZ3RofSBkYXRhc2V0cylgOwogICAgfSBlbHNlIHsKICAgICAgb3B0aW9uLnRleHRDb250ZW50ID0gcGFydHMubGVuZ3RoID4gMCAKICAgICAgICA/IHBhcnRzLmpvaW4oIiAtICIpCiAgICAgICAgOiBncm91cE5hbWU7CiAgICB9CiAgICAKICAgIHNlbGVjdC5hcHBlbmRDaGlsZChvcHRpb24pOwogIH0pOwogIAogIC8vIFNlbGVjdCBmaXJzdCBncm91cCBieSBkZWZhdWx0CiAgaWYgKHNvcnRlZEdyb3Vwcy5sZW5ndGggPiAwKSB7CiAgICBzZWxlY3RlZERhdGFzZXRJZCA9IGBncm91cDoke3NvcnRlZEdyb3Vwc1swXX1gOwogICAgc2VsZWN0LnZhbHVlID0gc2VsZWN0ZWREYXRhc2V0SWQ7CiAgfQogIAogIHNlbGVjdC5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCAoKSA9PiB7CiAgICBzZWxlY3RlZERhdGFzZXRJZCA9IHNlbGVjdC52YWx1ZTsKICAgIC8vIENsZWFuIHVwIHNlbGVjdGVkIHdlbGxzIC0gb25seSBrZWVwIHdlbGxzIGZyb20gc2VsZWN0ZWQgZGF0YXNldHMKICAgIGNvbnN0IHNlbGVjdGVkRGF0YXNldHMgPSBnZXRTZWxlY3RlZERhdGFzZXRzKCk7CiAgICBjb25zdCBuZXdTZWxlY3RlZFdlbGxzID0gbmV3IFNldCgpOwogICAgc2VsZWN0ZWRXZWxscy5mb3JFYWNoKGtleSA9PiB7CiAgICAgIGNvbnN0IFtwbGF0ZUlkXSA9IGtleS5zcGxpdCgiOiIpOwogICAgICBpZiAoc2VsZWN0ZWREYXRhc2V0cy5pbmNsdWRlcyhwbGF0ZUlkKSkgewogICAgICAgIG5ld1NlbGVjdGVkV2VsbHMuYWRkKGtleSk7CiAgICAgIH0KICAgIH0pOwogICAgc2VsZWN0ZWRXZWxscyA9IG5ld1NlbGVjdGVkV2VsbHM7CiAgICAvLyBSZXNldCBlbmFibGVkIGRhdGFzZXRzL3dlbGxzL2NvbHVtbnMgd2hlbiBjaGFuZ2luZyBkYXRhc2V0IGdyb3VwCiAgICBlbmFibGVkRGF0YXNldHMuY2xlYXIoKTsKICAgIGVuYWJsZWRXZWxscy5jbGVhcigpOwogICAgZW5hYmxlZENvbHVtbnMuY2xlYXIoKTsKICAgIAogICAgcmVuZGVyUGxhdGVHcmlkKCk7CiAgICB1cGRhdGVXZWxsSW5mbygpOwogICAgdXBkYXRlRGF0YXNldEluZm8oKTsKICAgIHJlbmRlcldlbGxTZWxlY3RvckdyaWQoKTsKICB9KTsKICAKICAvLyBVcGRhdGUgaW5mbyBvbiBpbml0aWFsIGxvYWQKICB1cGRhdGVEYXRhc2V0SW5mbygpOwp9CgpmdW5jdGlvbiB1cGRhdGVEYXRhc2V0SW5mbygpIHsKICBjb25zdCBpbmZvRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImRhdGFzZXQtZGV0YWlscyIpOwogIGlmICghaW5mb0RpdiB8fCAhc2VsZWN0ZWREYXRhc2V0SWQpIHsKICAgIGlmIChpbmZvRGl2KSB7CiAgICAgIGluZm9EaXYudGV4dENvbnRlbnQgPSAiU2VsZWN0IGEgZGF0YXNldCB0byB2aWV3IGRldGFpbHMuIjsKICAgIH0KICAgIHJldHVybjsKICB9CiAgCiAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICBpZiAoc2VsZWN0ZWREYXRhc2V0cy5sZW5ndGggPT09IDApIHsKICAgIGluZm9EaXYudGV4dENvbnRlbnQgPSAiTm8gZGF0YXNldCBzZWxlY3RlZC4iOwogICAgcmV0dXJuOwogIH0KICAKICAvLyBHZXQgbWV0YWRhdGEgZnJvbSBmaXJzdCBkYXRhc2V0CiAgY29uc3QgZmlyc3RQbGF0ZSA9IHZpZXdlckRhdGEucGxhdGVzLmZpbmQocCA9PiBwLmlkID09PSBzZWxlY3RlZERhdGFzZXRzWzBdKTsKICBpZiAoIWZpcnN0UGxhdGUpIHsKICAgIGluZm9EaXYudGV4dENvbnRlbnQgPSAiRGF0YXNldCBpbmZvcm1hdGlvbiBub3QgYXZhaWxhYmxlLiI7CiAgICByZXR1cm47CiAgfQogIAogIGNvbnN0IGNvbHVtbkluZm8gPSBmaXJzdFBsYXRlLmNvbHVtbl9pbmZvIHx8IHt9OwogIGNvbnN0IGFsbFBsYXRlcyA9IHZpZXdlckRhdGEucGxhdGVzLmZpbHRlcihwID0+IHNlbGVjdGVkRGF0YXNldHMuaW5jbHVkZXMocC5pZCkpOwogIAogIC8vIEJ1aWxkIGluZm8gSFRNTAogIGxldCBodG1sID0gIiI7CiAgCiAgaWYgKGNvbHVtbkluZm8ucHJvdGVpbikgewogICAgaHRtbCArPSBgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogNHB4OyI+PHN0cm9uZz5Qcm90ZWluOjwvc3Ryb25nPiAke2NvbHVtbkluZm8ucHJvdGVpbn08L2Rpdj5gOwogIH0KICBpZiAoY29sdW1uSW5mby5nZW5vdHlwZSkgewogICAgaHRtbCArPSBgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogNHB4OyI+PHN0cm9uZz5HZW5vdHlwZTo8L3N0cm9uZz4gJHtjb2x1bW5JbmZvLmdlbm90eXBlfTwvZGl2PmA7CiAgfQogIGlmIChjb2x1bW5JbmZvLmJ1ZmZlcikgewogICAgaHRtbCArPSBgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogNHB4OyI+PHN0cm9uZz5CdWZmZXI6PC9zdHJvbmc+ICR7Y29sdW1uSW5mby5idWZmZXJ9PC9kaXY+YDsKICB9CiAgaWYgKGNvbHVtbkluZm8uc2NpZW50aXN0KSB7CiAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA0cHg7Ij48c3Ryb25nPlNjaWVudGlzdDo8L3N0cm9uZz4gJHtjb2x1bW5JbmZvLnNjaWVudGlzdH08L2Rpdj5gOwogIH0KICAKICBodG1sICs9IGA8ZGl2IHN0eWxlPSJtYXJnaW4tdG9wOiA4cHg7IHBhZGRpbmctdG9wOiA4cHg7IGJvcmRlci10b3A6IDFweCBzb2xpZCAjZGRkOyI+YDsKICBodG1sICs9IGA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA0cHg7Ij48c3Ryb25nPkRhdGFzZXRzOjwvc3Ryb25nPiAke2FsbFBsYXRlcy5sZW5ndGh9PC9kaXY+YDsKICBodG1sICs9IGA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuOHJlbTsgY29sb3I6ICM2NjY7Ij5gOwogIGFsbFBsYXRlcy5mb3JFYWNoKChwbGF0ZSwgaWR4KSA9PiB7CiAgICBodG1sICs9IGAke2lkeCArIDF9LiAke3BsYXRlLmZpbGUgfHwgcGxhdGUuaWR9YDsKICAgIGlmIChwbGF0ZS5jb2x1bW5faW5mbyAmJiBwbGF0ZS5jb2x1bW5faW5mby5udW1iZXIpIHsKICAgICAgaHRtbCArPSBgICgke3BsYXRlLmNvbHVtbl9pbmZvLm51bWJlcn0pYDsKICAgIH0KICAgIGh0bWwgKz0gIjxicj4iOwogIH0pOwogIGh0bWwgKz0gYDwvZGl2PjwvZGl2PmA7CiAgCiAgaW5mb0Rpdi5pbm5lckhUTUwgPSBodG1sOwp9CgpmdW5jdGlvbiBnZXRTZWxlY3RlZERhdGFzZXRzKCkgewogIC8vIFJldHVybiBhbGwgZGF0YXNldHMgaW4gdGhlIHNlbGVjdGVkIGdyb3VwLCBmaWx0ZXJlZCBieSBlbmFibGVkRGF0YXNldHMKICBpZiAoIXNlbGVjdGVkRGF0YXNldElkKSB7CiAgICByZXR1cm4gW107CiAgfQogIAogIGxldCBkYXRhc2V0cyA9IFtdOwogIAogIC8vIENoZWNrIGlmIGl0J3MgYSBncm91cCBzZWxlY3Rpb24gKGZvcm1hdDogImdyb3VwOkdST1VQX05BTUUiKQogIGlmIChzZWxlY3RlZERhdGFzZXRJZC5zdGFydHNXaXRoKCJncm91cDoiKSkgewogICAgY29uc3QgZ3JvdXBOYW1lID0gc2VsZWN0ZWREYXRhc2V0SWQuc3Vic3RyaW5nKDYpOyAvLyBSZW1vdmUgImdyb3VwOiIgcHJlZml4CiAgICBjb25zdCBzZWxlY3RlZFBsYXRlcyA9IHZpZXdlckRhdGEucGxhdGVzLmZpbHRlcihwID0+IHAuY29sdW1uX2dyb3VwID09PSBncm91cE5hbWUpOwogICAgZGF0YXNldHMgPSBzZWxlY3RlZFBsYXRlcy5tYXAocCA9PiBwLmlkKTsKICB9IGVsc2UgewogICAgLy8gT3RoZXJ3aXNlLCBpdCdzIGEgc2luZ2xlIGRhdGFzZXQgc2VsZWN0aW9uIChsZWdhY3kgc3VwcG9ydCkKICAgIGNvbnN0IHBsYXRlID0gdmlld2VyRGF0YS5wbGF0ZXMuZmluZChwID0+IHAuaWQgPT09IHNlbGVjdGVkRGF0YXNldElkKTsKICAgIGlmIChwbGF0ZSkgewogICAgICBkYXRhc2V0cyA9IFtzZWxlY3RlZERhdGFzZXRJZF07CiAgICB9CiAgfQogIAogIC8vIEZpbHRlciBieSBlbmFibGVkRGF0YXNldHMgaWYgYW55IGFyZSBzZXQKICBpZiAoZW5hYmxlZERhdGFzZXRzLnNpemUgPiAwKSB7CiAgICByZXR1cm4gZGF0YXNldHMuZmlsdGVyKGlkID0+IGVuYWJsZWREYXRhc2V0cy5oYXMoaWQpKTsKICB9CiAgCiAgcmV0dXJuIGRhdGFzZXRzOwp9CgpmdW5jdGlvbiB0b2dnbGVXZWxsU2VsZWN0b3IoKSB7CiAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIndlbGwtc2VsZWN0b3ItZ3JpZC1jb250YWluZXIiKTsKICBjb25zdCBhcnJvdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ3ZWxsLXNlbGVjdG9yLWFycm93Iik7CiAgaWYgKGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID09PSAibm9uZSIpIHsKICAgIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgIGFycm93LnRleHRDb250ZW50ID0gIuKWsiI7CiAgICByZW5kZXJXZWxsU2VsZWN0b3JHcmlkKCk7CiAgfSBlbHNlIHsKICAgIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgYXJyb3cudGV4dENvbnRlbnQgPSAi4pa8IjsKICB9Cn0KCmZ1bmN0aW9uIHRvZ2dsZUJhc2VsaW5lT3B0aW9ucygpIHsKICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtb3B0aW9ucy1jb250ZW50Iik7CiAgY29uc3QgYXJyb3cgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtb3B0aW9ucy1hcnJvdyIpOwogIGlmIChjb250YWluZXIuc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiKSB7CiAgICBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICBhcnJvdy50ZXh0Q29udGVudCA9ICLilrIiOwogIH0gZWxzZSB7CiAgICBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIGFycm93LnRleHRDb250ZW50ID0gIuKWvCI7CiAgfQp9CgpmdW5jdGlvbiB1cGRhdGVCYXNlbGluZU1ldGhvZFBhcmFtcygpIHsKICBjb25zdCBtZXRob2QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtbWV0aG9kLXNlbGVjdCIpLnZhbHVlOwogIGNvbnN0IGxvd2Vzc1BhcmFtcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJiYXNlbGluZS1sb3dlc3MtcGFyYW1zIik7CiAgY29uc3QgcG9seW5vbWlhbFBhcmFtcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJiYXNlbGluZS1wb2x5bm9taWFsLXBhcmFtcyIpOwogIAogIGlmIChtZXRob2QgPT09ICJsb3dlc3MiKSB7CiAgICBsb3dlc3NQYXJhbXMuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICBwb2x5bm9taWFsUGFyYW1zLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgfSBlbHNlIGlmIChtZXRob2QgPT09ICJwb2x5bm9taWFsIikgewogICAgbG93ZXNzUGFyYW1zLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICBwb2x5bm9taWFsUGFyYW1zLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogIH0gZWxzZSB7CiAgICAvLyBjb25zdGFudAogICAgbG93ZXNzUGFyYW1zLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICBwb2x5bm9taWFsUGFyYW1zLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgfQogIAogIHVwZGF0ZUN1cnJlbnRTZXR0aW5nc0Rpc3BsYXkoKTsKfQoKZnVuY3Rpb24gdXBkYXRlUmVncmVzc2lvblR5cGVQYXJhbXMoc2tpcENoYXJ0VXBkYXRlKSB7CiAgY29uc3QgcmVncmVzc2lvblR5cGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi10eXBlLXNlbGVjdCIpLnZhbHVlOwogIGNvbnN0IHBvbHlub21pYWxPcmRlckRpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZWdyZXNzaW9uLXBvbHlub21pYWwtb3JkZXIiKTsKICBjb25zdCBpbmZvUGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi1pbmZvLXBhbmVsIik7CiAgY29uc3QgZml0UmVncmVzc2lvblRvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJmaXQtcmVncmVzc2lvbi10b2dnbGUiKTsKICAKICBpZiAocmVncmVzc2lvblR5cGUgPT09ICJwb2x5bm9taWFsIiAmJiBwb2x5bm9taWFsT3JkZXJEaXYpIHsKICAgIHBvbHlub21pYWxPcmRlckRpdi5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICB9IGVsc2UgaWYgKHBvbHlub21pYWxPcmRlckRpdikgewogICAgcG9seW5vbWlhbE9yZGVyRGl2LnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgfQogIAogIC8vIFNob3cvaGlkZSBpbmZvIHBhbmVsIGZvciBtb25vLWV4cG9uZW50aWFsIChvbmx5IGlmIHJlZ3Jlc3Npb24gdG9nZ2xlIGlzIGNoZWNrZWQpCiAgaWYgKGluZm9QYW5lbCkgewogICAgY29uc3QgaXNSZWdyZXNzaW9uRW5hYmxlZCA9IGZpdFJlZ3Jlc3Npb25Ub2dnbGUgJiYgZml0UmVncmVzc2lvblRvZ2dsZS5jaGVja2VkOwogICAgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAibW9uby1leHBvbmVudGlhbCIgJiYgaXNSZWdyZXNzaW9uRW5hYmxlZCkgewogICAgICBpbmZvUGFuZWwuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICB9IGVsc2UgewogICAgICBpbmZvUGFuZWwuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIH0KICB9CiAgCiAgdXBkYXRlQ3VycmVudFNldHRpbmdzRGlzcGxheSgpOwogIAogIC8vIFVwZGF0ZSBjaGFydCB3aGVuIHJlZ3Jlc3Npb24gdHlwZSBjaGFuZ2VzICh1bmxlc3Mgc2tpcHBlZCBmb3IgaW5pdGlhbGl6YXRpb24pCiAgaWYgKCFza2lwQ2hhcnRVcGRhdGUpIHsKICAgIHVwZGF0ZUNoYXJ0KCk7CiAgfQp9CgpmdW5jdGlvbiB1cGRhdGVDdXJyZW50U2V0dGluZ3NEaXNwbGF5KCkgewogIGNvbnN0IGJhc2VsaW5lTWV0aG9kU2VsZWN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJhc2VsaW5lLW1ldGhvZC1zZWxlY3QiKTsKICBjb25zdCBub3JtYWxpemF0aW9uTW9kZVNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJub3JtYWxpemF0aW9uLW1vZGUtc2VsZWN0Iik7CiAgY29uc3QgcmVncmVzc2lvblR5cGVTZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi10eXBlLXNlbGVjdCIpOwogIAogIGNvbnN0IGJhc2VsaW5lTWV0aG9kRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3VycmVudC1iYXNlbGluZS1tZXRob2QiKTsKICBjb25zdCBub3JtYWxpemF0aW9uTW9kZUVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImN1cnJlbnQtbm9ybWFsaXphdGlvbi1tb2RlIik7CiAgY29uc3QgcmVncmVzc2lvblR5cGVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXJyZW50LXJlZ3Jlc3Npb24tdHlwZSIpOwogIAogIGlmIChiYXNlbGluZU1ldGhvZEVsICYmIGJhc2VsaW5lTWV0aG9kU2VsZWN0KSB7CiAgICBjb25zdCBtZXRob2QgPSBiYXNlbGluZU1ldGhvZFNlbGVjdC52YWx1ZTsKICAgIGJhc2VsaW5lTWV0aG9kRWwudGV4dENvbnRlbnQgPSBtZXRob2QuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBtZXRob2Quc2xpY2UoMSk7CiAgfQogIAogIGlmIChub3JtYWxpemF0aW9uTW9kZUVsICYmIG5vcm1hbGl6YXRpb25Nb2RlU2VsZWN0KSB7CiAgICBjb25zdCBtb2RlID0gbm9ybWFsaXphdGlvbk1vZGVTZWxlY3QudmFsdWU7CiAgICBub3JtYWxpemF0aW9uTW9kZUVsLnRleHRDb250ZW50ID0gbW9kZSA9PT0gImRlbHRhX2Zfb3Zlcl9mIiA/ICLOlEYvRiIgOiAiTXVsdGlwbGljYXRpdmUiOwogIH0KICAKICBpZiAocmVncmVzc2lvblR5cGVFbCAmJiByZWdyZXNzaW9uVHlwZVNlbGVjdCkgewogICAgY29uc3QgdHlwZSA9IHJlZ3Jlc3Npb25UeXBlU2VsZWN0LnZhbHVlOwogICAgY29uc3QgdHlwZUxhYmVscyA9IHsKICAgICAgImxpbmVhciI6ICJMaW5lYXIiLAogICAgICAicG9seW5vbWlhbCI6ICJQb2x5bm9taWFsIiwKICAgICAgImV4cG9uZW50aWFsIjogIkV4cG9uZW50aWFsIiwKICAgICAgImxvZ2FyaXRobWljIjogIkxvZ2FyaXRobWljIiwKICAgICAgIm1vbm8tZXhwb25lbnRpYWwiOiAiTW9uby1leHBvbmVudGlhbCBwbGF0ZWF1IgogICAgfTsKICAgIHJlZ3Jlc3Npb25UeXBlRWwudGV4dENvbnRlbnQgPSB0eXBlTGFiZWxzW3R5cGVdIHx8IHR5cGU7CiAgfQp9CgpmdW5jdGlvbiBwYXJzZUxhYmVsRm9yTGVnZW5kKGxhYmVsKSB7CiAgLy8gUGFyc2UgbGFiZWwgZm9ybWF0OiAiRTE3LCBGMTcsIEcxNywgRTE0LCBHMTQgLSA1MDAtMTAtMiAoUExDZV9XVF9DYSkgQ29sIDE3ICg1LXBsaWNhdGUsIDIgZGF0YXNldHMsIG1lYW4gwrEgU0UpIgogIC8vIEV4dHJhY3QgbWFpbiBoZWFkaW5nIChlLmcuLCAiNTAwLTEwLTIiKSBhbmQgcmV0dXJuIHJlc3QgYXMgZGV0YWlscwogIAogIGlmICghbGFiZWwpIHJldHVybiB7IG1haW5IZWFkaW5nOiBsYWJlbCwgZGV0YWlsczogIiIgfTsKICAKICAvLyBQYXR0ZXJuIHRvIG1hdGNoOiBudW1iZXItbnVtYmVyLW51bWJlciAodGhlIG1haW4gaGVhZGluZyBsaWtlICI1MDAtMTAtMiIpCiAgY29uc3QgbWFpbkhlYWRpbmdNYXRjaCA9IGxhYmVsLm1hdGNoKC9cYihcZCstXGQrLVxkKylcYi8pOwogIAogIGlmIChtYWluSGVhZGluZ01hdGNoKSB7CiAgICBjb25zdCBtYWluSGVhZGluZyA9IG1haW5IZWFkaW5nTWF0Y2hbMV07CiAgICBjb25zdCBtYXRjaEluZGV4ID0gbWFpbkhlYWRpbmdNYXRjaC5pbmRleDsKICAgIAogICAgLy8gR2V0IHBhcnRzIGJlZm9yZSBhbmQgYWZ0ZXIgdGhlIG1haW4gaGVhZGluZwogICAgY29uc3QgYmVmb3JlID0gbGFiZWwuc3Vic3RyaW5nKDAsIG1hdGNoSW5kZXgpLnRyaW0oKTsKICAgIGNvbnN0IGFmdGVyID0gbGFiZWwuc3Vic3RyaW5nKG1hdGNoSW5kZXggKyBtYWluSGVhZGluZy5sZW5ndGgpLnRyaW0oKTsKICAgIAogICAgLy8gQ29tYmluZSBiZWZvcmUgYW5kIGFmdGVyCiAgICBsZXQgZGV0YWlscyA9IChiZWZvcmUgKyAiICIgKyBhZnRlcikudHJpbSgpOwogICAgLy8gQ2xlYW4gdXAgZXh0cmEgc3BhY2VzIGFuZCBkYXNoZXMKICAgIGRldGFpbHMgPSBkZXRhaWxzLnJlcGxhY2UoL1xzKi1ccyovZywgIiAtICIpLnJlcGxhY2UoL1xzKy9nLCAiICIpLnRyaW0oKTsKICAgIC8vIFJlbW92ZSBsZWFkaW5nL3RyYWlsaW5nIGRhc2hlcyBhbmQgY2xlYW4gdXAKICAgIGRldGFpbHMgPSBkZXRhaWxzLnJlcGxhY2UoL14tXHMqLywgIiIpLnJlcGxhY2UoL1xzKi0kLywgIiIpLnRyaW0oKTsKICAgIAogICAgcmV0dXJuIHsgbWFpbkhlYWRpbmc6IG1haW5IZWFkaW5nLCBkZXRhaWxzOiBkZXRhaWxzIH07CiAgfQogIAogIC8vIElmIG5vIHBhdHRlcm4gbWF0Y2gsIHJldHVybiBvcmlnaW5hbCBhcyBtYWluIGhlYWRpbmcKICByZXR1cm4geyBtYWluSGVhZGluZzogbGFiZWwsIGRldGFpbHM6ICIiIH07Cn0KCmZ1bmN0aW9uIHVwZGF0ZU1vbm9FeHBvbmVudGlhbEluZm9QYW5lbChtb25vRXhwUGFyYW1zKSB7CiAgY29uc3QgaW5mb1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlZ3Jlc3Npb24taW5mby1wYW5lbCIpOwogIGNvbnN0IGluZm9Db250ZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlZ3Jlc3Npb24taW5mby1jb250ZW50Iik7CiAgCiAgaWYgKCFpbmZvUGFuZWwgfHwgIWluZm9Db250ZW50KSB7CiAgICByZXR1cm47CiAgfQogIAogIGlmIChtb25vRXhwUGFyYW1zLmxlbmd0aCA9PT0gMCkgewogICAgaW5mb0NvbnRlbnQuaW5uZXJIVE1MID0gIjxkaXYgc3R5bGU9J2NvbG9yOiAjNjY2Oyc+Tm8gZml0cyBhdmFpbGFibGUuIFNlbGVjdCB3ZWxscyBhbmQgZW5hYmxlIHJlZ3Jlc3Npb24uPC9kaXY+IjsKICAgIHJldHVybjsKICB9CiAgCiAgLy8gQnVpbGQgSFRNTCBmb3IgcGFyYW1ldGVycwogIGxldCBodG1sID0gIiI7CiAgCiAgLy8gTW9kZWwgZXF1YXRpb24KICBodG1sICs9ICI8ZGl2IHN0eWxlPSdtYXJnaW4tYm90dG9tOiA4cHg7IHBhZGRpbmc6IDRweDsgYmFja2dyb3VuZDogd2hpdGU7IGJvcmRlci1yYWRpdXM6IDJweDsnPiI7CiAgaHRtbCArPSAiPHN0cm9uZz5Nb2RlbDo8L3N0cm9uZz4geSh0KSA9IDEgKyBBKDEgLSBlPHN1cD4tayh0LXTigoApPC9zdXA+KSI7CiAgaHRtbCArPSAiPC9kaXY+IjsKICAKICAvLyBQYXJhbWV0ZXJzIGZvciBlYWNoIGZpdAogIG1vbm9FeHBQYXJhbXMuZm9yRWFjaCgoZml0LCBpZHgpID0+IHsKICAgIGNvbnN0IHAgPSBmaXQucGFyYW1zOwogICAgY29uc3QgYm9yZGVyQ29sb3IgPSBmaXQuY29sb3IgfHwgJyMyYTZjZmYnOyAvLyBVc2UgZGF0YXNldCBjb2xvciBvciBkZWZhdWx0IGJsdWUKICAgIAogICAgLy8gUGFyc2UgbGFiZWwgdG8gZXh0cmFjdCBtYWluIGhlYWRpbmcgYW5kIGRldGFpbHMKICAgIGNvbnN0IHBhcnNlZCA9IHBhcnNlTGFiZWxGb3JMZWdlbmQoZml0LmxhYmVsKTsKICAgIAogICAgaHRtbCArPSBgPGRpdiBzdHlsZT0nbWFyZ2luLWJvdHRvbTogMTJweDsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiB3aGl0ZTsgYm9yZGVyLXJhZGl1czogMnB4OyBib3JkZXItbGVmdDogM3B4IHNvbGlkICR7Ym9yZGVyQ29sb3J9Oyc+YDsKICAgIAogICAgLy8gTWFpbiBoZWFkaW5nIGluIGNhcmQgY29sb3IKICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9J2NvbG9yOiAke2JvcmRlckNvbG9yfTsgZm9udC13ZWlnaHQ6IDYwMDsgZm9udC1zaXplOiAwLjlyZW07IG1hcmdpbi1ib3R0b206IDRweDsnPiR7cGFyc2VkLm1haW5IZWFkaW5nfTwvZGl2PmA7CiAgICAKICAgIC8vIERldGFpbHMgaW4gZ3JheSBiZWxvdwogICAgaWYgKHBhcnNlZC5kZXRhaWxzKSB7CiAgICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9J2NvbG9yOiAjNjY2OyBmb250LXNpemU6IDAuN3JlbTsgbWFyZ2luLWJvdHRvbTogOHB4OyBsaW5lLWhlaWdodDogMS4zOyc+JHtwYXJzZWQuZGV0YWlsc308L2Rpdj5gOwogICAgfQogICAgCiAgICAvLyBQYXJhbWV0ZXJzIGdyaWQKICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9J2Rpc3BsYXk6IGdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyIDFmcjsgZ2FwOiA0cHg7IGZvbnQtc2l6ZTogMC43cmVtOyBtYXJnaW4tdG9wOiA4cHg7Jz5gOwogICAgCiAgICAvLyBMZWZ0IGNvbHVtbgogICAgaHRtbCArPSBgPGRpdj48c3Ryb25nPkEgKGFtcGxpdHVkZSk6PC9zdHJvbmc+ICR7cC5BLnRvRml4ZWQoNCl9PC9kaXY+YDsKICAgIGh0bWwgKz0gYDxkaXY+PHN0cm9uZz5rIChyYXRlIGNvbnN0YW50KTo8L3N0cm9uZz4gJHtwLmsudG9GaXhlZCg2KX0gc+KBu8K5PC9kaXY+YDsKICAgIGh0bWwgKz0gYDxkaXY+PHN0cm9uZz7PhCAodGltZSBjb25zdGFudCk6PC9zdHJvbmc+ICR7cC50YXUudG9GaXhlZCgyKX0gczwvZGl2PmA7CiAgICAKICAgIC8vIFJpZ2h0IGNvbHVtbgogICAgaHRtbCArPSBgPGRpdj48c3Ryb25nPnTigoAgKHN0YXJ0IHRpbWUpOjwvc3Ryb25nPiAke3AudDAudG9GaXhlZCgyKX0gczwvZGl2PmA7CiAgICBodG1sICs9IGA8ZGl2PjxzdHJvbmc+dOKCgS/igoIgKGhhbGYtdGltZSk6PC9zdHJvbmc+ICR7cC50SGFsZi50b0ZpeGVkKDIpfSBzPC9kaXY+YDsKICAgIGh0bWwgKz0gYDxkaXY+PHN0cm9uZz5QbGF0ZWF1Ojwvc3Ryb25nPiAke3AucGxhdGVhdS50b0ZpeGVkKDQpfTwvZGl2PmA7CiAgICAKICAgIGh0bWwgKz0gYDwvZGl2PjwvZGl2PmA7CiAgfSk7CiAgCiAgaW5mb0NvbnRlbnQuaW5uZXJIVE1MID0gaHRtbDsKfQoKZnVuY3Rpb24gcmVuZGVyV2VsbFNlbGVjdG9yR3JpZCgpIHsKICBjb25zdCBncmlkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIndlbGwtc2VsZWN0b3ItZ3JpZCIpOwogIGlmICghZ3JpZCB8fCAhc2VsZWN0ZWREYXRhc2V0SWQpIHsKICAgIHJldHVybjsKICB9CiAgCiAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICBpZiAoc2VsZWN0ZWREYXRhc2V0cy5sZW5ndGggPT09IDApIHsKICAgIGdyaWQuaW5uZXJIVE1MID0gIjxkaXYgc3R5bGU9J2NvbG9yOiAjNjY2OyBmb250LXNpemU6IDAuOHJlbTsgcGFkZGluZzogOHB4Oyc+Tm8gZGF0YXNldHMgc2VsZWN0ZWQuPC9kaXY+IjsKICAgIHJldHVybjsKICB9CiAgCiAgZ3JpZC5pbm5lckhUTUwgPSAiIjsKICAKICAvLyBDb2xsZWN0IGFsbCB1bmlxdWUgd2VsbCBJRHMgZnJvbSBzZWxlY3RlZCBkYXRhc2V0cwogIGNvbnN0IGFsbFdlbGxzU2V0ID0gbmV3IFNldCgpOwogIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgT2JqZWN0LmtleXMod2VsbHMpLmZvckVhY2god2VsbElkID0+IHsKICAgICAgYWxsV2VsbHNTZXQuYWRkKHdlbGxJZCk7CiAgICB9KTsKICB9KTsKICAKICAvLyBUb3AtbGVmdCBjb3JuZXIKICBjb25zdCBjb3JuZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICBjb3JuZXIuY2xhc3NOYW1lID0gIndlbGwtc2VsZWN0b3ItaGVhZGVyIjsKICBncmlkLmFwcGVuZENoaWxkKGNvcm5lcik7CiAgCiAgLy8gQ29sdW1uIGhlYWRlcnMKICBmb3IgKGxldCBjID0gMTsgYyA8PSBQTEFURV9DT0xTOyBjKyspIHsKICAgIGNvbnN0IGhlYWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgaGVhZGVyLmNsYXNzTmFtZSA9ICJ3ZWxsLXNlbGVjdG9yLWhlYWRlciI7CiAgICBoZWFkZXIudGV4dENvbnRlbnQgPSBjOwogICAgZ3JpZC5hcHBlbmRDaGlsZChoZWFkZXIpOwogIH0KICAKICAvLyBSb3dzCiAgUExBVEVfUk9XUy5mb3JFYWNoKHJvd0xldHRlciA9PiB7CiAgICAvLyBSb3cgbGFiZWwKICAgIGNvbnN0IHJvd0xhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICByb3dMYWJlbC5jbGFzc05hbWUgPSAid2VsbC1zZWxlY3Rvci1oZWFkZXIiOwogICAgcm93TGFiZWwudGV4dENvbnRlbnQgPSByb3dMZXR0ZXI7CiAgICBncmlkLmFwcGVuZENoaWxkKHJvd0xhYmVsKTsKICAgIAogICAgLy8gV2VsbHMKICAgIGZvciAobGV0IGNvbCA9IDE7IGNvbCA8PSBQTEFURV9DT0xTOyBjb2wrKykgewogICAgICBjb25zdCB3ZWxsSWQgPSByb3dMZXR0ZXIgKyBTdHJpbmcoY29sKTsKICAgICAgY29uc3QgY2VsbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBjZWxsLmNsYXNzTmFtZSA9ICJ3ZWxsLXNlbGVjdG9yLWNlbGwiOwogICAgICAKICAgICAgY29uc3QgaGFzRGF0YSA9IGFsbFdlbGxzU2V0Lmhhcyh3ZWxsSWQpOwogICAgICBjb25zdCBpc0V4Y2x1ZGVkID0gZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCk7CiAgICAgIAogICAgICBpZiAoaGFzRGF0YSkgewogICAgICAgIGNlbGwuY2xhc3NMaXN0LmFkZCgiaGFzLWRhdGEiKTsKICAgICAgICBpZiAoaXNFeGNsdWRlZCkgewogICAgICAgICAgLy8gVXNlIGlubGluZSBzdHlsZXMgd2l0aCByZ2IgdG8gYXZvaWQgaGV4IGVzY2FwaW5nIGlzc3VlcwogICAgICAgICAgY2VsbC5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYigyNTUsIDIwNCwgMjA0KSI7CiAgICAgICAgICBjZWxsLnN0eWxlLmJvcmRlckNvbG9yID0gInJnYigyNTUsIDEwNywgMTA3KSI7CiAgICAgICAgICBjZWxsLnN0eWxlLmNvbG9yID0gInJnYigyMDQsIDAsIDApIjsKICAgICAgICAgIGNlbGwuc3R5bGUuZm9udFdlaWdodCA9ICJib2xkIjsKICAgICAgICAgIGNlbGwudGV4dENvbnRlbnQgPSAi4pyVIjsKICAgICAgICAgIGNlbGwudGl0bGUgPSBgV2VsbCAke3dlbGxJZH0gLSBFWENMVURFRCAoY2xpY2sgdG8gaW5jbHVkZSlgOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjZWxsLnRleHRDb250ZW50ID0gY29sOwogICAgICAgICAgY2VsbC50aXRsZSA9IGBXZWxsICR7d2VsbElkfSAtIENsaWNrIHRvIGV4Y2x1ZGVgOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBjZWxsLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgKCkgPT4gewogICAgICAgICAgdG9nZ2xlV2VsbEV4Y2x1c2lvbih3ZWxsSWQpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGNlbGwuc3R5bGUuYmFja2dyb3VuZCA9ICIjZjJmMmYyIjsKICAgICAgICBjZWxsLnN0eWxlLmN1cnNvciA9ICJkZWZhdWx0IjsKICAgICAgICBjZWxsLnN0eWxlLm9wYWNpdHkgPSAiMC41IjsKICAgICAgfQogICAgICAKICAgICAgZ3JpZC5hcHBlbmRDaGlsZChjZWxsKTsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gdG9nZ2xlV2VsbEV4Y2x1c2lvbih3ZWxsSWQpIHsKICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPT09IDApIHsKICAgIC8vIElmIG5vIGV4Y2x1c2lvbnMgeWV0LCBmaXJzdCBjb2xsZWN0IGFsbCBhdmFpbGFibGUgd2VsbHMKICAgIGNvbnN0IHNlbGVjdGVkRGF0YXNldHMgPSBnZXRTZWxlY3RlZERhdGFzZXRzKCk7CiAgICBjb25zdCBhbGxXZWxsc1NldCA9IG5ldyBTZXQoKTsKICAgIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICAgIE9iamVjdC5rZXlzKHdlbGxzKS5mb3JFYWNoKHdJZCA9PiB7CiAgICAgICAgYWxsV2VsbHNTZXQuYWRkKHdJZCk7CiAgICAgIH0pOwogICAgfSk7CiAgICAvLyBFbmFibGUgYWxsIGV4Y2VwdCB0aGUgb25lIGJlaW5nIGNsaWNrZWQKICAgIGFsbFdlbGxzU2V0LmZvckVhY2god0lkID0+IHsKICAgICAgaWYgKHdJZCAhPT0gd2VsbElkKSB7CiAgICAgICAgZW5hYmxlZFdlbGxzLmFkZCh3SWQpOwogICAgICB9CiAgICB9KTsKICB9IGVsc2UgewogICAgLy8gVG9nZ2xlIHRoaXMgc3BlY2lmaWMgd2VsbAogICAgaWYgKGVuYWJsZWRXZWxscy5oYXMod2VsbElkKSkgewogICAgICBlbmFibGVkV2VsbHMuZGVsZXRlKHdlbGxJZCk7CiAgICB9IGVsc2UgewogICAgICBlbmFibGVkV2VsbHMuYWRkKHdlbGxJZCk7CiAgICB9CiAgICAKICAgIC8vIElmIGFsbCB3ZWxscyBhcmUgZW5hYmxlZCwgY2xlYXIgdGhlIHNldCAobWVhbmluZyBhbGwgYXJlIGVuYWJsZWQpCiAgICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogICAgY29uc3QgYWxsV2VsbHNTZXQgPSBuZXcgU2V0KCk7CiAgICBzZWxlY3RlZERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICBPYmplY3Qua2V5cyh3ZWxscykuZm9yRWFjaCh3SWQgPT4gewogICAgICAgIGFsbFdlbGxzU2V0LmFkZCh3SWQpOwogICAgICB9KTsKICAgIH0pOwogICAgCiAgICAvLyBDaGVjayBpZiBhbGwgd2VsbHMgYXJlIGVuYWJsZWQKICAgIGxldCBhbGxFbmFibGVkID0gdHJ1ZTsKICAgIGFsbFdlbGxzU2V0LmZvckVhY2god0lkID0+IHsKICAgICAgaWYgKCFlbmFibGVkV2VsbHMuaGFzKHdJZCkpIHsKICAgICAgICBhbGxFbmFibGVkID0gZmFsc2U7CiAgICAgIH0KICAgIH0pOwogICAgCiAgICBpZiAoYWxsRW5hYmxlZCkgewogICAgICBlbmFibGVkV2VsbHMuY2xlYXIoKTsgLy8gQ2xlYXIgbWVhbnMgYWxsIGVuYWJsZWQKICAgIH0KICB9CiAgCiAgcmVuZGVyV2VsbFNlbGVjdG9yR3JpZCgpOwogIHJlbmRlclBsYXRlR3JpZCgpOwogIHVwZGF0ZVdlbGxJbmZvKCk7Cn0KCmZ1bmN0aW9uIGdldEFsbERhdGFzZXRzSW5Hcm91cCgpIHsKICAvLyBHZXQgYWxsIGRhdGFzZXRzIGluIHRoZSBzZWxlY3RlZCBncm91cCAoYmVmb3JlIGZpbHRlcmluZyBieSBlbmFibGVkRGF0YXNldHMpCiAgaWYgKCFzZWxlY3RlZERhdGFzZXRJZCkgewogICAgcmV0dXJuIFtdOwogIH0KICAKICBpZiAoc2VsZWN0ZWREYXRhc2V0SWQuc3RhcnRzV2l0aCgiZ3JvdXA6IikpIHsKICAgIGNvbnN0IGdyb3VwTmFtZSA9IHNlbGVjdGVkRGF0YXNldElkLnN1YnN0cmluZyg2KTsKICAgIGNvbnN0IHNlbGVjdGVkUGxhdGVzID0gdmlld2VyRGF0YS5wbGF0ZXMuZmlsdGVyKHAgPT4gcC5jb2x1bW5fZ3JvdXAgPT09IGdyb3VwTmFtZSk7CiAgICByZXR1cm4gc2VsZWN0ZWRQbGF0ZXMubWFwKHAgPT4gcC5pZCk7CiAgfSBlbHNlIHsKICAgIGNvbnN0IHBsYXRlID0gdmlld2VyRGF0YS5wbGF0ZXMuZmluZChwID0+IHAuaWQgPT09IHNlbGVjdGVkRGF0YXNldElkKTsKICAgIHJldHVybiBwbGF0ZSA/IFtzZWxlY3RlZERhdGFzZXRJZF0gOiBbXTsKICB9Cn0KCmZ1bmN0aW9uIGluaXRpYWxpemVUcmlwbGljYXRlR3JvdXBDb2xvcnMoKSB7CiAgLy8gSW5pdGlhbGl6ZSBjb2xvciBtYXAgaWYgbmVlZGVkIChkb24ndCByZXNldCAtIGtlZXAgY29uc2lzdGVudCBjb2xvcnMpCiAgLy8gVGhpcyBlbnN1cmVzIGFsbCB3ZWxscyB3aXRoIHRoZSBzYW1lIHRyaXBsaWNhdGUgZ3JvdXAgbmFtZSBnZXQgdGhlIHNhbWUgY29sb3IKICAvLyBGb3IgZXhhbXBsZSwgYWxsIHdlbGxzIGluIHJvd3MgQiwgQywgRCB3aXRoIGdyb3VwIG5hbWUgIjI1MC0xMC0yIiBnZXQgdGhlIHNhbWUgY29sb3IKICBpZiAoT2JqZWN0LmtleXModHJpcGxpY2F0ZUdyb3VwQ29sb3JNYXApLmxlbmd0aCA9PT0gMCAmJiB2aWV3ZXJEYXRhICYmIHZpZXdlckRhdGEuY29uZmlnKSB7CiAgICBjb25zdCB0cmlwbGljYXRlR3JvdXBzID0gdmlld2VyRGF0YS5jb25maWcudHJpcGxpY2F0ZV9ncm91cHMgfHwgW107CiAgICBsZXQgY29sb3JJbmRleCA9IDA7CiAgICB0cmlwbGljYXRlR3JvdXBzLmZvckVhY2goZ3JvdXAgPT4gewogICAgICBjb25zdCBuYW1lID0gU3RyaW5nKGdyb3VwLm5hbWUgfHwgIiIpLnRyaW0oKTsKICAgICAgaWYgKG5hbWUgJiYgIXRyaXBsaWNhdGVHcm91cENvbG9yTWFwW25hbWVdKSB7CiAgICAgICAgdHJpcGxpY2F0ZUdyb3VwQ29sb3JNYXBbbmFtZV0gPSBUUklQTElDQVRFX0NPTE9SU1tjb2xvckluZGV4ICUlIFRSSVBMSUNBVEVfQ09MT1JTLmxlbmd0aF07CiAgICAgICAgY29sb3JJbmRleCsrOwogICAgICB9CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIHJlbmRlclBsYXRlR3JpZCgpIHsKICBjb25zdCBncmlkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInBsYXRlLWdyaWQiKTsKICBncmlkLmlubmVySFRNTCA9ICIiOwogIAogIC8vIEluaXRpYWxpemUgY29sb3IgbWFwIGlmIG5lZWRlZCAoZG9uJ3QgcmVzZXQgLSBrZWVwIGNvbnNpc3RlbnQgY29sb3JzKQogIC8vIFRoaXMgZW5zdXJlcyBhbGwgd2VsbHMgd2l0aCB0aGUgc2FtZSB0cmlwbGljYXRlIGdyb3VwIG5hbWUgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgaWYgKE9iamVjdC5rZXlzKHRyaXBsaWNhdGVHcm91cENvbG9yTWFwKS5sZW5ndGggPT09IDApIHsKICAgIGluaXRpYWxpemVUcmlwbGljYXRlR3JvdXBDb2xvcnMoKTsKICB9CgogIGNvbnN0IHNlbGVjdGVkRGF0YXNldHMgPSBnZXRTZWxlY3RlZERhdGFzZXRzKCk7CiAgY29uc3QgYWxsR3JvdXBEYXRhc2V0cyA9IGdldEFsbERhdGFzZXRzSW5Hcm91cCgpOwogIAogIC8vIEJ1aWxkIGNvbHVtbiBpbmZvIG1hcDogY29sdW1uIC0+IHsgZ2Vub3R5cGUsIGJ1ZmZlciwgc2NpZW50aXN0IH0KICAvLyBVc2UgYWxsIGRhdGFzZXRzIGluIGdyb3VwIHRvIHNob3cgYWxsIGF2YWlsYWJsZSBjb2x1bW4gZ3JvdXBzCiAgY29uc3QgY29sdW1uSW5mb01hcCA9IHt9OyAvLyBjb2x1bW4gLT4geyBnZW5vdHlwZSwgYnVmZmVyLCBzY2llbnRpc3QgfQogIAogIGFsbEdyb3VwRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgIGNvbnN0IHBsYXRlID0gdmlld2VyRGF0YS5wbGF0ZXMuZmluZChwID0+IHAuaWQgPT09IHBsYXRlSWQpOwogICAgaWYgKCFwbGF0ZSB8fCAhcGxhdGUuY29sdW1uX2luZm8pIHJldHVybjsKICAgIAogICAgY29uc3QgY29sdW1uSW5mbyA9IHBsYXRlLmNvbHVtbl9pbmZvOwogICAgLy8gRmluZCB3aGljaCBjb2x1bW5zIGhhdmUgZGF0YSBmb3IgdGhpcyBwbGF0ZQogICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICBPYmplY3Qua2V5cyh3ZWxscykuZm9yRWFjaCh3ZWxsSWQgPT4gewogICAgICBjb25zdCBjb2wgPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAgIGlmICghY29sdW1uSW5mb01hcFtjb2xdKSB7CiAgICAgICAgY29sdW1uSW5mb01hcFtjb2xdID0gewogICAgICAgICAgZ2Vub3R5cGU6IGNvbHVtbkluZm8uZ2Vub3R5cGUgfHwgIiIsCiAgICAgICAgICBidWZmZXI6IGNvbHVtbkluZm8uYnVmZmVyIHx8ICIiLAogICAgICAgICAgc2NpZW50aXN0OiBjb2x1bW5JbmZvLnNjaWVudGlzdCB8fCAiIgogICAgICAgIH07CiAgICAgIH0KICAgIH0pOwogIH0pOwoKICAvLyBUb3AtbGVmdCBibGFuawogIGNvbnN0IGNvcm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogIGNvcm5lci5jbGFzc05hbWUgPSAiZ3JpZC1oZWFkZXIiOwogIGdyaWQuYXBwZW5kQ2hpbGQoY29ybmVyKTsKCiAgLy8gQ29sdW1uIG51bWJlciBsYWJlbHMKICBmb3IgKGxldCBjID0gMTsgYyA8PSBQTEFURV9DT0xTOyBjKyspIHsKICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgZGl2LmNsYXNzTmFtZSA9ICJncmlkLWhlYWRlciBjb2wtbGFiZWwiOwogICAgZGl2LnRleHRDb250ZW50ID0gYzsKICAgIGdyaWQuYXBwZW5kQ2hpbGQoZGl2KTsKICB9CgogIGNvbnN0IHdlbGxDb3VudHMgPSB7fTsgLy8gVHJhY2sgaG93IG1hbnkgZGF0YXNldHMgaGF2ZSBkYXRhIGZvciBlYWNoIHdlbGwKCiAgLy8gQ291bnQgZGF0YXNldHMgcGVyIHdlbGwsIGZpbHRlcmluZyBieSBlbmFibGVkIHdlbGxzCiAgLy8gTm9ybWFsaXplIHdlbGwgSURzIHRvIGVuc3VyZSBjb25zaXN0ZW50IG1hdGNoaW5nCiAgc2VsZWN0ZWREYXRhc2V0cy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICBPYmplY3Qua2V5cyh3ZWxscykuZm9yRWFjaCh3ZWxsSWQgPT4gewogICAgICAvLyBOb3JtYWxpemUgd2VsbCBJRCAocmVtb3ZlIHNwYWNlcywgZW5zdXJlIGNvbnNpc3RlbnQgZm9ybWF0KQogICAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gU3RyaW5nKHdlbGxJZCkudHJpbSgpLnRvVXBwZXJDYXNlKCk7CiAgICAgIAogICAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZFdlbGxzIGlmIGFueSBhcmUgc2V0IChjaGVjayBib3RoIG9yaWdpbmFsIGFuZCBub3JtYWxpemVkKQogICAgICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCkgJiYgIWVuYWJsZWRXZWxscy5oYXMobm9ybWFsaXplZFdlbGxJZCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgCiAgICAgIC8vIEZpbHRlciBieSBlbmFibGVkQ29sdW1ucyBpZiBhbnkgYXJlIHNldAogICAgICBjb25zdCBjb2x1bW4gPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAgIGlmIChlbmFibGVkQ29sdW1ucy5zaXplID4gMCAmJiAhZW5hYmxlZENvbHVtbnMuaGFzKGNvbHVtbikpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgCiAgICAgIGlmICghd2VsbENvdW50c1tub3JtYWxpemVkV2VsbElkXSkgewogICAgICAgIHdlbGxDb3VudHNbbm9ybWFsaXplZFdlbGxJZF0gPSBuZXcgU2V0KCk7IC8vIFVzZSBTZXQgdG8gYXZvaWQgZHVwbGljYXRlcwogICAgICB9CiAgICAgIHdlbGxDb3VudHNbbm9ybWFsaXplZFdlbGxJZF0uYWRkKHBsYXRlSWQpOwogICAgfSk7CiAgfSk7CiAgCiAgLy8gQ29udmVydCBTZXRzIHRvIGFycmF5cyBmb3IgZWFzaWVyIHVzZQogIE9iamVjdC5rZXlzKHdlbGxDb3VudHMpLmZvckVhY2god2VsbElkID0+IHsKICAgIHdlbGxDb3VudHNbd2VsbElkXSA9IEFycmF5LmZyb20od2VsbENvdW50c1t3ZWxsSWRdKTsKICB9KTsKCiAgLy8gUm93cwogIFBMQVRFX1JPV1MuZm9yRWFjaChyb3dMZXR0ZXIgPT4gewogICAgLy8gUm93IGxhYmVsCiAgICBjb25zdCBsYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgbGFiZWwuY2xhc3NOYW1lID0gImdyaWQtaGVhZGVyIHJvdy1sYWJlbCI7CiAgICBsYWJlbC50ZXh0Q29udGVudCA9IHJvd0xldHRlcjsKICAgIGdyaWQuYXBwZW5kQ2hpbGQobGFiZWwpOwoKICAgIC8vIFdlbGxzCiAgICBmb3IgKGxldCBjb2wgPSAxOyBjb2wgPD0gUExBVEVfQ09MUzsgY29sKyspIHsKICAgICAgY29uc3Qgd2VsbElkID0gcm93TGV0dGVyICsgU3RyaW5nKGNvbCk7CiAgICAgIGNvbnN0IG5vcm1hbGl6ZWRXZWxsSWQgPSB3ZWxsSWQudG9VcHBlckNhc2UoKTsgLy8gTm9ybWFsaXplIGZvciBtYXRjaGluZwogICAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgZGl2LmNsYXNzTmFtZSA9ICJ3ZWxsIjsKICAgICAgY29uc3QgaGFzRGF0YSA9IHdlbGxDb3VudHMuaGFzT3duUHJvcGVydHkobm9ybWFsaXplZFdlbGxJZCk7CiAgICAgIGRpdi5kYXRhc2V0LndlbGxJZCA9IHdlbGxJZDsKICAgICAgZGl2LmRhdGFzZXQuaGFzRGF0YSA9IGhhc0RhdGEgPyAidHJ1ZSIgOiAiZmFsc2UiOwogICAgICAKICAgICAgaWYgKGhhc0RhdGEpIHsKICAgICAgICBjb25zdCBwbGF0ZXMgPSB3ZWxsQ291bnRzW25vcm1hbGl6ZWRXZWxsSWRdOwogICAgICAgIAogICAgICAgIC8vIENoZWNrIGlmIHRoaXMgd2VsbCBpcyBhIGNvbnRyb2wgd2VsbCAoY29uZmlndXJhYmxlIHZpYSBjb250cm9sX3Jvd3MpCiAgICAgICAgY29uc3QgaXNDb250cm9sID0gaXNDb250cm9sV2VsbCh3ZWxsSWQpOwogICAgICAgIAogICAgICAgIC8vIEdldCBsYWJlbCBmcm9tIHJvdy1iYXNlZCBjb25maWcgb3IgY29udGVudAogICAgICAgIC8vIFRyeSB0byBmaW5kIHRoZSBhY3R1YWwgd2VsbCBJRCBpbiB0aGUgZGF0YSAobWlnaHQgYmUgZGlmZmVyZW50IGNhc2UvZm9ybWF0KQogICAgICAgIGNvbnN0IGZpcnN0UGxhdGVJZCA9IHBsYXRlc1swXTsKICAgICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtmaXJzdFBsYXRlSWRdIHx8IHt9OwogICAgICAgIC8vIFRyeSBub3JtYWxpemVkIElEIGZpcnN0LCB0aGVuIG9yaWdpbmFsIElELCB0aGVuIHNlYXJjaCBmb3IgbWF0Y2hpbmcgd2VsbAogICAgICAgIGxldCBhY3R1YWxXZWxsSWQgPSBub3JtYWxpemVkV2VsbElkOwogICAgICAgIGlmICghd2VsbHNbYWN0dWFsV2VsbElkXSkgewogICAgICAgICAgYWN0dWFsV2VsbElkID0gd2VsbElkOwogICAgICAgICAgaWYgKCF3ZWxsc1thY3R1YWxXZWxsSWRdKSB7CiAgICAgICAgICAgIC8vIFNlYXJjaCBmb3IgbWF0Y2hpbmcgd2VsbCBJRCAoY2FzZS1pbnNlbnNpdGl2ZSkKICAgICAgICAgICAgY29uc3QgbWF0Y2hpbmdLZXkgPSBPYmplY3Qua2V5cyh3ZWxscykuZmluZChrZXkgPT4gCiAgICAgICAgICAgICAga2V5LnRvVXBwZXJDYXNlKCkgPT09IG5vcm1hbGl6ZWRXZWxsSWQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKG1hdGNoaW5nS2V5KSB7CiAgICAgICAgICAgICAgYWN0dWFsV2VsbElkID0gbWF0Y2hpbmdLZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3Qgd2VsbERhdGEgPSB3ZWxsc1thY3R1YWxXZWxsSWRdOwogICAgICAgIGlmICghd2VsbERhdGEpIHsKICAgICAgICAgIC8vIFdlbGwgZGF0YSBub3QgZm91bmQsIHNraXAgdGhpcyB3ZWxsCiAgICAgICAgICBkaXYuc3R5bGUuY3Vyc29yID0gImRlZmF1bHQiOwogICAgICAgICAgZGl2LnN0eWxlLmJhY2tncm91bmQgPSAiI2YyZjJmMiI7CiAgICAgICAgICBncmlkLmFwcGVuZENoaWxkKGRpdik7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgY29uc3QgY29uZmlnID0gdmlld2VyRGF0YS5jb25maWcgfHwge307CiAgICAgICAgY29uc3Qgd2VsbExhYmVscyA9IGNvbmZpZy53ZWxsX2xhYmVscyB8fCB7fTsKICAgICAgICAvLyBFeHRyYWN0IHJvdyBsZXR0ZXIgZnJvbSB3ZWxsSWQgKGUuZy4sICJCMTMiIC0+ICJCIikKICAgICAgICBjb25zdCByb3dMZXR0ZXIgPSBnZXRSb3dMZXR0ZXIod2VsbElkKTsKICAgICAgICAKICAgICAgICAvLyBDb3VudCB1bmlxdWUgZGF0YXNldHMgdGhhdCBhY3R1YWxseSBoYXZlIGRhdGEgZm9yIHRoaXMgd2VsbAogICAgICAgIGNvbnN0IHVuaXF1ZVBsYXRlcyA9IHBsYXRlcy5maWx0ZXIocGxhdGVJZCA9PiB7CiAgICAgICAgICBjb25zdCBwbGF0ZVdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBwbGF0ZSBoYXMgZGF0YSBmb3IgdGhpcyB3ZWxsICh0cnkgZGlmZmVyZW50IElEIGZvcm1hdHMpCiAgICAgICAgICByZXR1cm4gcGxhdGVXZWxsc1thY3R1YWxXZWxsSWRdIHx8IHBsYXRlV2VsbHNbd2VsbElkXSB8fCAKICAgICAgICAgICAgICAgICBPYmplY3Qua2V5cyhwbGF0ZVdlbGxzKS5zb21lKGtleSA9PiBrZXkudG9VcHBlckNhc2UoKSA9PT0gbm9ybWFsaXplZFdlbGxJZCk7CiAgICAgICAgfSk7CiAgICAgICAgY29uc3QgZGF0YXNldENvdW50ID0gdW5pcXVlUGxhdGVzLmxlbmd0aDsKICAgICAgICAKICAgICAgICAvLyBGb3IgY29udHJvbCB3ZWxsczogbWFpbiB0ZXh0IGlzICJDb250cm9sIiwgbGFiZWwgYmVsb3cgaXMgdGhlIGNvbnRyb2wgbGFiZWwKICAgICAgICAvLyBGb3Igbm9uLWNvbnRyb2wgd2VsbHM6IG1haW4gdGV4dCBpcyBwbGF0ZSBjb3VudCBvciB3ZWxsIElELCBsYWJlbCBiZWxvdyBpcyB0aGUgY29uZmlndXJlZCBsYWJlbAogICAgICAgIGxldCBtYWluVGV4dCwgbGFiZWw7CiAgICAgICAgaWYgKGlzQ29udHJvbCkgewogICAgICAgICAgbWFpblRleHQgPSAiQ29udHJvbCI7CiAgICAgICAgICAvLyBHZXQgdGhlIGNvbnRyb2wgbGFiZWwgZnJvbSBjb25maWcgb3Igd2VsbCBkYXRhIGFuZCBmb3JtYXQgaXQKICAgICAgICAgIGxhYmVsID0gd2VsbExhYmVsc1tyb3dMZXR0ZXJdIHx8IHdlbGxEYXRhLmxhYmVsIHx8IHdlbGxEYXRhLmNvbnRlbnQgfHwgIiI7CiAgICAgICAgICBpZiAobGFiZWwpIHsKICAgICAgICAgICAgbGFiZWwgPSBmb3JtYXRMYWJlbChsYWJlbCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFNob3cgZGF0YXNldCBjb3VudCBpZiBtb3JlIHRoYW4gMSwgb3RoZXJ3aXNlIHNob3cgd2VsbCBJRAogICAgICAgICAgbWFpblRleHQgPSBkYXRhc2V0Q291bnQgPiAxID8gYCR7ZGF0YXNldENvdW50fWAgOiB3ZWxsSWQ7CiAgICAgICAgICAvLyBVc2Ugcm93LWJhc2VkIGxhYmVsIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIHVzZSB3ZWxsJ3MgbGFiZWwgb3IgY29udGVudAogICAgICAgICAgbGFiZWwgPSB3ZWxsTGFiZWxzW3Jvd0xldHRlcl0gfHwgd2VsbERhdGEubGFiZWwgfHwgd2VsbERhdGEuY29udGVudCB8fCAiIjsKICAgICAgICAgIC8vIEZvcm1hdCBsYWJlbCAocmVtb3ZlIHVNLCBmb3JtYXQgYXMgbnVtYmVyLW51bWJlci1udW1iZXIpCiAgICAgICAgICBpZiAobGFiZWwpIHsKICAgICAgICAgICAgbGFiZWwgPSBmb3JtYXRMYWJlbChsYWJlbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGRpdi50ZXh0Q29udGVudCA9IG1haW5UZXh0OwogICAgICAgIGRpdi5zdHlsZS5jdXJzb3IgPSAicG9pbnRlciI7CiAgICAgICAgZGl2LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAiYXV0byI7CiAgICAgICAgZGl2LnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKICAgICAgICBkaXYuc3R5bGUuekluZGV4ID0gIjEiOwogICAgICAgIAogICAgICAgIC8vIEFkZCB2aXN1YWwgaW5kaWNhdG9yIGZvciBkdXBsaWNhdGUgd2VsbHMKICAgICAgICBpZiAoaXNEdXBsaWNhdGVXZWxsKHdlbGxJZCkpIHsKICAgICAgICAgIGRpdi5zdHlsZS5ib3JkZXJXaWR0aCA9ICIycHgiOwogICAgICAgICAgZGl2LnN0eWxlLmJvcmRlclN0eWxlID0gImRvdWJsZSI7CiAgICAgICAgICBkaXYudGl0bGUgPSAoZGl2LnRpdGxlIHx8ICIiKSArICIg4pqg77iPIER1cGxpY2F0ZSB3ZWxsIC0gY2xpY2sgdG8gY29tcGFyZSBkYXRhc2V0cyI7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChsYWJlbCkgewogICAgICAgICAgY29uc3QgbGFiZWxEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgIGxhYmVsRGl2LmNsYXNzTmFtZSA9ICJ3ZWxsLWxhYmVsIjsKICAgICAgICAgIGxhYmVsRGl2LnRleHRDb250ZW50ID0gbGFiZWw7CiAgICAgICAgICBsYWJlbERpdi5zdHlsZS5wb2ludGVyRXZlbnRzID0gIm5vbmUiOwogICAgICAgICAgZGl2LmFwcGVuZENoaWxkKGxhYmVsRGl2KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZGl2LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgKGUpID0+IHsKICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICB0b2dnbGVXZWxsU2VsZWN0aW9uKHdlbGxJZCwgcGxhdGVzKTsKICAgICAgICB9KTsKICAgICAgICBpZiAoaXNDb250cm9sKSB7CiAgICAgICAgICBkaXYuY2xhc3NMaXN0LmFkZCgiY29udHJvbCIpOwogICAgICAgICAgZGl2LnRpdGxlID0gIkNvbnRyb2wgd2VsbCAoaW5kZXBlbmRlbnRseSBzZWxlY3RhYmxlKSI7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIENoZWNrIGlmIHRoaXMgd2VsbCBpcyBwYXJ0IG9mIGEgdHJpcGxpY2F0ZSBncm91cCAoY29udHJvbHMgYXJlIG5ldmVyIGluIHRyaXBsaWNhdGUgZ3JvdXBzKQogICAgICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgICAgICBjb25zdCB0cmlwbGljYXRlR3JvdXAgPSBnZXRUcmlwbGljYXRlR3JvdXAod2VsbElkLCBjb2x1bW4pOwogICAgICAgIAogICAgICAgIC8vIEFkZCB2aXN1YWwgaW5kaWNhdG9yIGZvciB0cmlwbGljYXRlIGdyb3VwcyB3aXRoIGRpc3RpbmN0IGNvbG9ycwogICAgICAgIC8vIEFsbCB3ZWxscyBpbiB0aGUgc2FtZSB0cmlwbGljYXRlIGdyb3VwIChzYW1lIG5hbWUpIGdldCB0aGUgc2FtZSBjb2xvcgogICAgICAgIC8vIEZvciBleGFtcGxlLCBhbGwgd2VsbHMgaW4gcm93cyBCLCBDLCBEIHdpdGggZ3JvdXAgbmFtZSAiMjUwLTEwLTIiIGdldCB0aGUgc2FtZSBjb2xvcgogICAgICAgIC8vIEJvcmRlcnMvc3Ryb2tlcyBvbmx5IGFwcGVhciB3aGVuIHNlbGVjdGVkCiAgICAgICAgaWYgKHRyaXBsaWNhdGVHcm91cCAmJiB0cmlwbGljYXRlR3JvdXAubmFtZSkgewogICAgICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoInRyaXBsaWNhdGUtZ3JvdXAiKTsKICAgICAgICAgIGRpdi50aXRsZSA9IGBUcmlwbGljYXRlIGdyb3VwOiAke3RyaXBsaWNhdGVHcm91cC5uYW1lfSAoY2xpY2sgdG8gc2VsZWN0IGFsbClgOwogICAgICAgICAgCiAgICAgICAgICAvLyBBcHBseSBkaXN0aW5jdCBjb2xvciBmb3IgdGhpcyB0cmlwbGljYXRlIGdyb3VwIChiYWNrZ3JvdW5kIG9ubHksIG5vIGJvcmRlciB1bmxlc3Mgc2VsZWN0ZWQpCiAgICAgICAgICAvLyBBbGwgd2VsbHMgd2l0aCB0aGUgc2FtZSBncm91cCBuYW1lIHdpbGwgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgICAgICAgICAvLyBUaGlzIGVuc3VyZXMgQiwgQywgRCByb3dzIGFsbCBnZXQgdGhlIHNhbWUgY29sb3IgZm9yIHRoZSBzYW1lIHRyaXBsaWNhdGUgZ3JvdXAKICAgICAgICAgIGNvbnN0IGdyb3VwTmFtZSA9IFN0cmluZyh0cmlwbGljYXRlR3JvdXAubmFtZSB8fCAiIikudHJpbSgpOyAvLyBOb3JtYWxpemUgZ3JvdXAgbmFtZQogICAgICAgICAgY29uc3QgY29sb3IgPSBnZXRUcmlwbGljYXRlR3JvdXBDb2xvcihncm91cE5hbWUpOwogICAgICAgICAgaWYgKGNvbG9yICYmIGNvbG9yLmJnSGFzRGF0YSkgewogICAgICAgICAgICAvLyBTZXQgYmFja2dyb3VuZCBjb2xvciBvbmx5IC0gYm9yZGVycyB3aWxsIGJlIGFkZGVkIHdoZW4gc2VsZWN0ZWQKICAgICAgICAgICAgY29uc3QgYmdDb2xvciA9IGhhc0RhdGEgPyBjb2xvci5iZ0hhc0RhdGEgOiBjb2xvci5iZzsKICAgICAgICAgICAgZGl2LnN0eWxlLnNldFByb3BlcnR5KCJiYWNrZ3JvdW5kLWNvbG9yIiwgYmdDb2xvciwgImltcG9ydGFudCIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBIaWdobGlnaHQgaWYgc2VsZWN0ZWQgKGNoZWNrIGlmIGFueSBzZWxlY3RlZCBkYXRhc2V0IGhhcyB0aGlzIHdlbGwgc2VsZWN0ZWQpCiAgICAgICAgLy8gQWxzbyBjaGVjayBpZiB0aGlzIHdlbGwgaXMgcGFydCBvZiBhIHRyaXBsaWNhdGUgZ3JvdXAgdGhhdCdzIHNlbGVjdGVkCiAgICAgICAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICAgICAgICBsZXQgaXNTZWxlY3RlZCA9IGZhbHNlOwogICAgICAgIAogICAgICAgIGlmICh0cmlwbGljYXRlR3JvdXApIHsKICAgICAgICAgIC8vIENoZWNrIGlmIGFueSB3ZWxsIGluIHRoaXMgdHJpcGxpY2F0ZSBncm91cCAoc2FtZSByb3cgcGF0dGVybiwgc2FtZSBjb2x1bW4pIGlzIHNlbGVjdGVkCiAgICAgICAgICBjb25zdCBncm91cFJvd0xldHRlcnMgPSBnZXRSb3dMZXR0ZXJzRnJvbVdlbGxzKHRyaXBsaWNhdGVHcm91cC53ZWxscyk7CiAgICAgICAgICBzZWxlY3RlZERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgICAgICAgIGdyb3VwUm93TGV0dGVycy5mb3JFYWNoKHJvd0xldHRlciA9PiB7CiAgICAgICAgICAgICAgY29uc3Qgd0lkID0gcm93TGV0dGVyICsgY29sdW1uOwogICAgICAgICAgICAgIGlmIChwbGF0ZXMuaW5jbHVkZXMocGxhdGVJZCkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7d0lkfWA7CiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0ZWRXZWxscy5oYXMoa2V5KSkgewogICAgICAgICAgICAgICAgICBpc1NlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIENoZWNrIGlmIHRoaXMgc3BlY2lmaWMgd2VsbCBpcyBzZWxlY3RlZAogICAgICAgICAgaXNTZWxlY3RlZCA9IHNlbGVjdGVkRGF0YXNldHMuc29tZShwbGF0ZUlkID0+IHsKICAgICAgICAgICAgaWYgKHBsYXRlcy5pbmNsdWRlcyhwbGF0ZUlkKSkgewogICAgICAgICAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7d2VsbElkfWA7CiAgICAgICAgICAgICAgcmV0dXJuIHNlbGVjdGVkV2VsbHMuaGFzKGtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChpc1NlbGVjdGVkKSB7CiAgICAgICAgICBkaXYuY2xhc3NMaXN0LmFkZCgic2VsZWN0ZWQiKTsKICAgICAgICAgIC8vIFVwZGF0ZSBiYWNrZ3JvdW5kIGNvbG9yIGFuZCBhZGQgYm9yZGVyIGZvciBzZWxlY3RlZCB0cmlwbGljYXRlIGdyb3VwcwogICAgICAgICAgaWYgKHRyaXBsaWNhdGVHcm91cCAmJiB0cmlwbGljYXRlR3JvdXAubmFtZSkgewogICAgICAgICAgICBjb25zdCBncm91cE5hbWUgPSBTdHJpbmcodHJpcGxpY2F0ZUdyb3VwLm5hbWUgfHwgIiIpLnRyaW0oKTsgLy8gTm9ybWFsaXplIGdyb3VwIG5hbWUKICAgICAgICAgICAgY29uc3QgY29sb3IgPSBnZXRUcmlwbGljYXRlR3JvdXBDb2xvcihncm91cE5hbWUpOwogICAgICAgICAgICBpZiAoY29sb3IpIHsKICAgICAgICAgICAgICBkaXYuc3R5bGUuc2V0UHJvcGVydHkoImJhY2tncm91bmQtY29sb3IiLCBjb2xvci5iZ0hhc0RhdGEsICJpbXBvcnRhbnQiKTsKICAgICAgICAgICAgICAvLyBBZGQgYm9yZGVyIHdoZW4gc2VsZWN0ZWQKICAgICAgICAgICAgICBkaXYuc3R5bGUuc2V0UHJvcGVydHkoImJvcmRlci1jb2xvciIsIGNvbG9yLmJvcmRlciwgImltcG9ydGFudCIpOwogICAgICAgICAgICAgIGRpdi5zdHlsZS5zZXRQcm9wZXJ0eSgiYm9yZGVyLXdpZHRoIiwgIjJweCIsICJpbXBvcnRhbnQiKTsKICAgICAgICAgICAgICBkaXYuc3R5bGUuc2V0UHJvcGVydHkoImJvcmRlci1zdHlsZSIsICJzb2xpZCIsICJpbXBvcnRhbnQiKTsKICAgICAgICAgICAgICBkaXYuc3R5bGUuc2V0UHJvcGVydHkoIm91dGxpbmUiLCBgMnB4IHNvbGlkICR7Y29sb3IuYm9yZGVyfWAsICJpbXBvcnRhbnQiKTsKICAgICAgICAgICAgICBkaXYuc3R5bGUuc2V0UHJvcGVydHkoIm91dGxpbmUtb2Zmc2V0IiwgIi0ycHgiLCAiaW1wb3J0YW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGl2LnN0eWxlLmN1cnNvciA9ICJkZWZhdWx0IjsKICAgICAgICBkaXYuc3R5bGUuYmFja2dyb3VuZCA9ICIjZjJmMmYyIjsKICAgICAgfQogICAgICBncmlkLmFwcGVuZENoaWxkKGRpdik7CiAgICB9CiAgfSk7CiAgCiAgLy8gVXBkYXRlIGNvbHVtbiBsZWdlbmQgd2l0aCBkYXRhc2V0IG1hcHBpbmcgKHVzZSBhbGwgZGF0YXNldHMgaW4gZ3JvdXApCiAgdXBkYXRlQ29sdW1uTGVnZW5kKGNvbHVtbkluZm9NYXAsIGFsbEdyb3VwRGF0YXNldHMpOwp9CgpmdW5jdGlvbiB1cGRhdGVDb2x1bW5MZWdlbmQoY29sdW1uSW5mb01hcCwgYWxsRGF0YXNldHMpIHsKICBjb25zdCBsZWdlbmREaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY29sdW1uLWxlZ2VuZC1jb250ZW50Iik7CiAgaWYgKCFsZWdlbmREaXYpIHJldHVybjsKICAKICAvLyBCdWlsZCBtYXA6IGNvbHVtbiAtPiB7IGRhdGFzZXRzOiBTZXQsIGluZm86IHsgZ2Vub3R5cGUsIGJ1ZmZlciwgc2NpZW50aXN0IH0gfQogIGNvbnN0IGNvbHVtbkRhdGEgPSB7fTsgLy8gY29sdW1uIC0+IHsgZGF0YXNldHM6IFNldCwgaW5mbzoge30gfQogIAogIC8vIEZpbmQgd2hpY2ggZGF0YXNldHMgaGF2ZSBkYXRhIGluIGVhY2ggY29sdW1uCiAgZm9yIChsZXQgY29sID0gMTsgY29sIDw9IFBMQVRFX0NPTFM7IGNvbCsrKSB7CiAgICBjb25zdCBpbmZvID0gY29sdW1uSW5mb01hcFtjb2xdOwogICAgaWYgKCFpbmZvKSBjb250aW51ZTsKICAgIAogICAgY29sdW1uRGF0YVtjb2xdID0gewogICAgICBkYXRhc2V0czogbmV3IFNldCgpLAogICAgICBpbmZvOiB7CiAgICAgICAgZ2Vub3R5cGU6IGluZm8uZ2Vub3R5cGUgfHwgIiIsCiAgICAgICAgYnVmZmVyOiBpbmZvLmJ1ZmZlciB8fCAiIiwKICAgICAgICBzY2llbnRpc3Q6IGluZm8uc2NpZW50aXN0IHx8ICIiCiAgICAgIH0KICAgIH07CiAgICAKICAgIC8vIEZpbmQgYWxsIGRhdGFzZXRzIHRoYXQgaGF2ZSBkYXRhIGluIHRoaXMgY29sdW1uCiAgICBhbGxEYXRhc2V0cy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgICAgY29uc3QgaGFzRGF0YUluQ29sdW1uID0gT2JqZWN0LmtleXMod2VsbHMpLnNvbWUod2VsbElkID0+IHsKICAgICAgICBjb25zdCB3ZWxsQ29sID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgICAgIHJldHVybiB3ZWxsQ29sID09PSBjb2w7CiAgICAgIH0pOwogICAgICAKICAgICAgaWYgKGhhc0RhdGFJbkNvbHVtbikgewogICAgICAgIGNvbHVtbkRhdGFbY29sXS5kYXRhc2V0cy5hZGQocGxhdGVJZCk7CiAgICAgIH0KICAgIH0pOwogIH0KICAKICBpZiAoT2JqZWN0LmtleXMoY29sdW1uRGF0YSkubGVuZ3RoID09PSAwKSB7CiAgICBsZWdlbmREaXYuaW5uZXJIVE1MID0gIjxkaXYgc3R5bGU9J2NvbG9yOiAjNjY2OyBmb250LXNpemU6IDAuOHJlbTsnPk5vIGNvbHVtbiBpbmZvcm1hdGlvbiBhdmFpbGFibGUuPC9kaXY+IjsKICAgIHJldHVybjsKICB9CiAgCiAgLy8gQnVpbGQgSFRNTCB3aXRoIGluZGl2aWR1YWwgY29sdW1uIGNoZWNrYm94ZXMKICBsZWdlbmREaXYuaW5uZXJIVE1MID0gIiI7CiAgCiAgLy8gU29ydCBjb2x1bW5zIG51bWVyaWNhbGx5CiAgY29uc3Qgc29ydGVkQ29sdW1ucyA9IE9iamVjdC5rZXlzKGNvbHVtbkRhdGEpLm1hcChOdW1iZXIpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKICAKICBzb3J0ZWRDb2x1bW5zLmZvckVhY2goY29sID0+IHsKICAgIGNvbnN0IGNvbERhdGEgPSBjb2x1bW5EYXRhW2NvbF07CiAgICBjb25zdCBjb2xEYXRhc2V0cyA9IEFycmF5LmZyb20oY29sRGF0YS5kYXRhc2V0cyk7CiAgICAKICAgIGlmIChjb2xEYXRhc2V0cy5sZW5ndGggPT09IDApIHJldHVybjsgLy8gU2tpcCBjb2x1bW5zIHdpdGggbm8gZGF0YQogICAgCiAgICAvLyBDaGVjayBpZiB0aGlzIGNvbHVtbiBpcyBlbmFibGVkIChlbXB0eSBzZXQgPSBhbGwgZW5hYmxlZCwgb3IgY29sdW1uIGlzIGluIHRoZSBzZXQpCiAgICBjb25zdCBjb2x1bW5FbmFibGVkID0gZW5hYmxlZENvbHVtbnMuc2l6ZSA9PT0gMCB8fCBlbmFibGVkQ29sdW1ucy5oYXMoY29sKTsKICAgIAogICAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBkaXYuc3R5bGUubWFyZ2luQm90dG9tID0gIjZweCI7CiAgICBkaXYuc3R5bGUucGFkZGluZyA9ICI2cHgiOwogICAgZGl2LnN0eWxlLmJhY2tncm91bmQgPSAiI2Y5ZjlmOSI7CiAgICBkaXYuc3R5bGUuYm9yZGVyUmFkaXVzID0gIjNweCI7CiAgICAKICAgIGNvbnN0IGNoZWNrYm94ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgIGNoZWNrYm94LnR5cGUgPSAiY2hlY2tib3giOwogICAgY2hlY2tib3guaWQgPSBgY29sdW1uLSR7Y29sfWA7CiAgICBjaGVja2JveC5jaGVja2VkID0gY29sdW1uRW5hYmxlZDsKICAgIGNoZWNrYm94LnN0eWxlLm1hcmdpblJpZ2h0ID0gIjhweCI7CiAgICBjaGVja2JveC5zdHlsZS5jdXJzb3IgPSAicG9pbnRlciI7CiAgICBjaGVja2JveC5kYXRhc2V0LmNvbHVtbiA9IGNvbDsKICAgIGNoZWNrYm94LmRhdGFzZXQuZGF0YXNldHMgPSBKU09OLnN0cmluZ2lmeShjb2xEYXRhc2V0cyk7CiAgICAKICAgIGNoZWNrYm94LmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsIChlKSA9PiB7CiAgICAgIGNvbnN0IGNvbHVtbiA9IHBhcnNlSW50KGUudGFyZ2V0LmRhdGFzZXQuY29sdW1uKTsKICAgICAgY29uc3QgYWxsR3JvdXBEYXRhc2V0cyA9IGdldEFsbERhdGFzZXRzSW5Hcm91cCgpOwogICAgICAKICAgICAgLy8gR2V0IGFsbCBjb2x1bW5zIHRoYXQgaGF2ZSBkYXRhCiAgICAgIGNvbnN0IGFsbENvbHVtbnNXaXRoRGF0YSA9IG5ldyBTZXQoKTsKICAgICAgYWxsR3JvdXBEYXRhc2V0cy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICAgIE9iamVjdC5rZXlzKHdlbGxzKS5mb3JFYWNoKHdlbGxJZCA9PiB7CiAgICAgICAgICBjb25zdCBjb2wgPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAgICAgICBhbGxDb2x1bW5zV2l0aERhdGEuYWRkKGNvbCk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICAKICAgICAgaWYgKGUudGFyZ2V0LmNoZWNrZWQpIHsKICAgICAgICAvLyBFbmFibGluZzogYWRkIGNvbHVtbiB0byBlbmFibGVkIHNldAogICAgICAgIGVuYWJsZWRDb2x1bW5zLmFkZChjb2x1bW4pOwogICAgICAgIAogICAgICAgIC8vIElmIGFsbCBjb2x1bW5zIGFyZSBub3cgZW5hYmxlZCwgY2xlYXIgdGhlIHNldCAobWVhbmluZyBhbGwgZW5hYmxlZCkKICAgICAgICBpZiAoQXJyYXkuZnJvbShhbGxDb2x1bW5zV2l0aERhdGEpLmV2ZXJ5KGNvbCA9PiBlbmFibGVkQ29sdW1ucy5oYXMoY29sKSkpIHsKICAgICAgICAgIGVuYWJsZWRDb2x1bW5zLmNsZWFyKCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIERpc2FibGluZzogaWYgc2V0IGlzIGVtcHR5IChhbGwgZW5hYmxlZCksIHBvcHVsYXRlIGl0IHdpdGggYWxsIGNvbHVtbnMgZXhjZXB0IHRoZSBvbmUgYmVpbmcgdW5jaGVja2VkCiAgICAgICAgaWYgKGVuYWJsZWRDb2x1bW5zLnNpemUgPT09IDApIHsKICAgICAgICAgIC8vIEN1cnJlbnRseSBhbGwgYXJlIGVuYWJsZWQsIHNvIGVuYWJsZSBhbGwgY29sdW1ucyBleGNlcHQgdGhlIG9uZSBiZWluZyB1bmNoZWNrZWQKICAgICAgICAgIGFsbENvbHVtbnNXaXRoRGF0YS5mb3JFYWNoKGNvbCA9PiB7CiAgICAgICAgICAgIGlmIChjb2wgIT09IGNvbHVtbikgewogICAgICAgICAgICAgIGVuYWJsZWRDb2x1bW5zLmFkZChjb2wpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gU29tZSBjb2x1bW5zIGFyZSBhbHJlYWR5IGRpc2FibGVkLCByZW1vdmUgdGhpcyBvbmUgZnJvbSBlbmFibGVkIHNldAogICAgICAgICAgZW5hYmxlZENvbHVtbnMuZGVsZXRlKGNvbHVtbik7CiAgICAgICAgfQogICAgICB9CiAgICAgIAogICAgICByZW5kZXJQbGF0ZUdyaWQoKTsKICAgICAgdXBkYXRlV2VsbEluZm8oKTsKICAgICAgdXBkYXRlQ2hhcnQoKTsKICAgIH0pOwogICAgCiAgICBjb25zdCBsYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxhYmVsIik7CiAgICBsYWJlbC5odG1sRm9yID0gYGNvbHVtbi0ke2NvbH1gOwogICAgbGFiZWwuc3R5bGUuY3Vyc29yID0gInBvaW50ZXIiOwogICAgbGFiZWwuc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsKICAgIGxhYmVsLnN0eWxlLmFsaWduSXRlbXMgPSAiY2VudGVyIjsKICAgIGxhYmVsLnN0eWxlLmZvbnRXZWlnaHQgPSAiNjAwIjsKICAgIAogICAgbGFiZWwuYXBwZW5kQ2hpbGQoY2hlY2tib3gpOwogICAgY29uc3QgbGFiZWxUZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgbGFiZWxUZXh0LnRleHRDb250ZW50ID0gYENvbHVtbiAke2NvbH1gOwogICAgbGFiZWwuYXBwZW5kQ2hpbGQobGFiZWxUZXh0KTsKICAgIAogICAgZGl2LmFwcGVuZENoaWxkKGxhYmVsKTsKICAgIAogICAgY29uc3QgZGV0YWlscyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgZGV0YWlscy5zdHlsZS5mb250U2l6ZSA9ICIwLjc1cmVtIjsKICAgIGRldGFpbHMuc3R5bGUubWFyZ2luTGVmdCA9ICIyNHB4IjsKICAgIGRldGFpbHMuc3R5bGUubWFyZ2luVG9wID0gIjRweCI7CiAgICAKICAgIGlmIChjb2xEYXRhLmluZm8uZ2Vub3R5cGUpIHsKICAgICAgY29uc3QgZ2VuRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGdlbkRpdi5zdHlsZS5tYXJnaW5Cb3R0b20gPSAiMnB4IjsKICAgICAgZ2VuRGl2LmlubmVySFRNTCA9IGA8c3Ryb25nPkdlbm90eXBlOjwvc3Ryb25nPiAke2NvbERhdGEuaW5mby5nZW5vdHlwZX1gOwogICAgICBkZXRhaWxzLmFwcGVuZENoaWxkKGdlbkRpdik7CiAgICB9CiAgICBpZiAoY29sRGF0YS5pbmZvLmJ1ZmZlcikgewogICAgICBjb25zdCBidWZEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgYnVmRGl2LnN0eWxlLm1hcmdpbkJvdHRvbSA9ICIycHgiOwogICAgICBidWZEaXYuaW5uZXJIVE1MID0gYDxzdHJvbmc+QnVmZmVyOjwvc3Ryb25nPiAke2NvbERhdGEuaW5mby5idWZmZXJ9YDsKICAgICAgZGV0YWlscy5hcHBlbmRDaGlsZChidWZEaXYpOwogICAgfQogICAgaWYgKGNvbERhdGEuaW5mby5zY2llbnRpc3QpIHsKICAgICAgY29uc3Qgc2NpRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIHNjaURpdi5pbm5lckhUTUwgPSBgPHN0cm9uZz5TY2llbnRpc3Q6PC9zdHJvbmc+ICR7Y29sRGF0YS5pbmZvLnNjaWVudGlzdH1gOwogICAgICBkZXRhaWxzLmFwcGVuZENoaWxkKHNjaURpdik7CiAgICB9CiAgICAKICAgIGlmIChjb2xEYXRhc2V0cy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IGNvdW50RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGNvdW50RGl2LnN0eWxlLm1hcmdpblRvcCA9ICI0cHgiOwogICAgICBjb3VudERpdi5zdHlsZS5mb250U2l6ZSA9ICIwLjdyZW0iOwogICAgICBjb3VudERpdi5zdHlsZS5jb2xvciA9ICIjNjY2IjsKICAgICAgY291bnREaXYudGV4dENvbnRlbnQgPSBgJHtjb2xEYXRhc2V0cy5sZW5ndGh9IGRhdGFzZXQke2NvbERhdGFzZXRzLmxlbmd0aCAhPT0gMSA/ICJzIiA6ICIifWA7CiAgICAgIGRldGFpbHMuYXBwZW5kQ2hpbGQoY291bnREaXYpOwogICAgfQogICAgCiAgICBkaXYuYXBwZW5kQ2hpbGQoZGV0YWlscyk7CiAgICBsZWdlbmREaXYuYXBwZW5kQ2hpbGQoZGl2KTsKICB9KTsKfQoKZnVuY3Rpb24gdG9nZ2xlV2VsbFNlbGVjdGlvbih3ZWxsSWQsIHBsYXRlSWRzKSB7CiAgLy8gVG9nZ2xlIHNlbGVjdGlvbiBmb3IgYWxsIHNlbGVjdGVkIGRhdGFzZXRzCiAgaWYgKCFzZWxlY3RlZERhdGFzZXRJZCkgcmV0dXJuOwogIAogIGNvbnN0IHNlbGVjdGVkRGF0YXNldHMgPSBnZXRTZWxlY3RlZERhdGFzZXRzKCk7CiAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogIGNvbnN0IGlzQ29udHJvbCA9IGlzQ29udHJvbFdlbGwod2VsbElkKTsKICAKICAvLyBDb250cm9sIHdlbGxzOiBhbGxvdyBpbmRpdmlkdWFsIHNlbGVjdGlvbiAoY2FuIHNlbGVjdCBlYWNoIHdlbGwgc2VwYXJhdGVseSkKICBpZiAoaXNDb250cm9sKSB7CiAgICAvLyBDaGVjayBpZiB0aGlzIHNwZWNpZmljIGNvbnRyb2wgd2VsbCBpcyBhbHJlYWR5IHNlbGVjdGVkCiAgICBsZXQgaXNTZWxlY3RlZCA9IGZhbHNlOwogICAgc2VsZWN0ZWREYXRhc2V0cy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBpZiAocGxhdGVJZHMuaW5jbHVkZXMocGxhdGVJZCkpIHsKICAgICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke3dlbGxJZH1gOwogICAgICAgIGlmIChzZWxlY3RlZFdlbGxzLmhhcyhrZXkpKSB7CiAgICAgICAgICBpc1NlbGVjdGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgCiAgICAvLyBUb2dnbGUganVzdCB0aGlzIGluZGl2aWR1YWwgY29udHJvbCB3ZWxsIGFjcm9zcyBhbGwgc2VsZWN0ZWQgZGF0YXNldHMKICAgIGxldCBhbnlDaGFuZ2VkID0gZmFsc2U7CiAgICBzZWxlY3RlZERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIC8vIE9ubHkgdG9nZ2xlIGlmIHRoaXMgcGxhdGUgaGFzIGRhdGEgZm9yIHRoaXMgd2VsbAogICAgICBpZiAocGxhdGVJZHMuaW5jbHVkZXMocGxhdGVJZCkpIHsKICAgICAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZFdlbGxzIGlmIGFueSBhcmUgc2V0CiAgICAgICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3ZWxsSWQpKSB7CiAgICAgICAgICByZXR1cm47IC8vIFNraXAgZXhjbHVkZWQgd2VsbHMKICAgICAgICB9CiAgICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHt3ZWxsSWR9YDsKICAgICAgICBpZiAoaXNTZWxlY3RlZCkgewogICAgICAgICAgc2VsZWN0ZWRXZWxscy5kZWxldGUoa2V5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZWN0ZWRXZWxscy5hZGQoa2V5KTsKICAgICAgICB9CiAgICAgICAgYW55Q2hhbmdlZCA9IHRydWU7CiAgICAgIH0KICAgIH0pOwogICAgCiAgICBpZiAoYW55Q2hhbmdlZCkgewogICAgICByZW5kZXJQbGF0ZUdyaWQoKTsKICAgICAgdXBkYXRlV2VsbEluZm8oKTsKICAgICAgdXBkYXRlQ2hhcnQoKTsKICAgIH0KICAgIHJldHVybjsKICB9CiAgCiAgLy8gRm9yIGR1cGxpY2F0ZSB3ZWxscywgYXV0b21hdGljYWxseSBzZWxlY3QgYWxsIGRhdGFzZXRzIGZvciBjb21wYXJpc29uCiAgaWYgKGlzRHVwbGljYXRlV2VsbCh3ZWxsSWQpKSB7CiAgICAvLyBGaW5kIGFsbCBkYXRhc2V0cyB0aGF0IGhhdmUgdGhpcyB3ZWxsCiAgICBjb25zdCBhbGxHcm91cERhdGFzZXRzID0gZ2V0QWxsRGF0YXNldHNJbkdyb3VwKCk7CiAgICBjb25zdCBkYXRhc2V0c1dpdGhXZWxsID0gYWxsR3JvdXBEYXRhc2V0cy5maWx0ZXIocGxhdGVJZCA9PiB7CiAgICAgIHJldHVybiBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gJiYgYWxsV2VsbHNEYXRhW3BsYXRlSWRdW3dlbGxJZF07CiAgICB9KTsKICAgIAogICAgLy8gQ2hlY2sgaWYgYW55IGRhdGFzZXQgZm9yIHRoaXMgd2VsbCBpcyBhbHJlYWR5IHNlbGVjdGVkCiAgICBsZXQgaXNBbnlTZWxlY3RlZCA9IGRhdGFzZXRzV2l0aFdlbGwuc29tZShwbGF0ZUlkID0+IHsKICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHt3ZWxsSWR9YDsKICAgICAgcmV0dXJuIHNlbGVjdGVkV2VsbHMuaGFzKGtleSk7CiAgICB9KTsKICAgIAogICAgLy8gVG9nZ2xlIGFsbCBkYXRhc2V0cyBmb3IgdGhpcyBkdXBsaWNhdGUgd2VsbAogICAgbGV0IGFueUNoYW5nZWQgPSBmYWxzZTsKICAgIGRhdGFzZXRzV2l0aFdlbGwuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHt3ZWxsSWR9YDsKICAgICAgaWYgKGlzQW55U2VsZWN0ZWQpIHsKICAgICAgICBzZWxlY3RlZFdlbGxzLmRlbGV0ZShrZXkpOwogICAgICB9IGVsc2UgewogICAgICAgIHNlbGVjdGVkV2VsbHMuYWRkKGtleSk7CiAgICAgIH0KICAgICAgYW55Q2hhbmdlZCA9IHRydWU7CiAgICB9KTsKICAgIAogICAgaWYgKGFueUNoYW5nZWQpIHsKICAgICAgcmVuZGVyUGxhdGVHcmlkKCk7CiAgICAgIHVwZGF0ZVdlbGxJbmZvKCk7CiAgICAgIHVwZGF0ZUNoYXJ0KCk7CiAgICB9CiAgICByZXR1cm47CiAgfQogIAogIC8vIEZvciBub24tY29udHJvbCB3ZWxscywgY2hlY2sgdHJpcGxpY2F0ZSBncm91cHMKICBjb25zdCB0cmlwbGljYXRlR3JvdXAgPSBnZXRUcmlwbGljYXRlR3JvdXAod2VsbElkLCBjb2x1bW4pOwogIAogIGxldCBhbnlDaGFuZ2VkID0gZmFsc2U7CiAgCiAgLy8gQ2hlY2sgaWYgdHJpcGxpY2F0ZSBncm91cCBpcyBzZWxlY3RlZCAoY2hlY2sgaWYgQUxMIHdlbGxzIGluIHRoZSBncm91cCBhcmUgc2VsZWN0ZWQpCiAgbGV0IGlzR3JvdXBTZWxlY3RlZCA9IGZhbHNlOwogIGlmICh0cmlwbGljYXRlR3JvdXApIHsKICAgIGNvbnN0IGdyb3VwUm93TGV0dGVycyA9IGdldFJvd0xldHRlcnNGcm9tV2VsbHModHJpcGxpY2F0ZUdyb3VwLndlbGxzKTsKICAgIC8vIENvdW50IGhvdyBtYW55IHdlbGxzIGluIHRoZSBncm91cCBhcmUgc2VsZWN0ZWQKICAgIGxldCBzZWxlY3RlZENvdW50ID0gMDsKICAgIGxldCB0b3RhbENvdW50ID0gMDsKICAgIAogICAgc2VsZWN0ZWREYXRhc2V0cy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBncm91cFJvd0xldHRlcnMuZm9yRWFjaChyb3dMZXR0ZXIgPT4gewogICAgICAgIGNvbnN0IHdJZCA9IHJvd0xldHRlciArIGNvbHVtbjsKICAgICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke3dJZH1gOwogICAgICAgIGNvbnN0IGhhc0RhdGEgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gJiYgYWxsV2VsbHNEYXRhW3BsYXRlSWRdW3dJZF07CiAgICAgICAgaWYgKGhhc0RhdGEpIHsKICAgICAgICAgIHRvdGFsQ291bnQrKzsKICAgICAgICAgIGlmIChzZWxlY3RlZFdlbGxzLmhhcyhrZXkpKSB7CiAgICAgICAgICAgIHNlbGVjdGVkQ291bnQrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgICAKICAgIC8vIENvbnNpZGVyIGdyb3VwIHNlbGVjdGVkIGlmIGF0IGxlYXN0IG9uZSB3ZWxsIGlzIHNlbGVjdGVkIChmb3IgdG9nZ2xlIGJlaGF2aW9yKQogICAgLy8gVGhpcyBhbGxvd3MgY2xpY2tpbmcgdG8gdG9nZ2xlIHRoZSB3aG9sZSBncm91cAogICAgaXNHcm91cFNlbGVjdGVkID0gc2VsZWN0ZWRDb3VudCA+IDA7CiAgfSBlbHNlIHsKICAgIC8vIEZvciBub24tdHJpcGxpY2F0ZSB3ZWxscywgY2hlY2sgaWYgdGhpcyBzcGVjaWZpYyB3ZWxsIGlzIHNlbGVjdGVkCiAgICBzZWxlY3RlZERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGlmIChwbGF0ZUlkcy5pbmNsdWRlcyhwbGF0ZUlkKSkgewogICAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7d2VsbElkfWA7CiAgICAgICAgaWYgKHNlbGVjdGVkV2VsbHMuaGFzKGtleSkpIHsKICAgICAgICAgIGlzR3JvdXBTZWxlY3RlZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CiAgCiAgLy8gVG9nZ2xlIHNlbGVjdGlvbjogaWYgZ3JvdXAvd2VsbCBpcyBzZWxlY3RlZCwgcmVtb3ZlIGFsbDsgb3RoZXJ3aXNlIGFkZCBhbGwKICBpZiAodHJpcGxpY2F0ZUdyb3VwKSB7CiAgICAvLyBHZXQgcm93IGxldHRlcnMgZnJvbSB0aGUgdHJpcGxpY2F0ZSBncm91cCBwYXR0ZXJuCiAgICBjb25zdCBncm91cFJvd0xldHRlcnMgPSBnZXRSb3dMZXR0ZXJzRnJvbVdlbGxzKHRyaXBsaWNhdGVHcm91cC53ZWxscyk7CiAgICAKICAgIC8vIFRvZ2dsZSBhbGwgd2VsbHMgaW4gdGhlIHRyaXBsaWNhdGUgZ3JvdXAgKHNhbWUgcm93IHBhdHRlcm4sIHNhbWUgY29sdW1uKSBhY3Jvc3MgYWxsIHNlbGVjdGVkIGRhdGFzZXRzCiAgICBzZWxlY3RlZERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGdyb3VwUm93TGV0dGVycy5mb3JFYWNoKHJvd0xldHRlciA9PiB7CiAgICAgICAgY29uc3Qgd0lkID0gcm93TGV0dGVyICsgY29sdW1uOwogICAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7d0lkfWA7CiAgICAgICAgY29uc3QgaGFzRGF0YSA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSAmJiBhbGxXZWxsc0RhdGFbcGxhdGVJZF1bd0lkXTsKICAgICAgICBpZiAoaGFzRGF0YSkgewogICAgICAgICAgLy8gRmlsdGVyIGJ5IGVuYWJsZWRXZWxscyBpZiBhbnkgYXJlIHNldAogICAgICAgICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3SWQpKSB7CiAgICAgICAgICAgIHJldHVybjsgLy8gU2tpcCBleGNsdWRlZCB3ZWxscwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzR3JvdXBTZWxlY3RlZCkgewogICAgICAgICAgICBzZWxlY3RlZFdlbGxzLmRlbGV0ZShrZXkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZWN0ZWRXZWxscy5hZGQoa2V5KTsKICAgICAgICAgIH0KICAgICAgICAgIGFueUNoYW5nZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9IGVsc2UgewogICAgLy8gVG9nZ2xlIGluZGl2aWR1YWwgd2VsbCBhY3Jvc3MgYWxsIHNlbGVjdGVkIGRhdGFzZXRzCiAgICBzZWxlY3RlZERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIC8vIE9ubHkgdG9nZ2xlIGlmIHRoaXMgcGxhdGUgaGFzIGRhdGEgZm9yIHRoaXMgd2VsbAogICAgICBpZiAocGxhdGVJZHMuaW5jbHVkZXMocGxhdGVJZCkpIHsKICAgICAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZFdlbGxzIGlmIGFueSBhcmUgc2V0CiAgICAgICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3ZWxsSWQpKSB7CiAgICAgICAgICByZXR1cm47IC8vIFNraXAgZXhjbHVkZWQgd2VsbHMKICAgICAgICB9CiAgICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHt3ZWxsSWR9YDsKICAgICAgICBpZiAoaXNHcm91cFNlbGVjdGVkKSB7CiAgICAgICAgICBzZWxlY3RlZFdlbGxzLmRlbGV0ZShrZXkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxlY3RlZFdlbGxzLmFkZChrZXkpOwogICAgICAgIH0KICAgICAgICBhbnlDaGFuZ2VkID0gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgfQogIAogIGlmIChhbnlDaGFuZ2VkKSB7CiAgICByZW5kZXJQbGF0ZUdyaWQoKTsKICAgIHVwZGF0ZVdlbGxJbmZvKCk7CiAgfQp9CgpmdW5jdGlvbiBjbGVhclNlbGVjdGlvbigpIHsKICBzZWxlY3RlZFdlbGxzLmNsZWFyKCk7CiAgcmVuZGVyUGxhdGVHcmlkKCk7CiAgdXBkYXRlQ2hhcnQoKTsKfQoKZnVuY3Rpb24gdXBkYXRlV2VsbEluZm8oKSB7CiAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgid2VsbC1pbmZvIik7CiAgaWYgKHNlbGVjdGVkV2VsbHMuc2l6ZSA9PT0gMCkgewogICAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICAgIGNvbnN0IGRhdGFzZXRDb3VudCA9IHNlbGVjdGVkRGF0YXNldHMubGVuZ3RoOwogICAgaWYgKGRhdGFzZXRDb3VudCA+IDEpIHsKICAgICAgZWwudGV4dENvbnRlbnQgPSBgU2VsZWN0ZWQgZ3JvdXAgd2l0aCAke2RhdGFzZXRDb3VudH0gZGF0YXNldHMuIENsaWNrIHdlbGxzIG9uIHRoZSBwbGF0ZSB0byBhZGQgdGhlbSB0byB0aGUgY2hhcnQuYDsKICAgIH0gZWxzZSB7CiAgICAgIGVsLnRleHRDb250ZW50ID0gIkNsaWNrIHdlbGxzIG9uIHRoZSBwbGF0ZSB0byBhZGQgdGhlbSB0byB0aGUgY2hhcnQuIjsKICAgIH0KICAgIHJldHVybjsKICB9CiAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICBjb25zdCBkYXRhc2V0Q291bnQgPSBzZWxlY3RlZERhdGFzZXRzLmxlbmd0aDsKICBjb25zdCB1bmlxdWVXZWxscyA9IG5ldyBTZXQoQXJyYXkuZnJvbShzZWxlY3RlZFdlbGxzKS5tYXAoa2V5ID0+IGtleS5zcGxpdCgiOiIpWzFdKSk7CiAgY29uc3Qgd2VsbENvdW50ID0gdW5pcXVlV2VsbHMuc2l6ZTsKICBpZiAoZGF0YXNldENvdW50ID4gMSkgewogICAgZWwudGV4dENvbnRlbnQgPSBgJHt3ZWxsQ291bnR9IHdlbGwocykgc2VsZWN0ZWQgYWNyb3NzICR7ZGF0YXNldENvdW50fSBkYXRhc2V0cy4gQ2xpY2sgIlVwZGF0ZSBDaGFydCIgdG8gZGlzcGxheS5gOwogIH0gZWxzZSB7CiAgICBlbC50ZXh0Q29udGVudCA9IGAke3dlbGxDb3VudH0gd2VsbChzKSBzZWxlY3RlZC4gQ2xpY2sgIlVwZGF0ZSBDaGFydCIgdG8gZGlzcGxheS5gOwogIH0KfQoKZnVuY3Rpb24gaXNDb250cm9sV2VsbCh3ZWxsSWQpIHsKICAvLyBDb250cm9sIHdlbGxzIGFyZSBjb25maWd1cmFibGUgdmlhIGNvbnRyb2xfcm93cyBpbiBjb25maWcgKGRlZmF1bHQ6IFsiTiIsICJPIl0pCiAgY29uc3QgY29uZmlnID0gdmlld2VyRGF0YS5jb25maWcgfHwge307CiAgY29uc3QgY29udHJvbFJvd3MgPSBjb25maWcuY29udHJvbF9yb3dzIHx8IFsiTiIsICJPIl07CiAgY29uc3Qgcm93TGV0dGVyID0gd2VsbElkLnJlcGxhY2UoL1swLTldL2csICcnKTsKICByZXR1cm4gY29udHJvbFJvd3MuaW5jbHVkZXMocm93TGV0dGVyKTsKfQoKZnVuY3Rpb24gZm9ybWF0TGFiZWwobGFiZWwpIHsKICAvLyBGb3JtYXQgbGFiZWxzOiByZW1vdmUgInVNIiBhbmQgY29udmVydCB0byAibnVtYmVyLW51bWJlci1udW1iZXIiIGZvcm1hdAogIC8vIEV4YW1wbGVzOiAiMjUwIHVNIDEwLTIiIC0+ICIyNTAtMTAtMiIsICI1MDAgdU0gNS0yIiAtPiAiNTAwLTUtMiIKICBpZiAoIWxhYmVsKSByZXR1cm4gbGFiZWw7CiAgCiAgLy8gUmVtb3ZlICJ1TSIgKGNhc2UgaW5zZW5zaXRpdmUpIGFuZCBleHRyYSBzcGFjZXMKICBsZXQgZm9ybWF0dGVkID0gbGFiZWwucmVwbGFjZSgvXHMqdU1ccyovZ2ksICcgJykucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwogIAogIC8vIEV4dHJhY3QgbnVtYmVycyBhbmQgaHlwaGVucywgcmVwbGFjZSBzcGFjZXMgd2l0aCBoeXBoZW5zCiAgLy8gTWF0Y2ggcGF0dGVybjogbnVtYmVyKHMpIGZvbGxvd2VkIGJ5IG9wdGlvbmFsIHNwYWNlL2h5cGhlbiBhbmQgbW9yZSBudW1iZXJzCiAgZm9ybWF0dGVkID0gZm9ybWF0dGVkLnJlcGxhY2UoLyhcZCspXHMqLVxzKihcZCspL2csICckMS0kMicpOyAvLyBIYW5kbGUgZXhpc3RpbmcgaHlwaGVucwogIGZvcm1hdHRlZCA9IGZvcm1hdHRlZC5yZXBsYWNlKC8oXGQrKVxzKyhcZCspL2csICckMS0kMicpOyAvLyBSZXBsYWNlIHNwYWNlcyBiZXR3ZWVuIG51bWJlcnMgd2l0aCBoeXBoZW5zCiAgCiAgcmV0dXJuIGZvcm1hdHRlZDsKfQoKZnVuY3Rpb24gZ2V0Um93TGV0dGVyKHdlbGxJZCkgewogIC8vIEV4dHJhY3Qgcm93IGxldHRlciBmcm9tIHdlbGwgSUQgKGUuZy4sICJCMTMiIC0+ICJCIikKICByZXR1cm4gd2VsbElkLnJlcGxhY2UoL1swLTldL2csICcnKTsKfQoKZnVuY3Rpb24gZ2V0VHJpcGxpY2F0ZUdyb3VwKHdlbGxJZCwgY29sdW1uKSB7CiAgLy8gQ29udHJvbCB3ZWxscyBzaG91bGQgbmV2ZXIgYmUgcGFydCBvZiB0cmlwbGljYXRlIGdyb3VwcwogIGlmIChpc0NvbnRyb2xXZWxsKHdlbGxJZCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICAKICBjb25zdCBjb25maWcgPSB2aWV3ZXJEYXRhLmNvbmZpZyB8fCB7fTsKICBjb25zdCB0cmlwbGljYXRlR3JvdXBzID0gY29uZmlnLnRyaXBsaWNhdGVfZ3JvdXBzIHx8IFtdOwogIGNvbnN0IHJvd0xldHRlciA9IGdldFJvd0xldHRlcih3ZWxsSWQpOwogIAogIC8vIEZpbmQgZ3JvdXAgdGhhdCBtYXRjaGVzIHRoZSByb3cgcGF0dGVybiAoQkNELCBFRkcsIGV0Yy4pIC0gYXBwbGllcyB0byBhbGwgY29sdW1ucwogIHJldHVybiB0cmlwbGljYXRlR3JvdXBzLmZpbmQoZ3JvdXAgPT4gewogICAgaWYgKCFncm91cC53ZWxscyB8fCBncm91cC53ZWxscy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgCiAgICAvLyBFeHRyYWN0IHJvdyBsZXR0ZXJzIGZyb20gdGhlIGdyb3VwJ3Mgd2VsbHMKICAgIGNvbnN0IGdyb3VwUm93TGV0dGVycyA9IGdldFJvd0xldHRlcnNGcm9tV2VsbHMoZ3JvdXAud2VsbHMpOwogICAgCiAgICAvLyBDaGVjayBpZiB0aGlzIHdlbGwncyByb3cgbGV0dGVyIG1hdGNoZXMgYW55IHJvdyBpbiB0aGUgZ3JvdXAgcGF0dGVybgogICAgLy8gR3JvdXBzIGFwcGx5IHRvIGFsbCBjb2x1bW5zLCBzbyBubyBjb2x1bW4gY2hlY2sgbmVlZGVkCiAgICByZXR1cm4gZ3JvdXBSb3dMZXR0ZXJzLmluY2x1ZGVzKHJvd0xldHRlcik7CiAgfSk7Cn0KCmZ1bmN0aW9uIGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKSB7CiAgLy8gRXh0cmFjdCBjb2x1bW4gbnVtYmVyIGZyb20gd2VsbCBJRCAoZS5nLiwgIkIxMyIgLT4gMTMpCiAgcmV0dXJuIHBhcnNlSW50KHdlbGxJZC5yZXBsYWNlKC9bQS1aXS9nLCAnJykpOwp9CgpmdW5jdGlvbiBnZXRSb3dMZXR0ZXJzRnJvbVdlbGxzKHdlbGxzKSB7CiAgLy8gRXh0cmFjdCByb3cgbGV0dGVycyBmcm9tIHdlbGxzIGFycmF5CiAgLy8gV2VsbHMgY2FuIGJlIGVpdGhlciByb3cgbGV0dGVycyAoZS5nLiwgWyJCIiwgIkMiLCAiRCJdKSBvciBmdWxsIHdlbGwgSURzIChlLmcuLCBbIkIxMyIsICJDMTMiLCAiRDEzIl0pCiAgcmV0dXJuIHdlbGxzLm1hcCh3ID0+IHsKICAgIC8vIElmIGl0J3MgYSBmdWxsIHdlbGwgSUQsIGV4dHJhY3Qgcm93IGxldHRlcjsgb3RoZXJ3aXNlIGFzc3VtZSBpdCdzIGFscmVhZHkgYSByb3cgbGV0dGVyCiAgICBpZiAody5sZW5ndGggPiAxICYmIC9eW0EtWl0vLnRlc3QodykgJiYgL1swLTldLy50ZXN0KHcpKSB7CiAgICAgIHJldHVybiBnZXRSb3dMZXR0ZXIodyk7CiAgICB9CiAgICByZXR1cm4gdzsgLy8gQWxyZWFkeSBhIHJvdyBsZXR0ZXIKICB9KTsKfQoKLy8gQ29sb3IgcGFsZXR0ZSBmb3IgdHJpcGxpY2F0ZSBncm91cHMgLSBlYWNoIGdyb3VwIGdldHMgYSBkaXN0aW5jdCBjb2xvcgpjb25zdCBUUklQTElDQVRFX0NPTE9SUyA9IFsKICB7IGJvcmRlcjogIiNmZjZiNmIiLCBiZzogIiNmZmUwZTAiLCBiZ1NlbGVjdGVkOiAiI2ZmY2NjYyIsIGJnSGFzRGF0YTogIiNmZmU4ZTgiIH0sIC8vIFJlZAogIHsgYm9yZGVyOiAiIzRlY2RjNCIsIGJnOiAiI2UwZjdmNSIsIGJnU2VsZWN0ZWQ6ICIjY2NmMGVkIiwgYmdIYXNEYXRhOiAiI2U4ZjlmNyIgfSwgLy8gVGVhbAogIHsgYm9yZGVyOiAiIzQ1YjdkMSIsIGJnOiAiI2UwZjJmNyIsIGJnU2VsZWN0ZWQ6ICIjY2NlOGYwIiwgYmdIYXNEYXRhOiAiI2U4ZjVmYSIgfSwgLy8gQmx1ZQogIHsgYm9yZGVyOiAiI2Y5Y2EyNCIsIGJnOiAiI2ZmZjllMCIsIGJnU2VsZWN0ZWQ6ICIjZmZmM2NjIiwgYmdIYXNEYXRhOiAiI2ZmZmJlOCIgfSwgLy8gWWVsbG93CiAgeyBib3JkZXI6ICIjNmM1Y2U3IiwgYmc6ICIjZWRlYWY3IiwgYmdTZWxlY3RlZDogIiNkZGQ0ZjAiLCBiZ0hhc0RhdGE6ICIjZjBlY2Y5IiB9LCAvLyBQdXJwbGUKICB7IGJvcmRlcjogIiNhMjliZmUiLCBiZzogIiNlZGVhZjciLCBiZ1NlbGVjdGVkOiAiI2RkZDRmMCIsIGJnSGFzRGF0YTogIiNmMGVjZjkiIH0sIC8vIExpZ2h0IFB1cnBsZQogIHsgYm9yZGVyOiAiI2ZkNzlhOCIsIGJnOiAiI2ZmZTBlZCIsIGJnU2VsZWN0ZWQ6ICIjZmZjY2UwIiwgYmdIYXNEYXRhOiAiI2ZmZThmMCIgfSwgLy8gUGluawogIHsgYm9yZGVyOiAiIzAwYjg5NCIsIGJnOiAiI2UwZjVmMCIsIGJnU2VsZWN0ZWQ6ICIjY2NlZGU1IiwgYmdIYXNEYXRhOiAiI2U4ZjdmMiIgfSwgLy8gR3JlZW4KICB7IGJvcmRlcjogIiNlMTcwNTUiLCBiZzogIiNmZmUwZDkiLCBiZ1NlbGVjdGVkOiAiI2ZmY2NiYiIsIGJnSGFzRGF0YTogIiNmZmU4ZTAiIH0sIC8vIE9yYW5nZQogIHsgYm9yZGVyOiAiIzc0YjlmZiIsIGJnOiAiI2UwZjBmZiIsIGJnU2VsZWN0ZWQ6ICIjY2NlMGZmIiwgYmdIYXNEYXRhOiAiI2U4ZjVmZiIgfSwgLy8gTGlnaHQgQmx1ZQogIHsgYm9yZGVyOiAiIzU1ZWZjNCIsIGJnOiAiI2UwZmFmNSIsIGJnU2VsZWN0ZWQ6ICIjY2NmNWViIiwgYmdIYXNEYXRhOiAiI2U4ZmJmNyIgfSwgLy8gTWludAogIHsgYm9yZGVyOiAiI2ZkY2I2ZSIsIGJnOiAiI2ZmZjVlMCIsIGJnU2VsZWN0ZWQ6ICIjZmZlYmNjIiwgYmdIYXNEYXRhOiAiI2ZmZjhlOCIgfSAgLy8gTGlnaHQgT3JhbmdlCl07CgovLyBNYXAgdHJpcGxpY2F0ZSBncm91cCBuYW1lcyB0byBjb2xvcnMgKGNvbnNpc3RlbnQgYWNyb3NzIHRoZSBhcHApCmxldCB0cmlwbGljYXRlR3JvdXBDb2xvck1hcCA9IHt9OwoKZnVuY3Rpb24gZ2V0VHJpcGxpY2F0ZUdyb3VwQ29sb3IoZ3JvdXBOYW1lKSB7CiAgaWYgKCFncm91cE5hbWUpIHJldHVybiBudWxsOwogIAogIC8vIEVuc3VyZSBjb2xvciBtYXAgaXMgaW5pdGlhbGl6ZWQKICBpbml0aWFsaXplVHJpcGxpY2F0ZUdyb3VwQ29sb3JzKCk7CiAgCiAgLy8gTm9ybWFsaXplIGdyb3VwIG5hbWUgdG8gZW5zdXJlIGNvbnNpc3RlbnQgbG9va3VwCiAgY29uc3Qgbm9ybWFsaXplZE5hbWUgPSBTdHJpbmcoZ3JvdXBOYW1lKS50cmltKCk7CiAgCiAgLy8gUmV0dXJuIHRoZSBjb2xvciBmb3IgdGhpcyBncm91cCBuYW1lIChzYW1lIGNvbG9yIGZvciBhbGwgd2VsbHMgaW4gdGhlIGdyb3VwKQogIC8vIEFsbCB3ZWxscyB3aXRoIHRoZSBzYW1lIGdyb3VwIG5hbWUgd2lsbCBnZXQgdGhlIHNhbWUgY29sb3IKICAvLyBGb3IgZXhhbXBsZSwgYWxsIHdlbGxzIGluIHJvd3MgQiwgQywgRCB3aXRoIGdyb3VwICIyNTAtMTAtMiIgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgcmV0dXJuIHRyaXBsaWNhdGVHcm91cENvbG9yTWFwW25vcm1hbGl6ZWROYW1lXSB8fCBUUklQTElDQVRFX0NPTE9SU1swXTsKfQoKZnVuY3Rpb24gaXNEdXBsaWNhdGVXZWxsKHdlbGxJZCkgewogIC8vIENoZWNrIGlmIHRoaXMgd2VsbCBJRCBpcyBpbiB0aGUgZHVwbGljYXRlIHdhcm5pbmdzCiAgaWYgKCF2aWV3ZXJEYXRhIHx8ICF2aWV3ZXJEYXRhLmNvbmZpZyB8fCAhdmlld2VyRGF0YS5jb25maWcud2FybmluZ3MpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgY29uc3Qgd2FybmluZ3MgPSB2aWV3ZXJEYXRhLmNvbmZpZy53YXJuaW5ncy5kdXBsaWNhdGVfY29sdW1ucyB8fCBbXTsKICByZXR1cm4gd2FybmluZ3Muc29tZSh3YXJuaW5nID0+IHsKICAgIGNvbnN0IHdlbGxJZHMgPSB3YXJuaW5nLndlbGxfaWRzIHx8IFtdOwogICAgcmV0dXJuIHdlbGxJZHMuaW5jbHVkZXMod2VsbElkKTsKICB9KTsKfQoKZnVuY3Rpb24gZ2V0RHVwbGljYXRlRmlsZXMod2VsbElkKSB7CiAgLy8gR2V0IHRoZSBsaXN0IG9mIGZpbGVzIHRoYXQgaGF2ZSB0aGlzIGR1cGxpY2F0ZSB3ZWxsCiAgaWYgKCF2aWV3ZXJEYXRhIHx8ICF2aWV3ZXJEYXRhLmNvbmZpZyB8fCAhdmlld2VyRGF0YS5jb25maWcud2FybmluZ3MpIHsKICAgIHJldHVybiBbXTsKICB9CiAgY29uc3Qgd2FybmluZ3MgPSB2aWV3ZXJEYXRhLmNvbmZpZy53YXJuaW5ncy5kdXBsaWNhdGVfY29sdW1ucyB8fCBbXTsKICBmb3IgKGNvbnN0IHdhcm5pbmcgb2Ygd2FybmluZ3MpIHsKICAgIGNvbnN0IHdlbGxJZHMgPSB3YXJuaW5nLndlbGxfaWRzIHx8IFtdOwogICAgaWYgKHdlbGxJZHMuaW5jbHVkZXMod2VsbElkKSkgewogICAgICByZXR1cm4gd2FybmluZy5maWxlcyB8fCBbXTsKICAgIH0KICB9CiAgcmV0dXJuIFtdOwp9CgpmdW5jdGlvbiBnZXRBbGxVbmlxdWVUaW1lUG9pbnRzKHdlbGxzKSB7CiAgLy8gQ29sbGVjdCBhbGwgdW5pcXVlIHRpbWUgcG9pbnRzIGZyb20gYWxsIHdlbGxzCiAgY29uc3QgYWxsVGltZVBvaW50cyA9IG5ldyBTZXQoKTsKICB3ZWxscy5mb3JFYWNoKHdlbGwgPT4gewogICAgaWYgKHdlbGwudGltZV9zKSB7CiAgICAgIHdlbGwudGltZV9zLmZvckVhY2godCA9PiB7CiAgICAgICAgaWYgKHQgIT09IG51bGwgJiYgdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBhbGxUaW1lUG9pbnRzLmFkZCh0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0pOwogIHJldHVybiBBcnJheS5mcm9tKGFsbFRpbWVQb2ludHMpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKfQoKZnVuY3Rpb24gY2FsY3VsYXRlTWVhbkFuZEVycm9yKHdlbGxzLCB0aW1lUG9pbnRzKSB7CiAgLy8gQ2FsY3VsYXRlIG1lYW4gYW5kIHN0YW5kYXJkIGVycm9yIGZvciB0cmlwbGljYXRlcyBhdCBlYWNoIHRpbWUgcG9pbnQKICBjb25zdCBtZWFucyA9IFtdOwogIGNvbnN0IGVycm9ycyA9IFtdOwogIAogIHRpbWVQb2ludHMuZm9yRWFjaCgodGltZSwgaWR4KSA9PiB7CiAgICBjb25zdCB2YWx1ZXMgPSB3ZWxscy5tYXAodyA9PiB7CiAgICAgIGNvbnN0IHRpbWVJZHggPSB3LnRpbWVfcy5pbmRleE9mKHRpbWUpOwogICAgICByZXR1cm4gdGltZUlkeCA+PSAwID8gdy52YWx1ZXNbdGltZUlkeF0gOiBudWxsOwogICAgfSkuZmlsdGVyKHYgPT4gdiAhPT0gbnVsbCk7CiAgICAKICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIG1lYW5zLnB1c2gobnVsbCk7CiAgICAgIGVycm9ycy5wdXNoKG51bGwpOwogICAgICByZXR1cm47CiAgICB9CiAgICAKICAgIGNvbnN0IG1lYW4gPSB2YWx1ZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyB2YWx1ZXMubGVuZ3RoOwogICAgLy8gVXNlIHNhbXBsZSB2YXJpYW5jZSAoZGl2aWRlIGJ5IG4tMSkgZm9yIHByb3BlciBTRU0gY2FsY3VsYXRpb24KICAgIGNvbnN0IG4gPSB2YWx1ZXMubGVuZ3RoOwogICAgY29uc3QgdmFyaWFuY2UgPSBuID4gMSAKICAgICAgPyB2YWx1ZXMucmVkdWNlKChzdW0sIHZhbCkgPT4gc3VtICsgTWF0aC5wb3codmFsIC0gbWVhbiwgMiksIDApIC8gKG4gLSAxKQogICAgICA6IDA7CiAgICBjb25zdCBzdGREZXYgPSBNYXRoLnNxcnQodmFyaWFuY2UpOwogICAgY29uc3Qgc3RkRXJyb3IgPSBzdGREZXYgLyBNYXRoLnNxcnQobik7CiAgICAKICAgIG1lYW5zLnB1c2gobWVhbik7CiAgICBlcnJvcnMucHVzaChzdGRFcnJvcik7CiAgfSk7CiAgCiAgcmV0dXJuIHsgbWVhbnMsIGVycm9ycyB9Owp9CgpmdW5jdGlvbiBwcm9jZXNzV2VsbHNBbmRDYWxjdWxhdGVNZWFuKHdlbGxzLCBpc05vcm1hbGl6ZWQgPSBmYWxzZSwgYmFzZWxpbmVFbmRUaW1lID0gMjQsIGN1dG9mZlRpbWUgPSAzNjApIHsKICAvLyBXT1JLRkxPVzogQWx3YXlzIHByb2Nlc3MgZWFjaCB3ZWxsIGluZGl2aWR1YWxseSBmaXJzdCwgdGhlbiBhdmVyYWdlCiAgLy8gSWYgbm9ybWFsaXplZDogbm9ybWFsaXplIGVhY2ggd2VsbCB0byBpdHMgT1dOIGJhc2VsaW5lIGZpcnN0LCB0aGVuIGNhbGN1bGF0ZSBtZWFuIGFuZCBlcnJvcgogIC8vIElmIG5vdCBub3JtYWxpemVkOiBwcm9jZXNzIGVhY2ggd2VsbCBpbmRpdmlkdWFsbHkgKG5vIG5vcm1hbGl6YXRpb24pLCB0aGVuIGNhbGN1bGF0ZSBtZWFuIGFuZCBlcnJvcgogIC8vIFRoaXMgZW5zdXJlcyBjb3JyZWN0IG5vcm1hbGl6YXRpb24gZXZlbiB3aGVuIGNvbWJpbmluZyB3ZWxscyBmcm9tIGRpZmZlcmVudCBjb2x1bW5zIHdpdGggZGlmZmVyZW50IGJhc2VsaW5lcwogIC8vIFJldHVybnMgeyBmaWx0ZXJlZFRpbWVQb2ludHMsIG1lYW5zLCBlcnJvcnMsIG9yaWdpbmFsTWVhbnMgfQogIAogIC8vIFN0ZXAgMTogUHJvY2VzcyBlYWNoIHdlbGwgaW5kaXZpZHVhbGx5IChub3JtYWxpemUgaWYgZW5hYmxlZCwgb3RoZXJ3aXNlIHVzZSByYXcgZGF0YSkKICBjb25zdCBwcm9jZXNzZWRXZWxscyA9IHdlbGxzLm1hcCh3ZWxsID0+IHsKICAgIGNvbnN0IGZpbHRlcmVkVGltZVBvaW50cyA9IFtdOwogICAgY29uc3QgcHJvY2Vzc2VkVmFsdWVzID0gW107CiAgICBjb25zdCBvcmlnaW5hbFZhbHVlcyA9IFtdOwogICAgCiAgICBpZiAoIXdlbGwudGltZV9zIHx8ICF3ZWxsLnZhbHVlcykgewogICAgICByZXR1cm4geyB0aW1lUG9pbnRzOiBbXSwgdmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgICB9CiAgICAKICAgIGlmIChpc05vcm1hbGl6ZWQpIHsKICAgICAgLy8gTm9ybWFsaXplIHRoaXMgd2VsbCBieSBpdHMgb3duIGJhc2VsaW5lCiAgICAgIGNvbnN0IGJhc2VsaW5lVmFsdWVzID0gW107CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbC50aW1lX3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB0aW1lID0gd2VsbC50aW1lX3NbaV07CiAgICAgICAgY29uc3QgdmFsID0gd2VsbC52YWx1ZXNbaV07CiAgICAgICAgaWYgKHRpbWUgIT09IG51bGwgJiYgdmFsICE9PSBudWxsICYmIHRpbWUgPD0gYmFzZWxpbmVFbmRUaW1lKSB7CiAgICAgICAgICBiYXNlbGluZVZhbHVlcy5wdXNoKHZhbCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIAogICAgICBpZiAoYmFzZWxpbmVWYWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgLy8gTm8gYmFzZWxpbmUgZGF0YSBmb3IgdGhpcyB3ZWxsLCBza2lwIGl0CiAgICAgICAgcmV0dXJuIHsgdGltZVBvaW50czogW10sIHZhbHVlczogW10sIG9yaWdpbmFsVmFsdWVzOiBbXSB9OwogICAgICB9CiAgICAgIAogICAgICBjb25zdCB3ZWxsQmFzZWxpbmUgPSBiYXNlbGluZVZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIGJhc2VsaW5lVmFsdWVzLmxlbmd0aDsKICAgICAgCiAgICAgIGlmICh3ZWxsQmFzZWxpbmUgPT09IDAgfHwgIWlzRmluaXRlKHdlbGxCYXNlbGluZSkpIHsKICAgICAgICAvLyBJbnZhbGlkIGJhc2VsaW5lIGZvciB0aGlzIHdlbGwsIHNraXAgaXQKICAgICAgICByZXR1cm4geyB0aW1lUG9pbnRzOiBbXSwgdmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgICAgIH0KICAgICAgCiAgICAgIC8vIE5vcm1hbGl6ZSBhbmQgZmlsdGVyOiBvbmx5IGluY2x1ZGUgcG9pbnRzIGFmdGVyIGJhc2VsaW5lRW5kVGltZSBhbmQgdXAgdG8gY3V0b2ZmVGltZQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdlbGwudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgdGltZSA9IHdlbGwudGltZV9zW2ldOwogICAgICAgIGNvbnN0IHZhbCA9IHdlbGwudmFsdWVzW2ldOwogICAgICAgIAogICAgICAgIGlmICh0aW1lID09PSBudWxsIHx8IHZhbCA9PT0gbnVsbCkgY29udGludWU7CiAgICAgICAgCiAgICAgICAgLy8gT25seSBpbmNsdWRlIHBvaW50cyBhZnRlciBiYXNlbGluZUVuZFRpbWUgYW5kIHVwIHRvIGN1dG9mZlRpbWUKICAgICAgICBpZiAodGltZSA+IGJhc2VsaW5lRW5kVGltZSAmJiB0aW1lIDw9IGN1dG9mZlRpbWUpIHsKICAgICAgICAgIC8vIFN1YnRyYWN0IGJhc2VsaW5lRW5kVGltZSB0byBicmluZyBmaXJzdCBwb2ludCB0byB4PTAgKHRpbWUgYWZ0ZXIgaW5qZWN0aW9uKQogICAgICAgICAgZmlsdGVyZWRUaW1lUG9pbnRzLnB1c2godGltZSAtIGJhc2VsaW5lRW5kVGltZSk7CiAgICAgICAgICAvLyBEaXZpZGUgYnkgdGhpcyB3ZWxsJ3Mgb3duIGJhc2VsaW5lCiAgICAgICAgICBwcm9jZXNzZWRWYWx1ZXMucHVzaCh2YWwgLyB3ZWxsQmFzZWxpbmUpOwogICAgICAgICAgb3JpZ2luYWxWYWx1ZXMucHVzaCh2YWwpOyAvLyBTdG9yZSBvcmlnaW5hbCB2YWx1ZQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gTm90IG5vcm1hbGl6ZWQ6IHVzZSBhbGwgcmF3IGRhdGEgcG9pbnRzCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbC50aW1lX3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB0aW1lID0gd2VsbC50aW1lX3NbaV07CiAgICAgICAgY29uc3QgdmFsID0gd2VsbC52YWx1ZXNbaV07CiAgICAgICAgCiAgICAgICAgaWYgKHRpbWUgPT09IG51bGwgfHwgdmFsID09PSBudWxsKSBjb250aW51ZTsKICAgICAgICAKICAgICAgICBmaWx0ZXJlZFRpbWVQb2ludHMucHVzaCh0aW1lKTsKICAgICAgICBwcm9jZXNzZWRWYWx1ZXMucHVzaCh2YWwpOwogICAgICAgIG9yaWdpbmFsVmFsdWVzLnB1c2godmFsKTsgLy8gU3RvcmUgb3JpZ2luYWwgdmFsdWUgKHNhbWUgYXMgcHJvY2Vzc2VkIHdoZW4gbm90IG5vcm1hbGl6ZWQpCiAgICAgIH0KICAgIH0KICAgIAogICAgcmV0dXJuIHsgdGltZVBvaW50czogZmlsdGVyZWRUaW1lUG9pbnRzLCB2YWx1ZXM6IHByb2Nlc3NlZFZhbHVlcywgb3JpZ2luYWxWYWx1ZXM6IG9yaWdpbmFsVmFsdWVzIH07CiAgfSkuZmlsdGVyKHdlbGwgPT4gd2VsbC50aW1lUG9pbnRzLmxlbmd0aCA+IDApOyAvLyBGaWx0ZXIgb3V0IHdlbGxzIHdpdGggbm8gZGF0YQogIAogIC8vIFN0ZXAgMjogRmluZCBhbGwgdW5pcXVlIHRpbWUgcG9pbnRzIGFjcm9zcyBhbGwgcHJvY2Vzc2VkIHdlbGxzCiAgY29uc3QgYWxsVGltZVBvaW50cyA9IG5ldyBTZXQoKTsKICBwcm9jZXNzZWRXZWxscy5mb3JFYWNoKHdlbGwgPT4gewogICAgd2VsbC50aW1lUG9pbnRzLmZvckVhY2godCA9PiB7CiAgICAgIGlmICh0ICE9PSBudWxsKSBhbGxUaW1lUG9pbnRzLmFkZCh0KTsKICAgIH0pOwogIH0pOwogIAogIGNvbnN0IHNvcnRlZFRpbWVQb2ludHMgPSBBcnJheS5mcm9tKGFsbFRpbWVQb2ludHMpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKICAKICAvLyBTdGVwIDM6IENhbGN1bGF0ZSBtZWFuIGFuZCBlcnJvciBhdCBlYWNoIHRpbWUgcG9pbnQgZnJvbSBwcm9jZXNzZWQgdmFsdWVzCiAgLy8gQWxzbyB0cmFjayBvcmlnaW5hbCB2YWx1ZXMgZm9yIHRvb2x0aXAgZGlzcGxheQogIGNvbnN0IG1lYW5zID0gW107CiAgY29uc3QgZXJyb3JzID0gW107CiAgY29uc3Qgb3JpZ2luYWxNZWFucyA9IFtdOwogIAogIHNvcnRlZFRpbWVQb2ludHMuZm9yRWFjaCh0aW1lID0+IHsKICAgIGNvbnN0IHZhbHVlcyA9IFtdOwogICAgY29uc3Qgb3JpZ1ZhbHVlcyA9IFtdOwogICAgcHJvY2Vzc2VkV2VsbHMuZm9yRWFjaCh3ZWxsID0+IHsKICAgICAgY29uc3QgdGltZUlkeCA9IHdlbGwudGltZVBvaW50cy5pbmRleE9mKHRpbWUpOwogICAgICBpZiAodGltZUlkeCA+PSAwICYmIHdlbGwudmFsdWVzW3RpbWVJZHhdICE9PSBudWxsKSB7CiAgICAgICAgdmFsdWVzLnB1c2god2VsbC52YWx1ZXNbdGltZUlkeF0pOwogICAgICAgIGlmICh3ZWxsLm9yaWdpbmFsVmFsdWVzICYmIHdlbGwub3JpZ2luYWxWYWx1ZXNbdGltZUlkeF0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgb3JpZ1ZhbHVlcy5wdXNoKHdlbGwub3JpZ2luYWxWYWx1ZXNbdGltZUlkeF0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICAKICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIG1lYW5zLnB1c2gobnVsbCk7CiAgICAgIGVycm9ycy5wdXNoKG51bGwpOwogICAgICBvcmlnaW5hbE1lYW5zLnB1c2gobnVsbCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIAogICAgY29uc3QgbWVhbiA9IHZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIHZhbHVlcy5sZW5ndGg7CiAgICAvLyBVc2Ugc2FtcGxlIHZhcmlhbmNlIChkaXZpZGUgYnkgbi0xKSBmb3IgcHJvcGVyIFNFTSBjYWxjdWxhdGlvbgogICAgY29uc3QgbiA9IHZhbHVlcy5sZW5ndGg7CiAgICBjb25zdCB2YXJpYW5jZSA9IG4gPiAxIAogICAgICA/IHZhbHVlcy5yZWR1Y2UoKHN1bSwgdmFsKSA9PiBzdW0gKyBNYXRoLnBvdyh2YWwgLSBtZWFuLCAyKSwgMCkgLyAobiAtIDEpCiAgICAgIDogMDsKICAgIGNvbnN0IHN0ZERldiA9IE1hdGguc3FydCh2YXJpYW5jZSk7CiAgICBjb25zdCBzdGRFcnJvciA9IHN0ZERldiAvIE1hdGguc3FydChuKTsKICAgIAogICAgbWVhbnMucHVzaChtZWFuKTsKICAgIGVycm9ycy5wdXNoKHN0ZEVycm9yKTsKICAgIAogICAgLy8gQ2FsY3VsYXRlIG1lYW4gb2Ygb3JpZ2luYWwgdmFsdWVzCiAgICBpZiAob3JpZ1ZhbHVlcy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG9yaWdNZWFuID0gb3JpZ1ZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIG9yaWdWYWx1ZXMubGVuZ3RoOwogICAgICBvcmlnaW5hbE1lYW5zLnB1c2gob3JpZ01lYW4pOwogICAgfSBlbHNlIHsKICAgICAgb3JpZ2luYWxNZWFucy5wdXNoKG51bGwpOwogICAgfQogIH0pOwogIAogIHJldHVybiB7IGZpbHRlcmVkVGltZVBvaW50czogc29ydGVkVGltZVBvaW50cywgbm9ybWFsaXplZE1lYW5zOiBtZWFucywgbm9ybWFsaXplZEVycm9yczogZXJyb3JzLCBvcmlnaW5hbE1lYW5zOiBvcmlnaW5hbE1lYW5zIH07Cn0KCi8vIEtlZXAgb2xkIGZ1bmN0aW9uIG5hbWUgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCBidXQgaXQgbm93IHVzZXMgdGhlIHVuaWZpZWQgd29ya2Zsb3cKZnVuY3Rpb24gY2FsY3VsYXRlTWVhbkFuZEVycm9yRnJvbU5vcm1hbGl6ZWQod2VsbHMsIGJhc2VsaW5lRW5kVGltZSA9IDI0LCBjdXRvZmZUaW1lID0gMzYwKSB7CiAgcmV0dXJuIHByb2Nlc3NXZWxsc0FuZENhbGN1bGF0ZU1lYW4od2VsbHMsIHRydWUsIGJhc2VsaW5lRW5kVGltZSwgY3V0b2ZmVGltZSk7Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZURhdGEodGltZVBvaW50cywgdmFsdWVzLCBiYXNlbGluZUVuZFRpbWUgPSAyNCwgY3V0b2ZmVGltZSA9IDM2MCkgewogIC8vIE5vcm1hbGl6ZSBkYXRhOiBjYWxjdWxhdGUgYmFzZWxpbmUgZnJvbSAwLWJhc2VsaW5lRW5kVGltZSwgdGhlbiBwbG90IG9ubHkgcG9pbnRzIGFmdGVyIGJhc2VsaW5lRW5kVGltZQogIC8vIGRpdmlkZWQgYnkgYmFzZWxpbmUsIHVwIHRvIGN1dG9mZlRpbWUuIEJhc2VsaW5lIHBlcmlvZCBpcyBOT1QgaW5jbHVkZWQgaW4gdGhlIHBsb3QuCiAgLy8gUmV0dXJucyB7IGZpbHRlcmVkVGltZVBvaW50cywgbm9ybWFsaXplZFZhbHVlcywgb3JpZ2luYWxWYWx1ZXMgfSAtIGZpbHRlcmVkIGFycmF5cwogIGlmICghdGltZVBvaW50cyB8fCAhdmFsdWVzIHx8IHRpbWVQb2ludHMubGVuZ3RoICE9PSB2YWx1ZXMubGVuZ3RoKSB7CiAgICAvLyBJZiBpbnZhbGlkIGlucHV0LCByZXR1cm4gZW1wdHkgZmlsdGVyZWQgYXJyYXlzCiAgICByZXR1cm4geyBmaWx0ZXJlZFRpbWVQb2ludHM6IFtdLCBub3JtYWxpemVkVmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgfQogIAogIC8vIEZpbmQgYmFzZWxpbmU6IGF2ZXJhZ2Ugb2YgYWxsIHZhbHVlcyB3aGVyZSB0aW1lIDw9IGJhc2VsaW5lRW5kVGltZQogIGNvbnN0IGJhc2VsaW5lVmFsdWVzID0gW107CiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aW1lUG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAodGltZVBvaW50c1tpXSAhPT0gbnVsbCAmJiB2YWx1ZXNbaV0gIT09IG51bGwgJiYgdGltZVBvaW50c1tpXSA8PSBiYXNlbGluZUVuZFRpbWUpIHsKICAgICAgYmFzZWxpbmVWYWx1ZXMucHVzaCh2YWx1ZXNbaV0pOwogICAgfQogIH0KICAKICBpZiAoYmFzZWxpbmVWYWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAvLyBObyBiYXNlbGluZSBkYXRhIGZvdW5kLCByZXR1cm4gZW1wdHkgZmlsdGVyZWQgYXJyYXlzIChjYW4ndCBub3JtYWxpemUgd2l0aG91dCBiYXNlbGluZSkKICAgIHJldHVybiB7IGZpbHRlcmVkVGltZVBvaW50czogW10sIG5vcm1hbGl6ZWRWYWx1ZXM6IFtdLCBvcmlnaW5hbFZhbHVlczogW10gfTsKICB9CiAgCiAgY29uc3QgYmFzZWxpbmUgPSBiYXNlbGluZVZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIGJhc2VsaW5lVmFsdWVzLmxlbmd0aDsKICAKICBpZiAoYmFzZWxpbmUgPT09IDAgfHwgIWlzRmluaXRlKGJhc2VsaW5lKSkgewogICAgLy8gQXZvaWQgZGl2aXNpb24gYnkgemVybyBvciBpbnZhbGlkIGJhc2VsaW5lCiAgICByZXR1cm4geyBmaWx0ZXJlZFRpbWVQb2ludHM6IFtdLCBub3JtYWxpemVkVmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgfQogIAogIC8vIEZpbHRlciBhbmQgbm9ybWFsaXplOiBvbmx5IGluY2x1ZGUgcG9pbnRzIHdoZXJlIGJhc2VsaW5lRW5kVGltZSA8IHRpbWUgPD0gY3V0b2ZmVGltZQogIC8vIEVWRVJZIHBvaW50IGFmdGVyIGJhc2VsaW5lRW5kVGltZSBpcyBkaXZpZGVkIGJ5IHRoZSBTQU1FIGJhc2VsaW5lIGF2ZXJhZ2UKICBjb25zdCBmaWx0ZXJlZFRpbWVQb2ludHMgPSBbXTsKICBjb25zdCBub3JtYWxpemVkVmFsdWVzID0gW107CiAgY29uc3Qgb3JpZ2luYWxWYWx1ZXMgPSBbXTsKICAKICBmb3IgKGxldCBpID0gMDsgaSA8IHRpbWVQb2ludHMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHRpbWUgPSB0aW1lUG9pbnRzW2ldOwogICAgY29uc3QgdmFsID0gdmFsdWVzW2ldOwogICAgCiAgICBpZiAodGltZSA9PT0gbnVsbCB8fCB2YWwgPT09IG51bGwpIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICAKICAgIC8vIE9ubHkgaW5jbHVkZSBwb2ludHMgYWZ0ZXIgYmFzZWxpbmVFbmRUaW1lIGFuZCB1cCB0byBjdXRvZmZUaW1lIChiYXNlbGluZSBOT1QgaW5jbHVkZWQpCiAgICBpZiAodGltZSA+IGJhc2VsaW5lRW5kVGltZSAmJiB0aW1lIDw9IGN1dG9mZlRpbWUpIHsKICAgICAgLy8gU3VidHJhY3QgYmFzZWxpbmVFbmRUaW1lIHRvIGJyaW5nIGZpcnN0IHBvaW50IHRvIHg9MCAodGltZSBhZnRlciBpbmplY3Rpb24pCiAgICAgIGZpbHRlcmVkVGltZVBvaW50cy5wdXNoKHRpbWUgLSBiYXNlbGluZUVuZFRpbWUpOwogICAgICAvLyBEaXZpZGUgRVZFUlkgdGltZSBwb2ludCBieSB0aGUgU0FNRSBiYXNlbGluZSBhdmVyYWdlCiAgICAgIG5vcm1hbGl6ZWRWYWx1ZXMucHVzaCh2YWwgLyBiYXNlbGluZSk7CiAgICAgIG9yaWdpbmFsVmFsdWVzLnB1c2godmFsKTsgLy8gU3RvcmUgb3JpZ2luYWwgdmFsdWUgZm9yIHRvb2x0aXAKICAgIH0KICB9CiAgCiAgcmV0dXJuIHsgZmlsdGVyZWRUaW1lUG9pbnRzLCBub3JtYWxpemVkVmFsdWVzLCBvcmlnaW5hbFZhbHVlcyB9Owp9CgovLyBGaXQgYmFzZWxpbmUgZnVuY3Rpb24gdXNpbmcgc3BlY2lmaWVkIG1ldGhvZApmdW5jdGlvbiBmaXRCYXNlbGluZUZ1bmN0aW9uKHRpbWVQb2ludHMsIHZhbHVlcywgbWV0aG9kID0gJ2xvd2VzcycsIGZyYWMgPSAwLjUsIHBvbHlPcmRlciA9IDEpIHsKICAvLyBFeHRyYWN0IGJhc2VsaW5lIHdpbmRvdyAodGltZSA8PSBiYXNlbGluZUVuZFRpbWUgd2lsbCBiZSBoYW5kbGVkIGJ5IGNhbGxlcikKICAvLyBUaGlzIGZ1bmN0aW9uIGZpdHMgb24gdGhlIHByb3ZpZGVkIHBvaW50cyBhbmQgcmV0dXJucyBhIGZ1bmN0aW9uIGcodCkgdGhhdCBjYW4gYmUgZXZhbHVhdGVkIGF0IGFueSB0aW1lCiAgCiAgaWYgKCF0aW1lUG9pbnRzIHx8ICF2YWx1ZXMgfHwgdGltZVBvaW50cy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBudWxsOwogIH0KICAKICAvLyBGaWx0ZXIgb3V0IE5hTiB2YWx1ZXMKICBjb25zdCB2YWxpZERhdGEgPSBbXTsKICBmb3IgKGxldCBpID0gMDsgaSA8IHRpbWVQb2ludHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICh0aW1lUG9pbnRzW2ldICE9PSBudWxsICYmIHZhbHVlc1tpXSAhPT0gbnVsbCAmJiAhaXNOYU4odGltZVBvaW50c1tpXSkgJiYgIWlzTmFOKHZhbHVlc1tpXSkpIHsKICAgICAgdmFsaWREYXRhLnB1c2goeyB0OiB0aW1lUG9pbnRzW2ldLCB2OiB2YWx1ZXNbaV0gfSk7CiAgICB9CiAgfQogIAogIGlmICh2YWxpZERhdGEubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgdmFsaWREYXRhLnNvcnQoKGEsIGIpID0+IGEudCAtIGIudCk7CiAgY29uc3QgdGltZXMgPSB2YWxpZERhdGEubWFwKGQgPT4gZC50KTsKICBjb25zdCB2YWxzID0gdmFsaWREYXRhLm1hcChkID0+IGQudik7CiAgCiAgaWYgKG1ldGhvZCA9PT0gJ2NvbnN0YW50JykgewogICAgLy8gQ29uc3RhbnQgYmFzZWxpbmU6IGcodCkgPSBtZWFuKEZfYmFzZWxpbmUpCiAgICBjb25zdCBiYXNlbGluZVZhbHVlID0gdmFscy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIHZhbHMubGVuZ3RoOwogICAgcmV0dXJuICh0KSA9PiBiYXNlbGluZVZhbHVlOwogIH0gZWxzZSBpZiAobWV0aG9kID09PSAncG9seW5vbWlhbCcpIHsKICAgIC8vIFBvbHlub21pYWwgZml0OiBnKHQpID0gY+KCgCArIGPigoF0ICsgY+KCgnTCsiArIC4uLgogICAgLy8gU2ltcGxlIHBvbHlub21pYWwgcmVncmVzc2lvbgogICAgY29uc3QgbiA9IHRpbWVzLmxlbmd0aDsKICAgIGNvbnN0IFggPSBbXTsKICAgIGNvbnN0IHkgPSB2YWxzOwogICAgCiAgICAvLyBCdWlsZCBkZXNpZ24gbWF0cml4CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCByb3cgPSBbXTsKICAgICAgZm9yIChsZXQgcCA9IHBvbHlPcmRlcjsgcCA+PSAwOyBwLS0pIHsKICAgICAgICByb3cucHVzaChNYXRoLnBvdyh0aW1lc1tpXSwgcCkpOwogICAgICB9CiAgICAgIFgucHVzaChyb3cpOwogICAgfQogICAgCiAgICAvLyBTb2x2ZSB1c2luZyBub3JtYWwgZXF1YXRpb25zOiAoWCdYKV4oLTEpWCd5CiAgICAvLyBTaW1wbGlmaWVkIGZvciBzbWFsbCBvcmRlcnMKICAgIGxldCBjb2VmZnM7CiAgICBpZiAocG9seU9yZGVyID09PSAxKSB7CiAgICAgIC8vIExpbmVhcjogeSA9IGEgKyBiKnQKICAgICAgY29uc3Qgc3VtVCA9IHRpbWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgICBjb25zdCBzdW1UMiA9IHRpbWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIgKiBiLCAwKTsKICAgICAgY29uc3Qgc3VtWSA9IHkucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICAgIGNvbnN0IHN1bVRZID0gdGltZXMucmVkdWNlKChzdW0sIHQsIGkpID0+IHN1bSArIHQgKiB5W2ldLCAwKTsKICAgICAgY29uc3QgbiA9IHRpbWVzLmxlbmd0aDsKICAgICAgCiAgICAgIGNvbnN0IGRldCA9IG4gKiBzdW1UMiAtIHN1bVQgKiBzdW1UOwogICAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgICAgLy8gRmFsbGJhY2sgdG8gY29uc3RhbnQKICAgICAgICBjb25zdCBtZWFuID0gc3VtWSAvIG47CiAgICAgICAgcmV0dXJuICh0KSA9PiBtZWFuOwogICAgICB9CiAgICAgIAogICAgICBjb25zdCBhID0gKHN1bVkgKiBzdW1UMiAtIHN1bVQgKiBzdW1UWSkgLyBkZXQ7CiAgICAgIGNvbnN0IGIgPSAobiAqIHN1bVRZIC0gc3VtVCAqIHN1bVkpIC8gZGV0OwogICAgICBjb2VmZnMgPSBbYiwgYV07IC8vIFtjMSwgYzBdIGZvciBwb2x5MWQgZm9ybWF0CiAgICB9IGVsc2UgewogICAgICAvLyBIaWdoZXIgb3JkZXIgLSB1c2Ugc2ltcGxlIGxlYXN0IHNxdWFyZXMKICAgICAgLy8gRm9yIHNpbXBsaWNpdHksIHVzZSBhIGJhc2ljIGltcGxlbWVudGF0aW9uCiAgICAgIGNvbnN0IG1lYW5UID0gc3VtVCAvIG47CiAgICAgIGNvbnN0IG1lYW5ZID0gc3VtWSAvIG47CiAgICAgIC8vIEZhbGxiYWNrIHRvIGNvbnN0YW50IGZvciBub3cgaWYgb3JkZXIgPiAxCiAgICAgIGNvbnN0IG1lYW4gPSBtZWFuWTsKICAgICAgcmV0dXJuICh0KSA9PiBtZWFuOwogICAgfQogICAgCiAgICByZXR1cm4gKHQpID0+IHsKICAgICAgbGV0IHJlc3VsdCA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29lZmZzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVzdWx0ICs9IGNvZWZmc1tpXSAqIE1hdGgucG93KHQsIGNvZWZmcy5sZW5ndGggLSAxIC0gaSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfSBlbHNlIGlmIChtZXRob2QgPT09ICdsb3dlc3MnKSB7CiAgICAvLyBMT1dFU1Mgc21vb3RoaW5nIC0gc2ltcGxpZmllZCBpbXBsZW1lbnRhdGlvbgogICAgLy8gRm9yIGEgcHJvcGVyIExPV0VTUywgd2UnZCBuZWVkIGEgbGlicmFyeSwgYnV0IHdlIGNhbiBhcHByb3hpbWF0ZSB3aXRoIG1vdmluZyBhdmVyYWdlCiAgICAvLyBUaGlzIGlzIGEgc2ltcGxpZmllZCB2ZXJzaW9uIC0gZm9yIHByb2R1Y3Rpb24sIGNvbnNpZGVyIHVzaW5nIGEgbGlicmFyeSBsaWtlIHJlZ3Jlc3Npb24uanMKICAgIAogICAgLy8gVXNlIGEgc2ltcGxlIG1vdmluZyBhdmVyYWdlIHdpdGggd2VpZ2h0ZWQgd2luZG93IGFzIGFwcHJveGltYXRpb24KICAgIGNvbnN0IHdpbmRvd1NpemUgPSBNYXRoLm1heCgxLCBNYXRoLmZsb29yKGZyYWMgKiB0aW1lcy5sZW5ndGgpKTsKICAgIGNvbnN0IHNtb290aGVkID0gW107CiAgICAKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZXMubGVuZ3RoOyBpKyspIHsKICAgICAgbGV0IHN1bSA9IDA7CiAgICAgIGxldCB3ZWlnaHRTdW0gPSAwOwogICAgICBjb25zdCBjZW50ZXIgPSB0aW1lc1tpXTsKICAgICAgCiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGltZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5hYnModGltZXNbal0gLSBjZW50ZXIpOwogICAgICAgIGNvbnN0IG1heERpc3QgPSBNYXRoLm1heCguLi50aW1lcy5tYXAodCA9PiBNYXRoLmFicyh0IC0gY2VudGVyKSkpOwogICAgICAgIGNvbnN0IHdlaWdodCA9IGRpc3QgPCBtYXhEaXN0ICogZnJhYyA/IE1hdGgucG93KDEgLSAoZGlzdCAvIChtYXhEaXN0ICogZnJhYykpLCAzKSA6IDA7IC8vIFRyaWN1YmUgd2VpZ2h0CiAgICAgICAgCiAgICAgICAgc3VtICs9IHZhbHNbal0gKiB3ZWlnaHQ7CiAgICAgICAgd2VpZ2h0U3VtICs9IHdlaWdodDsKICAgICAgfQogICAgICAKICAgICAgc21vb3RoZWQucHVzaCh3ZWlnaHRTdW0gPiAwID8gc3VtIC8gd2VpZ2h0U3VtIDogdmFsc1tpXSk7CiAgICB9CiAgICAKICAgIC8vIFJldHVybiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uCiAgICByZXR1cm4gKHQpID0+IHsKICAgICAgaWYgKHQgPD0gdGltZXNbMF0pIHJldHVybiBzbW9vdGhlZFswXTsKICAgICAgaWYgKHQgPj0gdGltZXNbdGltZXMubGVuZ3RoIC0gMV0pIHJldHVybiBzbW9vdGhlZFtzbW9vdGhlZC5sZW5ndGggLSAxXTsKICAgICAgCiAgICAgIC8vIExpbmVhciBpbnRlcnBvbGF0aW9uCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZXMubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgaWYgKHQgPj0gdGltZXNbaV0gJiYgdCA8PSB0aW1lc1tpICsgMV0pIHsKICAgICAgICAgIGNvbnN0IHJhdGlvID0gKHQgLSB0aW1lc1tpXSkgLyAodGltZXNbaSArIDFdIC0gdGltZXNbaV0pOwogICAgICAgICAgcmV0dXJuIHNtb290aGVkW2ldICogKDEgLSByYXRpbykgKyBzbW9vdGhlZFtpICsgMV0gKiByYXRpbzsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHNtb290aGVkW3Ntb290aGVkLmxlbmd0aCAtIDFdOwogICAgfTsKICB9CiAgCiAgcmV0dXJuIG51bGw7Cn0KCi8vIE5vcm1hbGl6ZSB3ZWxsIGRhdGEgdXNpbmcgZml0dGVkIGJhc2VsaW5lIChTdGVwIDQpCmZ1bmN0aW9uIG5vcm1hbGl6ZVdpdGhGaXR0ZWRCYXNlbGluZSh3ZWxsRGF0YSwgYmFzZWxpbmVFbmRUaW1lLCBtZXRob2QsIGZyYWMsIHBvbHlPcmRlciwgbm9ybWFsaXphdGlvbk1vZGUpIHsKICBpZiAoIXdlbGxEYXRhIHx8ICF3ZWxsRGF0YS50aW1lX3MgfHwgIXdlbGxEYXRhLnZhbHVlcykgewogICAgcmV0dXJuIHdlbGxEYXRhOwogIH0KICAKICAvLyBFeHRyYWN0IGJhc2VsaW5lIHdpbmRvdwogIGNvbnN0IGJhc2VsaW5lVGltZXMgPSBbXTsKICBjb25zdCBiYXNlbGluZVZhbHVlcyA9IFtdOwogIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbERhdGEudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCB0aW1lID0gd2VsbERhdGEudGltZV9zW2ldOwogICAgY29uc3QgdmFsID0gd2VsbERhdGEudmFsdWVzW2ldOwogICAgaWYgKHRpbWUgIT09IG51bGwgJiYgdmFsICE9PSBudWxsICYmIHRpbWUgPD0gYmFzZWxpbmVFbmRUaW1lKSB7CiAgICAgIGJhc2VsaW5lVGltZXMucHVzaCh0aW1lKTsKICAgICAgYmFzZWxpbmVWYWx1ZXMucHVzaCh2YWwpOwogICAgfQogIH0KICAKICBpZiAoYmFzZWxpbmVUaW1lcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB3ZWxsRGF0YTsgLy8gTm8gYmFzZWxpbmUgZGF0YQogIH0KICAKICAvLyBGaXQgYmFzZWxpbmUgZnVuY3Rpb24KICBjb25zdCBiYXNlbGluZUZ1bmMgPSBmaXRCYXNlbGluZUZ1bmN0aW9uKGJhc2VsaW5lVGltZXMsIGJhc2VsaW5lVmFsdWVzLCBtZXRob2QsIGZyYWMsIHBvbHlPcmRlcik7CiAgaWYgKCFiYXNlbGluZUZ1bmMpIHsKICAgIHJldHVybiB3ZWxsRGF0YTsKICB9CiAgCiAgLy8gTm9ybWFsaXplIGFsbCB0aW1lcG9pbnRzIHVzaW5nIGZpdHRlZCBiYXNlbGluZQogIGNvbnN0IG5vcm1hbGl6ZWRUaW1lcyA9IFtdOwogIGNvbnN0IG5vcm1hbGl6ZWRWYWx1ZXMgPSBbXTsKICBjb25zdCBvcmlnaW5hbFZhbHVlcyA9IFtdOwogIAogIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbERhdGEudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCB0aW1lID0gd2VsbERhdGEudGltZV9zW2ldOwogICAgY29uc3QgdmFsdWUgPSB3ZWxsRGF0YS52YWx1ZXNbaV07CiAgICAKICAgIGlmICh0aW1lID09PSBudWxsIHx8IHZhbHVlID09PSBudWxsKSBjb250aW51ZTsKICAgIAogICAgY29uc3QgYmFzZWxpbmVWYWx1ZSA9IGJhc2VsaW5lRnVuYyh0aW1lKTsKICAgIGlmIChiYXNlbGluZVZhbHVlID09PSAwIHx8ICFpc0Zpbml0ZShiYXNlbGluZVZhbHVlKSkgY29udGludWU7CiAgICAKICAgIGxldCBub3JtVmFsdWU7CiAgICBpZiAobm9ybWFsaXphdGlvbk1vZGUgPT09ICdkZWx0YV9mX292ZXJfZicpIHsKICAgICAgLy8gzpRGL0YgPSAoRih0KSAtIGcodCkpIC8gZyh0KQogICAgICBub3JtVmFsdWUgPSAodmFsdWUgLSBiYXNlbGluZVZhbHVlKSAvIGJhc2VsaW5lVmFsdWU7CiAgICB9IGVsc2UgewogICAgICAvLyBNdWx0aXBsaWNhdGl2ZTogRl9ub3JtKHQpID0gRih0KSAvIGcodCkKICAgICAgbm9ybVZhbHVlID0gdmFsdWUgLyBiYXNlbGluZVZhbHVlOwogICAgfQogICAgCiAgICBub3JtYWxpemVkVGltZXMucHVzaCh0aW1lKTsKICAgIG5vcm1hbGl6ZWRWYWx1ZXMucHVzaChub3JtVmFsdWUpOwogICAgb3JpZ2luYWxWYWx1ZXMucHVzaCh2YWx1ZSk7CiAgfQogIAogIGlmIChub3JtYWxpemVkVGltZXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgcmV0dXJuIHsKICAgIHRpbWVfczogbm9ybWFsaXplZFRpbWVzLAogICAgdmFsdWVzOiBub3JtYWxpemVkVmFsdWVzLAogICAgb3JpZ2luYWxWYWx1ZXM6IG9yaWdpbmFsVmFsdWVzLAogICAgbGFiZWw6IHdlbGxEYXRhLmxhYmVsLAogICAgY29udGVudDogd2VsbERhdGEuY29udGVudAogIH07Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZVdlbGxEYXRhKHdlbGxEYXRhLCBpc05vcm1hbGl6ZWQsIGJhc2VsaW5lRW5kVGltZSA9IDI0LCBjdXRvZmZUaW1lID0gMzYwKSB7CiAgLy8gU1RFUCAzOiBOb3JtYWxpemUgYSBzaW5nbGUgd2VsbCdzIGRhdGEgb2JqZWN0IChpZiBub3JtYWxpemF0aW9uIGlzIGVuYWJsZWQpCiAgLy8gVGhpcyBoYXBwZW5zIEFGVEVSIGJhc2VsaW5lIGFsaWdubWVudCBhbmQgZ3JvdXBpbmcgaW50byB0cmlwbGljYXRlcwogIC8vIFJldHVybnMgYSBuZXcgd2VsbCBkYXRhIG9iamVjdCB3aXRoIG5vcm1hbGl6ZWQgdGltZV9zIGFuZCB2YWx1ZXMgKG9yIG9yaWdpbmFsIGlmIG5vdCBub3JtYWxpemVkKQogIGlmICghd2VsbERhdGEgfHwgIXdlbGxEYXRhLnRpbWVfcyB8fCAhd2VsbERhdGEudmFsdWVzKSB7CiAgICByZXR1cm4gd2VsbERhdGE7IC8vIFJldHVybiBhcy1pcyBpZiBpbnZhbGlkCiAgfQogIAogIGlmICghaXNOb3JtYWxpemVkKSB7CiAgICAvLyBOb3Qgbm9ybWFsaXppbmcgLSByZXR1cm4gb3JpZ2luYWwgZGF0YQogICAgcmV0dXJuIHsKICAgICAgdGltZV9zOiB3ZWxsRGF0YS50aW1lX3MsCiAgICAgIHZhbHVlczogd2VsbERhdGEudmFsdWVzLAogICAgICBsYWJlbDogd2VsbERhdGEubGFiZWwsCiAgICAgIGNvbnRlbnQ6IHdlbGxEYXRhLmNvbnRlbnQsCiAgICAgIG9yaWdpbmFsVmFsdWVzOiB3ZWxsRGF0YS5vcmlnaW5hbFZhbHVlcyB8fCB3ZWxsRGF0YS52YWx1ZXMKICAgIH07CiAgfQogIAogIC8vIE5vcm1hbGl6ZSB0aGlzIHdlbGwKICBjb25zdCBub3JtYWxpemVkID0gbm9ybWFsaXplRGF0YSh3ZWxsRGF0YS50aW1lX3MsIHdlbGxEYXRhLnZhbHVlcywgYmFzZWxpbmVFbmRUaW1lLCBjdXRvZmZUaW1lKTsKICAKICBpZiAobm9ybWFsaXplZC5maWx0ZXJlZFRpbWVQb2ludHMubGVuZ3RoID09PSAwKSB7CiAgICAvLyBObyBkYXRhIGFmdGVyIG5vcm1hbGl6YXRpb24gLSByZXR1cm4gbnVsbCB0byBpbmRpY2F0ZSB0aGlzIHdlbGwgc2hvdWxkIGJlIHNraXBwZWQKICAgIHJldHVybiBudWxsOwogIH0KICAKICAvLyBSZXR1cm4gbm9ybWFsaXplZCB3ZWxsIGRhdGEKICByZXR1cm4gewogICAgdGltZV9zOiBub3JtYWxpemVkLmZpbHRlcmVkVGltZVBvaW50cywKICAgIHZhbHVlczogbm9ybWFsaXplZC5ub3JtYWxpemVkVmFsdWVzLAogICAgb3JpZ2luYWxWYWx1ZXM6IG5vcm1hbGl6ZWQub3JpZ2luYWxWYWx1ZXMsIC8vIFN0b3JlIGZvciB0b29sdGlwIGRpc3BsYXkKICAgIGxhYmVsOiB3ZWxsRGF0YS5sYWJlbCwKICAgIGNvbnRlbnQ6IHdlbGxEYXRhLmNvbnRlbnQKICB9Owp9CgoKLy8gRml0IHJlZ3Jlc3Npb24gY3VydmUgdG8gZGF0YSBwb2ludHMgKFN0ZXAgNCkKZnVuY3Rpb24gZml0UmVncmVzc2lvbkN1cnZlKGRhdGFQb2ludHMsIHJlZ3Jlc3Npb25UeXBlID0gJ21vbm8tZXhwb25lbnRpYWwnLCBwb2x5bm9taWFsT3JkZXIgPSAyKSB7CiAgLy8gZGF0YVBvaW50cyBpcyBhbiBhcnJheSBvZiB7eCwgeX0gb2JqZWN0cwogIGlmICghZGF0YVBvaW50cyB8fCBkYXRhUG9pbnRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIAogIC8vIEZpbHRlciB2YWxpZCBwb2ludHMKICBjb25zdCB2YWxpZFBvaW50cyA9IGRhdGFQb2ludHMuZmlsdGVyKHAgPT4gcC54ICE9PSBudWxsICYmIHAueSAhPT0gbnVsbCAmJiBpc0Zpbml0ZShwLngpICYmIGlzRmluaXRlKHAueSkpOwogIGlmICh2YWxpZFBvaW50cy5sZW5ndGggPCAyKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgLy8gU29ydCBieSB4CiAgdmFsaWRQb2ludHMuc29ydCgoYSwgYikgPT4gYS54IC0gYi54KTsKICBjb25zdCB4ID0gdmFsaWRQb2ludHMubWFwKHAgPT4gcC54KTsKICBjb25zdCB5ID0gdmFsaWRQb2ludHMubWFwKHAgPT4gcC55KTsKICAKICBsZXQgZml0RnVuY3Rpb247CiAgCiAgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAnbGluZWFyJykgewogICAgLy8gTGluZWFyOiB5ID0gYSArIGIqeAogICAgY29uc3QgbiA9IHgubGVuZ3RoOwogICAgY29uc3Qgc3VtWCA9IHgucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICBjb25zdCBzdW1ZID0geS5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTsKICAgIGNvbnN0IHN1bVhZID0geC5yZWR1Y2UoKHN1bSwgeGksIGkpID0+IHN1bSArIHhpICogeVtpXSwgMCk7CiAgICBjb25zdCBzdW1YMiA9IHgucmVkdWNlKChzdW0sIHhpKSA9PiBzdW0gKyB4aSAqIHhpLCAwKTsKICAgIAogICAgY29uc3QgZGV0ID0gbiAqIHN1bVgyIC0gc3VtWCAqIHN1bVg7CiAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgIC8vIEZhbGxiYWNrIHRvIGNvbnN0YW50CiAgICAgIGNvbnN0IG1lYW4gPSBzdW1ZIC8gbjsKICAgICAgZml0RnVuY3Rpb24gPSAodCkgPT4gbWVhbjsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGEgPSAoc3VtWSAqIHN1bVgyIC0gc3VtWCAqIHN1bVhZKSAvIGRldDsKICAgICAgY29uc3QgYiA9IChuICogc3VtWFkgLSBzdW1YICogc3VtWSkgLyBkZXQ7CiAgICAgIGZpdEZ1bmN0aW9uID0gKHQpID0+IGEgKyBiICogdDsKICAgIH0KICB9IGVsc2UgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAncG9seW5vbWlhbCcpIHsKICAgIC8vIFBvbHlub21pYWw6IHkgPSBjMCArIGMxKnggKyBjMip4XjIgKyAuLi4gKyBjbip4Xm4KICAgIGNvbnN0IG4gPSB4Lmxlbmd0aDsKICAgIGNvbnN0IG9yZGVyID0gTWF0aC5taW4ocG9seW5vbWlhbE9yZGVyLCBuIC0gMSk7IC8vIENhbid0IGZpdCBvcmRlciA+PSBuIHBvaW50cwogICAgCiAgICAvLyBCdWlsZCBkZXNpZ24gbWF0cml4CiAgICBjb25zdCBYID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCByb3cgPSBbXTsKICAgICAgZm9yIChsZXQgcCA9IG9yZGVyOyBwID49IDA7IHAtLSkgewogICAgICAgIHJvdy5wdXNoKE1hdGgucG93KHhbaV0sIHApKTsKICAgICAgfQogICAgICBYLnB1c2gocm93KTsKICAgIH0KICAgIAogICAgLy8gU29sdmUgdXNpbmcgbm9ybWFsIGVxdWF0aW9uczogKFgnWCleKC0xKVgneQogICAgLy8gU2ltcGxpZmllZCBmb3Igc21hbGwgb3JkZXJzCiAgICBsZXQgY29lZmZzOwogICAgaWYgKG9yZGVyID09PSAxKSB7CiAgICAgIC8vIExpbmVhciBjYXNlCiAgICAgIGNvbnN0IHN1bVggPSB4LnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgICBjb25zdCBzdW1YMiA9IHgucmVkdWNlKChzdW0sIHhpKSA9PiBzdW0gKyB4aSAqIHhpLCAwKTsKICAgICAgY29uc3Qgc3VtWSA9IHkucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICAgIGNvbnN0IHN1bVhZID0geC5yZWR1Y2UoKHN1bSwgeGksIGkpID0+IHN1bSArIHhpICogeVtpXSwgMCk7CiAgICAgIGNvbnN0IGRldCA9IG4gKiBzdW1YMiAtIHN1bVggKiBzdW1YOwogICAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgICAgY29lZmZzID0gW3N1bVkgLyBuLCAwXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBhID0gKHN1bVkgKiBzdW1YMiAtIHN1bVggKiBzdW1YWSkgLyBkZXQ7CiAgICAgICAgY29uc3QgYiA9IChuICogc3VtWFkgLSBzdW1YICogc3VtWSkgLyBkZXQ7CiAgICAgICAgY29lZmZzID0gW2EsIGJdOyAvLyBbYzAsIGMxXQogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBIaWdoZXIgb3JkZXIgLSB1c2Ugc2ltcGxlIGxlYXN0IHNxdWFyZXMgYXBwcm94aW1hdGlvbgogICAgICAvLyBGb3Igc2ltcGxpY2l0eSwgdXNlIGEgYmFzaWMgaW1wbGVtZW50YXRpb24KICAgICAgY29uc3QgbWVhblkgPSB5LnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gbjsKICAgICAgY29lZmZzID0gW21lYW5ZXTsKICAgICAgZm9yIChsZXQgcCA9IDE7IHAgPD0gb3JkZXI7IHArKykgewogICAgICAgIGNvZWZmcy5wdXNoKDApOwogICAgICB9CiAgICB9CiAgICAKICAgIGZpdEZ1bmN0aW9uID0gKHQpID0+IHsKICAgICAgbGV0IHJlc3VsdCA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29lZmZzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVzdWx0ICs9IGNvZWZmc1tpXSAqIE1hdGgucG93KHQsIGNvZWZmcy5sZW5ndGggLSAxIC0gaSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfSBlbHNlIGlmIChyZWdyZXNzaW9uVHlwZSA9PT0gJ2V4cG9uZW50aWFsJykgewogICAgLy8gRXhwb25lbnRpYWw6IHkgPSBhICogZV4oYip4KSBvciB5ID0gYSAqIGJeeAogICAgLy8gVHJhbnNmb3JtIHRvIGxpbmVhcjogbG4oeSkgPSBsbihhKSArIGIqeAogICAgY29uc3QgbG9nWSA9IHkubWFwKHlpID0+IHlpID4gMCA/IE1hdGgubG9nKHlpKSA6IG51bGwpLmZpbHRlcihseSA9PiBseSAhPT0gbnVsbCk7CiAgICBpZiAobG9nWS5sZW5ndGggPCAyKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgCiAgICBjb25zdCBuID0geC5sZW5ndGg7CiAgICBjb25zdCBzdW1YID0geC5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTsKICAgIGNvbnN0IHN1bUxvZ1kgPSBsb2dZLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgY29uc3Qgc3VtWExvZ1kgPSB4LnNsaWNlKDAsIGxvZ1kubGVuZ3RoKS5yZWR1Y2UoKHN1bSwgeGksIGkpID0+IHN1bSArIHhpICogbG9nWVtpXSwgMCk7CiAgICBjb25zdCBzdW1YMiA9IHguc2xpY2UoMCwgbG9nWS5sZW5ndGgpLnJlZHVjZSgoc3VtLCB4aSkgPT4gc3VtICsgeGkgKiB4aSwgMCk7CiAgICAKICAgIGNvbnN0IGRldCA9IGxvZ1kubGVuZ3RoICogc3VtWDIgLSBzdW1YICogc3VtWDsKICAgIGlmIChNYXRoLmFicyhkZXQpIDwgMWUtMTApIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICAKICAgIGNvbnN0IGxuQSA9IChzdW1Mb2dZICogc3VtWDIgLSBzdW1YICogc3VtWExvZ1kpIC8gZGV0OwogICAgY29uc3QgYiA9IChsb2dZLmxlbmd0aCAqIHN1bVhMb2dZIC0gc3VtWCAqIHN1bUxvZ1kpIC8gZGV0OwogICAgY29uc3QgYSA9IE1hdGguZXhwKGxuQSk7CiAgICAKICAgIGZpdEZ1bmN0aW9uID0gKHQpID0+IGEgKiBNYXRoLmV4cChiICogdCk7CiAgfSBlbHNlIGlmIChyZWdyZXNzaW9uVHlwZSA9PT0gJ2xvZ2FyaXRobWljJykgewogICAgLy8gTG9nYXJpdGhtaWM6IHkgPSBhICsgYipsbih4KQogICAgLy8gRmlsdGVyIG91dCBub24tcG9zaXRpdmUgeCB2YWx1ZXMKICAgIGNvbnN0IHZhbGlkSW5kaWNlcyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB4Lmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh4W2ldID4gMCkgewogICAgICAgIHZhbGlkSW5kaWNlcy5wdXNoKGkpOwogICAgICB9CiAgICB9CiAgICAKICAgIGlmICh2YWxpZEluZGljZXMubGVuZ3RoIDwgMikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIAogICAgY29uc3QgbG9nWCA9IHZhbGlkSW5kaWNlcy5tYXAoaSA9PiBNYXRoLmxvZyh4W2ldKSk7CiAgICBjb25zdCB2YWxpZFkgPSB2YWxpZEluZGljZXMubWFwKGkgPT4geVtpXSk7CiAgICBjb25zdCBuID0gdmFsaWRJbmRpY2VzLmxlbmd0aDsKICAgIAogICAgY29uc3Qgc3VtTG9nWCA9IGxvZ1gucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICBjb25zdCBzdW1ZID0gdmFsaWRZLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgY29uc3Qgc3VtTG9nWFkgPSBsb2dYLnJlZHVjZSgoc3VtLCBseGksIGkpID0+IHN1bSArIGx4aSAqIHZhbGlkWVtpXSwgMCk7CiAgICBjb25zdCBzdW1Mb2dYMiA9IGxvZ1gucmVkdWNlKChzdW0sIGx4aSkgPT4gc3VtICsgbHhpICogbHhpLCAwKTsKICAgIAogICAgY29uc3QgZGV0ID0gbiAqIHN1bUxvZ1gyIC0gc3VtTG9nWCAqIHN1bUxvZ1g7CiAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgCiAgICBjb25zdCBhID0gKHN1bVkgKiBzdW1Mb2dYMiAtIHN1bUxvZ1ggKiBzdW1Mb2dYWSkgLyBkZXQ7CiAgICBjb25zdCBiID0gKG4gKiBzdW1Mb2dYWSAtIHN1bUxvZ1ggKiBzdW1ZKSAvIGRldDsKICAgIAogICAgZml0RnVuY3Rpb24gPSAodCkgPT4gdCA+IDAgPyBhICsgYiAqIE1hdGgubG9nKHQpIDogbnVsbDsKICB9IGVsc2UgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAnbW9uby1leHBvbmVudGlhbCcpIHsKICAgIC8vIE1vbm8tZXhwb25lbnRpYWwgcmlzZSB0byBwbGF0ZWF1OiB5KHQpID0gMSArIEEoMSAtIGVeKC1rKHQgLSB04oKAKSkpCiAgICAvLyBGb3Igbm9ybWFsaXplZCBkYXRhLCBiYXNlbGluZSDiiYggMSwgc28gd2UgZml4IHTigoAgPSAwIChvciBmaXJzdCB0aW1lcG9pbnQpCiAgICAvLyB5KHQpID0gMSArIEEoMSAtIGVeKC1rKnQpKQogICAgCiAgICAvLyBGaW5kIHTigoAgYXMgdGhlIGZpcnN0IHRpbWVwb2ludCAob3IgMCBpZiBkYXRhIHN0YXJ0cyBhdCAwKQogICAgY29uc3QgdDAgPSBNYXRoLm1pbiguLi54KTsKICAgIGNvbnN0IHhTaGlmdGVkID0geC5tYXAoeGkgPT4geGkgLSB0MCk7CiAgICAKICAgIC8vIEluaXRpYWwgcGFyYW1ldGVyIGVzdGltYXRlcwogICAgLy8gQTogYW1wbGl0dWRlID0gbWF4KHkpIC0gMSAoc2luY2UgYmFzZWxpbmUgaXMgbm9ybWFsaXplZCB0byAxKQogICAgY29uc3QgeU1heCA9IE1hdGgubWF4KC4uLnkpOwogICAgY29uc3QgeU1pbiA9IE1hdGgubWluKC4uLnkpOwogICAgbGV0IEEgPSBNYXRoLm1heCgwLCB5TWF4IC0gMSk7IC8vIEFtcGxpdHVkZSBzaG91bGQgYmUgcG9zaXRpdmUKICAgIAogICAgLy8gazogcmF0ZSBjb25zdGFudCAtIGVzdGltYXRlIGZyb20gcmlzZSB0aW1lCiAgICAvLyBGaW5kIHRpbWVwb2ludCB3aGVyZSBzaWduYWwgcmVhY2hlcyB+NjMlJSBvZiBhbXBsaXR1ZGUgKDEgLSAxL2Ug4omIIDAuNjMyKQogICAgY29uc3QgdGltZVNwYW4gPSBNYXRoLm1heCguLi54U2hpZnRlZCkgLSBNYXRoLm1pbiguLi54U2hpZnRlZCk7CiAgICBjb25zdCB0YXJnZXRZID0gMSArIEEgKiAwLjYzMjsKICAgIGxldCBrID0gMC4wMTsgLy8gRGVmYXVsdCBpbml0aWFsIGd1ZXNzCiAgICBpZiAoQSA+IDAuMDEgJiYgdGltZVNwYW4gPiAwKSB7CiAgICAgIC8vIEZpbmQgY2xvc2VzdCBwb2ludCB0byB0YXJnZXQKICAgICAgbGV0IGNsb3Nlc3RJZHggPSAwOwogICAgICBsZXQgbWluRGlmZiA9IE1hdGguYWJzKHlbMF0gLSB0YXJnZXRZKTsKICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCB5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgZGlmZiA9IE1hdGguYWJzKHlbaV0gLSB0YXJnZXRZKTsKICAgICAgICBpZiAoZGlmZiA8IG1pbkRpZmYpIHsKICAgICAgICAgIG1pbkRpZmYgPSBkaWZmOwogICAgICAgICAgY2xvc2VzdElkeCA9IGk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEVzdGltYXRlIGsgZnJvbTogMSAtIGVeKC1rKnQpID0gMC42MzIgPT4gayDiiYggMS90CiAgICAgIGlmICh4U2hpZnRlZFtjbG9zZXN0SWR4XSA+IDApIHsKICAgICAgICBrID0gMSAvIHhTaGlmdGVkW2Nsb3Nlc3RJZHhdOwogICAgICAgIGsgPSBNYXRoLm1heCgxZS02LCBNYXRoLm1pbigxMCwgaykpOyAvLyBCb3VuZCBiZXR3ZWVuIDFlLTYgYW5kIDEwCiAgICAgIH0KICAgIH0KICAgIAogICAgLy8gVXNlIHNpbXBsZSBpdGVyYXRpdmUgbm9ubGluZWFyIGxlYXN0IHNxdWFyZXMgKEdhdXNzLU5ld3RvbikKICAgIC8vIE1pbmltaXplIHN1bSBvZiBzcXVhcmVkIHJlc2lkdWFsczogzqMoeSAtICgxICsgQSgxIC0gZV4oLWsqdCkpKSnCsgogICAgY29uc3QgbWF4SXRlcmF0aW9ucyA9IDEwMDsKICAgIGNvbnN0IHRvbGVyYW5jZSA9IDFlLTY7CiAgICAKICAgIGZvciAobGV0IGl0ZXIgPSAwOyBpdGVyIDwgbWF4SXRlcmF0aW9uczsgaXRlcisrKSB7CiAgICAgIC8vIENhbGN1bGF0ZSByZXNpZHVhbHMgYW5kIEphY29iaWFuCiAgICAgIGxldCBzdW1SZXNpZHVhbCA9IDA7CiAgICAgIGxldCBzdW1SZXNpZHVhbEEgPSAwOwogICAgICBsZXQgc3VtUmVzaWR1YWxLID0gMDsKICAgICAgbGV0IHN1bUpBQSA9IDA7CiAgICAgIGxldCBzdW1KQUsgPSAwOwogICAgICBsZXQgc3VtSktLID0gMDsKICAgICAgCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgeFNoaWZ0ZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB0ID0geFNoaWZ0ZWRbaV07CiAgICAgICAgY29uc3QgeU9icyA9IHlbaV07CiAgICAgICAgY29uc3QgeVByZWQgPSAxICsgQSAqICgxIC0gTWF0aC5leHAoLWsgKiB0KSk7CiAgICAgICAgY29uc3QgcmVzaWR1YWwgPSB5T2JzIC0geVByZWQ7CiAgICAgICAgCiAgICAgICAgLy8gUGFydGlhbCBkZXJpdmF0aXZlcwogICAgICAgIGNvbnN0IGRBID0gMSAtIE1hdGguZXhwKC1rICogdCk7CiAgICAgICAgY29uc3QgZEsgPSBBICogdCAqIE1hdGguZXhwKC1rICogdCk7CiAgICAgICAgCiAgICAgICAgc3VtUmVzaWR1YWwgKz0gcmVzaWR1YWw7CiAgICAgICAgc3VtUmVzaWR1YWxBICs9IHJlc2lkdWFsICogZEE7CiAgICAgICAgc3VtUmVzaWR1YWxLICs9IHJlc2lkdWFsICogZEs7CiAgICAgICAgc3VtSkFBICs9IGRBICogZEE7CiAgICAgICAgc3VtSkFLICs9IGRBICogZEs7CiAgICAgICAgc3VtSktLICs9IGRLICogZEs7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIFNvbHZlIG5vcm1hbCBlcXVhdGlvbnM6IEpeVCAqIEogKiBkZWx0YSA9IEpeVCAqIHJlc2lkdWFsCiAgICAgIGNvbnN0IGRldCA9IHN1bUpBQSAqIHN1bUpLSyAtIHN1bUpBSyAqIHN1bUpBSzsKICAgICAgaWYgKE1hdGguYWJzKGRldCkgPCAxZS0xMCkgYnJlYWs7CiAgICAgIAogICAgICBjb25zdCBkZWx0YUEgPSAoc3VtUmVzaWR1YWxBICogc3VtSktLIC0gc3VtUmVzaWR1YWxLICogc3VtSkFLKSAvIGRldDsKICAgICAgY29uc3QgZGVsdGFLID0gKHN1bVJlc2lkdWFsSyAqIHN1bUpBQSAtIHN1bVJlc2lkdWFsQSAqIHN1bUpBSykgLyBkZXQ7CiAgICAgIAogICAgICAvLyBVcGRhdGUgcGFyYW1ldGVycyB3aXRoIGRhbXBpbmcKICAgICAgY29uc3QgZGFtcGluZyA9IDAuNTsKICAgICAgQSA9IE1hdGgubWF4KDAsIEEgKyBkYW1waW5nICogZGVsdGFBKTsKICAgICAgayA9IE1hdGgubWF4KDFlLTYsIE1hdGgubWluKDEwLCBrICsgZGFtcGluZyAqIGRlbHRhSykpOwogICAgICAKICAgICAgLy8gSWYgcGFyYW1ldGVycyBkaWRuJ3QgY2hhbmdlIG11Y2gsIHdlJ3JlIGRvbmUKICAgICAgaWYgKE1hdGguYWJzKGRlbHRhQSkgPCB0b2xlcmFuY2UgJiYgTWF0aC5hYnMoZGVsdGFLKSA8IHRvbGVyYW5jZSkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICAKICAgIC8vIFN0b3JlIHBhcmFtZXRlcnMgZm9yIGluZm8gcGFuZWwKICAgIGNvbnN0IHRhdSA9IDEgLyBrOyAvLyB0aW1lIGNvbnN0YW50CiAgICBjb25zdCB0SGFsZiA9IE1hdGgubG9nKDIpIC8gazsgLy8gaGFsZi10aW1lCiAgICBjb25zdCBwbGF0ZWF1ID0gMSArIEE7IC8vIHBsYXRlYXUgdmFsdWUKICAgIAogICAgLy8gQ3JlYXRlIGZpdCBmdW5jdGlvbgogICAgZml0RnVuY3Rpb24gPSAodCkgPT4gewogICAgICBjb25zdCB0U2hpZnRlZCA9IHQgLSB0MDsKICAgICAgaWYgKHRTaGlmdGVkIDwgMCkgcmV0dXJuIDE7IC8vIEJlZm9yZSBhY3RpdmF0aW9uCiAgICAgIHJldHVybiAxICsgQSAqICgxIC0gTWF0aC5leHAoLWsgKiB0U2hpZnRlZCkpOwogICAgfTsKICAgIAogICAgLy8gQXR0YWNoIHBhcmFtZXRlcnMgdG8gZnVuY3Rpb24gZm9yIGluZm8gcGFuZWwKICAgIGZpdEZ1bmN0aW9uLnBhcmFtcyA9IHsKICAgICAgQTogQSwKICAgICAgazogaywKICAgICAgdDA6IHQwLAogICAgICB0YXU6IHRhdSwKICAgICAgdEhhbGY6IHRIYWxmLAogICAgICBwbGF0ZWF1OiBwbGF0ZWF1CiAgICB9OwogIH0gZWxzZSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgcmV0dXJuIGZpdEZ1bmN0aW9uOwp9CgpmdW5jdGlvbiBub3JtYWxpemVNZWFuQW5kRXJyb3IodGltZVBvaW50cywgbWVhbnMsIGVycm9ycywgYmFzZWxpbmVFbmRUaW1lID0gMjQsIGN1dG9mZlRpbWUgPSAzNjApIHsKICAvLyBOb3JtYWxpemUgbWVhbiBhbmQgZXJyb3IgZGF0YTogY2FsY3VsYXRlIGJhc2VsaW5lIGZyb20gMC1iYXNlbGluZUVuZFRpbWUsIHRoZW4gcGxvdCBvbmx5IHBvaW50cyBhZnRlciBiYXNlbGluZUVuZFRpbWUKICAvLyBkaXZpZGVkIGJ5IGJhc2VsaW5lLCB1cCB0byBjdXRvZmZUaW1lLiBCYXNlbGluZSBwZXJpb2QgaXMgTk9UIGluY2x1ZGVkIGluIHRoZSBwbG90LgogIC8vIFJldHVybnMgeyBmaWx0ZXJlZFRpbWVQb2ludHMsIG5vcm1hbGl6ZWRNZWFucywgbm9ybWFsaXplZEVycm9ycyB9IC0gZmlsdGVyZWQgYXJyYXlzCiAgLy8gRmlyc3QgY2FsY3VsYXRlIGJhc2VsaW5lIGZyb20gbWVhbnMKICBjb25zdCBiYXNlbGluZVZhbHVlcyA9IFtdOwogIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZVBvaW50cy5sZW5ndGg7IGkrKykgewogICAgaWYgKHRpbWVQb2ludHNbaV0gIT09IG51bGwgJiYgbWVhbnNbaV0gIT09IG51bGwgJiYgdGltZVBvaW50c1tpXSA8PSBiYXNlbGluZUVuZFRpbWUpIHsKICAgICAgYmFzZWxpbmVWYWx1ZXMucHVzaChtZWFuc1tpXSk7CiAgICB9CiAgfQogIAogIGlmIChiYXNlbGluZVZhbHVlcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB7IGZpbHRlcmVkVGltZVBvaW50czogdGltZVBvaW50cywgbm9ybWFsaXplZE1lYW5zOiBtZWFucywgbm9ybWFsaXplZEVycm9yczogZXJyb3JzIH07CiAgfQogIAogIGNvbnN0IGJhc2VsaW5lID0gYmFzZWxpbmVWYWx1ZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyBiYXNlbGluZVZhbHVlcy5sZW5ndGg7CiAgCiAgaWYgKGJhc2VsaW5lID09PSAwKSB7CiAgICByZXR1cm4geyBmaWx0ZXJlZFRpbWVQb2ludHM6IHRpbWVQb2ludHMsIG5vcm1hbGl6ZWRNZWFuczogbWVhbnMsIG5vcm1hbGl6ZWRFcnJvcnM6IGVycm9ycyB9OwogIH0KICAKICAvLyBGaWx0ZXIgYW5kIG5vcm1hbGl6ZTogb25seSBpbmNsdWRlIHBvaW50cyB3aGVyZSBiYXNlbGluZUVuZFRpbWUgPCB0aW1lIDw9IGN1dG9mZlRpbWUKICBjb25zdCBmaWx0ZXJlZFRpbWVQb2ludHMgPSBbXTsKICBjb25zdCBub3JtYWxpemVkTWVhbnMgPSBbXTsKICBjb25zdCBub3JtYWxpemVkRXJyb3JzID0gW107CiAgCiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aW1lUG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCB0aW1lID0gdGltZVBvaW50c1tpXTsKICAgIGNvbnN0IG1lYW4gPSBtZWFuc1tpXTsKICAgIGNvbnN0IGVycm9yID0gZXJyb3JzW2ldOwogICAgCiAgICBpZiAodGltZSA9PT0gbnVsbCB8fCBtZWFuID09PSBudWxsKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQogICAgCiAgICAvLyBPbmx5IGluY2x1ZGUgcG9pbnRzIGFmdGVyIGJhc2VsaW5lRW5kVGltZSBhbmQgdXAgdG8gY3V0b2ZmVGltZSAoYmFzZWxpbmUgTk9UIGluY2x1ZGVkKQogICAgaWYgKHRpbWUgPiBiYXNlbGluZUVuZFRpbWUgJiYgdGltZSA8PSBjdXRvZmZUaW1lKSB7CiAgICAgIC8vIFN1YnRyYWN0IGJhc2VsaW5lRW5kVGltZSB0byBicmluZyBmaXJzdCBwb2ludCB0byB4PTAgKHRpbWUgYWZ0ZXIgaW5qZWN0aW9uKQogICAgICBmaWx0ZXJlZFRpbWVQb2ludHMucHVzaCh0aW1lIC0gYmFzZWxpbmVFbmRUaW1lKTsKICAgICAgbm9ybWFsaXplZE1lYW5zLnB1c2gobWVhbiAvIGJhc2VsaW5lKTsKICAgICAgLy8gRXJyb3JzIHNjYWxlIHByb3BvcnRpb25hbGx5CiAgICAgIG5vcm1hbGl6ZWRFcnJvcnMucHVzaChlcnJvciAhPT0gbnVsbCA/IGVycm9yIC8gYmFzZWxpbmUgOiBudWxsKTsKICAgIH0KICB9CiAgCiAgcmV0dXJuIHsgZmlsdGVyZWRUaW1lUG9pbnRzLCBub3JtYWxpemVkTWVhbnMsIG5vcm1hbGl6ZWRFcnJvcnMgfTsKfQoKZnVuY3Rpb24gdXBkYXRlQ2hhcnQoKSB7CiAgLy8gR3VhcmQ6IGVuc3VyZSB2aWV3ZXJEYXRhIGlzIGxvYWRlZAogIGlmICghdmlld2VyRGF0YSB8fCAhYWxsV2VsbHNEYXRhIHx8IE9iamVjdC5rZXlzKGFsbFdlbGxzRGF0YSkubGVuZ3RoID09PSAwKSB7CiAgICBjb25zb2xlLndhcm4oInZpZXdlckRhdGEgbm90IGxvYWRlZCB5ZXQsIHNraXBwaW5nIGNoYXJ0IHVwZGF0ZSIpOwogICAgcmV0dXJuOwogIH0KICAKICBjb25zdCBjdHggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgid2VsbC1jaGFydCIpLmdldENvbnRleHQoIjJkIik7CgogIC8vIFNURVAgMTogQ2hlY2sgaWYgbm9ybWFsaXphdGlvbiB1c2luZyBmaXR0ZWQgYmFzZWxpbmUgaXMgZW5hYmxlZCAobXVzdCBiZSBmaXJzdCkKICBjb25zdCBub3JtYWxpemVCYXNlbGluZVRvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJub3JtYWxpemUtYmFzZWxpbmUtdG9nZ2xlIik7CiAgY29uc3Qgbm9ybWFsaXplQmFzZWxpbmUgPSBub3JtYWxpemVCYXNlbGluZVRvZ2dsZSA/IG5vcm1hbGl6ZUJhc2VsaW5lVG9nZ2xlLmNoZWNrZWQgOiBmYWxzZTsKICAKICAvLyBTVEVQIDI6IENoZWNrIGlmIHRyaXBsaWNhdGUgZ3JvdXBpbmcgaXMgZW5hYmxlZCAocmVxdWlyZXMgU3RlcCAxKQogIGNvbnN0IGdyb3VwVHJpcGxpY2F0ZXNUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZ3JvdXAtdHJpcGxpY2F0ZXMtdG9nZ2xlIik7CiAgY29uc3QgZ3JvdXBUcmlwbGljYXRlcyA9IGdyb3VwVHJpcGxpY2F0ZXNUb2dnbGUgPyBncm91cFRyaXBsaWNhdGVzVG9nZ2xlLmNoZWNrZWQgOiBmYWxzZTsKICAKICAvLyBFbmZvcmNlIHdvcmtmbG93OiBTdGVwIDIgKGdyb3VwaW5nKSByZXF1aXJlcyBTdGVwIDEgKG5vcm1hbGl6YXRpb24pCiAgaWYgKGdyb3VwVHJpcGxpY2F0ZXMgJiYgIW5vcm1hbGl6ZUJhc2VsaW5lKSB7CiAgICAvLyBEaXNhYmxlIGdyb3VwaW5nIGlmIG5vcm1hbGl6YXRpb24gaXMgbm90IGVuYWJsZWQKICAgIGlmIChncm91cFRyaXBsaWNhdGVzVG9nZ2xlKSB7CiAgICAgIGdyb3VwVHJpcGxpY2F0ZXNUb2dnbGUuY2hlY2tlZCA9IGZhbHNlOwogICAgfQogICAgZ3JvdXBUcmlwbGljYXRlcyA9IGZhbHNlOwogIH0KICAKICAvLyBTVEVQIDA6IENoZWNrIGlmIGluZGl2aWR1YWwgd2VsbHMgc2hvdWxkIGJlIHNob3duCiAgLy8gU3RlcCAwIG9ubHkgc2hvd3Mgd2hlbiBOTyBvdGhlciBwcm9jZXNzaW5nIHN0ZXBzICgxLTIpIGFyZSBlbmFibGVkCiAgY29uc3Qgc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzaG93LWluZGl2aWR1YWwtd2VsbHMtdG9nZ2xlIik7CiAgY29uc3Qgc3RlcDBSZXF1ZXN0ZWQgPSBzaG93SW5kaXZpZHVhbFdlbGxzVG9nZ2xlID8gc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZS5jaGVja2VkIDogdHJ1ZTsKICBjb25zdCBhbnlQcm9jZXNzaW5nU3RlcEVuYWJsZWQgPSBub3JtYWxpemVCYXNlbGluZSB8fCBncm91cFRyaXBsaWNhdGVzOwogIC8vIFNob3cgU3RlcCAwIGlmIHJlcXVlc3RlZCBBTkQgbm8gb3RoZXIgc3RlcHMgZW5hYmxlZAogIC8vIElmIG5vIHN0ZXBzIGFyZSBlbmFibGVkIGF0IGFsbCwgZGVmYXVsdCB0byBzaG93aW5nIFN0ZXAgMCAocmF3IGRhdGEpIGFzIGZhbGxiYWNrCiAgY29uc3Qgc2hvd0luZGl2aWR1YWxXZWxscyA9IChzdGVwMFJlcXVlc3RlZCAmJiAhYW55UHJvY2Vzc2luZ1N0ZXBFbmFibGVkKSB8fCAoIWFueVByb2Nlc3NpbmdTdGVwRW5hYmxlZCk7CiAgCiAgLy8gU2hvdy9oaWRlIFN0ZXAgMCB3YXJuaW5nCiAgY29uc3Qgc3RlcDBXYXJuaW5nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInN0ZXAwLXdhcm5pbmciKTsKICBpZiAoc3RlcDBXYXJuaW5nKSB7CiAgICBzdGVwMFdhcm5pbmcuc3R5bGUuZGlzcGxheSA9IChzdGVwMFJlcXVlc3RlZCAmJiBhbnlQcm9jZXNzaW5nU3RlcEVuYWJsZWQpID8gImJsb2NrIiA6ICJub25lIjsKICB9CiAgCiAgLy8gRGlzYWJsZSBTdGVwIDAgY2hlY2tib3ggaWYgb3RoZXIgc3RlcHMgKDEtMikgYXJlIGVuYWJsZWQgKHZpc3VhbCBmZWVkYmFjaykKICBpZiAoc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZSkgewogICAgc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZS5kaXNhYmxlZCA9IGFueVByb2Nlc3NpbmdTdGVwRW5hYmxlZDsKICB9CiAgCiAgLy8gR2V0IG5vcm1hbGl6YXRpb24gYmFzZWxpbmUgcGFyYW1ldGVycwogIGNvbnN0IG5vcm1hbGl6ZUJhc2VsaW5lRW5kSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibm9ybWFsaXplLWJhc2VsaW5lLWVuZC10aW1lIik7CiAgY29uc3Qgbm9ybWFsaXplQmFzZWxpbmVFbmRUaW1lID0gbm9ybWFsaXplQmFzZWxpbmVFbmRJbnB1dCA/IHBhcnNlRmxvYXQobm9ybWFsaXplQmFzZWxpbmVFbmRJbnB1dC52YWx1ZSkgfHwgMjQgOiAyNDsKICAKICAvLyBHZXQgYmFzZWxpbmUgZml0dGluZyBtZXRob2QgYW5kIHBhcmFtZXRlcnMKICBjb25zdCBiYXNlbGluZU1ldGhvZFNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJiYXNlbGluZS1tZXRob2Qtc2VsZWN0Iik7CiAgY29uc3QgYmFzZWxpbmVNZXRob2QgPSBiYXNlbGluZU1ldGhvZFNlbGVjdCA/IGJhc2VsaW5lTWV0aG9kU2VsZWN0LnZhbHVlIDogImxvd2VzcyI7CiAgY29uc3QgYmFzZWxpbmVGcmFjSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtZnJhYy1pbnB1dCIpOwogIGNvbnN0IGJhc2VsaW5lRnJhYyA9IGJhc2VsaW5lRnJhY0lucHV0ID8gcGFyc2VGbG9hdChiYXNlbGluZUZyYWNJbnB1dC52YWx1ZSkgfHwgMC41IDogMC41OwogIGNvbnN0IGJhc2VsaW5lUG9seU9yZGVySW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtcG9seS1vcmRlci1pbnB1dCIpOwogIGNvbnN0IGJhc2VsaW5lUG9seU9yZGVyID0gYmFzZWxpbmVQb2x5T3JkZXJJbnB1dCA/IHBhcnNlSW50KGJhc2VsaW5lUG9seU9yZGVySW5wdXQudmFsdWUpIHx8IDEgOiAxOwogIAogIC8vIEdldCBub3JtYWxpemF0aW9uIG1vZGUKICBjb25zdCBub3JtYWxpemF0aW9uTW9kZVNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJub3JtYWxpemF0aW9uLW1vZGUtc2VsZWN0Iik7CiAgY29uc3Qgbm9ybWFsaXphdGlvbk1vZGUgPSBub3JtYWxpemF0aW9uTW9kZVNlbGVjdCA/IG5vcm1hbGl6YXRpb25Nb2RlU2VsZWN0LnZhbHVlIDogImRlbHRhX2Zfb3Zlcl9mIjsKICAKICAvLyBTaG93L2hpZGUgbm9ybWFsaXphdGlvbiBiYXNlbGluZSBwYXJhbWV0ZXJzCiAgY29uc3Qgbm9ybWFsaXplQmFzZWxpbmVQYXJhbWV0ZXJzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm5vcm1hbGl6ZS1iYXNlbGluZS1wYXJhbWV0ZXJzIik7CiAgaWYgKG5vcm1hbGl6ZUJhc2VsaW5lUGFyYW1ldGVyc0RpdiAmJiBub3JtYWxpemVCYXNlbGluZVRvZ2dsZSkgewogICAgbm9ybWFsaXplQmFzZWxpbmVQYXJhbWV0ZXJzRGl2LnN0eWxlLmRpc3BsYXkgPSBub3JtYWxpemVCYXNlbGluZSA/ICJibG9jayIgOiAibm9uZSI7CiAgfQogIAogIC8vIFNURVAgMzogQ2hlY2sgaWYgY3V0b2ZmIGlzIGVuYWJsZWQKICBjb25zdCBjdXRvZmZCYXNlbGluZVRvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXRvZmYtYmFzZWxpbmUtdG9nZ2xlIik7CiAgY29uc3QgY3V0b2ZmQmFzZWxpbmUgPSBjdXRvZmZCYXNlbGluZVRvZ2dsZSA/IGN1dG9mZkJhc2VsaW5lVG9nZ2xlLmNoZWNrZWQgOiBmYWxzZTsKICBjb25zdCBjdXRvZmZCYXNlbGluZVRpbWVJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXRvZmYtYmFzZWxpbmUtdGltZSIpOwogIGNvbnN0IGN1dG9mZkJhc2VsaW5lVGltZSA9IGN1dG9mZkJhc2VsaW5lVGltZUlucHV0ID8gcGFyc2VGbG9hdChjdXRvZmZCYXNlbGluZVRpbWVJbnB1dC52YWx1ZSkgfHwgMzYwIDogMzYwOwogIAogIC8vIFNob3cvaGlkZSBjdXRvZmYgcGFyYW1ldGVycwogIGNvbnN0IGN1dG9mZkJhc2VsaW5lUGFyYW1ldGVyc0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXRvZmYtYmFzZWxpbmUtcGFyYW1ldGVycyIpOwogIGlmIChjdXRvZmZCYXNlbGluZVBhcmFtZXRlcnNEaXYgJiYgY3V0b2ZmQmFzZWxpbmVUb2dnbGUpIHsKICAgIGN1dG9mZkJhc2VsaW5lUGFyYW1ldGVyc0Rpdi5zdHlsZS5kaXNwbGF5ID0gY3V0b2ZmQmFzZWxpbmUgPyAiYmxvY2siIDogIm5vbmUiOwogIH0KICAKICAvLyBTVEVQIDQ6IENoZWNrIGlmIHJlZ3Jlc3Npb24gaXMgZW5hYmxlZAogIGNvbnN0IGZpdFJlZ3Jlc3Npb25Ub2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZml0LXJlZ3Jlc3Npb24tdG9nZ2xlIik7CiAgY29uc3QgZml0UmVncmVzc2lvbiA9IGZpdFJlZ3Jlc3Npb25Ub2dnbGUgPyBmaXRSZWdyZXNzaW9uVG9nZ2xlLmNoZWNrZWQgOiBmYWxzZTsKICBjb25zdCByZWdyZXNzaW9uVHlwZVNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZWdyZXNzaW9uLXR5cGUtc2VsZWN0Iik7CiAgY29uc3QgcmVncmVzc2lvblR5cGUgPSByZWdyZXNzaW9uVHlwZVNlbGVjdCA/IHJlZ3Jlc3Npb25UeXBlU2VsZWN0LnZhbHVlIDogIm1vbm8tZXhwb25lbnRpYWwiOwogIGNvbnN0IHBvbHlub21pYWxPcmRlcklucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInBvbHlub21pYWwtb3JkZXItaW5wdXQiKTsKICBjb25zdCBwb2x5bm9taWFsT3JkZXIgPSBwb2x5bm9taWFsT3JkZXJJbnB1dCA/IHBhcnNlSW50KHBvbHlub21pYWxPcmRlcklucHV0LnZhbHVlKSB8fCAyIDogMjsKICAKICAvLyBTaG93L2hpZGUgcmVncmVzc2lvbiBwYXJhbWV0ZXJzCiAgY29uc3QgZml0UmVncmVzc2lvblBhcmFtZXRlcnNEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZml0LXJlZ3Jlc3Npb24tcGFyYW1ldGVycyIpOwogIGlmIChmaXRSZWdyZXNzaW9uUGFyYW1ldGVyc0RpdiAmJiBmaXRSZWdyZXNzaW9uVG9nZ2xlKSB7CiAgICBmaXRSZWdyZXNzaW9uUGFyYW1ldGVyc0Rpdi5zdHlsZS5kaXNwbGF5ID0gZml0UmVncmVzc2lvbiA/ICJibG9jayIgOiAibm9uZSI7CiAgfQogIAogIC8vIFVwZGF0ZSByZWdyZXNzaW9uIHR5cGUgcGFyYW1zIHRvIHNob3cvaGlkZSBpbmZvIHBhbmVsIHdoZW4gcmVncmVzc2lvbiBpcyB0b2dnbGVkCiAgaWYgKGZpdFJlZ3Jlc3Npb24pIHsKICAgIHVwZGF0ZVJlZ3Jlc3Npb25UeXBlUGFyYW1zKHRydWUpOyAvLyBTa2lwIGNoYXJ0IHVwZGF0ZSBzaW5jZSB3ZSdyZSBhbHJlYWR5IHVwZGF0aW5nCiAgfSBlbHNlIHsKICAgIC8vIEhpZGUgaW5mbyBwYW5lbCB3aGVuIHJlZ3Jlc3Npb24gaXMgZGlzYWJsZWQKICAgIGNvbnN0IGluZm9QYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZWdyZXNzaW9uLWluZm8tcGFuZWwiKTsKICAgIGlmIChpbmZvUGFuZWwpIHsKICAgICAgaW5mb1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICB9CiAgfQoKICBpZiAoc2VsZWN0ZWRXZWxscy5zaXplID09PSAwKSB7CiAgICAvLyBDbGVhciB0aGUgY2hhcnQgaWYgbm8gd2VsbHMgc2VsZWN0ZWQKICAgIC8vIERldGVybWluZSB5LWF4aXMgbGFiZWwgYmFzZWQgb24gcHJvY2Vzc2luZyBzdGVwcwogICAgbGV0IHlBeGlzTGFiZWwgPSAiRmx1b3Jlc2NlbmNlIChGSSkiOwogICAgaWYgKG5vcm1hbGl6ZUJhc2VsaW5lKSB7CiAgICAgIGlmIChub3JtYWxpemF0aW9uTW9kZSA9PT0gJ2RlbHRhX2Zfb3Zlcl9mJykgewogICAgICAgIHlBeGlzTGFiZWwgPSAizpRGL0YgKE5vcm1hbGl6ZWQpIjsKICAgICAgfSBlbHNlIHsKICAgICAgICB5QXhpc0xhYmVsID0gIkYvRuKCgCAoTm9ybWFsaXplZCkiOwogICAgICB9CiAgICB9CiAgICBpZiAoY2hhcnQpIHsKICAgICAgLy8gVHJhbnNmb3JtIGV4aXN0aW5nIGNoYXJ0CiAgICAgIGNoYXJ0LmRhdGEuZGF0YXNldHMgPSBbXTsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueC50aXRsZS50ZXh0ID0gIlRpbWUgKHMpIjsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueS50aXRsZS50ZXh0ID0geUF4aXNMYWJlbDsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueS5taW4gPSB1bmRlZmluZWQ7CiAgICAgIGNoYXJ0Lm9wdGlvbnMucGx1Z2lucy50aXRsZS50ZXh0ID0gIlNlbGVjdCB3ZWxscyB0byBkaXNwbGF5IGRhdGEiOwogICAgICBjaGFydC51cGRhdGUoJ25vbmUnKTsgLy8gVXBkYXRlIHdpdGhvdXQgYW5pbWF0aW9uCiAgICB9IGVsc2UgewogICAgICAvLyBDcmVhdGUgbmV3IGNoYXJ0IG9ubHkgaWYgaXQgZG9lc24ndCBleGlzdAogICAgICBjaGFydCA9IG5ldyBDaGFydChjdHgsIHsKICAgICAgICB0eXBlOiAibGluZSIsCiAgICAgICAgZGF0YTogeyBkYXRhc2V0czogW10gfSwKICAgICAgICBvcHRpb25zOiB7CiAgICAgICAgICByZXNwb25zaXZlOiB0cnVlLAogICAgICAgICAgbWFpbnRhaW5Bc3BlY3RSYXRpbzogZmFsc2UsCiAgICAgICAgICBzY2FsZXM6IHsKICAgICAgICAgICAgeDogeyAKICAgICAgICAgICAgICB0eXBlOiAibGluZWFyIiwgCiAgICAgICAgICAgICAgdGl0bGU6IHsgZGlzcGxheTogdHJ1ZSwgdGV4dDogIlRpbWUgKHMpIiB9IAogICAgICAgICAgICB9LAogICAgICAgICAgICB5OiB7IAogICAgICAgICAgICAgIHRpdGxlOiB7IGRpc3BsYXk6IHRydWUsIHRleHQ6IHlBeGlzTGFiZWwgfSwKICAgICAgICAgICAgICBtaW46IHVuZGVmaW5lZAogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgcGx1Z2luczogewogICAgICAgICAgICBsZWdlbmQ6IHsgZGlzcGxheTogZmFsc2UgfSwKICAgICAgICAgICAgdGl0bGU6IHsgZGlzcGxheTogdHJ1ZSwgdGV4dDogIlNlbGVjdCB3ZWxscyB0byBkaXNwbGF5IGRhdGEiIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuOwogIH0KCiAgY29uc3QgZGF0YXNldHMgPSBbXTsKICBjb25zdCBjb2xvcnMgPSBbCiAgICAicmdiYSg1NCwgMTYyLCAyMzUsIDEuMCkiLAogICAgInJnYmEoMjU1LCA5OSwgMTMyLCAxLjApIiwKICAgICJyZ2JhKDI1NSwgMjA2LCA4NiwgMS4wKSIsCiAgICAicmdiYSg3NSwgMTkyLCAxOTIsIDEuMCkiLAogICAgInJnYmEoMTUzLCAxMDIsIDI1NSwgMS4wKSIsCiAgICAicmdiYSgyNTUsIDE1OSwgNjQsIDEuMCkiLAogICAgInJnYmEoMTk5LCAxOTksIDE5OSwgMS4wKSIsCiAgICAicmdiYSg4MywgMTAyLCAyNTUsIDEuMCkiCiAgXTsKICAKICBsZXQgY29sb3JJZHggPSAwOwogIAogIC8vIFNURVAgMDogQWRkIGluZGl2aWR1YWwgd2VsbHMgKHJhdyBkYXRhLCBiZWZvcmUgYW55IHByb2Nlc3NpbmcpIGlmIGVuYWJsZWQKICBpZiAoc2hvd0luZGl2aWR1YWxXZWxscykgewogICAgQXJyYXkuZnJvbShzZWxlY3RlZFdlbGxzKS5mb3JFYWNoKGtleSA9PiB7CiAgICAgIGNvbnN0IFtwbGF0ZUlkLCB3ZWxsSWRdID0ga2V5LnNwbGl0KCI6Iik7CiAgICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgICAgCiAgICAgIC8vIEZpbHRlciBieSBlbmFibGVkQ29sdW1ucyBpZiBhbnkgYXJlIHNldAogICAgICBpZiAoZW5hYmxlZENvbHVtbnMuc2l6ZSA+IDAgJiYgIWVuYWJsZWRDb2x1bW5zLmhhcyhjb2x1bW4pKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIAogICAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZFdlbGxzIGlmIGFueSBhcmUgc2V0CiAgICAgIGlmIChlbmFibGVkV2VsbHMuc2l6ZSA+IDAgJiYgIWVuYWJsZWRXZWxscy5oYXMod2VsbElkKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAKICAgICAgaWYgKGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSAmJiBhbGxXZWxsc0RhdGFbcGxhdGVJZF1bd2VsbElkXSkgewogICAgICAgIGNvbnN0IHdlbGxEYXRhID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdW3dlbGxJZF07CiAgICAgICAgY29uc3QgcGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gcGxhdGVJZCk7CiAgICAgICAgY29uc3QgZmlsZW5hbWUgPSBwbGF0ZSA/IChwbGF0ZS5maWxlIHx8IHBsYXRlLmlkKSA6IHBsYXRlSWQ7CiAgICAgICAgY29uc3QgY29uZmlnID0gdmlld2VyRGF0YS5jb25maWcgfHwge307CiAgICAgICAgY29uc3Qgd2VsbExhYmVscyA9IGNvbmZpZy53ZWxsX2xhYmVscyB8fCB7fTsKICAgICAgICBjb25zdCByb3dMZXR0ZXIgPSBnZXRSb3dMZXR0ZXIod2VsbElkKTsKICAgICAgICBjb25zdCBpc0NvbnRyb2wgPSBpc0NvbnRyb2xXZWxsKHdlbGxJZCk7CiAgICAgICAgY29uc3QgbGFiZWwgPSB3ZWxsTGFiZWxzW3Jvd0xldHRlcl0gfHwgd2VsbERhdGEubGFiZWwgfHwgd2VsbERhdGEuY29udGVudCB8fCBgV2VsbCAke3dlbGxJZH1gOwogICAgICAgIGNvbnN0IGZvcm1hdHRlZExhYmVsID0gZm9ybWF0TGFiZWwobGFiZWwpOwogICAgICAgIAogICAgICAgIC8vIFVzZSByYXcgZGF0YSAobm90IHByb2Nlc3NlZCkgZm9yIFN0ZXAgMAogICAgICAgIGNvbnN0IGNvbG9yID0gY29sb3JzW2NvbG9ySWR4ICUlIGNvbG9ycy5sZW5ndGhdOwogICAgICAgIGNvbG9ySWR4Kys7CiAgICAgICAgCiAgICAgICAgLy8gQWRkICJDb250cm9sIiBzdWZmaXggZm9yIGNvbnRyb2wgd2VsbHMKICAgICAgICBjb25zdCBkaXNwbGF5TGFiZWwgPSBpc0NvbnRyb2wgCiAgICAgICAgICA/IGAke3dlbGxJZH0gLSAke2Zvcm1hdHRlZExhYmVsfSBDb250cm9sIENvbCAke2NvbHVtbn1gCiAgICAgICAgICA6IGAke3dlbGxJZH0gLSAke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59YDsKICAgICAgICAKICAgICAgICBkYXRhc2V0cy5wdXNoKHsKICAgICAgICAgIGxhYmVsOiBkaXNwbGF5TGFiZWwsCiAgICAgICAgICBkYXRhOiB3ZWxsRGF0YS50aW1lX3MubWFwKCh0LCBpKSA9PiAoeyB4OiB0LCB5OiB3ZWxsRGF0YS52YWx1ZXNbaV0gfSkpLmZpbHRlcihkID0+IGQueSAhPT0gbnVsbCAmJiBkLnggIT09IG51bGwpLAogICAgICAgICAgYm9yZGVyQ29sb3I6IGNvbG9yLnJlcGxhY2UoIjEuMCIsICIwLjUiKSwgLy8gTGlnaHRlciBjb2xvciBmb3IgcmF3IGRhdGEKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogInRyYW5zcGFyZW50IiwKICAgICAgICAgIHRlbnNpb246IDAuMTUsCiAgICAgICAgICBwb2ludFJhZGl1czogMS41LAogICAgICAgICAgYm9yZGVyV2lkdGg6IDEsCiAgICAgICAgICBib3JkZXJEYXNoOiBbMywgM10sIC8vIERhc2hlZCBsaW5lIGZvciByYXcgZGF0YQogICAgICAgICAgZmlsbDogZmFsc2UKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfQogIAoKICAvLyBHcm91cCBzZWxlY3RlZCB3ZWxscyBieSB0cmlwbGljYXRlIGdyb3VwIG9yIGluZGl2aWR1YWwgd2VsbAogIGNvbnN0IGdyb3VwZWRTZWxlY3Rpb25zID0ge307CiAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICAKICAvLyBncm91cFRyaXBsaWNhdGVzIGFscmVhZHkgZGVmaW5lZCBhYm92ZQogIAogIC8vIEZpcnN0IHBhc3M6IGlkZW50aWZ5IGFsbCB0cmlwbGljYXRlIGdyb3VwcyBmcm9tIHNlbGVjdGVkIHdlbGxzCiAgLy8gT25seSBncm91cCBpbnRvIHRyaXBsaWNhdGVzIGlmIFN0ZXAgMiBpcyBlbmFibGVkCiAgY29uc3QgdHJpcGxpY2F0ZUdyb3Vwc0ZvdW5kID0gbmV3IE1hcCgpOyAvLyBncm91cEtleSAtPiB7IG5hbWUsIGNvbHVtbiwgd2VsbHM6IFNldCBvZiB3ZWxsSWRzIH0KICAKICBBcnJheS5mcm9tKHNlbGVjdGVkV2VsbHMpLmZvckVhY2goa2V5ID0+IHsKICAgIGNvbnN0IFtwbGF0ZUlkLCB3ZWxsSWRdID0ga2V5LnNwbGl0KCI6Iik7CiAgICBjb25zdCBjb2x1bW4gPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAKICAgIC8vIEZpbHRlciBieSBlbmFibGVkQ29sdW1ucyBpZiBhbnkgYXJlIHNldAogICAgaWYgKGVuYWJsZWRDb2x1bW5zLnNpemUgPiAwICYmICFlbmFibGVkQ29sdW1ucy5oYXMoY29sdW1uKSkgewogICAgICByZXR1cm47IC8vIFNraXAgd2VsbHMgZnJvbSBkaXNhYmxlZCBjb2x1bW5zCiAgICB9CiAgICAKICAgIC8vIEZpbHRlciBieSBlbmFibGVkV2VsbHMgaWYgYW55IGFyZSBzZXQgKGV4Y2x1ZGUgd2VsbHMpCiAgICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCkpIHsKICAgICAgcmV0dXJuOyAvLyBTa2lwIGV4Y2x1ZGVkIHdlbGxzCiAgICB9CiAgICAKICAgIGNvbnN0IGlzQ29udHJvbCA9IGlzQ29udHJvbFdlbGwod2VsbElkKTsKICAgIAogICAgLy8gQ29udHJvbHMgYXJlIGFsd2F5cyBoYW5kbGVkIGFzIGluZGl2aWR1YWwgd2VsbHMgKG5vIGdyb3VwaW5nKQogICAgaWYgKGlzQ29udHJvbCkgewogICAgICByZXR1cm47IC8vIFNraXAgY29udHJvbHMgLSB0aGV5J2xsIGJlIGhhbmRsZWQgYXMgaW5kaXZpZHVhbCB3ZWxscyBpbiB0aGUgdGhpcmQgcGFzcwogICAgfQogICAgCiAgICAvLyBTVEVQIDI6IE9ubHkgZ3JvdXAgaW50byB0cmlwbGljYXRlcyBpZiBncm91cGluZyBpcyBlbmFibGVkCiAgICBpZiAoZ3JvdXBUcmlwbGljYXRlcykgewogICAgICBjb25zdCB0cmlwbGljYXRlR3JvdXAgPSBnZXRUcmlwbGljYXRlR3JvdXAod2VsbElkLCBjb2x1bW4pOwogICAgICBpZiAodHJpcGxpY2F0ZUdyb3VwKSB7CiAgICAgICAgLy8gQ3JlYXRlIGdyb3VwIGtleSB0aGF0IGluY2x1ZGVzIGNvbHVtbiB0byBzZXBhcmF0ZSBzYW1lIHBhdHRlcm4gYWNyb3NzIGNvbHVtbnMKICAgICAgICBjb25zdCBncm91cEtleSA9IGAke3RyaXBsaWNhdGVHcm91cC5uYW1lfV9jb2wke2NvbHVtbn1gOwogICAgICAgIGlmICghdHJpcGxpY2F0ZUdyb3Vwc0ZvdW5kLmhhcyhncm91cEtleSkpIHsKICAgICAgICAgIC8vIEdldCByb3cgbGV0dGVycyBmcm9tIHRoZSB0cmlwbGljYXRlIGdyb3VwIHBhdHRlcm4KICAgICAgICAgIGNvbnN0IGdyb3VwUm93TGV0dGVycyA9IGdldFJvd0xldHRlcnNGcm9tV2VsbHModHJpcGxpY2F0ZUdyb3VwLndlbGxzKTsKICAgICAgICAgIC8vIENyZWF0ZSB3ZWxsIElEcyBmb3IgdGhpcyBjb2x1bW4gdXNpbmcgdGhlIHJvdyBwYXR0ZXJuCiAgICAgICAgICBjb25zdCB3ZWxsSWRzRm9yQ29sdW1uID0gZ3JvdXBSb3dMZXR0ZXJzLm1hcChyb3cgPT4gcm93ICsgY29sdW1uKTsKICAgICAgICAgIAogICAgICAgICAgdHJpcGxpY2F0ZUdyb3Vwc0ZvdW5kLnNldChncm91cEtleSwgewogICAgICAgICAgICBuYW1lOiB0cmlwbGljYXRlR3JvdXAubmFtZSwKICAgICAgICAgICAgY29sdW1uOiBjb2x1bW4sCiAgICAgICAgICAgIHdlbGxJZHM6IG5ldyBTZXQod2VsbElkc0ZvckNvbHVtbikKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLy8gSWYgZ3JvdXBpbmcgaXMgZGlzYWJsZWQsIHdlbGxzIHdpbGwgYmUgaGFuZGxlZCBhcyBpbmRpdmlkdWFsIHdlbGxzIGluIHRoZSB0aGlyZCBwYXNzCiAgfSk7CiAgCiAgLy8gU2Vjb25kIHBhc3M6IGJ1aWxkIGdyb3VwZWQgc2VsZWN0aW9ucyBmb3IgdHJpcGxpY2F0ZSBncm91cHMKICB0cmlwbGljYXRlR3JvdXBzRm91bmQuZm9yRWFjaCgoZ3JvdXBJbmZvLCBncm91cEtleSkgPT4gewogICAgZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldID0gewogICAgICB0eXBlOiAidHJpcGxpY2F0ZSIsCiAgICAgIHdlbGxzOiBbXSwKICAgICAgbmFtZTogZ3JvdXBJbmZvLm5hbWUKICAgIH07CiAgICAKICAgIC8vIENvbGxlY3Qgd2VsbHMgZnJvbSBkYXRhc2V0cyB0aGF0IGhhdmUgc2VsZWN0ZWQgd2VsbHMgaW4gdGhpcyB0cmlwbGljYXRlIGdyb3VwCiAgICBBcnJheS5mcm9tKHNlbGVjdGVkV2VsbHMpLmZvckVhY2goa2V5ID0+IHsKICAgICAgY29uc3QgW3BsYXRlSWQsIHdlbGxJZF0gPSBrZXkuc3BsaXQoIjoiKTsKICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgICBpZiAoZ3JvdXBJbmZvLndlbGxJZHMuaGFzKHdlbGxJZCkgJiYgY29sdW1uID09PSBncm91cEluZm8uY29sdW1uKSB7CiAgICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICAgICAgaWYgKHdlbGxzW3dlbGxJZF0pIHsKICAgICAgICAgIC8vIENoZWNrIGlmIGFscmVhZHkgYWRkZWQKICAgICAgICAgIGNvbnN0IGV4aXN0cyA9IGdyb3VwZWRTZWxlY3Rpb25zW2dyb3VwS2V5XS53ZWxscy5zb21lKAogICAgICAgICAgICB3ID0+IHcud2VsbElkID09PSB3ZWxsSWQgJiYgdy5wbGF0ZUlkID09PSBwbGF0ZUlkCiAgICAgICAgICApOwogICAgICAgICAgaWYgKCFleGlzdHMpIHsKICAgICAgICAgICAgLy8gU1RFUCAxOiBBcHBseSBub3JtYWxpemF0aW9uIHVzaW5nIGZpdHRlZCBiYXNlbGluZSBpZiBlbmFibGVkIChtdXN0IGhhcHBlbiBiZWZvcmUgZ3JvdXBpbmcpCiAgICAgICAgICAgIGxldCBwcm9jZXNzZWRXZWxsRGF0YSA9IHdlbGxzW3dlbGxJZF07CiAgICAgICAgICAgIGlmIChub3JtYWxpemVCYXNlbGluZSkgewogICAgICAgICAgICAgIHByb2Nlc3NlZFdlbGxEYXRhID0gbm9ybWFsaXplV2l0aEZpdHRlZEJhc2VsaW5lKAogICAgICAgICAgICAgICAgcHJvY2Vzc2VkV2VsbERhdGEsCiAgICAgICAgICAgICAgICBub3JtYWxpemVCYXNlbGluZUVuZFRpbWUsCiAgICAgICAgICAgICAgICBiYXNlbGluZU1ldGhvZCwKICAgICAgICAgICAgICAgIGJhc2VsaW5lRnJhYywKICAgICAgICAgICAgICAgIGJhc2VsaW5lUG9seU9yZGVyLAogICAgICAgICAgICAgICAgbm9ybWFsaXphdGlvbk1vZGUKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICghcHJvY2Vzc2VkV2VsbERhdGEpIHJldHVybjsgLy8gU2tpcCBpZiBub3JtYWxpemF0aW9uIGZhaWxlZAogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEFkZCB0byBncm91cCAoU3RlcCAyIGhhcHBlbnMgaGVyZSAtIGdyb3VwaW5nKQogICAgICAgICAgICAvLyBTdGVwIDMgKGF2ZXJhZ2luZykgd2lsbCBiZSBhcHBsaWVkIGxhdGVyCiAgICAgICAgICAgIGdyb3VwZWRTZWxlY3Rpb25zW2dyb3VwS2V5XS53ZWxscy5wdXNoKHsKICAgICAgICAgICAgICB3ZWxsSWQ6IHdlbGxJZCwKICAgICAgICAgICAgICBwbGF0ZUlkOiBwbGF0ZUlkLAogICAgICAgICAgICAgIGRhdGE6IHByb2Nlc3NlZFdlbGxEYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSk7CiAgCiAgLy8gVGhpcmQgcGFzczogaGFuZGxlIGluZGl2aWR1YWwgd2VsbHMgKHNraXAgaWYgYWxyZWFkeSBpbiB0cmlwbGljYXRlIGdyb3VwKQogIEFycmF5LmZyb20oc2VsZWN0ZWRXZWxscykuZm9yRWFjaChrZXkgPT4gewogICAgLy8gVmVyaWZ5IHRoaXMgd2VsbCBpcyBzdGlsbCBzZWxlY3RlZCAobWF5IGhhdmUgYmVlbiBkZXNlbGVjdGVkKQogICAgaWYgKCFzZWxlY3RlZFdlbGxzLmhhcyhrZXkpKSB7CiAgICAgIHJldHVybjsgLy8gU2tpcCB3ZWxscyB0aGF0IGFyZSBubyBsb25nZXIgc2VsZWN0ZWQKICAgIH0KICAgIAogICAgY29uc3QgW3BsYXRlSWQsIHdlbGxJZF0gPSBrZXkuc3BsaXQoIjoiKTsKICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgIGNvbnN0IGlzQ29udHJvbCA9IGlzQ29udHJvbFdlbGwod2VsbElkKTsKICAgIAogICAgLy8gQ29udHJvbHMgYXJlIGFsd2F5cyBoYW5kbGVkIGFzIGluZGl2aWR1YWwgd2VsbHMgKG5vIGdyb3VwaW5nKQogICAgaWYgKGlzQ29udHJvbCkgewogICAgICAvLyBDb250aW51ZSB0byBwcm9jZXNzIGFzIGluZGl2aWR1YWwgd2VsbAogICAgfSBlbHNlIHsKICAgICAgLy8gU1RFUCAyOiBDaGVjayBpZiB0aGlzIHdlbGwgaXMgcGFydCBvZiBhIHRyaXBsaWNhdGUgZ3JvdXAgd2UndmUgYWxyZWFkeSBwcm9jZXNzZWQKICAgICAgLy8gT25seSBza2lwIGlmIGdyb3VwaW5nIGlzIGVuYWJsZWQgYW5kIHRoaXMgd2VsbCB3YXMgZ3JvdXBlZAogICAgICBpZiAoZ3JvdXBUcmlwbGljYXRlcykgewogICAgICAgIGNvbnN0IHRyaXBsaWNhdGVHcm91cCA9IGdldFRyaXBsaWNhdGVHcm91cCh3ZWxsSWQsIGNvbHVtbik7CiAgICAgICAgaWYgKHRyaXBsaWNhdGVHcm91cCkgewogICAgICAgICAgLy8gQWxyZWFkeSBoYW5kbGVkIGluIHRyaXBsaWNhdGVHcm91cHNGb3VuZCAtIHNraXAKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIAogICAgLy8gRmlsdGVyIGJ5IGVuYWJsZWRXZWxscyBpZiBhbnkgYXJlIHNldAogICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3ZWxsSWQpKSB7CiAgICAgIHJldHVybjsgLy8gU2tpcCBleGNsdWRlZCB3ZWxscwogICAgfQogICAgCiAgICAvLyBJbmRpdmlkdWFsIHdlbGwgKG5vdCBwYXJ0IG9mIGEgdHJpcGxpY2F0ZSBncm91cCkKICAgIGNvbnN0IGdyb3VwS2V5ID0gYHdlbGxfJHt3ZWxsSWR9YDsKICAgIGlmICghZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldKSB7CiAgICAgIGNvbnN0IGNvbmZpZyA9IHZpZXdlckRhdGEuY29uZmlnIHx8IHt9OwogICAgICBjb25zdCB3ZWxsTGFiZWxzID0gY29uZmlnLndlbGxfbGFiZWxzIHx8IHt9OwogICAgICAvLyBHZXQgbGFiZWwgZnJvbSByb3ctYmFzZWQgY29uZmlnIG9yIHdlbGwgZGF0YQogICAgICBjb25zdCByb3dMZXR0ZXIgPSBnZXRSb3dMZXR0ZXIod2VsbElkKTsKICAgICAgbGV0IGxhYmVsID0gd2VsbExhYmVsc1tyb3dMZXR0ZXJdOwogICAgICBpZiAoIWxhYmVsKSB7CiAgICAgICAgZm9yIChjb25zdCBwSWQgb2Ygc2VsZWN0ZWREYXRhc2V0cykgewogICAgICAgICAgaWYgKGFsbFdlbGxzRGF0YVtwSWRdICYmIGFsbFdlbGxzRGF0YVtwSWRdW3dlbGxJZF0pIHsKICAgICAgICAgICAgbGFiZWwgPSBhbGxXZWxsc0RhdGFbcElkXVt3ZWxsSWRdLmxhYmVsIHx8IGFsbFdlbGxzRGF0YVtwSWRdW3dlbGxJZF0uY29udGVudCB8fCBgV2VsbCAke3dlbGxJZH1gOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldID0gewogICAgICAgIHR5cGU6ICJzaW5nbGUiLAogICAgICAgIHdlbGxzOiBbXSwKICAgICAgICBsYWJlbDogZm9ybWF0TGFiZWwobGFiZWwpIHx8IGBXZWxsICR7d2VsbElkfWAKICAgICAgfTsKICAgIH0KICAgIAogICAgLy8gQWRkIHRoaXMgd2VsbCdzIGRhdGEgaWYgaXQgZXhpc3RzCiAgICBpZiAoYWxsV2VsbHNEYXRhW3BsYXRlSWRdICYmIGFsbFdlbGxzRGF0YVtwbGF0ZUlkXVt3ZWxsSWRdKSB7CiAgICAgIGNvbnN0IGV4aXN0aW5nID0gZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldLndlbGxzLmZpbmQodyA9PiB3LndlbGxJZCA9PT0gd2VsbElkICYmIHcucGxhdGVJZCA9PT0gcGxhdGVJZCk7CiAgICAgIGlmICghZXhpc3RpbmcpIHsKICAgICAgICAgIC8vIFNURVAgMTogQXBwbHkgbm9ybWFsaXphdGlvbiB1c2luZyBmaXR0ZWQgYmFzZWxpbmUgaWYgZW5hYmxlZCAobXVzdCBoYXBwZW4gYmVmb3JlIGdyb3VwaW5nKQogICAgICAgICAgbGV0IHByb2Nlc3NlZFdlbGxEYXRhID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdW3dlbGxJZF07CiAgICAgICAgICBpZiAobm9ybWFsaXplQmFzZWxpbmUpIHsKICAgICAgICAgICAgcHJvY2Vzc2VkV2VsbERhdGEgPSBub3JtYWxpemVXaXRoRml0dGVkQmFzZWxpbmUoCiAgICAgICAgICAgICAgcHJvY2Vzc2VkV2VsbERhdGEsCiAgICAgICAgICAgICAgbm9ybWFsaXplQmFzZWxpbmVFbmRUaW1lLAogICAgICAgICAgICAgIGJhc2VsaW5lTWV0aG9kLAogICAgICAgICAgICAgIGJhc2VsaW5lRnJhYywKICAgICAgICAgICAgICBiYXNlbGluZVBvbHlPcmRlciwKICAgICAgICAgICAgICBub3JtYWxpemF0aW9uTW9kZQogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoIXByb2Nlc3NlZFdlbGxEYXRhKSByZXR1cm47IC8vIFNraXAgaWYgbm9ybWFsaXphdGlvbiBmYWlsZWQKICAgICAgICAgIH0KICAgICAgICAgIC8vIFNURVAgNDogQXBwbHkgbm9ybWFsaXphdGlvbiB1c2luZyBmaXR0ZWQgYmFzZWxpbmUgaWYgZW5hYmxlZAogICAgICAgICAgaWYgKG5vcm1hbGl6ZUJhc2VsaW5lKSB7CiAgICAgICAgICAgIHByb2Nlc3NlZFdlbGxEYXRhID0gbm9ybWFsaXplV2l0aEZpdHRlZEJhc2VsaW5lKAogICAgICAgICAgICAgIHByb2Nlc3NlZFdlbGxEYXRhLAogICAgICAgICAgICAgIG5vcm1hbGl6ZUJhc2VsaW5lRW5kVGltZSwKICAgICAgICAgICAgICBiYXNlbGluZU1ldGhvZCwKICAgICAgICAgICAgICBiYXNlbGluZUZyYWMsCiAgICAgICAgICAgICAgYmFzZWxpbmVQb2x5T3JkZXIsCiAgICAgICAgICAgICAgbm9ybWFsaXphdGlvbk1vZGUKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKCFwcm9jZXNzZWRXZWxsRGF0YSkgcmV0dXJuOyAvLyBTa2lwIGlmIG5vcm1hbGl6YXRpb24gZmFpbGVkCiAgICAgICAgICB9CiAgICAgICAgICAvLyBBZGQgdG8gZ3JvdXAgKFN0ZXAgMiBoYXBwZW5zIGhlcmUgLSBncm91cGluZykKICAgICAgICAgIC8vIFN0ZXAgMyAoYXZlcmFnaW5nKSB3aWxsIGJlIGFwcGxpZWQgbGF0ZXIKICAgICAgICAgIGdyb3VwZWRTZWxlY3Rpb25zW2dyb3VwS2V5XS53ZWxscy5wdXNoKHsKICAgICAgICAgIHdlbGxJZCwgCiAgICAgICAgICBwbGF0ZUlkLCAKICAgICAgICAgIGRhdGE6IHByb2Nlc3NlZFdlbGxEYXRhCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9KTsKICAKICAvLyBDb250aW51ZSB3aXRoIGdyb3VwZWQgc2VsZWN0aW9ucyAoY29sb3JJZHggYWxyZWFkeSBpbml0aWFsaXplZCBmb3IgU3RlcCAwKQogIC8vIFByb2Nlc3MgZ3JvdXBlZCBzZWxlY3Rpb25zIHdoZW46CiAgLy8gMS4gU3RlcCAwIGlzIG5vdCBzaG93aW5nIChiZWNhdXNlIG90aGVyIHN0ZXBzIGFyZSBlbmFibGVkKSwgT1IKICAvLyAyLiBQcm9jZXNzaW5nIHN0ZXBzIGFyZSBlbmFibGVkICh3aGljaCBhdXRvbWF0aWNhbGx5IGRpc2FibGVzIFN0ZXAgMCkKICAvLyBUaGlzIGVuc3VyZXMgZGF0YSBhbHdheXMgc2hvd3MgLSBlaXRoZXIgU3RlcCAwIGluZGl2aWR1YWwgd2VsbHMgT1IgZ3JvdXBlZCBzZWxlY3Rpb25zCiAgaWYgKCFzaG93SW5kaXZpZHVhbFdlbGxzKSB7CiAgICBPYmplY3Qua2V5cyhncm91cGVkU2VsZWN0aW9ucykuZm9yRWFjaChncm91cEtleSA9PiB7CiAgICAgIGNvbnN0IGdyb3VwID0gZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldOwogICAgICAKICAgICAgLy8gRmlsdGVyIG91dCBhbnkgd2VsbHMgdGhhdCBhcmUgbm8gbG9uZ2VyIHNlbGVjdGVkIG9yIGFyZSBleGNsdWRlZAogICAgICBncm91cC53ZWxscyA9IGdyb3VwLndlbGxzLmZpbHRlcih3ID0+IHsKICAgICAgICBjb25zdCBrZXkgPSBgJHt3LnBsYXRlSWR9OiR7dy53ZWxsSWR9YDsKICAgICAgICAvLyBDaGVjayBpZiBzdGlsbCBzZWxlY3RlZAogICAgICAgIGlmICghc2VsZWN0ZWRXZWxscy5oYXMoa2V5KSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICAvLyBDaGVjayBpZiBleGNsdWRlZCB2aWEgZW5hYmxlZFdlbGxzCiAgICAgICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3LndlbGxJZCkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgICAKICAgICAgLy8gU2tpcCBncm91cHMgd2l0aCBubyB3ZWxscyBhZnRlciBmaWx0ZXJpbmcKICAgICAgaWYgKGdyb3VwLndlbGxzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybjsgLy8gU2tpcCB0byBuZXh0IGdyb3VwCiAgICAgIH0KICAgICAgCiAgICAgIGNvbnN0IGNvbG9yID0gY29sb3JzW2NvbG9ySWR4ICUlIGNvbG9ycy5sZW5ndGhdOwogICAgICBjb2xvcklkeCsrOwoKICAgIGlmIChncm91cC50eXBlID09PSAidHJpcGxpY2F0ZSIgJiYgZ3JvdXAud2VsbHMubGVuZ3RoID4gMCkgewogICAgICAvLyBTVEVQIDM6IEF2ZXJhZ2Ugd2l0aGluIHRyaXBsaWNhdGUgZ3JvdXAKICAgICAgY29uc3QgcmVzdWx0ID0gcHJvY2Vzc1dlbGxzQW5kQ2FsY3VsYXRlTWVhbigKICAgICAgICBncm91cC53ZWxscy5tYXAodyA9PiB3LmRhdGEpLAogICAgICAgIGZhbHNlLCAvLyBObyBub3JtYWxpemF0aW9uCiAgICAgICAgMCwgLy8gYmFzZWxpbmVFbmRUaW1lIG5vdCB1c2VkCiAgICAgICAgOTk5OTk5IC8vIGN1dG9mZlRpbWUgbm90IHVzZWQKICAgICAgKTsKICAgICAgY29uc3QgdGltZVBvaW50cyA9IHJlc3VsdC5maWx0ZXJlZFRpbWVQb2ludHM7CiAgICAgIGNvbnN0IG1lYW5zID0gcmVzdWx0Lm5vcm1hbGl6ZWRNZWFuczsKICAgICAgY29uc3QgZXJyb3JzID0gcmVzdWx0Lm5vcm1hbGl6ZWRFcnJvcnM7CiAgICAgIAogICAgICAvLyBDcmVhdGUgZGF0YXNldCB3aXRoIG1lYW4gYW5kIGVycm9yIGluZm9ybWF0aW9uCiAgICAgIGNvbnN0IGxpbmVEYXRhID0gdGltZVBvaW50cy5tYXAoKHQsIGkpID0+IHsKICAgICAgICBjb25zdCBwb2ludCA9IHsKICAgICAgICAgIHg6IHQsCiAgICAgICAgICB5OiBtZWFuc1tpXSwKICAgICAgICAgIGVycm9yOiBlcnJvcnNbaV0KICAgICAgICB9OwogICAgICAgIHJldHVybiBwb2ludDsKICAgICAgfSkuZmlsdGVyKGQgPT4gZC55ICE9PSBudWxsKTsKICAgICAgCiAgICAgIC8vIEdldCBncm91cCBuYW1lIGZyb20gZmlyc3Qgd2VsbCdzIHBsYXRlCiAgICAgIGNvbnN0IGZpcnN0UGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gZ3JvdXAud2VsbHNbMF0ucGxhdGVJZCk7CiAgICAgIGNvbnN0IGNvbHVtbkdyb3VwTmFtZSA9IGZpcnN0UGxhdGUgPyBmaXJzdFBsYXRlLmNvbHVtbl9ncm91cCA6ICIiOwogICAgICBjb25zdCBkYXRhc2V0Q291bnQgPSBuZXcgU2V0KGdyb3VwLndlbGxzLm1hcCh3ID0+IHcucGxhdGVJZCkpLnNpemU7CiAgICAgIGNvbnN0IHdlbGxDb3VudCA9IGdyb3VwLndlbGxzLmxlbmd0aDsKICAgICAgCiAgICAgIC8vIENyZWF0ZSBhcHByb3ByaWF0ZSBsYWJlbCBiYXNlZCBvbiBudW1iZXIgb2YgcmVwbGljYXRlcwogICAgICBsZXQgcmVwbGljYXRlTGFiZWwgPSAiIjsKICAgICAgaWYgKHdlbGxDb3VudCA9PT0gMykgewogICAgICAgIHJlcGxpY2F0ZUxhYmVsID0gInRyaXBsaWNhdGUiOwogICAgICB9IGVsc2UgaWYgKHdlbGxDb3VudCA9PT0gNikgewogICAgICAgIHJlcGxpY2F0ZUxhYmVsID0gImhleHBsaWNhdGUiOwogICAgICB9IGVsc2UgaWYgKHdlbGxDb3VudCA9PT0gOSkgewogICAgICAgIHJlcGxpY2F0ZUxhYmVsID0gIm5vbnVwbGljYXRlIjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXBsaWNhdGVMYWJlbCA9IGAke3dlbGxDb3VudH0tcGxpY2F0ZWA7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIEdldCBjb2x1bW4gbnVtYmVyIGZyb20gZmlyc3Qgd2VsbAogICAgICBjb25zdCBmaXJzdFdlbGxJZCA9IGdyb3VwLndlbGxzWzBdLndlbGxJZDsKICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZChmaXJzdFdlbGxJZCk7CiAgICAgIAogICAgICAvLyBBZGQgd2VsbCBJRHMgd2hlbiBTdGVwIDEgKG5vcm1hbGl6YXRpb24pIGlzIGVuYWJsZWQKICAgICAgbGV0IHdlbGxJZHNQcmVmaXggPSAiIjsKICAgICAgaWYgKG5vcm1hbGl6ZUJhc2VsaW5lICYmIGdyb3VwLndlbGxzLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCB3ZWxsSWRzID0gZ3JvdXAud2VsbHMubWFwKHcgPT4gdy53ZWxsSWQpLmpvaW4oIiwgIik7CiAgICAgICAgd2VsbElkc1ByZWZpeCA9IGAke3dlbGxJZHN9IC0gYDsKICAgICAgfQogICAgICAKICAgICAgY29uc3QgbGFiZWxTdWZmaXggPSBkYXRhc2V0Q291bnQgPiAxIAogICAgICAgID8gYCAoJHtyZXBsaWNhdGVMYWJlbH0sICR7ZGF0YXNldENvdW50fSBkYXRhc2V0cywgbWVhbiDCsSBTRSlgIAogICAgICAgIDogYCAoJHtyZXBsaWNhdGVMYWJlbH0sIG1lYW4gwrEgU0UpYDsKICAgICAgY29uc3QgZm9ybWF0dGVkTmFtZSA9IGZvcm1hdExhYmVsKGdyb3VwLm5hbWUpOwogICAgICBjb25zdCBsYWJlbCA9IGNvbHVtbkdyb3VwTmFtZSAKICAgICAgICA/IGAke3dlbGxJZHNQcmVmaXh9JHtmb3JtYXR0ZWROYW1lfSAoJHtjb2x1bW5Hcm91cE5hbWV9KSBDb2wgJHtjb2x1bW59JHtsYWJlbFN1ZmZpeH1gCiAgICAgICAgOiBgJHt3ZWxsSWRzUHJlZml4fSR7Zm9ybWF0dGVkTmFtZX0gQ29sICR7Y29sdW1ufSR7bGFiZWxTdWZmaXh9YDsKICAgICAgCiAgICAgIGRhdGFzZXRzLnB1c2goewogICAgICAgIGxhYmVsOiBsYWJlbCwKICAgICAgICBkYXRhOiBsaW5lRGF0YSwKICAgICAgICBib3JkZXJDb2xvcjogY29sb3IsCiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBjb2xvci5yZXBsYWNlKCIxLjAiLCAiMC4yIiksCiAgICAgICAgdGVuc2lvbjogMC4xNSwKICAgICAgICBwb2ludFJhZGl1czogMywKICAgICAgICBib3JkZXJXaWR0aDogMiwKICAgICAgICBmaWxsOiBmYWxzZQogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoZ3JvdXAudHlwZSA9PT0gInNpbmdsZSIpIHsKICAgICAgLy8gU2luZ2xlIHdlbGwgLSBjaGVjayBpZiBpdCdzIGEgZHVwbGljYXRlCiAgICAgIGNvbnN0IHdlbGxJZCA9IGdyb3VwLndlbGxzWzBdLndlbGxJZDsKICAgICAgY29uc3QgaXNEdXBsaWNhdGUgPSBpc0R1cGxpY2F0ZVdlbGwod2VsbElkKTsKICAgICAgCiAgICAgIGlmIChncm91cC53ZWxscy5sZW5ndGggPiAxICYmIGlzRHVwbGljYXRlKSB7CiAgICAgICAgLy8gRHVwbGljYXRlIHdlbGwgLSBzaG93IGVhY2ggZGF0YXNldCBzZXBhcmF0ZWx5IGZvciBjb21wYXJpc29uCiAgICAgICAgY29uc3QgbGluZVN0eWxlcyA9IFsic29saWQiLCAiZGFzaGVkIiwgImRvdHRlZCJdOwogICAgICAgIGNvbnN0IGZvcm1hdHRlZExhYmVsID0gZm9ybWF0TGFiZWwoZ3JvdXAubGFiZWwpOwogICAgICAgIAogICAgICAgIGdyb3VwLndlbGxzLmZvckVhY2goKHdlbGwsIGlkeCkgPT4gewogICAgICAgICAgY29uc3QgcGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gd2VsbC5wbGF0ZUlkKTsKICAgICAgICAgIGNvbnN0IGZpbGVuYW1lID0gcGxhdGUgPyAocGxhdGUuZmlsZSB8fCBwbGF0ZS5pZCkgOiB3ZWxsLnBsYXRlSWQ7CiAgICAgICAgICBjb25zdCBsaW5lU3R5bGUgPSBsaW5lU3R5bGVzW2lkeCAlJSBsaW5lU3R5bGVzLmxlbmd0aF07CiAgICAgICAgICAKICAgICAgICAgIC8vIFVzZSBzbGlnaHRseSBkaWZmZXJlbnQgc2hhZGVzIG9mIHRoZSBzYW1lIGNvbG9yIGZvciBkdXBsaWNhdGVzCiAgICAgICAgICBjb25zdCBiYXNlQ29sb3IgPSBjb2xvcjsKICAgICAgICAgIGNvbnN0IGFscGhhID0gMS4wIC0gKGlkeCAqIDAuMTUpOyAvLyBTbGlnaHRseSBmYWRlIGVhY2ggc3Vic2VxdWVudCBsaW5lCiAgICAgICAgICBjb25zdCBhZGp1c3RlZENvbG9yID0gYmFzZUNvbG9yLnJlcGxhY2UoIjEuMCIsIGFscGhhLnRvRml4ZWQoMSkpOwogICAgICAgICAgCiAgICAgICAgICBsZXQgdGltZVBvaW50cyA9IHdlbGwuZGF0YS50aW1lX3M7CiAgICAgICAgICBsZXQgdmFsdWVzID0gd2VsbC5kYXRhLnZhbHVlczsKICAgICAgICAgIAogICAgICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsLndlbGxJZCk7CiAgICAgICAgICAvLyBBZGQgd2VsbCBJRCB3aGVuIFN0ZXAgMSAobm9ybWFsaXphdGlvbikgaXMgZW5hYmxlZAogICAgICAgICAgY29uc3Qgd2VsbElkUHJlZml4ID0gbm9ybWFsaXplQmFzZWxpbmUgPyBgJHt3ZWxsLndlbGxJZH0gLSBgIDogIiI7CiAgICAgICAgICBkYXRhc2V0cy5wdXNoKHsKICAgICAgICAgICAgbGFiZWw6IGAke3dlbGxJZFByZWZpeH0ke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59ICgke2ZpbGVuYW1lfSlgLAogICAgICAgICAgICBkYXRhOiB0aW1lUG9pbnRzLm1hcCgodCwgaSkgPT4gewogICAgICAgICAgICAgIGNvbnN0IHBvaW50ID0geyB4OiB0LCB5OiB2YWx1ZXNbaV0gfTsKICAgICAgICAgICAgICByZXR1cm4gcG9pbnQ7CiAgICAgICAgICAgIH0pLmZpbHRlcihkID0+IGQueSAhPT0gbnVsbCksCiAgICAgICAgICAgIGJvcmRlckNvbG9yOiBhZGp1c3RlZENvbG9yLAogICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICAgIGJvcmRlckRhc2g6IGxpbmVTdHlsZSA9PT0gImRhc2hlZCIgPyBbNSwgNV0gOiBsaW5lU3R5bGUgPT09ICJkb3R0ZWQiID8gWzIsIDJdIDogW10sCiAgICAgICAgICAgIHRlbnNpb246IDAuMTUsCiAgICAgICAgICAgIHBvaW50UmFkaXVzOiAyLAogICAgICAgICAgICBib3JkZXJXaWR0aDogMS41LAogICAgICAgICAgICBmaWxsOiBmYWxzZSwKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKGdyb3VwLndlbGxzLmxlbmd0aCA+IDEpIHsKICAgICAgICAvLyBTVEVQIDM6IEF2ZXJhZ2UgbXVsdGlwbGUgZGF0YXNldHMgZm9yIHNhbWUgd2VsbCAobm90IGR1cGxpY2F0ZSkgLSBjYWxjdWxhdGUgbWVhbiBhbmQgZXJyb3IKICAgICAgICBjb25zdCByZXN1bHQgPSBwcm9jZXNzV2VsbHNBbmRDYWxjdWxhdGVNZWFuKAogICAgICAgICAgZ3JvdXAud2VsbHMubWFwKHcgPT4gdy5kYXRhKSwKICAgICAgICAgIGZhbHNlLCAvLyBObyBub3JtYWxpemF0aW9uCiAgICAgICAgICAwLCAvLyBiYXNlbGluZUVuZFRpbWUgbm90IHVzZWQKICAgICAgICAgIDk5OTk5OSAvLyBjdXRvZmZUaW1lIG5vdCB1c2VkCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0aW1lUG9pbnRzID0gcmVzdWx0LmZpbHRlcmVkVGltZVBvaW50czsKICAgICAgICBjb25zdCBtZWFucyA9IHJlc3VsdC5ub3JtYWxpemVkTWVhbnM7CiAgICAgICAgY29uc3QgZXJyb3JzID0gcmVzdWx0Lm5vcm1hbGl6ZWRFcnJvcnM7CiAgICAgICAgCiAgICAgICAgY29uc3QgbGluZURhdGEgPSB0aW1lUG9pbnRzLm1hcCgodCwgaSkgPT4gewogICAgICAgICAgY29uc3QgcG9pbnQgPSB7CiAgICAgICAgICAgIHg6IHQsCiAgICAgICAgICAgIHk6IG1lYW5zW2ldLAogICAgICAgICAgICBlcnJvcjogZXJyb3JzW2ldCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHBvaW50OwogICAgICAgIH0pLmZpbHRlcihkID0+IGQueSAhPT0gbnVsbCk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZGF0YXNldENvdW50ID0gZ3JvdXAud2VsbHMubGVuZ3RoOwogICAgICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgICAgICBjb25zdCBmb3JtYXR0ZWRMYWJlbCA9IGZvcm1hdExhYmVsKGdyb3VwLmxhYmVsKTsKICAgICAgICAvLyBBZGQgd2VsbCBJRCB3aGVuIFN0ZXAgMSAobm9ybWFsaXphdGlvbikgaXMgZW5hYmxlZAogICAgICAgIGNvbnN0IHdlbGxJZFByZWZpeCA9IG5vcm1hbGl6ZUJhc2VsaW5lID8gYCR7d2VsbElkfSAtIGAgOiAiIjsKICAgICAgICBjb25zdCBsYWJlbCA9IGAke3dlbGxJZFByZWZpeH0ke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59ICgke2RhdGFzZXRDb3VudH0gZGF0YXNldHMsIG1lYW4gwrEgU0UpYDsKICAgICAgICAKICAgICAgICBkYXRhc2V0cy5wdXNoKHsKICAgICAgICAgIGxhYmVsOiBsYWJlbCwKICAgICAgICAgIGRhdGE6IGxpbmVEYXRhLAogICAgICAgICAgYm9yZGVyQ29sb3I6IGNvbG9yLAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBjb2xvci5yZXBsYWNlKCIxLjAiLCAiMC4yIiksCiAgICAgICAgICB0ZW5zaW9uOiAwLjE1LAogICAgICAgICAgcG9pbnRSYWRpdXM6IDMsCiAgICAgICAgICBib3JkZXJXaWR0aDogMiwKICAgICAgICAgIGZpbGw6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU2luZ2xlIGRhdGFzZXQgZm9yIHRoaXMgd2VsbAogICAgICAgIC8vIFNraXAgc2hvd2luZyBwcm9jZXNzZWQgaW5kaXZpZHVhbCB3ZWxscyBpZiBTdGVwIDAgaXMgYWxyZWFkeSBzaG93aW5nIHRoZSByYXcgZGF0YQogICAgICAgIC8vIEJ1dCBvbmx5IHNraXAgaWYgU3RlcCAwIGlzIGFjdHVhbGx5IGVuYWJsZWQgKG5vdCBqdXN0IHJlcXVlc3RlZCkKICAgICAgICBpZiAoc2hvd0luZGl2aWR1YWxXZWxscyAmJiAhYW55UHJvY2Vzc2luZ1N0ZXBFbmFibGVkKSB7CiAgICAgICAgICAvLyBTdGVwIDAgYWxyZWFkeSBzaG93cyB0aGlzIHdlbGwsIHNraXAgdGhlIHByb2Nlc3NlZCB2ZXJzaW9uIHRvIGF2b2lkIGR1cGxpY2F0ZXMKICAgICAgICAgIHJldHVybjsgLy8gU2tpcCB0byBuZXh0IGdyb3VwIGluIGZvckVhY2gKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgY29uc3Qgd2VsbCA9IGdyb3VwLndlbGxzWzBdOwogICAgICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbC53ZWxsSWQpOwogICAgICAgIGNvbnN0IGZvcm1hdHRlZExhYmVsID0gZm9ybWF0TGFiZWwoZ3JvdXAubGFiZWwpOwogICAgICAgIAogICAgICAgIGxldCB0aW1lUG9pbnRzID0gd2VsbC5kYXRhLnRpbWVfczsKICAgICAgICBsZXQgdmFsdWVzID0gd2VsbC5kYXRhLnZhbHVlczsKICAgICAgICAKICAgICAgICAvLyBBZGQgd2VsbCBJRCB3aGVuIFN0ZXAgMSAobm9ybWFsaXphdGlvbikgaXMgZW5hYmxlZAogICAgICAgIGNvbnN0IHdlbGxJZFByZWZpeCA9IG5vcm1hbGl6ZUJhc2VsaW5lID8gYCR7d2VsbC53ZWxsSWR9IC0gYCA6ICIiOwogICAgICAgIGNvbnN0IGxhYmVsID0gZm9ybWF0dGVkTGFiZWwgCiAgICAgICAgICA/IGAke3dlbGxJZFByZWZpeH0ke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59YCAKICAgICAgICAgIDogYCR7d2VsbElkUHJlZml4fVdlbGwgJHt3ZWxsLndlbGxJZH0gQ29sICR7Y29sdW1ufWA7CiAgICAgICAgCiAgICAgICAgZGF0YXNldHMucHVzaCh7CiAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICBkYXRhOiB0aW1lUG9pbnRzLm1hcCgodCwgaSkgPT4gewogICAgICAgICAgICBjb25zdCBwb2ludCA9IHsgeDogdCwgeTogdmFsdWVzW2ldIH07CiAgICAgICAgICAgIHJldHVybiBwb2ludDsKICAgICAgICAgIH0pLmZpbHRlcihkID0+IGQueSAhPT0gbnVsbCksCiAgICAgICAgICBib3JkZXJDb2xvcjogY29sb3IsCiAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICB0ZW5zaW9uOiAwLjE1LAogICAgICAgICAgcG9pbnRSYWRpdXM6IDIsCiAgICAgICAgICBib3JkZXJXaWR0aDogMS41LAogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICB9KTsKICB9CgogIC8vIFNURVAgMzogQXBwbHkgY3V0b2ZmIGZpbHRlcmluZyB0byBhbGwgZGF0YXNldHMKICBsZXQgeEF4aXNNaW4gPSB1bmRlZmluZWQ7CiAgbGV0IHhBeGlzTWF4ID0gdW5kZWZpbmVkOwogIAogIGlmIChjdXRvZmZCYXNlbGluZSkgewogICAgZGF0YXNldHMuZm9yRWFjaChkYXRhc2V0ID0+IHsKICAgICAgaWYgKGRhdGFzZXQuZGF0YSAmJiBkYXRhc2V0LmRhdGEubGVuZ3RoID4gMCkgewogICAgICAgIC8vIEZpbmQgZmlyc3QgcmVhbCB0aW1lcG9pbnQgKGZpcnN0IG5vbi1udWxsIHRpbWUpCiAgICAgICAgbGV0IGZpcnN0VGltZXBvaW50ID0gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGFzZXQuZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGRhdGFzZXQuZGF0YVtpXS54ICE9PSBudWxsICYmIGlzRmluaXRlKGRhdGFzZXQuZGF0YVtpXS54KSkgewogICAgICAgICAgICBmaXJzdFRpbWVwb2ludCA9IGRhdGFzZXQuZGF0YVtpXS54OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gRGV0ZXJtaW5lIG1pbmltdW0gdGltZSB0byBpbmNsdWRlCiAgICAgICAgLy8gSWYgbm9ybWFsaXphdGlvbiBpcyBlbmFibGVkLCBleGNsdWRlIGJhc2VsaW5lIHBlcmlvZCAocG9pbnRzIGJlZm9yZSBiYXNlbGluZUVuZFRpbWUpCiAgICAgICAgLy8gT3RoZXJ3aXNlLCBleGNsdWRlIHBvaW50cyBiZWZvcmUgZmlyc3QgcmVhbCB0aW1lcG9pbnQKICAgICAgICBjb25zdCBtaW5UaW1lID0gbm9ybWFsaXplQmFzZWxpbmUgPyBub3JtYWxpemVCYXNlbGluZUVuZFRpbWUgOiAoZmlyc3RUaW1lcG9pbnQgIT09IG51bGwgPyBmaXJzdFRpbWVwb2ludCA6IC1JbmZpbml0eSk7CiAgICAgICAgCiAgICAgICAgLy8gRmlsdGVyIGRhdGEgcG9pbnRzOiBleGNsdWRlIGJlZm9yZSBtaW5UaW1lIGFuZCBhZnRlciBjdXRvZmYgdGltZQogICAgICAgIGRhdGFzZXQuZGF0YSA9IGRhdGFzZXQuZGF0YS5maWx0ZXIocG9pbnQgPT4gewogICAgICAgICAgaWYgKHBvaW50LnggPT09IG51bGwgfHwgIWlzRmluaXRlKHBvaW50LngpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICBpZiAocG9pbnQueCA8IG1pblRpbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgIGlmIChwb2ludC54ID4gY3V0b2ZmQmFzZWxpbmVUaW1lKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICAvLyBUcmFjayBtaW4vbWF4IHggdmFsdWVzIGZvciBheGlzIGFkanVzdG1lbnQKICAgICAgICBpZiAoZGF0YXNldC5kYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IHRpbWVzID0gZGF0YXNldC5kYXRhLm1hcChwID0+IHAueCkuZmlsdGVyKHQgPT4gdCAhPT0gbnVsbCAmJiBpc0Zpbml0ZSh0KSk7CiAgICAgICAgICBpZiAodGltZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBkYXRhc2V0TWluID0gTWF0aC5taW4oLi4udGltZXMpOwogICAgICAgICAgICBjb25zdCBkYXRhc2V0TWF4ID0gTWF0aC5tYXgoLi4udGltZXMpOwogICAgICAgICAgICBpZiAoeEF4aXNNaW4gPT09IHVuZGVmaW5lZCB8fCBkYXRhc2V0TWluIDwgeEF4aXNNaW4pIHsKICAgICAgICAgICAgICB4QXhpc01pbiA9IGRhdGFzZXRNaW47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHhBeGlzTWF4ID09PSB1bmRlZmluZWQgfHwgZGF0YXNldE1heCA+IHhBeGlzTWF4KSB7CiAgICAgICAgICAgICAgeEF4aXNNYXggPSBkYXRhc2V0TWF4OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9IGVsc2UgewogICAgLy8gRXZlbiBpZiBjdXRvZmYgaXMgZGlzYWJsZWQsIGNhbGN1bGF0ZSB4LWF4aXMgcmFuZ2UgZnJvbSBhbGwgZGF0YXNldHMgZm9yIHByb3BlciBkaXNwbGF5CiAgICBkYXRhc2V0cy5mb3JFYWNoKGRhdGFzZXQgPT4gewogICAgICBpZiAoZGF0YXNldC5kYXRhICYmIGRhdGFzZXQuZGF0YS5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3QgdGltZXMgPSBkYXRhc2V0LmRhdGEubWFwKHAgPT4gcC54KS5maWx0ZXIodCA9PiB0ICE9PSBudWxsICYmIGlzRmluaXRlKHQpKTsKICAgICAgICBpZiAodGltZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgY29uc3QgZGF0YXNldE1pbiA9IE1hdGgubWluKC4uLnRpbWVzKTsKICAgICAgICAgIGNvbnN0IGRhdGFzZXRNYXggPSBNYXRoLm1heCguLi50aW1lcyk7CiAgICAgICAgICBpZiAoeEF4aXNNaW4gPT09IHVuZGVmaW5lZCB8fCBkYXRhc2V0TWluIDwgeEF4aXNNaW4pIHsKICAgICAgICAgICAgeEF4aXNNaW4gPSBkYXRhc2V0TWluOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHhBeGlzTWF4ID09PSB1bmRlZmluZWQgfHwgZGF0YXNldE1heCA+IHhBeGlzTWF4KSB7CiAgICAgICAgICAgIHhBeGlzTWF4ID0gZGF0YXNldE1heDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICAKICAvLyBTVEVQIDQ6IEFkZCByZWdyZXNzaW9uIGN1cnZlcyB0byBkYXRhc2V0cwogIGlmIChmaXRSZWdyZXNzaW9uKSB7CiAgICBjb25zdCByZWdyZXNzaW9uRGF0YXNldHMgPSBbXTsKICAgIGNvbnN0IG1vbm9FeHBQYXJhbXMgPSBbXTsgLy8gU3RvcmUgcGFyYW1ldGVycyBmb3IgbW9uby1leHBvbmVudGlhbCBmaXRzCiAgICAKICAgIGRhdGFzZXRzLmZvckVhY2goZGF0YXNldCA9PiB7CiAgICAgIGlmIChkYXRhc2V0LmRhdGEgJiYgZGF0YXNldC5kYXRhLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBkYXRhc2V0IHJlcHJlc2VudHMgYSBjb250cm9sIHdlbGwKICAgICAgICAvLyBFeHRyYWN0IHdlbGxJZCBmcm9tIGxhYmVsIChmb3JtYXQ6ICJOMSAtIExhYmVsIiBvciAiTjEgLSBMYWJlbCBDb250cm9sIENvbCAxIikKICAgICAgICBsZXQgaXNDb250cm9sID0gZmFsc2U7CiAgICAgICAgY29uc3QgbGFiZWwgPSBkYXRhc2V0LmxhYmVsIHx8ICIiOwogICAgICAgIAogICAgICAgIC8vIE1ldGhvZCAxOiBDaGVjayBpZiBsYWJlbCBjb250YWlucyAiQ29udHJvbCIgKGNhc2UtaW5zZW5zaXRpdmUpCiAgICAgICAgaWYgKGxhYmVsLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoImNvbnRyb2wiKSkgewogICAgICAgICAgaXNDb250cm9sID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gTWV0aG9kIDI6IFRyeSB0byBleHRyYWN0IHdlbGxJZCBmcm9tIGxhYmVsIGFuZCBjaGVjawogICAgICAgICAgLy8gTGFiZWwgZm9ybWF0IGlzIHR5cGljYWxseTogIk4xIC0gTGFiZWwgQ29sIDEiIG9yICJOMSAtIExhYmVsIgogICAgICAgICAgY29uc3Qgd2VsbElkTWF0Y2ggPSBsYWJlbC5tYXRjaCgvXihbQS1aXVxkKylccyotLyk7CiAgICAgICAgICBpZiAod2VsbElkTWF0Y2gpIHsKICAgICAgICAgICAgY29uc3Qgd2VsbElkID0gd2VsbElkTWF0Y2hbMV07CiAgICAgICAgICAgIGlzQ29udHJvbCA9IGlzQ29udHJvbFdlbGwod2VsbElkKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gVXNlIGxpbmVhciByZWdyZXNzaW9uIGZvciBjb250cm9scywgb3RoZXJ3aXNlIHVzZSBzZWxlY3RlZCByZWdyZXNzaW9uIHR5cGUKICAgICAgICBjb25zdCByZWdyZXNzaW9uVHlwZVRvVXNlID0gaXNDb250cm9sID8gJ2xpbmVhcicgOiByZWdyZXNzaW9uVHlwZTsKICAgICAgICAKICAgICAgICAvLyBGaXQgcmVncmVzc2lvbiBjdXJ2ZQogICAgICAgIGNvbnN0IGZpdEZ1bmN0aW9uID0gZml0UmVncmVzc2lvbkN1cnZlKGRhdGFzZXQuZGF0YSwgcmVncmVzc2lvblR5cGVUb1VzZSwgcG9seW5vbWlhbE9yZGVyKTsKICAgICAgICBpZiAoZml0RnVuY3Rpb24pIHsKICAgICAgICAgIC8vIEdldCB0aW1lIHJhbmdlIGZyb20gZGF0YQogICAgICAgICAgY29uc3QgdGltZXMgPSBkYXRhc2V0LmRhdGEubWFwKHAgPT4gcC54KS5maWx0ZXIodCA9PiB0ICE9PSBudWxsICYmIGlzRmluaXRlKHQpKTsKICAgICAgICAgIGlmICh0aW1lcy5sZW5ndGggPT09IDApIHJldHVybjsKICAgICAgICAgIAogICAgICAgICAgY29uc3QgbWluVGltZSA9IE1hdGgubWluKC4uLnRpbWVzKTsKICAgICAgICAgIGNvbnN0IG1heFRpbWUgPSBNYXRoLm1heCguLi50aW1lcyk7CiAgICAgICAgICAKICAgICAgICAgIC8vIEdlbmVyYXRlIHJlZ3Jlc3Npb24gY3VydmUgcG9pbnRzCiAgICAgICAgICBjb25zdCBudW1Qb2ludHMgPSAxMDA7CiAgICAgICAgICBjb25zdCByZWdyZXNzaW9uRGF0YSA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gbnVtUG9pbnRzOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdCA9IG1pblRpbWUgKyAobWF4VGltZSAtIG1pblRpbWUpICogKGkgLyBudW1Qb2ludHMpOwogICAgICAgICAgICBjb25zdCB5ID0gZml0RnVuY3Rpb24odCk7CiAgICAgICAgICAgIGlmICh5ICE9PSBudWxsICYmIGlzRmluaXRlKHkpKSB7CiAgICAgICAgICAgICAgcmVncmVzc2lvbkRhdGEucHVzaCh7IHg6IHQsIHk6IHkgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIAogICAgICAgICAgaWYgKHJlZ3Jlc3Npb25EYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIHJlZ3Jlc3Npb24gZGF0YXNldCB3aXRoIHNhbWUgY29sb3IgYnV0IGRpZmZlcmVudCBzdHlsZQogICAgICAgICAgICBjb25zdCByZWdyZXNzaW9uQ29sb3IgPSBkYXRhc2V0LmJvcmRlckNvbG9yIHx8IGRhdGFzZXQuYmFja2dyb3VuZENvbG9yIHx8ICJyZ2JhKDEyOCwgMTI4LCAxMjgsIDEuMCkiOwogICAgICAgICAgICByZWdyZXNzaW9uRGF0YXNldHMucHVzaCh7CiAgICAgICAgICAgICAgbGFiZWw6IGAke2RhdGFzZXQubGFiZWx9ICgke3JlZ3Jlc3Npb25UeXBlVG9Vc2V9IGZpdClgLAogICAgICAgICAgICAgIGRhdGE6IHJlZ3Jlc3Npb25EYXRhLAogICAgICAgICAgICAgIGJvcmRlckNvbG9yOiByZWdyZXNzaW9uQ29sb3IsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgIGJvcmRlcldpZHRoOiAyLAogICAgICAgICAgICAgIGJvcmRlckRhc2g6IFs1LCA1XSwgLy8gRGFzaGVkIGxpbmUgZm9yIHJlZ3Jlc3Npb24KICAgICAgICAgICAgICBwb2ludFJhZGl1czogMCwgLy8gTm8gcG9pbnRzIG9uIHJlZ3Jlc3Npb24gbGluZQogICAgICAgICAgICAgIHRlbnNpb246IDAsCiAgICAgICAgICAgICAgZmlsbDogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdG9yZSBtb25vLWV4cG9uZW50aWFsIHBhcmFtZXRlcnMgZm9yIGluZm8gcGFuZWwKICAgICAgICAgICAgLy8gT25seSBzdG9yZSBpZiB1c2luZyBtb25vLWV4cG9uZW50aWFsIChub3QgZm9yIGNvbnRyb2xzIHdoaWNoIHVzZSBsaW5lYXIpCiAgICAgICAgICAgIGlmIChyZWdyZXNzaW9uVHlwZVRvVXNlID09PSAnbW9uby1leHBvbmVudGlhbCcgJiYgZml0RnVuY3Rpb24ucGFyYW1zKSB7CiAgICAgICAgICAgICAgLy8gUmVtb3ZlIHJlcGxpY2F0ZSBhbmQgZGF0YXNldCBpbmZvIGZyb20gbGFiZWwgZm9yIHJlZ3Jlc3Npb24gbGluZXMKICAgICAgICAgICAgICAvLyBQYXR0ZXJuOiByZW1vdmUgIihYLXBsaWNhdGUsIFkgZGF0YXNldHMsIG1lYW4gwrEgU0UpIiBvciBzaW1pbGFyIHBhdHRlcm5zCiAgICAgICAgICAgICAgbGV0IGNsZWFuTGFiZWwgPSBkYXRhc2V0LmxhYmVsOwogICAgICAgICAgICAgIC8vIFJlbW92ZSBwYXR0ZXJucyBjb250YWluaW5nIHBsaWNhdGUsIGRhdGFzZXRzLCBvciBtZWFuIMKxIFNFIGluIHBhcmVudGhlc2VzCiAgICAgICAgICAgICAgY2xlYW5MYWJlbCA9IGNsZWFuTGFiZWwucmVwbGFjZSgvXHMqXChbXildKig/OnBsaWNhdGV8ZGF0YXNldHN8bWVhblxzKsKxXHMqU0UpW14pXSpcKS9naSwgJycpOwogICAgICAgICAgICAgIC8vIENsZWFuIHVwIGFueSBkb3VibGUgc3BhY2VzIG9yIHRyYWlsaW5nL2xlYWRpbmcgc3BhY2VzCiAgICAgICAgICAgICAgY2xlYW5MYWJlbCA9IGNsZWFuTGFiZWwucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgIG1vbm9FeHBQYXJhbXMucHVzaCh7CiAgICAgICAgICAgICAgICBsYWJlbDogY2xlYW5MYWJlbCwKICAgICAgICAgICAgICAgIHBhcmFtczogZml0RnVuY3Rpb24ucGFyYW1zLAogICAgICAgICAgICAgICAgY29sb3I6IHJlZ3Jlc3Npb25Db2xvciAvLyBVc2UgdGhlIHNhbWUgY29sb3IgYXMgdGhlIHJlZ3Jlc3Npb24gY3VydmUKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICAKICAgIC8vIEFkZCByZWdyZXNzaW9uIGRhdGFzZXRzIHRvIHRoZSBtYWluIGRhdGFzZXRzIGFycmF5CiAgICBkYXRhc2V0cy5wdXNoKC4uLnJlZ3Jlc3Npb25EYXRhc2V0cyk7CiAgICAKICAgIC8vIFVwZGF0ZSBpbmZvIHBhbmVsIGZvciBtb25vLWV4cG9uZW50aWFsCiAgICBpZiAocmVncmVzc2lvblR5cGUgPT09ICdtb25vLWV4cG9uZW50aWFsJykgewogICAgICB1cGRhdGVNb25vRXhwb25lbnRpYWxJbmZvUGFuZWwobW9ub0V4cFBhcmFtcyk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBpbmZvUGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi1pbmZvLXBhbmVsIik7CiAgICAgIGlmIChpbmZvUGFuZWwpIHsKICAgICAgICBpbmZvUGFuZWwuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgfQogICAgfQogICAgCiAgICAvLyBSZWNhbGN1bGF0ZSB4LWF4aXMgcmFuZ2UgdG8gaW5jbHVkZSByZWdyZXNzaW9uIGN1cnZlcwogICAgaWYgKGN1dG9mZkJhc2VsaW5lKSB7CiAgICAgIGRhdGFzZXRzLmZvckVhY2goZGF0YXNldCA9PiB7CiAgICAgICAgaWYgKGRhdGFzZXQuZGF0YSAmJiBkYXRhc2V0LmRhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgY29uc3QgdGltZXMgPSBkYXRhc2V0LmRhdGEubWFwKHAgPT4gcC54KS5maWx0ZXIodCA9PiB0ICE9PSBudWxsICYmIGlzRmluaXRlKHQpKTsKICAgICAgICAgIGlmICh0aW1lcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGFzZXRNaW4gPSBNYXRoLm1pbiguLi50aW1lcyk7CiAgICAgICAgICAgIGNvbnN0IGRhdGFzZXRNYXggPSBNYXRoLm1heCguLi50aW1lcyk7CiAgICAgICAgICAgIGlmICh4QXhpc01pbiA9PT0gdW5kZWZpbmVkIHx8IGRhdGFzZXRNaW4gPCB4QXhpc01pbikgewogICAgICAgICAgICAgIHhBeGlzTWluID0gZGF0YXNldE1pbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoeEF4aXNNYXggPT09IHVuZGVmaW5lZCB8fCBkYXRhc2V0TWF4ID4geEF4aXNNYXgpIHsKICAgICAgICAgICAgICB4QXhpc01heCA9IGRhdGFzZXRNYXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KCiAgLy8gRGV0ZXJtaW5lIHktYXhpcyBsYWJlbCBiYXNlZCBvbiBwcm9jZXNzaW5nIHN0ZXBzCiAgbGV0IHlBeGlzTGFiZWwgPSAiRmx1b3Jlc2NlbmNlIChGSSkiOwogIGlmIChub3JtYWxpemVCYXNlbGluZSkgewogICAgaWYgKG5vcm1hbGl6YXRpb25Nb2RlID09PSAnZGVsdGFfZl9vdmVyX2YnKSB7CiAgICAgIHlBeGlzTGFiZWwgPSAizpRGL0YgKE5vcm1hbGl6ZWQpIjsKICAgIH0gZWxzZSB7CiAgICAgIHlBeGlzTGFiZWwgPSAiRi9G4oKAIChOb3JtYWxpemVkKSI7CiAgICB9CiAgfQoKICAvLyBUcmFuc2Zvcm0gZXhpc3RpbmcgY2hhcnQgaW5zdGVhZCBvZiByZWNyZWF0aW5nCiAgaWYgKGNoYXJ0KSB7CiAgICAvLyBDbGVhciBleGlzdGluZyBkYXRhc2V0cwogICAgd2hpbGUgKGNoYXJ0LmRhdGEuZGF0YXNldHMubGVuZ3RoID4gMCkgewogICAgICBjaGFydC5kYXRhLmRhdGFzZXRzLnBvcCgpOwogICAgfQogICAgCiAgICAvLyBBZGQgbmV3IGRhdGFzZXRzCiAgICBkYXRhc2V0cy5mb3JFYWNoKGRhdGFzZXQgPT4gewogICAgICBjaGFydC5kYXRhLmRhdGFzZXRzLnB1c2goZGF0YXNldCk7CiAgICB9KTsKICAgIAogICAgLy8gVXBkYXRlIGNoYXJ0IG9wdGlvbnMKICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLngudGl0bGUudGV4dCA9ICJUaW1lIChzKSI7CiAgICBjaGFydC5vcHRpb25zLnNjYWxlcy55LnRpdGxlLnRleHQgPSB5QXhpc0xhYmVsOwogICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueS5taW4gPSB1bmRlZmluZWQ7CiAgICAKICAgIC8vIEFkanVzdCB4LWF4aXMgcmFuZ2UgYmFzZWQgb24gZmlsdGVyZWQgZGF0YSAoU3RlcCAzKQogICAgaWYgKGN1dG9mZkJhc2VsaW5lICYmIHhBeGlzTWluICE9PSB1bmRlZmluZWQgJiYgeEF4aXNNYXggIT09IHVuZGVmaW5lZCkgewogICAgICAvLyBBZGQgc21hbGwgcGFkZGluZyAoMiUlIG9mIHJhbmdlKSBmb3IgYmV0dGVyIHZpc3VhbGl6YXRpb24KICAgICAgY29uc3QgcGFkZGluZyA9ICh4QXhpc01heCAtIHhBeGlzTWluKSAqIDAuMDI7CiAgICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLngubWluID0gTWF0aC5tYXgoMCwgeEF4aXNNaW4gLSBwYWRkaW5nKTsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueC5tYXggPSB4QXhpc01heCArIHBhZGRpbmc7CiAgICB9IGVsc2UgewogICAgICAvLyBSZXNldCB0byBhdXRvIGlmIGN1dG9mZiBpcyBkaXNhYmxlZAogICAgICBjaGFydC5vcHRpb25zLnNjYWxlcy54Lm1pbiA9IHVuZGVmaW5lZDsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueC5tYXggPSB1bmRlZmluZWQ7CiAgICB9CiAgICAKICAgIC8vIENvdW50IG9ubHkgd2VsbHMgdGhhdCBhcmUgYWN0dWFsbHkgZGlzcGxheWVkIChhY2NvdW50aW5nIGZvciBleGNsdXNpb25zKQogICAgLy8gQ291bnQgdW5pcXVlIHdlbGwgZ3JvdXBzL2RhdGFzZXRzIHRoYXQgYXJlIGFjdHVhbGx5IGRpc3BsYXllZAogICAgY29uc3QgZGlzcGxheWVkV2VsbENvdW50ID0gZGF0YXNldHMubGVuZ3RoOwogICAgY2hhcnQub3B0aW9ucy5wbHVnaW5zLnRpdGxlLnRleHQgPSBgVGltZSBDb3Vyc2UgLSAke2Rpc3BsYXllZFdlbGxDb3VudH0gd2VsbChzKSBzZWxlY3RlZGA7CiAgICBjaGFydC5vcHRpb25zLnBsdWdpbnMubGVnZW5kLmRpc3BsYXkgPSBkYXRhc2V0cy5sZW5ndGggPiAwOwogICAgCiAgICAvLyBGb3JjZSBDaGFydC5qcyB0byB1cGRhdGUgLSB1c2UgdXBkYXRlKCkgd2l0aG91dCBtb2RlIHRvIGVuc3VyZSBwcm9wZXIgcmVkcmF3CiAgICBjaGFydC51cGRhdGUoKTsKICB9IGVsc2UgewogICAgLy8gQ3JlYXRlIG5ldyBjaGFydCBvbmx5IGlmIGl0IGRvZXNuJ3QgZXhpc3QKICAgIGNoYXJ0ID0gbmV3IENoYXJ0KGN0eCwgewogICAgICB0eXBlOiAibGluZSIsCiAgICAgIGRhdGE6IHsKICAgICAgICBkYXRhc2V0czogZGF0YXNldHMKICAgICAgfSwKICAgICAgb3B0aW9uczogewogICAgICAgIHJlc3BvbnNpdmU6IHRydWUsCiAgICAgICAgbWFpbnRhaW5Bc3BlY3RSYXRpbzogZmFsc2UsCiAgICAgICAgcGFyc2luZzogZmFsc2UsCiAgICAgICAgc2NhbGVzOiB7CiAgICAgICAgICAgIHg6IHsgCiAgICAgICAgICAgICAgdHlwZTogImxpbmVhciIsIAogICAgICAgICAgICAgIHRpdGxlOiB7IAogICAgICAgICAgICAgICAgZGlzcGxheTogdHJ1ZSwKICAgICAgICAgICAgICAgIHRleHQ6ICJUaW1lIChzKSIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG1pbjogY3V0b2ZmQmFzZWxpbmUgJiYgeEF4aXNNaW4gIT09IHVuZGVmaW5lZCA/IE1hdGgubWF4KDAsIHhBeGlzTWluIC0gKHhBeGlzTWF4IC0geEF4aXNNaW4pICogMC4wMikgOiB1bmRlZmluZWQsCiAgICAgICAgICAgICAgbWF4OiBjdXRvZmZCYXNlbGluZSAmJiB4QXhpc01heCAhPT0gdW5kZWZpbmVkID8geEF4aXNNYXggKyAoeEF4aXNNYXggLSB4QXhpc01pbikgKiAwLjAyIDogdW5kZWZpbmVkCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHk6IHsgCiAgICAgICAgICAgICAgdGl0bGU6IHsgCiAgICAgICAgICAgICAgICBkaXNwbGF5OiB0cnVlLAogICAgICAgICAgICAgICAgdGV4dDogeUF4aXNMYWJlbAogICAgICAgICAgICB9LAogICAgICAgICAgICBtaW46IHVuZGVmaW5lZAogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcGx1Z2luczogewogICAgICAgICAgbGVnZW5kOiB7CiAgICAgICAgICAgIGRpc3BsYXk6IGRhdGFzZXRzLmxlbmd0aCA+IDAsIC8vIFNob3cgbGVnZW5kIHdoZW4gdGhlcmUgYXJlIGRhdGFzZXRzCiAgICAgICAgICAgIHBvc2l0aW9uOiAidG9wIiwKICAgICAgICAgICAgb25DbGljazogbnVsbCwKICAgICAgICAgICAgbGFiZWxzOiB7CiAgICAgICAgICAgICAgdXNlUG9pbnRTdHlsZTogdHJ1ZSwKICAgICAgICAgICAgICBwYWRkaW5nOiAxNSwKICAgICAgICAgICAgICBmb250OiB7CiAgICAgICAgICAgICAgICBzaXplOiAxMQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZ2VuZXJhdGVMYWJlbHM6IGZ1bmN0aW9uKGNoYXJ0KSB7CiAgICAgICAgICAgICAgICAvLyBDdXN0b20gbGFiZWwgZ2VuZXJhdGlvbiB0byBzaG93IGNvbG9yIGFuZCB3ZWxsIG5hbWUgY2xlYXJseQogICAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWwgPSBDaGFydC5kZWZhdWx0cy5wbHVnaW5zLmxlZ2VuZC5sYWJlbHMuZ2VuZXJhdGVMYWJlbHM7CiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbHMgPSBvcmlnaW5hbC5jYWxsKHRoaXMsIGNoYXJ0KTsKICAgICAgICAgICAgICAgIC8vIExhYmVscyBhbHJlYWR5IGhhdmUgdGhlIGNvcnJlY3QgdGV4dCBmcm9tIGRhdGFzZXQubGFiZWwKICAgICAgICAgICAgICAgIHJldHVybiBsYWJlbHM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgdGl0bGU6IHsKICAgICAgICAgICAgZGlzcGxheTogdHJ1ZSwKICAgICAgICAgICAgdGV4dDogYFRpbWUgQ291cnNlIC0gJHtkYXRhc2V0cy5sZW5ndGh9IHdlbGwocykgc2VsZWN0ZWRgCiAgICAgICAgICB9LAogICAgICAgICAgdG9vbHRpcDogewogICAgICAgICAgICBjYWxsYmFja3M6IHsKICAgICAgICAgICAgICBsYWJlbDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgICAgbGV0IGxhYmVsID0gY29udGV4dC5kYXRhc2V0LmxhYmVsIHx8ICIiOwogICAgICAgICAgICAgICAgaWYgKGxhYmVsKSB7CiAgICAgICAgICAgICAgICAgIGxhYmVsICs9ICI6ICI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY29udGV4dC5wYXJzZWQueSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsYWJlbCArPSBjb250ZXh0LnBhcnNlZC55LnRvRml4ZWQoMik7CiAgICAgICAgICAgICAgICAgIC8vIFNob3cgZXJyb3IgaWYgYXZhaWxhYmxlCiAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0LnJhdyAmJiBjb250ZXh0LnJhdy5lcnJvciAhPT0gdW5kZWZpbmVkICYmIGNvbnRleHQucmF3LmVycm9yICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbGFiZWwgKz0gIiDCsSAiICsgY29udGV4dC5yYXcuZXJyb3IudG9GaXhlZCgyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGxhYmVsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQp9CgovLyBJbml0aWFsaXplIHNldHRpbmdzIGRpc3BsYXkgb24gcGFnZSBsb2FkCnVwZGF0ZUN1cnJlbnRTZXR0aW5nc0Rpc3BsYXkoKTsKLy8gSW5pdGlhbGl6ZSBiYXNlbGluZSBtZXRob2QgcGFyYW1zIHRvIHNob3cvaGlkZSBMT1dFU1MvcG9seW5vbWlhbCBwYXJhbWV0ZXJzIGJhc2VkIG9uIGRlZmF1bHQgc2VsZWN0aW9uCnVwZGF0ZUJhc2VsaW5lTWV0aG9kUGFyYW1zKCk7Ci8vIEluaXRpYWxpemUgcmVncmVzc2lvbiB0eXBlIHBhcmFtcyB0byBzaG93L2hpZGUgaW5mbyBwYW5lbCBiYXNlZCBvbiBkZWZhdWx0IHNlbGVjdGlvbgovLyBTa2lwIGNoYXJ0IHVwZGF0ZSBkdXJpbmcgaW5pdGlhbGl6YXRpb24KdXBkYXRlUmVncmVzc2lvblR5cGVQYXJhbXModHJ1ZSk7Cgpsb2FkRGF0YSgpLmNhdGNoKGVyciA9PiB7CiAgY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIGxvYWQgdmlld2VyX2RhdGEuanNvbjoiLCBlcnIpOwogIGFsZXJ0KCJDb3VsZCBub3QgbG9hZCB2aWV3ZXJfZGF0YS5qc29uLiBEaWQgeW91IHJ1biB0aGUgUHl0aG9uIHNjcmlwdCBpbiB0aGUgc2FtZSBmb2xkZXI/Iik7Cn0pOwo8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+CiIiIgoKCmRlZiB3cml0ZV9odG1sKGh0bWxfcGF0aDogc3RyKToKICAgIGh0bWwgPSBIVE1MX1RFTVBMQVRFICUgewogICAgICAgICJyb3dzIjogUExBVEVfUk9XUywKICAgICAgICAiY29scyI6IFBMQVRFX0NPTFMsCiAgICB9CiAgICB3aXRoIG9wZW4oaHRtbF9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZi53cml0ZShodG1sKQoKCmRlZiB3cml0ZV93ZWJfY29tbWFuZChzY3JpcHRfZGlyOiBzdHIsIHdlYl9kaXI6IHN0cik6CiAgICAiIiIKICAgIENyZWF0ZSBhIGRvdWJsZS1jbGlja2FibGUgJ3dlYi5jb21tYW5kJyBmaWxlIGluIHRoZSBtYWluIGZvbGRlci4KICAgIE9uIG1hY09TLCAuY29tbWFuZCBmaWxlcyBjYW4gYmUgZG91YmxlLWNsaWNrZWQgdG8gcnVuIGluIFRlcm1pbmFsLgogICAgIiIiCiAgICB3ZWJfY29tbWFuZF9wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJ3ZWIuY29tbWFuZCIpCiAgICAKICAgIHdlYl9jb21tYW5kX2NvbnRlbnQgPSBmIiIiIyEvYmluL2Jhc2gKIyBEb3VibGUtY2xpY2thYmxlIHdlYiBzZXJ2ZXIgbGF1bmNoZXIgZm9yIFBsYXRlIFZpZXdlcgojIFRoaXMgZmlsZSBpcyBhdXRvLWdlbmVyYXRlZCBieSBwbGF0ZV92aWV3ZXIucHkKClBPUlQ9ODAwMApXRUJfRElSPSJ7d2ViX2Rpcn0iCgojIENoYW5nZSB0byB3ZWIgZGlyZWN0b3J5CmNkICIkV0VCX0RJUiIgfHwge3sKICAgIGVjaG8gIkVycm9yOiBDb3VsZCBub3QgZmluZCB3ZWIgZGlyZWN0b3J5OiAkV0VCX0RJUiIKICAgIGVjaG8gIlBsZWFzZSBydW4gcGxhdGVfdmlld2VyLnB5IGZpcnN0IHRvIGdlbmVyYXRlIHRoZSB3ZWIgZmlsZXMuIgogICAgcmVhZCAtcCAiUHJlc3MgRW50ZXIgdG8gZXhpdC4uLiIKICAgIGV4aXQgMQp9fQoKIyBDaGVjayBpZiB2aWV3ZXJfZGF0YS5qc29uIGV4aXN0cwppZiBbICEgLWYgInZpZXdlcl9kYXRhLmpzb24iIF07IHRoZW4KICAgIGVjaG8gIldhcm5pbmc6IHZpZXdlcl9kYXRhLmpzb24gbm90IGZvdW5kISIKICAgIGVjaG8gIlBsZWFzZSBydW4gcGxhdGVfdmlld2VyLnB5IGZpcnN0IHRvIGdlbmVyYXRlIHRoZSBkYXRhIGZpbGVzLiIKICAgIGVjaG8gIiIKZmkKClVSTD0iaHR0cDovL2xvY2FsaG9zdDoke3tQT1JUfX0vaW5kZXguaHRtbCIKCmVjaG8gIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKZWNobyAiUGxhdGUgVmlld2VyIFdlYiBTZXJ2ZXIiCmVjaG8gIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKZWNobyAiU2VydmVyIHJ1bm5pbmcgYXQ6ICRVUkwiCmVjaG8gIlNlcnZpbmcgZGlyZWN0b3J5OiAkV0VCX0RJUiIKZWNobyAiIgplY2hvICJQcmVzcyBDdHJsK0MgdG8gc3RvcCB0aGUgc2VydmVyIgplY2hvICI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iCmVjaG8gIiIKCiMgVHJ5IHRvIG9wZW4gYnJvd3NlciBhdXRvbWF0aWNhbGx5IGFmdGVyIGEgc2hvcnQgZGVsYXkKKHNsZWVwIDIgJiYgaWYgY29tbWFuZCAtdiBvcGVuICY+IC9kZXYvbnVsbDsgdGhlbgogICAgb3BlbiAiJFVSTCIgMj4vZGV2L251bGwgJiYgZWNobyAiT3BlbmVkICRVUkwgaW4geW91ciBkZWZhdWx0IGJyb3dzZXIiIHx8IGVjaG8gIlBsZWFzZSBvcGVuICRVUkwgbWFudWFsbHkgaW4geW91ciBicm93c2VyIgplbGlmIGNvbW1hbmQgLXYgeGRnLW9wZW4gJj4gL2Rldi9udWxsOyB0aGVuCiAgICB4ZGctb3BlbiAiJFVSTCIgMj4vZGV2L251bGwgJiYgZWNobyAiT3BlbmVkICRVUkwgaW4geW91ciBkZWZhdWx0IGJyb3dzZXIiIHx8IGVjaG8gIlBsZWFzZSBvcGVuICRVUkwgbWFudWFsbHkgaW4geW91ciBicm93c2VyIgplbHNlCiAgICBlY2hvICJQbGVhc2Ugb3BlbiAkVVJMIG1hbnVhbGx5IGluIHlvdXIgYnJvd3NlciIKZmkpICYKCiMgVHJ5IFB5dGhvbiAzIGZpcnN0LCB0aGVuIFB5dGhvbiAyLCB0aGVuIGV4aXQgd2l0aCBlcnJvcgppZiBjb21tYW5kIC12IHB5dGhvbjMgJj4gL2Rldi9udWxsOyB0aGVuCiAgICBweXRob24zIC1tIGh0dHAuc2VydmVyICIkUE9SVCIKZWxpZiBjb21tYW5kIC12IHB5dGhvbiAmPiAvZGV2L251bGw7IHRoZW4KICAgIHB5dGhvbiAtbSBTaW1wbGVIVFRQU2VydmVyICIkUE9SVCIKZWxzZQogICAgZWNobyAiRXJyb3I6IFB5dGhvbiBub3QgZm91bmQuIFBsZWFzZSBpbnN0YWxsIFB5dGhvbiB0byBydW4gYSBsb2NhbCBzZXJ2ZXIuIgogICAgcmVhZCAtcCAiUHJlc3MgRW50ZXIgdG8gZXhpdC4uLiIKICAgIGV4aXQgMQpmaQoiIiIKICAgIAogICAgd2l0aCBvcGVuKHdlYl9jb21tYW5kX3BhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICBmLndyaXRlKHdlYl9jb21tYW5kX2NvbnRlbnQpCiAgICAKICAgICMgTWFrZSBpdCBleGVjdXRhYmxlCiAgICBvcy5jaG1vZCh3ZWJfY29tbWFuZF9wYXRoLCAwbzc1NSkKICAgIAogICAgcmV0dXJuIHdlYl9jb21tYW5kX3BhdGgKCgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBCYXNlbGluZSBJZGVudGlmaWNhdGlvbiBhbmQgTm9ybWFsaXphdGlvbiBGdW5jdGlvbnMKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgpkZWYgaWRlbnRpZnlfYmFzZWxpbmVfd2luZG93KGRmOiBwZC5EYXRhRnJhbWUsIGJhc2VsaW5lX2VuZF90aW1lOiBmbG9hdCA9IDI0LjApIC0+IERpY3Rbc3RyLCBwZC5EYXRhRnJhbWVdOgogICAgIiIiCiAgICBGb3IgZWFjaCB3ZWxsIGNvbHVtbiwgZGVmaW5lIHRoZSBiYXNlbGluZSB3aW5kb3cgYXMgYWxsIHJvd3Mgd2l0aCBUaW1lX3MgPD0gYmFzZWxpbmVfZW5kX3RpbWUuCiAgICAKICAgIFBhcmFtZXRlcnM6CiAgICAtLS0tLS0tLS0tLQogICAgZGYgOiBwZC5EYXRhRnJhbWUKICAgICAgICBMb25nLWZvcm1hdCBEYXRhRnJhbWUgd2l0aCBjb2x1bW5zIFsncGxhdGVfaWQnLCAnd2VsbCcsICdjb250ZW50JywgJ3RpbWVfcycsICd2YWx1ZSddCiAgICBiYXNlbGluZV9lbmRfdGltZSA6IGZsb2F0CiAgICAgICAgTWF4aW11bSB0aW1lIChpbiBzZWNvbmRzKSBmb3IgYmFzZWxpbmUgd2luZG93IChkZWZhdWx0OiAyNC4wKQogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIERpY3Rbc3RyLCBwZC5EYXRhRnJhbWVdCiAgICAgICAgRGljdGlvbmFyeSBtYXBwaW5nIHdlbGxfaWQgdG8gRGF0YUZyYW1lIGNvbnRhaW5pbmcgb25seSBiYXNlbGluZSBwb2ludHMgZm9yIHRoYXQgd2VsbAogICAgIiIiCiAgICBiYXNlbGluZV9kYXRhID0ge30KICAgIAogICAgZm9yIHdlbGxfaWQsIHdlbGxfZGYgaW4gZGYuZ3JvdXBieSgnd2VsbCcpOgogICAgICAgIGJhc2VsaW5lX21hc2sgPSB3ZWxsX2RmWyd0aW1lX3MnXSA8PSBiYXNlbGluZV9lbmRfdGltZQogICAgICAgIGJhc2VsaW5lX2RhdGFbd2VsbF9pZF0gPSB3ZWxsX2RmW2Jhc2VsaW5lX21hc2tdLmNvcHkoKQogICAgCiAgICByZXR1cm4gYmFzZWxpbmVfZGF0YQoKCmRlZiBmaXRfYmFzZWxpbmUoCiAgICB0aW1lOiBwZC5TZXJpZXMsCiAgICBmbHVvcmVzY2VuY2U6IHBkLlNlcmllcywKICAgIG1ldGhvZDogc3RyID0gJ2xvd2VzcycsCiAgICBmcmFjOiBmbG9hdCA9IDAuNSwKICAgIHBvbHlfb3JkZXI6IGludCA9IDEsCiAgICB3ZWxsX2lkOiBzdHIgPSBOb25lCikgLT4gcGQuU2VyaWVzOgogICAgIiIiCiAgICBGaXQgYSBzbW9vdGggYmFzZWxpbmUgZnVuY3Rpb24gb24gdGhlIGJhc2VsaW5lIHdpbmRvdyBhbmQgZXh0cmFwb2xhdGUgdG8gZnVsbCB0aW1lY291cnNlLgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIHRpbWUgOiBwZC5TZXJpZXMKICAgICAgICBUaW1lIHZhbHVlcyBmb3IgYmFzZWxpbmUgd2luZG93CiAgICBmbHVvcmVzY2VuY2UgOiBwZC5TZXJpZXMKICAgICAgICBGbHVvcmVzY2VuY2UgdmFsdWVzIGZvciBiYXNlbGluZSB3aW5kb3cKICAgIG1ldGhvZCA6IHN0cgogICAgICAgIEJhc2VsaW5lIGZpdHRpbmcgbWV0aG9kOiAnbG93ZXNzJywgJ2NvbnN0YW50Jywgb3IgJ3BvbHlub21pYWwnIChkZWZhdWx0OiAnY29uc3RhbnQnKQogICAgICAgIC0gJ2xvd2Vzcyc6IExvY2FsbHkgV2VpZ2h0ZWQgU2NhdHRlcnBsb3QgU21vb3RoaW5nLiBVc2Ugd2hlbiBiYXNlbGluZSBoYXMgZ3JhZHVhbCBkcmlmdC4KICAgICAgICAgIEJlc3QgZm9yIG5vbi1saW5lYXIgYmFzZWxpbmVzIHdpdGggc21vb3RoIHRyZW5kcy4gRm9ybXVsYTogZyh0KSA9IExPV0VTUyhGX2Jhc2VsaW5lLCB0X2Jhc2VsaW5lLCBmcmFjKQogICAgICAgIC0gJ2NvbnN0YW50JzogQ29uc3RhbnQgbWVhbiBiYXNlbGluZS4gVXNlIHdoZW4gYmFzZWxpbmUgaXMgc3RhYmxlL2ZsYXQuCiAgICAgICAgICBCZXN0IGZvciBzdGFibGUgYmFzZWxpbmVzIHdpdGggbWluaW1hbCBkcmlmdC4gRm9ybXVsYTogZyh0KSA9IG1lYW4oRl9iYXNlbGluZSkKICAgICAgICAtICdwb2x5bm9taWFsJzogUG9seW5vbWlhbCBmaXQuIFVzZSB3aGVuIGJhc2VsaW5lIGhhcyBsaW5lYXIgb3IgcG9seW5vbWlhbCBkcmlmdC4KICAgICAgICAgIEJlc3QgZm9yIGJhc2VsaW5lcyB3aXRoIGtub3duIHBvbHlub21pYWwgdHJlbmRzLiBGb3JtdWxhOiBnKHQpID0gY+KCgCArIGPigoF0ICsgY+KCgnTCsiArIC4uLgogICAgZnJhYyA6IGZsb2F0CiAgICAgICAgRnJhY3Rpb24gb2YgZGF0YSB1c2VkIGZvciBMT1dFU1Mgc21vb3RoaW5nIChkZWZhdWx0OiAwLjUpLiBIaWdoZXIgPSBzbW9vdGhlciwgbG93ZXIgPSBtb3JlIGxvY2FsLgogICAgcG9seV9vcmRlciA6IGludAogICAgICAgIFBvbHlub21pYWwgb3JkZXIgZm9yIHBvbHlub21pYWwgZml0IChkZWZhdWx0OiAxKS4gMSA9IGxpbmVhciwgMiA9IHF1YWRyYXRpYywgZXRjLgogICAgd2VsbF9pZCA6IHN0ciwgb3B0aW9uYWwKICAgICAgICBXZWxsIGlkZW50aWZpZXIgZm9yIG91dHB1dAogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIHBkLlNlcmllcwogICAgICAgIEZpdHRlZCBiYXNlbGluZSB2YWx1ZXMgZm9yIGFsbCB0aW1lcG9pbnRzIChzYW1lIGluZGV4IGFzIGlucHV0IHRpbWUpCiAgICAiIiIKICAgIGltcG9ydCBudW1weSBhcyBucAogICAgCiAgICAjIFJlbW92ZSBOYU4gdmFsdWVzCiAgICB2YWxpZF9tYXNrID0gfihwZC5pc25hKHRpbWUpIHwgcGQuaXNuYShmbHVvcmVzY2VuY2UpKQogICAgdGltZV9jbGVhbiA9IHRpbWVbdmFsaWRfbWFza10udmFsdWVzCiAgICBmbHVvX2NsZWFuID0gZmx1b3Jlc2NlbmNlW3ZhbGlkX21hc2tdLnZhbHVlcwogICAgCiAgICBpZiBsZW4odGltZV9jbGVhbikgPT0gMDoKICAgICAgICAjIE5vIHZhbGlkIGRhdGEsIHJldHVybiBOYU4gc2VyaWVzCiAgICAgICAgcmV0dXJuIHBkLlNlcmllcyhpbmRleD10aW1lLmluZGV4LCBkdHlwZT1mbG9hdCkKICAgIAogICAgaWYgbWV0aG9kID09ICdjb25zdGFudCc6CiAgICAgICAgIyAwdGgtb3JkZXIgKGNvbnN0YW50IG1lYW4gYmFzZWxpbmUpCiAgICAgICAgIyBGb3JtdWxhOiBnKHQpID0gbWVhbihGX2Jhc2VsaW5lKSBmb3IgYWxsIHQKICAgICAgICBiYXNlbGluZV92YWx1ZSA9IG5wLm1lYW4oZmx1b19jbGVhbikKICAgICAgICBiYXNlbGluZV9maXQgPSBwZC5TZXJpZXMoYmFzZWxpbmVfdmFsdWUsIGluZGV4PXRpbWUuaW5kZXgpCiAgICAKICAgIGVsaWYgbWV0aG9kID09ICdwb2x5bm9taWFsJzoKICAgICAgICAjIFBvbHlub21pYWwgZml0IHVzaW5nIG5wLnBvbHlmaXQKICAgICAgICAjIEZvcm11bGE6IGcodCkgPSBj4oKAICsgY+KCgXQgKyBj4oKCdMKyICsgLi4uIChkZXBlbmRpbmcgb24gb3JkZXIpCiAgICAgICAgY29lZmZzID0gbnAucG9seWZpdCh0aW1lX2NsZWFuLCBmbHVvX2NsZWFuLCBwb2x5X29yZGVyKQogICAgICAgIHBvbHlfZnVuYyA9IG5wLnBvbHkxZChjb2VmZnMpCiAgICAgICAgYmFzZWxpbmVfZml0ID0gcGQuU2VyaWVzKHBvbHlfZnVuYyh0aW1lLnZhbHVlcyksIGluZGV4PXRpbWUuaW5kZXgpCiAgICAKICAgIGVsaWYgbWV0aG9kID09ICdsb3dlc3MnOgogICAgICAgICMgTE9XRVNTIHNtb290aGluZwogICAgICAgICMgRm9ybXVsYTogZyh0KSA9IExPV0VTUyhGX2Jhc2VsaW5lLCB0X2Jhc2VsaW5lLCBmcmFjKSBpbnRlcnBvbGF0ZWQvZXh0cmFwb2xhdGVkCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmcm9tIHN0YXRzbW9kZWxzLm5vbnBhcmFtZXRyaWMuc21vb3RoZXJzX2xvd2VzcyBpbXBvcnQgbG93ZXNzCiAgICAgICAgICAgICMgTE9XRVNTIHJldHVybnMgYXJyYXkgb2YgW3gsIHldIHBhaXJzCiAgICAgICAgICAgIHNtb290aGVkID0gbG93ZXNzKGZsdW9fY2xlYW4sIHRpbWVfY2xlYW4sIGZyYWM9ZnJhYywgcmV0dXJuX3NvcnRlZD1GYWxzZSkKICAgICAgICAgICAgIyBJbnRlcnBvbGF0ZS9leHRyYXBvbGF0ZSB0byBmdWxsIHRpbWVjb3Vyc2UKICAgICAgICAgICAgZnJvbSBzY2lweS5pbnRlcnBvbGF0ZSBpbXBvcnQgaW50ZXJwMWQKICAgICAgICAgICAgaW50ZXJwX2Z1bmMgPSBpbnRlcnAxZCgKICAgICAgICAgICAgICAgIHRpbWVfY2xlYW4sIHNtb290aGVkLCAKICAgICAgICAgICAgICAgIGtpbmQ9J2xpbmVhcicsIAogICAgICAgICAgICAgICAgYm91bmRzX2Vycm9yPUZhbHNlLCAKICAgICAgICAgICAgICAgIGZpbGxfdmFsdWU9J2V4dHJhcG9sYXRlJwogICAgICAgICAgICApCiAgICAgICAgICAgIGJhc2VsaW5lX2ZpdCA9IHBkLlNlcmllcyhpbnRlcnBfZnVuYyh0aW1lLnZhbHVlcyksIGluZGV4PXRpbWUuaW5kZXgpCiAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgICAgICByYWlzZSBJbXBvcnRFcnJvcigKICAgICAgICAgICAgICAgICJzdGF0c21vZGVscyBpcyByZXF1aXJlZCBmb3IgTE9XRVNTIGZpdHRpbmcuICIKICAgICAgICAgICAgICAgICJJbnN0YWxsIHdpdGg6IHBpcCBpbnN0YWxsIHN0YXRzbW9kZWxzIgogICAgICAgICAgICApCiAgICAKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIlVua25vd24gYmFzZWxpbmUgbWV0aG9kOiB7bWV0aG9kfS4gQ2hvb3NlIGZyb20gJ2xvd2VzcycsICdjb25zdGFudCcsIG9yICdwb2x5bm9taWFsJyIpCiAgICAKICAgIHJldHVybiBiYXNlbGluZV9maXQKCgpkZWYgZml0X3dlbGxfYmFzZWxpbmVzKAogICAgZGY6IHBkLkRhdGFGcmFtZSwKICAgIGJhc2VsaW5lX2VuZF90aW1lOiBmbG9hdCA9IDI0LjAsCiAgICBtZXRob2Q6IHN0ciA9ICdsb3dlc3MnLAogICAgZnJhYzogZmxvYXQgPSAwLjUsCiAgICBwb2x5X29yZGVyOiBpbnQgPSAxCikgLT4gRGljdFtzdHIsIHBkLlNlcmllc106CiAgICAiIiIKICAgIEZvciBlYWNoIHdlbGwsIGZpdCBhIHNtb290aCBiYXNlbGluZSBmdW5jdGlvbiBvbiB0aGUgYmFzZWxpbmUgd2luZG93IE9OTFksCiAgICB0aGVuIGV4dHJhcG9sYXRlIG92ZXIgdGhlIGZ1bGwgdGltZWNvdXJzZS4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBkZiA6IHBkLkRhdGFGcmFtZQogICAgICAgIExvbmctZm9ybWF0IERhdGFGcmFtZSB3aXRoIGNvbHVtbnMgWydwbGF0ZV9pZCcsICd3ZWxsJywgJ2NvbnRlbnQnLCAndGltZV9zJywgJ3ZhbHVlJ10KICAgIGJhc2VsaW5lX2VuZF90aW1lIDogZmxvYXQKICAgICAgICBNYXhpbXVtIHRpbWUgKGluIHNlY29uZHMpIGZvciBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQ6IDI0LjApCiAgICBtZXRob2QgOiBzdHIKICAgICAgICBCYXNlbGluZSBmaXR0aW5nIG1ldGhvZDogJ2xvd2VzcycsICdjb25zdGFudCcsIG9yICdwb2x5bm9taWFsJyAoZGVmYXVsdDogJ2NvbnN0YW50JykKICAgIGZyYWMgOiBmbG9hdAogICAgICAgIEZyYWN0aW9uIG9mIGRhdGEgdXNlZCBmb3IgTE9XRVNTIHNtb290aGluZyAoZGVmYXVsdDogMC41KQogICAgcG9seV9vcmRlciA6IGludAogICAgICAgIFBvbHlub21pYWwgb3JkZXIgZm9yIHBvbHlub21pYWwgZml0IChkZWZhdWx0OiAxKQogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIERpY3Rbc3RyLCBwZC5TZXJpZXNdCiAgICAgICAgRGljdGlvbmFyeSBtYXBwaW5nIHdlbGxfaWQgdG8gU2VyaWVzIG9mIGZpdHRlZCBiYXNlbGluZSB2YWx1ZXMgKGluZGV4ZWQgYnkgdGltZV9zKQogICAgIiIiCiAgICBiYXNlbGluZV9maXRzID0ge30KICAgIAogICAgIyBHZXQgYmFzZWxpbmUgd2luZG93cyBmb3IgZWFjaCB3ZWxsCiAgICBiYXNlbGluZV93aW5kb3dzID0gaWRlbnRpZnlfYmFzZWxpbmVfd2luZG93KGRmLCBiYXNlbGluZV9lbmRfdGltZSkKICAgIAogICAgIyBGaXQgYmFzZWxpbmUgZm9yIGVhY2ggd2VsbAogICAgZm9yIHdlbGxfaWQsIHdlbGxfZGYgaW4gZGYuZ3JvdXBieSgnd2VsbCcpOgogICAgICAgICMgR2V0IGZ1bGwgdGltZWNvdXJzZSBmb3IgdGhpcyB3ZWxsCiAgICAgICAgZnVsbF90aW1lY291cnNlID0gd2VsbF9kZi5zb3J0X3ZhbHVlcygndGltZV9zJykKICAgICAgICAKICAgICAgICAjIEdldCBiYXNlbGluZSB3aW5kb3cKICAgICAgICBiYXNlbGluZV93aW5kb3cgPSBiYXNlbGluZV93aW5kb3dzLmdldCh3ZWxsX2lkKQogICAgICAgIAogICAgICAgIGlmIGJhc2VsaW5lX3dpbmRvdyBpcyBOb25lIG9yIGxlbihiYXNlbGluZV93aW5kb3cpID09IDA6CiAgICAgICAgICAgICMgTm8gYmFzZWxpbmUgZGF0YSwgY3JlYXRlIE5hTiBzZXJpZXMKICAgICAgICAgICAgYmFzZWxpbmVfZml0c1t3ZWxsX2lkXSA9IHBkLlNlcmllcygKICAgICAgICAgICAgICAgIGluZGV4PWZ1bGxfdGltZWNvdXJzZVsndGltZV9zJ10sCiAgICAgICAgICAgICAgICBkdHlwZT1mbG9hdAogICAgICAgICAgICApCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgCiAgICAgICAgIyBTb3J0IGJhc2VsaW5lIHdpbmRvdyBieSB0aW1lCiAgICAgICAgYmFzZWxpbmVfd2luZG93ID0gYmFzZWxpbmVfd2luZG93LnNvcnRfdmFsdWVzKCd0aW1lX3MnKQogICAgICAgIAogICAgICAgICMgRml0IGJhc2VsaW5lIG9uIGJhc2VsaW5lIHdpbmRvdyBvbmx5CiAgICAgICAgYmFzZWxpbmVfZml0ID0gZml0X2Jhc2VsaW5lKAogICAgICAgICAgICBiYXNlbGluZV93aW5kb3dbJ3RpbWVfcyddLAogICAgICAgICAgICBiYXNlbGluZV93aW5kb3dbJ3ZhbHVlJ10sCiAgICAgICAgICAgIG1ldGhvZD1tZXRob2QsCiAgICAgICAgICAgIGZyYWM9ZnJhYywKICAgICAgICAgICAgcG9seV9vcmRlcj1wb2x5X29yZGVyLAogICAgICAgICAgICB3ZWxsX2lkPXdlbGxfaWQKICAgICAgICApCiAgICAgICAgCiAgICAgICAgIyBFeHRyYXBvbGF0ZSB0byBmdWxsIHRpbWVjb3Vyc2UKICAgICAgICAjIEludGVycG9sYXRlIGJhc2VsaW5lIGZpdCB0byBhbGwgdGltZXBvaW50cyBpbiBmdWxsIHRpbWVjb3Vyc2UKICAgICAgICBmcm9tIHNjaXB5LmludGVycG9sYXRlIGltcG9ydCBpbnRlcnAxZAogICAgICAgIAogICAgICAgICMgR2V0IHVuaXF1ZSB0aW1lcG9pbnRzIGZyb20gYmFzZWxpbmUgZml0CiAgICAgICAgYmFzZWxpbmVfdGltZXMgPSBiYXNlbGluZV9maXQuaW5kZXgudmFsdWVzCiAgICAgICAgYmFzZWxpbmVfdmFsdWVzID0gYmFzZWxpbmVfZml0LnZhbHVlcwogICAgICAgIAogICAgICAgICMgQ3JlYXRlIGludGVycG9sYXRpb24gZnVuY3Rpb24KICAgICAgICBpbnRlcnBfZnVuYyA9IGludGVycDFkKAogICAgICAgICAgICBiYXNlbGluZV90aW1lcywKICAgICAgICAgICAgYmFzZWxpbmVfdmFsdWVzLAogICAgICAgICAgICBraW5kPSdsaW5lYXInLAogICAgICAgICAgICBib3VuZHNfZXJyb3I9RmFsc2UsCiAgICAgICAgICAgIGZpbGxfdmFsdWU9J2V4dHJhcG9sYXRlJwogICAgICAgICkKICAgICAgICAKICAgICAgICAjIEludGVycG9sYXRlIHRvIGZ1bGwgdGltZWNvdXJzZSB0aW1lcG9pbnRzCiAgICAgICAgZnVsbF90aW1lcyA9IGZ1bGxfdGltZWNvdXJzZVsndGltZV9zJ10udmFsdWVzCiAgICAgICAgZXh0cmFwb2xhdGVkX2Jhc2VsaW5lID0gcGQuU2VyaWVzKAogICAgICAgICAgICBpbnRlcnBfZnVuYyhmdWxsX3RpbWVzKSwKICAgICAgICAgICAgaW5kZXg9ZnVsbF90aW1lY291cnNlWyd0aW1lX3MnXQogICAgICAgICkKICAgICAgICAKICAgICAgICBiYXNlbGluZV9maXRzW3dlbGxfaWRdID0gZXh0cmFwb2xhdGVkX2Jhc2VsaW5lCiAgICAKICAgIHJldHVybiBiYXNlbGluZV9maXRzCgoKZGVmIG5vcm1hbGl6ZV93ZWxscygKICAgIGRmOiBwZC5EYXRhRnJhbWUsCiAgICBiYXNlbGluZV9maXRzOiBEaWN0W3N0ciwgcGQuU2VyaWVzXSwKICAgIG5vcm1hbGl6YXRpb25fbW9kZTogc3RyID0gJ211bHRpcGxpY2F0aXZlJwopIC0+IHBkLkRhdGFGcmFtZToKICAgICIiIgogICAgRm9yIGVhY2ggd2VsbCBhbmQgZWFjaCB0aW1lcG9pbnQsIGNvbXB1dGUgbm9ybWFsaXplZCBmbHVvcmVzY2VuY2UgdXNpbmcgdGhlIGZpdHRlZCBiYXNlbGluZS4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBkZiA6IHBkLkRhdGFGcmFtZQogICAgICAgIExvbmctZm9ybWF0IERhdGFGcmFtZSB3aXRoIGNvbHVtbnMgWydwbGF0ZV9pZCcsICd3ZWxsJywgJ2NvbnRlbnQnLCAndGltZV9zJywgJ3ZhbHVlJ10KICAgIGJhc2VsaW5lX2ZpdHMgOiBEaWN0W3N0ciwgcGQuU2VyaWVzXQogICAgICAgIERpY3Rpb25hcnkgbWFwcGluZyB3ZWxsX2lkIHRvIFNlcmllcyBvZiBmaXR0ZWQgYmFzZWxpbmUgdmFsdWVzCiAgICBub3JtYWxpemF0aW9uX21vZGUgOiBzdHIKICAgICAgICBOb3JtYWxpemF0aW9uIG1vZGUgKGRlZmF1bHQ6ICdtdWx0aXBsaWNhdGl2ZScpCiAgICAgICAgLSAnZGVsdGFfZl9vdmVyX2YnOiDOlEYvRiBub3JtYWxpemF0aW9uLiBGb3JtdWxhOiBGJyh0KSA9IChGKHQpIC0gZyh0KSkgLyBnKHQpCiAgICAgICAgICBVc2Ugd2hlbiB5b3Ugd2FudCB0byBtZWFzdXJlIHJlbGF0aXZlIGNoYW5nZSBmcm9tIGJhc2VsaW5lLiBCZXN0IGZvciBkZXRlY3RpbmcKICAgICAgICAgIGluY3JlYXNlcy9kZWNyZWFzZXMgcmVsYXRpdmUgdG8gYmFzZWxpbmUuIFZhbHVlcyBjYW4gYmUgbmVnYXRpdmUgKGJlbG93IGJhc2VsaW5lKQogICAgICAgICAgb3IgcG9zaXRpdmUgKGFib3ZlIGJhc2VsaW5lKS4KICAgICAgICAtICdtdWx0aXBsaWNhdGl2ZSc6IE11bHRpcGxpY2F0aXZlIG5vcm1hbGl6YXRpb24uIEZvcm11bGE6IEZfbm9ybSh0KSA9IEYodCkgLyBnKHQpCiAgICAgICAgICBVc2Ugd2hlbiB5b3Ugd2FudCB0byBub3JtYWxpemUgYnkgYmFzZWxpbmUgd2l0aG91dCBzdWJ0cmFjdGluZy4gQmVzdCBmb3IgZm9sZC1jaGFuZ2UKICAgICAgICAgIGFuYWx5c2lzLiBWYWx1ZXMgYXJlIGFsd2F5cyBwb3NpdGl2ZSAocmF0aW8gdG8gYmFzZWxpbmUpLgogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIHBkLkRhdGFGcmFtZQogICAgICAgIERhdGFGcmFtZSB3aXRoIHNhbWUgc2hhcGUgYXMgaW5wdXQgYnV0IHdpdGggbm9ybWFsaXplZCAndmFsdWUnIGNvbHVtbgogICAgIiIiCiAgICBub3JtX2RmID0gZGYuY29weSgpCiAgICBub3JtX3ZhbHVlcyA9IFtdCiAgICAKICAgIGZvciBpZHgsIHJvdyBpbiBkZi5pdGVycm93cygpOgogICAgICAgIHdlbGxfaWQgPSByb3dbJ3dlbGwnXQogICAgICAgIHRpbWVfcyA9IHJvd1sndGltZV9zJ10KICAgICAgICB2YWx1ZSA9IHJvd1sndmFsdWUnXQogICAgICAgIAogICAgICAgICMgR2V0IGJhc2VsaW5lIGZpdCBmb3IgdGhpcyB3ZWxsCiAgICAgICAgYmFzZWxpbmVfc2VyaWVzID0gYmFzZWxpbmVfZml0cy5nZXQod2VsbF9pZCkKICAgICAgICAKICAgICAgICBpZiBiYXNlbGluZV9zZXJpZXMgaXMgTm9uZSBvciBsZW4oYmFzZWxpbmVfc2VyaWVzKSA9PSAwOgogICAgICAgICAgICBub3JtX3ZhbHVlcy5hcHBlbmQobnAubmFuKQogICAgICAgICAgICBjb250aW51ZQogICAgICAgIAogICAgICAgICMgRmluZCBjbG9zZXN0IHRpbWVwb2ludCBpbiBiYXNlbGluZSBzZXJpZXMKICAgICAgICBiYXNlbGluZV90aW1lcyA9IGJhc2VsaW5lX3Nlcmllcy5pbmRleC52YWx1ZXMKICAgICAgICBjbG9zZXN0X2lkeCA9IG5wLmFyZ21pbihucC5hYnMoYmFzZWxpbmVfdGltZXMgLSB0aW1lX3MpKQogICAgICAgIGJhc2VsaW5lX3ZhbHVlID0gYmFzZWxpbmVfc2VyaWVzLmlsb2NbY2xvc2VzdF9pZHhdCiAgICAgICAgCiAgICAgICAgaWYgcGQuaXNuYShiYXNlbGluZV92YWx1ZSkgb3IgYmFzZWxpbmVfdmFsdWUgPT0gMDoKICAgICAgICAgICAgbm9ybV92YWx1ZXMuYXBwZW5kKG5wLm5hbikKICAgICAgICAgICAgY29udGludWUKICAgICAgICAKICAgICAgICAjIEFwcGx5IG5vcm1hbGl6YXRpb24KICAgICAgICBpZiBub3JtYWxpemF0aW9uX21vZGUgPT0gJ2RlbHRhX2Zfb3Zlcl9mJzoKICAgICAgICAgICAgIyDOlEYvRiA9IChGKHQpIC0gZyh0KSkgLyBnKHQpCiAgICAgICAgICAgIG5vcm1fdmFsdWUgPSAodmFsdWUgLSBiYXNlbGluZV92YWx1ZSkgLyBiYXNlbGluZV92YWx1ZQogICAgICAgIGVsaWYgbm9ybWFsaXphdGlvbl9tb2RlID09ICdtdWx0aXBsaWNhdGl2ZSc6CiAgICAgICAgICAgICMgRl9ub3JtKHQpID0gRih0KSAvIGcodCkKICAgICAgICAgICAgbm9ybV92YWx1ZSA9IHZhbHVlIC8gYmFzZWxpbmVfdmFsdWUKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAgICAgZiJVbmtub3duIG5vcm1hbGl6YXRpb25fbW9kZToge25vcm1hbGl6YXRpb25fbW9kZX0uICIKICAgICAgICAgICAgICAgICJDaG9vc2UgZnJvbSAnZGVsdGFfZl9vdmVyX2YnIG9yICdtdWx0aXBsaWNhdGl2ZSciCiAgICAgICAgICAgICkKICAgICAgICAKICAgICAgICBub3JtX3ZhbHVlcy5hcHBlbmQobm9ybV92YWx1ZSkKICAgIAogICAgbm9ybV9kZlsndmFsdWUnXSA9IG5vcm1fdmFsdWVzCiAgICByZXR1cm4gbm9ybV9kZgoKCmRlZiBnZXRfdHJpcGxpY2F0ZV9ncm91cF9jb2xvcigKICAgIGdyb3VwX25hbWU6IHN0ciwKICAgIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lCikgLT4gc3RyOgogICAgIiIiCiAgICBHZXQgdGhlIGNvbG9yIGZvciBhIHRyaXBsaWNhdGUgZ3JvdXAgbmFtZS4KICAgIE1hdGNoZXMgdGhlIGNvbG9yIGFzc2lnbm1lbnQgZnJvbSB0aGUgd2ViIGludGVyZmFjZS4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBncm91cF9uYW1lIDogc3RyCiAgICAgICAgTmFtZSBvZiB0aGUgdHJpcGxpY2F0ZSBncm91cAogICAgY29uZmlnIDogRGljdFtzdHIsIEFueV0sIG9wdGlvbmFsCiAgICAgICAgQ29uZmlndXJhdGlvbiBkaWN0aW9uYXJ5IHdpdGggJ3RyaXBsaWNhdGVfZ3JvdXBzJyBrZXkKICAgIAogICAgUmV0dXJuczoKICAgIC0tLS0tLS0tCiAgICBzdHIKICAgICAgICBIZXggY29sb3IgY29kZSBmb3IgdGhlIGdyb3VwCiAgICAiIiIKICAgIGlmIGNvbmZpZyBpcyBOb25lOgogICAgICAgIHNjcmlwdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgICAgICBjb25maWdfcGF0aCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAicGxhdGVfY29uZmlnLmpzb24iKQogICAgICAgIGNvbmZpZyA9IGxvYWRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgCiAgICB0cmlwbGljYXRlX2dyb3VwcyA9IGNvbmZpZy5nZXQoInRyaXBsaWNhdGVfZ3JvdXBzIiwgREVGQVVMVF9UUklQTElDQVRFX0dST1VQUykKICAgIAogICAgIyBCdWlsZCBjb2xvciBtYXA6IGdyb3VwIG5hbWUgLT4gY29sb3IgaW5kZXgKICAgIGNvbG9yX21hcCA9IHt9CiAgICBmb3IgaWR4LCBncm91cCBpbiBlbnVtZXJhdGUodHJpcGxpY2F0ZV9ncm91cHMpOgogICAgICAgIG5hbWUgPSBncm91cC5nZXQoIm5hbWUiLCAiIikuc3RyaXAoKQogICAgICAgIGlmIG5hbWUgYW5kIG5hbWUgbm90IGluIGNvbG9yX21hcDoKICAgICAgICAgICAgY29sb3JfbWFwW25hbWVdID0gaWR4CiAgICAKICAgICMgR2V0IGNvbG9yIGluZGV4IGZvciB0aGlzIGdyb3VwCiAgICBub3JtYWxpemVkX25hbWUgPSBncm91cF9uYW1lLnN0cmlwKCkgaWYgZ3JvdXBfbmFtZSBlbHNlICIiCiAgICBjb2xvcl9pZHggPSBjb2xvcl9tYXAuZ2V0KG5vcm1hbGl6ZWRfbmFtZSwgMCkKICAgIAogICAgIyBSZXR1cm4gY29sb3IgZnJvbSBwYWxldHRlIChjeWNsZSBpZiBuZWVkZWQpCiAgICByZXR1cm4gVFJJUExJQ0FURV9DT0xPUlNbY29sb3JfaWR4ICUgbGVuKFRSSVBMSUNBVEVfQ09MT1JTKV0KCgpkZWYgYnVpbGRfY29uZGl0aW9uX21hcCgKICAgIGRmOiBwZC5EYXRhRnJhbWUsCiAgICBjb25maWc6IERpY3Rbc3RyLCBBbnldID0gTm9uZQopIC0+IERpY3Rbc3RyLCBzdHJdOgogICAgIiIiCiAgICBCdWlsZCBhIG1hcHBpbmcgZnJvbSB3ZWxsX2lkIHRvIGNvbmRpdGlvbiBuYW1lLgogICAgCiAgICBVc2VzIHRyaXBsaWNhdGUgZ3JvdXAgbmFtZXMgZnJvbSBjb25maWcgdG8gYXNzaWduIGNvbmRpdGlvbnMuCiAgICBXZWxscyBpbiB0aGUgc2FtZSB0cmlwbGljYXRlIGdyb3VwIChzYW1lIHJvdyBwYXR0ZXJuKSBnZXQgdGhlIHNhbWUgY29uZGl0aW9uLgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIGRmIDogcGQuRGF0YUZyYW1lCiAgICAgICAgTG9uZy1mb3JtYXQgRGF0YUZyYW1lIHdpdGggY29sdW1ucyBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgY29uZmlnIDogRGljdFtzdHIsIEFueV0KICAgICAgICBDb25maWd1cmF0aW9uIGRpY3Rpb25hcnkgd2l0aCAndHJpcGxpY2F0ZV9ncm91cHMnIGtleQogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIERpY3Rbc3RyLCBzdHJdCiAgICAgICAgRGljdGlvbmFyeSBtYXBwaW5nIHdlbGxfaWQgdG8gY29uZGl0aW9uIG5hbWUKICAgICIiIgogICAgaWYgY29uZmlnIGlzIE5vbmU6CiAgICAgICAgc2NyaXB0X2RpciA9IG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmFic3BhdGgoX19maWxlX18pKQogICAgICAgIGNvbmZpZ19wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJwbGF0ZV9jb25maWcuanNvbiIpCiAgICAgICAgY29uZmlnID0gbG9hZF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAKICAgIGNvbmRpdGlvbl9tYXAgPSB7fQogICAgdHJpcGxpY2F0ZV9ncm91cHMgPSBjb25maWcuZ2V0KCJ0cmlwbGljYXRlX2dyb3VwcyIsIERFRkFVTFRfVFJJUExJQ0FURV9HUk9VUFMpCiAgICAKICAgICMgQnVpbGQgbWFwcGluZzogcm93X2xldHRlciAtPiBjb25kaXRpb24gbmFtZQogICAgcm93X3RvX2NvbmRpdGlvbiA9IHt9CiAgICBmb3IgZ3JvdXAgaW4gdHJpcGxpY2F0ZV9ncm91cHM6CiAgICAgICAgZ3JvdXBfbmFtZSA9IGdyb3VwLmdldCgibmFtZSIsICIiKQogICAgICAgIGdyb3VwX3dlbGxzID0gZ3JvdXAuZ2V0KCJ3ZWxscyIsIFtdKQogICAgICAgIGZvciB3ZWxsX3BhdHRlcm4gaW4gZ3JvdXBfd2VsbHM6CiAgICAgICAgICAgICMgRXh0cmFjdCByb3cgbGV0dGVyIGZyb20gd2VsbCBwYXR0ZXJuIChlLmcuLCAiQiIgZnJvbSAiQiIgb3IgIkIxMyIpCiAgICAgICAgICAgIHJvd19sZXR0ZXIgPSB3ZWxsX3BhdHRlcm5bMF0gaWYgd2VsbF9wYXR0ZXJuIGFuZCB3ZWxsX3BhdHRlcm5bMF0uaXNhbHBoYSgpIGVsc2UgIiIKICAgICAgICAgICAgaWYgcm93X2xldHRlcjoKICAgICAgICAgICAgICAgIHJvd190b19jb25kaXRpb25bcm93X2xldHRlcl0gPSBncm91cF9uYW1lCiAgICAKICAgICMgTWFwIGVhY2ggd2VsbCB0byBpdHMgY29uZGl0aW9uIGJhc2VkIG9uIHJvdyBsZXR0ZXIKICAgIGZvciB3ZWxsX2lkIGluIGRmWyd3ZWxsJ10udW5pcXVlKCk6CiAgICAgICAgaWYgd2VsbF9pZCBhbmQgbGVuKHdlbGxfaWQpID4gMDoKICAgICAgICAgICAgcm93X2xldHRlciA9IHdlbGxfaWRbMF0gaWYgd2VsbF9pZFswXS5pc2FscGhhKCkgZWxzZSAiIgogICAgICAgICAgICBjb25kaXRpb24gPSByb3dfdG9fY29uZGl0aW9uLmdldChyb3dfbGV0dGVyLCB3ZWxsX2lkKSAgIyBEZWZhdWx0IHRvIHdlbGxfaWQgaWYgbm90IGZvdW5kCiAgICAgICAgICAgIGNvbmRpdGlvbl9tYXBbd2VsbF9pZF0gPSBjb25kaXRpb24KICAgIAogICAgcmV0dXJuIGNvbmRpdGlvbl9tYXAKCgpkZWYgY29tcHV0ZV9jb25kaXRpb25fc3RhdGlzdGljcygKICAgIG5vcm1fZGY6IHBkLkRhdGFGcmFtZSwKICAgIGNvbmRpdGlvbl9tYXA6IERpY3Rbc3RyLCBzdHJdCikgLT4gcGQuRGF0YUZyYW1lOgogICAgIiIiCiAgICBHcm91cCB3ZWxscyBieSBjb25kaXRpb24gYW5kIGNvbXB1dGUgbWVhbiDCsSBTRU0gZm9yIGVhY2ggY29uZGl0aW9uIGFuZCB0aW1lcG9pbnQuCiAgICAKICAgIFBhcmFtZXRlcnM6CiAgICAtLS0tLS0tLS0tLQogICAgbm9ybV9kZiA6IHBkLkRhdGFGcmFtZQogICAgICAgIE5vcm1hbGl6ZWQgRGF0YUZyYW1lIHdpdGggY29sdW1ucyBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgY29uZGl0aW9uX21hcCA6IERpY3Rbc3RyLCBzdHJdCiAgICAgICAgRGljdGlvbmFyeSBtYXBwaW5nIHdlbGxfaWQgdG8gY29uZGl0aW9uIG5hbWUKICAgIAogICAgUmV0dXJuczoKICAgIC0tLS0tLS0tCiAgICBwZC5EYXRhRnJhbWUKICAgICAgICBUaWR5IERhdGFGcmFtZSB3aXRoIGNvbHVtbnM6IFsnVGltZV9zJywgJ2NvbmRpdGlvbicsICdtZWFuJywgJ3NkJywgJ3NlbScsICduJ10KICAgICIiIgogICAgaW1wb3J0IG51bXB5IGFzIG5wCiAgICAKICAgICMgQWRkIGNvbmRpdGlvbiBjb2x1bW4KICAgIG5vcm1fZGYgPSBub3JtX2RmLmNvcHkoKQogICAgbm9ybV9kZlsnY29uZGl0aW9uJ10gPSBub3JtX2RmWyd3ZWxsJ10ubWFwKGNvbmRpdGlvbl9tYXApCiAgICAKICAgICMgR3JvdXAgYnkgY29uZGl0aW9uIGFuZCB0aW1lCiAgICByZXN1bHRzID0gW10KICAgIAogICAgZm9yIChjb25kaXRpb24sIHRpbWVfcyksIGdyb3VwIGluIG5vcm1fZGYuZ3JvdXBieShbJ2NvbmRpdGlvbicsICd0aW1lX3MnXSk6CiAgICAgICAgdmFsdWVzID0gZ3JvdXBbJ3ZhbHVlJ10uZHJvcG5hKCkudmFsdWVzCiAgICAgICAgCiAgICAgICAgaWYgbGVuKHZhbHVlcykgPT0gMDoKICAgICAgICAgICAgY29udGludWUKICAgICAgICAKICAgICAgICBuID0gbGVuKHZhbHVlcykKICAgICAgICBtZWFuID0gbnAubWVhbih2YWx1ZXMpCiAgICAgICAgc2QgPSBucC5zdGQodmFsdWVzLCBkZG9mPTEpICAjIFNhbXBsZSBzdGFuZGFyZCBkZXZpYXRpb24KICAgICAgICBzZW0gPSBzZCAvIG5wLnNxcnQobikgaWYgbiA+IDAgZWxzZSBucC5uYW4KICAgICAgICAKICAgICAgICByZXN1bHRzLmFwcGVuZCh7CiAgICAgICAgICAgICdUaW1lX3MnOiB0aW1lX3MsCiAgICAgICAgICAgICdjb25kaXRpb24nOiBjb25kaXRpb24sCiAgICAgICAgICAgICdtZWFuJzogbWVhbiwKICAgICAgICAgICAgJ3NkJzogc2QsCiAgICAgICAgICAgICdzZW0nOiBzZW0sCiAgICAgICAgICAgICduJzogbgogICAgICAgIH0pCiAgICAKICAgIHN0YXRzX2RmID0gcGQuRGF0YUZyYW1lKHJlc3VsdHMpCiAgICByZXR1cm4gc3RhdHNfZGYuc29ydF92YWx1ZXMoWydjb25kaXRpb24nLCAnVGltZV9zJ10pLnJlc2V0X2luZGV4KGRyb3A9VHJ1ZSkKCgpkZWYgcGxvdF90aW1lY291cnNlKAogICAgc3RhdHNfZGY6IHBkLkRhdGFGcmFtZSwKICAgIGNvbmRpdGlvbnM6IExpc3Rbc3RyXSA9IE5vbmUsCiAgICBmaWdzaXplOiB0dXBsZSA9ICgxMCwgNiksCiAgICBzYXZlX3BhdGg6IHN0ciA9IE5vbmUsCiAgICBjb25maWc6IERpY3Rbc3RyLCBBbnldID0gTm9uZQopOgogICAgIiIiCiAgICBHZW5lcmF0ZSB0aW1lLWNvdXJzZSBwbG90cyB3aXRoIG1lYW4gwrEgU0VNIGZvciBlYWNoIGNvbmRpdGlvbi4KICAgIFVzZXMgdHJpcGxpY2F0ZSBncm91cCBjb2xvcnMgdG8gbWF0Y2ggdGhlIHdlYiBpbnRlcmZhY2UuCiAgICAKICAgIFBhcmFtZXRlcnM6CiAgICAtLS0tLS0tLS0tLQogICAgc3RhdHNfZGYgOiBwZC5EYXRhRnJhbWUKICAgICAgICBTdGF0aXN0aWNzIERhdGFGcmFtZSB3aXRoIGNvbHVtbnMgWydUaW1lX3MnLCAnY29uZGl0aW9uJywgJ21lYW4nLCAnc2VtJ10KICAgIGNvbmRpdGlvbnMgOiBMaXN0W3N0cl0sIG9wdGlvbmFsCiAgICAgICAgU3Vic2V0IG9mIGNvbmRpdGlvbnMgdG8gcGxvdC4gSWYgTm9uZSwgcGxvdHMgYWxsIGNvbmRpdGlvbnMuCiAgICBmaWdzaXplIDogdHVwbGUKICAgICAgICBGaWd1cmUgc2l6ZSAod2lkdGgsIGhlaWdodCkgaW4gaW5jaGVzIChkZWZhdWx0OiAoMTAsIDYpKQogICAgc2F2ZV9wYXRoIDogc3RyLCBvcHRpb25hbAogICAgICAgIFBhdGggdG8gc2F2ZSB0aGUgZmlndXJlLiBJZiBOb25lLCBkaXNwbGF5cyB0aGUgcGxvdC4KICAgIGNvbmZpZyA6IERpY3Rbc3RyLCBBbnldLCBvcHRpb25hbAogICAgICAgIENvbmZpZ3VyYXRpb24gZGljdGlvbmFyeSB3aXRoICd0cmlwbGljYXRlX2dyb3Vwcycga2V5CiAgICAiIiIKICAgIGltcG9ydCBtYXRwbG90bGliLnB5cGxvdCBhcyBwbHQKICAgIAogICAgaWYgY29uZmlnIGlzIE5vbmU6CiAgICAgICAgc2NyaXB0X2RpciA9IG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmFic3BhdGgoX19maWxlX18pKQogICAgICAgIGNvbmZpZ19wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJwbGF0ZV9jb25maWcuanNvbiIpCiAgICAgICAgY29uZmlnID0gbG9hZF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAKICAgIGlmIGNvbmRpdGlvbnMgaXMgTm9uZToKICAgICAgICBjb25kaXRpb25zID0gc3RhdHNfZGZbJ2NvbmRpdGlvbiddLnVuaXF1ZSgpCiAgICAKICAgIGZpZywgYXggPSBwbHQuc3VicGxvdHMoZmlnc2l6ZT1maWdzaXplKQogICAgCiAgICBmb3IgaWR4LCBjb25kaXRpb24gaW4gZW51bWVyYXRlKGNvbmRpdGlvbnMpOgogICAgICAgIGNvbmRfZGF0YSA9IHN0YXRzX2RmW3N0YXRzX2RmWydjb25kaXRpb24nXSA9PSBjb25kaXRpb25dLnNvcnRfdmFsdWVzKCdUaW1lX3MnKQogICAgICAgIAogICAgICAgIGlmIGxlbihjb25kX2RhdGEpID09IDA6CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgCiAgICAgICAgdGltZXMgPSBjb25kX2RhdGFbJ1RpbWVfcyddLnZhbHVlcwogICAgICAgIG1lYW5zID0gY29uZF9kYXRhWydtZWFuJ10udmFsdWVzCiAgICAgICAgc2VtcyA9IGNvbmRfZGF0YVsnc2VtJ10udmFsdWVzCiAgICAgICAgCiAgICAgICAgIyBHZXQgY29sb3IgZm9yIHRoaXMgY29uZGl0aW9uICh0cmlwbGljYXRlIGdyb3VwIG5hbWUpCiAgICAgICAgIyBVc2UgdHJpcGxpY2F0ZSBncm91cCBjb2xvciBpZiBjb25kaXRpb24gbWF0Y2hlcyBhIGdyb3VwIG5hbWUsIG90aGVyd2lzZSB1c2UgZGVmYXVsdCBwYWxldHRlCiAgICAgICAgY29sb3IgPSBnZXRfdHJpcGxpY2F0ZV9ncm91cF9jb2xvcihjb25kaXRpb24sIGNvbmZpZykKICAgICAgICAKICAgICAgICAjIFBsb3QgbGluZQogICAgICAgIGF4LnBsb3QodGltZXMsIG1lYW5zLCBsYWJlbD1jb25kaXRpb24sIGNvbG9yPWNvbG9yLCBsaW5ld2lkdGg9MikKICAgICAgICAKICAgICAgICAjIFBsb3QgZXJyb3IgYmFycwogICAgICAgIGF4LmVycm9yYmFyKAogICAgICAgICAgICB0aW1lcywgbWVhbnMsIHllcnI9c2VtcywKICAgICAgICAgICAgY29sb3I9Y29sb3IsCiAgICAgICAgICAgIGFscGhhPTAuNSwKICAgICAgICAgICAgY2Fwc2l6ZT0zLAogICAgICAgICAgICBjYXB0aGljaz0xLAogICAgICAgICAgICBlbGluZXdpZHRoPTEKICAgICAgICApCiAgICAKICAgIGF4LnNldF94bGFiZWwoJ1RpbWUgKHMpJywgZm9udHNpemU9MTIpCiAgICBheC5zZXRfeWxhYmVsKCfOlEYvRicsIGZvbnRzaXplPTEyKQogICAgYXguc2V0X3RpdGxlKCdUaW1lIENvdXJzZSBieSBDb25kaXRpb24nLCBmb250c2l6ZT0xNCkKICAgIGF4LmxlZ2VuZChsb2M9J2Jlc3QnLCBmb250c2l6ZT0xMCkKICAgIGF4LmdyaWQoVHJ1ZSwgYWxwaGE9MC4zKQogICAgCiAgICBwbHQudGlnaHRfbGF5b3V0KCkKICAgIAogICAgaWYgc2F2ZV9wYXRoOgogICAgICAgIHBsdC5zYXZlZmlnKHNhdmVfcGF0aCwgZHBpPTMwMCwgYmJveF9pbmNoZXM9J3RpZ2h0JykKICAgICAgICBwcmludChmIlBsb3Qgc2F2ZWQgdG8ge3NhdmVfcGF0aH0iKQogICAgZWxzZToKICAgICAgICBwbHQuc2hvdygpCiAgICAKICAgIHBsdC5jbG9zZSgpCgoKZGVmIHByaW50X2Jhc2VsaW5lX29wdGlvbnMoKToKICAgICIiIgogICAgUHJpbnQgZGVzY3JpcHRpb25zIG9mIGJhc2VsaW5lIGZpdHRpbmcgYW5kIG5vcm1hbGl6YXRpb24gb3B0aW9ucy4KICAgICIiIgogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgiQkFTRUxJTkUgRklUVElORyBPUFRJT05TIikKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoIlxuMS4gTE9XRVNTIChMb2NhbGx5IFdlaWdodGVkIFNjYXR0ZXJwbG90IFNtb290aGluZykiKQogICAgcHJpbnQoIiAgIEZvcm11bGE6IGcodCkgPSBMT1dFU1MoRl9iYXNlbGluZSwgdF9iYXNlbGluZSwgZnJhYykiKQogICAgcHJpbnQoIiAgIFdoZW4gdG8gdXNlOiBCYXNlbGluZSBoYXMgZ3JhZHVhbCBkcmlmdCBvciBub24tbGluZWFyIHRyZW5kcyIpCiAgICBwcmludCgiICAgQmVzdCBmb3I6IE5vbi1saW5lYXIgYmFzZWxpbmVzIHdpdGggc21vb3RoIHRyZW5kcyIpCiAgICBwcmludCgiICAgUGFyYW1ldGVyczoiKQogICAgcHJpbnQoIiAgICAgLSBmcmFjOiBGcmFjdGlvbiBvZiBkYXRhIHVzZWQgZm9yIHNtb290aGluZyAoZGVmYXVsdDogMC41KSIpCiAgICBwcmludCgiICAgICAgICogSGlnaGVyIGZyYWMgKDAuNy0wLjkpID0gc21vb3RoZXIsIG1vcmUgZ2xvYmFsIGZpdCIpCiAgICBwcmludCgiICAgICAgICogTG93ZXIgZnJhYyAoMC4yLTAuNCkgPSBtb3JlIGxvY2FsLCBmb2xsb3dzIGRhdGEgY2xvc2VseSIpCiAgICBwcmludCgpCiAgICBwcmludCgiMi4gQ09OU1RBTlQgKDB0aC1vcmRlciBwb2x5bm9taWFsKSIpCiAgICBwcmludCgiICAgRm9ybXVsYTogZyh0KSA9IG1lYW4oRl9iYXNlbGluZSkgZm9yIGFsbCB0IikKICAgIHByaW50KCIgICBXaGVuIHRvIHVzZTogQmFzZWxpbmUgaXMgc3RhYmxlL2ZsYXQgd2l0aCBtaW5pbWFsIGRyaWZ0IikKICAgIHByaW50KCIgICBCZXN0IGZvcjogU3RhYmxlIGJhc2VsaW5lcyB3aXRoIG5vIHRpbWUtZGVwZW5kZW50IHRyZW5kcyIpCiAgICBwcmludCgiICAgUGFyYW1ldGVyczogTm9uZSIpCiAgICBwcmludCgpCiAgICBwcmludCgiMy4gUE9MWU5PTUlBTCAoMXN0LW9yZGVyIG9yIGhpZ2hlcikiKQogICAgcHJpbnQoIiAgIEZvcm11bGE6IGcodCkgPSBj4oKAICsgY+KCgXQgKyBj4oKCdMKyICsgLi4uIikKICAgIHByaW50KCIgICBXaGVuIHRvIHVzZTogQmFzZWxpbmUgaGFzIGxpbmVhciBvciBwb2x5bm9taWFsIGRyaWZ0IikKICAgIHByaW50KCIgICBCZXN0IGZvcjogQmFzZWxpbmVzIHdpdGgga25vd24gcG9seW5vbWlhbCB0cmVuZHMiKQogICAgcHJpbnQoIiAgIFBhcmFtZXRlcnM6IikKICAgIHByaW50KCIgICAgIC0gcG9seV9vcmRlcjogUG9seW5vbWlhbCBvcmRlciAoZGVmYXVsdDogMSA9IGxpbmVhcikiKQogICAgcHJpbnQoIiAgICAgICAqIE9yZGVyIDE6IExpbmVhciBkcmlmdCAoZyh0KSA9IGPigoAgKyBj4oKBdCkiKQogICAgcHJpbnQoIiAgICAgICAqIE9yZGVyIDI6IFF1YWRyYXRpYyBkcmlmdCAoZyh0KSA9IGPigoAgKyBj4oKBdCArIGPigoJ0wrIpIikKICAgIHByaW50KCIgICAgICAgKiBIaWdoZXIgb3JkZXJzOiBNb3JlIGNvbXBsZXggdHJlbmRzIikKICAgIHByaW50KCkKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoIk5PUk1BTElaQVRJT04gT1BUSU9OUyIpCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KCJcbjEuIERFTFRBX0ZfT1ZFUl9GICjOlEYvRikiKQogICAgcHJpbnQoIiAgIEZvcm11bGE6IEYnKHQpID0gKEYodCkgLSBnKHQpKSAvIGcodCkiKQogICAgcHJpbnQoIiAgIFdoZW4gdG8gdXNlOiBNZWFzdXJlIHJlbGF0aXZlIGNoYW5nZSBmcm9tIGJhc2VsaW5lIikKICAgIHByaW50KCIgICBCZXN0IGZvcjogRGV0ZWN0aW5nIGluY3JlYXNlcy9kZWNyZWFzZXMgcmVsYXRpdmUgdG8gYmFzZWxpbmUiKQogICAgcHJpbnQoIiAgIEludGVycHJldGF0aW9uOiIpCiAgICBwcmludCgiICAgICAqIEYnKHQpID0gMDogTm8gY2hhbmdlIGZyb20gYmFzZWxpbmUiKQogICAgcHJpbnQoIiAgICAgKiBGJyh0KSA+IDA6IEluY3JlYXNlIGFib3ZlIGJhc2VsaW5lIChlLmcuLCAwLjUgPSA1MCUgaW5jcmVhc2UpIikKICAgIHByaW50KCIgICAgICogRicodCkgPCAwOiBEZWNyZWFzZSBiZWxvdyBiYXNlbGluZSAoZS5nLiwgLTAuMyA9IDMwJSBkZWNyZWFzZSkiKQogICAgcHJpbnQoIiAgIFZhbHVlcyBjYW4gYmUgbmVnYXRpdmUgKGJlbG93IGJhc2VsaW5lKSBvciBwb3NpdGl2ZSAoYWJvdmUgYmFzZWxpbmUpIikKICAgIHByaW50KCkKICAgIHByaW50KCIyLiBNVUxUSVBMSUNBVElWRSIpCiAgICBwcmludCgiICAgRm9ybXVsYTogRl9ub3JtKHQpID0gRih0KSAvIGcodCkiKQogICAgcHJpbnQoIiAgIFdoZW4gdG8gdXNlOiBOb3JtYWxpemUgYnkgYmFzZWxpbmUgd2l0aG91dCBzdWJ0cmFjdGluZyIpCiAgICBwcmludCgiICAgQmVzdCBmb3I6IEZvbGQtY2hhbmdlIGFuYWx5c2lzIikKICAgIHByaW50KCIgICBJbnRlcnByZXRhdGlvbjoiKQogICAgcHJpbnQoIiAgICAgKiBGX25vcm0odCkgPSAxLjA6IE5vIGNoYW5nZSBmcm9tIGJhc2VsaW5lIikKICAgIHByaW50KCIgICAgICogRl9ub3JtKHQpID0gMi4wOiAyLWZvbGQgaW5jcmVhc2UgKDEwMCUgaW5jcmVhc2UpIikKICAgIHByaW50KCIgICAgICogRl9ub3JtKHQpID0gMC41OiAyLWZvbGQgZGVjcmVhc2UgKDUwJSBvZiBiYXNlbGluZSkiKQogICAgcHJpbnQoIiAgIFZhbHVlcyBhcmUgYWx3YXlzIHBvc2l0aXZlIChyYXRpbyB0byBiYXNlbGluZSkiKQogICAgcHJpbnQoKQogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgiU1RBVElTVElDUyBDT01QVVRBVElPTiIpCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KCJcbkZvciBlYWNoIGNvbmRpdGlvbiBhbmQgdGltZXBvaW50LCB0aGUgZm9sbG93aW5nIHN0YXRpc3RpY3MgYXJlIGNvbXB1dGVkOiIpCiAgICBwcmludCgiICBNZWFuOiDOvCh0KSA9ICgxL24pICogzqMgRicodCkiKQogICAgcHJpbnQoIiAgICBBdmVyYWdlIG5vcm1hbGl6ZWQgdmFsdWUgYWNyb3NzIGFsbCB3ZWxscyBpbiB0aGUgY29uZGl0aW9uIikKICAgIHByaW50KCkKICAgIHByaW50KCIgIFNEOiDPgyh0KSA9IHNxcnQozqMoRicodCkgLSDOvCh0KSnCsiAvIChuLTEpKSIpCiAgICBwcmludCgiICAgIFNhbXBsZSBzdGFuZGFyZCBkZXZpYXRpb24gKGRkb2Y9MSkgYWNyb3NzIHdlbGxzIikKICAgIHByaW50KCkKICAgIHByaW50KCIgIFNFTTogU0VNKHQpID0gz4ModCkgLyBzcXJ0KG4pIikKICAgIHByaW50KCIgICAgU3RhbmRhcmQgZXJyb3Igb2YgdGhlIG1lYW4gPSBTRCAvIHNxcnQobl93ZWxscykiKQogICAgcHJpbnQoIiAgICBOb3RlOiBTRU0gaXMgY29tcHV0ZWQgYWNyb3NzIHdlbGxzLCBub3QgcHJvcGFnYXRlZCBmcm9tIGJhc2VsaW5lIGVycm9yIikKICAgIHByaW50KCkKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoKQoKCmRlZiBwcm9jZXNzX2Jhc2VsaW5lX25vcm1hbGl6YXRpb24oCiAgICBkZjogcGQuRGF0YUZyYW1lLAogICAgYmFzZWxpbmVfZW5kX3RpbWU6IGZsb2F0ID0gMjQuMCwKICAgIGJhc2VsaW5lX21ldGhvZDogc3RyID0gJ2NvbnN0YW50JywKICAgIGJhc2VsaW5lX2ZyYWM6IGZsb2F0ID0gMC41LAogICAgYmFzZWxpbmVfcG9seV9vcmRlcjogaW50ID0gMSwKICAgIG5vcm1hbGl6YXRpb25fbW9kZTogc3RyID0gJ211bHRpcGxpY2F0aXZlJywKICAgIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lLAogICAgb3V0cHV0X2Rpcjogc3RyID0gTm9uZQopIC0+IHR1cGxlOgogICAgIiIiCiAgICBDb21wbGV0ZSBwaXBlbGluZTogYmFzZWxpbmUgaWRlbnRpZmljYXRpb24sIGZpdHRpbmcsIG5vcm1hbGl6YXRpb24sIGFuZCBzdGF0aXN0aWNzLgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIGRmIDogcGQuRGF0YUZyYW1lCiAgICAgICAgTG9uZy1mb3JtYXQgRGF0YUZyYW1lIHdpdGggY29sdW1ucyBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgYmFzZWxpbmVfZW5kX3RpbWUgOiBmbG9hdAogICAgICAgIE1heGltdW0gdGltZSAoaW4gc2Vjb25kcykgZm9yIGJhc2VsaW5lIHdpbmRvdyAoZGVmYXVsdDogMjQuMCkKICAgIGJhc2VsaW5lX21ldGhvZCA6IHN0cgogICAgICAgIEJhc2VsaW5lIGZpdHRpbmcgbWV0aG9kOiAnbG93ZXNzJywgJ2NvbnN0YW50Jywgb3IgJ3BvbHlub21pYWwnIChkZWZhdWx0OiAnY29uc3RhbnQnKQogICAgYmFzZWxpbmVfZnJhYyA6IGZsb2F0CiAgICAgICAgRnJhY3Rpb24gb2YgZGF0YSB1c2VkIGZvciBMT1dFU1Mgc21vb3RoaW5nIChkZWZhdWx0OiAwLjUpCiAgICBiYXNlbGluZV9wb2x5X29yZGVyIDogaW50CiAgICAgICAgUG9seW5vbWlhbCBvcmRlciBmb3IgcG9seW5vbWlhbCBmaXQgKGRlZmF1bHQ6IDEpCiAgICBub3JtYWxpemF0aW9uX21vZGUgOiBzdHIKICAgICAgICBOb3JtYWxpemF0aW9uIG1vZGU6ICdkZWx0YV9mX292ZXJfZicgb3IgJ211bHRpcGxpY2F0aXZlJyAoZGVmYXVsdDogJ211bHRpcGxpY2F0aXZlJykKICAgIGNvbmZpZyA6IERpY3Rbc3RyLCBBbnldLCBvcHRpb25hbAogICAgICAgIENvbmZpZ3VyYXRpb24gZGljdGlvbmFyeS4gSWYgTm9uZSwgbG9hZHMgZnJvbSBwbGF0ZV9jb25maWcuanNvbgogICAgb3V0cHV0X2RpciA6IHN0ciwgb3B0aW9uYWwKICAgICAgICBEaXJlY3RvcnkgdG8gc2F2ZSBvdXRwdXRzLiBJZiBOb25lLCB1c2VzIGN1cnJlbnQgZGlyZWN0b3J5LgogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIHR1cGxlCiAgICAgICAgKG5vcm1fZGYsIHN0YXRzX2RmLCBiYXNlbGluZV9maXRzKQogICAgICAgIC0gbm9ybV9kZjogTm9ybWFsaXplZCBEYXRhRnJhbWUKICAgICAgICAtIHN0YXRzX2RmOiBDb25kaXRpb24gc3RhdGlzdGljcyBEYXRhRnJhbWUKICAgICAgICAtIGJhc2VsaW5lX2ZpdHM6IERpY3Rpb25hcnkgb2YgYmFzZWxpbmUgZml0cyBwZXIgd2VsbAogICAgIiIiCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KCJCQVNFTElORSBJREVOVElGSUNBVElPTiBBTkQgTk9STUFMSVpBVElPTiBQSVBFTElORSIpCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KGYiXG5DdXJyZW50IFNldHRpbmdzOiIpCiAgICBwcmludChmIiAgQmFzZWxpbmUgd2luZG93OiBUaW1lX3MgPD0ge2Jhc2VsaW5lX2VuZF90aW1lfSBzIikKICAgIHByaW50KGYiICBCYXNlbGluZSBtZXRob2Q6IHtiYXNlbGluZV9tZXRob2R9IikKICAgIGlmIGJhc2VsaW5lX21ldGhvZCA9PSAnbG93ZXNzJzoKICAgICAgICBwcmludChmIiAgICBMT1dFU1Mgc21vb3RoaW5nIGZyYWN0aW9uIChmcmFjKToge2Jhc2VsaW5lX2ZyYWN9IikKICAgIGVsaWYgYmFzZWxpbmVfbWV0aG9kID09ICdwb2x5bm9taWFsJzoKICAgICAgICBwcmludChmIiAgICBQb2x5bm9taWFsIG9yZGVyOiB7YmFzZWxpbmVfcG9seV9vcmRlcn0iKQogICAgcHJpbnQoZiIgIE5vcm1hbGl6YXRpb24gbW9kZToge25vcm1hbGl6YXRpb25fbW9kZX0iKQogICAgcHJpbnQoKQogICAgcHJpbnQoIkZvciBkZXRhaWxlZCBvcHRpb24gZGVzY3JpcHRpb25zLCBjYWxsOiBwcmludF9iYXNlbGluZV9vcHRpb25zKCkiKQogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgpCiAgICAKICAgIHByaW50KCJTdGVwIDE6IElkZW50aWZ5aW5nIGJhc2VsaW5lIHdpbmRvd3MuLi4iLCBmbHVzaD1UcnVlKQogICAgYmFzZWxpbmVfd2luZG93cyA9IGlkZW50aWZ5X2Jhc2VsaW5lX3dpbmRvdyhkZiwgYmFzZWxpbmVfZW5kX3RpbWUpCiAgICBwcmludChmIiAgSWRlbnRpZmllZCBiYXNlbGluZSB3aW5kb3dzIGZvciB7bGVuKGJhc2VsaW5lX3dpbmRvd3MpfSB3ZWxscyIsIGZsdXNoPVRydWUpCiAgICB0b3RhbF9iYXNlbGluZV9wb2ludHMgPSBzdW0obGVuKGJ3KSBmb3IgYncgaW4gYmFzZWxpbmVfd2luZG93cy52YWx1ZXMoKSkKICAgIHByaW50KGYiICBUb3RhbCBiYXNlbGluZSBwb2ludHM6IHt0b3RhbF9iYXNlbGluZV9wb2ludHN9IiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgcHJpbnQoIlN0ZXAgMjogRml0dGluZyBiYXNlbGluZXMuLi4iLCBmbHVzaD1UcnVlKQogICAgYmFzZWxpbmVfZml0cyA9IGZpdF93ZWxsX2Jhc2VsaW5lcygKICAgICAgICBkZiwKICAgICAgICBiYXNlbGluZV9lbmRfdGltZT1iYXNlbGluZV9lbmRfdGltZSwKICAgICAgICBtZXRob2Q9YmFzZWxpbmVfbWV0aG9kLAogICAgICAgIGZyYWM9YmFzZWxpbmVfZnJhYywKICAgICAgICBwb2x5X29yZGVyPWJhc2VsaW5lX3BvbHlfb3JkZXIKICAgICkKICAgIHByaW50KGYiICBGaXR0ZWQgYmFzZWxpbmVzIGZvciB7bGVuKGJhc2VsaW5lX2ZpdHMpfSB3ZWxscyIsIGZsdXNoPVRydWUpCiAgICAKICAgIHByaW50KCJTdGVwIDM6IE5vcm1hbGl6aW5nIHdlbGxzLi4uIiwgZmx1c2g9VHJ1ZSkKICAgIG5vcm1fZGYgPSBub3JtYWxpemVfd2VsbHMoZGYsIGJhc2VsaW5lX2ZpdHMsIG5vcm1hbGl6YXRpb25fbW9kZT1ub3JtYWxpemF0aW9uX21vZGUpCiAgICBwcmludChmIiAgTm9ybWFsaXplZCB7bGVuKG5vcm1fZGYpfSBkYXRhIHBvaW50cyIsIGZsdXNoPVRydWUpCiAgICAKICAgIHByaW50KCJTdGVwIDQ6IEJ1aWxkaW5nIGNvbmRpdGlvbiBtYXAuLi4iLCBmbHVzaD1UcnVlKQogICAgY29uZGl0aW9uX21hcCA9IGJ1aWxkX2NvbmRpdGlvbl9tYXAoZGYsIGNvbmZpZz1jb25maWcpCiAgICBwcmludChmIiAgTWFwcGVkIHtsZW4oY29uZGl0aW9uX21hcCl9IHdlbGxzIHRvIGNvbmRpdGlvbnMiLCBmbHVzaD1UcnVlKQogICAgY29uZGl0aW9uX2NvdW50cyA9IHt9CiAgICBmb3Igd2VsbF9pZCwgY29uZGl0aW9uIGluIGNvbmRpdGlvbl9tYXAuaXRlbXMoKToKICAgICAgICBjb25kaXRpb25fY291bnRzW2NvbmRpdGlvbl0gPSBjb25kaXRpb25fY291bnRzLmdldChjb25kaXRpb24sIDApICsgMQogICAgcHJpbnQoZiIgIENvbmRpdGlvbiBkaXN0cmlidXRpb246IiwgZmx1c2g9VHJ1ZSkKICAgIGZvciBjb25kaXRpb24sIGNvdW50IGluIHNvcnRlZChjb25kaXRpb25fY291bnRzLml0ZW1zKCkpOgogICAgICAgIHByaW50KGYiICAgIHtjb25kaXRpb259OiB7Y291bnR9IHdlbGxzIiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgcHJpbnQoIlN0ZXAgNTogQ29tcHV0aW5nIGNvbmRpdGlvbiBzdGF0aXN0aWNzLi4uIiwgZmx1c2g9VHJ1ZSkKICAgIHN0YXRzX2RmID0gY29tcHV0ZV9jb25kaXRpb25fc3RhdGlzdGljcyhub3JtX2RmLCBjb25kaXRpb25fbWFwKQogICAgcHJpbnQoZiIgIENvbXB1dGVkIHN0YXRpc3RpY3MgZm9yIHtsZW4oc3RhdHNfZGYpfSBjb25kaXRpb24tdGltZXBvaW50IGNvbWJpbmF0aW9ucyIsIGZsdXNoPVRydWUpCiAgICAKICAgICMgU2F2ZSBvdXRwdXRzIGlmIG91dHB1dF9kaXIgaXMgcHJvdmlkZWQKICAgIGlmIG91dHB1dF9kaXI6CiAgICAgICAgZW5zdXJlX2RpcihvdXRwdXRfZGlyKQogICAgICAgIAogICAgICAgIHByaW50KCJTdGVwIDY6IFNhdmluZyBvdXRwdXRzLi4uIiwgZmx1c2g9VHJ1ZSkKICAgICAgICAKICAgICAgICAjIFNhdmUgbm9ybWFsaXplZCBkYXRhCiAgICAgICAgbm9ybV9jc3ZfcGF0aCA9IG9zLnBhdGguam9pbihvdXRwdXRfZGlyLCAibm9ybWFsaXplZF9kYXRhLmNzdiIpCiAgICAgICAgbm9ybV9kZi50b19jc3Yobm9ybV9jc3ZfcGF0aCwgaW5kZXg9RmFsc2UpCiAgICAgICAgcHJpbnQoZiIgIFNhdmVkIG5vcm1hbGl6ZWQgZGF0YSB0byB7bm9ybV9jc3ZfcGF0aH0iLCBmbHVzaD1UcnVlKQogICAgICAgIAogICAgICAgICMgU2F2ZSBjb25kaXRpb24gc3RhdGlzdGljcwogICAgICAgIHN0YXRzX2Nzdl9wYXRoID0gb3MucGF0aC5qb2luKG91dHB1dF9kaXIsICJjb25kaXRpb25fc3RhdGlzdGljcy5jc3YiKQogICAgICAgIHN0YXRzX2RmLnRvX2NzdihzdGF0c19jc3ZfcGF0aCwgaW5kZXg9RmFsc2UpCiAgICAgICAgcHJpbnQoZiIgIFNhdmVkIGNvbmRpdGlvbiBzdGF0aXN0aWNzIHRvIHtzdGF0c19jc3ZfcGF0aH0iLCBmbHVzaD1UcnVlKQogICAgICAgIAogICAgICAgICMgU2F2ZSBwbG90CiAgICAgICAgcGxvdF9wYXRoID0gb3MucGF0aC5qb2luKG91dHB1dF9kaXIsICJ0aW1lY291cnNlX3Bsb3QucG5nIikKICAgICAgICBwbG90X3RpbWVjb3Vyc2Uoc3RhdHNfZGYsIHNhdmVfcGF0aD1wbG90X3BhdGgsIGNvbmZpZz1jb25maWcpCiAgICAgICAgcHJpbnQoZiIgIFNhdmVkIHBsb3QgdG8ge3Bsb3RfcGF0aH0iLCBmbHVzaD1UcnVlKQogICAgCiAgICByZXR1cm4gbm9ybV9kZiwgc3RhdHNfZGYsIGJhc2VsaW5lX2ZpdHMKCgpkZWYgbWFpbigpOgogICAgIyBVc2UgdGhlIGRpcmVjdG9yeSB3aGVyZSB0aGlzIHNjcmlwdCBsaXZlcyBhcyB0aGUgd29ya2luZyBkaXJlY3RvcnkKICAgIHNjcmlwdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgIG9zLmNoZGlyKHNjcmlwdF9kaXIpCgogICAgIyBGaW5kIEV4Y2VsIGZpbGVzIGluIHRoaXMgZGlyZWN0b3J5CiAgICBleGNlbF9maWxlcyA9IFsKICAgICAgICBmIGZvciBmIGluIG9zLmxpc3RkaXIoIi4iKQogICAgICAgIGlmIGYubG93ZXIoKS5lbmRzd2l0aCgiLnhsc3giKSBhbmQgbm90IGYuc3RhcnRzd2l0aCgifiQiKQogICAgXQoKICAgIGlmIG5vdCBleGNlbF9maWxlczoKICAgICAgICBwcmludCgiTm8gLnhsc3ggZmlsZXMgZm91bmQgaW4gdGhpcyBmb2xkZXIuIiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgIHN5cy5leGl0KDEpCiAgICAKICAgICMgVmFsaWRhdGUgZmlsZW5hbWUgZm9ybWF0cyBiZWZvcmUgcHJvY2Vzc2luZwogICAgcHJpbnQoIlN0YXJ0aW5nIHBsYXRlIHZpZXdlciBzY3JpcHQuLi4iLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoIlZhbGlkYXRpbmcgZmlsZW5hbWUgZm9ybWF0cy4uLiIsIGZsdXNoPVRydWUpCiAgICBpbnZhbGlkX2ZpbGVzID0gW10KICAgIGZvciBmbmFtZSBpbiBleGNlbF9maWxlczoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHZhbGlkYXRlX2ZpbGVuYW1lX2Zvcm1hdChmbmFtZSkKICAgICAgICBleGNlcHQgVmFsdWVFcnJvciBhcyBlOgogICAgICAgICAgICBpbnZhbGlkX2ZpbGVzLmFwcGVuZCgoZm5hbWUsIHN0cihlKSkpCiAgICAKICAgIGlmIGludmFsaWRfZmlsZXM6CiAgICAgICAgcHJpbnQoIlxu4p2MIEVSUk9SOiBJbnZhbGlkIGZpbGVuYW1lIGZvcm1hdChzKSBkZXRlY3RlZDoiLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAgICAgZm9yIGZuYW1lLCBlcnJvcl9tc2cgaW4gaW52YWxpZF9maWxlczoKICAgICAgICAgICAgcHJpbnQoZiJcbkZpbGU6IHtmbmFtZX0iLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAgICAgICAgIHByaW50KGVycm9yX21zZywgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgIHByaW50KCJcblBsZWFzZSByZW5hbWUgdGhlIGZpbGUocykgdG8gbWF0Y2ggdGhlIGV4cGVjdGVkIGZvcm1hdCBhbmQgcmVydW4gdGhlIHNjcmlwdC4iLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAgICAgc3lzLmV4aXQoMSkKICAgIAogICAgcHJpbnQoZiLinJMgQWxsIHtsZW4oZXhjZWxfZmlsZXMpfSBmaWxlKHMpIGhhdmUgdmFsaWQgZmlsZW5hbWUgZm9ybWF0cyIsIGZsdXNoPVRydWUpCgogICAgYWxsX3BsYXRlczogRGljdFtzdHIsIHBkLkRhdGFGcmFtZV0gPSB7fQogICAgY3N2X3Jvb3QgPSBvcy5wYXRoLmpvaW4oc2NyaXB0X2RpciwgImNzdiIpCiAgICAKICAgICMgTG9hZCBjb25maWd1cmF0aW9uIGZpbGUgZWFybHkgc28gaXQgY2FuIGJlIHVzZWQgZm9yIENTViBnZW5lcmF0aW9uCiAgICBjb25maWdfcGF0aCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAicGxhdGVfY29uZmlnLmpzb24iKQogICAgY29uZmlnID0gbG9hZF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAKICAgICMgVHJhY2sgcGxhdGVfaWRzIGFuZCB0aGVpciBzb3VyY2UgZmlsZXMgdG8gZGV0ZWN0IGR1cGxpY2F0ZXMKICAgIHBsYXRlX2lkX3RvX2ZpbGVzOiBEaWN0W3N0ciwgTGlzdFtzdHJdXSA9IHt9CiAgICAjIFRyYWNrIHBsYXRlX2lkIHRvIG9yaWdpbmFsIGZpbGVuYW1lIG1hcHBpbmcKICAgIHBsYXRlX2lkX3RvX2ZpbGVuYW1lOiBEaWN0W3N0ciwgc3RyXSA9IHt9CgogICAgZm9yIGlkeCwgZm5hbWUgaW4gZW51bWVyYXRlKGV4Y2VsX2ZpbGVzLCAxKToKICAgICAgICBwcmludChmIlxuW3tpZHh9L3tsZW4oZXhjZWxfZmlsZXMpfV0gUHJvY2Vzc2luZyB7Zm5hbWV9Li4uIiwgZmx1c2g9VHJ1ZSkKICAgICAgICBwYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsIGZuYW1lKQogICAgICAgIHRyeToKICAgICAgICAgICAgbG9uZ19kZiA9IHBhcnNlX3BsYXRlX2ZpbGUocGF0aCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiRXJyb3IgcGFyc2luZyB7Zm5hbWV9OiB7ZX0iLCBmaWxlPXN5cy5zdGRlcnIsIGZsdXNoPVRydWUpCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHBsYXRlX2lkID0gbG9uZ19kZlsicGxhdGVfaWQiXS5pbG9jWzBdCiAgICAgICAgCiAgICAgICAgIyBUcmFjayB3aGljaCBmaWxlcyBwcm9kdWNlIHdoaWNoIHBsYXRlX2lkCiAgICAgICAgaWYgcGxhdGVfaWQgbm90IGluIHBsYXRlX2lkX3RvX2ZpbGVzOgogICAgICAgICAgICBwbGF0ZV9pZF90b19maWxlc1twbGF0ZV9pZF0gPSBbXQogICAgICAgIHBsYXRlX2lkX3RvX2ZpbGVzW3BsYXRlX2lkXS5hcHBlbmQoZm5hbWUpCiAgICAgICAgCiAgICAgICAgIyBUcmFjayBmaWxlbmFtZSBmb3IgdGhpcyBwbGF0ZV9pZCAodXNlIGZpcnN0IG9jY3VycmVuY2UpCiAgICAgICAgaWYgcGxhdGVfaWQgbm90IGluIHBsYXRlX2lkX3RvX2ZpbGVuYW1lOgogICAgICAgICAgICBwbGF0ZV9pZF90b19maWxlbmFtZVtwbGF0ZV9pZF0gPSBmbmFtZQogICAgICAgIAogICAgICAgICMgSWYgdGhpcyBwbGF0ZV9pZCBhbHJlYWR5IGV4aXN0cywgbWFrZSBpdCB1bmlxdWUgYnkgYXBwZW5kaW5nIGZpbGVuYW1lCiAgICAgICAgaWYgcGxhdGVfaWQgaW4gYWxsX3BsYXRlczoKICAgICAgICAgICAgIyBUaGlzIGlzIGEgZHVwbGljYXRlIC0gd2UnbGwgaGFuZGxlIGl0IGJlbG93CiAgICAgICAgICAgIHBhc3MKICAgICAgICBlbHNlOgogICAgICAgICAgICBhbGxfcGxhdGVzW3BsYXRlX2lkXSA9IGxvbmdfZGYKICAgICAgICAgICAgd3JpdGVfY3N2c19mb3JfcGxhdGUobG9uZ19kZiwgY3N2X3Jvb3QsIGNvbmZpZywgZm5hbWUpCgogICAgIyBDaGVjayBmb3IgZHVwbGljYXRlcyBhbmQgd2FybgogICAgZHVwbGljYXRlc19mb3VuZCA9IEZhbHNlCiAgICBmb3IgcGxhdGVfaWQsIGZpbGVzIGluIHBsYXRlX2lkX3RvX2ZpbGVzLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGZpbGVzKSA+IDE6CiAgICAgICAgICAgIGR1cGxpY2F0ZXNfZm91bmQgPSBUcnVlCiAgICAgICAgICAgIHByaW50KGYiXG7imqDvuI8gIFdBUk5JTkc6IER1cGxpY2F0ZSBkYXRhc2V0IGRldGVjdGVkISIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICAgICAgcHJpbnQoZiIgICBQbGF0ZSBJRCAne3BsYXRlX2lkfScgaXMgcHJvZHVjZWQgYnkgbXVsdGlwbGUgZmlsZXM6IiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgICAgICBmb3IgZiBpbiBmaWxlczoKICAgICAgICAgICAgICAgIHByaW50KGYiICAgICAtIHtmfSIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICAgICAgcHJpbnQoZiIgICBQbGVhc2UgZGVsZXRlIHRoZSBkdXBsaWNhdGUgZmlsZShzKSBhbmQgcmVydW4gdGhlIHNjcmlwdC4iLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAKICAgIGlmIGR1cGxpY2F0ZXNfZm91bmQ6CiAgICAgICAgcHJpbnQoIlxu4pqg77iPICBFUlJPUjogRHVwbGljYXRlIGRhdGFzZXRzIGZvdW5kLiBQbGVhc2UgZGVsZXRlIGR1cGxpY2F0ZXMgYW5kIHJlcnVuLiIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBwcmludCgiICAgT25seSB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBlYWNoIGR1cGxpY2F0ZSB3aWxsIGJlIGluY2x1ZGVkLiIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBzeXMuZXhpdCgxKQoKICAgIGlmIG5vdCBhbGxfcGxhdGVzOgogICAgICAgIHByaW50KCJObyBwbGF0ZXMgd2VyZSBzdWNjZXNzZnVsbHkgcGFyc2VkLiIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBzeXMuZXhpdCgxKQogICAgCiAgICBwcmludChmIlxu4pyTIFN1Y2Nlc3NmdWxseSBsb2FkZWQge2xlbihhbGxfcGxhdGVzKX0gZGF0YXNldChzKToiLCBmbHVzaD1UcnVlKQogICAgZm9yIHBsYXRlX2lkIGluIHNvcnRlZChhbGxfcGxhdGVzLmtleXMoKSk6CiAgICAgICAgcHJpbnQoZiIgICAtIHtwbGF0ZV9pZH0iLCBmbHVzaD1UcnVlKQoKICAgICMgQ29uZmlnIGFscmVhZHkgbG9hZGVkIGFib3ZlCgogICAgIyBCdWlsZCBKU09OIGZvciB2aWV3ZXIKICAgIHdlYl9kaXIgPSBvcy5wYXRoLmpvaW4oc2NyaXB0X2RpciwgIndlYiIpCiAgICBlbnN1cmVfZGlyKHdlYl9kaXIpCiAgICBqc29uX3BhdGggPSBvcy5wYXRoLmpvaW4od2ViX2RpciwgInZpZXdlcl9kYXRhLmpzb24iKQogICAgYnVpbGRfdmlld2VyX2pzb24oYWxsX3BsYXRlcywganNvbl9wYXRoLCBjb25maWcsIHBsYXRlX2lkX3RvX2ZpbGVuYW1lKQoKICAgICMgV3JpdGUgSFRNTAogICAgaHRtbF9wYXRoID0gb3MucGF0aC5qb2luKHdlYl9kaXIsICJpbmRleC5odG1sIikKICAgIHdyaXRlX2h0bWwoaHRtbF9wYXRoKQoKICAgICMgQ3JlYXRlIGRvdWJsZS1jbGlja2FibGUgd2ViLmNvbW1hbmQgZmlsZQogICAgd2ViX2NvbW1hbmRfcGF0aCA9IHdyaXRlX3dlYl9jb21tYW5kKHNjcmlwdF9kaXIsIHdlYl9kaXIpCgogICAgcHJpbnQoIkRvbmUuIiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KCJHZW5lcmF0ZWQ6IiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KGYiICBDU1ZzIGluOiB7Y3N2X3Jvb3R9IiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KGYiICBXZWIgdmlld2VyOiB7aHRtbF9wYXRofSIsIGZsdXNoPVRydWUpCiAgICBwcmludChmIiAgV2ViIGxhdW5jaGVyOiB7d2ViX2NvbW1hbmRfcGF0aH0iLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoIlxuVG8gdmlldyB0aGUgcGxhdGVzOiIsIGZsdXNoPVRydWUpCiAgICBwcmludChmIiAgRG91YmxlLWNsaWNrICd3ZWIuY29tbWFuZCcgaW4gRmluZGVyLCBvciIsIGZsdXNoPVRydWUpCiAgICBwcmludChmIiAgUnVuOiAuL3dlYi5jb21tYW5kIiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KCJUaGUgYnJvd3NlciB3aWxsIG9wZW4gYXV0b21hdGljYWxseS4iLCBmbHVzaD1UcnVlKQoKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICBtYWluKCk="
		
		-- Decode and execute the Python code
		do shell script "cd " & quoted form of folderPath & " && echo " & quoted form of pythonCodeBase64 & " | base64 -d | python3"
		
		display notification "Plate viewer script completed successfully!" with title "Plate Viewer"
		
	on error errMsg
		display alert "Error" message errMsg
	end try
	
	return input
end run
