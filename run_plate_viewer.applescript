-- AppleScript to run plate_viewer.py
-- The Python code is embedded directly in this script (base64 encoded)
-- Required packages will be installed automatically if needed

on run {input, parameters}
	try
		-- Get the selected folder from Finder or Automator
		if input is {} or input is missing value or (count of input) = 0 then
			set selectedFolder to choose folder with prompt "Select a folder containing .xlsx files:"
			if selectedFolder is {} then
				return
			end if
		else
			set selectedFolder to item 1 of input
		end if
		
		-- Get the folder path
		set folderPath to POSIX path of selectedFolder
		
		-- Remove trailing slash if present
		if folderPath ends with "/" then
			set folderPath to text 1 thru -2 of folderPath
		end if
		
		-- Install required Python packages if needed
		set requiredPackages to "pandas numpy scipy matplotlib openpyxl"
		
		-- Try installation with different methods (in order of preference)
		set installSuccess to false
		set lastError to ""
		
		-- Method 1: Try with --user flag (works on most systems, safest)
		try
			do shell script "python3 -m pip install --user " & requiredPackages & " 2>&1"
			set installSuccess to true
		on error installError1
			set lastError to installError1
			-- Method 2: Check Python version and try with --break-system-packages if supported
			try
				set pythonVersion to (do shell script "python3 --version 2>&1 | awk '{print $2}'")
				set pythonMajor to (do shell script "echo " & quoted form of pythonVersion & " | cut -d. -f1")
				set pythonMinor to (do shell script "echo " & quoted form of pythonVersion & " | cut -d. -f2")
				
				if (pythonMajor as integer) >= 3 and (pythonMinor as integer) >= 11 then
					-- Python 3.11+, try with --break-system-packages --user
					try
						do shell script "python3 -m pip install --break-system-packages --user " & requiredPackages & " 2>&1"
						set installSuccess to true
					on error installError2
						set lastError to installError2
						-- Try with --break-system-packages without --user
						try
							do shell script "python3 -m pip install --break-system-packages " & requiredPackages & " 2>&1"
							set installSuccess to true
						on error installError3
							set lastError to installError3
						end try
					end try
				end if
			on error
				-- Version check failed, continue to next method
			end try
			
			-- Method 3: If still not successful, try without any flags (may work if pip is configured)
			if not installSuccess then
				try
					do shell script "python3 -m pip install " & requiredPackages & " 2>&1"
					set installSuccess to true
				on error installError4
					set lastError to installError4
				end try
			end if
			
			-- If all methods failed, show warning but continue
			if not installSuccess then
				display alert "Warning" message "Could not install required packages automatically.\n\nLast error: " & lastError & "\n\nPlease install manually: " & requiredPackages & "\n\nRun: python3 -m pip install --user " & requiredPackages buttons {"Continue", "Cancel"} default button "Continue" as warning
				if button returned of result is "Cancel" then
					return
				end if
			end if
		end try
		
		-- Embedded Python code (base64 encoded)
		set pythonCodeBase64 to "IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwppbXBvcnQgb3MKaW1wb3J0IHN5cwppbXBvcnQganNvbgppbXBvcnQgc2h1dGlsCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBBbnksIExpc3QKCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IG51bXB5IGFzIG5wCgojIC0tLS0tIENPTkZJRyAtLS0tLQojIDM4NC13ZWxsIHBsYXRlOiAxNiByb3dzIChBLVApIHggMjQgY29sdW1uczsgY2hhbmdlIGlmIG5lZWRlZC4KUExBVEVfUk9XUyA9ICJBQkNERUZHSElKS0xNTk9QIiAgIyAxNiByb3dzClBMQVRFX0NPTFMgPSAyNAoKU0hFRVRfTkFNRV9QUkVGRVJSRUQgPSAiVGFibGUgQWxsIERhdGEgcG9pbnRzIiAgIyBmcm9tIHlvdXIgZXhhbXBsZQoKIyBEZWZhdWx0IHdlbGwgbGFiZWxzIGFuZCB0cmlwbGljYXRlIGdyb3VwcwpERUZBVUxUX1dFTExfTEFCRUxTID0gewogICAgIkIxMyI6ICIyNTAtMTAtMiIsCiAgICAiQzEzIjogIjI1MC0xMC0yIiwKICAgICJEMTMiOiAiMjUwLTEwLTIiLAogICAgIkUxMyI6ICI1MDAtMTAtMiIsCiAgICAiRjEzIjogIjUwMC0xMC0yIiwKICAgICJHMTMiOiAiNTAwLTEwLTIiLAogICAgIkgxMyI6ICIyNTAtNS0yIiwKICAgICJJMTMiOiAiMjUwLTUtMiIsCiAgICAiSjEzIjogIjI1MC01LTIiLAogICAgIksxMyI6ICI1MDAtNS0yIiwKICAgICJMMTMiOiAiNTAwLTUtMiIsCiAgICAiTTEzIjogIjUwMC01LTIiLAogICAgIk4xMyI6ICI1MDAtMTAtMiIsCiAgICAiTzEzIjogIjUwMC01LTIiCn0KCiMgQ29sb3IgcGFsZXR0ZSBmb3IgdHJpcGxpY2F0ZSBncm91cHMgLSBtYXRjaGVzIHdlYiBpbnRlcmZhY2UKIyBFYWNoIGdyb3VwIGdldHMgYSBkaXN0aW5jdCBjb2xvciAodXNpbmcgYm9yZGVyIGNvbG9yIGZvciBwbG90cykKVFJJUExJQ0FURV9DT0xPUlMgPSBbCiAgICAiI2ZmNmI2YiIsICAjIFJlZAogICAgIiM0ZWNkYzQiLCAgIyBUZWFsCiAgICAiIzQ1YjdkMSIsICAjIEJsdWUKICAgICIjZjljYTI0IiwgICMgWWVsbG93CiAgICAiIzZjNWNlNyIsICAjIFB1cnBsZQogICAgIiNhMjliZmUiLCAgIyBMaWdodCBQdXJwbGUKICAgICIjZmQ3OWE4IiwgICMgUGluawogICAgIiMwMGI4OTQiLCAgIyBHcmVlbgogICAgIiNlMTcwNTUiLCAgIyBPcmFuZ2UKICAgICIjNzRiOWZmIiwgICMgTGlnaHQgQmx1ZQogICAgIiM1NWVmYzQiLCAgIyBNaW50CiAgICAiI2ZkY2I2ZSIgICAjIExpZ2h0IE9yYW5nZQpdCgpkZWYgaXNfY29udHJvbF93ZWxsKHdlbGxfaWQ6IHN0ciwgY29udHJvbF9yb3dzOiBMaXN0W3N0cl0gPSBOb25lKSAtPiBib29sOgogICAgIiIiCiAgICBDaGVjayBpZiBhIHdlbGwgaXMgYSBjb250cm9sIHdlbGwuCiAgICBEZWZhdWx0IGNvbnRyb2wgcm93cyBhcmUgTiBhbmQgTywgYnV0IHRoaXMgY2FuIGJlIGNvbmZpZ3VyZWQgdmlhIGNvbnRyb2xfcm93cyBwYXJhbWV0ZXIuCiAgICBDb250cm9sIHdlbGxzIHNob3VsZCBiZSBpbmRlcGVuZGVudGx5IHNlbGVjdGFibGUgYW5kIG5vdCBncm91cGVkIGFzIHRyaXBsaWNhdGVzLgogICAgIiIiCiAgICBpZiBub3Qgd2VsbF9pZDoKICAgICAgICByZXR1cm4gRmFsc2UKICAgIGlmIGNvbnRyb2xfcm93cyBpcyBOb25lOgogICAgICAgIGNvbnRyb2xfcm93cyA9IFsiTiIsICJPIl0gICMgRGVmYXVsdCBjb250cm9sIHJvd3MKICAgIHJvd19sZXR0ZXIgPSB3ZWxsX2lkWzBdIGlmIHdlbGxfaWRbMF0uaXNhbHBoYSgpIGVsc2UgIiIKICAgIHJldHVybiByb3dfbGV0dGVyIGluIGNvbnRyb2xfcm93cwoKCmRlZiB2YWxpZGF0ZV9maWxlbmFtZV9mb3JtYXQoZmlsZW5hbWU6IHN0cik6CiAgICAiIiIKICAgIFZhbGlkYXRlIHRoYXQgZmlsZW5hbWUgbWF0Y2hlcyB0aGUgZXhwZWN0ZWQgZm9ybWF0OgogICAgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJbX3NjaWVudGlzdF1bX251bWJlcl0ueGxzeAogICAgCiAgICBFeHBlY3RlZCBmb3JtYXQ6IEF0IGxlYXN0IDMgdW5kZXJzY29yZS1zZXBhcmF0ZWQgcGFydHMgYmVmb3JlIHRoZSAueGxzeCBleHRlbnNpb24uCiAgICBFeGFtcGxlczoKICAgIC0gUExDYl9XVF9DYV9NQy54bHN4ICg0IHBhcnRzKQogICAgLSBQTENiX1dUX0NhX01DXzEzLnhsc3ggKDUgcGFydHMpCiAgICAtIFBMQ2JfSDMzMkFfQ2FfU01fMTIueGxzeCAoNSBwYXJ0cykKICAgIAogICAgUmFpc2VzIFZhbHVlRXJyb3IgaWYgZm9ybWF0IGlzIGludmFsaWQuCiAgICAiIiIKICAgIGlmIG5vdCBmaWxlbmFtZS5sb3dlcigpLmVuZHN3aXRoKCcueGxzeCcpOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiSW52YWxpZCBmaWxlbmFtZSBmb3JtYXQ6ICd7ZmlsZW5hbWV9J1xuIgogICAgICAgICAgICBmIkV4cGVjdGVkIGZvcm1hdDogcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJbX3NjaWVudGlzdF1bX251bWJlcl0ueGxzeFxuIgogICAgICAgICAgICBmIkZpbGVuYW1lIG11c3QgZW5kIHdpdGggLnhsc3ggZXh0ZW5zaW9uLiIKICAgICAgICApCiAgICAKICAgICMgUmVtb3ZlIC54bHN4IGV4dGVuc2lvbgogICAgYmFzZV9uYW1lID0gb3MucGF0aC5zcGxpdGV4dChmaWxlbmFtZSlbMF0KICAgIAogICAgIyBTcGxpdCBieSB1bmRlcnNjb3JlCiAgICBwYXJ0cyA9IGJhc2VfbmFtZS5zcGxpdCgiXyIpCiAgICAKICAgIGlmIGxlbihwYXJ0cykgPCAzOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiSW52YWxpZCBmaWxlbmFtZSBmb3JtYXQ6ICd7ZmlsZW5hbWV9J1xuIgogICAgICAgICAgICBmIkV4cGVjdGVkIGZvcm1hdDogcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJbX3NjaWVudGlzdF1bX251bWJlcl0ueGxzeFxuIgogICAgICAgICAgICBmIlRoZSBmaWxlbmFtZSBtdXN0IGhhdmUgYXQgbGVhc3QgMyB1bmRlcnNjb3JlLXNlcGFyYXRlZCBwYXJ0cyBiZWZvcmUgdGhlIC54bHN4IGV4dGVuc2lvbi5cbiIKICAgICAgICAgICAgZiJGb3VuZCB7bGVuKHBhcnRzKX0gcGFydChzKToge3BhcnRzfVxuIgogICAgICAgICAgICBmIkV4YW1wbGUgdmFsaWQgZm9ybWF0czpcbiIKICAgICAgICAgICAgZiIgIC0gUExDYl9XVF9DYV9NQy54bHN4XG4iCiAgICAgICAgICAgIGYiICAtIFBMQ2JfV1RfQ2FfTUNfMTMueGxzeFxuIgogICAgICAgICAgICBmIiAgLSBQTENiX0gzMzJBX0NhX1NNXzEyLnhsc3giCiAgICAgICAgKQoKCmRlZiBwYXJzZV9jb2x1bW5fZ3JvdXBfZnJvbV9maWxlbmFtZShmaWxlbmFtZTogc3RyKSAtPiBEaWN0W3N0ciwgc3RyXToKICAgICIiIgogICAgUGFyc2UgY29sdW1uIGdyb3VwIGluZm9ybWF0aW9uIGZyb20gZmlsZW5hbWUgZm9ybWF0OgogICAgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJfaW5pdGlhbHMtb2Ytc2NpZW50aXN0X2FyYml0cmFyeS1udW1iZXIueGxzeAogICAgCiAgICBSZXR1cm5zIGEgZGljdGlvbmFyeSB3aXRoOgogICAgLSAiY29sdW1uX2dyb3VwIjogInByb3RlaW5fZ2Vub3R5cGVfYnVmZmVyIiAodXNlZCBmb3IgZ3JvdXBpbmcpCiAgICAtICJwcm90ZWluIjogcHJvdGVpbiBuYW1lCiAgICAtICJnZW5vdHlwZSI6IGdlbm90eXBlCiAgICAtICJidWZmZXIiOiBidWZmZXIKICAgIC0gInNjaWVudGlzdCI6IGluaXRpYWxzLW9mLXNjaWVudGlzdAogICAgLSAibnVtYmVyIjogYXJiaXRyYXJ5LW51bWJlcgogICAgIiIiCiAgICAjIFZhbGlkYXRlIGZpbGVuYW1lIGZvcm1hdCBmaXJzdAogICAgdmFsaWRhdGVfZmlsZW5hbWVfZm9ybWF0KGZpbGVuYW1lKQogICAgCiAgICAjIFJlbW92ZSAueGxzeCBleHRlbnNpb24KICAgIGJhc2VfbmFtZSA9IG9zLnBhdGguc3BsaXRleHQoZmlsZW5hbWUpWzBdCiAgICAKICAgICMgU3BsaXQgYnkgdW5kZXJzY29yZQogICAgcGFydHMgPSBiYXNlX25hbWUuc3BsaXQoIl8iKQogICAgCiAgICAjIEF0IHRoaXMgcG9pbnQgd2Uga25vdyB3ZSBoYXZlIGF0IGxlYXN0IDMgcGFydHMgZHVlIHRvIHZhbGlkYXRpb24KICAgICMgSWYgd2UgaGF2ZSBhdCBsZWFzdCAzIHBhcnRzLCB1c2UgZmlyc3QgMyBmb3IgY29sdW1uX2dyb3VwIChwcm90ZWluX2dlbm90eXBlX2J1ZmZlcikKICAgICMgVGhpcyBoYW5kbGVzIGNhc2VzIGxpa2UgIlBMQ2JfV1RfRUdUQV9NQyIgKDQgcGFydHMpIG9yICJQTENiX1dUX0VHVEFfTUNfMTMiICg1IHBhcnRzKQogICAgcHJvdGVpbiA9IHBhcnRzWzBdCiAgICBnZW5vdHlwZSA9IHBhcnRzWzFdCiAgICBidWZmZXIgPSBwYXJ0c1syXQogICAgc2NpZW50aXN0ID0gcGFydHNbM10gaWYgbGVuKHBhcnRzKSA+IDMgZWxzZSAiIgogICAgbnVtYmVyID0gcGFydHNbNF0gaWYgbGVuKHBhcnRzKSA+IDQgZWxzZSAiIgogICAgCiAgICAjIENvbHVtbiBncm91cCBpcyBhbHdheXMgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXIgKGZpcnN0IDMgcGFydHMpCiAgICBjb2x1bW5fZ3JvdXAgPSBmIntwcm90ZWlufV97Z2Vub3R5cGV9X3tidWZmZXJ9IgogICAgCiAgICByZXR1cm4gewogICAgICAgICJjb2x1bW5fZ3JvdXAiOiBjb2x1bW5fZ3JvdXAsCiAgICAgICAgInByb3RlaW4iOiBwcm90ZWluLAogICAgICAgICJnZW5vdHlwZSI6IGdlbm90eXBlLAogICAgICAgICJidWZmZXIiOiBidWZmZXIsCiAgICAgICAgInNjaWVudGlzdCI6IHNjaWVudGlzdCwKICAgICAgICAibnVtYmVyIjogbnVtYmVyCiAgICB9CiAgICAKICAgICMgSWYgd2UgaGF2ZSBhdCBsZWFzdCAzIHBhcnRzLCB1c2UgZmlyc3QgMyBmb3IgY29sdW1uX2dyb3VwIChwcm90ZWluX2dlbm90eXBlX2J1ZmZlcikKICAgICMgVGhpcyBoYW5kbGVzIGNhc2VzIGxpa2UgIlBMQ2JfV1RfRUdUQV9NQyIgKDQgcGFydHMpIG9yICJQTENiX1dUX0VHVEFfTUNfMTMiICg1IHBhcnRzKQogICAgcHJvdGVpbiA9IHBhcnRzWzBdCiAgICBnZW5vdHlwZSA9IHBhcnRzWzFdCiAgICBidWZmZXIgPSBwYXJ0c1syXQogICAgc2NpZW50aXN0ID0gcGFydHNbM10gaWYgbGVuKHBhcnRzKSA+IDMgZWxzZSAiIgogICAgbnVtYmVyID0gcGFydHNbNF0gaWYgbGVuKHBhcnRzKSA+IDQgZWxzZSAiIgogICAgCiAgICAjIENvbHVtbiBncm91cCBpcyBhbHdheXMgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXIgKGZpcnN0IDMgcGFydHMpCiAgICBjb2x1bW5fZ3JvdXAgPSBmIntwcm90ZWlufV97Z2Vub3R5cGV9X3tidWZmZXJ9IgogICAgCiAgICByZXR1cm4gewogICAgICAgICJjb2x1bW5fZ3JvdXAiOiBjb2x1bW5fZ3JvdXAsCiAgICAgICAgInByb3RlaW4iOiBwcm90ZWluLAogICAgICAgICJnZW5vdHlwZSI6IGdlbm90eXBlLAogICAgICAgICJidWZmZXIiOiBidWZmZXIsCiAgICAgICAgInNjaWVudGlzdCI6IHNjaWVudGlzdCwKICAgICAgICAibnVtYmVyIjogbnVtYmVyCiAgICB9CiAgICAKCgpkZWYgZmluZF9oZWFkZXJfYW5kX3RpbWVfcm93cyhkZjogcGQuRGF0YUZyYW1lKSAtPiAoaW50LCBpbnQpOgogICAgIiIiCiAgICBGaW5kIHRoZSAnV2VsbCcgaGVhZGVyIHJvdyBhbmQgdGhlICdUaW1lIFtzXScgcm93LgogICAgUmV0dXJucyAoaGVhZGVyX3Jvd19pbmRleCwgdGltZV9yb3dfaW5kZXgpLgogICAgIiIiCiAgICBoZWFkZXJfcm93X2lkeCA9IE5vbmUKICAgIHRpbWVfcm93X2lkeCA9IE5vbmUKCiAgICBmb3IgaSBpbiByYW5nZShsZW4oZGYpKToKICAgICAgICBjZWxsMCA9IHN0cihkZi5pYXRbaSwgMF0pIGlmIG5vdCBwZC5pc25hKGRmLmlhdFtpLCAwXSkgZWxzZSAiIgogICAgICAgIGNlbGwxID0gc3RyKGRmLmlhdFtpLCAxXSkgaWYgbm90IHBkLmlzbmEoZGYuaWF0W2ksIDFdKSBlbHNlICIiCiAgICAgICAgaWYgY2VsbDAuc3RyaXAoKSA9PSAiV2VsbCI6CiAgICAgICAgICAgIGhlYWRlcl9yb3dfaWR4ID0gaQogICAgICAgIGlmICJUaW1lIiBpbiBjZWxsMSBhbmQgIltzXSIgaW4gY2VsbDE6CiAgICAgICAgICAgIHRpbWVfcm93X2lkeCA9IGkKCiAgICBpZiBoZWFkZXJfcm93X2lkeCBpcyBOb25lIG9yIHRpbWVfcm93X2lkeCBpcyBOb25lOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIkNvdWxkIG5vdCBmaW5kICdXZWxsJyBoZWFkZXIgcm93IG9yICdUaW1lIFtzXScgcm93IGluIEV4Y2VsIHNoZWV0LiIpCgogICAgaWYgdGltZV9yb3dfaWR4ICE9IGhlYWRlcl9yb3dfaWR4ICsgMToKICAgICAgICAjIE5vdCBmYXRhbCwgYnV0IHdhcm4gaW4gY2FzZSBmb3JtYXQgZHJpZnRzCiAgICAgICAgcHJpbnQoZiJXYXJuaW5nOiBUaW1lIHJvdyAoaW5kZXgge3RpbWVfcm93X2lkeH0pIGlzIG5vdCBkaXJlY3RseSBhZnRlciBoZWFkZXIgcm93IChpbmRleCB7aGVhZGVyX3Jvd19pZHh9KS4iLAogICAgICAgICAgICAgIGZpbGU9c3lzLnN0ZGVycikKCiAgICByZXR1cm4gaGVhZGVyX3Jvd19pZHgsIHRpbWVfcm93X2lkeAoKCmRlZiBwYXJzZV9wbGF0ZV9maWxlKHhsc3hfcGF0aDogc3RyKSAtPiBwZC5EYXRhRnJhbWU6CiAgICAiIiIKICAgIFBhcnNlIGEgc2luZ2xlIEV4Y2VsIGZpbGUgaW50byBhIGxvbmctZm9ybWF0IERhdGFGcmFtZSB3aXRoIGNvbHVtbnM6CiAgICBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgIiIiCiAgICBwcmludChmIlBhcnNpbmcge29zLnBhdGguYmFzZW5hbWUoeGxzeF9wYXRoKX0uLi4iLCBmbHVzaD1UcnVlKQogICAgdHJ5OgogICAgICAgIHByaW50KGYiICBPcGVuaW5nIEV4Y2VsIGZpbGUuLi4iLCBmbHVzaD1UcnVlKQogICAgICAgICMgRXhwbGljaXRseSB1c2Ugb3BlbnB5eGwgZW5naW5lIGZvciAueGxzeCBmaWxlcyB0byBhdm9pZCBoYW5naW5nCiAgICAgICAgeGxzID0gcGQuRXhjZWxGaWxlKHhsc3hfcGF0aCwgZW5naW5lPSdvcGVucHl4bCcpCiAgICAgICAgaWYgU0hFRVRfTkFNRV9QUkVGRVJSRUQgaW4geGxzLnNoZWV0X25hbWVzOgogICAgICAgICAgICBzaGVldF9uYW1lID0gU0hFRVRfTkFNRV9QUkVGRVJSRUQKICAgICAgICBlbHNlOgogICAgICAgICAgICBzaGVldF9uYW1lID0geGxzLnNoZWV0X25hbWVzWzBdCiAgICAgICAgICAgIHByaW50KGYiICBTaGVldCAne1NIRUVUX05BTUVfUFJFRkVSUkVEfScgbm90IGZvdW5kOyB1c2luZyBmaXJzdCBzaGVldCAne3NoZWV0X25hbWV9JyBpbnN0ZWFkLiIsIGZsdXNoPVRydWUpCiAgICAgICAgcHJpbnQoZiIgIFJlYWRpbmcgc2hlZXQgJ3tzaGVldF9uYW1lfScuLi4iLCBmbHVzaD1UcnVlKQogICAgICAgICMgVXNlIHRoZSBzYW1lIGVuZ2luZSBmb3IgcmVhZF9leGNlbAogICAgICAgIGRmID0gcGQucmVhZF9leGNlbCh4bHN4X3BhdGgsIHNoZWV0X25hbWU9c2hlZXRfbmFtZSwgaGVhZGVyPU5vbmUsIGVuZ2luZT0nb3BlbnB5eGwnKQogICAgICAgIHByaW50KGYiICBTaGVldCBsb2FkZWQ6IHtsZW4oZGYpfSByb3dzLCB7bGVuKGRmLmNvbHVtbnMpfSBjb2x1bW5zIiwgZmx1c2g9VHJ1ZSkKICAgICAgICAjIENsb3NlIHRoZSBFeGNlbEZpbGUgdG8gZnJlZSByZXNvdXJjZXMKICAgICAgICB4bHMuY2xvc2UoKQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIkZpbGUgbm90IGZvdW5kOiB7eGxzeF9wYXRofSIpCiAgICBleGNlcHQgUGVybWlzc2lvbkVycm9yOgogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIlBlcm1pc3Npb24gZGVuaWVkOiB7eGxzeF9wYXRofSAoZmlsZSBtYXkgYmUgb3BlbiBpbiBhbm90aGVyIHByb2dyYW0pIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBlcnJvcl90eXBlID0gdHlwZShlKS5fX25hbWVfXwogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIkZhaWxlZCB0byByZWFkIHt4bHN4X3BhdGh9OiB7ZXJyb3JfdHlwZX06IHtlfSIpCgogICAgcHJpbnQoZiIgIEZpbmRpbmcgaGVhZGVyIGFuZCB0aW1lIHJvd3MuLi4iLCBmbHVzaD1UcnVlKQogICAgaGVhZGVyX3Jvd19pZHgsIHRpbWVfcm93X2lkeCA9IGZpbmRfaGVhZGVyX2FuZF90aW1lX3Jvd3MoZGYpCgogICAgIyBUaW1lIHJvdzogY29sdW1uIDEgaXMgIlRpbWUgW3NdIiwgbWVhc3VyZW1lbnQgdGltZXMgc3RhcnQgZnJvbSBjb2x1bW4gMiBvbndhcmQuCiAgICB0aW1lX3JvdyA9IGRmLmlsb2NbdGltZV9yb3dfaWR4XQogICAgdGltZV92YWx1ZXMgPSB0aW1lX3Jvdy5pbG9jWzI6XS50b2xpc3QoKQogICAgIyBDbGVhbiB1cCB0aW1lcwogICAgdGltZV92YWx1ZXNfY2xlYW4gPSBbXQogICAgZm9yIHQgaW4gdGltZV92YWx1ZXM6CiAgICAgICAgaWYgcGQuaXNuYSh0KToKICAgICAgICAgICAgYnJlYWsKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRpbWVfdmFsdWVzX2NsZWFuLmFwcGVuZChmbG9hdCh0KSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAjIFN0b3AgYXQgdGhlIGZpcnN0IG5vbi1udW1lcmljIC8gd2VpcmQgdGhpbmcKICAgICAgICAgICAgYnJlYWsKCiAgICBudW1fdGltZV9wb2ludHMgPSBsZW4odGltZV92YWx1ZXNfY2xlYW4pCiAgICBpZiBudW1fdGltZV9wb2ludHMgPT0gMDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiTm8gdGltZXBvaW50cyBwYXJzZWQgaW4ge3hsc3hfcGF0aH0uIikKCiAgICBwbGF0ZV9pZCA9IG9zLnBhdGguc3BsaXRleHQob3MucGF0aC5iYXNlbmFtZSh4bHN4X3BhdGgpKVswXQoKICAgIHJlY29yZHM6IExpc3RbRGljdFtzdHIsIEFueV1dID0gW10KCiAgICAjIERhdGEgcm93czogZnJvbSB0aW1lX3Jvd19pZHggKyAxIGRvd253YXJkcyB1bnRpbCB3ZSBoaXQgZW1wdHkgIldlbGwiIGNlbGwKICAgIHByaW50KGYiICBQcm9jZXNzaW5nIGRhdGEgcm93cyAoc3RhcnRpbmcgZnJvbSByb3cge3RpbWVfcm93X2lkeCArIDF9KS4uLiIsIGZsdXNoPVRydWUpCiAgICByb3dzX3Byb2Nlc3NlZCA9IDAKICAgIGZvciBpIGluIHJhbmdlKHRpbWVfcm93X2lkeCArIDEsIGxlbihkZikpOgogICAgICAgIHdlbGwgPSBkZi5pYXRbaSwgMF0KICAgICAgICBjb250ZW50ID0gZGYuaWF0W2ksIDFdCgogICAgICAgIGlmIHBkLmlzbmEod2VsbCkgb3Igc3RyKHdlbGwpLnN0cmlwKCkgPT0gIiI6CiAgICAgICAgICAgICMgQXNzdW1lIHdlJ3ZlIHJlYWNoZWQgdGhlIGVuZCBvZiBkYXRhCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHdlbGxfaWQgPSBzdHIod2VsbCkuc3RyaXAoKQogICAgICAgIGNvbnRlbnRfc3RyID0gIiIgaWYgcGQuaXNuYShjb250ZW50KSBlbHNlIHN0cihjb250ZW50KS5zdHJpcCgpCgogICAgICAgIHJvd192YWxzID0gZGYuaWxvY1tpLCAyOjIgKyBudW1fdGltZV9wb2ludHNdLnRvbGlzdCgpCiAgICAgICAgIyBFbnN1cmUgc2FtZSBsZW5ndGggYXMgdGltZSBsaXN0CiAgICAgICAgcm93X3ZhbHMgPSByb3dfdmFsc1s6bnVtX3RpbWVfcG9pbnRzXQoKICAgICAgICBmb3IgdCwgdiBpbiB6aXAodGltZV92YWx1ZXNfY2xlYW4sIHJvd192YWxzKToKICAgICAgICAgICAgaWYgcGQuaXNuYSh2KToKICAgICAgICAgICAgICAgICMgU2tpcCBtaXNzaW5nIHZhbHVlcywgYnV0IGtlZXAgdGltZXBvaW50IGluIG92ZXJhbGwgc2NoZW1lCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB2X2Zsb2F0ID0gZmxvYXQodikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICByZWNvcmRzLmFwcGVuZCgKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAicGxhdGVfaWQiOiBwbGF0ZV9pZCwKICAgICAgICAgICAgICAgICAgICAid2VsbCI6IHdlbGxfaWQsCiAgICAgICAgICAgICAgICAgICAgImNvbnRlbnQiOiBjb250ZW50X3N0ciwKICAgICAgICAgICAgICAgICAgICAidGltZV9zIjogZmxvYXQodCksCiAgICAgICAgICAgICAgICAgICAgInZhbHVlIjogdl9mbG9hdCwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgIAogICAgICAgIHJvd3NfcHJvY2Vzc2VkICs9IDEKICAgICAgICBpZiByb3dzX3Byb2Nlc3NlZCAlIDEwMCA9PSAwOgogICAgICAgICAgICBwcmludChmIiAgICBQcm9jZXNzZWQge3Jvd3NfcHJvY2Vzc2VkfSByb3dzLi4uIiwgZmx1c2g9VHJ1ZSkKCiAgICBwcmludChmIiAgUHJvY2Vzc2VkIHtyb3dzX3Byb2Nlc3NlZH0gcm93cywgY3JlYXRlZCB7bGVuKHJlY29yZHMpfSBkYXRhIHBvaW50cyIsIGZsdXNoPVRydWUpCgogICAgaWYgbm90IHJlY29yZHM6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIk5vIGRhdGEgcm93cyBmb3VuZCBpbiB7eGxzeF9wYXRofSBhZnRlciBwYXJzaW5nLiIpCgogICAgcHJpbnQoZiIgIENyZWF0aW5nIERhdGFGcmFtZS4uLiIsIGZsdXNoPVRydWUpCiAgICBsb25nX2RmID0gcGQuRGF0YUZyYW1lLmZyb21fcmVjb3JkcyhyZWNvcmRzKQogICAgcHJpbnQoZiIgIOKckyBDb21wbGV0ZWQgcGFyc2luZyB7b3MucGF0aC5iYXNlbmFtZSh4bHN4X3BhdGgpfSIsIGZsdXNoPVRydWUpCiAgICByZXR1cm4gbG9uZ19kZgoKCmRlZiBlbnN1cmVfZGlyKHBhdGg6IHN0cik6CiAgICBvcy5tYWtlZGlycyhwYXRoLCBleGlzdF9vaz1UcnVlKQoKCmRlZiB3cml0ZV9jc3ZzX2Zvcl9wbGF0ZSgKICAgIGxvbmdfZGY6IHBkLkRhdGFGcmFtZSwgCiAgICBjc3Zfcm9vdDogc3RyLCAKICAgIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lLCAKICAgIGZpbGVuYW1lOiBzdHIgPSBOb25lLAogICAgYmFzZWxpbmVfZW5kX3RpbWU6IGZsb2F0ID0gMjAuMCwKICAgIGJhc2VsaW5lX21ldGhvZDogc3RyID0gJ2NvbnN0YW50JywKICAgIGJhc2VsaW5lX2ZyYWM6IGZsb2F0ID0gMC41LAogICAgYmFzZWxpbmVfcG9seV9vcmRlcjogaW50ID0gMSwKICAgIG5vcm1hbGl6YXRpb25fbW9kZTogc3RyID0gJ211bHRpcGxpY2F0aXZlJwopOgogICAgIiIiCiAgICBXcml0ZSBDU1YgZmlsZXM6CiAgICAgIC0gY3N2X3Jvb3QvPHBsYXRlX2lkPi88cGxhdGVfaWQ+Xzx3ZWxsPi5jc3YgKHBlciB3ZWxsLCBub3JtYWxpemVkIHZhbHVlcyB3aXRoIGJhc2VsaW5lKQogICAgICAtIGNzdl9yb290Lzxjb25kaXRpb24+Xzx0cmlwbGljYXRlX25hbWU+LmNzdiAocGVyIGNvbmRpdGlvbi10cmlwbGljYXRlIGNvbWJpbmF0aW9uLCB1c2luZyBub3JtYWxpemVkIHZhbHVlcyB3aXRoIG1lYW4gYW5kIFNFTSkKICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBsb25nX2RmIDogcGQuRGF0YUZyYW1lCiAgICAgICAgTG9uZy1mb3JtYXQgRGF0YUZyYW1lIHdpdGggY29sdW1ucyBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgY3N2X3Jvb3QgOiBzdHIKICAgICAgICBSb290IGRpcmVjdG9yeSBmb3IgQ1NWIG91dHB1dAogICAgY29uZmlnIDogRGljdFtzdHIsIEFueV0sIG9wdGlvbmFsCiAgICAgICAgQ29uZmlndXJhdGlvbiBkaWN0aW9uYXJ5CiAgICBmaWxlbmFtZSA6IHN0ciwgb3B0aW9uYWwKICAgICAgICBTb3VyY2UgZmlsZW5hbWUgZm9yIHBhcnNpbmcgY29sdW1uIGluZm8KICAgIGJhc2VsaW5lX2VuZF90aW1lIDogZmxvYXQKICAgICAgICBNYXhpbXVtIHRpbWUgKGluIHNlY29uZHMpIGZvciBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQ6IDI0LjApCiAgICBiYXNlbGluZV9tZXRob2QgOiBzdHIKICAgICAgICBCYXNlbGluZSBmaXR0aW5nIG1ldGhvZDogJ2xvd2VzcycsICdjb25zdGFudCcsIG9yICdwb2x5bm9taWFsJyAoZGVmYXVsdDogJ2NvbnN0YW50JykKICAgIGJhc2VsaW5lX2ZyYWMgOiBmbG9hdAogICAgICAgIEZyYWN0aW9uIG9mIGRhdGEgdXNlZCBmb3IgTE9XRVNTIHNtb290aGluZyAoZGVmYXVsdDogMC41KQogICAgYmFzZWxpbmVfcG9seV9vcmRlciA6IGludAogICAgICAgIFBvbHlub21pYWwgb3JkZXIgZm9yIHBvbHlub21pYWwgZml0IChkZWZhdWx0OiAxKQogICAgbm9ybWFsaXphdGlvbl9tb2RlIDogc3RyCiAgICAgICAgTm9ybWFsaXphdGlvbiBtb2RlOiAnZGVsdGFfZl9vdmVyX2YnIG9yICdtdWx0aXBsaWNhdGl2ZScgKGRlZmF1bHQ6ICdtdWx0aXBsaWNhdGl2ZScpCiAgICAiIiIKICAgIHBsYXRlX2lkID0gbG9uZ19kZlsicGxhdGVfaWQiXS5pbG9jWzBdCiAgICBwcmludChmIiAgV3JpdGluZyBDU1ZzIGZvciB7cGxhdGVfaWR9Li4uIiwgZmx1c2g9VHJ1ZSkKCiAgICAjIExvYWQgY29uZmlnIGlmIG5vdCBwcm92aWRlZAogICAgaWYgY29uZmlnIGlzIE5vbmU6CiAgICAgICAgc2NyaXB0X2RpciA9IG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmFic3BhdGgoX19maWxlX18pKQogICAgICAgIGNvbmZpZ19wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJwbGF0ZV9jb25maWcuanNvbiIpCiAgICAgICAgY29uZmlnID0gbG9hZF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAKICAgICMgRmlsdGVyIG91dCBiYWQgd2VsbHMgYmVmb3JlIHByb2Nlc3NpbmcKICAgIGJhZF93ZWxsc19saXN0ID0gY29uZmlnLmdldCgiYmFkX3dlbGxzIiwgW10pCiAgICBpZiBiYWRfd2VsbHNfbGlzdDoKICAgICAgICBvcmlnaW5hbF9jb3VudCA9IGxlbihsb25nX2RmKQogICAgICAgIGxvbmdfZGYgPSBsb25nX2RmW35sb25nX2RmWyJ3ZWxsIl0uYXBwbHkobGFtYmRhIHc6IGlzX2JhZF93ZWxsKHcsIGNvbmZpZykpXQogICAgICAgIGZpbHRlcmVkX2NvdW50ID0gbGVuKGxvbmdfZGYpCiAgICAgICAgaWYgb3JpZ2luYWxfY291bnQgIT0gZmlsdGVyZWRfY291bnQ6CiAgICAgICAgICAgIHByaW50KGYiICAgIEV4Y2x1ZGluZyB7b3JpZ2luYWxfY291bnQgLSBmaWx0ZXJlZF9jb3VudH0gZGF0YSBwb2ludHMgZnJvbSBiYWQgd2VsbHMiLCBmbHVzaD1UcnVlKQogICAgCiAgICAjIE5vcm1hbGl6ZSBkYXRhIHdpdGggYmFzZWxpbmUgYmVmb3JlIHdyaXRpbmcgQ1NWcwogICAgcHJpbnQoZiIgICAgTm9ybWFsaXppbmcgZGF0YSB3aXRoIGJhc2VsaW5lIChtZXRob2Q9e2Jhc2VsaW5lX21ldGhvZH0sIG1vZGU9e25vcm1hbGl6YXRpb25fbW9kZX0pLi4uIiwgZmx1c2g9VHJ1ZSkKICAgIGJhc2VsaW5lX2ZpdHMgPSBmaXRfd2VsbF9iYXNlbGluZXMoCiAgICAgICAgbG9uZ19kZiwKICAgICAgICBiYXNlbGluZV9lbmRfdGltZT1iYXNlbGluZV9lbmRfdGltZSwKICAgICAgICBtZXRob2Q9YmFzZWxpbmVfbWV0aG9kLAogICAgICAgIGZyYWM9YmFzZWxpbmVfZnJhYywKICAgICAgICBwb2x5X29yZGVyPWJhc2VsaW5lX3BvbHlfb3JkZXIsCiAgICAgICAgY29uZmlnPWNvbmZpZwogICAgKQogICAgbm9ybV9kZiA9IG5vcm1hbGl6ZV93ZWxscyhsb25nX2RmLCBiYXNlbGluZV9maXRzLCBub3JtYWxpemF0aW9uX21vZGU9bm9ybWFsaXphdGlvbl9tb2RlKQogICAgIyBBZGQgbm9ybWFsaXplZCB3ZWxsIElEIGNvbHVtbiBmb3IgY29uc2lzdGVudCBtYXRjaGluZwogICAgbm9ybV9kZiA9IG5vcm1fZGYuY29weSgpCiAgICBub3JtX2RmWyJ3ZWxsX25vcm1hbGl6ZWQiXSA9IG5vcm1fZGZbIndlbGwiXS5hcHBseShsYW1iZGEgdzogbm9ybWFsaXplX3dlbGxfaWQoc3RyKHcpLnN0cmlwKCkpKQogICAgcHJpbnQoZiIgICAg4pyTIE5vcm1hbGl6ZWQge2xlbihub3JtX2RmKX0gZGF0YSBwb2ludHMiLCBmbHVzaD1UcnVlKQogICAgCiAgICAjIFBhcnNlIGNvbHVtbiBpbmZvIGZyb20gZmlsZW5hbWUgaWYgcHJvdmlkZWQKICAgIGNvbHVtbl9pbmZvID0gTm9uZQogICAgaWYgZmlsZW5hbWU6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb2x1bW5faW5mbyA9IHBhcnNlX2NvbHVtbl9ncm91cF9mcm9tX2ZpbGVuYW1lKGZpbGVuYW1lKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgIAogICAgIyBHZXQgd2VsbF9sYWJlbHMgYW5kIGNvbnRyb2xfcm93cyBmcm9tIGNvbmZpZwogICAgY29uZmlnX3dlbGxfbGFiZWxzID0gY29uZmlnLmdldCgid2VsbF9sYWJlbHMiLCB7fSkKICAgIHdlbGxfbGFiZWxzID0ge30KICAgIAogICAgIyBQcm9jZXNzIGNvbmZpZyBsYWJlbHMgLSBjb252ZXJ0IHdlbGwtc3BlY2lmaWMgdG8gcm93LWJhc2VkIGlmIG5lZWRlZAogICAgZm9yIGtleSwgdmFsdWUgaW4gY29uZmlnX3dlbGxfbGFiZWxzLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGtleSkgPiAxIGFuZCBrZXlbMF0uaXNhbHBoYSgpIGFuZCBrZXlbMTpdLmlzZGlnaXQoKToKICAgICAgICAgICAgIyBPbGQgZm9ybWF0OiAiQjEzIiAtPiBleHRyYWN0IHJvdyAiQiIKICAgICAgICAgICAgcm93X2xldHRlciA9IGtleVswXQogICAgICAgICAgICBpZiByb3dfbGV0dGVyIG5vdCBpbiB3ZWxsX2xhYmVsczoKICAgICAgICAgICAgICAgIHdlbGxfbGFiZWxzW3Jvd19sZXR0ZXJdID0gdmFsdWUKICAgICAgICAgICAgZWxpZiBub3Qgd2VsbF9sYWJlbHNbcm93X2xldHRlcl0gb3Igbm90IHdlbGxfbGFiZWxzW3Jvd19sZXR0ZXJdLnN0cmlwKCk6CiAgICAgICAgICAgICAgICB3ZWxsX2xhYmVsc1tyb3dfbGV0dGVyXSA9IHZhbHVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBOZXcgZm9ybWF0OiAiQiIgLT4gdXNlIGFzIGlzCiAgICAgICAgICAgIHdlbGxfbGFiZWxzW2tleV0gPSB2YWx1ZQogICAgCiAgICAjIEFsc28gY29udmVydCBERUZBVUxUX1dFTExfTEFCRUxTIHRvIHJvdy1iYXNlZCBmb3JtYXQKICAgIGRlZmF1bHRfcm93X2xhYmVscyA9IHt9CiAgICBmb3Iga2V5LCB2YWx1ZSBpbiBERUZBVUxUX1dFTExfTEFCRUxTLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGtleSkgPiAxIGFuZCBrZXlbMF0uaXNhbHBoYSgpOgogICAgICAgICAgICByb3dfbGV0dGVyID0ga2V5WzBdCiAgICAgICAgICAgIGlmIHJvd19sZXR0ZXIgbm90IGluIGRlZmF1bHRfcm93X2xhYmVsczoKICAgICAgICAgICAgICAgIGRlZmF1bHRfcm93X2xhYmVsc1tyb3dfbGV0dGVyXSA9IHZhbHVlCiAgICAKICAgICMgTWVyZ2UgZGVmYXVsdHMgd2l0aCBjb25maWcgKGNvbmZpZyB0YWtlcyBwcmVjZWRlbmNlKQogICAgd2VsbF9sYWJlbHMgPSB7KipkZWZhdWx0X3Jvd19sYWJlbHMsICoqd2VsbF9sYWJlbHN9CiAgICAKICAgIGNvbnRyb2xfcm93cyA9IGNvbmZpZy5nZXQoImNvbnRyb2xfcm93cyIsIFsiTiIsICJPIl0pCiAgICAKICAgICMgQXV0by1nZW5lcmF0ZSBncm91cHMgZnJvbSB3ZWxsX2xhYmVscwogICAgZ3JvdXBzID0gW10KICAgIGxhYmVsX3RvX3Jvd3M6IERpY3Rbc3RyLCBMaXN0W3N0cl1dID0ge30KICAgIAogICAgIyBHcm91cCByb3cgbGV0dGVycyBieSB0aGVpciBsYWJlbHMKICAgIGZvciByb3dfbGV0dGVyLCBsYWJlbCBpbiB3ZWxsX2xhYmVscy5pdGVtcygpOgogICAgICAgICMgRmlsdGVyIG91dCBjb250cm9sIHdlbGxzCiAgICAgICAgaWYgbm90IGlzX2NvbnRyb2xfd2VsbChyb3dfbGV0dGVyLCBjb250cm9sX3Jvd3MpOgogICAgICAgICAgICBpZiBsYWJlbCBhbmQgc3RyKGxhYmVsKS5zdHJpcCgpOgogICAgICAgICAgICAgICAgaWYgbGFiZWwgbm90IGluIGxhYmVsX3RvX3Jvd3M6CiAgICAgICAgICAgICAgICAgICAgbGFiZWxfdG9fcm93c1tsYWJlbF0gPSBbXQogICAgICAgICAgICAgICAgaWYgcm93X2xldHRlciBub3QgaW4gbGFiZWxfdG9fcm93c1tsYWJlbF06CiAgICAgICAgICAgICAgICAgICAgbGFiZWxfdG9fcm93c1tsYWJlbF0uYXBwZW5kKHJvd19sZXR0ZXIpCiAgICAKICAgICMgQ3JlYXRlIGdyb3VwcyBmcm9tIGxhYmVscwogICAgZm9yIGxhYmVsLCByb3dfbGV0dGVycyBpbiBsYWJlbF90b19yb3dzLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKHJvd19sZXR0ZXJzKSA+PSAxOiAgIyBBdCBsZWFzdCAxIHJvdyB3aXRoIHRoaXMgbGFiZWwKICAgICAgICAgICAgZ3JvdXBzLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAibmFtZSI6IGxhYmVsLAogICAgICAgICAgICAgICAgIndlbGxzIjogc29ydGVkKHJvd19sZXR0ZXJzKSAgIyBTdG9yZSByb3cgbGV0dGVycyBvbmx5CiAgICAgICAgICAgIH0pCiAgICAKICAgICMgQnVpbGQgbWFwcGluZzogd2VsbF9pZCAtPiBncm91cCBuYW1lCiAgICAjIFVzZSBub3JtYWxpemVkIHdlbGwgSURzIGZvciBjb25zaXN0ZW50IG1hdGNoaW5nCiAgICB3ZWxsX3RvX2dyb3VwID0ge30KICAgIGZvciBncm91cCBpbiBncm91cHM6CiAgICAgICAgZ3JvdXBfbmFtZSA9IGdyb3VwLmdldCgibmFtZSIsICIiKQogICAgICAgIGdyb3VwX3dlbGxzID0gZ3JvdXAuZ2V0KCJ3ZWxscyIsIFtdKQogICAgICAgIGZvciByb3dfbGV0dGVyIGluIGdyb3VwX3dlbGxzOgogICAgICAgICAgICAjIEZpbmQgYWxsIHdlbGxzIGluIHRoaXMgcm93IGFjcm9zcyBhbGwgY29sdW1ucwogICAgICAgICAgICAjIFVzZSB3ZWxsX25vcm1hbGl6ZWQgY29sdW1uIGZvciBjb25zaXN0ZW50IG1hdGNoaW5nCiAgICAgICAgICAgIGZvciBub3JtYWxpemVkX3dlbGxfaWQgaW4gbm9ybV9kZlsid2VsbF9ub3JtYWxpemVkIl0udW5pcXVlKCk6CiAgICAgICAgICAgICAgICBpZiBub3JtYWxpemVkX3dlbGxfaWQ6CiAgICAgICAgICAgICAgICAgICAgIyBDaGVjayBpZiBub3JtYWxpemVkIHdlbGwgSUQgc3RhcnRzIHdpdGggdGhlIHJvdyBsZXR0ZXIKICAgICAgICAgICAgICAgICAgICBpZiBub3JtYWxpemVkX3dlbGxfaWQgYW5kIG5vcm1hbGl6ZWRfd2VsbF9pZFswXSA9PSByb3dfbGV0dGVyOgogICAgICAgICAgICAgICAgICAgICAgICAjIFN0b3JlIG1hcHBpbmcgdXNpbmcgbm9ybWFsaXplZCB3ZWxsIElEIChjb25zaXN0ZW50IGZvcm1hdCkKICAgICAgICAgICAgICAgICAgICAgICAgd2VsbF90b19ncm91cFtub3JtYWxpemVkX3dlbGxfaWRdID0gZ3JvdXBfbmFtZQogICAgCiAgICAjIFBlci13ZWxsIENTVnMgKG5vcm1hbGl6ZWQgdmFsdWVzIHdpdGggYmFzZWxpbmUsIHdpdGhvdXQgU0VNIC0gU0VNIG9ubHkgYmVsb25ncyBpbiB0cmlwbGljYXRlIENTVnMpCiAgICBwbGF0ZV9mb2xkZXIgPSBvcy5wYXRoLmpvaW4oY3N2X3Jvb3QsIHBsYXRlX2lkKQogICAgZW5zdXJlX2RpcihwbGF0ZV9mb2xkZXIpCiAgICAKICAgIHdlbGxzID0gbm9ybV9kZi5ncm91cGJ5KCJ3ZWxsIikKICAgIHByaW50KGYiICAgIFdyaXRpbmcge2xlbih3ZWxscyl9IHBlci13ZWxsIENTVnMgKG5vcm1hbGl6ZWQgdmFsdWVzKS4uLiIsIGZsdXNoPVRydWUpCiAgICAKICAgICMgV3JpdGUgcGVyLXdlbGwgQ1NWcyB3aXRoIG5vcm1hbGl6ZWQgdmFsdWVzCiAgICBmb3IgaWR4LCAod2VsbF9pZCwgZykgaW4gZW51bWVyYXRlKHdlbGxzLCAxKToKICAgICAgICAjIE5vcm1hbGl6ZSB3ZWxsIElEIGZvciBjb25zaXN0ZW50IGZpbGUgbmFtaW5nCiAgICAgICAgbm9ybWFsaXplZF93ZWxsX2lkID0gbm9ybWFsaXplX3dlbGxfaWQoc3RyKHdlbGxfaWQpLnN0cmlwKCkpCiAgICAgICAgc2FmZV93ZWxsID0gbm9ybWFsaXplZF93ZWxsX2lkLnJlcGxhY2UoIiAiLCAiIikucmVwbGFjZSgiOiIsICItIikKICAgICAgICBvdXRfcGF0aCA9IG9zLnBhdGguam9pbihwbGF0ZV9mb2xkZXIsIGYie3BsYXRlX2lkfV97c2FmZV93ZWxsfS5jc3YiKQogICAgICAgIGdfc29ydGVkID0gZy5zb3J0X3ZhbHVlcygidGltZV9zIikKICAgICAgICAKICAgICAgICAjIENyZWF0ZSBvdXRwdXQgRGF0YUZyYW1lIHdpdGggdGltZSBhbmQgbm9ybWFsaXplZCB2YWx1ZSBvbmx5IChubyBTRU0pCiAgICAgICAgb3V0cHV0X2RmID0gcGQuRGF0YUZyYW1lKHsKICAgICAgICAgICAgInRpbWVfcyI6IGdfc29ydGVkWyJ0aW1lX3MiXS52YWx1ZXMsCiAgICAgICAgICAgICJ2YWx1ZSI6IGdfc29ydGVkWyJ2YWx1ZSJdLnZhbHVlcyAgIyBUaGlzIGlzIG5vdyBub3JtYWxpemVkCiAgICAgICAgfSkKICAgICAgICBvdXRwdXRfZGYudG9fY3N2KG91dF9wYXRoLCBpbmRleD1GYWxzZSkKICAgICAgICAKICAgICAgICBpZiBpZHggJSA1ID09IDA6CiAgICAgICAgICAgIHByaW50KGYiICAgICAgV3JpdHRlbiB7aWR4fS97bGVuKHdlbGxzKX0gd2VsbHMuLi4iLCBmbHVzaD1UcnVlKQogICAgCiAgICAjIFdyaXRlIGNvbmRpdGlvbi1zcGVjaWZpYyBDU1ZzIChnZW5vdHlwZS1idWZmZXItdHJpcGxpY2F0ZSkKICAgICMgT25lIENTViBwZXIgY29uZGl0aW9uLXRyaXBsaWNhdGUtY29sdW1uIGNvbWJpbmF0aW9uCiAgICAjIFVzaW5nIG5vcm1hbGl6ZWQgdmFsdWVzIGZyb20gbm9ybV9kZgogICAgaWYgY29sdW1uX2luZm86CiAgICAgICAgcHJpbnQoZiIgICAgV3JpdGluZyBjb25kaXRpb24tc3BlY2lmaWMgQ1NWcyAodXNpbmcgbm9ybWFsaXplZCB2YWx1ZXMpLi4uIiwgZmx1c2g9VHJ1ZSkKICAgICAgICBnZW5vdHlwZSA9IGNvbHVtbl9pbmZvLmdldCgiZ2Vub3R5cGUiLCAiIikKICAgICAgICBidWZmZXIgPSBjb2x1bW5faW5mby5nZXQoImJ1ZmZlciIsICIiKQogICAgICAgIAogICAgICAgICMgR3JvdXAgYnkgZ3JvdXAgbmFtZSBhbmQgY29sdW1uCiAgICAgICAgZm9yIGdyb3VwIGluIGdyb3VwczoKICAgICAgICAgICAgZ3JvdXBfbmFtZSA9IGdyb3VwLmdldCgibmFtZSIsICIiKQogICAgICAgICAgICBpZiBub3QgZ3JvdXBfbmFtZToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdldCBhbGwgd2VsbHMgaW4gdGhpcyB0cmlwbGljYXRlIGdyb3VwIChhY3Jvc3MgYWxsIGNvbHVtbnMpCiAgICAgICAgICAgICMgVXNlIG5vcm1hbGl6ZWQgd2VsbCBJRHMgZm9yIGNvbnNpc3RlbnQgbWF0Y2hpbmcKICAgICAgICAgICAgZ3JvdXBfd2VsbHMgPSBbXQogICAgICAgICAgICBmb3Igbm9ybWFsaXplZF93ZWxsX2lkIGluIG5vcm1fZGZbIndlbGxfbm9ybWFsaXplZCJdLnVuaXF1ZSgpOgogICAgICAgICAgICAgICAgIyBDaGVjayB1c2luZyBub3JtYWxpemVkIHdlbGwgSUQKICAgICAgICAgICAgICAgIGlmIG5vcm1hbGl6ZWRfd2VsbF9pZCBpbiB3ZWxsX3RvX2dyb3VwIGFuZCB3ZWxsX3RvX2dyb3VwW25vcm1hbGl6ZWRfd2VsbF9pZF0gPT0gZ3JvdXBfbmFtZToKICAgICAgICAgICAgICAgICAgICAjIFN0b3JlIG5vcm1hbGl6ZWQgd2VsbCBJRCBmb3IgY29uc2lzdGVuY3kKICAgICAgICAgICAgICAgICAgICBncm91cF93ZWxscy5hcHBlbmQobm9ybWFsaXplZF93ZWxsX2lkKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGdyb3VwX3dlbGxzOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR3JvdXAgd2VsbHMgYnkgY29sdW1uIG51bWJlcgogICAgICAgICAgICAjIE5vdGU6IGdyb3VwX3dlbGxzIG5vdyBjb250YWlucyBub3JtYWxpemVkIHdlbGwgSURzCiAgICAgICAgICAgIHdlbGxzX2J5X2NvbHVtbiA9IHt9CiAgICAgICAgICAgIGZvciBub3JtYWxpemVkX3dlbGxfaWQgaW4gZ3JvdXBfd2VsbHM6CiAgICAgICAgICAgICAgICAjIEV4dHJhY3QgY29sdW1uIG51bWJlciBmcm9tIG5vcm1hbGl6ZWQgd2VsbCBJRCAoZS5nLiwgIkIxMyIgLT4gMTMsICJCMDUiIC0+IDUpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgY29sdW1uX251bSA9IGludCgnJy5qb2luKGZpbHRlcihzdHIuaXNkaWdpdCwgc3RyKG5vcm1hbGl6ZWRfd2VsbF9pZCkpKSkKICAgICAgICAgICAgICAgICAgICBpZiBjb2x1bW5fbnVtIG5vdCBpbiB3ZWxsc19ieV9jb2x1bW46CiAgICAgICAgICAgICAgICAgICAgICAgIHdlbGxzX2J5X2NvbHVtbltjb2x1bW5fbnVtXSA9IFtdCiAgICAgICAgICAgICAgICAgICAgd2VsbHNfYnlfY29sdW1uW2NvbHVtbl9udW1dLmFwcGVuZChub3JtYWxpemVkX3dlbGxfaWQpCiAgICAgICAgICAgICAgICBleGNlcHQgKFZhbHVlRXJyb3IsIEF0dHJpYnV0ZUVycm9yKToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDcmVhdGUgb25lIENTViBwZXIgY29sdW1uIGZvciB0aGlzIHRyaXBsaWNhdGUgZ3JvdXAKICAgICAgICAgICAgZm9yIGNvbHVtbl9udW0gaW4gc29ydGVkKHdlbGxzX2J5X2NvbHVtbi5rZXlzKCkpOgogICAgICAgICAgICAgICAgY29sdW1uX3dlbGxzID0gd2VsbHNfYnlfY29sdW1uW2NvbHVtbl9udW1dCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgR2V0IGFsbCB0aW1lIHBvaW50cyBmb3IgdGhpcyBjb2x1bW4ncyB3ZWxscyAodXNpbmcgbm9ybWFsaXplZCBkYXRhKQogICAgICAgICAgICAgICAgIyBjb2x1bW5fd2VsbHMgY29udGFpbnMgbm9ybWFsaXplZCB3ZWxsIElEcywgdXNlIHdlbGxfbm9ybWFsaXplZCBjb2x1bW4gZm9yIG1hdGNoaW5nCiAgICAgICAgICAgICAgICAjIEZpbHRlciBvdXQgYmFkIHdlbGxzIGZyb20gY29sdW1uX3dlbGxzCiAgICAgICAgICAgICAgICBjb2x1bW5fd2VsbHNfZmlsdGVyZWQgPSBbdyBmb3IgdyBpbiBjb2x1bW5fd2VsbHMgaWYgbm90IGlzX2JhZF93ZWxsKHcsIGNvbmZpZyldCiAgICAgICAgICAgICAgICBpZiBub3QgY29sdW1uX3dlbGxzX2ZpbHRlcmVkOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlICAjIFNraXAgdGhpcyBjb2x1bW4gaWYgYWxsIHdlbGxzIGFyZSBiYWQKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgYWxsX3RpbWVzID0gc29ydGVkKG5vcm1fZGZbbm9ybV9kZlsid2VsbF9ub3JtYWxpemVkIl0uaXNpbihjb2x1bW5fd2VsbHNfZmlsdGVyZWQpXVsidGltZV9zIl0udW5pcXVlKCkpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ2FsY3VsYXRlIG1lYW4gYW5kIFNFTSBmb3IgZWFjaCB0aW1lIHBvaW50IGFjcm9zcyB3ZWxscyBpbiB0aGlzIHRyaXBsaWNhdGUgZ3JvdXAgZm9yIHRoaXMgY29sdW1uCiAgICAgICAgICAgICAgICAjIFVzaW5nIG5vcm1hbGl6ZWQgdmFsdWVzCiAgICAgICAgICAgICAgICBtZWFuX3ZhbHVlcyA9IFtdCiAgICAgICAgICAgICAgICBzZW1fdmFsdWVzID0gW10KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIHRpbWUgaW4gYWxsX3RpbWVzOgogICAgICAgICAgICAgICAgICAgIHZhbHVlc19hdF90aW1lID0gW10KICAgICAgICAgICAgICAgICAgICBmb3Igbm9ybWFsaXplZF93ZWxsX2lkIGluIGNvbHVtbl93ZWxsc19maWx0ZXJlZDoKICAgICAgICAgICAgICAgICAgICAgICAgd2VsbF9kYXRhID0gbm9ybV9kZlsobm9ybV9kZlsid2VsbF9ub3JtYWxpemVkIl0gPT0gbm9ybWFsaXplZF93ZWxsX2lkKSAmIChub3JtX2RmWyJ0aW1lX3MiXSA9PSB0aW1lKV0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHdlbGxfZGF0YS5lbXB0eToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlc19hdF90aW1lLmFwcGVuZCh3ZWxsX2RhdGFbInZhbHVlIl0uaWxvY1swXSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBsZW4odmFsdWVzX2F0X3RpbWUpID49IDI6CiAgICAgICAgICAgICAgICAgICAgICAgIG1lYW4gPSBzdW0odmFsdWVzX2F0X3RpbWUpIC8gbGVuKHZhbHVlc19hdF90aW1lKQogICAgICAgICAgICAgICAgICAgICAgICB2YXJpYW5jZSA9IHN1bSgodiAtIG1lYW4pICoqIDIgZm9yIHYgaW4gdmFsdWVzX2F0X3RpbWUpIC8gKGxlbih2YWx1ZXNfYXRfdGltZSkgLSAxKSAjIFNhbXBsZSB2YXJpYW5jZSB1c2luZyBCZXNzZWwncyBjb3JyZWN0aW9uL3NhbXBsZSBzdGFuZGFyZCBkZXZpYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgc3RkX2RldiA9IHZhcmlhbmNlICoqIDAuNQogICAgICAgICAgICAgICAgICAgICAgICBzZW0gPSBzdGRfZGV2IC8gKGxlbih2YWx1ZXNfYXRfdGltZSkgKiogMC41KQogICAgICAgICAgICAgICAgICAgICAgICBtZWFuX3ZhbHVlcy5hcHBlbmQobWVhbikKICAgICAgICAgICAgICAgICAgICAgICAgc2VtX3ZhbHVlcy5hcHBlbmQoc2VtKQogICAgICAgICAgICAgICAgICAgIGVsaWYgbGVuKHZhbHVlc19hdF90aW1lKSA9PSAxOgogICAgICAgICAgICAgICAgICAgICAgICBtZWFuX3ZhbHVlcy5hcHBlbmQodmFsdWVzX2F0X3RpbWVbMF0pCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbV92YWx1ZXMuYXBwZW5kKE5vbmUpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbWVhbl92YWx1ZXMuYXBwZW5kKE5vbmUpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbV92YWx1ZXMuYXBwZW5kKE5vbmUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ3JlYXRlIGNvbmRpdGlvbiBDU1YgZmlsZW5hbWU6IHBsYXRlX2lkX3RyaXBsaWNhdGVfbmFtZV9jb2x7Y29sdW1ufQogICAgICAgICAgICAgICAgIyBQbGF0ZSBJRCBhbHJlYWR5IGNvbnRhaW5zIGdlbm90eXBlIGFuZCBidWZmZXIsIHNvIGp1c3QgdXNlIHRyaXBsaWNhdGUgbmFtZQogICAgICAgICAgICAgICAgIyBLZWVwIGh5cGhlbnMgaW4gZ3JvdXAgbmFtZSAoZS5nLiwgIjI1MC0xMC0yIiksIGp1c3Qgc2FuaXRpemUgc3BhY2VzIGFuZCBjb2xvbnMKICAgICAgICAgICAgICAgIHNhZmVfZ3JvdXBfbmFtZSA9IGdyb3VwX25hbWUucmVwbGFjZSgiICIsICJfIikucmVwbGFjZSgiOiIsICItIikKICAgICAgICAgICAgICAgIGNvbmRpdGlvbl9wYXRoID0gb3MucGF0aC5qb2luKGNzdl9yb290LCBmIntwbGF0ZV9pZH1fe3NhZmVfZ3JvdXBfbmFtZX1fY29se2NvbHVtbl9udW19LmNzdiIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgV3JpdGUgY29uZGl0aW9uIENTViB3aXRoIG5vcm1hbGl6ZWQgdmFsdWVzCiAgICAgICAgICAgICAgICBjb25kaXRpb25fZGYgPSBwZC5EYXRhRnJhbWUoewogICAgICAgICAgICAgICAgICAgICJ0aW1lX3MiOiBhbGxfdGltZXMsCiAgICAgICAgICAgICAgICAgICAgIm1lYW4iOiBtZWFuX3ZhbHVlcywKICAgICAgICAgICAgICAgICAgICAic2VtIjogc2VtX3ZhbHVlcwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIGNvbmRpdGlvbl9kZi50b19jc3YoY29uZGl0aW9uX3BhdGgsIGluZGV4PUZhbHNlKQogICAgICAgIAogICAgICAgIHByaW50KGYiICAgICAgV3JpdHRlbiBjb25kaXRpb24tc3BlY2lmaWMgQ1NWcyIsIGZsdXNoPVRydWUpCiAgICAKICAgIHByaW50KGYiICDinJMgQ29tcGxldGVkIHdyaXRpbmcgQ1NWcyBmb3Ige3BsYXRlX2lkfSIsIGZsdXNoPVRydWUpCgoKZGVmIHdyaXRlX2RlZmF1bHRfY29uZmlnKGNvbmZpZ19wYXRoOiBzdHIpOgogICAgIiIiV3JpdGUgZGVmYXVsdCBjb25maWd1cmF0aW9uIGZpbGUgZnJvbSBkZWZhdWx0cy4iIiIKICAgICMgQ29udmVydCBERUZBVUxUX1dFTExfTEFCRUxTIHRvIHJvdy1iYXNlZCBmb3JtYXQKICAgIHdlbGxfbGFiZWxzID0ge30KICAgIGZvciB3ZWxsX2lkLCBsYWJlbCBpbiBERUZBVUxUX1dFTExfTEFCRUxTLml0ZW1zKCk6CiAgICAgICAgaWYgd2VsbF9pZCBhbmQgbGVuKHdlbGxfaWQpID4gMCBhbmQgd2VsbF9pZFswXS5pc2FscGhhKCk6CiAgICAgICAgICAgIHJvd19sZXR0ZXIgPSB3ZWxsX2lkWzBdCiAgICAgICAgICAgIGlmIHJvd19sZXR0ZXIgbm90IGluIHdlbGxfbGFiZWxzOgogICAgICAgICAgICAgICAgd2VsbF9sYWJlbHNbcm93X2xldHRlcl0gPSBsYWJlbAogICAgCiAgICBkZWZhdWx0X2NvbmZpZyA9IHsKICAgICAgICAid2VsbF9sYWJlbHMiOiB3ZWxsX2xhYmVscywKICAgICAgICAiY29udHJvbF9yb3dzIjogWyJOIiwgIk8iXSwKICAgICAgICAiYmFkX3dlbGxzIjogW10KICAgIH0KICAgIAogICAgdHJ5OgogICAgICAgIHdpdGggb3Blbihjb25maWdfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBqc29uLmR1bXAoZGVmYXVsdF9jb25maWcsIGYsIGluZGVudD0yKQogICAgICAgIHByaW50KGYiICBHZW5lcmF0ZWQgZGVmYXVsdCBjb25maWd1cmF0aW9uIGZpbGU6IHtvcy5wYXRoLmJhc2VuYW1lKGNvbmZpZ19wYXRoKX0iLCBmbHVzaD1UcnVlKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiICBXYXJuaW5nOiBDb3VsZCBub3Qgd3JpdGUgZGVmYXVsdCBjb25maWcgZmlsZToge2V9IiwgZmx1c2g9VHJ1ZSkKCgpkZWYgbm9ybWFsaXplX3dlbGxfaWQod2VsbF9pZDogc3RyKSAtPiBzdHI6CiAgICAiIiIKICAgIE5vcm1hbGl6ZSB3ZWxsIElEIHRvIGNvbnNpc3RlbnQgZm9ybWF0OiB1cHBlcmNhc2Ugd2l0aCB6ZXJvLXBhZGRlZCBjb2x1bW4uCiAgICBFeGFtcGxlczogIkI1IiAtPiAiQjA1IiwgIkIxMyIgLT4gIkIxMyIsICJiNSIgLT4gIkIwNSIKICAgICIiIgogICAgaWYgbm90IHdlbGxfaWQ6CiAgICAgICAgcmV0dXJuICIiCiAgICAKICAgIHdlbGxfaWQgPSBzdHIod2VsbF9pZCkuc3RyaXAoKS51cHBlcigpCiAgICAKICAgICMgTWF0Y2ggcGF0dGVybjogbGV0dGVyIGZvbGxvd2VkIGJ5IGRpZ2l0cwogICAgaW1wb3J0IHJlCiAgICBtYXRjaCA9IHJlLm1hdGNoKHInXihbQS1aXSkoXGQrKSQnLCB3ZWxsX2lkKQogICAgaWYgbWF0Y2g6CiAgICAgICAgcm93ID0gbWF0Y2guZ3JvdXAoMSkKICAgICAgICBjb2wgPSBpbnQobWF0Y2guZ3JvdXAoMikpCiAgICAgICAgcmV0dXJuIGYie3Jvd317Y29sOjAyZH0iICAjIFplcm8tcGFkIHRvIDIgZGlnaXRzCiAgICAKICAgIHJldHVybiB3ZWxsX2lkCgoKZGVmIGlzX2JhZF93ZWxsKHdlbGxfaWQ6IHN0ciwgY29uZmlnOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUpIC0+IGJvb2w6CiAgICAiIiIKICAgIENoZWNrIGlmIGEgd2VsbCBpcyBpbiB0aGUgYmFkX3dlbGxzIGxpc3QgZnJvbSBjb25maWcuCiAgICAKICAgIFBhcmFtZXRlcnM6CiAgICAtLS0tLS0tLS0tLQogICAgd2VsbF9pZCA6IHN0cgogICAgICAgIFdlbGwgSUQgdG8gY2hlY2sgKGUuZy4sICJCMTMiLCAiQjA1IikKICAgIGNvbmZpZyA6IERpY3Rbc3RyLCBBbnldLCBvcHRpb25hbAogICAgICAgIENvbmZpZ3VyYXRpb24gZGljdGlvbmFyeS4gSWYgTm9uZSwgbG9hZHMgZnJvbSBwbGF0ZV9jb25maWcuanNvbgogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIGJvb2wKICAgICAgICBUcnVlIGlmIHRoZSB3ZWxsIGlzIGluIHRoZSBiYWRfd2VsbHMgbGlzdCwgRmFsc2Ugb3RoZXJ3aXNlCiAgICAiIiIKICAgIGlmIGNvbmZpZyBpcyBOb25lOgogICAgICAgIHNjcmlwdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgICAgICBjb25maWdfcGF0aCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAicGxhdGVfY29uZmlnLmpzb24iKQogICAgICAgIGNvbmZpZyA9IGxvYWRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgCiAgICBiYWRfd2VsbHMgPSBjb25maWcuZ2V0KCJiYWRfd2VsbHMiLCBbXSkKICAgIGlmIG5vdCBpc2luc3RhbmNlKGJhZF93ZWxscywgbGlzdCk6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgICMgTm9ybWFsaXplIHRoZSBpbnB1dCB3ZWxsIElEIGZvciBjb25zaXN0ZW50IG1hdGNoaW5nCiAgICBub3JtYWxpemVkX3dlbGxfaWQgPSBub3JtYWxpemVfd2VsbF9pZChzdHIod2VsbF9pZCkuc3RyaXAoKSkKICAgIAogICAgIyBDaGVjayBpZiBub3JtYWxpemVkIHdlbGwgSUQgbWF0Y2hlcyBhbnkgYmFkIHdlbGwgKG5vcm1hbGl6ZSBiYWQgd2VsbHMgdG9vKQogICAgZm9yIGJhZF93ZWxsIGluIGJhZF93ZWxsczoKICAgICAgICBub3JtYWxpemVkX2JhZF93ZWxsID0gbm9ybWFsaXplX3dlbGxfaWQoc3RyKGJhZF93ZWxsKS5zdHJpcCgpKQogICAgICAgIGlmIG5vcm1hbGl6ZWRfd2VsbF9pZCA9PSBub3JtYWxpemVkX2JhZF93ZWxsOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgbG9hZF9jb25maWcoY29uZmlnX3BhdGg6IHN0cikgLT4gRGljdFtzdHIsIEFueV06CiAgICAiIiJMb2FkIHBsYXRlIGNvbmZpZ3VyYXRpb24gZmlsZSBpZiBpdCBleGlzdHMsIG90aGVyd2lzZSBnZW5lcmF0ZSBmcm9tIGRlZmF1bHRzLiIiIgogICAgaWYgb3MucGF0aC5leGlzdHMoY29uZmlnX3BhdGgpOgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGNvbmZpZ19wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBjb25maWcgPSBqc29uLmxvYWQoZikKICAgICAgICAgICAgICAgIHByaW50KGYiICBMb2FkZWQgY29uZmlndXJhdGlvbiBmcm9tIHtvcy5wYXRoLmJhc2VuYW1lKGNvbmZpZ19wYXRoKX0iLCBmbHVzaD1UcnVlKQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbmZpZwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiIgIFdhcm5pbmc6IENvdWxkIG5vdCBsb2FkIGNvbmZpZyBmaWxlOiB7ZX0iLCBmbHVzaD1UcnVlKQogICAgICAgICAgICAjIEdlbmVyYXRlIGRlZmF1bHQgY29uZmlnIGlmIGxvYWRpbmcgZmFpbHMKICAgICAgICAgICAgd3JpdGVfZGVmYXVsdF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgZWxzZToKICAgICAgICAjIEdlbmVyYXRlIGRlZmF1bHQgY29uZmlnIGZpbGUgaWYgaXQgZG9lc24ndCBleGlzdAogICAgICAgIHdyaXRlX2RlZmF1bHRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgICAgIHJldHVybiB7fQoKCmRlZiBidWlsZF92aWV3ZXJfanNvbihhbGxfcGxhdGVzOiBEaWN0W3N0ciwgcGQuRGF0YUZyYW1lXSwganNvbl9wYXRoOiBzdHIsIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lLCBwbGF0ZV9pZF90b19maWxlbmFtZTogRGljdFtzdHIsIHN0cl0gPSBOb25lKToKICAgICIiIgogICAgQnVpbGQgdmlld2VyX2RhdGEuanNvbiB3aXRoIHN0cnVjdHVyZToKICAgIHsKICAgICAgImNvbmZpZyI6IHsKICAgICAgICAid2VsbF9sYWJlbHMiOiB7Li4ufSwKICAgICAgICAiZ3JvdXBzIjogWy4uLl0sICAjIHJvdy1sZXR0ZXIgZ3JvdXBzIChhcHBsaWVzIHRvIGFsbCBjb2x1bW5zLCBhdXRvLWdlbmVyYXRlZCBmcm9tIHdlbGxfbGFiZWxzKQogICAgICAgICJjb2x1bW5fZ3JvdXBzIjogey4uLn0gICMgbWFwcGluZyBvZiBjb2x1bW5fZ3JvdXAgdG8gbGlzdCBvZiBwbGF0ZV9pZHMKICAgICAgfSwKICAgICAgInBsYXRlcyI6IFsKICAgICAgICB7CiAgICAgICAgICAiaWQiOiAiPHBsYXRlX2lkPiIsCiAgICAgICAgICAiZmlsZSI6ICI8b3JpZ2luYWxfZmlsZV9uYW1lPiIsCiAgICAgICAgICAiY29sdW1uX2dyb3VwIjogIjxwcm90ZWluX2dlbm90eXBlX2J1ZmZlcj4iLAogICAgICAgICAgImNvbHVtbl9pbmZvIjogewogICAgICAgICAgICAicHJvdGVpbiI6ICIuLi4iLAogICAgICAgICAgICAiZ2Vub3R5cGUiOiAiLi4uIiwKICAgICAgICAgICAgImJ1ZmZlciI6ICIuLi4iLAogICAgICAgICAgICAic2NpZW50aXN0IjogIi4uLiIsCiAgICAgICAgICAgICJudW1iZXIiOiAiLi4uIgogICAgICAgICAgfSwKICAgICAgICAgICJ3ZWxscyI6IHsKICAgICAgICAgICAgIkIxNSI6IHsKICAgICAgICAgICAgICAiY29udGVudCI6ICJTYW1wbGUgWDEiLAogICAgICAgICAgICAgICJsYWJlbCI6ICJTYW1wbGUgWDEiLCAgIyBmcm9tIGNvbmZpZyBpZiBhdmFpbGFibGUKICAgICAgICAgICAgICAidGltZV9zIjogWy4uLl0sCiAgICAgICAgICAgICAgInZhbHVlcyI6IFsuLi5dCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC4uLgogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLi4uCiAgICAgIF0KICAgIH0KICAgICIiIgogICAgaWYgY29uZmlnIGlzIE5vbmU6CiAgICAgICAgY29uZmlnID0ge30KICAgIGlmIHBsYXRlX2lkX3RvX2ZpbGVuYW1lIGlzIE5vbmU6CiAgICAgICAgcGxhdGVfaWRfdG9fZmlsZW5hbWUgPSB7fQogICAgCiAgICAjIEdldCBjb250cm9sIHJvd3MgZnJvbSBjb25maWcgKGRlZmF1bHQ6IFsiTiIsICJPIl0pCiAgICBjb250cm9sX3Jvd3MgPSBjb25maWcuZ2V0KCJjb250cm9sX3Jvd3MiLCBbIk4iLCAiTyJdKQogICAgaWYgbm90IGlzaW5zdGFuY2UoY29udHJvbF9yb3dzLCBsaXN0KToKICAgICAgICBjb250cm9sX3Jvd3MgPSBbIk4iLCAiTyJdICAjIEZhbGxiYWNrIHRvIGRlZmF1bHQgaWYgaW52YWxpZAogICAgCiAgICAjIE1lcmdlIGRlZmF1bHQgd2VsbCBsYWJlbHMgd2l0aCBjb25maWcgbGFiZWxzIChjb25maWcgdGFrZXMgcHJlY2VkZW5jZSkKICAgICMgV2VsbCBsYWJlbHMgYXJlIG5vdyByb3ctYmFzZWQgKGUuZy4sICJCIjogImxhYmVsIikgaW5zdGVhZCBvZiB3ZWxsLXNwZWNpZmljIChlLmcuLCAiQjEzIjogImxhYmVsIikKICAgICMgQ29udmVydCBvbGQgZm9ybWF0IHRvIG5ldyBmb3JtYXQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkKICAgIGNvbmZpZ193ZWxsX2xhYmVscyA9IGNvbmZpZy5nZXQoIndlbGxfbGFiZWxzIiwge30pCiAgICB3ZWxsX2xhYmVscyA9IHt9CiAgICAKICAgICMgUHJvY2VzcyBjb25maWcgbGFiZWxzIC0gY29udmVydCB3ZWxsLXNwZWNpZmljIHRvIHJvdy1iYXNlZCBpZiBuZWVkZWQKICAgIGZvciBrZXksIHZhbHVlIGluIGNvbmZpZ193ZWxsX2xhYmVscy5pdGVtcygpOgogICAgICAgIGlmIGxlbihrZXkpID4gMSBhbmQga2V5WzBdLmlzYWxwaGEoKSBhbmQga2V5WzE6XS5pc2RpZ2l0KCk6CiAgICAgICAgICAgICMgT2xkIGZvcm1hdDogIkIxMyIgLT4gZXh0cmFjdCByb3cgIkIiCiAgICAgICAgICAgIHJvd19sZXR0ZXIgPSBrZXlbMF0KICAgICAgICAgICAgIyBVc2UgdGhlIGxhc3Qgbm9uLWVtcHR5IHZhbHVlIGZvciBlYWNoIHJvdyAoaW4gY2FzZSBvZiBkdXBsaWNhdGVzKQogICAgICAgICAgICBpZiByb3dfbGV0dGVyIG5vdCBpbiB3ZWxsX2xhYmVsczoKICAgICAgICAgICAgICAgIHdlbGxfbGFiZWxzW3Jvd19sZXR0ZXJdID0gdmFsdWUKICAgICAgICAgICAgZWxpZiBub3Qgd2VsbF9sYWJlbHNbcm93X2xldHRlcl0gb3Igbm90IHdlbGxfbGFiZWxzW3Jvd19sZXR0ZXJdLnN0cmlwKCk6CiAgICAgICAgICAgICAgICB3ZWxsX2xhYmVsc1tyb3dfbGV0dGVyXSA9IHZhbHVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBOZXcgZm9ybWF0OiAiQiIgLT4gdXNlIGFzIGlzCiAgICAgICAgICAgIHdlbGxfbGFiZWxzW2tleV0gPSB2YWx1ZQogICAgCiAgICAjIEFsc28gY29udmVydCBERUZBVUxUX1dFTExfTEFCRUxTIHRvIHJvdy1iYXNlZCBmb3JtYXQKICAgIGRlZmF1bHRfcm93X2xhYmVscyA9IHt9CiAgICBmb3Iga2V5LCB2YWx1ZSBpbiBERUZBVUxUX1dFTExfTEFCRUxTLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGtleSkgPiAxIGFuZCBrZXlbMF0uaXNhbHBoYSgpOgogICAgICAgICAgICByb3dfbGV0dGVyID0ga2V5WzBdCiAgICAgICAgICAgIGlmIHJvd19sZXR0ZXIgbm90IGluIGRlZmF1bHRfcm93X2xhYmVsczoKICAgICAgICAgICAgICAgIGRlZmF1bHRfcm93X2xhYmVsc1tyb3dfbGV0dGVyXSA9IHZhbHVlCiAgICAKICAgICMgTWVyZ2UgZGVmYXVsdHMgd2l0aCBjb25maWcgKGNvbmZpZyB0YWtlcyBwcmVjZWRlbmNlKQogICAgd2VsbF9sYWJlbHMgPSB7KipkZWZhdWx0X3Jvd19sYWJlbHMsICoqd2VsbF9sYWJlbHN9CiAgICAKICAgICMgUGFyc2UgY29sdW1uIGdyb3VwcyBmcm9tIGZpbGVuYW1lcwogICAgY29sdW1uX2dyb3VwczogRGljdFtzdHIsIExpc3Rbc3RyXV0gPSB7fSAgIyBjb2x1bW5fZ3JvdXAgLT4gbGlzdCBvZiBwbGF0ZV9pZHMKICAgIHBsYXRlX2NvbHVtbl9pbmZvOiBEaWN0W3N0ciwgRGljdFtzdHIsIHN0cl1dID0ge30gICMgcGxhdGVfaWQgLT4gY29sdW1uX2luZm8KICAgIAogICAgZm9yIHBsYXRlX2lkLCBkZiBpbiBhbGxfcGxhdGVzLml0ZW1zKCk6CiAgICAgICAgZmlsZW5hbWUgPSBwbGF0ZV9pZF90b19maWxlbmFtZS5nZXQocGxhdGVfaWQsIHBsYXRlX2lkICsgIi54bHN4IikKICAgICAgICBjb2x1bW5faW5mbyA9IHBhcnNlX2NvbHVtbl9ncm91cF9mcm9tX2ZpbGVuYW1lKGZpbGVuYW1lKQogICAgICAgIGNvbHVtbl9ncm91cCA9IGNvbHVtbl9pbmZvWyJjb2x1bW5fZ3JvdXAiXQogICAgICAgIAogICAgICAgIHBsYXRlX2NvbHVtbl9pbmZvW3BsYXRlX2lkXSA9IGNvbHVtbl9pbmZvCiAgICAgICAgCiAgICAgICAgaWYgY29sdW1uX2dyb3VwIG5vdCBpbiBjb2x1bW5fZ3JvdXBzOgogICAgICAgICAgICBjb2x1bW5fZ3JvdXBzW2NvbHVtbl9ncm91cF0gPSBbXQogICAgICAgIGlmIHBsYXRlX2lkIG5vdCBpbiBjb2x1bW5fZ3JvdXBzW2NvbHVtbl9ncm91cF06CiAgICAgICAgICAgIGNvbHVtbl9ncm91cHNbY29sdW1uX2dyb3VwXS5hcHBlbmQocGxhdGVfaWQpCiAgICAKICAgICMgQXV0by1nZW5lcmF0ZSBncm91cHMgZnJvbSB3ZWxsX2xhYmVscwogICAgIyBHcm91cHMgd2VsbHMgd2l0aCB0aGUgc2FtZSBsYWJlbCB0b2dldGhlcgogICAgIyBFeGNsdWRlIGNvbnRyb2wgd2VsbHMgZnJvbSBncm91cHMKICAgIGdyb3VwcyA9IFtdCiAgICBsYWJlbF90b19yb3dzOiBEaWN0W3N0ciwgTGlzdFtzdHJdXSA9IHt9CiAgICAKICAgICMgR3JvdXAgcm93IGxldHRlcnMgYnkgdGhlaXIgbGFiZWxzCiAgICBmb3Igcm93X2xldHRlciwgbGFiZWwgaW4gd2VsbF9sYWJlbHMuaXRlbXMoKToKICAgICAgICAjIEZpbHRlciBvdXQgY29udHJvbCB3ZWxscwogICAgICAgIGlmIG5vdCBpc19jb250cm9sX3dlbGwocm93X2xldHRlciwgY29udHJvbF9yb3dzKToKICAgICAgICAgICAgaWYgbGFiZWwgYW5kIHN0cihsYWJlbCkuc3RyaXAoKToKICAgICAgICAgICAgICAgIGlmIGxhYmVsIG5vdCBpbiBsYWJlbF90b19yb3dzOgogICAgICAgICAgICAgICAgICAgIGxhYmVsX3RvX3Jvd3NbbGFiZWxdID0gW10KICAgICAgICAgICAgICAgIGlmIHJvd19sZXR0ZXIgbm90IGluIGxhYmVsX3RvX3Jvd3NbbGFiZWxdOgogICAgICAgICAgICAgICAgICAgIGxhYmVsX3RvX3Jvd3NbbGFiZWxdLmFwcGVuZChyb3dfbGV0dGVyKQogICAgCiAgICAjIENyZWF0ZSBncm91cHMgZnJvbSBsYWJlbHMKICAgIGZvciBsYWJlbCwgcm93X2xldHRlcnMgaW4gbGFiZWxfdG9fcm93cy5pdGVtcygpOgogICAgICAgIGlmIGxlbihyb3dfbGV0dGVycykgPj0gMTogICMgQXQgbGVhc3QgMSByb3cgd2l0aCB0aGlzIGxhYmVsCiAgICAgICAgICAgIGdyb3Vwcy5hcHBlbmQoewogICAgICAgICAgICAgICAgIm5hbWUiOiBsYWJlbCwKICAgICAgICAgICAgICAgICJ3ZWxscyI6IHNvcnRlZChyb3dfbGV0dGVycykgICMgU3RvcmUgcm93IGxldHRlcnMgb25seQogICAgICAgICAgICB9KQogICAgCiAgICAjIFNvcnQgZ3JvdXBzIGJ5IG5hbWUKICAgIGdyb3Vwcy5zb3J0KGtleT1sYW1iZGEgeDogeC5nZXQoIm5hbWUiLCAiIikpCiAgICAKICAgIGlmIGdyb3VwczoKICAgICAgICBwcmludChmIiAgQXV0by1nZW5lcmF0ZWQge2xlbihncm91cHMpfSBncm91cChzKSBmcm9tIHdlbGxfbGFiZWxzIChhcHBsaWVzIHRvIGFsbCBjb2x1bW5zKSIsIGZsdXNoPVRydWUpCiAgICBlbHNlOgogICAgICAgIHByaW50KGYiICBObyBncm91cHMgZ2VuZXJhdGVkIGZyb20gd2VsbF9sYWJlbHMiLCBmbHVzaD1UcnVlKQogICAgCiAgICAjIERldGVjdCBkdXBsaWNhdGUgd2VsbCBJRHMgKHNhbWUgd2VsbCBJRCBhcHBlYXJzIGluIG11bHRpcGxlIGZpbGVzKQogICAgIyBPbmx5IGZsYWcgYXMgZHVwbGljYXRlIGlmIHNhbWUgc2NpZW50aXN0IEFORCBzYW1lIHdlbGwgSUQKICAgICMgVGhpcyBtZWFucyBkdXBsaWNhdGUgY29sdW1ucyBpbiB0aGUgcGxhdGUgZ3JpZAogICAgIyBTdHJ1Y3R1cmU6IChzY2llbnRpc3QsIHdlbGxfaWQpIC0+IGxpc3Qgb2YgZmlsZW5hbWVzCiAgICBzY2llbnRpc3Rfd2VsbF90b19maWxlczogRGljdFt0dXBsZSwgTGlzdFtzdHJdXSA9IHt9ICAjIChzY2llbnRpc3QsIHdlbGxfaWQpIC0+IGxpc3Qgb2YgZmlsZW5hbWVzCiAgICAKICAgICMgQnVpbGQgbWFwIG9mIHBsYXRlX2lkIHRvIHNjaWVudGlzdCBmb3IgcXVpY2sgbG9va3VwCiAgICBwbGF0ZV9pZF90b19zY2llbnRpc3Q6IERpY3Rbc3RyLCBzdHJdID0ge30KICAgIGZvciBwbGF0ZV9pZCwgZGYgaW4gYWxsX3BsYXRlcy5pdGVtcygpOgogICAgICAgIGZpbGVuYW1lID0gcGxhdGVfaWRfdG9fZmlsZW5hbWUuZ2V0KHBsYXRlX2lkLCBwbGF0ZV9pZCArICIueGxzeCIpCiAgICAgICAgY29sdW1uX2luZm8gPSBwbGF0ZV9jb2x1bW5faW5mby5nZXQocGxhdGVfaWQsIHBhcnNlX2NvbHVtbl9ncm91cF9mcm9tX2ZpbGVuYW1lKGZpbGVuYW1lKSkKICAgICAgICBzY2llbnRpc3QgPSBjb2x1bW5faW5mby5nZXQoInNjaWVudGlzdCIsICIiKQogICAgICAgIHBsYXRlX2lkX3RvX3NjaWVudGlzdFtwbGF0ZV9pZF0gPSBzY2llbnRpc3QKICAgIAogICAgZm9yIHBsYXRlX2lkLCBkZiBpbiBhbGxfcGxhdGVzLml0ZW1zKCk6CiAgICAgICAgZmlsZW5hbWUgPSBwbGF0ZV9pZF90b19maWxlbmFtZS5nZXQocGxhdGVfaWQsIHBsYXRlX2lkICsgIi54bHN4IikKICAgICAgICBzY2llbnRpc3QgPSBwbGF0ZV9pZF90b19zY2llbnRpc3QuZ2V0KHBsYXRlX2lkLCAiIikKICAgICAgICAjIEdldCBhbGwgdW5pcXVlIHdlbGwgSURzIGZyb20gdGhpcyBwbGF0ZQogICAgICAgIHVuaXF1ZV93ZWxscyA9IGRmWyJ3ZWxsIl0udW5pcXVlKCkKICAgICAgICBmb3Igd2VsbF9pZCBpbiB1bmlxdWVfd2VsbHM6CiAgICAgICAgICAgICMgTm9ybWFsaXplIHdlbGwgSUQgZm9yIGNvbnNpc3RlbnQgZHVwbGljYXRlIGRldGVjdGlvbgogICAgICAgICAgICB3ZWxsX2lkX3N0ciA9IG5vcm1hbGl6ZV93ZWxsX2lkKHN0cih3ZWxsX2lkKS5zdHJpcCgpKQogICAgICAgICAgICBrZXkgPSAoc2NpZW50aXN0LCB3ZWxsX2lkX3N0cikKICAgICAgICAgICAgaWYga2V5IG5vdCBpbiBzY2llbnRpc3Rfd2VsbF90b19maWxlczoKICAgICAgICAgICAgICAgIHNjaWVudGlzdF93ZWxsX3RvX2ZpbGVzW2tleV0gPSBbXQogICAgICAgICAgICBpZiBmaWxlbmFtZSBub3QgaW4gc2NpZW50aXN0X3dlbGxfdG9fZmlsZXNba2V5XToKICAgICAgICAgICAgICAgIHNjaWVudGlzdF93ZWxsX3RvX2ZpbGVzW2tleV0uYXBwZW5kKGZpbGVuYW1lKQogICAgCiAgICAjIEdyb3VwIGR1cGxpY2F0ZXMgYnkgZmlsZSBwYWlycyBmb3IgY2xlYW5lciBtZXNzYWdpbmcKICAgICMgT25seSBmbGFnIGlmIHNhbWUgc2NpZW50aXN0IEFORCBzYW1lIHdlbGwgSUQKICAgIGR1cGxpY2F0ZV9jb2x1bW5fd2FybmluZ3MgPSBbXQogICAgZmlsZV9wYWlyc190b19jb2x1bW5zOiBEaWN0W3N0ciwgTGlzdFtpbnRdXSA9IHt9ICAjICJmaWxlMXxmaWxlMiIgLT4gW2NvbHVtbl9udW1iZXJzXQogICAgCiAgICBmb3IgKHNjaWVudGlzdCwgd2VsbF9pZCksIGZpbGVzIGluIHNjaWVudGlzdF93ZWxsX3RvX2ZpbGVzLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGZpbGVzKSA+IDE6CiAgICAgICAgICAgICMgRXh0cmFjdCBjb2x1bW4gbnVtYmVyIGZyb20gd2VsbCBJRCAoZS5nLiwgIkIxMyIgLT4gMTMpCiAgICAgICAgICAgIGltcG9ydCByZQogICAgICAgICAgICBjb2xfbWF0Y2ggPSByZS5tYXRjaChyJ15bQS1aXShcZCspJCcsIHdlbGxfaWQpCiAgICAgICAgICAgIGlmIGNvbF9tYXRjaDoKICAgICAgICAgICAgICAgIGNvbHVtbl9udW0gPSBpbnQoY29sX21hdGNoLmdyb3VwKDEpKQogICAgICAgICAgICAgICAgIyBTb3J0IGZpbGVzIGFscGhhYmV0aWNhbGx5IGZvciBjb25zaXN0ZW50IG9yZGVyaW5nCiAgICAgICAgICAgICAgICBzb3J0ZWRfZmlsZXMgPSBzb3J0ZWQoZmlsZXMpCiAgICAgICAgICAgICAgICBmaWxlX2tleSA9ICJ8Ii5qb2luKHNvcnRlZF9maWxlcykKICAgICAgICAgICAgICAgIGlmIGZpbGVfa2V5IG5vdCBpbiBmaWxlX3BhaXJzX3RvX2NvbHVtbnM6CiAgICAgICAgICAgICAgICAgICAgZmlsZV9wYWlyc190b19jb2x1bW5zW2ZpbGVfa2V5XSA9IFtdCiAgICAgICAgICAgICAgICBpZiBjb2x1bW5fbnVtIG5vdCBpbiBmaWxlX3BhaXJzX3RvX2NvbHVtbnNbZmlsZV9rZXldOgogICAgICAgICAgICAgICAgICAgIGZpbGVfcGFpcnNfdG9fY29sdW1uc1tmaWxlX2tleV0uYXBwZW5kKGNvbHVtbl9udW0pCiAgICAKICAgICMgQnVpbGQgd2FybmluZ3MgZ3JvdXBlZCBieSBmaWxlIHBhaXJzIC0gb25seSBzaG93IGNvbHVtbiBudW1iZXJzCiAgICBmb3IgZmlsZV9rZXksIGNvbHVtbl9udW1iZXJzIGluIGZpbGVfcGFpcnNfdG9fY29sdW1ucy5pdGVtcygpOgogICAgICAgIGZpbGVzID0gZmlsZV9rZXkuc3BsaXQoInwiKQogICAgICAgIHNvcnRlZF9jb2x1bW5zID0gc29ydGVkKGNvbHVtbl9udW1iZXJzKQogICAgICAgIGR1cGxpY2F0ZV9jb2x1bW5fd2FybmluZ3MuYXBwZW5kKHsKICAgICAgICAgICAgImZpbGVzIjogZmlsZXMsCiAgICAgICAgICAgICJjb2x1bW5zIjogc29ydGVkX2NvbHVtbnMgICMgQ2hhbmdlZCBmcm9tIHdlbGxfaWRzIHRvIGNvbHVtbnMKICAgICAgICB9KQogICAgICAgIAogICAgICAgICMgQ29uc29sZSBtZXNzYWdlIC0gb25seSBzaG93IGNvbHVtbiBudW1iZXJzCiAgICAgICAgZmlsZXNfc3RyID0gIiBhbmQgIi5qb2luKGZpbGVzKQogICAgICAgIGNvbHVtbnNfc3RyID0gIiwgIi5qb2luKFtzdHIoYykgZm9yIGMgaW4gc29ydGVkX2NvbHVtbnNbOjEwXV0pICAjIFNob3cgZmlyc3QgMTAKICAgICAgICBpZiBsZW4oc29ydGVkX2NvbHVtbnMpID4gMTA6CiAgICAgICAgICAgIGNvbHVtbnNfc3RyICs9IGYiLCAuLi4gKHtsZW4oc29ydGVkX2NvbHVtbnMpfSB0b3RhbCkiCiAgICAgICAgcHJpbnQoZiIgIOKaoO+4jyAgV0FSTklORzoge2ZpbGVzX3N0cn0gaGF2ZSBkdXBsaWNhdGUgY29sdW1uczoge2NvbHVtbnNfc3RyfSIsIGZsdXNoPVRydWUpCiAgICAgICAgcHJpbnQoZiIgICAgIE9ubHkgZGF0YSBmcm9tICd7ZmlsZXNbMF19JyAoZmlyc3QgYWxwaGFiZXRpY2FsbHkpIGlzIHVzZWQuIiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgZGF0YSA9IHsKICAgICAgICAiY29uZmlnIjogewogICAgICAgICAgICAid2VsbF9sYWJlbHMiOiB3ZWxsX2xhYmVscywKICAgICAgICAgICAgImdyb3VwcyI6IGdyb3VwcywKICAgICAgICAgICAgImNvbHVtbl9ncm91cHMiOiBjb2x1bW5fZ3JvdXBzLAogICAgICAgICAgICAiY29udHJvbF9yb3dzIjogY29udHJvbF9yb3dzLAogICAgICAgICAgICAid2FybmluZ3MiOiB7CiAgICAgICAgICAgICAgICAiZHVwbGljYXRlX2NvbHVtbnMiOiBkdXBsaWNhdGVfY29sdW1uX3dhcm5pbmdzCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJwbGF0ZXMiOiBbXQogICAgfQogICAgCiAgICAjIEJ1aWxkIHBsYXRlcyBsaXN0IGFuZCBzb3J0IGJ5IHNjaWVudGlzdCBpbml0aWFscwogICAgcGxhdGVzX2xpc3QgPSBbXQogICAgZm9yIHBsYXRlX2lkLCBkZiBpbiBhbGxfcGxhdGVzLml0ZW1zKCk6CiAgICAgICAgd2VsbHNfZGljdDogRGljdFtzdHIsIEFueV0gPSB7fQogICAgICAgIGZvciB3ZWxsX2lkLCBnIGluIGRmLmdyb3VwYnkoIndlbGwiKToKICAgICAgICAgICAgIyBOb3JtYWxpemUgd2VsbCBJRCB0byBjb25zaXN0ZW50IGZvcm1hdCAoemVyby1wYWRkZWQpCiAgICAgICAgICAgIG5vcm1hbGl6ZWRfd2VsbF9pZCA9IG5vcm1hbGl6ZV93ZWxsX2lkKHdlbGxfaWQpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNraXAgYmFkIHdlbGxzCiAgICAgICAgICAgIGlmIGlzX2JhZF93ZWxsKG5vcm1hbGl6ZWRfd2VsbF9pZCwgY29uZmlnKToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgICAgICBnX3NvcnRlZCA9IGcuc29ydF92YWx1ZXMoInRpbWVfcyIpCiAgICAgICAgICAgIGNvbnRlbnQgPSBnX3NvcnRlZFsiY29udGVudCJdLmlsb2NbMF0KICAgICAgICAgICAgIyBVc2Ugcm93LWJhc2VkIGxhYmVsIGZyb20gY29uZmlnIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIHVzZSBjb250ZW50CiAgICAgICAgICAgICMgRXh0cmFjdCByb3cgbGV0dGVyIGZyb20gbm9ybWFsaXplZCB3ZWxsX2lkIChlLmcuLCAiQjEzIiAtPiAiQiIpCiAgICAgICAgICAgIHJvd19sZXR0ZXIgPSBub3JtYWxpemVkX3dlbGxfaWRbMF0gaWYgbm9ybWFsaXplZF93ZWxsX2lkIGFuZCBub3JtYWxpemVkX3dlbGxfaWRbMF0uaXNhbHBoYSgpIGVsc2UgIiIKICAgICAgICAgICAgbGFiZWwgPSB3ZWxsX2xhYmVscy5nZXQocm93X2xldHRlciwgY29udGVudCkgaWYgcm93X2xldHRlciBlbHNlIGNvbnRlbnQKICAgICAgICAgICAgd2VsbHNfZGljdFtub3JtYWxpemVkX3dlbGxfaWRdID0gewogICAgICAgICAgICAgICAgImNvbnRlbnQiOiBjb250ZW50LAogICAgICAgICAgICAgICAgImxhYmVsIjogbGFiZWwsCiAgICAgICAgICAgICAgICAidGltZV9zIjogZ19zb3J0ZWRbInRpbWVfcyJdLnRvbGlzdCgpLAogICAgICAgICAgICAgICAgInZhbHVlcyI6IGdfc29ydGVkWyJ2YWx1ZSJdLnRvbGlzdCgpLAogICAgICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZmlsZW5hbWUgPSBwbGF0ZV9pZF90b19maWxlbmFtZS5nZXQocGxhdGVfaWQsIHBsYXRlX2lkICsgIi54bHN4IikKICAgICAgICBjb2x1bW5faW5mbyA9IHBsYXRlX2NvbHVtbl9pbmZvLmdldChwbGF0ZV9pZCwgcGFyc2VfY29sdW1uX2dyb3VwX2Zyb21fZmlsZW5hbWUoZmlsZW5hbWUpKQogICAgICAgIAogICAgICAgIHBsYXRlc19saXN0LmFwcGVuZCgKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgImlkIjogcGxhdGVfaWQsCiAgICAgICAgICAgICAgICAiZmlsZSI6IGZpbGVuYW1lLAogICAgICAgICAgICAgICAgImNvbHVtbl9ncm91cCI6IGNvbHVtbl9pbmZvWyJjb2x1bW5fZ3JvdXAiXSwKICAgICAgICAgICAgICAgICJjb2x1bW5faW5mbyI6IHsKICAgICAgICAgICAgICAgICAgICAicHJvdGVpbiI6IGNvbHVtbl9pbmZvWyJwcm90ZWluIl0sCiAgICAgICAgICAgICAgICAgICAgImdlbm90eXBlIjogY29sdW1uX2luZm9bImdlbm90eXBlIl0sCiAgICAgICAgICAgICAgICAgICAgImJ1ZmZlciI6IGNvbHVtbl9pbmZvWyJidWZmZXIiXSwKICAgICAgICAgICAgICAgICAgICAic2NpZW50aXN0IjogY29sdW1uX2luZm9bInNjaWVudGlzdCJdLAogICAgICAgICAgICAgICAgICAgICJudW1iZXIiOiBjb2x1bW5faW5mb1sibnVtYmVyIl0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAid2VsbHMiOiB3ZWxsc19kaWN0LAogICAgICAgICAgICB9CiAgICAgICAgKQogICAgCiAgICAjIFNvcnQgcGxhdGVzIGJ5IHNjaWVudGlzdCBpbml0aWFscyAoZW1wdHkgc2NpZW50aXN0IGdvZXMgbGFzdCkKICAgIHBsYXRlc19saXN0LnNvcnQoa2V5PWxhbWJkYSBwOiAocFsiY29sdW1uX2luZm8iXVsic2NpZW50aXN0Il0gb3IgInp6eiIsIHBbImZpbGUiXSkpCiAgICBkYXRhWyJwbGF0ZXMiXSA9IHBsYXRlc19saXN0CgogICAgd2l0aCBvcGVuKGpzb25fcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgIGpzb24uZHVtcChkYXRhLCBmLCBpbmRlbnQ9MikKCgpIVE1MX1RFTVBMQVRFID0gciIiIjwhRE9DVFlQRSBodG1sPgo8aHRtbCBsYW5nPSJlbiI+CjxoZWFkPgogIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICA8dGl0bGU+UGxhdGUgVmlld2VyPC90aXRsZT4KICA8c3R5bGU+CiAgICBib2R5IHsKICAgICAgZm9udC1mYW1pbHk6IHN5c3RlbS11aSwgLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCAiU2Vnb2UgVUkiLCBzYW5zLXNlcmlmOwogICAgICBtYXJnaW46IDA7CiAgICAgIHBhZGRpbmc6IDA7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgIGhlaWdodDogMTAwdmg7CiAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICB9CiAgICAjY29udGVudC13cmFwcGVyIHsKICAgICAgZGlzcGxheTogZ3JpZDsKICAgICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAzMjBweCAxZnI7CiAgICAgIGZsZXg6IDE7CiAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB9CiAgICBhc2lkZSB7CiAgICAgIGJvcmRlci1yaWdodDogMXB4IHNvbGlkICNjY2M7CiAgICAgIHBhZGRpbmc6IDE2cHg7CiAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICAgIGJhY2tncm91bmQ6ICNmN2Y3Zjc7CiAgICAgIG92ZXJmbG93LXk6IGF1dG87CiAgICB9CiAgICBtYWluIHsKICAgICAgcGFkZGluZzogMTZweDsKICAgICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgICAgb3ZlcmZsb3c6IGF1dG87CiAgICB9CiAgICBoMSB7CiAgICAgIGZvbnQtc2l6ZTogMS4ycmVtOwogICAgICBtYXJnaW4tdG9wOiAwOwogICAgfQogICAgbGFiZWwgewogICAgICBkaXNwbGF5OiBibG9jazsKICAgICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgICBmb250LXdlaWdodDogNjAwOwogICAgfQogICAgc2VsZWN0IHsKICAgICAgd2lkdGg6IDEwMCUlOwogICAgICBwYWRkaW5nOiA4cHg7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7CiAgICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgIGZvbnQtc2l6ZTogMC45cmVtOwogICAgICBtYXJnaW4tYm90dG9tOiAxNnB4OwogICAgfQogICAgLmRhdGFzZXQtbGluZS1pdGVtIHsKICAgICAgcGFkZGluZzogOHB4IDEycHg7CiAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkICNlZWU7CiAgICAgIGZvbnQtc2l6ZTogMC45cmVtOwogICAgICB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kLWNvbG9yIDAuMTVzIGVhc2U7CiAgICAgIHVzZXItc2VsZWN0OiBub25lOwogICAgfQogICAgLmRhdGFzZXQtbGluZS1pdGVtOmhvdmVyIHsKICAgICAgYmFja2dyb3VuZC1jb2xvcjogI2YwZjBmMDsKICAgIH0KICAgIC5kYXRhc2V0LWxpbmUtaXRlbS5zZWxlY3RlZCB7CiAgICAgIGJhY2tncm91bmQtY29sb3I6ICNlNGYwZmY7CiAgICAgIGJvcmRlci1sZWZ0OiAzcHggc29saWQgIzJhNmNmZjsKICAgICAgZm9udC13ZWlnaHQ6IDUwMDsKICAgIH0KICAgIC5kYXRhc2V0LWxpbmUtaXRlbTpsYXN0LWNoaWxkIHsKICAgICAgYm9yZGVyLWJvdHRvbTogbm9uZTsKICAgIH0KICAgICN3ZWxsLWluZm8gewogICAgICBtYXJnaW4tdG9wOiA4cHg7CiAgICAgIGZvbnQtc2l6ZTogMC45cmVtOwogICAgICBwYWRkaW5nOiA4cHg7CiAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7CiAgICB9CiAgICAjcGxhdGUtZ3JpZCB7CiAgICAgIGRpc3BsYXk6IGdyaWQ7CiAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogYXV0byByZXBlYXQoJShjb2xzKWQsIDFmcik7CiAgICAgIGdyaWQtYXV0by1yb3dzOiAzMnB4OwogICAgICBnYXA6IDJweDsKICAgICAgZm9udC1zaXplOiAxMXB4OwogICAgICBtYXJnaW4tYm90dG9tOiAxNnB4OwogICAgfQogICAgLmdyaWQtaGVhZGVyIHsKICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgfQogICAgLnJvdy1sYWJlbCwgLmNvbC1sYWJlbCB7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgfQogICAgLndlbGwgewogICAgICBib3JkZXI6IDFweCBzb2xpZCAjZGRkOwogICAgICBib3JkZXItcmFkaXVzOiAzcHg7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgIGJhY2tncm91bmQ6ICNmZmY7CiAgICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgICAgZm9udC1zaXplOiAxMHB4OwogICAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgICAgei1pbmRleDogMTsKICAgIH0KICAgIC53ZWxsW2RhdGEtaGFzLWRhdGE9InRydWUiXTpub3QoLnRyaXBsaWNhdGUtZ3JvdXApOm5vdCguY29udHJvbCkgewogICAgICBiYWNrZ3JvdW5kOiAjZTRmMGZmOwogICAgICBib3JkZXItY29sb3I6ICM2YzljZmY7CiAgICB9CiAgICAud2VsbC5zZWxlY3RlZCB7CiAgICAgIG91dGxpbmU6IDJweCBzb2xpZCAjMmE2Y2ZmOwogICAgICBvdXRsaW5lLW9mZnNldDogLTJweDsKICAgICAgYmFja2dyb3VuZDogI2U0ZjBmZjsKICAgIH0KICAgIC53ZWxsLnJlcGxpY2F0ZSB7CiAgICAgIGJvcmRlci1zdHlsZTogZGFzaGVkOwogICAgfQogICAgLndlbGwudHJpcGxpY2F0ZS1ncm91cCB7CiAgICAgIC8qIEJvcmRlcnMgYXJlIGFkZGVkIHZpYSBpbmxpbmUgc3R5bGVzIG9ubHkgd2hlbiBzZWxlY3RlZCAqLwogICAgfQogICAgLyogSW5kaXZpZHVhbCBjb2xvcnMgd2lsbCBiZSBhcHBsaWVkIHZpYSBpbmxpbmUgc3R5bGVzICovCiAgICAud2VsbC5jb250cm9sIHsKICAgICAgYmFja2dyb3VuZDogI2U4ZjVlOTsKICAgICAgYm9yZGVyOiAxcHggc29saWQgI2RkZDsKICAgIH0KICAgIC53ZWxsLmNvbnRyb2xbZGF0YS1oYXMtZGF0YT0idHJ1ZSJdIHsKICAgICAgYmFja2dyb3VuZDogI2M4ZTZjOTsKICAgICAgYm9yZGVyLWNvbG9yOiAjNmM5Y2ZmOwogICAgfQogICAgLndlbGwuY29udHJvbC5zZWxlY3RlZCB7CiAgICAgIGJhY2tncm91bmQ6ICNjOGU2Yzk7CiAgICAgIG91dGxpbmU6IDJweCBzb2xpZCAjMmE2Y2ZmOwogICAgICBvdXRsaW5lLW9mZnNldDogLTJweDsKICAgIH0KICAgIC53ZWxsLWxhYmVsIHsKICAgICAgZm9udC1zaXplOiA4cHg7CiAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgYm90dG9tOiAxcHg7CiAgICAgIGxlZnQ6IDFweDsKICAgICAgcmlnaHQ6IDFweDsKICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICB0ZXh0LW92ZXJmbG93OiBlbGxpcHNpczsKICAgICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgIHotaW5kZXg6IDI7CiAgICB9CiAgICAjY2hhcnQtY29udGFpbmVyIHsKICAgICAgbWFyZ2luLXRvcDogMTJweDsKICAgICAgaGVpZ2h0OiA4MDBweDsKICAgICAgbWluLWhlaWdodDogODAwcHg7CiAgICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIH0KICAgIGNhbnZhcyB7CiAgICAgIG1heC13aWR0aDogMTAwJSU7CiAgICAgIGhlaWdodDogODAwcHggIWltcG9ydGFudDsKICAgIH0KICAgIC5idG4gewogICAgICBwYWRkaW5nOiA2cHggMTJweDsKICAgICAgbWFyZ2luOiA0cHggMDsKICAgICAgYm9yZGVyOiAxcHggc29saWQgI2NjYzsKICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICBmb250LXNpemU6IDAuOXJlbTsKICAgIH0KICAgIC5idG46aG92ZXIgewogICAgICBiYWNrZ3JvdW5kOiAjZjBmMGYwOwogICAgfQogICAgLmJ0bi1wcmltYXJ5IHsKICAgICAgYmFja2dyb3VuZDogIzJhNmNmZjsKICAgICAgY29sb3I6IHdoaXRlOwogICAgICBib3JkZXItY29sb3I6ICMyYTZjZmY7CiAgICB9CiAgICAuYnRuLXByaW1hcnk6aG92ZXIgewogICAgICBiYWNrZ3JvdW5kOiAjMWE1Y2ZmOwogICAgfQogICAgI3dhcm5pbmctYmFubmVyIHsKICAgICAgYmFja2dyb3VuZDogI2ZmZjNjZDsKICAgICAgYm9yZGVyOiAycHggc29saWQgI2ZmYzEwNzsKICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICBwYWRkaW5nOiAxMnB4IDE2cHg7CiAgICAgIG1hcmdpbjogMTZweDsKICAgICAgbWFyZ2luLWJvdHRvbTogMDsKICAgICAgZm9udC1zaXplOiAwLjlyZW07CiAgICAgIGNvbG9yOiAjODU2NDA0OwogICAgICBkaXNwbGF5OiBub25lOwogICAgfQogICAgI3dhcm5pbmctYmFubmVyLnNob3cgewogICAgICBkaXNwbGF5OiBibG9jazsKICAgIH0KICAgICN3YXJuaW5nLWJhbm5lciBoMyB7CiAgICAgIG1hcmdpbjogMCAwIDhweCAwOwogICAgICBmb250LXNpemU6IDFyZW07CiAgICAgIGNvbG9yOiAjODU2NDA0OwogICAgfQogICAgI3dhcm5pbmctYmFubmVyIHVsIHsKICAgICAgbWFyZ2luOiA4cHggMCAwIDA7CiAgICAgIHBhZGRpbmctbGVmdDogMjBweDsKICAgIH0KICAgICN3YXJuaW5nLWJhbm5lciBsaSB7CiAgICAgIG1hcmdpbjogNHB4IDA7CiAgICB9CiAgICBpbnB1dFt0eXBlPSJjaGVja2JveCJdOmRpc2FibGVkIHsKICAgICAgb3BhY2l0eTogMC41OwogICAgICBjdXJzb3I6IG5vdC1hbGxvd2VkICFpbXBvcnRhbnQ7CiAgICB9CiAgICBpbnB1dFt0eXBlPSJjaGVja2JveCJdOmRpc2FibGVkICsgc3BhbiB7CiAgICAgIG9wYWNpdHk6IDAuNjsKICAgICAgY29sb3I6ICM5OTk7CiAgICB9CiAgPC9zdHlsZT4KICA8IS0tIENoYXJ0LmpzIHZpYSBDRE4gLS0+CiAgPHNjcmlwdCBzcmM9Imh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vY2hhcnQuanMiPjwvc2NyaXB0Pgo8L2hlYWQ+Cjxib2R5PgogIDxkaXYgaWQ9Indhcm5pbmctYmFubmVyIj48L2Rpdj4KICA8ZGl2IGlkPSJjb250ZW50LXdyYXBwZXIiPgogIDxhc2lkZT4KICAgIDxoMT5QbGF0ZSBWaWV3ZXI8L2gxPgogICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZ2FwOiA2cHg7IG1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICA8bGFiZWwgc3R5bGU9Im1hcmdpbjogMDsiPlNlbGVjdCBEYXRhc2V0IEdyb3Vwczo8L2xhYmVsPgogICAgICA8ZGl2IHN0eWxlPSJwb3NpdGlvbjogcmVsYXRpdmU7IGRpc3BsYXk6IGlubGluZS1ibG9jazsiPgogICAgICAgIDxzcGFuIHN0eWxlPSJjdXJzb3I6IGhlbHA7IGNvbG9yOiAjNjY2OyBmb250LXNpemU6IDAuOXJlbTsgZm9udC13ZWlnaHQ6IG5vcm1hbDsgdXNlci1zZWxlY3Q6IG5vbmU7IiAKICAgICAgICAgICAgICBpZD0iZGF0YXNldC1zZWxlY3QtaGVscCIgCiAgICAgICAgICAgICAgdGl0bGU9IkNsaWNrOiBTZWxlY3Qgc2luZ2xlIGl0ZW0mIzEwO1NoaWZ0K0NsaWNrOiBTZWxlY3QgcmFuZ2UmIzEwO0N0cmwvQ21kK0NsaWNrOiBUb2dnbGUgaXRlbSI+CiAgICAgICAgICDik5gKICAgICAgICA8L3NwYW4+CiAgICAgICAgPGRpdiBpZD0iZGF0YXNldC1zZWxlY3QtdG9vbHRpcCIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7IHBvc2l0aW9uOiBhYnNvbHV0ZTsgYm90dG9tOiAxMDAlJTsgbGVmdDogNTAlJTsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUlKTsgbWFyZ2luLWJvdHRvbTogOHB4OyBiYWNrZ3JvdW5kOiAjMzMzOyBjb2xvcjogd2hpdGU7IHBhZGRpbmc6IDEwcHggMTJweDsgYm9yZGVyLXJhZGl1czogNnB4OyBmb250LXNpemU6IDAuOHJlbTsgd2hpdGUtc3BhY2U6IG5vd3JhcDsgei1pbmRleDogMTAwMDsgYm94LXNoYWRvdzogMCAycHggOHB4IHJnYmEoMCwwLDAsMC4yKTsgcG9pbnRlci1ldmVudHM6IG5vbmU7Ij4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDRweDsiPjxzdHJvbmc+Q2xpY2s6PC9zdHJvbmc+IFNlbGVjdCBzaW5nbGUgaXRlbTwvZGl2PgogICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogNHB4OyI+PHN0cm9uZz5TaGlmdCtDbGljazo8L3N0cm9uZz4gU2VsZWN0IHJhbmdlPC9kaXY+CiAgICAgICAgICA8ZGl2PjxzdHJvbmc+Q3RybC9DbWQrQ2xpY2s6PC9zdHJvbmc+IFRvZ2dsZSBpdGVtPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJwb3NpdGlvbjogYWJzb2x1dGU7IGJvdHRvbTogLTZweDsgbGVmdDogNTAlJTsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUlKTsgd2lkdGg6IDA7IGhlaWdodDogMDsgYm9yZGVyLWxlZnQ6IDZweCBzb2xpZCB0cmFuc3BhcmVudDsgYm9yZGVyLXJpZ2h0OiA2cHggc29saWQgdHJhbnNwYXJlbnQ7IGJvcmRlci10b3A6IDZweCBzb2xpZCAjMzMzOyI+PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IGlkPSJkYXRhc2V0LXNlbGVjdCIgc3R5bGU9Im1heC1oZWlnaHQ6IDIwMHB4OyBtaW4taGVpZ2h0OiA2MHB4OyBvdmVyZmxvdy15OiBhdXRvOyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiA0cHg7IGJhY2tncm91bmQ6IHdoaXRlOyBtYXJnaW4tYm90dG9tOiAxNnB4OyI+CiAgICAgIDxkaXYgc3R5bGU9InBhZGRpbmc6IDEycHg7IGNvbG9yOiAjNjY2OyBmb250LXNpemU6IDAuODVyZW07IHRleHQtYWxpZ246IGNlbnRlcjsiPkxvYWRpbmcgZGF0YXNldHMuLi48L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBpZD0iY29sdW1uLWxlZ2VuZCIgc3R5bGU9Im1hcmdpbi10b3A6IDE2cHg7IHBhZGRpbmc6IDEycHg7IGJhY2tncm91bmQ6IHdoaXRlOyBib3JkZXItcmFkaXVzOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGZvbnQtc2l6ZTogMC44NXJlbTsiPgogICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7Ij5TZWxlY3QgRGF0YXNldHMgYnkgQ29sdW1uPC9kaXY+CiAgICAgIDxkaXYgaWQ9ImNvbHVtbi1sZWdlbmQtY29udGVudCIgc3R5bGU9ImZvbnQtc2l6ZTogMC44cmVtOyBjb2xvcjogIzY2NjsiPk5vIGNvbHVtbiBpbmZvcm1hdGlvbiBhdmFpbGFibGUuPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgaWQ9IndlbGwtc2VsZWN0b3IiIHN0eWxlPSJtYXJnaW4tdG9wOiAxNnB4OyBwYWRkaW5nOiAxMnB4OyBiYWNrZ3JvdW5kOiB3aGl0ZTsgYm9yZGVyLXJhZGl1czogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyI+CiAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGN1cnNvcjogcG9pbnRlcjsgZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyIgb25jbGljaz0idG9nZ2xlV2VsbFNlbGVjdG9yKCkiPgogICAgICAgIDxzcGFuIGlkPSJ3ZWxsLXNlbGVjdG9yLWFycm93IiBzdHlsZT0ibWFyZ2luLXJpZ2h0OiA4cHg7Ij7ilrw8L3NwYW4+CiAgICAgICAgPHNwYW4+U2VsZWN0IFdlbGxzIChjbGljayB0byBleGNsdWRlKTwvc3Bhbj4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgaWQ9IndlbGwtc2VsZWN0b3ItZ3JpZC1jb250YWluZXIiIHN0eWxlPSJkaXNwbGF5OiBub25lOyI+CiAgICAgICAgPGRpdiBpZD0id2VsbC1zZWxlY3Rvci1ncmlkIiBzdHlsZT0iZGlzcGxheTogZ3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiBhdXRvIHJlcGVhdCgyNCwgMWZyKTsgZ3JpZC1hdXRvLXJvd3M6IDE4cHg7IGdhcDogMXB4OyBmb250LXNpemU6IDhweDsgbWFyZ2luLXRvcDogOHB4OyI+PC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLXRvcDogMTZweDsgdGV4dC1hbGlnbjogY2VudGVyOyI+CiAgICAgICAgICBDbGljayB3ZWxscyB0byBleGNsdWRlIHRoZW0gKOKclSA9IGV4Y2x1ZGVkKQogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBzdHlsZT0ibWFyZ2luLXRvcDogMTZweDsgcGFkZGluZzogMTJweDsgYmFja2dyb3VuZDogd2hpdGU7IGJvcmRlci1yYWRpdXM6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsiPgogICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7IGZvbnQtc2l6ZTogMC45NXJlbTsgY29sb3I6ICMzMzM7Ij5EYXRhIFByb2Nlc3NpbmcgV29ya2Zsb3c8L2Rpdj4KICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLWJvdHRvbTogMTJweDsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZjlmOWY5OyBib3JkZXItcmFkaXVzOiAzcHg7Ij4KICAgICAgICA8c3Ryb25nPlN0ZXAgMTo8L3N0cm9uZz4gTm9ybWFsaXplIHVzaW5nIGZpdHRlZCBiYXNlbGluZSAoaWYgZW5hYmxlZCk8YnI+CiAgICAgICAgPHN0cm9uZz5TdGVwIDI6PC9zdHJvbmc+IEdyb3VwIHdlbGxzIGludG8gdHJpcGxpY2F0ZSBncm91cHMgKGlmIGVuYWJsZWQpPGJyPgogICAgICAgIDxzdHJvbmc+U3RlcCAzOjwvc3Ryb25nPiBDdXRvZmYgZGF0YSBwb2ludHMgYmVmb3JlIGZpcnN0IHRpbWVwb2ludCBhbmQgYWZ0ZXIgdGltZSBwb2ludCAoaWYgZW5hYmxlZCk8YnI+CiAgICAgICAgPHN0cm9uZz5TdGVwIDQ6PC9zdHJvbmc+IEZpdCByZWdyZXNzaW9uIGN1cnZlIHRvIGRhdGEgcG9pbnRzIChpZiBlbmFibGVkKQogICAgICA8L2Rpdj4KICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBjdXJzb3I6IHBvaW50ZXI7IGZvbnQtc2l6ZTogMC45cmVtOyI+CiAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0ibm9ybWFsaXplLWJhc2VsaW5lLXRvZ2dsZSIgc3R5bGU9Im1hcmdpbi1yaWdodDogOHB4OyBjdXJzb3I6IHBvaW50ZXI7IiBvbmNoYW5nZT0idXBkYXRlQ2hhcnQoKTsiPgogICAgICAgIDxzcGFuPjxzdHJvbmc+U3RlcCAxOjwvc3Ryb25nPiBOb3JtYWxpemUgdXNpbmcgZml0dGVkIGJhc2VsaW5lPC9zcGFuPgogICAgICA8L2xhYmVsPgogICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiA0cHg7IG1hcmdpbi1ib3R0b206IDhweDsgbWFyZ2luLWxlZnQ6IDI0cHg7Ij4KICAgICAgICBGaXQgYSBiYXNlbGluZSBmdW5jdGlvbiAoTE9XRVNTLCBjb25zdGFudCwgb3IgcG9seW5vbWlhbCkgb24gdGhlIGJhc2VsaW5lIHdpbmRvdyBhbmQgbm9ybWFsaXplIGVhY2ggd2VsbCB1c2luZyB0aGUgZml0dGVkIGJhc2VsaW5lLiBTZWxlY3QgbWV0aG9kIGFuZCBwYXJhbWV0ZXJzIGluIHRoZSAiQmFzZWxpbmUgRml0dGluZyAmIE5vcm1hbGl6YXRpb24gT3B0aW9ucyIgc2VjdGlvbiBiZWxvdy4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgaWQ9Im5vcm1hbGl6ZS1iYXNlbGluZS1wYXJhbWV0ZXJzIiBzdHlsZT0iZm9udC1zaXplOiAwLjhyZW07IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyBkaXNwbGF5OiBub25lOyBtYXJnaW4tbGVmdDogMjRweDsgbWFyZ2luLWJvdHRvbTogOHB4OyI+CiAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogOHB4OyI+CiAgICAgICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICA8c3BhbiBzdHlsZT0ibWluLXdpZHRoOiAxMjBweDsiPkJhc2VsaW5lIHdpbmRvdyBlbmQgKHMpOjwvc3Bhbj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9Im51bWJlciIgaWQ9Im5vcm1hbGl6ZS1iYXNlbGluZS1lbmQtdGltZSIgdmFsdWU9IjI0IiBtaW49IjAiIHN0ZXA9IjAuMSIgc3R5bGU9IndpZHRoOiA4MHB4OyBwYWRkaW5nOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsiIG9uY2hhbmdlPSJ1cGRhdGVDaGFydCgpOyI+CiAgICAgICAgICA8L2xhYmVsPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDRweDsiPgogICAgICAgICAgQmFzZWxpbmUgZml0dGluZyBtZXRob2QgYW5kIG5vcm1hbGl6YXRpb24gbW9kZSBhcmUgc2VsZWN0ZWQgaW4gdGhlICJCYXNlbGluZSBGaXR0aW5nICYgTm9ybWFsaXphdGlvbiBPcHRpb25zIiBzZWN0aW9uIGJlbG93LgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgaWQ9ImN1cnJlbnQtc2V0dGluZ3MtZGlzcGxheSIgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICMzMzM7IG1hcmdpbi10b3A6IDhweDsgcGFkZGluZzogNnB4OyBiYWNrZ3JvdW5kOiAjZjBmMGYwOyBib3JkZXItcmFkaXVzOiAzcHg7IGJvcmRlci1sZWZ0OiAzcHggc29saWQgIzJhNmNmZjsiPgogICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogNHB4OyBjb2xvcjogIzJhNmNmZjsiPkN1cnJlbnQgU2V0dGluZ3M6PC9kaXY+CiAgICAgICAgICA8ZGl2IGlkPSJjdXJyZW50LXNldHRpbmdzLWNvbnRlbnQiIHN0eWxlPSJmb250LXNpemU6IDAuN3JlbTsgY29sb3I6ICM2NjY7Ij4KICAgICAgICAgICAgQmFzZWxpbmU6IDxzcGFuIGlkPSJjdXJyZW50LWJhc2VsaW5lLW1ldGhvZCI+Q29uc3RhbnQ8L3NwYW4+IHwgTm9ybWFsaXphdGlvbjogPHNwYW4gaWQ9ImN1cnJlbnQtbm9ybWFsaXphdGlvbi1tb2RlIj5NdWx0aXBsaWNhdGl2ZTwvc3Bhbj4gfCBDdXJ2ZSBGaXQ6IDxzcGFuIGlkPSJjdXJyZW50LXJlZ3Jlc3Npb24tdHlwZSI+TW9uby1leHBvbmVudGlhbCBwbGF0ZWF1PC9zcGFuPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGN1cnNvcjogcG9pbnRlcjsgZm9udC1zaXplOiAwLjlyZW07IG1hcmdpbi10b3A6IDEycHg7Ij4KICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJncm91cC10cmlwbGljYXRlcy10b2dnbGUiIHN0eWxlPSJtYXJnaW4tcmlnaHQ6IDhweDsgY3Vyc29yOiBwb2ludGVyOyIgb25jaGFuZ2U9InVwZGF0ZUNoYXJ0KCk7Ij4KICAgICAgICA8c3Bhbj48c3Ryb25nPlN0ZXAgMjo8L3N0cm9uZz4gR3JvdXAgd2VsbHMgaW50byB0cmlwbGljYXRlIGdyb3Vwczwvc3Bhbj4KICAgICAgPC9sYWJlbD4KICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLXRvcDogNHB4OyBtYXJnaW4tbGVmdDogMjRweDsiPgogICAgICAgIFdoZW4gZW5hYmxlZCwgd2VsbHMgdGhhdCBhcmUgcGFydCBvZiB0cmlwbGljYXRlIGdyb3VwcyAoZS5nLiwgcm93cyBCLCBDLCBEKSBhcmUgZ3JvdXBlZCB0b2dldGhlci4gV2hlbiBkaXNhYmxlZCwgZWFjaCB3ZWxsIGlzIHNob3duIGluZGl2aWR1YWxseS4gPHN0cm9uZz5Ob3RlOjwvc3Ryb25nPiBSZXF1aXJlcyBTdGVwIDEgKG5vcm1hbGl6YXRpb24pIHRvIGJlIGVuYWJsZWQuCiAgICAgIDwvZGl2PgogICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGN1cnNvcjogcG9pbnRlcjsgZm9udC1zaXplOiAwLjlyZW07IG1hcmdpbi10b3A6IDEycHg7Ij4KICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJjdXRvZmYtYmFzZWxpbmUtdG9nZ2xlIiBzdHlsZT0ibWFyZ2luLXJpZ2h0OiA4cHg7IGN1cnNvcjogcG9pbnRlcjsiIG9uY2hhbmdlPSJ1cGRhdGVDaGFydCgpOyI+CiAgICAgICAgPHNwYW4+PHN0cm9uZz5TdGVwIDM6PC9zdHJvbmc+IEN1dG9mZiBkYXRhIHBvaW50cyBiZWZvcmUgZmlyc3QgdGltZXBvaW50IGFuZCBhZnRlciB0aW1lIHBvaW50PC9zcGFuPgogICAgICA8L2xhYmVsPgogICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiA0cHg7IG1hcmdpbi1sZWZ0OiAyNHB4OyI+CiAgICAgICAgV2hlbiBlbmFibGVkLCBkYXRhIHBvaW50cyBiZWZvcmUgdGhlIGZpcnN0IHJlYWwgdGltZXBvaW50IGFuZCBhZnRlciB0aGUgY3V0b2ZmIHRpbWUgd2lsbCBiZSBleGNsdWRlZCBmcm9tIHRoZSBncmFwaCBkaXNwbGF5LgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0iY3V0b2ZmLWJhc2VsaW5lLXBhcmFtZXRlcnMiIHN0eWxlPSJmb250LXNpemU6IDAuOHJlbTsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZjlmOWY5OyBib3JkZXItcmFkaXVzOiAzcHg7IGRpc3BsYXk6IG5vbmU7IG1hcmdpbi1sZWZ0OiAyNHB4OyBtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDEyMHB4OyI+Q3V0b2ZmIHRpbWUgKHMpOjwvc3Bhbj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9Im51bWJlciIgaWQ9ImN1dG9mZi1iYXNlbGluZS10aW1lIiB2YWx1ZT0iMzYwIiBtaW49IjAiIHN0ZXA9IjEiIHN0eWxlPSJ3aWR0aDogODBweDsgcGFkZGluZzogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7IiBvbmNoYW5nZT0idXBkYXRlQ2hhcnQoKTsiPgogICAgICAgICAgPC9sYWJlbD4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiA0cHg7Ij4KICAgICAgICAgIERhdGEgcG9pbnRzIGJlZm9yZSB0aGUgZmlyc3QgcmVhbCB0aW1lcG9pbnQgYW5kIGFmdGVyIHRoaXMgdGltZSB3aWxsIGJlIGV4Y2x1ZGVkIChkZWZhdWx0OiA2IG1pbnV0ZXMgPSAzNjAgc2Vjb25kcykuCiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGN1cnNvcjogcG9pbnRlcjsgZm9udC1zaXplOiAwLjlyZW07IG1hcmdpbi10b3A6IDEycHg7Ij4KICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJmaXQtcmVncmVzc2lvbi10b2dnbGUiIHN0eWxlPSJtYXJnaW4tcmlnaHQ6IDhweDsgY3Vyc29yOiBwb2ludGVyOyIgb25jaGFuZ2U9InVwZGF0ZVJlZ3Jlc3Npb25UeXBlUGFyYW1zKHRydWUpOyB1cGRhdGVDaGFydCgpOyI+CiAgICAgICAgPHNwYW4+PHN0cm9uZz5TdGVwIDQ6PC9zdHJvbmc+IEZpdCByZWdyZXNzaW9uIGN1cnZlIHRvIGRhdGEgcG9pbnRzPC9zcGFuPgogICAgICA8L2xhYmVsPgogICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiA0cHg7IG1hcmdpbi1sZWZ0OiAyNHB4OyI+CiAgICAgICAgV2hlbiBlbmFibGVkLCBhIHJlZ3Jlc3Npb24gY3VydmUgd2lsbCBiZSBmaXR0ZWQgdG8gdGhlIGRhdGEgcG9pbnRzIGFuZCBkaXNwbGF5ZWQgb24gdGhlIGdyYXBoLgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0iZml0LXJlZ3Jlc3Npb24tcGFyYW1ldGVycyIgc3R5bGU9ImZvbnQtc2l6ZTogMC44cmVtOyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsgZGlzcGxheTogbm9uZTsgbWFyZ2luLWxlZnQ6IDI0cHg7IG1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgPHNwYW4gc3R5bGU9Im1pbi13aWR0aDogMTQwcHg7Ij5SZWdyZXNzaW9uIHR5cGU6PC9zcGFuPgogICAgICAgICAgICA8c2VsZWN0IGlkPSJyZWdyZXNzaW9uLXR5cGUtc2VsZWN0IiBzdHlsZT0iZmxleDogMTsgcGFkZGluZzogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtc2l6ZTogMC44NXJlbTsiIG9uY2hhbmdlPSJ1cGRhdGVSZWdyZXNzaW9uVHlwZVBhcmFtcygpOyI+CiAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibGluZWFyIj5MaW5lYXI8L29wdGlvbj4KICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJwb2x5bm9taWFsIj5Qb2x5bm9taWFsPC9vcHRpb24+CiAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iZXhwb25lbnRpYWwiPkV4cG9uZW50aWFsPC9vcHRpb24+CiAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibG9nYXJpdGhtaWMiPkxvZ2FyaXRobWljPC9vcHRpb24+CiAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibW9uby1leHBvbmVudGlhbCIgc2VsZWN0ZWQ+TW9uby1leHBvbmVudGlhbCAocmlzZSB0byBwbGF0ZWF1KTwvb3B0aW9uPgogICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBpZD0icmVncmVzc2lvbi1wb2x5bm9taWFsLW9yZGVyIiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogOHB4OyBkaXNwbGF5OiBub25lOyI+CiAgICAgICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICA8c3BhbiBzdHlsZT0ibWluLXdpZHRoOiAxNDBweDsiPlBvbHlub21pYWwgb3JkZXI6PC9zcGFuPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBpZD0icG9seW5vbWlhbC1vcmRlci1pbnB1dCIgdmFsdWU9IjIiIG1pbj0iMiIgbWF4PSI1IiBzdGVwPSIxIiBzdHlsZT0id2lkdGg6IDgwcHg7IHBhZGRpbmc6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsgYm9yZGVyLXJhZGl1czogM3B4OyBmb250LWZhbWlseTogbW9ub3NwYWNlOyIgb25jaGFuZ2U9InVwZGF0ZUNoYXJ0KCk7Ij4KICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLXRvcDogNHB4OyI+CiAgICAgICAgICBUaGUgcmVncmVzc2lvbiBjdXJ2ZSB3aWxsIGJlIG92ZXJsYWlkIG9uIHRoZSBkYXRhIHBvaW50cy4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJyZWdyZXNzaW9uLWluZm8tcGFuZWwiIHN0eWxlPSJtYXJnaW4tdG9wOiAxMnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNlOGY0ZmQ7IGJvcmRlci1yYWRpdXM6IDNweDsgYm9yZGVyOiAxcHggc29saWQgIzJhNmNmZjsgZGlzcGxheTogbm9uZTsiPgogICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyBjb2xvcjogIzJhNmNmZjsiPk1vbm8tZXhwb25lbnRpYWwgRml0IFBhcmFtZXRlcnM8L2Rpdj4KICAgICAgICAgIDxkaXYgaWQ9InJlZ3Jlc3Npb24taW5mby1jb250ZW50IiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBmb250LWZhbWlseTogbW9ub3NwYWNlOyI+CiAgICAgICAgICAgIDwhLS0gUGFyYW1ldGVycyB3aWxsIGJlIHBvcHVsYXRlZCBoZXJlIC0tPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tdG9wOiAxNnB4OyBwYWRkaW5nOiAxMnB4OyBiYWNrZ3JvdW5kOiB3aGl0ZTsgYm9yZGVyLXJhZGl1czogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyI+CiAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGN1cnNvcjogcG9pbnRlcjsgZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyBmb250LXNpemU6IDAuOTVyZW07IGNvbG9yOiAjMzMzOyIgb25jbGljaz0idG9nZ2xlQmFzZWxpbmVPcHRpb25zKCkiPgogICAgICAgIDxzcGFuIGlkPSJiYXNlbGluZS1vcHRpb25zLWFycm93IiBzdHlsZT0ibWFyZ2luLXJpZ2h0OiA4cHg7Ij7ilrw8L3NwYW4+CiAgICAgICAgPHNwYW4+QmFzZWxpbmUgRml0dGluZyAmIE5vcm1hbGl6YXRpb24gT3B0aW9uczwvc3Bhbj4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgaWQ9ImJhc2VsaW5lLW9wdGlvbnMtY29udGVudCIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7IGZvbnQtc2l6ZTogMC44cmVtOyI+CiAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTZweDsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZThmNGZkOyBib3JkZXItcmFkaXVzOiAzcHg7IGJvcmRlcjogMXB4IHNvbGlkICMyYTZjZmY7Ij4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsgY29sb3I6ICMyYTZjZmY7Ij5TZWxlY3QgQmFzZWxpbmUgRml0dGluZyBNZXRob2Q8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICAgICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDRweDsgZm9udC1zaXplOiAwLjg1cmVtOyI+CiAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9Im1pbi13aWR0aDogMTQwcHg7Ij5NZXRob2Q6PC9zcGFuPgogICAgICAgICAgICAgIDxzZWxlY3QgaWQ9ImJhc2VsaW5lLW1ldGhvZC1zZWxlY3QiIHN0eWxlPSJmbGV4OiAxOyBwYWRkaW5nOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1zaXplOiAwLjg1cmVtOyIgb25jaGFuZ2U9InVwZGF0ZUJhc2VsaW5lTWV0aG9kUGFyYW1zKCk7Ij4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9Imxvd2VzcyI+TE9XRVNTPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJjb25zdGFudCIgc2VsZWN0ZWQ+Q29uc3RhbnQ8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9InBvbHlub21pYWwiPlBvbHlub21pYWw8L29wdGlvbj4KICAgICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgICAgPC9sYWJlbD4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBpZD0iYmFzZWxpbmUtbG93ZXNzLXBhcmFtcyIgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7IGRpc3BsYXk6IG5vbmU7Ij4KICAgICAgICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBtYXJnaW4tYm90dG9tOiA0cHg7IGZvbnQtc2l6ZTogMC44NXJlbTsiPgogICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDE0MHB4OyI+U21vb3RoaW5nIGZyYWN0aW9uIChmcmFjKTo8L3NwYW4+CiAgICAgICAgICAgICAgPGlucHV0IHR5cGU9Im51bWJlciIgaWQ9ImJhc2VsaW5lLWZyYWMtaW5wdXQiIHZhbHVlPSIwLjUiIG1pbj0iMC4xIiBtYXg9IjEuMCIgc3RlcD0iMC4xIiBzdHlsZT0iZmxleDogMTsgcGFkZGluZzogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7IGZvbnQtc2l6ZTogMC44NXJlbTsiPgogICAgICAgICAgICA8L2xhYmVsPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tbGVmdDogMTQwcHg7IG1hcmdpbi10b3A6IDJweDsiPgogICAgICAgICAgICAgIEhpZ2hlciA9IHNtb290aGVyICgwLjctMC45KSwgTG93ZXIgPSBtb3JlIGxvY2FsICgwLjItMC40KQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBpZD0iYmFzZWxpbmUtcG9seW5vbWlhbC1wYXJhbXMiIHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyBkaXNwbGF5OiBub25lOyI+CiAgICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNHB4OyBmb250LXNpemU6IDAuODVyZW07Ij4KICAgICAgICAgICAgICA8c3BhbiBzdHlsZT0ibWluLXdpZHRoOiAxNDBweDsiPlBvbHlub21pYWwgb3JkZXI6PC9zcGFuPgogICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIGlkPSJiYXNlbGluZS1wb2x5LW9yZGVyLWlucHV0IiB2YWx1ZT0iMSIgbWluPSIxIiBtYXg9IjUiIHN0ZXA9IjEiIHN0eWxlPSJmbGV4OiAxOyBwYWRkaW5nOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsgZm9udC1zaXplOiAwLjg1cmVtOyI+CiAgICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi1sZWZ0OiAxNDBweDsgbWFyZ2luLXRvcDogMnB4OyI+CiAgICAgICAgICAgICAgMSA9IGxpbmVhciwgMiA9IHF1YWRyYXRpYywgMysgPSBoaWdoZXIgb3JkZXIKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNlOGY0ZmQ7IGJvcmRlci1yYWRpdXM6IDNweDsgYm9yZGVyOiAxcHggc29saWQgIzJhNmNmZjsiPgogICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyBjb2xvcjogIzJhNmNmZjsiPlNlbGVjdCBOb3JtYWxpemF0aW9uIE1ldGhvZDwvZGl2PgogICAgICAgICAgPGRpdj4KICAgICAgICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBtYXJnaW4tYm90dG9tOiA0cHg7IGZvbnQtc2l6ZTogMC44NXJlbTsiPgogICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDE0MHB4OyI+Tm9ybWFsaXphdGlvbiBtb2RlOjwvc3Bhbj4KICAgICAgICAgICAgICA8c2VsZWN0IGlkPSJub3JtYWxpemF0aW9uLW1vZGUtc2VsZWN0IiBzdHlsZT0iZmxleDogMTsgcGFkZGluZzogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtc2l6ZTogMC44NXJlbTsiIG9uY2hhbmdlPSJ1cGRhdGVDdXJyZW50U2V0dGluZ3NEaXNwbGF5KCk7Ij4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9ImRlbHRhX2Zfb3Zlcl9mIj7OlEYvRiAoRGVsdGEgRiBvdmVyIEYpPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJtdWx0aXBsaWNhdGl2ZSIgc2VsZWN0ZWQ+TXVsdGlwbGljYXRpdmU8L29wdGlvbj4KICAgICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgICAgPC9sYWJlbD4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE2cHg7Ij4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsgY29sb3I6ICMyYTZjZmY7Ij5CYXNlbGluZSBGaXR0aW5nIE1ldGhvZHM8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDRweDsiPjEuIExPV0VTUyAoTG9jYWxseSBXZWlnaHRlZCBTY2F0dGVycGxvdCBTbW9vdGhpbmcpPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkZvcm11bGE6PC9zdHJvbmc+IGcodCkgPSBMT1dFU1MoRl9iYXNlbGluZSwgdF9iYXNlbGluZSwgZnJhYykKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPldoZW4gdG8gdXNlOjwvc3Ryb25nPiBCYXNlbGluZSBoYXMgZ3JhZHVhbCBkcmlmdCBvciBub24tbGluZWFyIHRyZW5kcwogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+QmVzdCBmb3I6PC9zdHJvbmc+IE5vbi1saW5lYXIgYmFzZWxpbmVzIHdpdGggc21vb3RoIHRyZW5kcwogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+UGFyYW1ldGVyczo8L3N0cm9uZz4KICAgICAgICAgICAgICA8dWwgc3R5bGU9Im1hcmdpbjogNHB4IDAgMCAyMHB4OyBwYWRkaW5nLWxlZnQ6IDA7Ij4KICAgICAgICAgICAgICAgIDxsaT48c3Ryb25nPmZyYWM6PC9zdHJvbmc+IEZyYWN0aW9uIG9mIGRhdGEgdXNlZCBmb3Igc21vb3RoaW5nIChkZWZhdWx0OiAwLjUpCiAgICAgICAgICAgICAgICAgIDx1bCBzdHlsZT0ibWFyZ2luOiAycHggMCAwIDIwcHg7IHBhZGRpbmctbGVmdDogMDsiPgogICAgICAgICAgICAgICAgICAgIDxsaT5IaWdoZXIgZnJhYyAoMC43LTAuOSkgPSBzbW9vdGhlciwgbW9yZSBnbG9iYWwgZml0PC9saT4KICAgICAgICAgICAgICAgICAgICA8bGk+TG93ZXIgZnJhYyAoMC4yLTAuNCkgPSBtb3JlIGxvY2FsLCBmb2xsb3dzIGRhdGEgY2xvc2VseTwvbGk+CiAgICAgICAgICAgICAgICAgIDwvdWw+CiAgICAgICAgICAgICAgICA8L2xpPgogICAgICAgICAgICAgIDwvdWw+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxMnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4yLiBDT05TVEFOVCAoMHRoLW9yZGVyIHBvbHlub21pYWwpPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkZvcm11bGE6PC9zdHJvbmc+IGcodCkgPSBtZWFuKEZfYmFzZWxpbmUpIGZvciBhbGwgdAogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+V2hlbiB0byB1c2U6PC9zdHJvbmc+IEJhc2VsaW5lIGlzIHN0YWJsZS9mbGF0IHdpdGggbWluaW1hbCBkcmlmdAogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+QmVzdCBmb3I6PC9zdHJvbmc+IFN0YWJsZSBiYXNlbGluZXMgd2l0aCBubyB0aW1lLWRlcGVuZGVudCB0cmVuZHMKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5QYXJhbWV0ZXJzOjwvc3Ryb25nPiBOb25lCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxMnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4zLiBQT0xZTk9NSUFMICgxc3Qtb3JkZXIgb3IgaGlnaGVyKTwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5Gb3JtdWxhOjwvc3Ryb25nPiBnKHQpID0gY+KCgCArIGPigoF0ICsgY+KCgnTCsiArIC4uLgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+V2hlbiB0byB1c2U6PC9zdHJvbmc+IEJhc2VsaW5lIGhhcyBsaW5lYXIgb3IgcG9seW5vbWlhbCBkcmlmdAogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+QmVzdCBmb3I6PC9zdHJvbmc+IEJhc2VsaW5lcyB3aXRoIGtub3duIHBvbHlub21pYWwgdHJlbmRzCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5QYXJhbWV0ZXJzOjwvc3Ryb25nPgogICAgICAgICAgICAgIDx1bCBzdHlsZT0ibWFyZ2luOiA0cHggMCAwIDIwcHg7IHBhZGRpbmctbGVmdDogMDsiPgogICAgICAgICAgICAgICAgPGxpPjxzdHJvbmc+cG9seV9vcmRlcjo8L3N0cm9uZz4gUG9seW5vbWlhbCBvcmRlciAoZGVmYXVsdDogMSA9IGxpbmVhcikKICAgICAgICAgICAgICAgICAgPHVsIHN0eWxlPSJtYXJnaW46IDJweCAwIDAgMjBweDsgcGFkZGluZy1sZWZ0OiAwOyI+CiAgICAgICAgICAgICAgICAgICAgPGxpPk9yZGVyIDE6IExpbmVhciBkcmlmdCAoZyh0KSA9IGPigoAgKyBj4oKBdCk8L2xpPgogICAgICAgICAgICAgICAgICAgIDxsaT5PcmRlciAyOiBRdWFkcmF0aWMgZHJpZnQgKGcodCkgPSBj4oKAICsgY+KCgXQgKyBj4oKCdMKyKTwvbGk+CiAgICAgICAgICAgICAgICAgICAgPGxpPkhpZ2hlciBvcmRlcnM6IE1vcmUgY29tcGxleCB0cmVuZHM8L2xpPgogICAgICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICAgICAgPC9saT4KICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE2cHg7Ij4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsgY29sb3I6ICMyYTZjZmY7Ij5Ob3JtYWxpemF0aW9uIE1ldGhvZHM8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDRweDsiPjEuIERFTFRBX0ZfT1ZFUl9GICjOlEYvRik8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+Rm9ybXVsYTo8L3N0cm9uZz4gRicodCkgPSAoRih0KSAtIGcodCkpIC8gZyh0KQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+V2hlbiB0byB1c2U6PC9zdHJvbmc+IE1lYXN1cmUgcmVsYXRpdmUgY2hhbmdlIGZyb20gYmFzZWxpbmUKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkJlc3QgZm9yOjwvc3Ryb25nPiBEZXRlY3RpbmcgaW5jcmVhc2VzL2RlY3JlYXNlcyByZWxhdGl2ZSB0byBiYXNlbGluZQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+SW50ZXJwcmV0YXRpb246PC9zdHJvbmc+CiAgICAgICAgICAgICAgPHVsIHN0eWxlPSJtYXJnaW46IDRweCAwIDAgMjBweDsgcGFkZGluZy1sZWZ0OiAwOyI+CiAgICAgICAgICAgICAgICA8bGk+RicodCkgPSAwOiBObyBjaGFuZ2UgZnJvbSBiYXNlbGluZTwvbGk+CiAgICAgICAgICAgICAgICA8bGk+RicodCkgPiAwOiBJbmNyZWFzZSBhYm92ZSBiYXNlbGluZSAoZS5nLiwgMC41ID0gNTAlJSBpbmNyZWFzZSk8L2xpPgogICAgICAgICAgICAgICAgPGxpPkYnKHQpIDwgMDogRGVjcmVhc2UgYmVsb3cgYmFzZWxpbmUgKGUuZy4sIC0wLjMgPSAzMCUlIGRlY3JlYXNlKTwvbGk+CiAgICAgICAgICAgICAgPC91bD4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyI+CiAgICAgICAgICAgICAgVmFsdWVzIGNhbiBiZSBuZWdhdGl2ZSAoYmVsb3cgYmFzZWxpbmUpIG9yIHBvc2l0aXZlIChhYm92ZSBiYXNlbGluZSkKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDRweDsiPjIuIE1VTFRJUExJQ0FUSVZFPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkZvcm11bGE6PC9zdHJvbmc+IEZfbm9ybSh0KSA9IEYodCkgLyBnKHQpCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5XaGVuIHRvIHVzZTo8L3N0cm9uZz4gTm9ybWFsaXplIGJ5IGJhc2VsaW5lIHdpdGhvdXQgc3VidHJhY3RpbmcKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkJlc3QgZm9yOjwvc3Ryb25nPiBGb2xkLWNoYW5nZSBhbmFseXNpcwogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+SW50ZXJwcmV0YXRpb246PC9zdHJvbmc+CiAgICAgICAgICAgICAgPHVsIHN0eWxlPSJtYXJnaW46IDRweCAwIDAgMjBweDsgcGFkZGluZy1sZWZ0OiAwOyI+CiAgICAgICAgICAgICAgICA8bGk+Rl9ub3JtKHQpID0gMS4wOiBObyBjaGFuZ2UgZnJvbSBiYXNlbGluZTwvbGk+CiAgICAgICAgICAgICAgICA8bGk+Rl9ub3JtKHQpID0gMi4wOiAyLWZvbGQgaW5jcmVhc2UgKDEwMCUlIGluY3JlYXNlKTwvbGk+CiAgICAgICAgICAgICAgICA8bGk+Rl9ub3JtKHQpID0gMC41OiAyLWZvbGQgZGVjcmVhc2UgKDUwJSUgb2YgYmFzZWxpbmUpPC9saT4KICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7Ij4KICAgICAgICAgICAgICBWYWx1ZXMgYXJlIGFsd2F5cyBwb3NpdGl2ZSAocmF0aW8gdG8gYmFzZWxpbmUpCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsgY29sb3I6ICMyYTZjZmY7Ij5TdGF0aXN0aWNzIENvbXB1dGF0aW9uPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICAgICAgICBGb3IgZWFjaCBjb25kaXRpb24gYW5kIHRpbWVwb2ludCwgdGhlIGZvbGxvd2luZyBzdGF0aXN0aWNzIGFyZSBjb21wdXRlZDoKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDZweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+TWVhbjo8L3N0cm9uZz4gzrwodCkgPSAoMS9uKSDDlyDOoyBGJyh0KQogICAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyI+CiAgICAgICAgICAgICAgICBBdmVyYWdlIG5vcm1hbGl6ZWQgdmFsdWUgYWNyb3NzIGFsbCB3ZWxscyBpbiB0aGUgY29uZGl0aW9uCiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA2cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPlNEOjwvc3Ryb25nPiDPgyh0KSA9IHNxcnQozqMoRicodCkgLSDOvCh0KSnCsiAvIChuLTEpKQogICAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyI+CiAgICAgICAgICAgICAgICBTYW1wbGUgc3RhbmRhcmQgZGV2aWF0aW9uIChkZG9mPTEpIGFjcm9zcyB3ZWxscwogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICA8c3Ryb25nPlNFTTo8L3N0cm9uZz4gU0VNKHQpID0gz4ModCkgLyBzcXJ0KG4pCiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IGZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7Ij4KICAgICAgICAgICAgICAgIFN0YW5kYXJkIGVycm9yIG9mIHRoZSBtZWFuID0gU0QgLyBzcXJ0KG5fd2VsbHMpCiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IGZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDRweDsiPgogICAgICAgICAgICAgICAgPHN0cm9uZz5Ob3RlOjwvc3Ryb25nPiBTRU0gaXMgY29tcHV0ZWQgYWNyb3NzIHdlbGxzLCBub3QgcHJvcGFnYXRlZCBmcm9tIGJhc2VsaW5lIGVycm9yCiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXByaW1hcnkiIG9uY2xpY2s9InVwZGF0ZUNoYXJ0KCkiIHN0eWxlPSJtYXJnaW4tdG9wOiAxNnB4OyI+VXBkYXRlIENoYXJ0PC9idXR0b24+CiAgICA8YnV0dG9uIGNsYXNzPSJidG4iIG9uY2xpY2s9ImNsZWFyU2VsZWN0aW9uKCkiPkNsZWFyIFNlbGVjdGlvbjwvYnV0dG9uPgogICAgPGRpdiBpZD0id2VsbC1pbmZvIiBzdHlsZT0ibWFyZ2luLXRvcDogMTZweDsiPkNsaWNrIHdlbGxzIG9uIHRoZSBwbGF0ZSB0byBhZGQgdGhlbSB0byB0aGUgY2hhcnQuPC9kaXY+CiAgPC9hc2lkZT4KICA8bWFpbj4KICAgIDxkaXYgaWQ9InBsYXRlLWdyaWRzLWNvbnRhaW5lciI+PC9kaXY+CiAgICA8ZGl2IGlkPSJjaGFydC1jb250YWluZXIiPgogICAgICA8Y2FudmFzIGlkPSJ3ZWxsLWNoYXJ0Ij48L2NhbnZhcz4KICAgIDwvZGl2PgogIDwvbWFpbj4KICA8L2Rpdj4KCjxzY3JpcHQ+CmNvbnN0IFBMQVRFX1JPV1MgPSAiJShyb3dzKXMiLnNwbGl0KCIiKTsKY29uc3QgUExBVEVfQ09MUyA9ICUoY29scylkOwoKbGV0IHZpZXdlckRhdGEgPSBudWxsOwpsZXQgY2hhcnQgPSBudWxsOwpsZXQgc2VsZWN0ZWRXZWxscyA9IG5ldyBTZXQoKTsgLy8gU2V0IG9mIHtwbGF0ZUlkOndlbGxJZH0gc3RyaW5ncwpsZXQgYWxsV2VsbHNEYXRhID0ge307IC8vIENvbWJpbmVkIHdlbGxzIGZyb20gYWxsIHBsYXRlczoge3BsYXRlSWQ6IHt3ZWxsSWQ6IHsuLi59fX0KbGV0IHNlbGVjdGVkRGF0YXNldElkcyA9IG5ldyBTZXQoKTsgLy8gU2V0IG9mIHNlbGVjdGVkIGRhdGFzZXQgZ3JvdXAgSURzIChlLmcuLCAiZ3JvdXA6R1JPVVBfTkFNRSIpCmxldCBsYXN0U2VsZWN0ZWRJbmRleCA9IC0xOyAvLyBUcmFjayBsYXN0IHNlbGVjdGVkIGluZGV4IGZvciBzaGlmdC1jbGljawpsZXQgZW5hYmxlZERhdGFzZXRzID0gbmV3IFNldCgpOyAvLyBTZXQgb2YgZW5hYmxlZCBkYXRhc2V0IElEcyAoZW1wdHkgPSBhbGwgZW5hYmxlZCkKbGV0IGVuYWJsZWRXZWxscyA9IG5ldyBTZXQoKTsgLy8gU2V0IG9mIGVuYWJsZWQgd2VsbCBJRHMgKGVtcHR5ID0gYWxsIGVuYWJsZWQpCmxldCBlbmFibGVkQ29sdW1uc0J5U2NpZW50aXN0ID0ge307IC8vIE1hcDogc2NpZW50aXN0IC0+IFNldCBvZiBlbmFibGVkIGNvbHVtbiBudW1iZXJzIChlbXB0eSBzZXQgPSBhbGwgZW5hYmxlZCkKbGV0IHBsYXRlSW5kaWNhdG9yQ2xlYW51cCA9IG51bGw7IC8vIFN0b3JlIGNsZWFudXAgZnVuY3Rpb25zIGZvciBwbGF0ZSBpbmRpY2F0b3IgZXZlbnQgbGlzdGVuZXJzCgovLyBIZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IGVuYWJsZWQgY29sdW1ucyBmb3IgYSBzY2llbnRpc3QKZnVuY3Rpb24gZ2V0RW5hYmxlZENvbHVtbnNGb3JTY2llbnRpc3Qoc2NpZW50aXN0KSB7CiAgaWYgKCFlbmFibGVkQ29sdW1uc0J5U2NpZW50aXN0W3NjaWVudGlzdF0pIHsKICAgIGVuYWJsZWRDb2x1bW5zQnlTY2llbnRpc3Rbc2NpZW50aXN0XSA9IG5ldyBTZXQoKTsKICB9CiAgcmV0dXJuIGVuYWJsZWRDb2x1bW5zQnlTY2llbnRpc3Rbc2NpZW50aXN0XTsKfQoKLy8gUmVnaXN0ZXIgZXJyb3IgYmFyIHBsdWdpbiBnbG9iYWxseQpDaGFydC5yZWdpc3Rlcih7CiAgaWQ6ICJlcnJvckJhcnMiLAogIGFmdGVyRGF0YXNldHNEcmF3OiAoY2hhcnQpID0+IHsKICAgIGNvbnN0IGN0eCA9IGNoYXJ0LmN0eDsKICAgIGNoYXJ0LmRhdGEuZGF0YXNldHMuZm9yRWFjaCgoZGF0YXNldCwgZGF0YXNldEluZGV4KSA9PiB7CiAgICAgIGlmICghZGF0YXNldC5kYXRhIHx8IGRhdGFzZXQuZGF0YS5sZW5ndGggPT09IDApIHJldHVybjsKICAgICAgCiAgICAgIC8vIENoZWNrIGlmIGFueSBkYXRhIHBvaW50IGhhcyBlcnJvciBpbmZvcm1hdGlvbgogICAgICBjb25zdCBoYXNFcnJvcnMgPSBkYXRhc2V0LmRhdGEuc29tZShkID0+IGQgJiYgZC5lcnJvciAhPT0gdW5kZWZpbmVkICYmIGQuZXJyb3IgIT09IG51bGwpOwogICAgICBpZiAoIWhhc0Vycm9ycykgcmV0dXJuOwogICAgICAKICAgICAgY29uc3QgbWV0YSA9IGNoYXJ0LmdldERhdGFzZXRNZXRhKGRhdGFzZXRJbmRleCk7CiAgICAgIGN0eC5zYXZlKCk7CiAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGRhdGFzZXQuYm9yZGVyQ29sb3IgfHwgInJnYmEoMCwwLDAsMC41KSI7CiAgICAgIGN0eC5saW5lV2lkdGggPSAxOwogICAgICAKICAgICAgbWV0YS5kYXRhLmZvckVhY2goKHBvaW50LCBpbmRleCkgPT4gewogICAgICAgIGlmICghcG9pbnQgfHwgIWRhdGFzZXQuZGF0YVtpbmRleF0gfHwgZGF0YXNldC5kYXRhW2luZGV4XS5lcnJvciA9PT0gdW5kZWZpbmVkIHx8IGRhdGFzZXQuZGF0YVtpbmRleF0uZXJyb3IgPT09IG51bGwpIHJldHVybjsKICAgICAgICAKICAgICAgICBjb25zdCB4ID0gcG9pbnQueDsKICAgICAgICBjb25zdCB5ID0gcG9pbnQueTsKICAgICAgICBjb25zdCBlcnJvciA9IGRhdGFzZXQuZGF0YVtpbmRleF0uZXJyb3I7CiAgICAgICAgY29uc3QgeVNjYWxlID0gY2hhcnQuc2NhbGVzLnk7CiAgICAgICAgY29uc3QgZXJyb3JQaXhlbHMgPSBNYXRoLmFicyh5U2NhbGUuZ2V0UGl4ZWxGb3JWYWx1ZSh5ICsgZXJyb3IpIC0geVNjYWxlLmdldFBpeGVsRm9yVmFsdWUoeSkpOwogICAgICAgIAogICAgICAgIC8vIERyYXcgdmVydGljYWwgZXJyb3IgYmFyCiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oeCwgeSAtIGVycm9yUGl4ZWxzKTsKICAgICAgICBjdHgubGluZVRvKHgsIHkgKyBlcnJvclBpeGVscyk7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIAogICAgICAgIC8vIERyYXcgaG9yaXpvbnRhbCBjYXBzCiAgICAgICAgY29uc3QgY2FwV2lkdGggPSA0OwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKHggLSBjYXBXaWR0aCwgeSAtIGVycm9yUGl4ZWxzKTsKICAgICAgICBjdHgubGluZVRvKHggKyBjYXBXaWR0aCwgeSAtIGVycm9yUGl4ZWxzKTsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oeCAtIGNhcFdpZHRoLCB5ICsgZXJyb3JQaXhlbHMpOwogICAgICAgIGN0eC5saW5lVG8oeCArIGNhcFdpZHRoLCB5ICsgZXJyb3JQaXhlbHMpOwogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgfSk7CiAgICAgIAogICAgICBjdHgucmVzdG9yZSgpOwogICAgfSk7CiAgfQp9KTsKCi8vIFJlZ2lzdGVyIGJhc2VsaW5lIGxhYmVsIHBsdWdpbiB0byBkaXNwbGF5IGJhc2VsaW5lIG51bWJlcnMgb24gdGhlIGNoYXJ0CkNoYXJ0LnJlZ2lzdGVyKHsKICBpZDogImJhc2VsaW5lTGFiZWxzIiwKICBhZnRlckRhdGFzZXRzRHJhdzogKGNoYXJ0KSA9PiB7CiAgICBjb25zdCBjdHggPSBjaGFydC5jdHg7CiAgICBjb25zdCB4U2NhbGUgPSBjaGFydC5zY2FsZXMueDsKICAgIGNvbnN0IHlTY2FsZSA9IGNoYXJ0LnNjYWxlcy55OwogICAgCiAgICBjaGFydC5kYXRhLmRhdGFzZXRzLmZvckVhY2goKGRhdGFzZXQsIGRhdGFzZXRJbmRleCkgPT4gewogICAgICAvLyBPbmx5IHByb2Nlc3MgYmFzZWxpbmUgbGluZXMgKGlkZW50aWZpZWQgYnkgaGF2aW5nIGV4YWN0bHkgMiBwb2ludHMgYW5kIG9yZGVyID09PSAxMDAwKQogICAgICBpZiAoIWRhdGFzZXQuZGF0YSB8fCBkYXRhc2V0LmRhdGEubGVuZ3RoICE9PSAyIHx8IGRhdGFzZXQub3JkZXIgIT09IDEwMDApIHJldHVybjsKICAgICAgCiAgICAgIC8vIEV4dHJhY3QgYmFzZWxpbmUgdmFsdWUgZnJvbSBsYWJlbCAoZm9ybWF0OiAibGFiZWwgKGJhc2VsaW5lOiB2YWx1ZSkiKQogICAgICBjb25zdCBiYXNlbGluZU1hdGNoID0gZGF0YXNldC5sYWJlbC5tYXRjaCgvXChiYXNlbGluZTpccyooW1xkLl0rKVwpLyk7CiAgICAgIGlmICghYmFzZWxpbmVNYXRjaCkgcmV0dXJuOwogICAgICAKICAgICAgY29uc3QgYmFzZWxpbmVWYWx1ZSA9IHBhcnNlRmxvYXQoYmFzZWxpbmVNYXRjaFsxXSk7CiAgICAgIGlmIChpc05hTihiYXNlbGluZVZhbHVlKSkgcmV0dXJuOwogICAgICAKICAgICAgLy8gR2V0IHRoZSB5IHBvc2l0aW9uIG9mIHRoZSBiYXNlbGluZQogICAgICBjb25zdCBiYXNlbGluZVkgPSBkYXRhc2V0LmRhdGFbMF0ueTsKICAgICAgY29uc3QgeVBpeGVsID0geVNjYWxlLmdldFBpeGVsRm9yVmFsdWUoYmFzZWxpbmVZKTsKICAgICAgCiAgICAgIC8vIFBvc2l0aW9uIHRleHQgYXQgdGhlIHJpZ2h0IGVkZ2Ugb2YgdGhlIGNoYXJ0LCBzbGlnaHRseSBvZmZzZXQgZnJvbSB0aGUgbGluZQogICAgICBjb25zdCBjaGFydEFyZWEgPSBjaGFydC5jaGFydEFyZWE7CiAgICAgIGNvbnN0IHRleHRYID0gY2hhcnRBcmVhLnJpZ2h0IC0gMTA7IC8vIDEwcHggZnJvbSByaWdodCBlZGdlCiAgICAgIGNvbnN0IHRleHRZID0geVBpeGVsIC0gNTsgLy8gNXB4IGFib3ZlIHRoZSBsaW5lCiAgICAgIAogICAgICBjdHguc2F2ZSgpOwogICAgICBjdHguZm9udCA9ICIxMnB4IEFyaWFsIjsKICAgICAgY3R4LmZpbGxTdHlsZSA9IGRhdGFzZXQuYm9yZGVyQ29sb3IgfHwgInJnYmEoMTI4LCAxMjgsIDEyOCwgMC43KSI7CiAgICAgIGN0eC50ZXh0QWxpZ24gPSAicmlnaHQiOwogICAgICBjdHgudGV4dEJhc2VsaW5lID0gImJvdHRvbSI7CiAgICAgIAogICAgICAvLyBEcmF3IGJhY2tncm91bmQgcmVjdGFuZ2xlIGZvciBiZXR0ZXIgcmVhZGFiaWxpdHkKICAgICAgY29uc3QgdGV4dCA9IGJhc2VsaW5lVmFsdWUudG9GaXhlZCgyKTsKICAgICAgY29uc3QgdGV4dE1ldHJpY3MgPSBjdHgubWVhc3VyZVRleHQodGV4dCk7CiAgICAgIGNvbnN0IHBhZGRpbmcgPSA0OwogICAgICBjdHguZmlsbFN0eWxlID0gInJnYmEoMjU1LCAyNTUsIDI1NSwgMC44KSI7CiAgICAgIGN0eC5maWxsUmVjdCgKICAgICAgICB0ZXh0WCAtIHRleHRNZXRyaWNzLndpZHRoIC0gcGFkZGluZywKICAgICAgICB0ZXh0WSAtIDEyIC0gcGFkZGluZywKICAgICAgICB0ZXh0TWV0cmljcy53aWR0aCArIHBhZGRpbmcgKiAyLAogICAgICAgIDEyICsgcGFkZGluZyAqIDIKICAgICAgKTsKICAgICAgCiAgICAgIC8vIERyYXcgdGhlIHRleHQKICAgICAgY3R4LmZpbGxTdHlsZSA9IGRhdGFzZXQuYm9yZGVyQ29sb3IgfHwgInJnYmEoMTI4LCAxMjgsIDEyOCwgMC45KSI7CiAgICAgIGN0eC5maWxsVGV4dCh0ZXh0LCB0ZXh0WCwgdGV4dFkpOwogICAgICAKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgIH0pOwogIH0KfSk7CgpmdW5jdGlvbiBkaXNwbGF5V2FybmluZ3MoKSB7CiAgY29uc3Qgd2FybmluZ0Jhbm5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ3YXJuaW5nLWJhbm5lciIpOwogIGlmICghd2FybmluZ0Jhbm5lciB8fCAhdmlld2VyRGF0YSB8fCAhdmlld2VyRGF0YS5jb25maWcpIHsKICAgIHJldHVybjsKICB9CiAgCiAgY29uc3Qgd2FybmluZ3MgPSB2aWV3ZXJEYXRhLmNvbmZpZy53YXJuaW5ncyB8fCB7fTsKICBjb25zdCBkdXBsaWNhdGVDb2x1bW5zID0gd2FybmluZ3MuZHVwbGljYXRlX2NvbHVtbnMgfHwgW107CiAgCiAgaWYgKGR1cGxpY2F0ZUNvbHVtbnMubGVuZ3RoID09PSAwKSB7CiAgICB3YXJuaW5nQmFubmVyLmNsYXNzTGlzdC5yZW1vdmUoInNob3ciKTsKICAgIHJldHVybjsKICB9CiAgCiAgLy8gQnVpbGQgd2FybmluZyBtZXNzYWdlIC0gb25seSBzaG93IGNvbHVtbiBudW1iZXJzCiAgbGV0IGh0bWwgPSAnPGgzPuKaoO+4jyBXYXJuaW5nOiBEdXBsaWNhdGUgQ29sdW1ucyBEZXRlY3RlZDwvaDM+JzsKICAKICBkdXBsaWNhdGVDb2x1bW5zLmZvckVhY2god2FybmluZyA9PiB7CiAgICBjb25zdCBmaWxlcyA9IHdhcm5pbmcuZmlsZXMgfHwgW107CiAgICBjb25zdCBjb2x1bW5zID0gd2FybmluZy5jb2x1bW5zIHx8IFtdOwogICAgY29uc3QgZmlsZXNTdHIgPSBmaWxlcy5qb2luKCIgYW5kICIpOwogICAgY29uc3QgY29sdW1uc1N0ciA9IGNvbHVtbnMubGVuZ3RoIDw9IDEwIAogICAgICA/IGNvbHVtbnMuam9pbigiLCAiKQogICAgICA6IGNvbHVtbnMuc2xpY2UoMCwgMTApLmpvaW4oIiwgIikgKyBgLCAuLi4gKCR7Y29sdW1ucy5sZW5ndGh9IHRvdGFsKWA7CiAgICAKICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDhweDsiPjxzdHJvbmc+JHtmaWxlc1N0cn08L3N0cm9uZz4gaGF2ZSBkdXBsaWNhdGUgY29sdW1uczogJHtjb2x1bW5zU3RyfTwvZGl2PmA7CiAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTZweDsgZm9udC1zaXplOiAwLjg1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLWJvdHRvbTogMTJweDsiPk9ubHkgZGF0YSBmcm9tICc8c3Ryb25nPiR7ZmlsZXNbMF19PC9zdHJvbmc+JyAoZmlyc3QgYWxwaGFiZXRpY2FsbHkpIGlzIHVzZWQuPC9kaXY+YDsKICB9KTsKICAKICB3YXJuaW5nQmFubmVyLmlubmVySFRNTCA9IGh0bWw7CiAgd2FybmluZ0Jhbm5lci5jbGFzc0xpc3QuYWRkKCJzaG93Iik7Cn0KCmFzeW5jIGZ1bmN0aW9uIGxvYWREYXRhKCkgewogIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKCJ2aWV3ZXJfZGF0YS5qc29uIik7CiAgdmlld2VyRGF0YSA9IGF3YWl0IHJlcy5qc29uKCk7CiAgY29tYmluZUFsbFdlbGxzKCk7CiAgLy8gSW5pdGlhbGl6ZSB0cmlwbGljYXRlIGdyb3VwIGNvbG9ycyBiZWZvcmUgcmVuZGVyaW5nCiAgaW5pdGlhbGl6ZVRyaXBsaWNhdGVHcm91cENvbG9ycygpOwogIGRpc3BsYXlXYXJuaW5ncygpOwogIGluaXREYXRhc2V0U2VsZWN0KCk7CiAgaW5pdERhdGFzZXRTZWxlY3RUb29sdGlwKCk7CiAgcmVuZGVyUGxhdGVHcmlkKCk7Cn0KCmZ1bmN0aW9uIGluaXREYXRhc2V0U2VsZWN0VG9vbHRpcCgpIHsKICBjb25zdCBoZWxwSWNvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJkYXRhc2V0LXNlbGVjdC1oZWxwIik7CiAgY29uc3QgdG9vbHRpcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJkYXRhc2V0LXNlbGVjdC10b29sdGlwIik7CiAgCiAgaWYgKCFoZWxwSWNvbiB8fCAhdG9vbHRpcCkgcmV0dXJuOwogIAogIGxldCB0b29sdGlwVGltZW91dDsKICAKICBoZWxwSWNvbi5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWVudGVyIiwgKCkgPT4gewogICAgY2xlYXJUaW1lb3V0KHRvb2x0aXBUaW1lb3V0KTsKICAgIHRvb2x0aXAuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgfSk7CiAgCiAgaGVscEljb24uYWRkRXZlbnRMaXN0ZW5lcigibW91c2VsZWF2ZSIsICgpID0+IHsKICAgIHRvb2x0aXBUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgIHRvb2x0aXAuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIH0sIDEwMCk7CiAgfSk7CiAgCiAgdG9vbHRpcC5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWVudGVyIiwgKCkgPT4gewogICAgY2xlYXJUaW1lb3V0KHRvb2x0aXBUaW1lb3V0KTsKICAgIHRvb2x0aXAuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgfSk7CiAgCiAgdG9vbHRpcC5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWxlYXZlIiwgKCkgPT4gewogICAgdG9vbHRpcFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgdG9vbHRpcC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgfSwgMTAwKTsKICB9KTsKfQoKZnVuY3Rpb24gY29tYmluZUFsbFdlbGxzKCkgewogIC8vIENvbWJpbmUgYWxsIHdlbGxzIGZyb20gYWxsIHBsYXRlcyBpbnRvIGEgc2luZ2xlIHN0cnVjdHVyZQogIGFsbFdlbGxzRGF0YSA9IHt9OwogIHZpZXdlckRhdGEucGxhdGVzLmZvckVhY2gocGxhdGUgPT4gewogICAgYWxsV2VsbHNEYXRhW3BsYXRlLmlkXSA9IHBsYXRlLndlbGxzOwogIH0pOwp9CgpmdW5jdGlvbiBpbml0RGF0YXNldFNlbGVjdCgpIHsKICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZGF0YXNldC1zZWxlY3QiKTsKICBjb250YWluZXIuaW5uZXJIVE1MID0gIiI7CiAgCiAgaWYgKCF2aWV3ZXJEYXRhIHx8ICF2aWV3ZXJEYXRhLnBsYXRlcyB8fCB2aWV3ZXJEYXRhLnBsYXRlcy5sZW5ndGggPT09IDApIHsKICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSAiPGRpdiBzdHlsZT0ncGFkZGluZzogMTJweDsgY29sb3I6ICM2NjY7IGZvbnQtc2l6ZTogMC44NXJlbTsgdGV4dC1hbGlnbjogY2VudGVyOyc+Tm8gZGF0YXNldHMgYXZhaWxhYmxlLjwvZGl2PiI7CiAgICByZXR1cm47CiAgfQogIAogIC8vIEdyb3VwIHBsYXRlcyBieSBjb2x1bW5fZ3JvdXAKICBjb25zdCBwbGF0ZXNCeUdyb3VwID0ge307CiAgdmlld2VyRGF0YS5wbGF0ZXMuZm9yRWFjaChwbGF0ZSA9PiB7CiAgICBjb25zdCBncm91cCA9IHBsYXRlLmNvbHVtbl9ncm91cCB8fCAiT3RoZXIiOwogICAgaWYgKCFwbGF0ZXNCeUdyb3VwW2dyb3VwXSkgewogICAgICBwbGF0ZXNCeUdyb3VwW2dyb3VwXSA9IFtdOwogICAgfQogICAgcGxhdGVzQnlHcm91cFtncm91cF0ucHVzaChwbGF0ZSk7CiAgfSk7CiAgCiAgLy8gU29ydCBncm91cHMgYWxwaGFiZXRpY2FsbHkKICBjb25zdCBzb3J0ZWRHcm91cHMgPSBPYmplY3Qua2V5cyhwbGF0ZXNCeUdyb3VwKS5zb3J0KCk7CiAgCiAgLy8gQ3JlYXRlIGxpbmUgaXRlbXMgZm9yIGVhY2ggZ3JvdXAKICBzb3J0ZWRHcm91cHMuZm9yRWFjaCgoZ3JvdXBOYW1lLCBpbmRleCkgPT4gewogICAgY29uc3QgcGxhdGVzID0gcGxhdGVzQnlHcm91cFtncm91cE5hbWVdOwogICAgY29uc3QgZ3JvdXBJZCA9IGBncm91cDoke2dyb3VwTmFtZX1gOwogICAgCiAgICAvLyBDcmVhdGUgZnJpZW5kbHkgbmFtZSBmcm9tIGZpcnN0IHBsYXRlJ3MgY29sdW1uIGluZm8KICAgIGNvbnN0IGZpcnN0UGxhdGUgPSBwbGF0ZXNbMF07CiAgICBjb25zdCBjb2x1bW5JbmZvID0gZmlyc3RQbGF0ZS5jb2x1bW5faW5mbyB8fCB7fTsKICAgIGNvbnN0IHBhcnRzID0gW107CiAgICBpZiAoY29sdW1uSW5mby5wcm90ZWluKSBwYXJ0cy5wdXNoKGNvbHVtbkluZm8ucHJvdGVpbik7CiAgICBpZiAoY29sdW1uSW5mby5nZW5vdHlwZSkgcGFydHMucHVzaChjb2x1bW5JbmZvLmdlbm90eXBlKTsKICAgIGlmIChjb2x1bW5JbmZvLmJ1ZmZlcikgcGFydHMucHVzaChjb2x1bW5JbmZvLmJ1ZmZlcik7CiAgICAKICAgIC8vIENyZWF0ZSBkaXNwbGF5IHRleHQKICAgIGxldCBkaXNwbGF5VGV4dDsKICAgIGlmIChwbGF0ZXMubGVuZ3RoID4gMSkgewogICAgICBkaXNwbGF5VGV4dCA9IHBhcnRzLmxlbmd0aCA+IDAgCiAgICAgICAgPyBgJHtwYXJ0cy5qb2luKCIgLSAiKX0gKCR7cGxhdGVzLmxlbmd0aH0gZGF0YXNldHMpYAogICAgICAgIDogYCR7Z3JvdXBOYW1lfSAoJHtwbGF0ZXMubGVuZ3RofSBkYXRhc2V0cylgOwogICAgfSBlbHNlIHsKICAgICAgZGlzcGxheVRleHQgPSBwYXJ0cy5sZW5ndGggPiAwIAogICAgICAgID8gcGFydHMuam9pbigiIC0gIikKICAgICAgICA6IGdyb3VwTmFtZTsKICAgIH0KICAgIAogICAgLy8gQ3JlYXRlIGxpbmUgaXRlbSBkaXYKICAgIGNvbnN0IGxpbmVJdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBsaW5lSXRlbS5jbGFzc05hbWUgPSAiZGF0YXNldC1saW5lLWl0ZW0iOwogICAgbGluZUl0ZW0uZGF0YXNldC5ncm91cElkID0gZ3JvdXBJZDsKICAgIGxpbmVJdGVtLmRhdGFzZXQuaW5kZXggPSBpbmRleDsKICAgIGxpbmVJdGVtLnRleHRDb250ZW50ID0gZGlzcGxheVRleHQ7CiAgICAKICAgIC8vIEFkZCBjbGljayBoYW5kbGVyCiAgICBsaW5lSXRlbS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIChlKSA9PiB7CiAgICAgIGhhbmRsZURhdGFzZXRJdGVtQ2xpY2soZSwgZ3JvdXBJZCwgaW5kZXgpOwogICAgfSk7CiAgICAKICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChsaW5lSXRlbSk7CiAgfSk7CiAgCiAgLy8gU2VsZWN0IGZpcnN0IGdyb3VwIGJ5IGRlZmF1bHQKICBpZiAoc29ydGVkR3JvdXBzLmxlbmd0aCA+IDApIHsKICAgIGNvbnN0IGZpcnN0R3JvdXBJZCA9IGBncm91cDoke3NvcnRlZEdyb3Vwc1swXX1gOwogICAgc2VsZWN0ZWREYXRhc2V0SWRzLmFkZChmaXJzdEdyb3VwSWQpOwogICAgbGFzdFNlbGVjdGVkSW5kZXggPSAwOwogICAgdXBkYXRlRGF0YXNldFNlbGVjdERpc3BsYXkoKTsKICB9CiAgCn0KCmZ1bmN0aW9uIGhhbmRsZURhdGFzZXRJdGVtQ2xpY2soZSwgZ3JvdXBJZCwgaW5kZXgpIHsKICBjb25zdCBpc1NoaWZ0Q2xpY2sgPSBlLnNoaWZ0S2V5OwogIGNvbnN0IGlzQ3RybENsaWNrID0gZS5jdHJsS2V5IHx8IGUubWV0YUtleTsgLy8gU3VwcG9ydCBib3RoIEN0cmwgYW5kIENtZAogIAogIGlmIChpc1NoaWZ0Q2xpY2sgJiYgbGFzdFNlbGVjdGVkSW5kZXggPj0gMCkgewogICAgLy8gU2hpZnQtY2xpY2s6IHNlbGVjdCByYW5nZSBmcm9tIGxhc3RTZWxlY3RlZEluZGV4IHRvIGN1cnJlbnQgaW5kZXgKICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJkYXRhc2V0LXNlbGVjdCIpOwogICAgY29uc3QgaXRlbXMgPSBBcnJheS5mcm9tKGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yQWxsKCIuZGF0YXNldC1saW5lLWl0ZW0iKSk7CiAgICBjb25zdCBzdGFydElkeCA9IE1hdGgubWluKGxhc3RTZWxlY3RlZEluZGV4LCBpbmRleCk7CiAgICBjb25zdCBlbmRJZHggPSBNYXRoLm1heChsYXN0U2VsZWN0ZWRJbmRleCwgaW5kZXgpOwogICAgCiAgICBmb3IgKGxldCBpID0gc3RhcnRJZHg7IGkgPD0gZW5kSWR4OyBpKyspIHsKICAgICAgaWYgKGl0ZW1zW2ldKSB7CiAgICAgICAgY29uc3QgaXRlbUdyb3VwSWQgPSBpdGVtc1tpXS5kYXRhc2V0Lmdyb3VwSWQ7CiAgICAgICAgc2VsZWN0ZWREYXRhc2V0SWRzLmFkZChpdGVtR3JvdXBJZCk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgaWYgKGlzQ3RybENsaWNrKSB7CiAgICAvLyBDdHJsL0NtZC1jbGljazogdG9nZ2xlIHRoaXMgaXRlbQogICAgaWYgKHNlbGVjdGVkRGF0YXNldElkcy5oYXMoZ3JvdXBJZCkpIHsKICAgICAgc2VsZWN0ZWREYXRhc2V0SWRzLmRlbGV0ZShncm91cElkKTsKICAgIH0gZWxzZSB7CiAgICAgIHNlbGVjdGVkRGF0YXNldElkcy5hZGQoZ3JvdXBJZCk7CiAgICB9CiAgfSBlbHNlIHsKICAgIC8vIFJlZ3VsYXIgY2xpY2s6IGNsZWFyIGFsbCBhbmQgc2VsZWN0IG9ubHkgdGhpcyBpdGVtCiAgICBzZWxlY3RlZERhdGFzZXRJZHMuY2xlYXIoKTsKICAgIHNlbGVjdGVkRGF0YXNldElkcy5hZGQoZ3JvdXBJZCk7CiAgfQogIAogIGxhc3RTZWxlY3RlZEluZGV4ID0gaW5kZXg7CiAgdXBkYXRlRGF0YXNldFNlbGVjdERpc3BsYXkoKTsKICAKICAvLyBDbGVhbiB1cCBzZWxlY3RlZCB3ZWxscyAtIG9ubHkga2VlcCB3ZWxscyBmcm9tIHNlbGVjdGVkIGRhdGFzZXRzCiAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICBjb25zdCBuZXdTZWxlY3RlZFdlbGxzID0gbmV3IFNldCgpOwogIHNlbGVjdGVkV2VsbHMuZm9yRWFjaChrZXkgPT4gewogICAgY29uc3QgW3BsYXRlSWRdID0ga2V5LnNwbGl0KCI6Iik7CiAgICBpZiAoc2VsZWN0ZWREYXRhc2V0cy5pbmNsdWRlcyhwbGF0ZUlkKSkgewogICAgICBuZXdTZWxlY3RlZFdlbGxzLmFkZChrZXkpOwogICAgfQogIH0pOwogIHNlbGVjdGVkV2VsbHMgPSBuZXdTZWxlY3RlZFdlbGxzOwogIAogIC8vIFJlc2V0IGVuYWJsZWQgZGF0YXNldHMvd2VsbHMvY29sdW1ucyB3aGVuIGNoYW5naW5nIGRhdGFzZXQgZ3JvdXBzCiAgZW5hYmxlZERhdGFzZXRzLmNsZWFyKCk7CiAgZW5hYmxlZFdlbGxzLmNsZWFyKCk7CiAgZW5hYmxlZENvbHVtbnNCeVNjaWVudGlzdCA9IHt9OyAvLyBDbGVhciBhbGwgc2NpZW50aXN0LXNwZWNpZmljIGNvbHVtbiBmaWx0ZXJzCiAgCiAgcmVuZGVyUGxhdGVHcmlkKCk7CiAgdXBkYXRlV2VsbEluZm8oKTsKICByZW5kZXJXZWxsU2VsZWN0b3JHcmlkKCk7Cn0KCmZ1bmN0aW9uIHVwZGF0ZURhdGFzZXRTZWxlY3REaXNwbGF5KCkgewogIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJkYXRhc2V0LXNlbGVjdCIpOwogIGNvbnN0IGl0ZW1zID0gY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3JBbGwoIi5kYXRhc2V0LWxpbmUtaXRlbSIpOwogIAogIGl0ZW1zLmZvckVhY2goaXRlbSA9PiB7CiAgICBjb25zdCBncm91cElkID0gaXRlbS5kYXRhc2V0Lmdyb3VwSWQ7CiAgICBpZiAoc2VsZWN0ZWREYXRhc2V0SWRzLmhhcyhncm91cElkKSkgewogICAgICBpdGVtLmNsYXNzTGlzdC5hZGQoInNlbGVjdGVkIik7CiAgICB9IGVsc2UgewogICAgICBpdGVtLmNsYXNzTGlzdC5yZW1vdmUoInNlbGVjdGVkIik7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIGdldFNlbGVjdGVkRGF0YXNldHMoKSB7CiAgLy8gUmV0dXJuIGFsbCBkYXRhc2V0cyBpbiB0aGUgc2VsZWN0ZWQgZ3JvdXBzLCBmaWx0ZXJlZCBieSBlbmFibGVkRGF0YXNldHMKICBpZiAoc2VsZWN0ZWREYXRhc2V0SWRzLnNpemUgPT09IDApIHsKICAgIHJldHVybiBbXTsKICB9CiAgCiAgbGV0IGRhdGFzZXRzID0gW107CiAgCiAgLy8gUHJvY2VzcyBhbGwgc2VsZWN0ZWQgZ3JvdXBzCiAgc2VsZWN0ZWREYXRhc2V0SWRzLmZvckVhY2goZ3JvdXBJZCA9PiB7CiAgICAvLyBDaGVjayBpZiBpdCdzIGEgZ3JvdXAgc2VsZWN0aW9uIChmb3JtYXQ6ICJncm91cDpHUk9VUF9OQU1FIikKICAgIGlmIChncm91cElkLnN0YXJ0c1dpdGgoImdyb3VwOiIpKSB7CiAgICAgIGNvbnN0IGdyb3VwTmFtZSA9IGdyb3VwSWQuc3Vic3RyaW5nKDYpOyAvLyBSZW1vdmUgImdyb3VwOiIgcHJlZml4CiAgICAgIGNvbnN0IHNlbGVjdGVkUGxhdGVzID0gdmlld2VyRGF0YS5wbGF0ZXMuZmlsdGVyKHAgPT4gcC5jb2x1bW5fZ3JvdXAgPT09IGdyb3VwTmFtZSk7CiAgICAgIGRhdGFzZXRzLnB1c2goLi4uc2VsZWN0ZWRQbGF0ZXMubWFwKHAgPT4gcC5pZCkpOwogICAgfSBlbHNlIHsKICAgICAgLy8gT3RoZXJ3aXNlLCBpdCdzIGEgc2luZ2xlIGRhdGFzZXQgc2VsZWN0aW9uIChsZWdhY3kgc3VwcG9ydCkKICAgICAgY29uc3QgcGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gZ3JvdXBJZCk7CiAgICAgIGlmIChwbGF0ZSkgewogICAgICAgIGRhdGFzZXRzLnB1c2goZ3JvdXBJZCk7CiAgICAgIH0KICAgIH0KICB9KTsKICAKICAvLyBSZW1vdmUgZHVwbGljYXRlcwogIGRhdGFzZXRzID0gWy4uLm5ldyBTZXQoZGF0YXNldHMpXTsKICAKICAvLyBGaWx0ZXIgYnkgZW5hYmxlZERhdGFzZXRzIGlmIGFueSBhcmUgc2V0CiAgaWYgKGVuYWJsZWREYXRhc2V0cy5zaXplID4gMCkgewogICAgcmV0dXJuIGRhdGFzZXRzLmZpbHRlcihpZCA9PiBlbmFibGVkRGF0YXNldHMuaGFzKGlkKSk7CiAgfQogIAogIHJldHVybiBkYXRhc2V0czsKfQoKZnVuY3Rpb24gdG9nZ2xlV2VsbFNlbGVjdG9yKCkgewogIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ3ZWxsLXNlbGVjdG9yLWdyaWQtY29udGFpbmVyIik7CiAgY29uc3QgYXJyb3cgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgid2VsbC1zZWxlY3Rvci1hcnJvdyIpOwogIGlmIChjb250YWluZXIuc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiKSB7CiAgICBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICBhcnJvdy50ZXh0Q29udGVudCA9ICLilrIiOwogICAgcmVuZGVyV2VsbFNlbGVjdG9yR3JpZCgpOwogIH0gZWxzZSB7CiAgICBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIGFycm93LnRleHRDb250ZW50ID0gIuKWvCI7CiAgfQp9CgpmdW5jdGlvbiB0b2dnbGVCYXNlbGluZU9wdGlvbnMoKSB7CiAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJhc2VsaW5lLW9wdGlvbnMtY29udGVudCIpOwogIGNvbnN0IGFycm93ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJhc2VsaW5lLW9wdGlvbnMtYXJyb3ciKTsKICBpZiAoY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPT09ICJub25lIikgewogICAgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgYXJyb3cudGV4dENvbnRlbnQgPSAi4payIjsKICB9IGVsc2UgewogICAgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICBhcnJvdy50ZXh0Q29udGVudCA9ICLilrwiOwogIH0KfQoKZnVuY3Rpb24gdXBkYXRlQmFzZWxpbmVNZXRob2RQYXJhbXMoKSB7CiAgY29uc3QgbWV0aG9kID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJhc2VsaW5lLW1ldGhvZC1zZWxlY3QiKS52YWx1ZTsKICBjb25zdCBsb3dlc3NQYXJhbXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtbG93ZXNzLXBhcmFtcyIpOwogIGNvbnN0IHBvbHlub21pYWxQYXJhbXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtcG9seW5vbWlhbC1wYXJhbXMiKTsKICAKICBpZiAobWV0aG9kID09PSAibG93ZXNzIikgewogICAgbG93ZXNzUGFyYW1zLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgcG9seW5vbWlhbFBhcmFtcy5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogIH0gZWxzZSBpZiAobWV0aG9kID09PSAicG9seW5vbWlhbCIpIHsKICAgIGxvd2Vzc1BhcmFtcy5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgcG9seW5vbWlhbFBhcmFtcy5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICB9IGVsc2UgewogICAgLy8gY29uc3RhbnQKICAgIGxvd2Vzc1BhcmFtcy5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgcG9seW5vbWlhbFBhcmFtcy5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogIH0KICAKICB1cGRhdGVDdXJyZW50U2V0dGluZ3NEaXNwbGF5KCk7Cn0KCmZ1bmN0aW9uIHVwZGF0ZVJlZ3Jlc3Npb25UeXBlUGFyYW1zKHNraXBDaGFydFVwZGF0ZSkgewogIGNvbnN0IHJlZ3Jlc3Npb25UeXBlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlZ3Jlc3Npb24tdHlwZS1zZWxlY3QiKS52YWx1ZTsKICBjb25zdCBwb2x5bm9taWFsT3JkZXJEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi1wb2x5bm9taWFsLW9yZGVyIik7CiAgY29uc3QgaW5mb1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlZ3Jlc3Npb24taW5mby1wYW5lbCIpOwogIGNvbnN0IGZpdFJlZ3Jlc3Npb25Ub2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZml0LXJlZ3Jlc3Npb24tdG9nZ2xlIik7CiAgCiAgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAicG9seW5vbWlhbCIgJiYgcG9seW5vbWlhbE9yZGVyRGl2KSB7CiAgICBwb2x5bm9taWFsT3JkZXJEaXYuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgfSBlbHNlIGlmIChwb2x5bm9taWFsT3JkZXJEaXYpIHsKICAgIHBvbHlub21pYWxPcmRlckRpdi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogIH0KICAKICAvLyBTaG93L2hpZGUgaW5mbyBwYW5lbCBmb3IgbW9uby1leHBvbmVudGlhbCAob25seSBpZiByZWdyZXNzaW9uIHRvZ2dsZSBpcyBjaGVja2VkKQogIGlmIChpbmZvUGFuZWwpIHsKICAgIGNvbnN0IGlzUmVncmVzc2lvbkVuYWJsZWQgPSBmaXRSZWdyZXNzaW9uVG9nZ2xlICYmIGZpdFJlZ3Jlc3Npb25Ub2dnbGUuY2hlY2tlZDsKICAgIGlmIChyZWdyZXNzaW9uVHlwZSA9PT0gIm1vbm8tZXhwb25lbnRpYWwiICYmIGlzUmVncmVzc2lvbkVuYWJsZWQpIHsKICAgICAgaW5mb1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgfSBlbHNlIHsKICAgICAgaW5mb1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICB9CiAgfQogIAogIHVwZGF0ZUN1cnJlbnRTZXR0aW5nc0Rpc3BsYXkoKTsKICAKICAvLyBVcGRhdGUgY2hhcnQgd2hlbiByZWdyZXNzaW9uIHR5cGUgY2hhbmdlcyAodW5sZXNzIHNraXBwZWQgZm9yIGluaXRpYWxpemF0aW9uKQogIGlmICghc2tpcENoYXJ0VXBkYXRlKSB7CiAgICB1cGRhdGVDaGFydCgpOwogIH0KfQoKZnVuY3Rpb24gdXBkYXRlQ3VycmVudFNldHRpbmdzRGlzcGxheSgpIHsKICBjb25zdCBiYXNlbGluZU1ldGhvZFNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJiYXNlbGluZS1tZXRob2Qtc2VsZWN0Iik7CiAgY29uc3Qgbm9ybWFsaXphdGlvbk1vZGVTZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibm9ybWFsaXphdGlvbi1tb2RlLXNlbGVjdCIpOwogIGNvbnN0IHJlZ3Jlc3Npb25UeXBlU2VsZWN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlZ3Jlc3Npb24tdHlwZS1zZWxlY3QiKTsKICAKICBjb25zdCBiYXNlbGluZU1ldGhvZEVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImN1cnJlbnQtYmFzZWxpbmUtbWV0aG9kIik7CiAgY29uc3Qgbm9ybWFsaXphdGlvbk1vZGVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXJyZW50LW5vcm1hbGl6YXRpb24tbW9kZSIpOwogIGNvbnN0IHJlZ3Jlc3Npb25UeXBlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3VycmVudC1yZWdyZXNzaW9uLXR5cGUiKTsKICAKICBpZiAoYmFzZWxpbmVNZXRob2RFbCAmJiBiYXNlbGluZU1ldGhvZFNlbGVjdCkgewogICAgY29uc3QgbWV0aG9kID0gYmFzZWxpbmVNZXRob2RTZWxlY3QudmFsdWU7CiAgICBiYXNlbGluZU1ldGhvZEVsLnRleHRDb250ZW50ID0gbWV0aG9kLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbWV0aG9kLnNsaWNlKDEpOwogIH0KICAKICBpZiAobm9ybWFsaXphdGlvbk1vZGVFbCAmJiBub3JtYWxpemF0aW9uTW9kZVNlbGVjdCkgewogICAgY29uc3QgbW9kZSA9IG5vcm1hbGl6YXRpb25Nb2RlU2VsZWN0LnZhbHVlOwogICAgbm9ybWFsaXphdGlvbk1vZGVFbC50ZXh0Q29udGVudCA9IG1vZGUgPT09ICJkZWx0YV9mX292ZXJfZiIgPyAizpRGL0YiIDogIk11bHRpcGxpY2F0aXZlIjsKICB9CiAgCiAgaWYgKHJlZ3Jlc3Npb25UeXBlRWwgJiYgcmVncmVzc2lvblR5cGVTZWxlY3QpIHsKICAgIGNvbnN0IHR5cGUgPSByZWdyZXNzaW9uVHlwZVNlbGVjdC52YWx1ZTsKICAgIGNvbnN0IHR5cGVMYWJlbHMgPSB7CiAgICAgICJsaW5lYXIiOiAiTGluZWFyIiwKICAgICAgInBvbHlub21pYWwiOiAiUG9seW5vbWlhbCIsCiAgICAgICJleHBvbmVudGlhbCI6ICJFeHBvbmVudGlhbCIsCiAgICAgICJsb2dhcml0aG1pYyI6ICJMb2dhcml0aG1pYyIsCiAgICAgICJtb25vLWV4cG9uZW50aWFsIjogIk1vbm8tZXhwb25lbnRpYWwgcGxhdGVhdSIKICAgIH07CiAgICByZWdyZXNzaW9uVHlwZUVsLnRleHRDb250ZW50ID0gdHlwZUxhYmVsc1t0eXBlXSB8fCB0eXBlOwogIH0KfQoKZnVuY3Rpb24gcGFyc2VMYWJlbEZvckxlZ2VuZChsYWJlbCkgewogIC8vIFBhcnNlIGxhYmVsIGZvcm1hdDogIkUxNywgRjE3LCBHMTcsIEUxNCwgRzE0IC0gNTAwLTEwLTIgKFBMQ2VfV1RfQ2EpIENvbCAxNyAoNS1wbGljYXRlLCAyIGRhdGFzZXRzLCBtZWFuIMKxIFNFKSIKICAvLyBFeHRyYWN0IG1haW4gaGVhZGluZyAoZS5nLiwgIjUwMC0xMC0yIikgYW5kIHJldHVybiByZXN0IGFzIGRldGFpbHMKICAKICBpZiAoIWxhYmVsKSByZXR1cm4geyBtYWluSGVhZGluZzogbGFiZWwsIGRldGFpbHM6ICIiIH07CiAgCiAgLy8gUGF0dGVybiB0byBtYXRjaDogbnVtYmVyLW51bWJlci1udW1iZXIgKHRoZSBtYWluIGhlYWRpbmcgbGlrZSAiNTAwLTEwLTIiKQogIGNvbnN0IG1haW5IZWFkaW5nTWF0Y2ggPSBsYWJlbC5tYXRjaCgvXGIoXGQrLVxkKy1cZCspXGIvKTsKICAKICBpZiAobWFpbkhlYWRpbmdNYXRjaCkgewogICAgY29uc3QgbWFpbkhlYWRpbmcgPSBtYWluSGVhZGluZ01hdGNoWzFdOwogICAgY29uc3QgbWF0Y2hJbmRleCA9IG1haW5IZWFkaW5nTWF0Y2guaW5kZXg7CiAgICAKICAgIC8vIEdldCBwYXJ0cyBiZWZvcmUgYW5kIGFmdGVyIHRoZSBtYWluIGhlYWRpbmcKICAgIGNvbnN0IGJlZm9yZSA9IGxhYmVsLnN1YnN0cmluZygwLCBtYXRjaEluZGV4KS50cmltKCk7CiAgICBjb25zdCBhZnRlciA9IGxhYmVsLnN1YnN0cmluZyhtYXRjaEluZGV4ICsgbWFpbkhlYWRpbmcubGVuZ3RoKS50cmltKCk7CiAgICAKICAgIC8vIENvbWJpbmUgYmVmb3JlIGFuZCBhZnRlcgogICAgbGV0IGRldGFpbHMgPSAoYmVmb3JlICsgIiAiICsgYWZ0ZXIpLnRyaW0oKTsKICAgIC8vIENsZWFuIHVwIGV4dHJhIHNwYWNlcyBhbmQgZGFzaGVzCiAgICBkZXRhaWxzID0gZGV0YWlscy5yZXBsYWNlKC9ccyotXHMqL2csICIgLSAiKS5yZXBsYWNlKC9ccysvZywgIiAiKS50cmltKCk7CiAgICAvLyBSZW1vdmUgbGVhZGluZy90cmFpbGluZyBkYXNoZXMgYW5kIGNsZWFuIHVwCiAgICBkZXRhaWxzID0gZGV0YWlscy5yZXBsYWNlKC9eLVxzKi8sICIiKS5yZXBsYWNlKC9ccyotJC8sICIiKS50cmltKCk7CiAgICAKICAgIHJldHVybiB7IG1haW5IZWFkaW5nOiBtYWluSGVhZGluZywgZGV0YWlsczogZGV0YWlscyB9OwogIH0KICAKICAvLyBJZiBubyBwYXR0ZXJuIG1hdGNoLCByZXR1cm4gb3JpZ2luYWwgYXMgbWFpbiBoZWFkaW5nCiAgcmV0dXJuIHsgbWFpbkhlYWRpbmc6IGxhYmVsLCBkZXRhaWxzOiAiIiB9Owp9CgpmdW5jdGlvbiB1cGRhdGVNb25vRXhwb25lbnRpYWxJbmZvUGFuZWwobW9ub0V4cFBhcmFtcykgewogIGNvbnN0IGluZm9QYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZWdyZXNzaW9uLWluZm8tcGFuZWwiKTsKICBjb25zdCBpbmZvQ29udGVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZWdyZXNzaW9uLWluZm8tY29udGVudCIpOwogIAogIGlmICghaW5mb1BhbmVsIHx8ICFpbmZvQ29udGVudCkgewogICAgcmV0dXJuOwogIH0KICAKICBpZiAobW9ub0V4cFBhcmFtcy5sZW5ndGggPT09IDApIHsKICAgIGluZm9Db250ZW50LmlubmVySFRNTCA9ICI8ZGl2IHN0eWxlPSdjb2xvcjogIzY2NjsnPk5vIGZpdHMgYXZhaWxhYmxlLiBTZWxlY3Qgd2VsbHMgYW5kIGVuYWJsZSByZWdyZXNzaW9uLjwvZGl2PiI7CiAgICByZXR1cm47CiAgfQogIAogIC8vIEJ1aWxkIEhUTUwgZm9yIHBhcmFtZXRlcnMKICBsZXQgaHRtbCA9ICIiOwogIAogIC8vIE1vZGVsIGVxdWF0aW9uCiAgaHRtbCArPSAiPGRpdiBzdHlsZT0nbWFyZ2luLWJvdHRvbTogOHB4OyBwYWRkaW5nOiA0cHg7IGJhY2tncm91bmQ6IHdoaXRlOyBib3JkZXItcmFkaXVzOiAycHg7Jz4iOwogIGh0bWwgKz0gIjxzdHJvbmc+TW9kZWw6PC9zdHJvbmc+IHkodCkgPSAxICsgQSgxIC0gZTxzdXA+LWsodC104oKAKTwvc3VwPikiOwogIGh0bWwgKz0gIjwvZGl2PiI7CiAgCiAgLy8gUGFyYW1ldGVycyBmb3IgZWFjaCBmaXQKICBtb25vRXhwUGFyYW1zLmZvckVhY2goKGZpdCwgaWR4KSA9PiB7CiAgICBjb25zdCBwID0gZml0LnBhcmFtczsKICAgIGNvbnN0IGJvcmRlckNvbG9yID0gZml0LmNvbG9yIHx8ICcjMmE2Y2ZmJzsgLy8gVXNlIGRhdGFzZXQgY29sb3Igb3IgZGVmYXVsdCBibHVlCiAgICAKICAgIC8vIFBhcnNlIGxhYmVsIHRvIGV4dHJhY3QgbWFpbiBoZWFkaW5nIGFuZCBkZXRhaWxzCiAgICBjb25zdCBwYXJzZWQgPSBwYXJzZUxhYmVsRm9yTGVnZW5kKGZpdC5sYWJlbCk7CiAgICAKICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9J21hcmdpbi1ib3R0b206IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogd2hpdGU7IGJvcmRlci1yYWRpdXM6IDJweDsgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCAke2JvcmRlckNvbG9yfTsnPmA7CiAgICAKICAgIC8vIE1haW4gaGVhZGluZyBpbiBjYXJkIGNvbG9yCiAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSdjb2xvcjogJHtib3JkZXJDb2xvcn07IGZvbnQtd2VpZ2h0OiA2MDA7IGZvbnQtc2l6ZTogMC45cmVtOyBtYXJnaW4tYm90dG9tOiA0cHg7Jz4ke3BhcnNlZC5tYWluSGVhZGluZ308L2Rpdj5gOwogICAgCiAgICAvLyBEZXRhaWxzIGluIGdyYXkgYmVsb3cKICAgIGlmIChwYXJzZWQuZGV0YWlscykgewogICAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSdjb2xvcjogIzY2NjsgZm9udC1zaXplOiAwLjdyZW07IG1hcmdpbi1ib3R0b206IDhweDsgbGluZS1oZWlnaHQ6IDEuMzsnPiR7cGFyc2VkLmRldGFpbHN9PC9kaXY+YDsKICAgIH0KICAgIAogICAgLy8gUGFyYW1ldGVycyBncmlkCiAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSdkaXNwbGF5OiBncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmciAxZnI7IGdhcDogNHB4OyBmb250LXNpemU6IDAuN3JlbTsgbWFyZ2luLXRvcDogOHB4Oyc+YDsKICAgIAogICAgLy8gTGVmdCBjb2x1bW4KICAgIGh0bWwgKz0gYDxkaXY+PHN0cm9uZz5BIChhbXBsaXR1ZGUpOjwvc3Ryb25nPiAke3AuQS50b0ZpeGVkKDQpfTwvZGl2PmA7CiAgICBodG1sICs9IGA8ZGl2PjxzdHJvbmc+ayAocmF0ZSBjb25zdGFudCk6PC9zdHJvbmc+ICR7cC5rLnRvRml4ZWQoNil9IHPigbvCuTwvZGl2PmA7CiAgICBodG1sICs9IGA8ZGl2PjxzdHJvbmc+z4QgKHRpbWUgY29uc3RhbnQpOjwvc3Ryb25nPiAke3AudGF1LnRvRml4ZWQoMil9IHM8L2Rpdj5gOwogICAgCiAgICAvLyBSaWdodCBjb2x1bW4KICAgIGh0bWwgKz0gYDxkaXY+PHN0cm9uZz504oKAIChzdGFydCB0aW1lKTo8L3N0cm9uZz4gJHtwLnQwLnRvRml4ZWQoMil9IHM8L2Rpdj5gOwogICAgaHRtbCArPSBgPGRpdj48c3Ryb25nPnTigoEv4oKCIChoYWxmLXRpbWUpOjwvc3Ryb25nPiAke3AudEhhbGYudG9GaXhlZCgyKX0gczwvZGl2PmA7CiAgICBodG1sICs9IGA8ZGl2PjxzdHJvbmc+UGxhdGVhdTo8L3N0cm9uZz4gJHtwLnBsYXRlYXUudG9GaXhlZCg0KX08L2Rpdj5gOwogICAgCiAgICBodG1sICs9IGA8L2Rpdj48L2Rpdj5gOwogIH0pOwogIAogIGluZm9Db250ZW50LmlubmVySFRNTCA9IGh0bWw7Cn0KCmZ1bmN0aW9uIHJlbmRlcldlbGxTZWxlY3RvckdyaWQoKSB7CiAgY29uc3QgZ3JpZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ3ZWxsLXNlbGVjdG9yLWdyaWQiKTsKICBpZiAoIWdyaWQgfHwgc2VsZWN0ZWREYXRhc2V0SWRzLnNpemUgPT09IDApIHsKICAgIHJldHVybjsKICB9CiAgCiAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICBpZiAoc2VsZWN0ZWREYXRhc2V0cy5sZW5ndGggPT09IDApIHsKICAgIGdyaWQuaW5uZXJIVE1MID0gIjxkaXYgc3R5bGU9J2NvbG9yOiAjNjY2OyBmb250LXNpemU6IDAuOHJlbTsgcGFkZGluZzogOHB4Oyc+Tm8gZGF0YXNldHMgc2VsZWN0ZWQuPC9kaXY+IjsKICAgIHJldHVybjsKICB9CiAgCiAgZ3JpZC5pbm5lckhUTUwgPSAiIjsKICAKICAvLyBDb2xsZWN0IGFsbCB1bmlxdWUgd2VsbCBJRHMgZnJvbSBzZWxlY3RlZCBkYXRhc2V0cwogIGNvbnN0IGFsbFdlbGxzU2V0ID0gbmV3IFNldCgpOwogIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgT2JqZWN0LmtleXMod2VsbHMpLmZvckVhY2god2VsbElkID0+IHsKICAgICAgYWxsV2VsbHNTZXQuYWRkKHdlbGxJZCk7CiAgICB9KTsKICB9KTsKICAKICAvLyBUb3AtbGVmdCBjb3JuZXIKICBjb25zdCBjb3JuZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICBjb3JuZXIuY2xhc3NOYW1lID0gIndlbGwtc2VsZWN0b3ItaGVhZGVyIjsKICBncmlkLmFwcGVuZENoaWxkKGNvcm5lcik7CiAgCiAgLy8gQ29sdW1uIGhlYWRlcnMKICBmb3IgKGxldCBjID0gMTsgYyA8PSBQTEFURV9DT0xTOyBjKyspIHsKICAgIGNvbnN0IGhlYWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgaGVhZGVyLmNsYXNzTmFtZSA9ICJ3ZWxsLXNlbGVjdG9yLWhlYWRlciI7CiAgICBoZWFkZXIudGV4dENvbnRlbnQgPSBjOwogICAgZ3JpZC5hcHBlbmRDaGlsZChoZWFkZXIpOwogIH0KICAKICAvLyBSb3dzCiAgUExBVEVfUk9XUy5mb3JFYWNoKHJvd0xldHRlciA9PiB7CiAgICAvLyBSb3cgbGFiZWwKICAgIGNvbnN0IHJvd0xhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICByb3dMYWJlbC5jbGFzc05hbWUgPSAid2VsbC1zZWxlY3Rvci1oZWFkZXIiOwogICAgcm93TGFiZWwudGV4dENvbnRlbnQgPSByb3dMZXR0ZXI7CiAgICBncmlkLmFwcGVuZENoaWxkKHJvd0xhYmVsKTsKICAgIAogICAgLy8gV2VsbHMKICAgIGZvciAobGV0IGNvbCA9IDE7IGNvbCA8PSBQTEFURV9DT0xTOyBjb2wrKykgewogICAgICBjb25zdCB3ZWxsSWQgPSByb3dMZXR0ZXIgKyBTdHJpbmcoY29sKTsKICAgICAgY29uc3Qgbm9ybWFsaXplZFdlbGxJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpOwogICAgICBjb25zdCBjZWxsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGNlbGwuY2xhc3NOYW1lID0gIndlbGwtc2VsZWN0b3ItY2VsbCI7CiAgICAgIAogICAgICAvLyBDaGVjayBmb3IgZGF0YSB1c2luZyBub3JtYWxpemVkIElEIChzaW5jZSBhbGxXZWxsc0RhdGEgY29udGFpbnMgbm9ybWFsaXplZCBJRHMpCiAgICAgIGNvbnN0IGhhc0RhdGEgPSBhbGxXZWxsc1NldC5oYXMobm9ybWFsaXplZFdlbGxJZCkgfHwgYWxsV2VsbHNTZXQuaGFzKHdlbGxJZCk7CiAgICAgIC8vIENoZWNrIGV4Y2x1c2lvbiB1c2luZyBib3RoIG5vcm1hbGl6ZWQgYW5kIG5vbi1ub3JtYWxpemVkIElEcwogICAgICBjb25zdCBpc0V4Y2x1ZGVkID0gZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKG5vcm1hbGl6ZWRXZWxsSWQpICYmICFlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCk7CiAgICAgIAogICAgICBpZiAoaGFzRGF0YSkgewogICAgICAgIGNlbGwuY2xhc3NMaXN0LmFkZCgiaGFzLWRhdGEiKTsKICAgICAgICBpZiAoaXNFeGNsdWRlZCkgewogICAgICAgICAgLy8gVXNlIGlubGluZSBzdHlsZXMgd2l0aCByZ2IgdG8gYXZvaWQgaGV4IGVzY2FwaW5nIGlzc3VlcwogICAgICAgICAgY2VsbC5zdHlsZS5iYWNrZ3JvdW5kID0gInJnYigyNTUsIDIwNCwgMjA0KSI7CiAgICAgICAgICBjZWxsLnN0eWxlLmJvcmRlckNvbG9yID0gInJnYigyNTUsIDEwNywgMTA3KSI7CiAgICAgICAgICBjZWxsLnN0eWxlLmNvbG9yID0gInJnYigyMDQsIDAsIDApIjsKICAgICAgICAgIGNlbGwuc3R5bGUuZm9udFdlaWdodCA9ICJib2xkIjsKICAgICAgICAgIGNlbGwudGV4dENvbnRlbnQgPSAi4pyVIjsKICAgICAgICAgIGNlbGwudGl0bGUgPSBgV2VsbCAke3dlbGxJZH0gLSBFWENMVURFRCAoY2xpY2sgdG8gaW5jbHVkZSlgOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjZWxsLnRleHRDb250ZW50ID0gY29sOwogICAgICAgICAgY2VsbC50aXRsZSA9IGBXZWxsICR7d2VsbElkfSAtIENsaWNrIHRvIGV4Y2x1ZGVgOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBjZWxsLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgKCkgPT4gewogICAgICAgICAgdG9nZ2xlV2VsbEV4Y2x1c2lvbihub3JtYWxpemVkV2VsbElkKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjZWxsLnN0eWxlLmJhY2tncm91bmQgPSAiI2YyZjJmMiI7CiAgICAgICAgY2VsbC5zdHlsZS5jdXJzb3IgPSAiZGVmYXVsdCI7CiAgICAgICAgY2VsbC5zdHlsZS5vcGFjaXR5ID0gIjAuNSI7CiAgICAgIH0KICAgICAgCiAgICAgIGdyaWQuYXBwZW5kQ2hpbGQoY2VsbCk7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIHRvZ2dsZVdlbGxFeGNsdXNpb24od2VsbElkKSB7CiAgLy8gTm9ybWFsaXplIHRoZSBpbmNvbWluZyB3ZWxsIElEIHRvIGVuc3VyZSBjb25zaXN0ZW50IGNvbXBhcmlzb24KICAvLyB3ZWxsSWQgbWF5IGFscmVhZHkgYmUgbm9ybWFsaXplZCwgYnV0IG5vcm1hbGl6ZSBpdCB0byBiZSBzYWZlCiAgY29uc3Qgbm9ybWFsaXplZFdlbGxJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpOwogIAogIGlmIChlbmFibGVkV2VsbHMuc2l6ZSA9PT0gMCkgewogICAgLy8gSWYgbm8gZXhjbHVzaW9ucyB5ZXQsIGZpcnN0IGNvbGxlY3QgYWxsIGF2YWlsYWJsZSB3ZWxscwogICAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICAgIGNvbnN0IGFsbFdlbGxzU2V0ID0gbmV3IFNldCgpOwogICAgc2VsZWN0ZWREYXRhc2V0cy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgICAgT2JqZWN0LmtleXMod2VsbHMpLmZvckVhY2god0lkID0+IHsKICAgICAgICAvLyBBbGwgd2VsbCBJRHMgaW4gYWxsV2VsbHNEYXRhIGFyZSBhbHJlYWR5IG5vcm1hbGl6ZWQsIGJ1dCBub3JtYWxpemUgdG8gYmUgc2FmZQogICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRXSWQgPSBub3JtYWxpemVXZWxsSWQod0lkKTsKICAgICAgICBhbGxXZWxsc1NldC5hZGQobm9ybWFsaXplZFdJZCk7CiAgICAgIH0pOwogICAgfSk7CiAgICAvLyBFbmFibGUgYWxsIGV4Y2VwdCB0aGUgb25lIGJlaW5nIGNsaWNrZWQgKHVzaW5nIG5vcm1hbGl6ZWQgSUQpCiAgICBhbGxXZWxsc1NldC5mb3JFYWNoKHdJZCA9PiB7CiAgICAgIGlmICh3SWQgIT09IG5vcm1hbGl6ZWRXZWxsSWQpIHsKICAgICAgICBlbmFibGVkV2VsbHMuYWRkKHdJZCk7CiAgICAgIH0KICAgIH0pOwogIH0gZWxzZSB7CiAgICAvLyBUb2dnbGUgdGhpcyBzcGVjaWZpYyB3ZWxsIChjaGVjayBib3RoIG5vcm1hbGl6ZWQgYW5kIG5vbi1ub3JtYWxpemVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5KQogICAgY29uc3QgaGFzTm9ybWFsaXplZCA9IGVuYWJsZWRXZWxscy5oYXMobm9ybWFsaXplZFdlbGxJZCk7CiAgICBjb25zdCBoYXNPcmlnaW5hbCA9IGVuYWJsZWRXZWxscy5oYXMod2VsbElkKTsKICAgIAogICAgaWYgKGhhc05vcm1hbGl6ZWQgfHwgaGFzT3JpZ2luYWwpIHsKICAgICAgLy8gUmVtb3ZlIGJvdGggbm9ybWFsaXplZCBhbmQgbm9uLW5vcm1hbGl6ZWQgdmVyc2lvbnMgaWYgcHJlc2VudAogICAgICBlbmFibGVkV2VsbHMuZGVsZXRlKG5vcm1hbGl6ZWRXZWxsSWQpOwogICAgICBlbmFibGVkV2VsbHMuZGVsZXRlKHdlbGxJZCk7CiAgICB9IGVsc2UgewogICAgICAvLyBBZGQgbm9ybWFsaXplZCB2ZXJzaW9uCiAgICAgIGVuYWJsZWRXZWxscy5hZGQobm9ybWFsaXplZFdlbGxJZCk7CiAgICB9CiAgICAKICAgIC8vIElmIGFsbCB3ZWxscyBhcmUgZW5hYmxlZCwgY2xlYXIgdGhlIHNldCAobWVhbmluZyBhbGwgYXJlIGVuYWJsZWQpCiAgICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogICAgY29uc3QgYWxsV2VsbHNTZXQgPSBuZXcgU2V0KCk7CiAgICBzZWxlY3RlZERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICBPYmplY3Qua2V5cyh3ZWxscykuZm9yRWFjaCh3SWQgPT4gewogICAgICAgIC8vIE5vcm1hbGl6ZSBhbGwgd2VsbCBJRHMgZm9yIGNvbnNpc3RlbnQgY29tcGFyaXNvbgogICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRXSWQgPSBub3JtYWxpemVXZWxsSWQod0lkKTsKICAgICAgICBhbGxXZWxsc1NldC5hZGQobm9ybWFsaXplZFdJZCk7CiAgICAgIH0pOwogICAgfSk7CiAgICAKICAgIC8vIENoZWNrIGlmIGFsbCB3ZWxscyBhcmUgZW5hYmxlZCAoY2hlY2sgYm90aCBub3JtYWxpemVkIGFuZCBub24tbm9ybWFsaXplZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSkKICAgIGxldCBhbGxFbmFibGVkID0gdHJ1ZTsKICAgIGFsbFdlbGxzU2V0LmZvckVhY2gobm9ybWFsaXplZFdJZCA9PiB7CiAgICAgIC8vIENoZWNrIGJvdGggbm9ybWFsaXplZCBhbmQgb3JpZ2luYWwgZm9ybWF0CiAgICAgIGNvbnN0IG9yaWdpbmFsV0lkID0gbm9ybWFsaXplZFdJZC5yZXBsYWNlKC9eKFtBLVpdKShcZHsyfSkkLywgKG1hdGNoLCByb3csIGNvbCkgPT4gewogICAgICAgIGNvbnN0IGNvbE51bSA9IHBhcnNlSW50KGNvbCk7CiAgICAgICAgcmV0dXJuIHJvdyArIFN0cmluZyhjb2xOdW0pOwogICAgICB9KTsKICAgICAgaWYgKCFlbmFibGVkV2VsbHMuaGFzKG5vcm1hbGl6ZWRXSWQpICYmICFlbmFibGVkV2VsbHMuaGFzKG9yaWdpbmFsV0lkKSkgewogICAgICAgIGFsbEVuYWJsZWQgPSBmYWxzZTsKICAgICAgfQogICAgfSk7CiAgICAKICAgIGlmIChhbGxFbmFibGVkKSB7CiAgICAgIGVuYWJsZWRXZWxscy5jbGVhcigpOyAvLyBDbGVhciBtZWFucyBhbGwgZW5hYmxlZAogICAgfQogIH0KICAKICByZW5kZXJXZWxsU2VsZWN0b3JHcmlkKCk7CiAgcmVuZGVyUGxhdGVHcmlkKCk7CiAgdXBkYXRlV2VsbEluZm8oKTsKfQoKZnVuY3Rpb24gZ2V0QWxsRGF0YXNldHNJbkdyb3VwKCkgewogIC8vIEdldCBhbGwgZGF0YXNldHMgaW4gdGhlIHNlbGVjdGVkIGdyb3VwcyAoYmVmb3JlIGZpbHRlcmluZyBieSBlbmFibGVkRGF0YXNldHMpCiAgaWYgKHNlbGVjdGVkRGF0YXNldElkcy5zaXplID09PSAwKSB7CiAgICByZXR1cm4gW107CiAgfQogIAogIGxldCBkYXRhc2V0cyA9IFtdOwogIAogIHNlbGVjdGVkRGF0YXNldElkcy5mb3JFYWNoKGdyb3VwSWQgPT4gewogICAgaWYgKGdyb3VwSWQuc3RhcnRzV2l0aCgiZ3JvdXA6IikpIHsKICAgICAgY29uc3QgZ3JvdXBOYW1lID0gZ3JvdXBJZC5zdWJzdHJpbmcoNik7CiAgICAgIGNvbnN0IHNlbGVjdGVkUGxhdGVzID0gdmlld2VyRGF0YS5wbGF0ZXMuZmlsdGVyKHAgPT4gcC5jb2x1bW5fZ3JvdXAgPT09IGdyb3VwTmFtZSk7CiAgICAgIGRhdGFzZXRzLnB1c2goLi4uc2VsZWN0ZWRQbGF0ZXMubWFwKHAgPT4gcC5pZCkpOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgcGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gZ3JvdXBJZCk7CiAgICAgIGlmIChwbGF0ZSkgewogICAgICAgIGRhdGFzZXRzLnB1c2goZ3JvdXBJZCk7CiAgICAgIH0KICAgIH0KICB9KTsKICAKICAvLyBSZW1vdmUgZHVwbGljYXRlcwogIHJldHVybiBbLi4ubmV3IFNldChkYXRhc2V0cyldOwp9CgpmdW5jdGlvbiBpbml0aWFsaXplVHJpcGxpY2F0ZUdyb3VwQ29sb3JzKCkgewogIC8vIEluaXRpYWxpemUgY29sb3IgbWFwIGlmIG5lZWRlZCAoZG9uJ3QgcmVzZXQgLSBrZWVwIGNvbnNpc3RlbnQgY29sb3JzKQogIC8vIFRoaXMgZW5zdXJlcyBhbGwgd2VsbHMgd2l0aCB0aGUgc2FtZSBncm91cCBuYW1lIGdldCB0aGUgc2FtZSBjb2xvcgogIC8vIEZvciBleGFtcGxlLCBhbGwgd2VsbHMgaW4gcm93cyBCLCBDLCBEIHdpdGggZ3JvdXAgbmFtZSAiMjUwLTEwLTIiIGdldCB0aGUgc2FtZSBjb2xvcgogIGlmIChPYmplY3Qua2V5cyh0cmlwbGljYXRlR3JvdXBDb2xvck1hcCkubGVuZ3RoID09PSAwICYmIHZpZXdlckRhdGEgJiYgdmlld2VyRGF0YS5jb25maWcpIHsKICAgIGNvbnN0IGdyb3VwcyA9IHZpZXdlckRhdGEuY29uZmlnLmdyb3VwcyB8fCBbXTsKICAgIGxldCBjb2xvckluZGV4ID0gMDsKICAgIGdyb3Vwcy5mb3JFYWNoKGdyb3VwID0+IHsKICAgICAgY29uc3QgbmFtZSA9IFN0cmluZyhncm91cC5uYW1lIHx8ICIiKS50cmltKCk7CiAgICAgIGlmIChuYW1lICYmICF0cmlwbGljYXRlR3JvdXBDb2xvck1hcFtuYW1lXSkgewogICAgICAgIHRyaXBsaWNhdGVHcm91cENvbG9yTWFwW25hbWVdID0gVFJJUExJQ0FURV9DT0xPUlNbY29sb3JJbmRleCAlJSBUUklQTElDQVRFX0NPTE9SUy5sZW5ndGhdOwogICAgICAgIGNvbG9ySW5kZXgrKzsKICAgICAgfQogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiByZW5kZXJQbGF0ZUdyaWQoKSB7CiAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInBsYXRlLWdyaWRzLWNvbnRhaW5lciIpOwogIGNvbnRhaW5lci5pbm5lckhUTUwgPSAiIjsKICAKICAvLyBTZXQgdXAgaG9yaXpvbnRhbCBzY3JvbGxpbmcgY29udGFpbmVyCiAgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgY29udGFpbmVyLnN0eWxlLmZsZXhEaXJlY3Rpb24gPSAicm93IjsKICBjb250YWluZXIuc3R5bGUub3ZlcmZsb3dYID0gImF1dG8iOwogIGNvbnRhaW5lci5zdHlsZS5vdmVyZmxvd1kgPSAiaGlkZGVuIjsKICBjb250YWluZXIuc3R5bGUuc2Nyb2xsU25hcFR5cGUgPSAieCBtYW5kYXRvcnkiOwogIGNvbnRhaW5lci5zdHlsZS5zY3JvbGxQYWRkaW5nTGVmdCA9ICIxNnB4IjsKICBjb250YWluZXIuc3R5bGUuc2Nyb2xsUGFkZGluZ1JpZ2h0ID0gIjE2cHgiOwogIGNvbnRhaW5lci5zdHlsZS5zY3JvbGxCZWhhdmlvciA9ICJzbW9vdGgiOwogIGNvbnRhaW5lci5zdHlsZS5nYXAgPSAiMjRweCI7CiAgY29udGFpbmVyLnN0eWxlLnBhZGRpbmdCb3R0b20gPSAiNTBweCI7IC8vIFNwYWNlIGZvciBpbmRpY2F0b3JzCiAgY29udGFpbmVyLnN0eWxlLnBhZGRpbmdMZWZ0ID0gIjE2cHgiOwogIGNvbnRhaW5lci5zdHlsZS5wYWRkaW5nUmlnaHQgPSAiMTZweCI7CiAgY29udGFpbmVyLnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKICBjb250YWluZXIuc3R5bGUud2lkdGggPSAiMTAwJSUiOwogIGNvbnRhaW5lci5zdHlsZS5oZWlnaHQgPSAiYXV0byI7CiAgCiAgLy8gU3R5bGUgdGhlIHNjcm9sbGJhcgogIGNvbnRhaW5lci5zdHlsZS5zY3JvbGxiYXJXaWR0aCA9ICJ0aGluIjsKICBjb250YWluZXIuc3R5bGUuc2Nyb2xsYmFyQ29sb3IgPSAiI2NjYyB0cmFuc3BhcmVudCI7CiAgCiAgLy8gSW5pdGlhbGl6ZSBjb2xvciBtYXAgaWYgbmVlZGVkIChkb24ndCByZXNldCAtIGtlZXAgY29uc2lzdGVudCBjb2xvcnMpCiAgLy8gVGhpcyBlbnN1cmVzIGFsbCB3ZWxscyB3aXRoIHRoZSBzYW1lIGdyb3VwIG5hbWUgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgaWYgKE9iamVjdC5rZXlzKHRyaXBsaWNhdGVHcm91cENvbG9yTWFwKS5sZW5ndGggPT09IDApIHsKICAgIGluaXRpYWxpemVUcmlwbGljYXRlR3JvdXBDb2xvcnMoKTsKICB9CgogIGNvbnN0IHNlbGVjdGVkRGF0YXNldHMgPSBnZXRTZWxlY3RlZERhdGFzZXRzKCk7CiAgY29uc3QgYWxsR3JvdXBEYXRhc2V0cyA9IGdldEFsbERhdGFzZXRzSW5Hcm91cCgpOwogIAogIC8vIEdyb3VwIHBsYXRlcyBieSBzY2llbnRpc3QgaW5pdGlhbHMKICBjb25zdCBwbGF0ZXNCeVNjaWVudGlzdCA9IHt9OyAvLyBzY2llbnRpc3QgLT4gW3BsYXRlSWRzXQogIGFsbEdyb3VwRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgIGNvbnN0IHBsYXRlID0gdmlld2VyRGF0YS5wbGF0ZXMuZmluZChwID0+IHAuaWQgPT09IHBsYXRlSWQpOwogICAgaWYgKCFwbGF0ZSB8fCAhcGxhdGUuY29sdW1uX2luZm8pIHJldHVybjsKICAgIGNvbnN0IHNjaWVudGlzdCA9IHBsYXRlLmNvbHVtbl9pbmZvLnNjaWVudGlzdCB8fCAiIjsKICAgIGlmICghcGxhdGVzQnlTY2llbnRpc3Rbc2NpZW50aXN0XSkgewogICAgICBwbGF0ZXNCeVNjaWVudGlzdFtzY2llbnRpc3RdID0gW107CiAgICB9CiAgICBwbGF0ZXNCeVNjaWVudGlzdFtzY2llbnRpc3RdLnB1c2gocGxhdGVJZCk7CiAgfSk7CiAgCiAgLy8gU29ydCBzY2llbnRpc3RzIGJ5IGluaXRpYWxzIChlbXB0eSBzY2llbnRpc3QgZ29lcyBsYXN0KQogIGNvbnN0IHNvcnRlZFNjaWVudGlzdHMgPSBPYmplY3Qua2V5cyhwbGF0ZXNCeVNjaWVudGlzdCkuc29ydCgoYSwgYikgPT4gewogICAgaWYgKGEgPT09ICIiKSByZXR1cm4gMTsKICAgIGlmIChiID09PSAiIikgcmV0dXJuIC0xOwogICAgcmV0dXJuIGEubG9jYWxlQ29tcGFyZShiKTsKICB9KTsKICAKICAvLyBCdWlsZCBjb2x1bW4gaW5mbyBtYXA6IGNvbHVtbiAtPiB7IGdlbm90eXBlLCBidWZmZXIsIHNjaWVudGlzdCB9CiAgLy8gVXNlIGFsbCBkYXRhc2V0cyBpbiBncm91cCB0byBzaG93IGFsbCBhdmFpbGFibGUgY29sdW1uIGdyb3VwcwogIGNvbnN0IGNvbHVtbkluZm9NYXAgPSB7fTsgLy8gY29sdW1uIC0+IHsgZ2Vub3R5cGUsIGJ1ZmZlciwgc2NpZW50aXN0IH0KICAKICBhbGxHcm91cERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICBjb25zdCBwbGF0ZSA9IHZpZXdlckRhdGEucGxhdGVzLmZpbmQocCA9PiBwLmlkID09PSBwbGF0ZUlkKTsKICAgIGlmICghcGxhdGUgfHwgIXBsYXRlLmNvbHVtbl9pbmZvKSByZXR1cm47CiAgICAKICAgIGNvbnN0IGNvbHVtbkluZm8gPSBwbGF0ZS5jb2x1bW5faW5mbzsKICAgIC8vIEZpbmQgd2hpY2ggY29sdW1ucyBoYXZlIGRhdGEgZm9yIHRoaXMgcGxhdGUKICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgT2JqZWN0LmtleXMod2VsbHMpLmZvckVhY2god2VsbElkID0+IHsKICAgICAgY29uc3QgY29sID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgICBpZiAoIWNvbHVtbkluZm9NYXBbY29sXSkgewogICAgICAgIGNvbHVtbkluZm9NYXBbY29sXSA9IHsKICAgICAgICAgIGdlbm90eXBlOiBjb2x1bW5JbmZvLmdlbm90eXBlIHx8ICIiLAogICAgICAgICAgYnVmZmVyOiBjb2x1bW5JbmZvLmJ1ZmZlciB8fCAiIiwKICAgICAgICAgIHNjaWVudGlzdDogY29sdW1uSW5mby5zY2llbnRpc3QgfHwgIiIKICAgICAgICB9OwogICAgICB9CiAgICB9KTsKICB9KTsKICAKICAvLyBSZW5kZXIgYSBzZXBhcmF0ZSBncmlkIGZvciBlYWNoIHNjaWVudGlzdAogIGNvbnN0IHBsYXRlQ29udGFpbmVycyA9IFtdOwogIHNvcnRlZFNjaWVudGlzdHMuZm9yRWFjaCgoc2NpZW50aXN0LCBpbmRleCkgPT4gewogICAgY29uc3Qgc2NpZW50aXN0UGxhdGVJZHMgPSBwbGF0ZXNCeVNjaWVudGlzdFtzY2llbnRpc3RdOwogICAgY29uc3Qgc2NpZW50aXN0RGF0YXNldHMgPSBzZWxlY3RlZERhdGFzZXRzLmZpbHRlcihpZCA9PiBzY2llbnRpc3RQbGF0ZUlkcy5pbmNsdWRlcyhpZCkpOwogICAgCiAgICAvLyBDcmVhdGUgY29udGFpbmVyIGZvciB0aGlzIHNjaWVudGlzdCdzIGdyaWQgd2l0aCBzY3JvbGwgc25hcAogICAgY29uc3Qgc2NpZW50aXN0Q29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBzY2llbnRpc3RDb250YWluZXIuc3R5bGUuZmxleFNocmluayA9ICIwIjsKICAgIC8vIFVzZSB2aWV3cG9ydCB3aWR0aCBtaW51cyBhcHByb3hpbWF0ZSBzaWRlYmFyIHdpZHRoLCB3aXRoIG1pbi9tYXggY29uc3RyYWludHMKICAgIHNjaWVudGlzdENvbnRhaW5lci5zdHlsZS53aWR0aCA9ICJtaW4oY2FsYygxMDB2dyAtIDM1MHB4KSwgMTIwMHB4KSI7CiAgICBzY2llbnRpc3RDb250YWluZXIuc3R5bGUubWluV2lkdGggPSAiODAwcHgiOwogICAgc2NpZW50aXN0Q29udGFpbmVyLnN0eWxlLnNjcm9sbFNuYXBBbGlnbiA9ICJzdGFydCI7CiAgICBzY2llbnRpc3RDb250YWluZXIuc3R5bGUuc2Nyb2xsU25hcFN0b3AgPSAiYWx3YXlzIjsKICAgIHNjaWVudGlzdENvbnRhaW5lci5zdHlsZS5wYWRkaW5nTGVmdCA9ICIxNnB4IjsKICAgIHNjaWVudGlzdENvbnRhaW5lci5zdHlsZS5wYWRkaW5nUmlnaHQgPSAiMTZweCI7CiAgICBzY2llbnRpc3RDb250YWluZXIuc3R5bGUuYm94U2l6aW5nID0gImJvcmRlci1ib3giOwogICAgc2NpZW50aXN0Q29udGFpbmVyLmRhdGFzZXQuc2NpZW50aXN0SW5kZXggPSBpbmRleDsKICAgIAogICAgLy8gQWRkIHNjaWVudGlzdCBsYWJlbAogICAgY29uc3Qgc2NpZW50aXN0TGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIHNjaWVudGlzdExhYmVsLnN0eWxlLmZvbnRTaXplID0gIjEuMXJlbSI7CiAgICBzY2llbnRpc3RMYWJlbC5zdHlsZS5mb250V2VpZ2h0ID0gIjYwMCI7CiAgICBzY2llbnRpc3RMYWJlbC5zdHlsZS5tYXJnaW5Cb3R0b20gPSAiOHB4IjsKICAgIHNjaWVudGlzdExhYmVsLnN0eWxlLmNvbG9yID0gIiMzMzMiOwogICAgc2NpZW50aXN0TGFiZWwudGV4dENvbnRlbnQgPSBzY2llbnRpc3QgfHwgIk5vIFNjaWVudGlzdCI7CiAgICBzY2llbnRpc3RDb250YWluZXIuYXBwZW5kQ2hpbGQoc2NpZW50aXN0TGFiZWwpOwogICAgCiAgICAvLyBDcmVhdGUgZ3JpZCBmb3IgdGhpcyBzY2llbnRpc3QKICAgIGNvbnN0IGdyaWQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGdyaWQuaWQgPSBgcGxhdGUtZ3JpZC0ke3NjaWVudGlzdCB8fCAibm9uZSJ9YDsKICAgIGdyaWQuY2xhc3NOYW1lID0gInBsYXRlLWdyaWQiOwogICAgZ3JpZC5zdHlsZS5kaXNwbGF5ID0gImdyaWQiOwogICAgZ3JpZC5zdHlsZS5ncmlkVGVtcGxhdGVDb2x1bW5zID0gYGF1dG8gcmVwZWF0KCR7UExBVEVfQ09MU30sIDFmcilgOwogICAgZ3JpZC5zdHlsZS5ncmlkQXV0b1Jvd3MgPSAiMzJweCI7CiAgICBncmlkLnN0eWxlLmdhcCA9ICIycHgiOwogICAgZ3JpZC5zdHlsZS5mb250U2l6ZSA9ICIxMXB4IjsKICAgIGdyaWQuc3R5bGUubWFyZ2luQm90dG9tID0gIjE2cHgiOwogICAgCiAgICBzY2llbnRpc3RDb250YWluZXIuYXBwZW5kQ2hpbGQoZ3JpZCk7CiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoc2NpZW50aXN0Q29udGFpbmVyKTsKICAgIHBsYXRlQ29udGFpbmVycy5wdXNoKHNjaWVudGlzdENvbnRhaW5lcik7CgogICAgLy8gVG9wLWxlZnQgYmxhbmsKICAgIGNvbnN0IGNvcm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgY29ybmVyLmNsYXNzTmFtZSA9ICJncmlkLWhlYWRlciI7CiAgICBncmlkLmFwcGVuZENoaWxkKGNvcm5lcik7CgogICAgLy8gQ29sdW1uIG51bWJlciBsYWJlbHMKICAgIGZvciAobGV0IGMgPSAxOyBjIDw9IFBMQVRFX0NPTFM7IGMrKykgewogICAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgZGl2LmNsYXNzTmFtZSA9ICJncmlkLWhlYWRlciBjb2wtbGFiZWwiOwogICAgICBkaXYudGV4dENvbnRlbnQgPSBjOwogICAgICBncmlkLmFwcGVuZENoaWxkKGRpdik7CiAgICB9CgogICAgY29uc3Qgd2VsbENvdW50cyA9IHt9OyAvLyBUcmFjayBob3cgbWFueSBkYXRhc2V0cyBoYXZlIGRhdGEgZm9yIGVhY2ggd2VsbAoKICAgIC8vIENvdW50IGRhdGFzZXRzIHBlciB3ZWxsLCBmaWx0ZXJpbmcgYnkgZW5hYmxlZCB3ZWxscwogICAgLy8gTm9ybWFsaXplIHdlbGwgSURzIHRvIGVuc3VyZSBjb25zaXN0ZW50IG1hdGNoaW5nICh6ZXJvLXBhZGRlZCBmb3JtYXQpCiAgICAvLyBPbmx5IHVzZSBkYXRhc2V0cyBmb3IgdGhpcyBzY2llbnRpc3QKICAgIHNjaWVudGlzdERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICBPYmplY3Qua2V5cyh3ZWxscykuZm9yRWFjaCh3ZWxsSWQgPT4gewogICAgICAgIC8vIE5vcm1hbGl6ZSB3ZWxsIElEIHRvIHplcm8tcGFkZGVkIGZvcm1hdCAoZS5nLiwgIkI1IiAtPiAiQjA1IiwgIkIxMyIgLT4gIkIxMyIpCiAgICAgICAgY29uc3Qgbm9ybWFsaXplZFdlbGxJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpOwogICAgICAgIAogICAgICAgIC8vIEZpbHRlciBieSBlbmFibGVkV2VsbHMgaWYgYW55IGFyZSBzZXQgKGNoZWNrIGJvdGggb3JpZ2luYWwgYW5kIG5vcm1hbGl6ZWQpCiAgICAgICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3ZWxsSWQpICYmICFlbmFibGVkV2VsbHMuaGFzKG5vcm1hbGl6ZWRXZWxsSWQpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIEZpbHRlciBieSBlbmFibGVkQ29sdW1ucyBpZiBhbnkgYXJlIHNldCAoc2NpZW50aXN0LXNwZWNpZmljKQogICAgICAgIC8vIFVzZSB0aGUgc2NpZW50aXN0IGZyb20gdGhlIG91dGVyIGxvb3AgKGFsbCBwbGF0ZXMgaW4gc2NpZW50aXN0RGF0YXNldHMgaGF2ZSB0aGUgc2FtZSBzY2llbnRpc3QpCiAgICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgICAgIGNvbnN0IGVuYWJsZWRDb2x1bW5zID0gZ2V0RW5hYmxlZENvbHVtbnNGb3JTY2llbnRpc3Qoc2NpZW50aXN0KTsKICAgICAgICBpZiAoZW5hYmxlZENvbHVtbnMuc2l6ZSA+IDAgJiYgIWVuYWJsZWRDb2x1bW5zLmhhcyhjb2x1bW4pKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICghd2VsbENvdW50c1tub3JtYWxpemVkV2VsbElkXSkgewogICAgICAgICAgd2VsbENvdW50c1tub3JtYWxpemVkV2VsbElkXSA9IG5ldyBTZXQoKTsgLy8gVXNlIFNldCB0byBhdm9pZCBkdXBsaWNhdGVzCiAgICAgICAgfQogICAgICAgIHdlbGxDb3VudHNbbm9ybWFsaXplZFdlbGxJZF0uYWRkKHBsYXRlSWQpOwogICAgICB9KTsKICAgIH0pOwogICAgCiAgICAvLyBDb252ZXJ0IFNldHMgdG8gYXJyYXlzIGZvciBlYXNpZXIgdXNlCiAgICBPYmplY3Qua2V5cyh3ZWxsQ291bnRzKS5mb3JFYWNoKHdlbGxJZCA9PiB7CiAgICAgIHdlbGxDb3VudHNbd2VsbElkXSA9IEFycmF5LmZyb20od2VsbENvdW50c1t3ZWxsSWRdKTsKICAgIH0pOwoKICAgIC8vIFJvd3MKICAgIFBMQVRFX1JPV1MuZm9yRWFjaChyb3dMZXR0ZXIgPT4gewogICAgICAvLyBSb3cgbGFiZWwKICAgICAgY29uc3QgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgbGFiZWwuY2xhc3NOYW1lID0gImdyaWQtaGVhZGVyIHJvdy1sYWJlbCI7CiAgICAgIGxhYmVsLnRleHRDb250ZW50ID0gcm93TGV0dGVyOwogICAgICBncmlkLmFwcGVuZENoaWxkKGxhYmVsKTsKCiAgICAgIC8vIFdlbGxzCiAgICAgIGZvciAobGV0IGNvbCA9IDE7IGNvbCA8PSBQTEFURV9DT0xTOyBjb2wrKykgewogICAgICAgIGNvbnN0IHdlbGxJZCA9IHJvd0xldHRlciArIFN0cmluZyhjb2wpOwogICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRXZWxsSWQgPSBub3JtYWxpemVXZWxsSWQod2VsbElkKTsgLy8gTm9ybWFsaXplIHRvIHplcm8tcGFkZGVkIGZvcm1hdCBmb3IgbWF0Y2hpbmcKICAgICAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBkaXYuY2xhc3NOYW1lID0gIndlbGwiOwogICAgICAgIGNvbnN0IGhhc0RhdGEgPSB3ZWxsQ291bnRzLmhhc093blByb3BlcnR5KG5vcm1hbGl6ZWRXZWxsSWQpOwogICAgICAgIGRpdi5kYXRhc2V0LndlbGxJZCA9IHdlbGxJZDsKICAgICAgICBkaXYuZGF0YXNldC5oYXNEYXRhID0gaGFzRGF0YSA/ICJ0cnVlIiA6ICJmYWxzZSI7CiAgICAgICAgCiAgICAgICAgaWYgKGhhc0RhdGEpIHsKICAgICAgICBjb25zdCBwbGF0ZXMgPSB3ZWxsQ291bnRzW25vcm1hbGl6ZWRXZWxsSWRdOwogICAgICAgIAogICAgICAgIC8vIENoZWNrIGlmIHRoaXMgd2VsbCBpcyBhIGNvbnRyb2wgd2VsbCAoY29uZmlndXJhYmxlIHZpYSBjb250cm9sX3Jvd3MpCiAgICAgICAgY29uc3QgaXNDb250cm9sID0gaXNDb250cm9sV2VsbCh3ZWxsSWQpOwogICAgICAgIAogICAgICAgIC8vIEdldCBsYWJlbCBmcm9tIHJvdy1iYXNlZCBjb25maWcgb3IgY29udGVudAogICAgICAgIC8vIFRyeSB0byBmaW5kIHRoZSBhY3R1YWwgd2VsbCBJRCBpbiB0aGUgZGF0YSB1c2luZyBub3JtYWxpemVkIGZvcm1hdAogICAgICAgIGNvbnN0IGZpcnN0UGxhdGVJZCA9IHBsYXRlc1swXTsKICAgICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtmaXJzdFBsYXRlSWRdIHx8IHt9OwogICAgICAgIC8vIFRyeSBub3JtYWxpemVkIElEIGZpcnN0LCB0aGVuIHNlYXJjaCBmb3IgbWF0Y2hpbmcgd2VsbCB1c2luZyBub3JtYWxpemVkIGZvcm1hdAogICAgICAgIGxldCBhY3R1YWxXZWxsSWQgPSBub3JtYWxpemVkV2VsbElkOwogICAgICAgIGlmICghd2VsbHNbYWN0dWFsV2VsbElkXSkgewogICAgICAgICAgLy8gU2VhcmNoIGZvciBtYXRjaGluZyB3ZWxsIElEIHVzaW5nIG5vcm1hbGl6ZWQgZm9ybWF0CiAgICAgICAgICBjb25zdCBtYXRjaGluZ0tleSA9IE9iamVjdC5rZXlzKHdlbGxzKS5maW5kKGtleSA9PiAKICAgICAgICAgICAgbm9ybWFsaXplV2VsbElkKGtleSkgPT09IG5vcm1hbGl6ZWRXZWxsSWQKICAgICAgICAgICk7CiAgICAgICAgICBpZiAobWF0Y2hpbmdLZXkpIHsKICAgICAgICAgICAgYWN0dWFsV2VsbElkID0gbWF0Y2hpbmdLZXk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHdlbGxEYXRhID0gd2VsbHNbYWN0dWFsV2VsbElkXTsKICAgICAgICBpZiAoIXdlbGxEYXRhKSB7CiAgICAgICAgICAvLyBXZWxsIGRhdGEgbm90IGZvdW5kLCBza2lwIHRoaXMgd2VsbAogICAgICAgICAgZGl2LnN0eWxlLmN1cnNvciA9ICJkZWZhdWx0IjsKICAgICAgICAgIGRpdi5zdHlsZS5iYWNrZ3JvdW5kID0gIiNmMmYyZjIiOwogICAgICAgICAgZ3JpZC5hcHBlbmRDaGlsZChkaXYpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGNvbnN0IGNvbmZpZyA9IHZpZXdlckRhdGEuY29uZmlnIHx8IHt9OwogICAgICAgIGNvbnN0IHdlbGxMYWJlbHMgPSBjb25maWcud2VsbF9sYWJlbHMgfHwge307CiAgICAgICAgLy8gRXh0cmFjdCByb3cgbGV0dGVyIGZyb20gd2VsbElkIChlLmcuLCAiQjEzIiAtPiAiQiIpCiAgICAgICAgY29uc3Qgcm93TGV0dGVyID0gZ2V0Um93TGV0dGVyKHdlbGxJZCk7CiAgICAgICAgCiAgICAgICAgLy8gQ291bnQgdW5pcXVlIGRhdGFzZXRzIHRoYXQgYWN0dWFsbHkgaGF2ZSBkYXRhIGZvciB0aGlzIHdlbGwKICAgICAgICBjb25zdCB1bmlxdWVQbGF0ZXMgPSBwbGF0ZXMuZmlsdGVyKHBsYXRlSWQgPT4gewogICAgICAgICAgY29uc3QgcGxhdGVXZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgICAgICAgIC8vIENoZWNrIGlmIHRoaXMgcGxhdGUgaGFzIGRhdGEgZm9yIHRoaXMgd2VsbCB1c2luZyBub3JtYWxpemVkIGZvcm1hdAogICAgICAgICAgcmV0dXJuIHBsYXRlV2VsbHNbYWN0dWFsV2VsbElkXSB8fCAKICAgICAgICAgICAgICAgICBPYmplY3Qua2V5cyhwbGF0ZVdlbGxzKS5zb21lKGtleSA9PiBub3JtYWxpemVXZWxsSWQoa2V5KSA9PT0gbm9ybWFsaXplZFdlbGxJZCk7CiAgICAgICAgfSk7CiAgICAgICAgY29uc3QgZGF0YXNldENvdW50ID0gdW5pcXVlUGxhdGVzLmxlbmd0aDsKICAgICAgICAKICAgICAgICAvLyBGb3IgY29udHJvbCB3ZWxsczogbWFpbiB0ZXh0IGlzICJDb250cm9sIiwgbGFiZWwgYmVsb3cgaXMgdGhlIGNvbnRyb2wgbGFiZWwKICAgICAgICAvLyBGb3Igbm9uLWNvbnRyb2wgd2VsbHM6IG1haW4gdGV4dCBpcyBwbGF0ZSBjb3VudCBvciB3ZWxsIElELCBsYWJlbCBiZWxvdyBpcyB0aGUgY29uZmlndXJlZCBsYWJlbAogICAgICAgIGxldCBtYWluVGV4dCwgbGFiZWw7CiAgICAgICAgaWYgKGlzQ29udHJvbCkgewogICAgICAgICAgbWFpblRleHQgPSAiQ29udHJvbCI7CiAgICAgICAgICAvLyBHZXQgdGhlIGNvbnRyb2wgbGFiZWwgZnJvbSBjb25maWcgb3Igd2VsbCBkYXRhIGFuZCBmb3JtYXQgaXQKICAgICAgICAgIGxhYmVsID0gd2VsbExhYmVsc1tyb3dMZXR0ZXJdIHx8IHdlbGxEYXRhLmxhYmVsIHx8IHdlbGxEYXRhLmNvbnRlbnQgfHwgIiI7CiAgICAgICAgICBpZiAobGFiZWwpIHsKICAgICAgICAgICAgbGFiZWwgPSBmb3JtYXRMYWJlbChsYWJlbCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFNob3cgZGF0YXNldCBjb3VudCBpZiBtb3JlIHRoYW4gMSwgb3RoZXJ3aXNlIHNob3cgd2VsbCBJRAogICAgICAgICAgbWFpblRleHQgPSBkYXRhc2V0Q291bnQgPiAxID8gYCR7ZGF0YXNldENvdW50fWAgOiB3ZWxsSWQ7CiAgICAgICAgICAvLyBVc2Ugcm93LWJhc2VkIGxhYmVsIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIHVzZSB3ZWxsJ3MgbGFiZWwgb3IgY29udGVudAogICAgICAgICAgbGFiZWwgPSB3ZWxsTGFiZWxzW3Jvd0xldHRlcl0gfHwgd2VsbERhdGEubGFiZWwgfHwgd2VsbERhdGEuY29udGVudCB8fCAiIjsKICAgICAgICAgIC8vIEZvcm1hdCBsYWJlbCAocmVtb3ZlIHVNLCBmb3JtYXQgYXMgbnVtYmVyLW51bWJlci1udW1iZXIpCiAgICAgICAgICBpZiAobGFiZWwpIHsKICAgICAgICAgICAgbGFiZWwgPSBmb3JtYXRMYWJlbChsYWJlbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGRpdi50ZXh0Q29udGVudCA9IG1haW5UZXh0OwogICAgICAgIGRpdi5zdHlsZS5jdXJzb3IgPSAicG9pbnRlciI7CiAgICAgICAgZGl2LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAiYXV0byI7CiAgICAgICAgZGl2LnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKICAgICAgICBkaXYuc3R5bGUuekluZGV4ID0gIjEiOwogICAgICAgIAogICAgICAgIC8vIEFkZCB2aXN1YWwgaW5kaWNhdG9yIGZvciBkdXBsaWNhdGUgd2VsbHMKICAgICAgICBpZiAoaXNEdXBsaWNhdGVXZWxsKHdlbGxJZCkpIHsKICAgICAgICAgIGRpdi5zdHlsZS5ib3JkZXJXaWR0aCA9ICIycHgiOwogICAgICAgICAgZGl2LnN0eWxlLmJvcmRlclN0eWxlID0gImRvdWJsZSI7CiAgICAgICAgICBkaXYudGl0bGUgPSAoZGl2LnRpdGxlIHx8ICIiKSArICIg4pqg77iPIER1cGxpY2F0ZSB3ZWxsIC0gY2xpY2sgdG8gY29tcGFyZSBkYXRhc2V0cyI7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChsYWJlbCkgewogICAgICAgICAgY29uc3QgbGFiZWxEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgIGxhYmVsRGl2LmNsYXNzTmFtZSA9ICJ3ZWxsLWxhYmVsIjsKICAgICAgICAgIGxhYmVsRGl2LnRleHRDb250ZW50ID0gbGFiZWw7CiAgICAgICAgICBsYWJlbERpdi5zdHlsZS5wb2ludGVyRXZlbnRzID0gIm5vbmUiOwogICAgICAgICAgZGl2LmFwcGVuZENoaWxkKGxhYmVsRGl2KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZGl2LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgKGUpID0+IHsKICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAvLyBHZXQgYWxsIHNlbGVjdGVkIGRhdGFzZXRzIHRoYXQgaGF2ZSBkYXRhIGZvciB0aGlzIHdlbGwgKG5vdCBqdXN0IGN1cnJlbnQgc2NpZW50aXN0J3MgZ3JpZCkKICAgICAgICAgIC8vIFRoaXMgZW5zdXJlcyB0b2dnbGVzIHdvcmsgYWNyb3NzIGFsbCBkYXRhc2V0cyBpbiB0aGUgc2VsZWN0ZWQgZ3JvdXAKICAgICAgICAgIGNvbnN0IGFsbFNlbGVjdGVkRGF0YXNldHMgPSBnZXRTZWxlY3RlZERhdGFzZXRzKCk7CiAgICAgICAgICBjb25zdCBwbGF0ZXNXaXRoV2VsbCA9IGFsbFNlbGVjdGVkRGF0YXNldHMuZmlsdGVyKHBsYXRlSWQgPT4gewogICAgICAgICAgICBjb25zdCBwbGF0ZVdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICAgICAgICAvLyBDaGVjayBpZiB0aGlzIHBsYXRlIGhhcyBkYXRhIGZvciB0aGlzIHdlbGwgdXNpbmcgbm9ybWFsaXplZCBmb3JtYXQKICAgICAgICAgICAgcmV0dXJuIHBsYXRlV2VsbHNbbm9ybWFsaXplZFdlbGxJZF0gfHwgCiAgICAgICAgICAgICAgICAgICBPYmplY3Qua2V5cyhwbGF0ZVdlbGxzKS5zb21lKGtleSA9PiBub3JtYWxpemVXZWxsSWQoa2V5KSA9PT0gbm9ybWFsaXplZFdlbGxJZCk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHRvZ2dsZVdlbGxTZWxlY3Rpb24od2VsbElkLCBwbGF0ZXNXaXRoV2VsbCk7CiAgICAgICAgfSk7CiAgICAgICAgaWYgKGlzQ29udHJvbCkgewogICAgICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoImNvbnRyb2wiKTsKICAgICAgICAgIGRpdi50aXRsZSA9ICJDb250cm9sIHdlbGwgKGluZGVwZW5kZW50bHkgc2VsZWN0YWJsZSkiOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBDaGVjayBpZiB0aGlzIHdlbGwgaXMgcGFydCBvZiBhIHRyaXBsaWNhdGUgZ3JvdXAgKGNvbnRyb2xzIGFyZSBuZXZlciBpbiB0cmlwbGljYXRlIGdyb3VwcykKICAgICAgICBjb25zdCBjb2x1bW4gPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAgICAgY29uc3QgdHJpcGxpY2F0ZUdyb3VwID0gZ2V0VHJpcGxpY2F0ZUdyb3VwKHdlbGxJZCwgY29sdW1uKTsKICAgICAgICAKICAgICAgICAvLyBBZGQgdmlzdWFsIGluZGljYXRvciBmb3IgdHJpcGxpY2F0ZSBncm91cHMgd2l0aCBkaXN0aW5jdCBjb2xvcnMKICAgICAgICAvLyBBbGwgd2VsbHMgaW4gdGhlIHNhbWUgdHJpcGxpY2F0ZSBncm91cCAoc2FtZSBuYW1lKSBnZXQgdGhlIHNhbWUgY29sb3IKICAgICAgICAvLyBGb3IgZXhhbXBsZSwgYWxsIHdlbGxzIGluIHJvd3MgQiwgQywgRCB3aXRoIGdyb3VwIG5hbWUgIjI1MC0xMC0yIiBnZXQgdGhlIHNhbWUgY29sb3IKICAgICAgICAvLyBCb3JkZXJzL3N0cm9rZXMgb25seSBhcHBlYXIgd2hlbiBzZWxlY3RlZAogICAgICAgIGlmICh0cmlwbGljYXRlR3JvdXAgJiYgdHJpcGxpY2F0ZUdyb3VwLm5hbWUpIHsKICAgICAgICAgIGRpdi5jbGFzc0xpc3QuYWRkKCJ0cmlwbGljYXRlLWdyb3VwIik7CiAgICAgICAgICBkaXYudGl0bGUgPSBgVHJpcGxpY2F0ZSBncm91cDogJHt0cmlwbGljYXRlR3JvdXAubmFtZX0gKGNsaWNrIHRvIHNlbGVjdCBhbGwpYDsKICAgICAgICAgIAogICAgICAgICAgLy8gQXBwbHkgZGlzdGluY3QgY29sb3IgZm9yIHRoaXMgdHJpcGxpY2F0ZSBncm91cCAoYmFja2dyb3VuZCBvbmx5LCBubyBib3JkZXIgdW5sZXNzIHNlbGVjdGVkKQogICAgICAgICAgLy8gQWxsIHdlbGxzIHdpdGggdGhlIHNhbWUgZ3JvdXAgbmFtZSB3aWxsIGdldCB0aGUgc2FtZSBjb2xvcgogICAgICAgICAgLy8gVGhpcyBlbnN1cmVzIEIsIEMsIEQgcm93cyBhbGwgZ2V0IHRoZSBzYW1lIGNvbG9yIGZvciB0aGUgc2FtZSB0cmlwbGljYXRlIGdyb3VwCiAgICAgICAgICBjb25zdCBncm91cE5hbWUgPSBTdHJpbmcodHJpcGxpY2F0ZUdyb3VwLm5hbWUgfHwgIiIpLnRyaW0oKTsgLy8gTm9ybWFsaXplIGdyb3VwIG5hbWUKICAgICAgICAgIGNvbnN0IGNvbG9yID0gZ2V0VHJpcGxpY2F0ZUdyb3VwQ29sb3IoZ3JvdXBOYW1lKTsKICAgICAgICAgIGlmIChjb2xvciAmJiBjb2xvci5iZ0hhc0RhdGEpIHsKICAgICAgICAgICAgLy8gU2V0IGJhY2tncm91bmQgY29sb3Igb25seSAtIGJvcmRlcnMgd2lsbCBiZSBhZGRlZCB3aGVuIHNlbGVjdGVkCiAgICAgICAgICAgIGNvbnN0IGJnQ29sb3IgPSBoYXNEYXRhID8gY29sb3IuYmdIYXNEYXRhIDogY29sb3IuYmc7CiAgICAgICAgICAgIGRpdi5zdHlsZS5zZXRQcm9wZXJ0eSgiYmFja2dyb3VuZC1jb2xvciIsIGJnQ29sb3IsICJpbXBvcnRhbnQiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgICAvLyBIaWdobGlnaHQgaWYgc2VsZWN0ZWQgKGNoZWNrIGlmIGFueSBzZWxlY3RlZCBkYXRhc2V0IGhhcyB0aGlzIHdlbGwgc2VsZWN0ZWQpCiAgICAgICAgICAvLyBBbHNvIGNoZWNrIGlmIHRoaXMgd2VsbCBpcyBwYXJ0IG9mIGEgdHJpcGxpY2F0ZSBncm91cCB0aGF0J3Mgc2VsZWN0ZWQKICAgICAgICAgIGNvbnN0IHNlbGVjdGVkRGF0YXNldHNGb3JDaGVjayA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICAgICAgICAgIGxldCBpc1NlbGVjdGVkID0gZmFsc2U7CiAgICAgICAgICAKICAgICAgICAgIGlmICh0cmlwbGljYXRlR3JvdXApIHsKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgYW55IHdlbGwgaW4gdGhpcyB0cmlwbGljYXRlIGdyb3VwIChzYW1lIHJvdyBwYXR0ZXJuLCBzYW1lIGNvbHVtbikgaXMgc2VsZWN0ZWQKICAgICAgICAgICAgY29uc3QgZ3JvdXBSb3dMZXR0ZXJzID0gZ2V0Um93TGV0dGVyc0Zyb21XZWxscyh0cmlwbGljYXRlR3JvdXAud2VsbHMpOwogICAgICAgICAgICBzZWxlY3RlZERhdGFzZXRzRm9yQ2hlY2suZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgICAgICAgICBpZiAoIXBsYXRlcy5pbmNsdWRlcyhwbGF0ZUlkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBncm91cFJvd0xldHRlcnMuZm9yRWFjaChyb3dMZXR0ZXIgPT4gewogICAgICAgICAgICAgICAgY29uc3Qgd0lkID0gcm93TGV0dGVyICsgY29sdW1uOwogICAgICAgICAgICAgICAgY29uc3Qgbm9ybWFsaXplZFdJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3SWQpOwogICAgICAgICAgICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHtub3JtYWxpemVkV0lkfWA7CiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0ZWRXZWxscy5oYXMoa2V5KSkgewogICAgICAgICAgICAgICAgICBpc1NlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBDaGVjayBpZiB0aGlzIHNwZWNpZmljIHdlbGwgaXMgc2VsZWN0ZWQKICAgICAgICAgICAgY29uc3Qgbm9ybWFsaXplZFdlbGxJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpOwogICAgICAgICAgICBpc1NlbGVjdGVkID0gc2VsZWN0ZWREYXRhc2V0c0ZvckNoZWNrLnNvbWUocGxhdGVJZCA9PiB7CiAgICAgICAgICAgICAgaWYgKHBsYXRlcy5pbmNsdWRlcyhwbGF0ZUlkKSkgewogICAgICAgICAgICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHtub3JtYWxpemVkV2VsbElkfWA7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZWN0ZWRXZWxscy5oYXMoa2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIAogICAgICAgICAgaWYgKGlzU2VsZWN0ZWQpIHsKICAgICAgICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoInNlbGVjdGVkIik7CiAgICAgICAgICAgIC8vIFVwZGF0ZSBiYWNrZ3JvdW5kIGNvbG9yIGFuZCBhZGQgYm9yZGVyIGZvciBzZWxlY3RlZCB0cmlwbGljYXRlIGdyb3VwcwogICAgICAgICAgICBpZiAodHJpcGxpY2F0ZUdyb3VwICYmIHRyaXBsaWNhdGVHcm91cC5uYW1lKSB7CiAgICAgICAgICAgICAgY29uc3QgZ3JvdXBOYW1lID0gU3RyaW5nKHRyaXBsaWNhdGVHcm91cC5uYW1lIHx8ICIiKS50cmltKCk7IC8vIE5vcm1hbGl6ZSBncm91cCBuYW1lCiAgICAgICAgICAgICAgY29uc3QgY29sb3IgPSBnZXRUcmlwbGljYXRlR3JvdXBDb2xvcihncm91cE5hbWUpOwogICAgICAgICAgICAgIGlmIChjb2xvcikgewogICAgICAgICAgICAgICAgZGl2LnN0eWxlLnNldFByb3BlcnR5KCJiYWNrZ3JvdW5kLWNvbG9yIiwgY29sb3IuYmdIYXNEYXRhLCAiaW1wb3J0YW50Iik7CiAgICAgICAgICAgICAgICAvLyBBZGQgYm9yZGVyIHdoZW4gc2VsZWN0ZWQKICAgICAgICAgICAgICAgIGRpdi5zdHlsZS5zZXRQcm9wZXJ0eSgiYm9yZGVyLWNvbG9yIiwgY29sb3IuYm9yZGVyLCAiaW1wb3J0YW50Iik7CiAgICAgICAgICAgICAgICBkaXYuc3R5bGUuc2V0UHJvcGVydHkoImJvcmRlci13aWR0aCIsICIycHgiLCAiaW1wb3J0YW50Iik7CiAgICAgICAgICAgICAgICBkaXYuc3R5bGUuc2V0UHJvcGVydHkoImJvcmRlci1zdHlsZSIsICJzb2xpZCIsICJpbXBvcnRhbnQiKTsKICAgICAgICAgICAgICAgIGRpdi5zdHlsZS5zZXRQcm9wZXJ0eSgib3V0bGluZSIsIGAycHggc29saWQgJHtjb2xvci5ib3JkZXJ9YCwgImltcG9ydGFudCIpOwogICAgICAgICAgICAgICAgZGl2LnN0eWxlLnNldFByb3BlcnR5KCJvdXRsaW5lLW9mZnNldCIsICItMnB4IiwgImltcG9ydGFudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkaXYuc3R5bGUuY3Vyc29yID0gImRlZmF1bHQiOwogICAgICAgICAgZGl2LnN0eWxlLmJhY2tncm91bmQgPSAiI2YyZjJmMiI7CiAgICAgICAgfQogICAgICAgIGdyaWQuYXBwZW5kQ2hpbGQoZGl2KTsKICAgICAgfQogICAgfSk7CiAgfSk7CiAgCiAgLy8gQ3JlYXRlIHZpc3VhbCBpbmRpY2F0b3JzIGJlbG93IHRoZSBwbGF0ZSBncmlkcwogIGNyZWF0ZVBsYXRlSW5kaWNhdG9ycyhjb250YWluZXIsIHBsYXRlQ29udGFpbmVycywgc29ydGVkU2NpZW50aXN0cyk7CiAgCiAgLy8gVXBkYXRlIGNvbHVtbiBsZWdlbmQgd2l0aCBkYXRhc2V0IG1hcHBpbmcgKHVzZSBhbGwgZGF0YXNldHMgaW4gZ3JvdXApCiAgdXBkYXRlQ29sdW1uTGVnZW5kKGNvbHVtbkluZm9NYXAsIGFsbEdyb3VwRGF0YXNldHMpOwp9CgpmdW5jdGlvbiBjcmVhdGVQbGF0ZUluZGljYXRvcnMoY29udGFpbmVyLCBwbGF0ZUNvbnRhaW5lcnMsIHNjaWVudGlzdHMpIHsKICBpZiAocGxhdGVDb250YWluZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwogIAogIC8vIFJlbW92ZSBvbGQgZXZlbnQgbGlzdGVuZXJzIGlmIHRoZXkgZXhpc3QKICBpZiAocGxhdGVJbmRpY2F0b3JDbGVhbnVwKSB7CiAgICBwbGF0ZUluZGljYXRvckNsZWFudXAoKTsKICAgIHBsYXRlSW5kaWNhdG9yQ2xlYW51cCA9IG51bGw7CiAgfQogIAogIC8vIFJlbW92ZSBleGlzdGluZyBpbmRpY2F0b3IgaWYgcHJlc2VudAogIGNvbnN0IGV4aXN0aW5nSW5kaWNhdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInBsYXRlLWluZGljYXRvcnMiKTsKICBpZiAoZXhpc3RpbmdJbmRpY2F0b3IpIHsKICAgIGV4aXN0aW5nSW5kaWNhdG9yLnJlbW92ZSgpOwogIH0KICAKICAvLyBDcmVhdGUgaW5kaWNhdG9yIGNvbnRhaW5lciAtIGFwcGVuZCB0byBtYWluIGVsZW1lbnQgKHBhcmVudCBvZiBjb250YWluZXIpCiAgY29uc3QgbWFpbkVsZW1lbnQgPSBjb250YWluZXIucGFyZW50RWxlbWVudDsKICBpZiAoIW1haW5FbGVtZW50KSByZXR1cm47CiAgCiAgY29uc3QgaW5kaWNhdG9yQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgaW5kaWNhdG9yQ29udGFpbmVyLmlkID0gInBsYXRlLWluZGljYXRvcnMiOwogIGluZGljYXRvckNvbnRhaW5lci5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CiAgaW5kaWNhdG9yQ29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgaW5kaWNhdG9yQ29udGFpbmVyLnN0eWxlLmdhcCA9ICI2cHgiOwogIGluZGljYXRvckNvbnRhaW5lci5zdHlsZS5qdXN0aWZ5Q29udGVudCA9ICJjZW50ZXIiOwogIGluZGljYXRvckNvbnRhaW5lci5zdHlsZS5hbGlnbkl0ZW1zID0gImNlbnRlciI7CiAgaW5kaWNhdG9yQ29udGFpbmVyLnN0eWxlLnpJbmRleCA9ICIxMCI7CiAgaW5kaWNhdG9yQ29udGFpbmVyLnN0eWxlLnBhZGRpbmcgPSAiNnB4IDEycHgiOwogIGluZGljYXRvckNvbnRhaW5lci5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAicmdiYSgyNTUsIDI1NSwgMjU1LCAwLjk1KSI7CiAgaW5kaWNhdG9yQ29udGFpbmVyLnN0eWxlLmJvcmRlclJhZGl1cyA9ICIxNnB4IjsKICBpbmRpY2F0b3JDb250YWluZXIuc3R5bGUuYm94U2hhZG93ID0gIjAgMnB4IDhweCByZ2JhKDAsIDAsIDAsIDAuMTIpIjsKICBpbmRpY2F0b3JDb250YWluZXIuc3R5bGUud2lkdGggPSAiZml0LWNvbnRlbnQiOwogIGluZGljYXRvckNvbnRhaW5lci5zdHlsZS5tYXJnaW4gPSAiMCBhdXRvIjsKICBpbmRpY2F0b3JDb250YWluZXIuc3R5bGUubWFyZ2luVG9wID0gIi0zNXB4IjsKICBpbmRpY2F0b3JDb250YWluZXIuc3R5bGUubWFyZ2luQm90dG9tID0gIjhweCI7CiAgCiAgLy8gQ3JlYXRlIGluZGljYXRvciBkb3RzIGZvciBlYWNoIHBsYXRlCiAgY29uc3QgaW5kaWNhdG9ycyA9IFtdOwogIHNjaWVudGlzdHMuZm9yRWFjaCgoc2NpZW50aXN0LCBpbmRleCkgPT4gewogICAgY29uc3QgaW5kaWNhdG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBpbmRpY2F0b3IuY2xhc3NOYW1lID0gInBsYXRlLWluZGljYXRvciI7CiAgICBpbmRpY2F0b3IuZGF0YXNldC5pbmRleCA9IGluZGV4OwogICAgaW5kaWNhdG9yLnN0eWxlLndpZHRoID0gIjhweCI7CiAgICBpbmRpY2F0b3Iuc3R5bGUuaGVpZ2h0ID0gIjhweCI7CiAgICBpbmRpY2F0b3Iuc3R5bGUuYm9yZGVyUmFkaXVzID0gIjUwJSUiOwogICAgaW5kaWNhdG9yLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGluZGV4ID09PSAwID8gIiMyYTZjZmYiIDogIiNjY2MiOwogICAgaW5kaWNhdG9yLnN0eWxlLmN1cnNvciA9ICJwb2ludGVyIjsKICAgIGluZGljYXRvci5zdHlsZS50cmFuc2l0aW9uID0gImFsbCAwLjNzIGVhc2UiOwogICAgaW5kaWNhdG9yLnN0eWxlLmJvcmRlciA9ICIxcHggc29saWQgdHJhbnNwYXJlbnQiOwogICAgCiAgICAvLyBBZGQgaG92ZXIgZWZmZWN0CiAgICBpbmRpY2F0b3IuYWRkRXZlbnRMaXN0ZW5lcigibW91c2VlbnRlciIsICgpID0+IHsKICAgICAgaWYgKGluZGljYXRvci5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgIT09ICIjMmE2Y2ZmIikgewogICAgICAgIGluZGljYXRvci5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAiIzk5OSI7CiAgICAgICAgaW5kaWNhdG9yLnN0eWxlLnRyYW5zZm9ybSA9ICJzY2FsZSgxLjMpIjsKICAgICAgfQogICAgfSk7CiAgICBpbmRpY2F0b3IuYWRkRXZlbnRMaXN0ZW5lcigibW91c2VsZWF2ZSIsICgpID0+IHsKICAgICAgaWYgKGluZGljYXRvci5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgIT09ICIjMmE2Y2ZmIikgewogICAgICAgIGluZGljYXRvci5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAiI2NjYyI7CiAgICAgICAgaW5kaWNhdG9yLnN0eWxlLnRyYW5zZm9ybSA9ICJzY2FsZSgxKSI7CiAgICAgIH0KICAgIH0pOwogICAgCiAgICAvLyBDbGljayB0byBzY3JvbGwgdG8gcGxhdGUKICAgIGluZGljYXRvci5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgICAgaWYgKHBsYXRlQ29udGFpbmVyc1tpbmRleF0pIHsKICAgICAgICBwbGF0ZUNvbnRhaW5lcnNbaW5kZXhdLnNjcm9sbEludG9WaWV3KHsgYmVoYXZpb3I6ICJzbW9vdGgiLCBibG9jazogIm5lYXJlc3QiLCBpbmxpbmU6ICJzdGFydCIgfSk7CiAgICAgIH0KICAgIH0pOwogICAgCiAgICAvLyBBZGQgdG9vbHRpcCB3aXRoIHNjaWVudGlzdCBuYW1lCiAgICBpbmRpY2F0b3IudGl0bGUgPSBzY2llbnRpc3QgfHwgIk5vIFNjaWVudGlzdCI7CiAgICAKICAgIGluZGljYXRvckNvbnRhaW5lci5hcHBlbmRDaGlsZChpbmRpY2F0b3IpOwogICAgaW5kaWNhdG9ycy5wdXNoKGluZGljYXRvcik7CiAgfSk7CiAgCiAgLy8gSW5zZXJ0IGluZGljYXRvciBjb250YWluZXIgYWZ0ZXIgdGhlIHBsYXRlLWdyaWRzLWNvbnRhaW5lcgogIGlmIChtYWluRWxlbWVudCkgewogICAgbWFpbkVsZW1lbnQuaW5zZXJ0QmVmb3JlKGluZGljYXRvckNvbnRhaW5lciwgY29udGFpbmVyLm5leHRTaWJsaW5nKTsKICB9CiAgCiAgLy8gVXBkYXRlIGluZGljYXRvcnMgb24gc2Nyb2xsCiAgbGV0IHNjcm9sbFRpbWVvdXQ7CiAgY29uc3QgdXBkYXRlQWN0aXZlSW5kaWNhdG9yID0gKCkgPT4gewogICAgY29uc3QgY29udGFpbmVyUmVjdCA9IGNvbnRhaW5lci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIGNvbnN0IGNvbnRhaW5lckNlbnRlciA9IGNvbnRhaW5lclJlY3QubGVmdCArIGNvbnRhaW5lclJlY3Qud2lkdGggLyAyOwogICAgCiAgICBsZXQgYWN0aXZlSW5kZXggPSAwOwogICAgbGV0IG1pbkRpc3RhbmNlID0gSW5maW5pdHk7CiAgICAKICAgIHBsYXRlQ29udGFpbmVycy5mb3JFYWNoKChwbGF0ZUNvbnRhaW5lciwgaW5kZXgpID0+IHsKICAgICAgY29uc3QgcGxhdGVSZWN0ID0gcGxhdGVDb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIGNvbnN0IHBsYXRlQ2VudGVyID0gcGxhdGVSZWN0LmxlZnQgKyBwbGF0ZVJlY3Qud2lkdGggLyAyOwogICAgICBjb25zdCBkaXN0YW5jZSA9IE1hdGguYWJzKGNvbnRhaW5lckNlbnRlciAtIHBsYXRlQ2VudGVyKTsKICAgICAgCiAgICAgIGlmIChkaXN0YW5jZSA8IG1pbkRpc3RhbmNlKSB7CiAgICAgICAgbWluRGlzdGFuY2UgPSBkaXN0YW5jZTsKICAgICAgICBhY3RpdmVJbmRleCA9IGluZGV4OwogICAgICB9CiAgICB9KTsKICAgIAogICAgLy8gVXBkYXRlIGluZGljYXRvciBzdHlsZXMKICAgIGluZGljYXRvcnMuZm9yRWFjaCgoaW5kaWNhdG9yLCBpbmRleCkgPT4gewogICAgICBpZiAoaW5kZXggPT09IGFjdGl2ZUluZGV4KSB7CiAgICAgICAgaW5kaWNhdG9yLnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICIjMmE2Y2ZmIjsKICAgICAgICBpbmRpY2F0b3Iuc3R5bGUud2lkdGggPSAiMTBweCI7CiAgICAgICAgaW5kaWNhdG9yLnN0eWxlLmhlaWdodCA9ICIxMHB4IjsKICAgICAgICBpbmRpY2F0b3Iuc3R5bGUuYm9yZGVyID0gIjFweCBzb2xpZCAjMWE1Y2U2IjsKICAgICAgfSBlbHNlIHsKICAgICAgICBpbmRpY2F0b3Iuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gIiNjY2MiOwogICAgICAgIGluZGljYXRvci5zdHlsZS53aWR0aCA9ICI4cHgiOwogICAgICAgIGluZGljYXRvci5zdHlsZS5oZWlnaHQgPSAiOHB4IjsKICAgICAgICBpbmRpY2F0b3Iuc3R5bGUuYm9yZGVyID0gIjFweCBzb2xpZCB0cmFuc3BhcmVudCI7CiAgICAgIH0KICAgIH0pOwogIH07CiAgCiAgLy8gQ3JlYXRlIG5hbWVkIGhhbmRsZXIgZnVuY3Rpb25zIHNvIHRoZXkgY2FuIGJlIHJlbW92ZWQgbGF0ZXIKICBjb25zdCBzY3JvbGxIYW5kbGVyID0gKCkgPT4gewogICAgY2xlYXJUaW1lb3V0KHNjcm9sbFRpbWVvdXQpOwogICAgc2Nyb2xsVGltZW91dCA9IHNldFRpbWVvdXQodXBkYXRlQWN0aXZlSW5kaWNhdG9yLCA1MCk7CiAgfTsKICAKICBjb25zdCByZXNpemVIYW5kbGVyID0gdXBkYXRlQWN0aXZlSW5kaWNhdG9yOwogIAogIC8vIEFkZCBldmVudCBsaXN0ZW5lcnMKICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigic2Nyb2xsIiwgc2Nyb2xsSGFuZGxlcik7CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInJlc2l6ZSIsIHJlc2l6ZUhhbmRsZXIpOwogIAogIC8vIFN0b3JlIGNsZWFudXAgZnVuY3Rpb24KICBwbGF0ZUluZGljYXRvckNsZWFudXAgPSAoKSA9PiB7CiAgICBjb250YWluZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcigic2Nyb2xsIiwgc2Nyb2xsSGFuZGxlcik7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigicmVzaXplIiwgcmVzaXplSGFuZGxlcik7CiAgICBpZiAoc2Nyb2xsVGltZW91dCkgewogICAgICBjbGVhclRpbWVvdXQoc2Nyb2xsVGltZW91dCk7CiAgICB9CiAgfTsKICAKICAvLyBJbml0aWFsIHVwZGF0ZQogIHVwZGF0ZUFjdGl2ZUluZGljYXRvcigpOwp9CgpmdW5jdGlvbiB1cGRhdGVDb2x1bW5MZWdlbmQoY29sdW1uSW5mb01hcCwgYWxsRGF0YXNldHMpIHsKICBjb25zdCBsZWdlbmREaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY29sdW1uLWxlZ2VuZC1jb250ZW50Iik7CiAgaWYgKCFsZWdlbmREaXYpIHJldHVybjsKICAKICAvLyBCdWlsZCBtYXA6IGNvbHVtbiAtPiB7IGRhdGFzZXRzOiBTZXQsIGluZm86IHsgZ2Vub3R5cGUsIGJ1ZmZlciwgc2NpZW50aXN0IH0gfQogIGNvbnN0IGNvbHVtbkRhdGEgPSB7fTsgLy8gY29sdW1uIC0+IHsgZGF0YXNldHM6IFNldCwgaW5mbzoge30gfQogIAogIC8vIEZpbmQgd2hpY2ggZGF0YXNldHMgaGF2ZSBkYXRhIGluIGVhY2ggY29sdW1uCiAgZm9yIChsZXQgY29sID0gMTsgY29sIDw9IFBMQVRFX0NPTFM7IGNvbCsrKSB7CiAgICBjb25zdCBpbmZvID0gY29sdW1uSW5mb01hcFtjb2xdOwogICAgaWYgKCFpbmZvKSBjb250aW51ZTsKICAgIAogICAgY29sdW1uRGF0YVtjb2xdID0gewogICAgICBkYXRhc2V0czogbmV3IFNldCgpLAogICAgICBpbmZvOiB7CiAgICAgICAgZ2Vub3R5cGU6IGluZm8uZ2Vub3R5cGUgfHwgIiIsCiAgICAgICAgYnVmZmVyOiBpbmZvLmJ1ZmZlciB8fCAiIiwKICAgICAgICBzY2llbnRpc3Q6IGluZm8uc2NpZW50aXN0IHx8ICIiCiAgICAgIH0KICAgIH07CiAgICAKICAgIC8vIEZpbmQgYWxsIGRhdGFzZXRzIHRoYXQgaGF2ZSBkYXRhIGluIHRoaXMgY29sdW1uCiAgICBhbGxEYXRhc2V0cy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgICAgY29uc3QgaGFzRGF0YUluQ29sdW1uID0gT2JqZWN0LmtleXMod2VsbHMpLnNvbWUod2VsbElkID0+IHsKICAgICAgICBjb25zdCB3ZWxsQ29sID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgICAgIHJldHVybiB3ZWxsQ29sID09PSBjb2w7CiAgICAgIH0pOwogICAgICAKICAgICAgaWYgKGhhc0RhdGFJbkNvbHVtbikgewogICAgICAgIGNvbHVtbkRhdGFbY29sXS5kYXRhc2V0cy5hZGQocGxhdGVJZCk7CiAgICAgIH0KICAgIH0pOwogIH0KICAKICBpZiAoT2JqZWN0LmtleXMoY29sdW1uRGF0YSkubGVuZ3RoID09PSAwKSB7CiAgICBsZWdlbmREaXYuaW5uZXJIVE1MID0gIjxkaXYgc3R5bGU9J2NvbG9yOiAjNjY2OyBmb250LXNpemU6IDAuOHJlbTsnPk5vIGNvbHVtbiBpbmZvcm1hdGlvbiBhdmFpbGFibGUuPC9kaXY+IjsKICAgIHJldHVybjsKICB9CiAgCiAgLy8gQnVpbGQgSFRNTCB3aXRoIGluZGl2aWR1YWwgY29sdW1uIGNoZWNrYm94ZXMKICBsZWdlbmREaXYuaW5uZXJIVE1MID0gIiI7CiAgCiAgLy8gU29ydCBjb2x1bW5zIG51bWVyaWNhbGx5CiAgY29uc3Qgc29ydGVkQ29sdW1ucyA9IE9iamVjdC5rZXlzKGNvbHVtbkRhdGEpLm1hcChOdW1iZXIpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKICAKICBzb3J0ZWRDb2x1bW5zLmZvckVhY2goY29sID0+IHsKICAgIGNvbnN0IGNvbERhdGEgPSBjb2x1bW5EYXRhW2NvbF07CiAgICBjb25zdCBjb2xEYXRhc2V0cyA9IEFycmF5LmZyb20oY29sRGF0YS5kYXRhc2V0cyk7CiAgICAKICAgIGlmIChjb2xEYXRhc2V0cy5sZW5ndGggPT09IDApIHJldHVybjsgLy8gU2tpcCBjb2x1bW5zIHdpdGggbm8gZGF0YQogICAgCiAgICAvLyBDcmVhdGUgY29udGFpbmVyIGZvciB0aGlzIGNvbHVtbgogICAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBkaXYuc3R5bGUubWFyZ2luQm90dG9tID0gIjhweCI7CiAgICBkaXYuc3R5bGUucGFkZGluZyA9ICI4cHgiOwogICAgZGl2LnN0eWxlLmJhY2tncm91bmQgPSAiI2Y5ZjlmOSI7CiAgICBkaXYuc3R5bGUuYm9yZGVyUmFkaXVzID0gIjNweCI7CiAgICAKICAgIC8vIENvbHVtbiBoZWFkZXIgd2l0aCBpbmZvCiAgICBjb25zdCBjb2x1bW5IZWFkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGNvbHVtbkhlYWRlci5zdHlsZS5mb250V2VpZ2h0ID0gIjYwMCI7CiAgICBjb2x1bW5IZWFkZXIuc3R5bGUubWFyZ2luQm90dG9tID0gIjZweCI7CiAgICBjb2x1bW5IZWFkZXIudGV4dENvbnRlbnQgPSBgQ29sdW1uICR7Y29sfWA7CiAgICBkaXYuYXBwZW5kQ2hpbGQoY29sdW1uSGVhZGVyKTsKICAgIAogICAgLy8gQ29sdW1uIGluZm8gKGdlbm90eXBlLCBidWZmZXIsIHNjaWVudGlzdCkKICAgIGNvbnN0IGRldGFpbHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGRldGFpbHMuc3R5bGUuZm9udFNpemUgPSAiMC43NXJlbSI7CiAgICBkZXRhaWxzLnN0eWxlLm1hcmdpbkJvdHRvbSA9ICI2cHgiOwogICAgZGV0YWlscy5zdHlsZS5tYXJnaW5MZWZ0ID0gIjRweCI7CiAgICAKICAgIGlmIChjb2xEYXRhLmluZm8uZ2Vub3R5cGUpIHsKICAgICAgY29uc3QgZ2VuRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGdlbkRpdi5zdHlsZS5tYXJnaW5Cb3R0b20gPSAiMnB4IjsKICAgICAgZ2VuRGl2LmlubmVySFRNTCA9IGA8c3Ryb25nPkdlbm90eXBlOjwvc3Ryb25nPiAke2NvbERhdGEuaW5mby5nZW5vdHlwZX1gOwogICAgICBkZXRhaWxzLmFwcGVuZENoaWxkKGdlbkRpdik7CiAgICB9CiAgICBpZiAoY29sRGF0YS5pbmZvLmJ1ZmZlcikgewogICAgICBjb25zdCBidWZEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgYnVmRGl2LnN0eWxlLm1hcmdpbkJvdHRvbSA9ICIycHgiOwogICAgICBidWZEaXYuaW5uZXJIVE1MID0gYDxzdHJvbmc+QnVmZmVyOjwvc3Ryb25nPiAke2NvbERhdGEuaW5mby5idWZmZXJ9YDsKICAgICAgZGV0YWlscy5hcHBlbmRDaGlsZChidWZEaXYpOwogICAgfQogICAgaWYgKGNvbERhdGEuaW5mby5zY2llbnRpc3QpIHsKICAgICAgY29uc3Qgc2NpRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIHNjaURpdi5pbm5lckhUTUwgPSBgPHN0cm9uZz5TY2llbnRpc3Q6PC9zdHJvbmc+ICR7Y29sRGF0YS5pbmZvLnNjaWVudGlzdH1gOwogICAgICBkZXRhaWxzLmFwcGVuZENoaWxkKHNjaURpdik7CiAgICB9CiAgICAKICAgIGRpdi5hcHBlbmRDaGlsZChkZXRhaWxzKTsKICAgIAogICAgLy8gQ3JlYXRlIHNlcGFyYXRlIGNoZWNrYm94IGZvciBlYWNoIGRhdGFzZXQKICAgIGNvbERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IHBsYXRlID0gdmlld2VyRGF0YS5wbGF0ZXMuZmluZChwID0+IHAuaWQgPT09IHBsYXRlSWQpOwogICAgICBjb25zdCBmaWxlbmFtZSA9IHBsYXRlID8gKHBsYXRlLmZpbGUgfHwgcGxhdGUuaWQpIDogcGxhdGVJZDsKICAgICAgY29uc3Qgc2NpZW50aXN0ID0gcGxhdGUgJiYgcGxhdGUuY29sdW1uX2luZm8gPyAocGxhdGUuY29sdW1uX2luZm8uc2NpZW50aXN0IHx8ICIiKSA6ICIiOwogICAgICAKICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBjb2x1bW4gaXMgZW5hYmxlZCBmb3IgdGhpcyBzY2llbnRpc3QncyBkYXRhc2V0cwogICAgICBjb25zdCBlbmFibGVkQ29sdW1ucyA9IGdldEVuYWJsZWRDb2x1bW5zRm9yU2NpZW50aXN0KHNjaWVudGlzdCk7CiAgICAgIGNvbnN0IGNvbHVtbkVuYWJsZWQgPSBlbmFibGVkQ29sdW1ucy5zaXplID09PSAwIHx8IGVuYWJsZWRDb2x1bW5zLmhhcyhjb2wpOwogICAgICAKICAgICAgY29uc3QgZGF0YXNldERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBkYXRhc2V0RGl2LnN0eWxlLm1hcmdpbkxlZnQgPSAiOHB4IjsKICAgICAgZGF0YXNldERpdi5zdHlsZS5tYXJnaW5Ub3AgPSAiNHB4IjsKICAgICAgZGF0YXNldERpdi5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOwogICAgICBkYXRhc2V0RGl2LnN0eWxlLmFsaWduSXRlbXMgPSAiY2VudGVyIjsKICAgICAgCiAgICAgIGNvbnN0IGNoZWNrYm94ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgICAgY2hlY2tib3gudHlwZSA9ICJjaGVja2JveCI7CiAgICAgIGNoZWNrYm94LmlkID0gYGNvbHVtbi0ke2NvbH0tZGF0YXNldC0ke3BsYXRlSWR9YDsKICAgICAgY2hlY2tib3guY2hlY2tlZCA9IGNvbHVtbkVuYWJsZWQ7CiAgICAgIGNoZWNrYm94LnN0eWxlLm1hcmdpblJpZ2h0ID0gIjhweCI7CiAgICAgIGNoZWNrYm94LnN0eWxlLmN1cnNvciA9ICJwb2ludGVyIjsKICAgICAgY2hlY2tib3guZGF0YXNldC5jb2x1bW4gPSBjb2w7CiAgICAgIGNoZWNrYm94LmRhdGFzZXQucGxhdGVJZCA9IHBsYXRlSWQ7CiAgICAgIGNoZWNrYm94LmRhdGFzZXQuc2NpZW50aXN0ID0gc2NpZW50aXN0OwogICAgICAKICAgICAgY2hlY2tib3guYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgKGUpID0+IHsKICAgICAgICBjb25zdCBjb2x1bW4gPSBwYXJzZUludChlLnRhcmdldC5kYXRhc2V0LmNvbHVtbik7CiAgICAgICAgY29uc3Qgc2NpZW50aXN0ID0gZS50YXJnZXQuZGF0YXNldC5zY2llbnRpc3QgfHwgIiI7CiAgICAgICAgCiAgICAgICAgLy8gR2V0IGVuYWJsZWQgY29sdW1ucyBmb3IgdGhpcyBzY2llbnRpc3QKICAgICAgICBjb25zdCBlbmFibGVkQ29sdW1ucyA9IGdldEVuYWJsZWRDb2x1bW5zRm9yU2NpZW50aXN0KHNjaWVudGlzdCk7CiAgICAgICAgCiAgICAgICAgLy8gR2V0IGFsbCBjb2x1bW5zIHRoYXQgaGF2ZSBkYXRhIGZvciB0aGlzIHNjaWVudGlzdCdzIGRhdGFzZXRzCiAgICAgICAgY29uc3QgYWxsQ29sdW1uc1dpdGhEYXRhID0gbmV3IFNldCgpOwogICAgICAgIGFsbERhdGFzZXRzLmZvckVhY2gocElkID0+IHsKICAgICAgICAgIGNvbnN0IHAgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHBsID0+IHBsLmlkID09PSBwSWQpOwogICAgICAgICAgY29uc3QgcFNjaWVudGlzdCA9IHAgJiYgcC5jb2x1bW5faW5mbyA/IChwLmNvbHVtbl9pbmZvLnNjaWVudGlzdCB8fCAiIikgOiAiIjsKICAgICAgICAgIGlmIChwU2NpZW50aXN0ID09PSBzY2llbnRpc3QpIHsKICAgICAgICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcElkXSB8fCB7fTsKICAgICAgICAgICAgT2JqZWN0LmtleXMod2VsbHMpLmZvckVhY2god2VsbElkID0+IHsKICAgICAgICAgICAgICBjb25zdCBjb2wgPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAgICAgICAgICAgYWxsQ29sdW1uc1dpdGhEYXRhLmFkZChjb2wpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICAKICAgICAgICBpZiAoZS50YXJnZXQuY2hlY2tlZCkgewogICAgICAgICAgLy8gRW5hYmxpbmc6IGFkZCBjb2x1bW4gdG8gZW5hYmxlZCBzZXQgZm9yIHRoaXMgc2NpZW50aXN0CiAgICAgICAgICBlbmFibGVkQ29sdW1ucy5hZGQoY29sdW1uKTsKICAgICAgICAgIAogICAgICAgICAgLy8gSWYgYWxsIGNvbHVtbnMgdGhhdCBoYXZlIGRhdGEgYXJlIG5vdyBlbmFibGVkLCBjbGVhciB0aGUgc2V0IChtZWFuaW5nIGFsbCBlbmFibGVkKQogICAgICAgICAgLy8gVGhpcyBvcHRpbWl6ZXMgc3RvcmFnZTogZW1wdHkgc2V0ID0gYWxsIGVuYWJsZWQsIG5vbi1lbXB0eSBzZXQgPSBvbmx5IHRoZXNlIGVuYWJsZWQKICAgICAgICAgIGNvbnN0IGFsbENvbHVtbnNFbmFibGVkID0gQXJyYXkuZnJvbShhbGxDb2x1bW5zV2l0aERhdGEpLmV2ZXJ5KGNvbCA9PiBlbmFibGVkQ29sdW1ucy5oYXMoY29sKSk7CiAgICAgICAgICBpZiAoYWxsQ29sdW1uc0VuYWJsZWQgJiYgZW5hYmxlZENvbHVtbnMuc2l6ZSA9PT0gYWxsQ29sdW1uc1dpdGhEYXRhLnNpemUpIHsKICAgICAgICAgICAgZW5hYmxlZENvbHVtbnMuY2xlYXIoKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gRGlzYWJsaW5nOiBpZiBzZXQgaXMgZW1wdHkgKGFsbCBlbmFibGVkKSwgcG9wdWxhdGUgaXQgd2l0aCBhbGwgY29sdW1ucyBleGNlcHQgdGhlIG9uZSBiZWluZyB1bmNoZWNrZWQKICAgICAgICAgIGlmIChlbmFibGVkQ29sdW1ucy5zaXplID09PSAwKSB7CiAgICAgICAgICAgIC8vIEN1cnJlbnRseSBhbGwgYXJlIGVuYWJsZWQsIHNvIHBvcHVsYXRlIHNldCB3aXRoIGFsbCBjb2x1bW5zIGV4Y2VwdCB0aGUgb25lIGJlaW5nIHVuY2hlY2tlZAogICAgICAgICAgICBhbGxDb2x1bW5zV2l0aERhdGEuZm9yRWFjaChjb2wgPT4gewogICAgICAgICAgICAgIGlmIChjb2wgIT09IGNvbHVtbikgewogICAgICAgICAgICAgICAgZW5hYmxlZENvbHVtbnMuYWRkKGNvbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFNvbWUgY29sdW1ucyBhcmUgYWxyZWFkeSBkaXNhYmxlZCwgcmVtb3ZlIHRoaXMgb25lIGZyb20gZW5hYmxlZCBzZXQKICAgICAgICAgICAgY29uc3QgaGFkQ29sdW1uID0gZW5hYmxlZENvbHVtbnMuaGFzKGNvbHVtbik7CiAgICAgICAgICAgIGVuYWJsZWRDb2x1bW5zLmRlbGV0ZShjb2x1bW4pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gT25seSByZS1lbmFibGUgaWYgd2UganVzdCBkZWxldGVkIHRoZSBsYXN0IGVuYWJsZWQgY29sdW1uIChwcmV2ZW50IGRpc2FibGluZyBldmVyeXRoaW5nKQogICAgICAgICAgICAvLyBCdXQgb25seSBpZiB0aGVyZSBhcmUgb3RoZXIgY29sdW1ucyBhdmFpbGFibGUKICAgICAgICAgICAgaWYgKGVuYWJsZWRDb2x1bW5zLnNpemUgPT09IDAgJiYgYWxsQ29sdW1uc1dpdGhEYXRhLnNpemUgPiAxICYmIGhhZENvbHVtbikgewogICAgICAgICAgICAgIC8vIFJlLWVuYWJsZSBhbGwgY29sdW1ucyBleGNlcHQgdGhlIG9uZSBiZWluZyB1bmNoZWNrZWQKICAgICAgICAgICAgICBhbGxDb2x1bW5zV2l0aERhdGEuZm9yRWFjaChjb2wgPT4gewogICAgICAgICAgICAgICAgaWYgKGNvbCAhPT0gY29sdW1uKSB7CiAgICAgICAgICAgICAgICAgIGVuYWJsZWRDb2x1bW5zLmFkZChjb2wpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFVwZGF0ZSBhbGwgY2hlY2tib3hlcyBmb3IgYWxsIGNvbHVtbnMgZm9yIHRoaXMgc2NpZW50aXN0IHRvIHJlZmxlY3QgdGhlIG5ldyBzdGF0ZQogICAgICAgIC8vIFdlIG5lZWQgdG8gdXBkYXRlIGNoZWNrYm94ZXMgZm9yIGFsbCBjb2x1bW5zLCBub3QganVzdCB0aGUgb25lIHRoYXQgd2FzIHRvZ2dsZWQKICAgICAgICBjb25zdCBhbGxHcm91cERhdGFzZXRzID0gZ2V0QWxsRGF0YXNldHNJbkdyb3VwKCk7CiAgICAgICAgZm9yIChsZXQgYyA9IDE7IGMgPD0gUExBVEVfQ09MUzsgYysrKSB7CiAgICAgICAgICAvLyBGaW5kIGFsbCBkYXRhc2V0cyBmb3IgdGhpcyBjb2x1bW4gYW5kIHNjaWVudGlzdAogICAgICAgICAgY29uc3QgZGF0YXNldHNGb3JDb2wgPSBbXTsKICAgICAgICAgIGFsbEdyb3VwRGF0YXNldHMuZm9yRWFjaChwSWQgPT4gewogICAgICAgICAgICBjb25zdCBwID0gdmlld2VyRGF0YS5wbGF0ZXMuZmluZChwbCA9PiBwbC5pZCA9PT0gcElkKTsKICAgICAgICAgICAgY29uc3QgcFNjaWVudGlzdCA9IHAgJiYgcC5jb2x1bW5faW5mbyA/IChwLmNvbHVtbl9pbmZvLnNjaWVudGlzdCB8fCAiIikgOiAiIjsKICAgICAgICAgICAgaWYgKHBTY2llbnRpc3QgPT09IHNjaWVudGlzdCkgewogICAgICAgICAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BJZF0gfHwge307CiAgICAgICAgICAgICAgY29uc3QgaGFzRGF0YUluQ29sdW1uID0gT2JqZWN0LmtleXMod2VsbHMpLnNvbWUod2VsbElkID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHdlbGxDb2wgPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAgICAgICAgICAgICByZXR1cm4gd2VsbENvbCA9PT0gYzsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAoaGFzRGF0YUluQ29sdW1uKSB7CiAgICAgICAgICAgICAgICBkYXRhc2V0c0ZvckNvbC5wdXNoKHBJZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIGFsbCBjaGVja2JveGVzIGZvciB0aGlzIGNvbHVtbgogICAgICAgICAgZGF0YXNldHNGb3JDb2wuZm9yRWFjaChwSWQgPT4gewogICAgICAgICAgICBjb25zdCBjYiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBjb2x1bW4tJHtjfS1kYXRhc2V0LSR7cElkfWApOwogICAgICAgICAgICBpZiAoY2IpIHsKICAgICAgICAgICAgICBjb25zdCBpc0VuYWJsZWQgPSBlbmFibGVkQ29sdW1ucy5zaXplID09PSAwIHx8IGVuYWJsZWRDb2x1bW5zLmhhcyhjKTsKICAgICAgICAgICAgICBjYi5jaGVja2VkID0gaXNFbmFibGVkOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gUmUtcmVuZGVyIHRoZSBncmlkIGFuZCB1cGRhdGUgY2hhcnQKICAgICAgICByZW5kZXJQbGF0ZUdyaWQoKTsKICAgICAgICB1cGRhdGVXZWxsSW5mbygpOwogICAgICAgIHVwZGF0ZUNoYXJ0KCk7CiAgICAgIH0pOwogICAgICAKICAgICAgY29uc3QgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOwogICAgICBsYWJlbC5odG1sRm9yID0gYGNvbHVtbi0ke2NvbH0tZGF0YXNldC0ke3BsYXRlSWR9YDsKICAgICAgbGFiZWwuc3R5bGUuY3Vyc29yID0gInBvaW50ZXIiOwogICAgICBsYWJlbC5zdHlsZS5mb250U2l6ZSA9ICIwLjhyZW0iOwogICAgICBsYWJlbC50ZXh0Q29udGVudCA9IGZpbGVuYW1lOwogICAgICAKICAgICAgZGF0YXNldERpdi5hcHBlbmRDaGlsZChjaGVja2JveCk7CiAgICAgIGRhdGFzZXREaXYuYXBwZW5kQ2hpbGQobGFiZWwpOwogICAgICBkaXYuYXBwZW5kQ2hpbGQoZGF0YXNldERpdik7CiAgICB9KTsKICAgIAogICAgbGVnZW5kRGl2LmFwcGVuZENoaWxkKGRpdik7CiAgfSk7Cn0KCmZ1bmN0aW9uIHRvZ2dsZVdlbGxTZWxlY3Rpb24od2VsbElkLCBwbGF0ZUlkcykgewogIC8vIFRvZ2dsZSBzZWxlY3Rpb24gb25seSBmb3IgdGhlIHBsYXRlSWRzIHBhc3NlZCBpbiAod2hpY2ggYXJlIGFscmVhZHkgZmlsdGVyZWQgdG8gY3VycmVudCBzY2llbnRpc3QpCiAgLy8gcGxhdGVJZHMgc2hvdWxkIG9ubHkgY29udGFpbiBkYXRhc2V0cyBmcm9tIHRoZSBjdXJyZW50IHNjaWVudGlzdCdzIGdyaWQKICBpZiAocGxhdGVJZHMubGVuZ3RoID09PSAwKSByZXR1cm47CiAgCiAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogIGNvbnN0IGlzQ29udHJvbCA9IGlzQ29udHJvbFdlbGwod2VsbElkKTsKICAKICAvLyBDb250cm9sIHdlbGxzOiBhbGxvdyBpbmRpdmlkdWFsIHNlbGVjdGlvbiAoY2FuIHNlbGVjdCBlYWNoIHdlbGwgc2VwYXJhdGVseSkKICBpZiAoaXNDb250cm9sKSB7CiAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgICAvLyBDaGVjayBpZiB0aGlzIHNwZWNpZmljIGNvbnRyb2wgd2VsbCBpcyBhbHJlYWR5IHNlbGVjdGVkIChvbmx5IGluIHRoZSBwYXNzZWQgcGxhdGVJZHMpCiAgICBsZXQgaXNTZWxlY3RlZCA9IGZhbHNlOwogICAgcGxhdGVJZHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHtub3JtYWxpemVkV2VsbElkfWA7CiAgICAgIGlmIChzZWxlY3RlZFdlbGxzLmhhcyhrZXkpKSB7CiAgICAgICAgaXNTZWxlY3RlZCA9IHRydWU7CiAgICAgIH0KICAgIH0pOwogICAgCiAgICAvLyBUb2dnbGUganVzdCB0aGlzIGluZGl2aWR1YWwgY29udHJvbCB3ZWxsIGFjcm9zcyB0aGUgcGFzc2VkIHBsYXRlSWRzIG9ubHkKICAgIGxldCBhbnlDaGFuZ2VkID0gZmFsc2U7CiAgICBwbGF0ZUlkcy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgICAgY29uc3QgaGFzRGF0YSA9IHdlbGxzW25vcm1hbGl6ZWRXZWxsSWRdIHx8IHdlbGxzW3dlbGxJZF07CiAgICAgIGlmICghaGFzRGF0YSkgewogICAgICAgIHJldHVybjsgLy8gU2tpcCBpZiBubyBkYXRhCiAgICAgIH0KICAgICAgLy8gRmlsdGVyIGJ5IGVuYWJsZWRXZWxscyBpZiBhbnkgYXJlIHNldAogICAgICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCkgJiYgIWVuYWJsZWRXZWxscy5oYXMobm9ybWFsaXplZFdlbGxJZCkpIHsKICAgICAgICByZXR1cm47IC8vIFNraXAgZXhjbHVkZWQgd2VsbHMKICAgICAgfQogICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke25vcm1hbGl6ZWRXZWxsSWR9YDsKICAgICAgaWYgKGlzU2VsZWN0ZWQpIHsKICAgICAgICBzZWxlY3RlZFdlbGxzLmRlbGV0ZShrZXkpOwogICAgICB9IGVsc2UgewogICAgICAgIHNlbGVjdGVkV2VsbHMuYWRkKGtleSk7CiAgICAgIH0KICAgICAgYW55Q2hhbmdlZCA9IHRydWU7CiAgICB9KTsKICAgIAogICAgaWYgKGFueUNoYW5nZWQpIHsKICAgICAgcmVuZGVyUGxhdGVHcmlkKCk7CiAgICAgIHVwZGF0ZVdlbGxJbmZvKCk7CiAgICAgIHVwZGF0ZUNoYXJ0KCk7CiAgICB9CiAgICByZXR1cm47CiAgfQogIAogIC8vIEZvciBkdXBsaWNhdGUgd2VsbHMsIGF1dG9tYXRpY2FsbHkgc2VsZWN0IGFsbCBkYXRhc2V0cyBmb3IgY29tcGFyaXNvbiAob25seSBpbiBjdXJyZW50IHNjaWVudGlzdCdzIGdyaWQpCiAgaWYgKGlzRHVwbGljYXRlV2VsbCh3ZWxsSWQpKSB7CiAgICAvLyBPbmx5IHVzZSBkYXRhc2V0cyBmcm9tIHRoZSBwYXNzZWQgcGxhdGVJZHMgKGN1cnJlbnQgc2NpZW50aXN0J3MgZ3JpZCkKICAgIGNvbnN0IG5vcm1hbGl6ZWRXZWxsSWQgPSBub3JtYWxpemVXZWxsSWQod2VsbElkKTsKICAgIGNvbnN0IGRhdGFzZXRzV2l0aFdlbGwgPSBwbGF0ZUlkcy5maWx0ZXIocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICByZXR1cm4gd2VsbHNbbm9ybWFsaXplZFdlbGxJZF0gfHwgd2VsbHNbd2VsbElkXTsKICAgIH0pOwogICAgCiAgICAvLyBDaGVjayBpZiBhbnkgZGF0YXNldCBmb3IgdGhpcyB3ZWxsIGlzIGFscmVhZHkgc2VsZWN0ZWQgKG9ubHkgaW4gY3VycmVudCBzY2llbnRpc3QncyBncmlkKQogICAgbGV0IGlzQW55U2VsZWN0ZWQgPSBkYXRhc2V0c1dpdGhXZWxsLnNvbWUocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7bm9ybWFsaXplZFdlbGxJZH1gOwogICAgICByZXR1cm4gc2VsZWN0ZWRXZWxscy5oYXMoa2V5KTsKICAgIH0pOwogICAgCiAgICAvLyBUb2dnbGUgYWxsIGRhdGFzZXRzIGZvciB0aGlzIGR1cGxpY2F0ZSB3ZWxsIChvbmx5IGluIGN1cnJlbnQgc2NpZW50aXN0J3MgZ3JpZCkKICAgIGxldCBhbnlDaGFuZ2VkID0gZmFsc2U7CiAgICBkYXRhc2V0c1dpdGhXZWxsLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7bm9ybWFsaXplZFdlbGxJZH1gOwogICAgICBpZiAoaXNBbnlTZWxlY3RlZCkgewogICAgICAgIHNlbGVjdGVkV2VsbHMuZGVsZXRlKGtleSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VsZWN0ZWRXZWxscy5hZGQoa2V5KTsKICAgICAgfQogICAgICBhbnlDaGFuZ2VkID0gdHJ1ZTsKICAgIH0pOwogICAgCiAgICBpZiAoYW55Q2hhbmdlZCkgewogICAgICByZW5kZXJQbGF0ZUdyaWQoKTsKICAgICAgdXBkYXRlV2VsbEluZm8oKTsKICAgICAgdXBkYXRlQ2hhcnQoKTsKICAgIH0KICAgIHJldHVybjsKICB9CiAgCiAgLy8gRm9yIG5vbi1jb250cm9sIHdlbGxzLCBjaGVjayB0cmlwbGljYXRlIGdyb3VwcwogIGNvbnN0IHRyaXBsaWNhdGVHcm91cCA9IGdldFRyaXBsaWNhdGVHcm91cCh3ZWxsSWQsIGNvbHVtbik7CiAgCiAgbGV0IGFueUNoYW5nZWQgPSBmYWxzZTsKICAKICAvLyBDaGVjayBpZiB0cmlwbGljYXRlIGdyb3VwIGlzIHNlbGVjdGVkIChjaGVjayBpZiBBTEwgd2VsbHMgaW4gdGhlIGdyb3VwIGFyZSBzZWxlY3RlZCkKICAvLyBPbmx5IGNoZWNrIHdpdGhpbiB0aGUgcGFzc2VkIHBsYXRlSWRzIChjdXJyZW50IHNjaWVudGlzdCdzIGdyaWQpCiAgbGV0IGlzR3JvdXBTZWxlY3RlZCA9IGZhbHNlOwogIGlmICh0cmlwbGljYXRlR3JvdXApIHsKICAgIGNvbnN0IGdyb3VwUm93TGV0dGVycyA9IGdldFJvd0xldHRlcnNGcm9tV2VsbHModHJpcGxpY2F0ZUdyb3VwLndlbGxzKTsKICAgIC8vIENvdW50IGhvdyBtYW55IHdlbGxzIGluIHRoZSBncm91cCBhcmUgc2VsZWN0ZWQgKG9ubHkgaW4gY3VycmVudCBzY2llbnRpc3QncyBncmlkKQogICAgbGV0IHNlbGVjdGVkQ291bnQgPSAwOwogICAgbGV0IHRvdGFsQ291bnQgPSAwOwogICAgCiAgICBwbGF0ZUlkcy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgICAgZ3JvdXBSb3dMZXR0ZXJzLmZvckVhY2gocm93TGV0dGVyID0+IHsKICAgICAgICBjb25zdCB3SWQgPSByb3dMZXR0ZXIgKyBjb2x1bW47CiAgICAgICAgY29uc3Qgbm9ybWFsaXplZFdJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3SWQpOwogICAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7bm9ybWFsaXplZFdJZH1gOwogICAgICAgIGNvbnN0IGhhc0RhdGEgPSB3ZWxsc1tub3JtYWxpemVkV0lkXSB8fCB3ZWxsc1t3SWRdOwogICAgICAgIGlmIChoYXNEYXRhKSB7CiAgICAgICAgICB0b3RhbENvdW50Kys7CiAgICAgICAgICBpZiAoc2VsZWN0ZWRXZWxscy5oYXMoa2V5KSkgewogICAgICAgICAgICBzZWxlY3RlZENvdW50Kys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogICAgCiAgICAvLyBDb25zaWRlciBncm91cCBzZWxlY3RlZCBpZiBhdCBsZWFzdCBvbmUgd2VsbCBpcyBzZWxlY3RlZCAoZm9yIHRvZ2dsZSBiZWhhdmlvcikKICAgIC8vIFRoaXMgYWxsb3dzIGNsaWNraW5nIHRvIHRvZ2dsZSB0aGUgd2hvbGUgZ3JvdXAKICAgIGlzR3JvdXBTZWxlY3RlZCA9IHNlbGVjdGVkQ291bnQgPiAwOwogIH0gZWxzZSB7CiAgICAvLyBGb3Igbm9uLXRyaXBsaWNhdGUgd2VsbHMsIGNoZWNrIGlmIHRoaXMgc3BlY2lmaWMgd2VsbCBpcyBzZWxlY3RlZCAob25seSBpbiBjdXJyZW50IHNjaWVudGlzdCdzIGdyaWQpCiAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgICBwbGF0ZUlkcy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke25vcm1hbGl6ZWRXZWxsSWR9YDsKICAgICAgaWYgKHNlbGVjdGVkV2VsbHMuaGFzKGtleSkpIHsKICAgICAgICBpc0dyb3VwU2VsZWN0ZWQgPSB0cnVlOwogICAgICB9CiAgICB9KTsKICB9CiAgCiAgLy8gVG9nZ2xlIHNlbGVjdGlvbjogaWYgZ3JvdXAvd2VsbCBpcyBzZWxlY3RlZCwgcmVtb3ZlIGFsbDsgb3RoZXJ3aXNlIGFkZCBhbGwKICAvLyBPbmx5IG9wZXJhdGUgb24gcGxhdGVJZHMgKGN1cnJlbnQgc2NpZW50aXN0J3MgZ3JpZCkKICBpZiAodHJpcGxpY2F0ZUdyb3VwKSB7CiAgICAvLyBHZXQgcm93IGxldHRlcnMgZnJvbSB0aGUgdHJpcGxpY2F0ZSBncm91cCBwYXR0ZXJuCiAgICBjb25zdCBncm91cFJvd0xldHRlcnMgPSBnZXRSb3dMZXR0ZXJzRnJvbVdlbGxzKHRyaXBsaWNhdGVHcm91cC53ZWxscyk7CiAgICAKICAgIC8vIFRvZ2dsZSBhbGwgd2VsbHMgaW4gdGhlIHRyaXBsaWNhdGUgZ3JvdXAgKHNhbWUgcm93IHBhdHRlcm4sIHNhbWUgY29sdW1uKSBhY3Jvc3MgcGxhdGVJZHMgb25seQogICAgcGxhdGVJZHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICAgIGdyb3VwUm93TGV0dGVycy5mb3JFYWNoKHJvd0xldHRlciA9PiB7CiAgICAgICAgY29uc3Qgd0lkID0gcm93TGV0dGVyICsgY29sdW1uOwogICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRXSWQgPSBub3JtYWxpemVXZWxsSWQod0lkKTsKICAgICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke25vcm1hbGl6ZWRXSWR9YDsKICAgICAgICBjb25zdCBoYXNEYXRhID0gd2VsbHNbbm9ybWFsaXplZFdJZF0gfHwgd2VsbHNbd0lkXTsKICAgICAgICBpZiAoaGFzRGF0YSkgewogICAgICAgICAgLy8gRmlsdGVyIGJ5IGVuYWJsZWRXZWxscyBpZiBhbnkgYXJlIHNldAogICAgICAgICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3SWQpICYmICFlbmFibGVkV2VsbHMuaGFzKG5vcm1hbGl6ZWRXSWQpKSB7CiAgICAgICAgICAgIHJldHVybjsgLy8gU2tpcCBleGNsdWRlZCB3ZWxscwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzR3JvdXBTZWxlY3RlZCkgewogICAgICAgICAgICBzZWxlY3RlZFdlbGxzLmRlbGV0ZShrZXkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZWN0ZWRXZWxscy5hZGQoa2V5KTsKICAgICAgICAgIH0KICAgICAgICAgIGFueUNoYW5nZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9IGVsc2UgewogICAgLy8gVG9nZ2xlIGluZGl2aWR1YWwgd2VsbCBhY3Jvc3MgcGxhdGVJZHMgb25seSAoY3VycmVudCBzY2llbnRpc3QncyBncmlkKQogICAgY29uc3Qgbm9ybWFsaXplZFdlbGxJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpOwogICAgcGxhdGVJZHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICAgIGNvbnN0IGhhc0RhdGEgPSB3ZWxsc1tub3JtYWxpemVkV2VsbElkXSB8fCB3ZWxsc1t3ZWxsSWRdOwogICAgICBpZiAoIWhhc0RhdGEpIHsKICAgICAgICByZXR1cm47IC8vIFNraXAgaWYgbm8gZGF0YQogICAgICB9CiAgICAgIC8vIEZpbHRlciBieSBlbmFibGVkV2VsbHMgaWYgYW55IGFyZSBzZXQKICAgICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3ZWxsSWQpICYmICFlbmFibGVkV2VsbHMuaGFzKG5vcm1hbGl6ZWRXZWxsSWQpKSB7CiAgICAgICAgcmV0dXJuOyAvLyBTa2lwIGV4Y2x1ZGVkIHdlbGxzCiAgICAgIH0KICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHtub3JtYWxpemVkV2VsbElkfWA7CiAgICAgIGlmIChpc0dyb3VwU2VsZWN0ZWQpIHsKICAgICAgICBzZWxlY3RlZFdlbGxzLmRlbGV0ZShrZXkpOwogICAgICB9IGVsc2UgewogICAgICAgIHNlbGVjdGVkV2VsbHMuYWRkKGtleSk7CiAgICAgIH0KICAgICAgYW55Q2hhbmdlZCA9IHRydWU7CiAgICB9KTsKICB9CiAgCiAgaWYgKGFueUNoYW5nZWQpIHsKICAgIHJlbmRlclBsYXRlR3JpZCgpOwogICAgdXBkYXRlV2VsbEluZm8oKTsKICB9Cn0KCmZ1bmN0aW9uIGNsZWFyU2VsZWN0aW9uKCkgewogIHNlbGVjdGVkV2VsbHMuY2xlYXIoKTsKICByZW5kZXJQbGF0ZUdyaWQoKTsKICB1cGRhdGVDaGFydCgpOwp9CgpmdW5jdGlvbiB1cGRhdGVXZWxsSW5mbygpIHsKICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ3ZWxsLWluZm8iKTsKICBpZiAoc2VsZWN0ZWRXZWxscy5zaXplID09PSAwKSB7CiAgICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogICAgY29uc3QgZGF0YXNldENvdW50ID0gc2VsZWN0ZWREYXRhc2V0cy5sZW5ndGg7CiAgICBpZiAoZGF0YXNldENvdW50ID4gMSkgewogICAgICBlbC50ZXh0Q29udGVudCA9IGBTZWxlY3RlZCBncm91cCB3aXRoICR7ZGF0YXNldENvdW50fSBkYXRhc2V0cy4gQ2xpY2sgd2VsbHMgb24gdGhlIHBsYXRlIHRvIGFkZCB0aGVtIHRvIHRoZSBjaGFydC5gOwogICAgfSBlbHNlIHsKICAgICAgZWwudGV4dENvbnRlbnQgPSAiQ2xpY2sgd2VsbHMgb24gdGhlIHBsYXRlIHRvIGFkZCB0aGVtIHRvIHRoZSBjaGFydC4iOwogICAgfQogICAgcmV0dXJuOwogIH0KICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogIGNvbnN0IGRhdGFzZXRDb3VudCA9IHNlbGVjdGVkRGF0YXNldHMubGVuZ3RoOwogIGNvbnN0IHVuaXF1ZVdlbGxzID0gbmV3IFNldChBcnJheS5mcm9tKHNlbGVjdGVkV2VsbHMpLm1hcChrZXkgPT4ga2V5LnNwbGl0KCI6IilbMV0pKTsKICBjb25zdCB3ZWxsQ291bnQgPSB1bmlxdWVXZWxscy5zaXplOwogIGlmIChkYXRhc2V0Q291bnQgPiAxKSB7CiAgICBlbC50ZXh0Q29udGVudCA9IGAke3dlbGxDb3VudH0gd2VsbChzKSBzZWxlY3RlZCBhY3Jvc3MgJHtkYXRhc2V0Q291bnR9IGRhdGFzZXRzLiBDbGljayAiVXBkYXRlIENoYXJ0IiB0byBkaXNwbGF5LmA7CiAgfSBlbHNlIHsKICAgIGVsLnRleHRDb250ZW50ID0gYCR7d2VsbENvdW50fSB3ZWxsKHMpIHNlbGVjdGVkLiBDbGljayAiVXBkYXRlIENoYXJ0IiB0byBkaXNwbGF5LmA7CiAgfQp9CgpmdW5jdGlvbiBpc0NvbnRyb2xXZWxsKHdlbGxJZCkgewogIC8vIENvbnRyb2wgd2VsbHMgYXJlIGNvbmZpZ3VyYWJsZSB2aWEgY29udHJvbF9yb3dzIGluIGNvbmZpZyAoZGVmYXVsdDogWyJOIiwgIk8iXSkKICBjb25zdCBjb25maWcgPSB2aWV3ZXJEYXRhLmNvbmZpZyB8fCB7fTsKICBjb25zdCBjb250cm9sUm93cyA9IGNvbmZpZy5jb250cm9sX3Jvd3MgfHwgWyJOIiwgIk8iXTsKICBjb25zdCByb3dMZXR0ZXIgPSB3ZWxsSWQucmVwbGFjZSgvWzAtOV0vZywgJycpOwogIHJldHVybiBjb250cm9sUm93cy5pbmNsdWRlcyhyb3dMZXR0ZXIpOwp9CgpmdW5jdGlvbiBmb3JtYXRMYWJlbChsYWJlbCkgewogIC8vIEZvcm1hdCBsYWJlbHM6IHJlbW92ZSAidU0iIGFuZCBjb252ZXJ0IHRvICJudW1iZXItbnVtYmVyLW51bWJlciIgZm9ybWF0CiAgLy8gRXhhbXBsZXM6ICIyNTAgdU0gMTAtMiIgLT4gIjI1MC0xMC0yIiwgIjUwMCB1TSA1LTIiIC0+ICI1MDAtNS0yIgogIGlmICghbGFiZWwpIHJldHVybiBsYWJlbDsKICAKICAvLyBSZW1vdmUgInVNIiAoY2FzZSBpbnNlbnNpdGl2ZSkgYW5kIGV4dHJhIHNwYWNlcwogIGxldCBmb3JtYXR0ZWQgPSBsYWJlbC5yZXBsYWNlKC9ccyp1TVxzKi9naSwgJyAnKS5yZXBsYWNlKC9ccysvZywgJyAnKS50cmltKCk7CiAgCiAgLy8gRXh0cmFjdCBudW1iZXJzIGFuZCBoeXBoZW5zLCByZXBsYWNlIHNwYWNlcyB3aXRoIGh5cGhlbnMKICAvLyBNYXRjaCBwYXR0ZXJuOiBudW1iZXIocykgZm9sbG93ZWQgYnkgb3B0aW9uYWwgc3BhY2UvaHlwaGVuIGFuZCBtb3JlIG51bWJlcnMKICBmb3JtYXR0ZWQgPSBmb3JtYXR0ZWQucmVwbGFjZSgvKFxkKylccyotXHMqKFxkKykvZywgJyQxLSQyJyk7IC8vIEhhbmRsZSBleGlzdGluZyBoeXBoZW5zCiAgZm9ybWF0dGVkID0gZm9ybWF0dGVkLnJlcGxhY2UoLyhcZCspXHMrKFxkKykvZywgJyQxLSQyJyk7IC8vIFJlcGxhY2Ugc3BhY2VzIGJldHdlZW4gbnVtYmVycyB3aXRoIGh5cGhlbnMKICAKICByZXR1cm4gZm9ybWF0dGVkOwp9CgpmdW5jdGlvbiBnZXRSb3dMZXR0ZXIod2VsbElkKSB7CiAgLy8gRXh0cmFjdCByb3cgbGV0dGVyIGZyb20gd2VsbCBJRCAoZS5nLiwgIkIxMyIgLT4gIkIiKQogIHJldHVybiB3ZWxsSWQucmVwbGFjZSgvWzAtOV0vZywgJycpOwp9CgpmdW5jdGlvbiBnZXRUcmlwbGljYXRlR3JvdXAod2VsbElkLCBjb2x1bW4pIHsKICAvLyBDb250cm9sIHdlbGxzIHNob3VsZCBuZXZlciBiZSBwYXJ0IG9mIGdyb3VwcwogIGlmIChpc0NvbnRyb2xXZWxsKHdlbGxJZCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICAKICBjb25zdCBjb25maWcgPSB2aWV3ZXJEYXRhLmNvbmZpZyB8fCB7fTsKICBjb25zdCBncm91cHMgPSBjb25maWcuZ3JvdXBzIHx8IFtdOwogIGNvbnN0IHJvd0xldHRlciA9IGdldFJvd0xldHRlcih3ZWxsSWQpOwogIAogIC8vIEZpbmQgZ3JvdXAgdGhhdCBtYXRjaGVzIHRoZSByb3cgcGF0dGVybiAoQkNELCBFRkcsIGV0Yy4pIC0gYXBwbGllcyB0byBhbGwgY29sdW1ucwogIHJldHVybiBncm91cHMuZmluZChncm91cCA9PiB7CiAgICBpZiAoIWdyb3VwLndlbGxzIHx8IGdyb3VwLndlbGxzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAKICAgIC8vIEV4dHJhY3Qgcm93IGxldHRlcnMgZnJvbSB0aGUgZ3JvdXAncyB3ZWxscwogICAgY29uc3QgZ3JvdXBSb3dMZXR0ZXJzID0gZ2V0Um93TGV0dGVyc0Zyb21XZWxscyhncm91cC53ZWxscyk7CiAgICAKICAgIC8vIENoZWNrIGlmIHRoaXMgd2VsbCdzIHJvdyBsZXR0ZXIgbWF0Y2hlcyBhbnkgcm93IGluIHRoZSBncm91cCBwYXR0ZXJuCiAgICAvLyBHcm91cHMgYXBwbHkgdG8gYWxsIGNvbHVtbnMsIHNvIG5vIGNvbHVtbiBjaGVjayBuZWVkZWQKICAgIHJldHVybiBncm91cFJvd0xldHRlcnMuaW5jbHVkZXMocm93TGV0dGVyKTsKICB9KTsKfQoKZnVuY3Rpb24gbm9ybWFsaXplV2VsbElkKHdlbGxJZCkgewogIC8vIE5vcm1hbGl6ZSB3ZWxsIElEIHRvIGNvbnNpc3RlbnQgZm9ybWF0OiB1cHBlcmNhc2Ugd2l0aCB6ZXJvLXBhZGRlZCBjb2x1bW4gKGUuZy4sICJCNSIgLT4gIkIwNSIsICJCMTMiIC0+ICJCMTMiKQogIGNvbnN0IG1hdGNoID0gU3RyaW5nKHdlbGxJZCkudHJpbSgpLnRvVXBwZXJDYXNlKCkubWF0Y2goL14oW0EtWl0pKFxkKykkLyk7CiAgaWYgKG1hdGNoKSB7CiAgICBjb25zdCByb3cgPSBtYXRjaFsxXTsKICAgIGNvbnN0IGNvbCA9IHBhcnNlSW50KG1hdGNoWzJdKTsKICAgIHJldHVybiByb3cgKyBTdHJpbmcoY29sKS5wYWRTdGFydCgyLCAnMCcpOwogIH0KICByZXR1cm4gU3RyaW5nKHdlbGxJZCkudHJpbSgpLnRvVXBwZXJDYXNlKCk7Cn0KCmZ1bmN0aW9uIGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKSB7CiAgLy8gRXh0cmFjdCBjb2x1bW4gbnVtYmVyIGZyb20gd2VsbCBJRCAoZS5nLiwgIkIxMyIgLT4gMTMpCiAgcmV0dXJuIHBhcnNlSW50KHdlbGxJZC5yZXBsYWNlKC9bQS1aXS9nLCAnJykpOwp9CgpmdW5jdGlvbiBnZXRSb3dMZXR0ZXJzRnJvbVdlbGxzKHdlbGxzKSB7CiAgLy8gRXh0cmFjdCByb3cgbGV0dGVycyBmcm9tIHdlbGxzIGFycmF5CiAgLy8gV2VsbHMgY2FuIGJlIGVpdGhlciByb3cgbGV0dGVycyAoZS5nLiwgWyJCIiwgIkMiLCAiRCJdKSBvciBmdWxsIHdlbGwgSURzIChlLmcuLCBbIkIxMyIsICJDMTMiLCAiRDEzIl0pCiAgcmV0dXJuIHdlbGxzLm1hcCh3ID0+IHsKICAgIC8vIElmIGl0J3MgYSBmdWxsIHdlbGwgSUQsIGV4dHJhY3Qgcm93IGxldHRlcjsgb3RoZXJ3aXNlIGFzc3VtZSBpdCdzIGFscmVhZHkgYSByb3cgbGV0dGVyCiAgICBpZiAody5sZW5ndGggPiAxICYmIC9eW0EtWl0vLnRlc3QodykgJiYgL1swLTldLy50ZXN0KHcpKSB7CiAgICAgIHJldHVybiBnZXRSb3dMZXR0ZXIodyk7CiAgICB9CiAgICByZXR1cm4gdzsgLy8gQWxyZWFkeSBhIHJvdyBsZXR0ZXIKICB9KTsKfQoKLy8gQ29sb3IgcGFsZXR0ZSBmb3IgdHJpcGxpY2F0ZSBncm91cHMgLSBlYWNoIGdyb3VwIGdldHMgYSBkaXN0aW5jdCBjb2xvcgpjb25zdCBUUklQTElDQVRFX0NPTE9SUyA9IFsKICB7IGJvcmRlcjogIiNmZjZiNmIiLCBiZzogIiNmZmUwZTAiLCBiZ1NlbGVjdGVkOiAiI2ZmY2NjYyIsIGJnSGFzRGF0YTogIiNmZmU4ZTgiIH0sIC8vIFJlZAogIHsgYm9yZGVyOiAiIzRlY2RjNCIsIGJnOiAiI2UwZjdmNSIsIGJnU2VsZWN0ZWQ6ICIjY2NmMGVkIiwgYmdIYXNEYXRhOiAiI2U4ZjlmNyIgfSwgLy8gVGVhbAogIHsgYm9yZGVyOiAiIzQ1YjdkMSIsIGJnOiAiI2UwZjJmNyIsIGJnU2VsZWN0ZWQ6ICIjY2NlOGYwIiwgYmdIYXNEYXRhOiAiI2U4ZjVmYSIgfSwgLy8gQmx1ZQogIHsgYm9yZGVyOiAiI2Y5Y2EyNCIsIGJnOiAiI2ZmZjllMCIsIGJnU2VsZWN0ZWQ6ICIjZmZmM2NjIiwgYmdIYXNEYXRhOiAiI2ZmZmJlOCIgfSwgLy8gWWVsbG93CiAgeyBib3JkZXI6ICIjNmM1Y2U3IiwgYmc6ICIjZWRlYWY3IiwgYmdTZWxlY3RlZDogIiNkZGQ0ZjAiLCBiZ0hhc0RhdGE6ICIjZjBlY2Y5IiB9LCAvLyBQdXJwbGUKICB7IGJvcmRlcjogIiNhMjliZmUiLCBiZzogIiNlZGVhZjciLCBiZ1NlbGVjdGVkOiAiI2RkZDRmMCIsIGJnSGFzRGF0YTogIiNmMGVjZjkiIH0sIC8vIExpZ2h0IFB1cnBsZQogIHsgYm9yZGVyOiAiI2ZkNzlhOCIsIGJnOiAiI2ZmZTBlZCIsIGJnU2VsZWN0ZWQ6ICIjZmZjY2UwIiwgYmdIYXNEYXRhOiAiI2ZmZThmMCIgfSwgLy8gUGluawogIHsgYm9yZGVyOiAiIzAwYjg5NCIsIGJnOiAiI2UwZjVmMCIsIGJnU2VsZWN0ZWQ6ICIjY2NlZGU1IiwgYmdIYXNEYXRhOiAiI2U4ZjdmMiIgfSwgLy8gR3JlZW4KICB7IGJvcmRlcjogIiNlMTcwNTUiLCBiZzogIiNmZmUwZDkiLCBiZ1NlbGVjdGVkOiAiI2ZmY2NiYiIsIGJnSGFzRGF0YTogIiNmZmU4ZTAiIH0sIC8vIE9yYW5nZQogIHsgYm9yZGVyOiAiIzc0YjlmZiIsIGJnOiAiI2UwZjBmZiIsIGJnU2VsZWN0ZWQ6ICIjY2NlMGZmIiwgYmdIYXNEYXRhOiAiI2U4ZjVmZiIgfSwgLy8gTGlnaHQgQmx1ZQogIHsgYm9yZGVyOiAiIzU1ZWZjNCIsIGJnOiAiI2UwZmFmNSIsIGJnU2VsZWN0ZWQ6ICIjY2NmNWViIiwgYmdIYXNEYXRhOiAiI2U4ZmJmNyIgfSwgLy8gTWludAogIHsgYm9yZGVyOiAiI2ZkY2I2ZSIsIGJnOiAiI2ZmZjVlMCIsIGJnU2VsZWN0ZWQ6ICIjZmZlYmNjIiwgYmdIYXNEYXRhOiAiI2ZmZjhlOCIgfSAgLy8gTGlnaHQgT3JhbmdlCl07CgovLyBNYXAgdHJpcGxpY2F0ZSBncm91cCBuYW1lcyB0byBjb2xvcnMgKGNvbnNpc3RlbnQgYWNyb3NzIHRoZSBhcHApCmxldCB0cmlwbGljYXRlR3JvdXBDb2xvck1hcCA9IHt9OwoKZnVuY3Rpb24gZ2V0VHJpcGxpY2F0ZUdyb3VwQ29sb3IoZ3JvdXBOYW1lKSB7CiAgaWYgKCFncm91cE5hbWUpIHJldHVybiBudWxsOwogIAogIC8vIEVuc3VyZSBjb2xvciBtYXAgaXMgaW5pdGlhbGl6ZWQKICBpbml0aWFsaXplVHJpcGxpY2F0ZUdyb3VwQ29sb3JzKCk7CiAgCiAgLy8gTm9ybWFsaXplIGdyb3VwIG5hbWUgdG8gZW5zdXJlIGNvbnNpc3RlbnQgbG9va3VwCiAgY29uc3Qgbm9ybWFsaXplZE5hbWUgPSBTdHJpbmcoZ3JvdXBOYW1lKS50cmltKCk7CiAgCiAgLy8gUmV0dXJuIHRoZSBjb2xvciBmb3IgdGhpcyBncm91cCBuYW1lIChzYW1lIGNvbG9yIGZvciBhbGwgd2VsbHMgaW4gdGhlIGdyb3VwKQogIC8vIEFsbCB3ZWxscyB3aXRoIHRoZSBzYW1lIGdyb3VwIG5hbWUgd2lsbCBnZXQgdGhlIHNhbWUgY29sb3IKICAvLyBGb3IgZXhhbXBsZSwgYWxsIHdlbGxzIGluIHJvd3MgQiwgQywgRCB3aXRoIGdyb3VwICIyNTAtMTAtMiIgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgcmV0dXJuIHRyaXBsaWNhdGVHcm91cENvbG9yTWFwW25vcm1hbGl6ZWROYW1lXSB8fCBUUklQTElDQVRFX0NPTE9SU1swXTsKfQoKZnVuY3Rpb24gaXNEdXBsaWNhdGVXZWxsKHdlbGxJZCkgewogIC8vIENoZWNrIGlmIHRoaXMgd2VsbCdzIGNvbHVtbiBpcyBpbiB0aGUgZHVwbGljYXRlIHdhcm5pbmdzCiAgaWYgKCF2aWV3ZXJEYXRhIHx8ICF2aWV3ZXJEYXRhLmNvbmZpZyB8fCAhdmlld2VyRGF0YS5jb25maWcud2FybmluZ3MpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogIGNvbnN0IHdhcm5pbmdzID0gdmlld2VyRGF0YS5jb25maWcud2FybmluZ3MuZHVwbGljYXRlX2NvbHVtbnMgfHwgW107CiAgcmV0dXJuIHdhcm5pbmdzLnNvbWUod2FybmluZyA9PiB7CiAgICBjb25zdCBjb2x1bW5zID0gd2FybmluZy5jb2x1bW5zIHx8IFtdOwogICAgcmV0dXJuIGNvbHVtbnMuaW5jbHVkZXMoY29sdW1uKTsKICB9KTsKfQoKZnVuY3Rpb24gZ2V0RHVwbGljYXRlRmlsZXMod2VsbElkKSB7CiAgLy8gR2V0IHRoZSBsaXN0IG9mIGZpbGVzIHRoYXQgaGF2ZSB0aGlzIGR1cGxpY2F0ZSB3ZWxsJ3MgY29sdW1uCiAgaWYgKCF2aWV3ZXJEYXRhIHx8ICF2aWV3ZXJEYXRhLmNvbmZpZyB8fCAhdmlld2VyRGF0YS5jb25maWcud2FybmluZ3MpIHsKICAgIHJldHVybiBbXTsKICB9CiAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogIGNvbnN0IHdhcm5pbmdzID0gdmlld2VyRGF0YS5jb25maWcud2FybmluZ3MuZHVwbGljYXRlX2NvbHVtbnMgfHwgW107CiAgZm9yIChjb25zdCB3YXJuaW5nIG9mIHdhcm5pbmdzKSB7CiAgICBjb25zdCBjb2x1bW5zID0gd2FybmluZy5jb2x1bW5zIHx8IFtdOwogICAgaWYgKGNvbHVtbnMuaW5jbHVkZXMoY29sdW1uKSkgewogICAgICByZXR1cm4gd2FybmluZy5maWxlcyB8fCBbXTsKICAgIH0KICB9CiAgcmV0dXJuIFtdOwp9CgpmdW5jdGlvbiBnZXRBbGxVbmlxdWVUaW1lUG9pbnRzKHdlbGxzKSB7CiAgLy8gQ29sbGVjdCBhbGwgdW5pcXVlIHRpbWUgcG9pbnRzIGZyb20gYWxsIHdlbGxzCiAgY29uc3QgYWxsVGltZVBvaW50cyA9IG5ldyBTZXQoKTsKICB3ZWxscy5mb3JFYWNoKHdlbGwgPT4gewogICAgaWYgKHdlbGwudGltZV9zKSB7CiAgICAgIHdlbGwudGltZV9zLmZvckVhY2godCA9PiB7CiAgICAgICAgaWYgKHQgIT09IG51bGwgJiYgdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBhbGxUaW1lUG9pbnRzLmFkZCh0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0pOwogIHJldHVybiBBcnJheS5mcm9tKGFsbFRpbWVQb2ludHMpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKfQoKZnVuY3Rpb24gY2FsY3VsYXRlTWVhbkFuZEVycm9yKHdlbGxzLCB0aW1lUG9pbnRzKSB7CiAgLy8gQ2FsY3VsYXRlIG1lYW4gYW5kIHN0YW5kYXJkIGVycm9yIGZvciB0cmlwbGljYXRlcyBhdCBlYWNoIHRpbWUgcG9pbnQKICBjb25zdCBtZWFucyA9IFtdOwogIGNvbnN0IGVycm9ycyA9IFtdOwogIAogIHRpbWVQb2ludHMuZm9yRWFjaCgodGltZSwgaWR4KSA9PiB7CiAgICBjb25zdCB2YWx1ZXMgPSB3ZWxscy5tYXAodyA9PiB7CiAgICAgIGNvbnN0IHRpbWVJZHggPSB3LnRpbWVfcy5pbmRleE9mKHRpbWUpOwogICAgICByZXR1cm4gdGltZUlkeCA+PSAwID8gdy52YWx1ZXNbdGltZUlkeF0gOiBudWxsOwogICAgfSkuZmlsdGVyKHYgPT4gdiAhPT0gbnVsbCk7CiAgICAKICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIG1lYW5zLnB1c2gobnVsbCk7CiAgICAgIGVycm9ycy5wdXNoKG51bGwpOwogICAgICByZXR1cm47CiAgICB9CiAgICAKICAgIGNvbnN0IG1lYW4gPSB2YWx1ZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyB2YWx1ZXMubGVuZ3RoOwogICAgLy8gVXNlIHNhbXBsZSB2YXJpYW5jZSAoZGl2aWRlIGJ5IG4tMSkgZm9yIHByb3BlciBTRU0gY2FsY3VsYXRpb24KICAgIGNvbnN0IG4gPSB2YWx1ZXMubGVuZ3RoOwogICAgY29uc3QgdmFyaWFuY2UgPSBuID4gMSAKICAgICAgPyB2YWx1ZXMucmVkdWNlKChzdW0sIHZhbCkgPT4gc3VtICsgTWF0aC5wb3codmFsIC0gbWVhbiwgMiksIDApIC8gKG4gLSAxKQogICAgICA6IDA7CiAgICBjb25zdCBzdGREZXYgPSBNYXRoLnNxcnQodmFyaWFuY2UpOwogICAgY29uc3Qgc3RkRXJyb3IgPSBzdGREZXYgLyBNYXRoLnNxcnQobik7CiAgICAKICAgIG1lYW5zLnB1c2gobWVhbik7CiAgICBlcnJvcnMucHVzaChzdGRFcnJvcik7CiAgfSk7CiAgCiAgcmV0dXJuIHsgbWVhbnMsIGVycm9ycyB9Owp9CgpmdW5jdGlvbiBwcm9jZXNzV2VsbHNBbmRDYWxjdWxhdGVNZWFuKHdlbGxzLCBpc05vcm1hbGl6ZWQgPSBmYWxzZSwgYmFzZWxpbmVFbmRUaW1lID0gMjQsIGN1dG9mZlRpbWUgPSAzNjApIHsKICAvLyBXT1JLRkxPVzogQWx3YXlzIHByb2Nlc3MgZWFjaCB3ZWxsIGluZGl2aWR1YWxseSBmaXJzdCwgdGhlbiBhdmVyYWdlCiAgLy8gSWYgbm9ybWFsaXplZDogbm9ybWFsaXplIGVhY2ggd2VsbCB0byBpdHMgT1dOIGJhc2VsaW5lIGZpcnN0LCB0aGVuIGNhbGN1bGF0ZSBtZWFuIGFuZCBlcnJvcgogIC8vIElmIG5vdCBub3JtYWxpemVkOiBwcm9jZXNzIGVhY2ggd2VsbCBpbmRpdmlkdWFsbHkgKG5vIG5vcm1hbGl6YXRpb24pLCB0aGVuIGNhbGN1bGF0ZSBtZWFuIGFuZCBlcnJvcgogIC8vIFRoaXMgZW5zdXJlcyBjb3JyZWN0IG5vcm1hbGl6YXRpb24gZXZlbiB3aGVuIGNvbWJpbmluZyB3ZWxscyBmcm9tIGRpZmZlcmVudCBjb2x1bW5zIHdpdGggZGlmZmVyZW50IGJhc2VsaW5lcwogIC8vIFJldHVybnMgeyBmaWx0ZXJlZFRpbWVQb2ludHMsIG1lYW5zLCBlcnJvcnMsIG9yaWdpbmFsTWVhbnMgfQogIAogIC8vIFN0ZXAgMTogUHJvY2VzcyBlYWNoIHdlbGwgaW5kaXZpZHVhbGx5IChub3JtYWxpemUgaWYgZW5hYmxlZCwgb3RoZXJ3aXNlIHVzZSByYXcgZGF0YSkKICBjb25zdCBwcm9jZXNzZWRXZWxscyA9IHdlbGxzLm1hcCh3ZWxsID0+IHsKICAgIGNvbnN0IGZpbHRlcmVkVGltZVBvaW50cyA9IFtdOwogICAgY29uc3QgcHJvY2Vzc2VkVmFsdWVzID0gW107CiAgICBjb25zdCBvcmlnaW5hbFZhbHVlcyA9IFtdOwogICAgCiAgICBpZiAoIXdlbGwudGltZV9zIHx8ICF3ZWxsLnZhbHVlcykgewogICAgICByZXR1cm4geyB0aW1lUG9pbnRzOiBbXSwgdmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgICB9CiAgICAKICAgIGlmIChpc05vcm1hbGl6ZWQpIHsKICAgICAgLy8gTm9ybWFsaXplIHRoaXMgd2VsbCBieSBpdHMgb3duIGJhc2VsaW5lCiAgICAgIGNvbnN0IGJhc2VsaW5lVmFsdWVzID0gW107CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbC50aW1lX3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB0aW1lID0gd2VsbC50aW1lX3NbaV07CiAgICAgICAgY29uc3QgdmFsID0gd2VsbC52YWx1ZXNbaV07CiAgICAgICAgaWYgKHRpbWUgIT09IG51bGwgJiYgdmFsICE9PSBudWxsICYmIHRpbWUgPD0gYmFzZWxpbmVFbmRUaW1lKSB7CiAgICAgICAgICBiYXNlbGluZVZhbHVlcy5wdXNoKHZhbCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIAogICAgICBpZiAoYmFzZWxpbmVWYWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgLy8gTm8gYmFzZWxpbmUgZGF0YSBmb3IgdGhpcyB3ZWxsLCBza2lwIGl0CiAgICAgICAgcmV0dXJuIHsgdGltZVBvaW50czogW10sIHZhbHVlczogW10sIG9yaWdpbmFsVmFsdWVzOiBbXSB9OwogICAgICB9CiAgICAgIAogICAgICBjb25zdCB3ZWxsQmFzZWxpbmUgPSBiYXNlbGluZVZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIGJhc2VsaW5lVmFsdWVzLmxlbmd0aDsKICAgICAgCiAgICAgIGlmICh3ZWxsQmFzZWxpbmUgPT09IDAgfHwgIWlzRmluaXRlKHdlbGxCYXNlbGluZSkpIHsKICAgICAgICAvLyBJbnZhbGlkIGJhc2VsaW5lIGZvciB0aGlzIHdlbGwsIHNraXAgaXQKICAgICAgICByZXR1cm4geyB0aW1lUG9pbnRzOiBbXSwgdmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgICAgIH0KICAgICAgCiAgICAgIC8vIE5vcm1hbGl6ZSBhbmQgZmlsdGVyOiBvbmx5IGluY2x1ZGUgcG9pbnRzIGFmdGVyIGJhc2VsaW5lRW5kVGltZSBhbmQgdXAgdG8gY3V0b2ZmVGltZQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdlbGwudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgdGltZSA9IHdlbGwudGltZV9zW2ldOwogICAgICAgIGNvbnN0IHZhbCA9IHdlbGwudmFsdWVzW2ldOwogICAgICAgIAogICAgICAgIGlmICh0aW1lID09PSBudWxsIHx8IHZhbCA9PT0gbnVsbCkgY29udGludWU7CiAgICAgICAgCiAgICAgICAgLy8gT25seSBpbmNsdWRlIHBvaW50cyBhZnRlciBiYXNlbGluZUVuZFRpbWUgYW5kIHVwIHRvIGN1dG9mZlRpbWUKICAgICAgICBpZiAodGltZSA+IGJhc2VsaW5lRW5kVGltZSAmJiB0aW1lIDw9IGN1dG9mZlRpbWUpIHsKICAgICAgICAgIC8vIFN1YnRyYWN0IGJhc2VsaW5lRW5kVGltZSB0byBicmluZyBmaXJzdCBwb2ludCB0byB4PTAgKHRpbWUgYWZ0ZXIgaW5qZWN0aW9uKQogICAgICAgICAgZmlsdGVyZWRUaW1lUG9pbnRzLnB1c2godGltZSAtIGJhc2VsaW5lRW5kVGltZSk7CiAgICAgICAgICAvLyBEaXZpZGUgYnkgdGhpcyB3ZWxsJ3Mgb3duIGJhc2VsaW5lCiAgICAgICAgICBwcm9jZXNzZWRWYWx1ZXMucHVzaCh2YWwgLyB3ZWxsQmFzZWxpbmUpOwogICAgICAgICAgb3JpZ2luYWxWYWx1ZXMucHVzaCh2YWwpOyAvLyBTdG9yZSBvcmlnaW5hbCB2YWx1ZQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gTm90IG5vcm1hbGl6ZWQ6IHVzZSBhbGwgcmF3IGRhdGEgcG9pbnRzCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbC50aW1lX3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB0aW1lID0gd2VsbC50aW1lX3NbaV07CiAgICAgICAgY29uc3QgdmFsID0gd2VsbC52YWx1ZXNbaV07CiAgICAgICAgCiAgICAgICAgaWYgKHRpbWUgPT09IG51bGwgfHwgdmFsID09PSBudWxsKSBjb250aW51ZTsKICAgICAgICAKICAgICAgICBmaWx0ZXJlZFRpbWVQb2ludHMucHVzaCh0aW1lKTsKICAgICAgICBwcm9jZXNzZWRWYWx1ZXMucHVzaCh2YWwpOwogICAgICAgIG9yaWdpbmFsVmFsdWVzLnB1c2godmFsKTsgLy8gU3RvcmUgb3JpZ2luYWwgdmFsdWUgKHNhbWUgYXMgcHJvY2Vzc2VkIHdoZW4gbm90IG5vcm1hbGl6ZWQpCiAgICAgIH0KICAgIH0KICAgIAogICAgcmV0dXJuIHsgdGltZVBvaW50czogZmlsdGVyZWRUaW1lUG9pbnRzLCB2YWx1ZXM6IHByb2Nlc3NlZFZhbHVlcywgb3JpZ2luYWxWYWx1ZXM6IG9yaWdpbmFsVmFsdWVzIH07CiAgfSkuZmlsdGVyKHdlbGwgPT4gd2VsbC50aW1lUG9pbnRzLmxlbmd0aCA+IDApOyAvLyBGaWx0ZXIgb3V0IHdlbGxzIHdpdGggbm8gZGF0YQogIAogIC8vIFN0ZXAgMjogRmluZCBhbGwgdW5pcXVlIHRpbWUgcG9pbnRzIGFjcm9zcyBhbGwgcHJvY2Vzc2VkIHdlbGxzCiAgY29uc3QgYWxsVGltZVBvaW50cyA9IG5ldyBTZXQoKTsKICBwcm9jZXNzZWRXZWxscy5mb3JFYWNoKHdlbGwgPT4gewogICAgd2VsbC50aW1lUG9pbnRzLmZvckVhY2godCA9PiB7CiAgICAgIGlmICh0ICE9PSBudWxsKSBhbGxUaW1lUG9pbnRzLmFkZCh0KTsKICAgIH0pOwogIH0pOwogIAogIGNvbnN0IHNvcnRlZFRpbWVQb2ludHMgPSBBcnJheS5mcm9tKGFsbFRpbWVQb2ludHMpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKICAKICAvLyBTdGVwIDM6IENhbGN1bGF0ZSBtZWFuIGFuZCBlcnJvciBhdCBlYWNoIHRpbWUgcG9pbnQgZnJvbSBwcm9jZXNzZWQgdmFsdWVzCiAgLy8gQWxzbyB0cmFjayBvcmlnaW5hbCB2YWx1ZXMgZm9yIHRvb2x0aXAgZGlzcGxheQogIGNvbnN0IG1lYW5zID0gW107CiAgY29uc3QgZXJyb3JzID0gW107CiAgY29uc3Qgb3JpZ2luYWxNZWFucyA9IFtdOwogIAogIHNvcnRlZFRpbWVQb2ludHMuZm9yRWFjaCh0aW1lID0+IHsKICAgIGNvbnN0IHZhbHVlcyA9IFtdOwogICAgY29uc3Qgb3JpZ1ZhbHVlcyA9IFtdOwogICAgcHJvY2Vzc2VkV2VsbHMuZm9yRWFjaCh3ZWxsID0+IHsKICAgICAgY29uc3QgdGltZUlkeCA9IHdlbGwudGltZVBvaW50cy5pbmRleE9mKHRpbWUpOwogICAgICBpZiAodGltZUlkeCA+PSAwICYmIHdlbGwudmFsdWVzW3RpbWVJZHhdICE9PSBudWxsKSB7CiAgICAgICAgdmFsdWVzLnB1c2god2VsbC52YWx1ZXNbdGltZUlkeF0pOwogICAgICAgIGlmICh3ZWxsLm9yaWdpbmFsVmFsdWVzICYmIHdlbGwub3JpZ2luYWxWYWx1ZXNbdGltZUlkeF0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgb3JpZ1ZhbHVlcy5wdXNoKHdlbGwub3JpZ2luYWxWYWx1ZXNbdGltZUlkeF0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICAKICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIG1lYW5zLnB1c2gobnVsbCk7CiAgICAgIGVycm9ycy5wdXNoKG51bGwpOwogICAgICBvcmlnaW5hbE1lYW5zLnB1c2gobnVsbCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIAogICAgY29uc3QgbWVhbiA9IHZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIHZhbHVlcy5sZW5ndGg7CiAgICAvLyBVc2Ugc2FtcGxlIHZhcmlhbmNlIChkaXZpZGUgYnkgbi0xKSBmb3IgcHJvcGVyIFNFTSBjYWxjdWxhdGlvbgogICAgY29uc3QgbiA9IHZhbHVlcy5sZW5ndGg7CiAgICBjb25zdCB2YXJpYW5jZSA9IG4gPiAxIAogICAgICA/IHZhbHVlcy5yZWR1Y2UoKHN1bSwgdmFsKSA9PiBzdW0gKyBNYXRoLnBvdyh2YWwgLSBtZWFuLCAyKSwgMCkgLyAobiAtIDEpCiAgICAgIDogMDsKICAgIGNvbnN0IHN0ZERldiA9IE1hdGguc3FydCh2YXJpYW5jZSk7CiAgICBjb25zdCBzdGRFcnJvciA9IHN0ZERldiAvIE1hdGguc3FydChuKTsKICAgIAogICAgbWVhbnMucHVzaChtZWFuKTsKICAgIGVycm9ycy5wdXNoKHN0ZEVycm9yKTsKICAgIAogICAgLy8gQ2FsY3VsYXRlIG1lYW4gb2Ygb3JpZ2luYWwgdmFsdWVzCiAgICBpZiAob3JpZ1ZhbHVlcy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG9yaWdNZWFuID0gb3JpZ1ZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIG9yaWdWYWx1ZXMubGVuZ3RoOwogICAgICBvcmlnaW5hbE1lYW5zLnB1c2gob3JpZ01lYW4pOwogICAgfSBlbHNlIHsKICAgICAgb3JpZ2luYWxNZWFucy5wdXNoKG51bGwpOwogICAgfQogIH0pOwogIAogIHJldHVybiB7IGZpbHRlcmVkVGltZVBvaW50czogc29ydGVkVGltZVBvaW50cywgbm9ybWFsaXplZE1lYW5zOiBtZWFucywgbm9ybWFsaXplZEVycm9yczogZXJyb3JzLCBvcmlnaW5hbE1lYW5zOiBvcmlnaW5hbE1lYW5zIH07Cn0KCi8vIEtlZXAgb2xkIGZ1bmN0aW9uIG5hbWUgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCBidXQgaXQgbm93IHVzZXMgdGhlIHVuaWZpZWQgd29ya2Zsb3cKZnVuY3Rpb24gY2FsY3VsYXRlTWVhbkFuZEVycm9yRnJvbU5vcm1hbGl6ZWQod2VsbHMsIGJhc2VsaW5lRW5kVGltZSA9IDI0LCBjdXRvZmZUaW1lID0gMzYwKSB7CiAgcmV0dXJuIHByb2Nlc3NXZWxsc0FuZENhbGN1bGF0ZU1lYW4od2VsbHMsIHRydWUsIGJhc2VsaW5lRW5kVGltZSwgY3V0b2ZmVGltZSk7Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZURhdGEodGltZVBvaW50cywgdmFsdWVzLCBiYXNlbGluZUVuZFRpbWUgPSAyNCwgY3V0b2ZmVGltZSA9IDM2MCkgewogIC8vIE5vcm1hbGl6ZSBkYXRhOiBjYWxjdWxhdGUgYmFzZWxpbmUgZnJvbSAwLWJhc2VsaW5lRW5kVGltZSwgdGhlbiBwbG90IG9ubHkgcG9pbnRzIGFmdGVyIGJhc2VsaW5lRW5kVGltZQogIC8vIGRpdmlkZWQgYnkgYmFzZWxpbmUsIHVwIHRvIGN1dG9mZlRpbWUuIEJhc2VsaW5lIHBlcmlvZCBpcyBOT1QgaW5jbHVkZWQgaW4gdGhlIHBsb3QuCiAgLy8gUmV0dXJucyB7IGZpbHRlcmVkVGltZVBvaW50cywgbm9ybWFsaXplZFZhbHVlcywgb3JpZ2luYWxWYWx1ZXMgfSAtIGZpbHRlcmVkIGFycmF5cwogIGlmICghdGltZVBvaW50cyB8fCAhdmFsdWVzIHx8IHRpbWVQb2ludHMubGVuZ3RoICE9PSB2YWx1ZXMubGVuZ3RoKSB7CiAgICAvLyBJZiBpbnZhbGlkIGlucHV0LCByZXR1cm4gZW1wdHkgZmlsdGVyZWQgYXJyYXlzCiAgICByZXR1cm4geyBmaWx0ZXJlZFRpbWVQb2ludHM6IFtdLCBub3JtYWxpemVkVmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgfQogIAogIC8vIEZpbmQgYmFzZWxpbmU6IGF2ZXJhZ2Ugb2YgYWxsIHZhbHVlcyB3aGVyZSB0aW1lIDw9IGJhc2VsaW5lRW5kVGltZQogIGNvbnN0IGJhc2VsaW5lVmFsdWVzID0gW107CiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aW1lUG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAodGltZVBvaW50c1tpXSAhPT0gbnVsbCAmJiB2YWx1ZXNbaV0gIT09IG51bGwgJiYgdGltZVBvaW50c1tpXSA8PSBiYXNlbGluZUVuZFRpbWUpIHsKICAgICAgYmFzZWxpbmVWYWx1ZXMucHVzaCh2YWx1ZXNbaV0pOwogICAgfQogIH0KICAKICBpZiAoYmFzZWxpbmVWYWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAvLyBObyBiYXNlbGluZSBkYXRhIGZvdW5kLCByZXR1cm4gZW1wdHkgZmlsdGVyZWQgYXJyYXlzIChjYW4ndCBub3JtYWxpemUgd2l0aG91dCBiYXNlbGluZSkKICAgIHJldHVybiB7IGZpbHRlcmVkVGltZVBvaW50czogW10sIG5vcm1hbGl6ZWRWYWx1ZXM6IFtdLCBvcmlnaW5hbFZhbHVlczogW10gfTsKICB9CiAgCiAgY29uc3QgYmFzZWxpbmUgPSBiYXNlbGluZVZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIGJhc2VsaW5lVmFsdWVzLmxlbmd0aDsKICAKICBpZiAoYmFzZWxpbmUgPT09IDAgfHwgIWlzRmluaXRlKGJhc2VsaW5lKSkgewogICAgLy8gQXZvaWQgZGl2aXNpb24gYnkgemVybyBvciBpbnZhbGlkIGJhc2VsaW5lCiAgICByZXR1cm4geyBmaWx0ZXJlZFRpbWVQb2ludHM6IFtdLCBub3JtYWxpemVkVmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgfQogIAogIC8vIEZpbHRlciBhbmQgbm9ybWFsaXplOiBvbmx5IGluY2x1ZGUgcG9pbnRzIHdoZXJlIGJhc2VsaW5lRW5kVGltZSA8IHRpbWUgPD0gY3V0b2ZmVGltZQogIC8vIEVWRVJZIHBvaW50IGFmdGVyIGJhc2VsaW5lRW5kVGltZSBpcyBkaXZpZGVkIGJ5IHRoZSBTQU1FIGJhc2VsaW5lIGF2ZXJhZ2UKICBjb25zdCBmaWx0ZXJlZFRpbWVQb2ludHMgPSBbXTsKICBjb25zdCBub3JtYWxpemVkVmFsdWVzID0gW107CiAgY29uc3Qgb3JpZ2luYWxWYWx1ZXMgPSBbXTsKICAKICBmb3IgKGxldCBpID0gMDsgaSA8IHRpbWVQb2ludHMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHRpbWUgPSB0aW1lUG9pbnRzW2ldOwogICAgY29uc3QgdmFsID0gdmFsdWVzW2ldOwogICAgCiAgICBpZiAodGltZSA9PT0gbnVsbCB8fCB2YWwgPT09IG51bGwpIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICAKICAgIC8vIE9ubHkgaW5jbHVkZSBwb2ludHMgYWZ0ZXIgYmFzZWxpbmVFbmRUaW1lIGFuZCB1cCB0byBjdXRvZmZUaW1lIChiYXNlbGluZSBOT1QgaW5jbHVkZWQpCiAgICBpZiAodGltZSA+IGJhc2VsaW5lRW5kVGltZSAmJiB0aW1lIDw9IGN1dG9mZlRpbWUpIHsKICAgICAgLy8gU3VidHJhY3QgYmFzZWxpbmVFbmRUaW1lIHRvIGJyaW5nIGZpcnN0IHBvaW50IHRvIHg9MCAodGltZSBhZnRlciBpbmplY3Rpb24pCiAgICAgIGZpbHRlcmVkVGltZVBvaW50cy5wdXNoKHRpbWUgLSBiYXNlbGluZUVuZFRpbWUpOwogICAgICAvLyBEaXZpZGUgRVZFUlkgdGltZSBwb2ludCBieSB0aGUgU0FNRSBiYXNlbGluZSBhdmVyYWdlCiAgICAgIG5vcm1hbGl6ZWRWYWx1ZXMucHVzaCh2YWwgLyBiYXNlbGluZSk7CiAgICAgIG9yaWdpbmFsVmFsdWVzLnB1c2godmFsKTsgLy8gU3RvcmUgb3JpZ2luYWwgdmFsdWUgZm9yIHRvb2x0aXAKICAgIH0KICB9CiAgCiAgcmV0dXJuIHsgZmlsdGVyZWRUaW1lUG9pbnRzLCBub3JtYWxpemVkVmFsdWVzLCBvcmlnaW5hbFZhbHVlcyB9Owp9CgovLyBGaXQgYmFzZWxpbmUgZnVuY3Rpb24gdXNpbmcgc3BlY2lmaWVkIG1ldGhvZApmdW5jdGlvbiBmaXRCYXNlbGluZUZ1bmN0aW9uKHRpbWVQb2ludHMsIHZhbHVlcywgbWV0aG9kID0gJ2xvd2VzcycsIGZyYWMgPSAwLjUsIHBvbHlPcmRlciA9IDEpIHsKICAvLyBFeHRyYWN0IGJhc2VsaW5lIHdpbmRvdyAodGltZSA8PSBiYXNlbGluZUVuZFRpbWUgd2lsbCBiZSBoYW5kbGVkIGJ5IGNhbGxlcikKICAvLyBUaGlzIGZ1bmN0aW9uIGZpdHMgb24gdGhlIHByb3ZpZGVkIHBvaW50cyBhbmQgcmV0dXJucyBhIGZ1bmN0aW9uIGcodCkgdGhhdCBjYW4gYmUgZXZhbHVhdGVkIGF0IGFueSB0aW1lCiAgCiAgaWYgKCF0aW1lUG9pbnRzIHx8ICF2YWx1ZXMgfHwgdGltZVBvaW50cy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBudWxsOwogIH0KICAKICAvLyBGaWx0ZXIgb3V0IE5hTiB2YWx1ZXMKICBjb25zdCB2YWxpZERhdGEgPSBbXTsKICBmb3IgKGxldCBpID0gMDsgaSA8IHRpbWVQb2ludHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICh0aW1lUG9pbnRzW2ldICE9PSBudWxsICYmIHZhbHVlc1tpXSAhPT0gbnVsbCAmJiAhaXNOYU4odGltZVBvaW50c1tpXSkgJiYgIWlzTmFOKHZhbHVlc1tpXSkpIHsKICAgICAgdmFsaWREYXRhLnB1c2goeyB0OiB0aW1lUG9pbnRzW2ldLCB2OiB2YWx1ZXNbaV0gfSk7CiAgICB9CiAgfQogIAogIGlmICh2YWxpZERhdGEubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgdmFsaWREYXRhLnNvcnQoKGEsIGIpID0+IGEudCAtIGIudCk7CiAgY29uc3QgdGltZXMgPSB2YWxpZERhdGEubWFwKGQgPT4gZC50KTsKICBjb25zdCB2YWxzID0gdmFsaWREYXRhLm1hcChkID0+IGQudik7CiAgCiAgaWYgKG1ldGhvZCA9PT0gJ2NvbnN0YW50JykgewogICAgLy8gQ29uc3RhbnQgYmFzZWxpbmU6IGcodCkgPSBtZWFuKEZfYmFzZWxpbmUpCiAgICBjb25zdCBiYXNlbGluZVZhbHVlID0gdmFscy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIHZhbHMubGVuZ3RoOwogICAgcmV0dXJuICh0KSA9PiBiYXNlbGluZVZhbHVlOwogIH0gZWxzZSBpZiAobWV0aG9kID09PSAncG9seW5vbWlhbCcpIHsKICAgIC8vIFBvbHlub21pYWwgZml0OiBnKHQpID0gY+KCgCArIGPigoF0ICsgY+KCgnTCsiArIC4uLgogICAgLy8gU2ltcGxlIHBvbHlub21pYWwgcmVncmVzc2lvbgogICAgY29uc3QgbiA9IHRpbWVzLmxlbmd0aDsKICAgIGNvbnN0IFggPSBbXTsKICAgIGNvbnN0IHkgPSB2YWxzOwogICAgCiAgICAvLyBCdWlsZCBkZXNpZ24gbWF0cml4CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCByb3cgPSBbXTsKICAgICAgZm9yIChsZXQgcCA9IHBvbHlPcmRlcjsgcCA+PSAwOyBwLS0pIHsKICAgICAgICByb3cucHVzaChNYXRoLnBvdyh0aW1lc1tpXSwgcCkpOwogICAgICB9CiAgICAgIFgucHVzaChyb3cpOwogICAgfQogICAgCiAgICAvLyBTb2x2ZSB1c2luZyBub3JtYWwgZXF1YXRpb25zOiAoWCdYKV4oLTEpWCd5CiAgICAvLyBTaW1wbGlmaWVkIGZvciBzbWFsbCBvcmRlcnMKICAgIGxldCBjb2VmZnM7CiAgICBpZiAocG9seU9yZGVyID09PSAxKSB7CiAgICAgIC8vIExpbmVhcjogeSA9IGEgKyBiKnQKICAgICAgY29uc3Qgc3VtVCA9IHRpbWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgICBjb25zdCBzdW1UMiA9IHRpbWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIgKiBiLCAwKTsKICAgICAgY29uc3Qgc3VtWSA9IHkucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICAgIGNvbnN0IHN1bVRZID0gdGltZXMucmVkdWNlKChzdW0sIHQsIGkpID0+IHN1bSArIHQgKiB5W2ldLCAwKTsKICAgICAgY29uc3QgbiA9IHRpbWVzLmxlbmd0aDsKICAgICAgCiAgICAgIGNvbnN0IGRldCA9IG4gKiBzdW1UMiAtIHN1bVQgKiBzdW1UOwogICAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgICAgLy8gRmFsbGJhY2sgdG8gY29uc3RhbnQKICAgICAgICBjb25zdCBtZWFuID0gc3VtWSAvIG47CiAgICAgICAgcmV0dXJuICh0KSA9PiBtZWFuOwogICAgICB9CiAgICAgIAogICAgICBjb25zdCBhID0gKHN1bVkgKiBzdW1UMiAtIHN1bVQgKiBzdW1UWSkgLyBkZXQ7CiAgICAgIGNvbnN0IGIgPSAobiAqIHN1bVRZIC0gc3VtVCAqIHN1bVkpIC8gZGV0OwogICAgICBjb2VmZnMgPSBbYiwgYV07IC8vIFtjMSwgYzBdIGZvciBwb2x5MWQgZm9ybWF0CiAgICB9IGVsc2UgewogICAgICAvLyBIaWdoZXIgb3JkZXIgLSB1c2Ugc2ltcGxlIGxlYXN0IHNxdWFyZXMKICAgICAgLy8gRm9yIHNpbXBsaWNpdHksIHVzZSBhIGJhc2ljIGltcGxlbWVudGF0aW9uCiAgICAgIGNvbnN0IG1lYW5UID0gc3VtVCAvIG47CiAgICAgIGNvbnN0IG1lYW5ZID0gc3VtWSAvIG47CiAgICAgIC8vIEZhbGxiYWNrIHRvIGNvbnN0YW50IGZvciBub3cgaWYgb3JkZXIgPiAxCiAgICAgIGNvbnN0IG1lYW4gPSBtZWFuWTsKICAgICAgcmV0dXJuICh0KSA9PiBtZWFuOwogICAgfQogICAgCiAgICByZXR1cm4gKHQpID0+IHsKICAgICAgbGV0IHJlc3VsdCA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29lZmZzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVzdWx0ICs9IGNvZWZmc1tpXSAqIE1hdGgucG93KHQsIGNvZWZmcy5sZW5ndGggLSAxIC0gaSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfSBlbHNlIGlmIChtZXRob2QgPT09ICdsb3dlc3MnKSB7CiAgICAvLyBMT1dFU1Mgc21vb3RoaW5nIC0gc2ltcGxpZmllZCBpbXBsZW1lbnRhdGlvbgogICAgLy8gRm9yIGEgcHJvcGVyIExPV0VTUywgd2UnZCBuZWVkIGEgbGlicmFyeSwgYnV0IHdlIGNhbiBhcHByb3hpbWF0ZSB3aXRoIG1vdmluZyBhdmVyYWdlCiAgICAvLyBUaGlzIGlzIGEgc2ltcGxpZmllZCB2ZXJzaW9uIC0gZm9yIHByb2R1Y3Rpb24sIGNvbnNpZGVyIHVzaW5nIGEgbGlicmFyeSBsaWtlIHJlZ3Jlc3Npb24uanMKICAgIAogICAgLy8gVXNlIGEgc2ltcGxlIG1vdmluZyBhdmVyYWdlIHdpdGggd2VpZ2h0ZWQgd2luZG93IGFzIGFwcHJveGltYXRpb24KICAgIGNvbnN0IHdpbmRvd1NpemUgPSBNYXRoLm1heCgxLCBNYXRoLmZsb29yKGZyYWMgKiB0aW1lcy5sZW5ndGgpKTsKICAgIGNvbnN0IHNtb290aGVkID0gW107CiAgICAKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZXMubGVuZ3RoOyBpKyspIHsKICAgICAgbGV0IHN1bSA9IDA7CiAgICAgIGxldCB3ZWlnaHRTdW0gPSAwOwogICAgICBjb25zdCBjZW50ZXIgPSB0aW1lc1tpXTsKICAgICAgCiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGltZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5hYnModGltZXNbal0gLSBjZW50ZXIpOwogICAgICAgIGNvbnN0IG1heERpc3QgPSBNYXRoLm1heCguLi50aW1lcy5tYXAodCA9PiBNYXRoLmFicyh0IC0gY2VudGVyKSkpOwogICAgICAgIGNvbnN0IHdlaWdodCA9IGRpc3QgPCBtYXhEaXN0ICogZnJhYyA/IE1hdGgucG93KDEgLSAoZGlzdCAvIChtYXhEaXN0ICogZnJhYykpLCAzKSA6IDA7IC8vIFRyaWN1YmUgd2VpZ2h0CiAgICAgICAgCiAgICAgICAgc3VtICs9IHZhbHNbal0gKiB3ZWlnaHQ7CiAgICAgICAgd2VpZ2h0U3VtICs9IHdlaWdodDsKICAgICAgfQogICAgICAKICAgICAgc21vb3RoZWQucHVzaCh3ZWlnaHRTdW0gPiAwID8gc3VtIC8gd2VpZ2h0U3VtIDogdmFsc1tpXSk7CiAgICB9CiAgICAKICAgIC8vIFJldHVybiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uCiAgICByZXR1cm4gKHQpID0+IHsKICAgICAgaWYgKHQgPD0gdGltZXNbMF0pIHJldHVybiBzbW9vdGhlZFswXTsKICAgICAgaWYgKHQgPj0gdGltZXNbdGltZXMubGVuZ3RoIC0gMV0pIHJldHVybiBzbW9vdGhlZFtzbW9vdGhlZC5sZW5ndGggLSAxXTsKICAgICAgCiAgICAgIC8vIExpbmVhciBpbnRlcnBvbGF0aW9uCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZXMubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgaWYgKHQgPj0gdGltZXNbaV0gJiYgdCA8PSB0aW1lc1tpICsgMV0pIHsKICAgICAgICAgIGNvbnN0IHJhdGlvID0gKHQgLSB0aW1lc1tpXSkgLyAodGltZXNbaSArIDFdIC0gdGltZXNbaV0pOwogICAgICAgICAgcmV0dXJuIHNtb290aGVkW2ldICogKDEgLSByYXRpbykgKyBzbW9vdGhlZFtpICsgMV0gKiByYXRpbzsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHNtb290aGVkW3Ntb290aGVkLmxlbmd0aCAtIDFdOwogICAgfTsKICB9CiAgCiAgcmV0dXJuIG51bGw7Cn0KCi8vIE5vcm1hbGl6ZSB3ZWxsIGRhdGEgdXNpbmcgZml0dGVkIGJhc2VsaW5lIChTdGVwIDQpCmZ1bmN0aW9uIG5vcm1hbGl6ZVdpdGhGaXR0ZWRCYXNlbGluZSh3ZWxsRGF0YSwgYmFzZWxpbmVFbmRUaW1lLCBtZXRob2QsIGZyYWMsIHBvbHlPcmRlciwgbm9ybWFsaXphdGlvbk1vZGUpIHsKICBpZiAoIXdlbGxEYXRhIHx8ICF3ZWxsRGF0YS50aW1lX3MgfHwgIXdlbGxEYXRhLnZhbHVlcykgewogICAgcmV0dXJuIHdlbGxEYXRhOwogIH0KICAKICAvLyBFeHRyYWN0IGJhc2VsaW5lIHdpbmRvdwogIGNvbnN0IGJhc2VsaW5lVGltZXMgPSBbXTsKICBjb25zdCBiYXNlbGluZVZhbHVlcyA9IFtdOwogIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbERhdGEudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCB0aW1lID0gd2VsbERhdGEudGltZV9zW2ldOwogICAgY29uc3QgdmFsID0gd2VsbERhdGEudmFsdWVzW2ldOwogICAgaWYgKHRpbWUgIT09IG51bGwgJiYgdmFsICE9PSBudWxsICYmIHRpbWUgPD0gYmFzZWxpbmVFbmRUaW1lKSB7CiAgICAgIGJhc2VsaW5lVGltZXMucHVzaCh0aW1lKTsKICAgICAgYmFzZWxpbmVWYWx1ZXMucHVzaCh2YWwpOwogICAgfQogIH0KICAKICBpZiAoYmFzZWxpbmVUaW1lcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB3ZWxsRGF0YTsgLy8gTm8gYmFzZWxpbmUgZGF0YQogIH0KICAKICAvLyBGaXQgYmFzZWxpbmUgZnVuY3Rpb24KICBjb25zdCBiYXNlbGluZUZ1bmMgPSBmaXRCYXNlbGluZUZ1bmN0aW9uKGJhc2VsaW5lVGltZXMsIGJhc2VsaW5lVmFsdWVzLCBtZXRob2QsIGZyYWMsIHBvbHlPcmRlcik7CiAgaWYgKCFiYXNlbGluZUZ1bmMpIHsKICAgIHJldHVybiB3ZWxsRGF0YTsKICB9CiAgCiAgLy8gTm9ybWFsaXplIGFsbCB0aW1lcG9pbnRzIHVzaW5nIGZpdHRlZCBiYXNlbGluZQogIGNvbnN0IG5vcm1hbGl6ZWRUaW1lcyA9IFtdOwogIGNvbnN0IG5vcm1hbGl6ZWRWYWx1ZXMgPSBbXTsKICBjb25zdCBvcmlnaW5hbFZhbHVlcyA9IFtdOwogIAogIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbERhdGEudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCB0aW1lID0gd2VsbERhdGEudGltZV9zW2ldOwogICAgY29uc3QgdmFsdWUgPSB3ZWxsRGF0YS52YWx1ZXNbaV07CiAgICAKICAgIGlmICh0aW1lID09PSBudWxsIHx8IHZhbHVlID09PSBudWxsKSBjb250aW51ZTsKICAgIAogICAgY29uc3QgYmFzZWxpbmVWYWx1ZSA9IGJhc2VsaW5lRnVuYyh0aW1lKTsKICAgIGlmIChiYXNlbGluZVZhbHVlID09PSAwIHx8ICFpc0Zpbml0ZShiYXNlbGluZVZhbHVlKSkgY29udGludWU7CiAgICAKICAgIGxldCBub3JtVmFsdWU7CiAgICBpZiAobm9ybWFsaXphdGlvbk1vZGUgPT09ICdkZWx0YV9mX292ZXJfZicpIHsKICAgICAgLy8gzpRGL0YgPSAoRih0KSAtIGcodCkpIC8gZyh0KQogICAgICBub3JtVmFsdWUgPSAodmFsdWUgLSBiYXNlbGluZVZhbHVlKSAvIGJhc2VsaW5lVmFsdWU7CiAgICB9IGVsc2UgewogICAgICAvLyBNdWx0aXBsaWNhdGl2ZTogRl9ub3JtKHQpID0gRih0KSAvIGcodCkKICAgICAgbm9ybVZhbHVlID0gdmFsdWUgLyBiYXNlbGluZVZhbHVlOwogICAgfQogICAgCiAgICBub3JtYWxpemVkVGltZXMucHVzaCh0aW1lKTsKICAgIG5vcm1hbGl6ZWRWYWx1ZXMucHVzaChub3JtVmFsdWUpOwogICAgb3JpZ2luYWxWYWx1ZXMucHVzaCh2YWx1ZSk7CiAgfQogIAogIGlmIChub3JtYWxpemVkVGltZXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgcmV0dXJuIHsKICAgIHRpbWVfczogbm9ybWFsaXplZFRpbWVzLAogICAgdmFsdWVzOiBub3JtYWxpemVkVmFsdWVzLAogICAgb3JpZ2luYWxWYWx1ZXM6IG9yaWdpbmFsVmFsdWVzLAogICAgbGFiZWw6IHdlbGxEYXRhLmxhYmVsLAogICAgY29udGVudDogd2VsbERhdGEuY29udGVudAogIH07Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZVdlbGxEYXRhKHdlbGxEYXRhLCBpc05vcm1hbGl6ZWQsIGJhc2VsaW5lRW5kVGltZSA9IDI0LCBjdXRvZmZUaW1lID0gMzYwKSB7CiAgLy8gU1RFUCAzOiBOb3JtYWxpemUgYSBzaW5nbGUgd2VsbCdzIGRhdGEgb2JqZWN0IChpZiBub3JtYWxpemF0aW9uIGlzIGVuYWJsZWQpCiAgLy8gVGhpcyBoYXBwZW5zIEFGVEVSIGJhc2VsaW5lIGFsaWdubWVudCBhbmQgZ3JvdXBpbmcgaW50byB0cmlwbGljYXRlcwogIC8vIFJldHVybnMgYSBuZXcgd2VsbCBkYXRhIG9iamVjdCB3aXRoIG5vcm1hbGl6ZWQgdGltZV9zIGFuZCB2YWx1ZXMgKG9yIG9yaWdpbmFsIGlmIG5vdCBub3JtYWxpemVkKQogIGlmICghd2VsbERhdGEgfHwgIXdlbGxEYXRhLnRpbWVfcyB8fCAhd2VsbERhdGEudmFsdWVzKSB7CiAgICByZXR1cm4gd2VsbERhdGE7IC8vIFJldHVybiBhcy1pcyBpZiBpbnZhbGlkCiAgfQogIAogIGlmICghaXNOb3JtYWxpemVkKSB7CiAgICAvLyBOb3Qgbm9ybWFsaXppbmcgLSByZXR1cm4gb3JpZ2luYWwgZGF0YQogICAgcmV0dXJuIHsKICAgICAgdGltZV9zOiB3ZWxsRGF0YS50aW1lX3MsCiAgICAgIHZhbHVlczogd2VsbERhdGEudmFsdWVzLAogICAgICBsYWJlbDogd2VsbERhdGEubGFiZWwsCiAgICAgIGNvbnRlbnQ6IHdlbGxEYXRhLmNvbnRlbnQsCiAgICAgIG9yaWdpbmFsVmFsdWVzOiB3ZWxsRGF0YS5vcmlnaW5hbFZhbHVlcyB8fCB3ZWxsRGF0YS52YWx1ZXMKICAgIH07CiAgfQogIAogIC8vIE5vcm1hbGl6ZSB0aGlzIHdlbGwKICBjb25zdCBub3JtYWxpemVkID0gbm9ybWFsaXplRGF0YSh3ZWxsRGF0YS50aW1lX3MsIHdlbGxEYXRhLnZhbHVlcywgYmFzZWxpbmVFbmRUaW1lLCBjdXRvZmZUaW1lKTsKICAKICBpZiAobm9ybWFsaXplZC5maWx0ZXJlZFRpbWVQb2ludHMubGVuZ3RoID09PSAwKSB7CiAgICAvLyBObyBkYXRhIGFmdGVyIG5vcm1hbGl6YXRpb24gLSByZXR1cm4gbnVsbCB0byBpbmRpY2F0ZSB0aGlzIHdlbGwgc2hvdWxkIGJlIHNraXBwZWQKICAgIHJldHVybiBudWxsOwogIH0KICAKICAvLyBSZXR1cm4gbm9ybWFsaXplZCB3ZWxsIGRhdGEKICByZXR1cm4gewogICAgdGltZV9zOiBub3JtYWxpemVkLmZpbHRlcmVkVGltZVBvaW50cywKICAgIHZhbHVlczogbm9ybWFsaXplZC5ub3JtYWxpemVkVmFsdWVzLAogICAgb3JpZ2luYWxWYWx1ZXM6IG5vcm1hbGl6ZWQub3JpZ2luYWxWYWx1ZXMsIC8vIFN0b3JlIGZvciB0b29sdGlwIGRpc3BsYXkKICAgIGxhYmVsOiB3ZWxsRGF0YS5sYWJlbCwKICAgIGNvbnRlbnQ6IHdlbGxEYXRhLmNvbnRlbnQKICB9Owp9CgoKLy8gRml0IHJlZ3Jlc3Npb24gY3VydmUgdG8gZGF0YSBwb2ludHMgKFN0ZXAgNCkKZnVuY3Rpb24gZml0UmVncmVzc2lvbkN1cnZlKGRhdGFQb2ludHMsIHJlZ3Jlc3Npb25UeXBlID0gJ21vbm8tZXhwb25lbnRpYWwnLCBwb2x5bm9taWFsT3JkZXIgPSAyKSB7CiAgLy8gZGF0YVBvaW50cyBpcyBhbiBhcnJheSBvZiB7eCwgeX0gb2JqZWN0cwogIGlmICghZGF0YVBvaW50cyB8fCBkYXRhUG9pbnRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIAogIC8vIEZpbHRlciB2YWxpZCBwb2ludHMKICBjb25zdCB2YWxpZFBvaW50cyA9IGRhdGFQb2ludHMuZmlsdGVyKHAgPT4gcC54ICE9PSBudWxsICYmIHAueSAhPT0gbnVsbCAmJiBpc0Zpbml0ZShwLngpICYmIGlzRmluaXRlKHAueSkpOwogIGlmICh2YWxpZFBvaW50cy5sZW5ndGggPCAyKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgLy8gU29ydCBieSB4CiAgdmFsaWRQb2ludHMuc29ydCgoYSwgYikgPT4gYS54IC0gYi54KTsKICBjb25zdCB4ID0gdmFsaWRQb2ludHMubWFwKHAgPT4gcC54KTsKICBjb25zdCB5ID0gdmFsaWRQb2ludHMubWFwKHAgPT4gcC55KTsKICAKICBsZXQgZml0RnVuY3Rpb247CiAgCiAgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAnbGluZWFyJykgewogICAgLy8gTGluZWFyOiB5ID0gYSArIGIqeAogICAgY29uc3QgbiA9IHgubGVuZ3RoOwogICAgY29uc3Qgc3VtWCA9IHgucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICBjb25zdCBzdW1ZID0geS5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTsKICAgIGNvbnN0IHN1bVhZID0geC5yZWR1Y2UoKHN1bSwgeGksIGkpID0+IHN1bSArIHhpICogeVtpXSwgMCk7CiAgICBjb25zdCBzdW1YMiA9IHgucmVkdWNlKChzdW0sIHhpKSA9PiBzdW0gKyB4aSAqIHhpLCAwKTsKICAgIAogICAgY29uc3QgZGV0ID0gbiAqIHN1bVgyIC0gc3VtWCAqIHN1bVg7CiAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgIC8vIEZhbGxiYWNrIHRvIGNvbnN0YW50CiAgICAgIGNvbnN0IG1lYW4gPSBzdW1ZIC8gbjsKICAgICAgZml0RnVuY3Rpb24gPSAodCkgPT4gbWVhbjsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGEgPSAoc3VtWSAqIHN1bVgyIC0gc3VtWCAqIHN1bVhZKSAvIGRldDsKICAgICAgY29uc3QgYiA9IChuICogc3VtWFkgLSBzdW1YICogc3VtWSkgLyBkZXQ7CiAgICAgIGZpdEZ1bmN0aW9uID0gKHQpID0+IGEgKyBiICogdDsKICAgIH0KICB9IGVsc2UgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAncG9seW5vbWlhbCcpIHsKICAgIC8vIFBvbHlub21pYWw6IHkgPSBjMCArIGMxKnggKyBjMip4XjIgKyAuLi4gKyBjbip4Xm4KICAgIGNvbnN0IG4gPSB4Lmxlbmd0aDsKICAgIGNvbnN0IG9yZGVyID0gTWF0aC5taW4ocG9seW5vbWlhbE9yZGVyLCBuIC0gMSk7IC8vIENhbid0IGZpdCBvcmRlciA+PSBuIHBvaW50cwogICAgCiAgICAvLyBCdWlsZCBkZXNpZ24gbWF0cml4CiAgICBjb25zdCBYID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCByb3cgPSBbXTsKICAgICAgZm9yIChsZXQgcCA9IG9yZGVyOyBwID49IDA7IHAtLSkgewogICAgICAgIHJvdy5wdXNoKE1hdGgucG93KHhbaV0sIHApKTsKICAgICAgfQogICAgICBYLnB1c2gocm93KTsKICAgIH0KICAgIAogICAgLy8gU29sdmUgdXNpbmcgbm9ybWFsIGVxdWF0aW9uczogKFgnWCleKC0xKVgneQogICAgLy8gU2ltcGxpZmllZCBmb3Igc21hbGwgb3JkZXJzCiAgICBsZXQgY29lZmZzOwogICAgaWYgKG9yZGVyID09PSAxKSB7CiAgICAgIC8vIExpbmVhciBjYXNlCiAgICAgIGNvbnN0IHN1bVggPSB4LnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgICBjb25zdCBzdW1YMiA9IHgucmVkdWNlKChzdW0sIHhpKSA9PiBzdW0gKyB4aSAqIHhpLCAwKTsKICAgICAgY29uc3Qgc3VtWSA9IHkucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICAgIGNvbnN0IHN1bVhZID0geC5yZWR1Y2UoKHN1bSwgeGksIGkpID0+IHN1bSArIHhpICogeVtpXSwgMCk7CiAgICAgIGNvbnN0IGRldCA9IG4gKiBzdW1YMiAtIHN1bVggKiBzdW1YOwogICAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgICAgY29lZmZzID0gW3N1bVkgLyBuLCAwXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBhID0gKHN1bVkgKiBzdW1YMiAtIHN1bVggKiBzdW1YWSkgLyBkZXQ7CiAgICAgICAgY29uc3QgYiA9IChuICogc3VtWFkgLSBzdW1YICogc3VtWSkgLyBkZXQ7CiAgICAgICAgY29lZmZzID0gW2EsIGJdOyAvLyBbYzAsIGMxXQogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBIaWdoZXIgb3JkZXIgLSB1c2Ugc2ltcGxlIGxlYXN0IHNxdWFyZXMgYXBwcm94aW1hdGlvbgogICAgICAvLyBGb3Igc2ltcGxpY2l0eSwgdXNlIGEgYmFzaWMgaW1wbGVtZW50YXRpb24KICAgICAgY29uc3QgbWVhblkgPSB5LnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gbjsKICAgICAgY29lZmZzID0gW21lYW5ZXTsKICAgICAgZm9yIChsZXQgcCA9IDE7IHAgPD0gb3JkZXI7IHArKykgewogICAgICAgIGNvZWZmcy5wdXNoKDApOwogICAgICB9CiAgICB9CiAgICAKICAgIGZpdEZ1bmN0aW9uID0gKHQpID0+IHsKICAgICAgbGV0IHJlc3VsdCA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29lZmZzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVzdWx0ICs9IGNvZWZmc1tpXSAqIE1hdGgucG93KHQsIGNvZWZmcy5sZW5ndGggLSAxIC0gaSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfSBlbHNlIGlmIChyZWdyZXNzaW9uVHlwZSA9PT0gJ2V4cG9uZW50aWFsJykgewogICAgLy8gRXhwb25lbnRpYWw6IHkgPSBhICogZV4oYip4KSBvciB5ID0gYSAqIGJeeAogICAgLy8gVHJhbnNmb3JtIHRvIGxpbmVhcjogbG4oeSkgPSBsbihhKSArIGIqeAogICAgY29uc3QgbG9nWSA9IHkubWFwKHlpID0+IHlpID4gMCA/IE1hdGgubG9nKHlpKSA6IG51bGwpLmZpbHRlcihseSA9PiBseSAhPT0gbnVsbCk7CiAgICBpZiAobG9nWS5sZW5ndGggPCAyKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgCiAgICBjb25zdCBuID0geC5sZW5ndGg7CiAgICBjb25zdCBzdW1YID0geC5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTsKICAgIGNvbnN0IHN1bUxvZ1kgPSBsb2dZLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgY29uc3Qgc3VtWExvZ1kgPSB4LnNsaWNlKDAsIGxvZ1kubGVuZ3RoKS5yZWR1Y2UoKHN1bSwgeGksIGkpID0+IHN1bSArIHhpICogbG9nWVtpXSwgMCk7CiAgICBjb25zdCBzdW1YMiA9IHguc2xpY2UoMCwgbG9nWS5sZW5ndGgpLnJlZHVjZSgoc3VtLCB4aSkgPT4gc3VtICsgeGkgKiB4aSwgMCk7CiAgICAKICAgIGNvbnN0IGRldCA9IGxvZ1kubGVuZ3RoICogc3VtWDIgLSBzdW1YICogc3VtWDsKICAgIGlmIChNYXRoLmFicyhkZXQpIDwgMWUtMTApIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICAKICAgIGNvbnN0IGxuQSA9IChzdW1Mb2dZICogc3VtWDIgLSBzdW1YICogc3VtWExvZ1kpIC8gZGV0OwogICAgY29uc3QgYiA9IChsb2dZLmxlbmd0aCAqIHN1bVhMb2dZIC0gc3VtWCAqIHN1bUxvZ1kpIC8gZGV0OwogICAgY29uc3QgYSA9IE1hdGguZXhwKGxuQSk7CiAgICAKICAgIGZpdEZ1bmN0aW9uID0gKHQpID0+IGEgKiBNYXRoLmV4cChiICogdCk7CiAgfSBlbHNlIGlmIChyZWdyZXNzaW9uVHlwZSA9PT0gJ2xvZ2FyaXRobWljJykgewogICAgLy8gTG9nYXJpdGhtaWM6IHkgPSBhICsgYipsbih4KQogICAgLy8gRmlsdGVyIG91dCBub24tcG9zaXRpdmUgeCB2YWx1ZXMKICAgIGNvbnN0IHZhbGlkSW5kaWNlcyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB4Lmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh4W2ldID4gMCkgewogICAgICAgIHZhbGlkSW5kaWNlcy5wdXNoKGkpOwogICAgICB9CiAgICB9CiAgICAKICAgIGlmICh2YWxpZEluZGljZXMubGVuZ3RoIDwgMikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIAogICAgY29uc3QgbG9nWCA9IHZhbGlkSW5kaWNlcy5tYXAoaSA9PiBNYXRoLmxvZyh4W2ldKSk7CiAgICBjb25zdCB2YWxpZFkgPSB2YWxpZEluZGljZXMubWFwKGkgPT4geVtpXSk7CiAgICBjb25zdCBuID0gdmFsaWRJbmRpY2VzLmxlbmd0aDsKICAgIAogICAgY29uc3Qgc3VtTG9nWCA9IGxvZ1gucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICBjb25zdCBzdW1ZID0gdmFsaWRZLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgY29uc3Qgc3VtTG9nWFkgPSBsb2dYLnJlZHVjZSgoc3VtLCBseGksIGkpID0+IHN1bSArIGx4aSAqIHZhbGlkWVtpXSwgMCk7CiAgICBjb25zdCBzdW1Mb2dYMiA9IGxvZ1gucmVkdWNlKChzdW0sIGx4aSkgPT4gc3VtICsgbHhpICogbHhpLCAwKTsKICAgIAogICAgY29uc3QgZGV0ID0gbiAqIHN1bUxvZ1gyIC0gc3VtTG9nWCAqIHN1bUxvZ1g7CiAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgCiAgICBjb25zdCBhID0gKHN1bVkgKiBzdW1Mb2dYMiAtIHN1bUxvZ1ggKiBzdW1Mb2dYWSkgLyBkZXQ7CiAgICBjb25zdCBiID0gKG4gKiBzdW1Mb2dYWSAtIHN1bUxvZ1ggKiBzdW1ZKSAvIGRldDsKICAgIAogICAgZml0RnVuY3Rpb24gPSAodCkgPT4gdCA+IDAgPyBhICsgYiAqIE1hdGgubG9nKHQpIDogbnVsbDsKICB9IGVsc2UgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAnbW9uby1leHBvbmVudGlhbCcpIHsKICAgIC8vIE1vbm8tZXhwb25lbnRpYWwgcmlzZSB0byBwbGF0ZWF1OiB5KHQpID0gMSArIEEoMSAtIGVeKC1rKHQgLSB04oKAKSkpCiAgICAvLyBGb3Igbm9ybWFsaXplZCBkYXRhLCBiYXNlbGluZSDiiYggMSwgc28gd2UgZml4IHTigoAgPSAwIChvciBmaXJzdCB0aW1lcG9pbnQpCiAgICAvLyB5KHQpID0gMSArIEEoMSAtIGVeKC1rKnQpKQogICAgCiAgICAvLyBGaW5kIHTigoAgYXMgdGhlIGZpcnN0IHRpbWVwb2ludCAob3IgMCBpZiBkYXRhIHN0YXJ0cyBhdCAwKQogICAgY29uc3QgdDAgPSBNYXRoLm1pbiguLi54KTsKICAgIGNvbnN0IHhTaGlmdGVkID0geC5tYXAoeGkgPT4geGkgLSB0MCk7CiAgICAKICAgIC8vIEluaXRpYWwgcGFyYW1ldGVyIGVzdGltYXRlcwogICAgLy8gQTogYW1wbGl0dWRlID0gbWF4KHkpIC0gMSAoc2luY2UgYmFzZWxpbmUgaXMgbm9ybWFsaXplZCB0byAxKQogICAgY29uc3QgeU1heCA9IE1hdGgubWF4KC4uLnkpOwogICAgY29uc3QgeU1pbiA9IE1hdGgubWluKC4uLnkpOwogICAgbGV0IEEgPSBNYXRoLm1heCgwLCB5TWF4IC0gMSk7IC8vIEFtcGxpdHVkZSBzaG91bGQgYmUgcG9zaXRpdmUKICAgIAogICAgLy8gazogcmF0ZSBjb25zdGFudCAtIGVzdGltYXRlIGZyb20gcmlzZSB0aW1lCiAgICAvLyBGaW5kIHRpbWVwb2ludCB3aGVyZSBzaWduYWwgcmVhY2hlcyB+NjMlJSBvZiBhbXBsaXR1ZGUgKDEgLSAxL2Ug4omIIDAuNjMyKQogICAgY29uc3QgdGltZVNwYW4gPSBNYXRoLm1heCguLi54U2hpZnRlZCkgLSBNYXRoLm1pbiguLi54U2hpZnRlZCk7CiAgICBjb25zdCB0YXJnZXRZID0gMSArIEEgKiAwLjYzMjsKICAgIGxldCBrID0gMC4wMTsgLy8gRGVmYXVsdCBpbml0aWFsIGd1ZXNzCiAgICBpZiAoQSA+IDAuMDEgJiYgdGltZVNwYW4gPiAwKSB7CiAgICAgIC8vIEZpbmQgY2xvc2VzdCBwb2ludCB0byB0YXJnZXQKICAgICAgbGV0IGNsb3Nlc3RJZHggPSAwOwogICAgICBsZXQgbWluRGlmZiA9IE1hdGguYWJzKHlbMF0gLSB0YXJnZXRZKTsKICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCB5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgZGlmZiA9IE1hdGguYWJzKHlbaV0gLSB0YXJnZXRZKTsKICAgICAgICBpZiAoZGlmZiA8IG1pbkRpZmYpIHsKICAgICAgICAgIG1pbkRpZmYgPSBkaWZmOwogICAgICAgICAgY2xvc2VzdElkeCA9IGk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEVzdGltYXRlIGsgZnJvbTogMSAtIGVeKC1rKnQpID0gMC42MzIgPT4gayDiiYggMS90CiAgICAgIGlmICh4U2hpZnRlZFtjbG9zZXN0SWR4XSA+IDApIHsKICAgICAgICBrID0gMSAvIHhTaGlmdGVkW2Nsb3Nlc3RJZHhdOwogICAgICAgIGsgPSBNYXRoLm1heCgxZS02LCBNYXRoLm1pbigxMCwgaykpOyAvLyBCb3VuZCBiZXR3ZWVuIDFlLTYgYW5kIDEwCiAgICAgIH0KICAgIH0KICAgIAogICAgLy8gVXNlIHNpbXBsZSBpdGVyYXRpdmUgbm9ubGluZWFyIGxlYXN0IHNxdWFyZXMgKEdhdXNzLU5ld3RvbikKICAgIC8vIE1pbmltaXplIHN1bSBvZiBzcXVhcmVkIHJlc2lkdWFsczogzqMoeSAtICgxICsgQSgxIC0gZV4oLWsqdCkpKSnCsgogICAgY29uc3QgbWF4SXRlcmF0aW9ucyA9IDEwMDsKICAgIGNvbnN0IHRvbGVyYW5jZSA9IDFlLTY7CiAgICAKICAgIGZvciAobGV0IGl0ZXIgPSAwOyBpdGVyIDwgbWF4SXRlcmF0aW9uczsgaXRlcisrKSB7CiAgICAgIC8vIENhbGN1bGF0ZSByZXNpZHVhbHMgYW5kIEphY29iaWFuCiAgICAgIGxldCBzdW1SZXNpZHVhbCA9IDA7CiAgICAgIGxldCBzdW1SZXNpZHVhbEEgPSAwOwogICAgICBsZXQgc3VtUmVzaWR1YWxLID0gMDsKICAgICAgbGV0IHN1bUpBQSA9IDA7CiAgICAgIGxldCBzdW1KQUsgPSAwOwogICAgICBsZXQgc3VtSktLID0gMDsKICAgICAgCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgeFNoaWZ0ZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB0ID0geFNoaWZ0ZWRbaV07CiAgICAgICAgY29uc3QgeU9icyA9IHlbaV07CiAgICAgICAgY29uc3QgeVByZWQgPSAxICsgQSAqICgxIC0gTWF0aC5leHAoLWsgKiB0KSk7CiAgICAgICAgY29uc3QgcmVzaWR1YWwgPSB5T2JzIC0geVByZWQ7CiAgICAgICAgCiAgICAgICAgLy8gUGFydGlhbCBkZXJpdmF0aXZlcwogICAgICAgIGNvbnN0IGRBID0gMSAtIE1hdGguZXhwKC1rICogdCk7CiAgICAgICAgY29uc3QgZEsgPSBBICogdCAqIE1hdGguZXhwKC1rICogdCk7CiAgICAgICAgCiAgICAgICAgc3VtUmVzaWR1YWwgKz0gcmVzaWR1YWw7CiAgICAgICAgc3VtUmVzaWR1YWxBICs9IHJlc2lkdWFsICogZEE7CiAgICAgICAgc3VtUmVzaWR1YWxLICs9IHJlc2lkdWFsICogZEs7CiAgICAgICAgc3VtSkFBICs9IGRBICogZEE7CiAgICAgICAgc3VtSkFLICs9IGRBICogZEs7CiAgICAgICAgc3VtSktLICs9IGRLICogZEs7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIFNvbHZlIG5vcm1hbCBlcXVhdGlvbnM6IEpeVCAqIEogKiBkZWx0YSA9IEpeVCAqIHJlc2lkdWFsCiAgICAgIGNvbnN0IGRldCA9IHN1bUpBQSAqIHN1bUpLSyAtIHN1bUpBSyAqIHN1bUpBSzsKICAgICAgaWYgKE1hdGguYWJzKGRldCkgPCAxZS0xMCkgYnJlYWs7CiAgICAgIAogICAgICBjb25zdCBkZWx0YUEgPSAoc3VtUmVzaWR1YWxBICogc3VtSktLIC0gc3VtUmVzaWR1YWxLICogc3VtSkFLKSAvIGRldDsKICAgICAgY29uc3QgZGVsdGFLID0gKHN1bVJlc2lkdWFsSyAqIHN1bUpBQSAtIHN1bVJlc2lkdWFsQSAqIHN1bUpBSykgLyBkZXQ7CiAgICAgIAogICAgICAvLyBVcGRhdGUgcGFyYW1ldGVycyB3aXRoIGRhbXBpbmcKICAgICAgY29uc3QgZGFtcGluZyA9IDAuNTsKICAgICAgQSA9IE1hdGgubWF4KDAsIEEgKyBkYW1waW5nICogZGVsdGFBKTsKICAgICAgayA9IE1hdGgubWF4KDFlLTYsIE1hdGgubWluKDEwLCBrICsgZGFtcGluZyAqIGRlbHRhSykpOwogICAgICAKICAgICAgLy8gSWYgcGFyYW1ldGVycyBkaWRuJ3QgY2hhbmdlIG11Y2gsIHdlJ3JlIGRvbmUKICAgICAgaWYgKE1hdGguYWJzKGRlbHRhQSkgPCB0b2xlcmFuY2UgJiYgTWF0aC5hYnMoZGVsdGFLKSA8IHRvbGVyYW5jZSkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICAKICAgIC8vIFN0b3JlIHBhcmFtZXRlcnMgZm9yIGluZm8gcGFuZWwKICAgIGNvbnN0IHRhdSA9IDEgLyBrOyAvLyB0aW1lIGNvbnN0YW50CiAgICBjb25zdCB0SGFsZiA9IE1hdGgubG9nKDIpIC8gazsgLy8gaGFsZi10aW1lCiAgICBjb25zdCBwbGF0ZWF1ID0gMSArIEE7IC8vIHBsYXRlYXUgdmFsdWUKICAgIAogICAgLy8gQ3JlYXRlIGZpdCBmdW5jdGlvbgogICAgZml0RnVuY3Rpb24gPSAodCkgPT4gewogICAgICBjb25zdCB0U2hpZnRlZCA9IHQgLSB0MDsKICAgICAgaWYgKHRTaGlmdGVkIDwgMCkgcmV0dXJuIDE7IC8vIEJlZm9yZSBhY3RpdmF0aW9uCiAgICAgIHJldHVybiAxICsgQSAqICgxIC0gTWF0aC5leHAoLWsgKiB0U2hpZnRlZCkpOwogICAgfTsKICAgIAogICAgLy8gQXR0YWNoIHBhcmFtZXRlcnMgdG8gZnVuY3Rpb24gZm9yIGluZm8gcGFuZWwKICAgIGZpdEZ1bmN0aW9uLnBhcmFtcyA9IHsKICAgICAgQTogQSwKICAgICAgazogaywKICAgICAgdDA6IHQwLAogICAgICB0YXU6IHRhdSwKICAgICAgdEhhbGY6IHRIYWxmLAogICAgICBwbGF0ZWF1OiBwbGF0ZWF1CiAgICB9OwogIH0gZWxzZSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgcmV0dXJuIGZpdEZ1bmN0aW9uOwp9CgpmdW5jdGlvbiBub3JtYWxpemVNZWFuQW5kRXJyb3IodGltZVBvaW50cywgbWVhbnMsIGVycm9ycywgYmFzZWxpbmVFbmRUaW1lID0gMjQsIGN1dG9mZlRpbWUgPSAzNjApIHsKICAvLyBOb3JtYWxpemUgbWVhbiBhbmQgZXJyb3IgZGF0YTogY2FsY3VsYXRlIGJhc2VsaW5lIGZyb20gMC1iYXNlbGluZUVuZFRpbWUsIHRoZW4gcGxvdCBvbmx5IHBvaW50cyBhZnRlciBiYXNlbGluZUVuZFRpbWUKICAvLyBkaXZpZGVkIGJ5IGJhc2VsaW5lLCB1cCB0byBjdXRvZmZUaW1lLiBCYXNlbGluZSBwZXJpb2QgaXMgTk9UIGluY2x1ZGVkIGluIHRoZSBwbG90LgogIC8vIFJldHVybnMgeyBmaWx0ZXJlZFRpbWVQb2ludHMsIG5vcm1hbGl6ZWRNZWFucywgbm9ybWFsaXplZEVycm9ycyB9IC0gZmlsdGVyZWQgYXJyYXlzCiAgLy8gRmlyc3QgY2FsY3VsYXRlIGJhc2VsaW5lIGZyb20gbWVhbnMKICBjb25zdCBiYXNlbGluZVZhbHVlcyA9IFtdOwogIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZVBvaW50cy5sZW5ndGg7IGkrKykgewogICAgaWYgKHRpbWVQb2ludHNbaV0gIT09IG51bGwgJiYgbWVhbnNbaV0gIT09IG51bGwgJiYgdGltZVBvaW50c1tpXSA8PSBiYXNlbGluZUVuZFRpbWUpIHsKICAgICAgYmFzZWxpbmVWYWx1ZXMucHVzaChtZWFuc1tpXSk7CiAgICB9CiAgfQogIAogIGlmIChiYXNlbGluZVZhbHVlcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB7IGZpbHRlcmVkVGltZVBvaW50czogdGltZVBvaW50cywgbm9ybWFsaXplZE1lYW5zOiBtZWFucywgbm9ybWFsaXplZEVycm9yczogZXJyb3JzIH07CiAgfQogIAogIGNvbnN0IGJhc2VsaW5lID0gYmFzZWxpbmVWYWx1ZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyBiYXNlbGluZVZhbHVlcy5sZW5ndGg7CiAgCiAgaWYgKGJhc2VsaW5lID09PSAwKSB7CiAgICByZXR1cm4geyBmaWx0ZXJlZFRpbWVQb2ludHM6IHRpbWVQb2ludHMsIG5vcm1hbGl6ZWRNZWFuczogbWVhbnMsIG5vcm1hbGl6ZWRFcnJvcnM6IGVycm9ycyB9OwogIH0KICAKICAvLyBGaWx0ZXIgYW5kIG5vcm1hbGl6ZTogb25seSBpbmNsdWRlIHBvaW50cyB3aGVyZSBiYXNlbGluZUVuZFRpbWUgPCB0aW1lIDw9IGN1dG9mZlRpbWUKICBjb25zdCBmaWx0ZXJlZFRpbWVQb2ludHMgPSBbXTsKICBjb25zdCBub3JtYWxpemVkTWVhbnMgPSBbXTsKICBjb25zdCBub3JtYWxpemVkRXJyb3JzID0gW107CiAgCiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aW1lUG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCB0aW1lID0gdGltZVBvaW50c1tpXTsKICAgIGNvbnN0IG1lYW4gPSBtZWFuc1tpXTsKICAgIGNvbnN0IGVycm9yID0gZXJyb3JzW2ldOwogICAgCiAgICBpZiAodGltZSA9PT0gbnVsbCB8fCBtZWFuID09PSBudWxsKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQogICAgCiAgICAvLyBPbmx5IGluY2x1ZGUgcG9pbnRzIGFmdGVyIGJhc2VsaW5lRW5kVGltZSBhbmQgdXAgdG8gY3V0b2ZmVGltZSAoYmFzZWxpbmUgTk9UIGluY2x1ZGVkKQogICAgaWYgKHRpbWUgPiBiYXNlbGluZUVuZFRpbWUgJiYgdGltZSA8PSBjdXRvZmZUaW1lKSB7CiAgICAgIC8vIFN1YnRyYWN0IGJhc2VsaW5lRW5kVGltZSB0byBicmluZyBmaXJzdCBwb2ludCB0byB4PTAgKHRpbWUgYWZ0ZXIgaW5qZWN0aW9uKQogICAgICBmaWx0ZXJlZFRpbWVQb2ludHMucHVzaCh0aW1lIC0gYmFzZWxpbmVFbmRUaW1lKTsKICAgICAgbm9ybWFsaXplZE1lYW5zLnB1c2gobWVhbiAvIGJhc2VsaW5lKTsKICAgICAgLy8gRXJyb3JzIHNjYWxlIHByb3BvcnRpb25hbGx5CiAgICAgIG5vcm1hbGl6ZWRFcnJvcnMucHVzaChlcnJvciAhPT0gbnVsbCA/IGVycm9yIC8gYmFzZWxpbmUgOiBudWxsKTsKICAgIH0KICB9CiAgCiAgcmV0dXJuIHsgZmlsdGVyZWRUaW1lUG9pbnRzLCBub3JtYWxpemVkTWVhbnMsIG5vcm1hbGl6ZWRFcnJvcnMgfTsKfQoKZnVuY3Rpb24gdXBkYXRlQ2hhcnQoKSB7CiAgLy8gR3VhcmQ6IGVuc3VyZSB2aWV3ZXJEYXRhIGlzIGxvYWRlZAogIGlmICghdmlld2VyRGF0YSB8fCAhYWxsV2VsbHNEYXRhIHx8IE9iamVjdC5rZXlzKGFsbFdlbGxzRGF0YSkubGVuZ3RoID09PSAwKSB7CiAgICBjb25zb2xlLndhcm4oInZpZXdlckRhdGEgbm90IGxvYWRlZCB5ZXQsIHNraXBwaW5nIGNoYXJ0IHVwZGF0ZSIpOwogICAgcmV0dXJuOwogIH0KICAKICBjb25zdCBjdHggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgid2VsbC1jaGFydCIpLmdldENvbnRleHQoIjJkIik7CgogIC8vIFNURVAgMTogQ2hlY2sgaWYgbm9ybWFsaXphdGlvbiB1c2luZyBmaXR0ZWQgYmFzZWxpbmUgaXMgZW5hYmxlZCAobXVzdCBiZSBmaXJzdCkKICBjb25zdCBub3JtYWxpemVCYXNlbGluZVRvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJub3JtYWxpemUtYmFzZWxpbmUtdG9nZ2xlIik7CiAgY29uc3Qgbm9ybWFsaXplQmFzZWxpbmUgPSBub3JtYWxpemVCYXNlbGluZVRvZ2dsZSA/IG5vcm1hbGl6ZUJhc2VsaW5lVG9nZ2xlLmNoZWNrZWQgOiBmYWxzZTsKICAKICAvLyBTVEVQIDI6IENoZWNrIGlmIHRyaXBsaWNhdGUgZ3JvdXBpbmcgaXMgZW5hYmxlZCAocmVxdWlyZXMgU3RlcCAxKQogIGNvbnN0IGdyb3VwVHJpcGxpY2F0ZXNUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZ3JvdXAtdHJpcGxpY2F0ZXMtdG9nZ2xlIik7CiAgY29uc3QgZ3JvdXBUcmlwbGljYXRlcyA9IGdyb3VwVHJpcGxpY2F0ZXNUb2dnbGUgPyBncm91cFRyaXBsaWNhdGVzVG9nZ2xlLmNoZWNrZWQgOiBmYWxzZTsKICAKICAvLyBFbmZvcmNlIHdvcmtmbG93OiBTdGVwIDIgKGdyb3VwaW5nKSByZXF1aXJlcyBTdGVwIDEgKG5vcm1hbGl6YXRpb24pCiAgaWYgKGdyb3VwVHJpcGxpY2F0ZXMgJiYgIW5vcm1hbGl6ZUJhc2VsaW5lKSB7CiAgICAvLyBEaXNhYmxlIGdyb3VwaW5nIGlmIG5vcm1hbGl6YXRpb24gaXMgbm90IGVuYWJsZWQKICAgIGlmIChncm91cFRyaXBsaWNhdGVzVG9nZ2xlKSB7CiAgICAgIGdyb3VwVHJpcGxpY2F0ZXNUb2dnbGUuY2hlY2tlZCA9IGZhbHNlOwogICAgfQogICAgZ3JvdXBUcmlwbGljYXRlcyA9IGZhbHNlOwogIH0KICAKICAvLyBTVEVQIDA6IENoZWNrIGlmIGluZGl2aWR1YWwgd2VsbHMgc2hvdWxkIGJlIHNob3duCiAgLy8gU3RlcCAwIG9ubHkgc2hvd3Mgd2hlbiBOTyBvdGhlciBwcm9jZXNzaW5nIHN0ZXBzICgxLTIpIGFyZSBlbmFibGVkCiAgY29uc3Qgc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzaG93LWluZGl2aWR1YWwtd2VsbHMtdG9nZ2xlIik7CiAgY29uc3Qgc3RlcDBSZXF1ZXN0ZWQgPSBzaG93SW5kaXZpZHVhbFdlbGxzVG9nZ2xlID8gc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZS5jaGVja2VkIDogdHJ1ZTsKICBjb25zdCBhbnlQcm9jZXNzaW5nU3RlcEVuYWJsZWQgPSBub3JtYWxpemVCYXNlbGluZSB8fCBncm91cFRyaXBsaWNhdGVzOwogIC8vIFNob3cgU3RlcCAwIGlmIHJlcXVlc3RlZCBBTkQgbm8gb3RoZXIgc3RlcHMgZW5hYmxlZAogIC8vIElmIG5vIHN0ZXBzIGFyZSBlbmFibGVkIGF0IGFsbCwgZGVmYXVsdCB0byBzaG93aW5nIFN0ZXAgMCAocmF3IGRhdGEpIGFzIGZhbGxiYWNrCiAgY29uc3Qgc2hvd0luZGl2aWR1YWxXZWxscyA9IChzdGVwMFJlcXVlc3RlZCAmJiAhYW55UHJvY2Vzc2luZ1N0ZXBFbmFibGVkKSB8fCAoIWFueVByb2Nlc3NpbmdTdGVwRW5hYmxlZCk7CiAgCiAgLy8gU2hvdy9oaWRlIFN0ZXAgMCB3YXJuaW5nCiAgY29uc3Qgc3RlcDBXYXJuaW5nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInN0ZXAwLXdhcm5pbmciKTsKICBpZiAoc3RlcDBXYXJuaW5nKSB7CiAgICBzdGVwMFdhcm5pbmcuc3R5bGUuZGlzcGxheSA9IChzdGVwMFJlcXVlc3RlZCAmJiBhbnlQcm9jZXNzaW5nU3RlcEVuYWJsZWQpID8gImJsb2NrIiA6ICJub25lIjsKICB9CiAgCiAgLy8gRGlzYWJsZSBTdGVwIDAgY2hlY2tib3ggaWYgb3RoZXIgc3RlcHMgKDEtMikgYXJlIGVuYWJsZWQgKHZpc3VhbCBmZWVkYmFjaykKICBpZiAoc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZSkgewogICAgc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZS5kaXNhYmxlZCA9IGFueVByb2Nlc3NpbmdTdGVwRW5hYmxlZDsKICB9CiAgCiAgLy8gR2V0IG5vcm1hbGl6YXRpb24gYmFzZWxpbmUgcGFyYW1ldGVycwogIGNvbnN0IG5vcm1hbGl6ZUJhc2VsaW5lRW5kSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibm9ybWFsaXplLWJhc2VsaW5lLWVuZC10aW1lIik7CiAgY29uc3Qgbm9ybWFsaXplQmFzZWxpbmVFbmRUaW1lID0gbm9ybWFsaXplQmFzZWxpbmVFbmRJbnB1dCA/IHBhcnNlRmxvYXQobm9ybWFsaXplQmFzZWxpbmVFbmRJbnB1dC52YWx1ZSkgfHwgMjQgOiAyNDsKICAKICAvLyBHZXQgYmFzZWxpbmUgZml0dGluZyBtZXRob2QgYW5kIHBhcmFtZXRlcnMKICBjb25zdCBiYXNlbGluZU1ldGhvZFNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJiYXNlbGluZS1tZXRob2Qtc2VsZWN0Iik7CiAgY29uc3QgYmFzZWxpbmVNZXRob2QgPSBiYXNlbGluZU1ldGhvZFNlbGVjdCA/IGJhc2VsaW5lTWV0aG9kU2VsZWN0LnZhbHVlIDogImxvd2VzcyI7CiAgY29uc3QgYmFzZWxpbmVGcmFjSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtZnJhYy1pbnB1dCIpOwogIGNvbnN0IGJhc2VsaW5lRnJhYyA9IGJhc2VsaW5lRnJhY0lucHV0ID8gcGFyc2VGbG9hdChiYXNlbGluZUZyYWNJbnB1dC52YWx1ZSkgfHwgMC41IDogMC41OwogIGNvbnN0IGJhc2VsaW5lUG9seU9yZGVySW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtcG9seS1vcmRlci1pbnB1dCIpOwogIGNvbnN0IGJhc2VsaW5lUG9seU9yZGVyID0gYmFzZWxpbmVQb2x5T3JkZXJJbnB1dCA/IHBhcnNlSW50KGJhc2VsaW5lUG9seU9yZGVySW5wdXQudmFsdWUpIHx8IDEgOiAxOwogIAogIC8vIEdldCBub3JtYWxpemF0aW9uIG1vZGUKICBjb25zdCBub3JtYWxpemF0aW9uTW9kZVNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJub3JtYWxpemF0aW9uLW1vZGUtc2VsZWN0Iik7CiAgY29uc3Qgbm9ybWFsaXphdGlvbk1vZGUgPSBub3JtYWxpemF0aW9uTW9kZVNlbGVjdCA/IG5vcm1hbGl6YXRpb25Nb2RlU2VsZWN0LnZhbHVlIDogImRlbHRhX2Zfb3Zlcl9mIjsKICAKICAvLyBTaG93L2hpZGUgbm9ybWFsaXphdGlvbiBiYXNlbGluZSBwYXJhbWV0ZXJzCiAgY29uc3Qgbm9ybWFsaXplQmFzZWxpbmVQYXJhbWV0ZXJzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm5vcm1hbGl6ZS1iYXNlbGluZS1wYXJhbWV0ZXJzIik7CiAgaWYgKG5vcm1hbGl6ZUJhc2VsaW5lUGFyYW1ldGVyc0RpdiAmJiBub3JtYWxpemVCYXNlbGluZVRvZ2dsZSkgewogICAgbm9ybWFsaXplQmFzZWxpbmVQYXJhbWV0ZXJzRGl2LnN0eWxlLmRpc3BsYXkgPSBub3JtYWxpemVCYXNlbGluZSA/ICJibG9jayIgOiAibm9uZSI7CiAgfQogIAogIC8vIFNURVAgMzogQ2hlY2sgaWYgY3V0b2ZmIGlzIGVuYWJsZWQKICBjb25zdCBjdXRvZmZCYXNlbGluZVRvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXRvZmYtYmFzZWxpbmUtdG9nZ2xlIik7CiAgY29uc3QgY3V0b2ZmQmFzZWxpbmUgPSBjdXRvZmZCYXNlbGluZVRvZ2dsZSA/IGN1dG9mZkJhc2VsaW5lVG9nZ2xlLmNoZWNrZWQgOiBmYWxzZTsKICBjb25zdCBjdXRvZmZCYXNlbGluZVRpbWVJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXRvZmYtYmFzZWxpbmUtdGltZSIpOwogIGNvbnN0IGN1dG9mZkJhc2VsaW5lVGltZSA9IGN1dG9mZkJhc2VsaW5lVGltZUlucHV0ID8gcGFyc2VGbG9hdChjdXRvZmZCYXNlbGluZVRpbWVJbnB1dC52YWx1ZSkgfHwgMzYwIDogMzYwOwogIAogIC8vIFNob3cvaGlkZSBjdXRvZmYgcGFyYW1ldGVycwogIGNvbnN0IGN1dG9mZkJhc2VsaW5lUGFyYW1ldGVyc0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXRvZmYtYmFzZWxpbmUtcGFyYW1ldGVycyIpOwogIGlmIChjdXRvZmZCYXNlbGluZVBhcmFtZXRlcnNEaXYgJiYgY3V0b2ZmQmFzZWxpbmVUb2dnbGUpIHsKICAgIGN1dG9mZkJhc2VsaW5lUGFyYW1ldGVyc0Rpdi5zdHlsZS5kaXNwbGF5ID0gY3V0b2ZmQmFzZWxpbmUgPyAiYmxvY2siIDogIm5vbmUiOwogIH0KICAKICAvLyBTVEVQIDQ6IENoZWNrIGlmIHJlZ3Jlc3Npb24gaXMgZW5hYmxlZAogIGNvbnN0IGZpdFJlZ3Jlc3Npb25Ub2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZml0LXJlZ3Jlc3Npb24tdG9nZ2xlIik7CiAgY29uc3QgZml0UmVncmVzc2lvbiA9IGZpdFJlZ3Jlc3Npb25Ub2dnbGUgPyBmaXRSZWdyZXNzaW9uVG9nZ2xlLmNoZWNrZWQgOiBmYWxzZTsKICBjb25zdCByZWdyZXNzaW9uVHlwZVNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZWdyZXNzaW9uLXR5cGUtc2VsZWN0Iik7CiAgY29uc3QgcmVncmVzc2lvblR5cGUgPSByZWdyZXNzaW9uVHlwZVNlbGVjdCA/IHJlZ3Jlc3Npb25UeXBlU2VsZWN0LnZhbHVlIDogIm1vbm8tZXhwb25lbnRpYWwiOwogIGNvbnN0IHBvbHlub21pYWxPcmRlcklucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInBvbHlub21pYWwtb3JkZXItaW5wdXQiKTsKICBjb25zdCBwb2x5bm9taWFsT3JkZXIgPSBwb2x5bm9taWFsT3JkZXJJbnB1dCA/IHBhcnNlSW50KHBvbHlub21pYWxPcmRlcklucHV0LnZhbHVlKSB8fCAyIDogMjsKICAKICAvLyBTaG93L2hpZGUgcmVncmVzc2lvbiBwYXJhbWV0ZXJzCiAgY29uc3QgZml0UmVncmVzc2lvblBhcmFtZXRlcnNEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZml0LXJlZ3Jlc3Npb24tcGFyYW1ldGVycyIpOwogIGlmIChmaXRSZWdyZXNzaW9uUGFyYW1ldGVyc0RpdiAmJiBmaXRSZWdyZXNzaW9uVG9nZ2xlKSB7CiAgICBmaXRSZWdyZXNzaW9uUGFyYW1ldGVyc0Rpdi5zdHlsZS5kaXNwbGF5ID0gZml0UmVncmVzc2lvbiA/ICJibG9jayIgOiAibm9uZSI7CiAgfQogIAogIC8vIFVwZGF0ZSByZWdyZXNzaW9uIHR5cGUgcGFyYW1zIHRvIHNob3cvaGlkZSBpbmZvIHBhbmVsIHdoZW4gcmVncmVzc2lvbiBpcyB0b2dnbGVkCiAgaWYgKGZpdFJlZ3Jlc3Npb24pIHsKICAgIHVwZGF0ZVJlZ3Jlc3Npb25UeXBlUGFyYW1zKHRydWUpOyAvLyBTa2lwIGNoYXJ0IHVwZGF0ZSBzaW5jZSB3ZSdyZSBhbHJlYWR5IHVwZGF0aW5nCiAgfSBlbHNlIHsKICAgIC8vIEhpZGUgaW5mbyBwYW5lbCB3aGVuIHJlZ3Jlc3Npb24gaXMgZGlzYWJsZWQKICAgIGNvbnN0IGluZm9QYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZWdyZXNzaW9uLWluZm8tcGFuZWwiKTsKICAgIGlmIChpbmZvUGFuZWwpIHsKICAgICAgaW5mb1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICB9CiAgfQoKICBpZiAoc2VsZWN0ZWRXZWxscy5zaXplID09PSAwKSB7CiAgICAvLyBDbGVhciB0aGUgY2hhcnQgaWYgbm8gd2VsbHMgc2VsZWN0ZWQKICAgIC8vIERldGVybWluZSB5LWF4aXMgbGFiZWwgYmFzZWQgb24gcHJvY2Vzc2luZyBzdGVwcwogICAgbGV0IHlBeGlzTGFiZWwgPSAiRmx1b3Jlc2NlbmNlIChGSSkiOwogICAgaWYgKG5vcm1hbGl6ZUJhc2VsaW5lKSB7CiAgICAgIGlmIChub3JtYWxpemF0aW9uTW9kZSA9PT0gJ2RlbHRhX2Zfb3Zlcl9mJykgewogICAgICAgIHlBeGlzTGFiZWwgPSAizpRGL0YgKE5vcm1hbGl6ZWQpIjsKICAgICAgfSBlbHNlIHsKICAgICAgICB5QXhpc0xhYmVsID0gIkYvRuKCgCAoTm9ybWFsaXplZCkiOwogICAgICB9CiAgICB9CiAgICBpZiAoY2hhcnQpIHsKICAgICAgLy8gVHJhbnNmb3JtIGV4aXN0aW5nIGNoYXJ0CiAgICAgIGNoYXJ0LmRhdGEuZGF0YXNldHMgPSBbXTsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueC50aXRsZS50ZXh0ID0gIlRpbWUgKHMpIjsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueS50aXRsZS50ZXh0ID0geUF4aXNMYWJlbDsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueS5taW4gPSB1bmRlZmluZWQ7CiAgICAgIGNoYXJ0Lm9wdGlvbnMucGx1Z2lucy50aXRsZS50ZXh0ID0gIlNlbGVjdCB3ZWxscyB0byBkaXNwbGF5IGRhdGEiOwogICAgICBjaGFydC51cGRhdGUoJ25vbmUnKTsgLy8gVXBkYXRlIHdpdGhvdXQgYW5pbWF0aW9uCiAgICB9IGVsc2UgewogICAgICAvLyBDcmVhdGUgbmV3IGNoYXJ0IG9ubHkgaWYgaXQgZG9lc24ndCBleGlzdAogICAgICBjaGFydCA9IG5ldyBDaGFydChjdHgsIHsKICAgICAgICB0eXBlOiAibGluZSIsCiAgICAgICAgZGF0YTogeyBkYXRhc2V0czogW10gfSwKICAgICAgICBvcHRpb25zOiB7CiAgICAgICAgICByZXNwb25zaXZlOiB0cnVlLAogICAgICAgICAgbWFpbnRhaW5Bc3BlY3RSYXRpbzogZmFsc2UsCiAgICAgICAgICBzY2FsZXM6IHsKICAgICAgICAgICAgeDogeyAKICAgICAgICAgICAgICB0eXBlOiAibGluZWFyIiwgCiAgICAgICAgICAgICAgdGl0bGU6IHsgZGlzcGxheTogdHJ1ZSwgdGV4dDogIlRpbWUgKHMpIiB9IAogICAgICAgICAgICB9LAogICAgICAgICAgICB5OiB7IAogICAgICAgICAgICAgIHRpdGxlOiB7IGRpc3BsYXk6IHRydWUsIHRleHQ6IHlBeGlzTGFiZWwgfSwKICAgICAgICAgICAgICBtaW46IHVuZGVmaW5lZAogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgcGx1Z2luczogewogICAgICAgICAgICBsZWdlbmQ6IHsgZGlzcGxheTogZmFsc2UgfSwKICAgICAgICAgICAgdGl0bGU6IHsgZGlzcGxheTogdHJ1ZSwgdGV4dDogIlNlbGVjdCB3ZWxscyB0byBkaXNwbGF5IGRhdGEiIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuOwogIH0KCiAgY29uc3QgZGF0YXNldHMgPSBbXTsKICBjb25zdCBjb2xvcnMgPSBbCiAgICAicmdiYSg1NCwgMTYyLCAyMzUsIDEuMCkiLAogICAgInJnYmEoMjU1LCA5OSwgMTMyLCAxLjApIiwKICAgICJyZ2JhKDI1NSwgMjA2LCA4NiwgMS4wKSIsCiAgICAicmdiYSg3NSwgMTkyLCAxOTIsIDEuMCkiLAogICAgInJnYmEoMTUzLCAxMDIsIDI1NSwgMS4wKSIsCiAgICAicmdiYSgyNTUsIDE1OSwgNjQsIDEuMCkiLAogICAgInJnYmEoMTk5LCAxOTksIDE5OSwgMS4wKSIsCiAgICAicmdiYSg4MywgMTAyLCAyNTUsIDEuMCkiCiAgXTsKICAKICBsZXQgY29sb3JJZHggPSAwOwogIAogIC8vIFNURVAgMDogQWRkIGluZGl2aWR1YWwgd2VsbHMgKHJhdyBkYXRhLCBiZWZvcmUgYW55IHByb2Nlc3NpbmcpIGlmIGVuYWJsZWQKICBpZiAoc2hvd0luZGl2aWR1YWxXZWxscykgewogICAgQXJyYXkuZnJvbShzZWxlY3RlZFdlbGxzKS5mb3JFYWNoKGtleSA9PiB7CiAgICAgIGNvbnN0IFtwbGF0ZUlkLCB3ZWxsSWRdID0ga2V5LnNwbGl0KCI6Iik7CiAgICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgICAgCiAgICAgIC8vIEZpbHRlciBieSBlbmFibGVkQ29sdW1ucyBpZiBhbnkgYXJlIHNldCAoc2NpZW50aXN0LXNwZWNpZmljKQogICAgICBjb25zdCBwbGF0ZSA9IHZpZXdlckRhdGEucGxhdGVzLmZpbmQocCA9PiBwLmlkID09PSBwbGF0ZUlkKTsKICAgICAgY29uc3Qgc2NpZW50aXN0ID0gcGxhdGUgJiYgcGxhdGUuY29sdW1uX2luZm8gPyAocGxhdGUuY29sdW1uX2luZm8uc2NpZW50aXN0IHx8ICIiKSA6ICIiOwogICAgICBjb25zdCBlbmFibGVkQ29sdW1ucyA9IGdldEVuYWJsZWRDb2x1bW5zRm9yU2NpZW50aXN0KHNjaWVudGlzdCk7CiAgICAgIGlmIChlbmFibGVkQ29sdW1ucy5zaXplID4gMCAmJiAhZW5hYmxlZENvbHVtbnMuaGFzKGNvbHVtbikpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgCiAgICAgIC8vIEZpbHRlciBieSBlbmFibGVkV2VsbHMgaWYgYW55IGFyZSBzZXQKICAgICAgY29uc3Qgbm9ybWFsaXplZFdlbGxJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpOwogICAgICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCkgJiYgIWVuYWJsZWRXZWxscy5oYXMobm9ybWFsaXplZFdlbGxJZCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgCiAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICBjb25zdCB3ZWxsRGF0YSA9IHdlbGxzW25vcm1hbGl6ZWRXZWxsSWRdIHx8IHdlbGxzW3dlbGxJZF07CiAgICAgIGlmICh3ZWxsRGF0YSkgewogICAgICAgIGNvbnN0IGZpbGVuYW1lID0gcGxhdGUgPyAocGxhdGUuZmlsZSB8fCBwbGF0ZS5pZCkgOiBwbGF0ZUlkOwogICAgICAgIGNvbnN0IGNvbmZpZyA9IHZpZXdlckRhdGEuY29uZmlnIHx8IHt9OwogICAgICAgIGNvbnN0IHdlbGxMYWJlbHMgPSBjb25maWcud2VsbF9sYWJlbHMgfHwge307CiAgICAgICAgY29uc3Qgcm93TGV0dGVyID0gZ2V0Um93TGV0dGVyKHdlbGxJZCk7CiAgICAgICAgY29uc3QgaXNDb250cm9sID0gaXNDb250cm9sV2VsbCh3ZWxsSWQpOwogICAgICAgIGNvbnN0IGxhYmVsID0gd2VsbExhYmVsc1tyb3dMZXR0ZXJdIHx8IHdlbGxEYXRhLmxhYmVsIHx8IHdlbGxEYXRhLmNvbnRlbnQgfHwgYFdlbGwgJHt3ZWxsSWR9YDsKICAgICAgICBjb25zdCBmb3JtYXR0ZWRMYWJlbCA9IGZvcm1hdExhYmVsKGxhYmVsKTsKICAgICAgICAKICAgICAgICAvLyBVc2UgcmF3IGRhdGEgKG5vdCBwcm9jZXNzZWQpIGZvciBTdGVwIDAKICAgICAgICBjb25zdCBjb2xvciA9IGNvbG9yc1tjb2xvcklkeCAlJSBjb2xvcnMubGVuZ3RoXTsKICAgICAgICBjb2xvcklkeCsrOwogICAgICAgIAogICAgICAgIC8vIEFkZCAiQ29udHJvbCIgc3VmZml4IGZvciBjb250cm9sIHdlbGxzCiAgICAgICAgY29uc3QgZGlzcGxheUxhYmVsID0gaXNDb250cm9sIAogICAgICAgICAgPyBgJHt3ZWxsSWR9IC0gJHtmb3JtYXR0ZWRMYWJlbH0gQ29udHJvbCBDb2wgJHtjb2x1bW59YAogICAgICAgICAgOiBgJHt3ZWxsSWR9IC0gJHtmb3JtYXR0ZWRMYWJlbH0gQ29sICR7Y29sdW1ufWA7CiAgICAgICAgCiAgICAgICAgZGF0YXNldHMucHVzaCh7CiAgICAgICAgICBsYWJlbDogZGlzcGxheUxhYmVsLAogICAgICAgICAgZGF0YTogd2VsbERhdGEudGltZV9zLm1hcCgodCwgaSkgPT4gKHsgeDogdCwgeTogd2VsbERhdGEudmFsdWVzW2ldIH0pKS5maWx0ZXIoZCA9PiBkLnkgIT09IG51bGwgJiYgZC54ICE9PSBudWxsKSwKICAgICAgICAgIGJvcmRlckNvbG9yOiBjb2xvci5yZXBsYWNlKCIxLjAiLCAiMC41IiksIC8vIExpZ2h0ZXIgY29sb3IgZm9yIHJhdyBkYXRhCiAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICB0ZW5zaW9uOiAwLjE1LAogICAgICAgICAgcG9pbnRSYWRpdXM6IDEuNSwKICAgICAgICAgIGJvcmRlcldpZHRoOiAxLAogICAgICAgICAgYm9yZGVyRGFzaDogWzMsIDNdLCAvLyBEYXNoZWQgbGluZSBmb3IgcmF3IGRhdGEKICAgICAgICAgIGZpbGw6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIH0KICAKCiAgLy8gR3JvdXAgc2VsZWN0ZWQgd2VsbHMgYnkgdHJpcGxpY2F0ZSBncm91cCBvciBpbmRpdmlkdWFsIHdlbGwKICBjb25zdCBncm91cGVkU2VsZWN0aW9ucyA9IHt9OwogIGNvbnN0IHNlbGVjdGVkRGF0YXNldHMgPSBnZXRTZWxlY3RlZERhdGFzZXRzKCk7CiAgCiAgLy8gZ3JvdXBUcmlwbGljYXRlcyBhbHJlYWR5IGRlZmluZWQgYWJvdmUKICAKICAvLyBGaXJzdCBwYXNzOiBpZGVudGlmeSBhbGwgdHJpcGxpY2F0ZSBncm91cHMgZnJvbSBzZWxlY3RlZCB3ZWxscwogIC8vIE9ubHkgZ3JvdXAgaW50byB0cmlwbGljYXRlcyBpZiBTdGVwIDIgaXMgZW5hYmxlZAogIGNvbnN0IHRyaXBsaWNhdGVHcm91cHNGb3VuZCA9IG5ldyBNYXAoKTsgLy8gZ3JvdXBLZXkgLT4geyBuYW1lLCBjb2x1bW4sIHdlbGxzOiBTZXQgb2Ygd2VsbElkcyB9CiAgCiAgQXJyYXkuZnJvbShzZWxlY3RlZFdlbGxzKS5mb3JFYWNoKGtleSA9PiB7CiAgICBjb25zdCBbcGxhdGVJZCwgd2VsbElkXSA9IGtleS5zcGxpdCgiOiIpOwogICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgCiAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZENvbHVtbnMgaWYgYW55IGFyZSBzZXQgKHNjaWVudGlzdC1zcGVjaWZpYykKICAgIGNvbnN0IHBsYXRlID0gdmlld2VyRGF0YS5wbGF0ZXMuZmluZChwID0+IHAuaWQgPT09IHBsYXRlSWQpOwogICAgY29uc3Qgc2NpZW50aXN0ID0gcGxhdGUgJiYgcGxhdGUuY29sdW1uX2luZm8gPyAocGxhdGUuY29sdW1uX2luZm8uc2NpZW50aXN0IHx8ICIiKSA6ICIiOwogICAgY29uc3QgZW5hYmxlZENvbHVtbnMgPSBnZXRFbmFibGVkQ29sdW1uc0ZvclNjaWVudGlzdChzY2llbnRpc3QpOwogICAgaWYgKGVuYWJsZWRDb2x1bW5zLnNpemUgPiAwICYmICFlbmFibGVkQ29sdW1ucy5oYXMoY29sdW1uKSkgewogICAgICByZXR1cm47IC8vIFNraXAgd2VsbHMgZnJvbSBkaXNhYmxlZCBjb2x1bW5zCiAgICB9CiAgICAKICAgIC8vIEZpbHRlciBieSBlbmFibGVkV2VsbHMgaWYgYW55IGFyZSBzZXQgKGV4Y2x1ZGUgd2VsbHMpCiAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCkgJiYgIWVuYWJsZWRXZWxscy5oYXMobm9ybWFsaXplZFdlbGxJZCkpIHsKICAgICAgcmV0dXJuOyAvLyBTa2lwIGV4Y2x1ZGVkIHdlbGxzCiAgICB9CiAgICAKICAgIGNvbnN0IGlzQ29udHJvbCA9IGlzQ29udHJvbFdlbGwod2VsbElkKTsKICAgIAogICAgLy8gQ29udHJvbHMgYXJlIGFsd2F5cyBoYW5kbGVkIGFzIGluZGl2aWR1YWwgd2VsbHMgKG5vIGdyb3VwaW5nKQogICAgaWYgKGlzQ29udHJvbCkgewogICAgICByZXR1cm47IC8vIFNraXAgY29udHJvbHMgLSB0aGV5J2xsIGJlIGhhbmRsZWQgYXMgaW5kaXZpZHVhbCB3ZWxscyBpbiB0aGUgdGhpcmQgcGFzcwogICAgfQogICAgCiAgICAvLyBTVEVQIDI6IE9ubHkgZ3JvdXAgaW50byB0cmlwbGljYXRlcyBpZiBncm91cGluZyBpcyBlbmFibGVkCiAgICBpZiAoZ3JvdXBUcmlwbGljYXRlcykgewogICAgICBjb25zdCB0cmlwbGljYXRlR3JvdXAgPSBnZXRUcmlwbGljYXRlR3JvdXAod2VsbElkLCBjb2x1bW4pOwogICAgICBpZiAodHJpcGxpY2F0ZUdyb3VwKSB7CiAgICAgICAgLy8gQ3JlYXRlIGdyb3VwIGtleSB0aGF0IGluY2x1ZGVzIGNvbHVtbiB0byBzZXBhcmF0ZSBzYW1lIHBhdHRlcm4gYWNyb3NzIGNvbHVtbnMKICAgICAgICBjb25zdCBncm91cEtleSA9IGAke3RyaXBsaWNhdGVHcm91cC5uYW1lfV9jb2wke2NvbHVtbn1gOwogICAgICAgIGlmICghdHJpcGxpY2F0ZUdyb3Vwc0ZvdW5kLmhhcyhncm91cEtleSkpIHsKICAgICAgICAgIC8vIEdldCByb3cgbGV0dGVycyBmcm9tIHRoZSB0cmlwbGljYXRlIGdyb3VwIHBhdHRlcm4KICAgICAgICAgIGNvbnN0IGdyb3VwUm93TGV0dGVycyA9IGdldFJvd0xldHRlcnNGcm9tV2VsbHModHJpcGxpY2F0ZUdyb3VwLndlbGxzKTsKICAgICAgICAgIC8vIENyZWF0ZSB3ZWxsIElEcyBmb3IgdGhpcyBjb2x1bW4gdXNpbmcgdGhlIHJvdyBwYXR0ZXJuCiAgICAgICAgICBjb25zdCB3ZWxsSWRzRm9yQ29sdW1uID0gZ3JvdXBSb3dMZXR0ZXJzLm1hcChyb3cgPT4gcm93ICsgY29sdW1uKTsKICAgICAgICAgIAogICAgICAgICAgdHJpcGxpY2F0ZUdyb3Vwc0ZvdW5kLnNldChncm91cEtleSwgewogICAgICAgICAgICBuYW1lOiB0cmlwbGljYXRlR3JvdXAubmFtZSwKICAgICAgICAgICAgY29sdW1uOiBjb2x1bW4sCiAgICAgICAgICAgIHdlbGxJZHM6IG5ldyBTZXQod2VsbElkc0ZvckNvbHVtbikKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLy8gSWYgZ3JvdXBpbmcgaXMgZGlzYWJsZWQsIHdlbGxzIHdpbGwgYmUgaGFuZGxlZCBhcyBpbmRpdmlkdWFsIHdlbGxzIGluIHRoZSB0aGlyZCBwYXNzCiAgfSk7CiAgCiAgLy8gU2Vjb25kIHBhc3M6IGJ1aWxkIGdyb3VwZWQgc2VsZWN0aW9ucyBmb3IgdHJpcGxpY2F0ZSBncm91cHMKICB0cmlwbGljYXRlR3JvdXBzRm91bmQuZm9yRWFjaCgoZ3JvdXBJbmZvLCBncm91cEtleSkgPT4gewogICAgZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldID0gewogICAgICB0eXBlOiAidHJpcGxpY2F0ZSIsCiAgICAgIHdlbGxzOiBbXSwKICAgICAgbmFtZTogZ3JvdXBJbmZvLm5hbWUKICAgIH07CiAgICAKICAgIC8vIENvbGxlY3Qgd2VsbHMgZnJvbSBkYXRhc2V0cyB0aGF0IGhhdmUgc2VsZWN0ZWQgd2VsbHMgaW4gdGhpcyB0cmlwbGljYXRlIGdyb3VwCiAgICBBcnJheS5mcm9tKHNlbGVjdGVkV2VsbHMpLmZvckVhY2goa2V5ID0+IHsKICAgICAgY29uc3QgW3BsYXRlSWQsIHdlbGxJZF0gPSBrZXkuc3BsaXQoIjoiKTsKICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgICAgIC8vIENoZWNrIGlmIHRoaXMgd2VsbCBpcyBpbiB0aGUgZ3JvdXAgKHVzaW5nIG5vcm1hbGl6ZWQgSUQpCiAgICAgIGNvbnN0IG5vcm1hbGl6ZWRXZWxsSWRzRm9yQ29sdW1uID0gQXJyYXkuZnJvbShncm91cEluZm8ud2VsbElkcykubWFwKHcgPT4gbm9ybWFsaXplV2VsbElkKHcpKTsKICAgICAgaWYgKG5vcm1hbGl6ZWRXZWxsSWRzRm9yQ29sdW1uLmluY2x1ZGVzKG5vcm1hbGl6ZWRXZWxsSWQpICYmIGNvbHVtbiA9PT0gZ3JvdXBJbmZvLmNvbHVtbikgewogICAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICAgIGNvbnN0IHdlbGxEYXRhID0gd2VsbHNbbm9ybWFsaXplZFdlbGxJZF0gfHwgd2VsbHNbd2VsbElkXTsKICAgICAgICBpZiAod2VsbERhdGEpIHsKICAgICAgICAgIC8vIENoZWNrIGlmIGFscmVhZHkgYWRkZWQKICAgICAgICAgIGNvbnN0IGV4aXN0cyA9IGdyb3VwZWRTZWxlY3Rpb25zW2dyb3VwS2V5XS53ZWxscy5zb21lKAogICAgICAgICAgICB3ID0+IHcud2VsbElkID09PSB3ZWxsSWQgJiYgdy5wbGF0ZUlkID09PSBwbGF0ZUlkCiAgICAgICAgICApOwogICAgICAgICAgaWYgKCFleGlzdHMpIHsKICAgICAgICAgICAgLy8gU1RFUCAxOiBBcHBseSBub3JtYWxpemF0aW9uIHVzaW5nIGZpdHRlZCBiYXNlbGluZSBpZiBlbmFibGVkIChtdXN0IGhhcHBlbiBiZWZvcmUgZ3JvdXBpbmcpCiAgICAgICAgICAgIGxldCBwcm9jZXNzZWRXZWxsRGF0YSA9IHdlbGxEYXRhOwogICAgICAgICAgICBpZiAobm9ybWFsaXplQmFzZWxpbmUpIHsKICAgICAgICAgICAgICBwcm9jZXNzZWRXZWxsRGF0YSA9IG5vcm1hbGl6ZVdpdGhGaXR0ZWRCYXNlbGluZSgKICAgICAgICAgICAgICAgIHByb2Nlc3NlZFdlbGxEYXRhLAogICAgICAgICAgICAgICAgbm9ybWFsaXplQmFzZWxpbmVFbmRUaW1lLAogICAgICAgICAgICAgICAgYmFzZWxpbmVNZXRob2QsCiAgICAgICAgICAgICAgICBiYXNlbGluZUZyYWMsCiAgICAgICAgICAgICAgICBiYXNlbGluZVBvbHlPcmRlciwKICAgICAgICAgICAgICAgIG5vcm1hbGl6YXRpb25Nb2RlCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoIXByb2Nlc3NlZFdlbGxEYXRhKSByZXR1cm47IC8vIFNraXAgaWYgbm9ybWFsaXphdGlvbiBmYWlsZWQKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBBZGQgdG8gZ3JvdXAgKFN0ZXAgMiBoYXBwZW5zIGhlcmUgLSBncm91cGluZykKICAgICAgICAgICAgLy8gU3RlcCAzIChhdmVyYWdpbmcpIHdpbGwgYmUgYXBwbGllZCBsYXRlcgogICAgICAgICAgICBncm91cGVkU2VsZWN0aW9uc1tncm91cEtleV0ud2VsbHMucHVzaCh7CiAgICAgICAgICAgICAgd2VsbElkOiB3ZWxsSWQsCiAgICAgICAgICAgICAgcGxhdGVJZDogcGxhdGVJZCwKICAgICAgICAgICAgICBkYXRhOiBwcm9jZXNzZWRXZWxsRGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0pOwogIAogIC8vIFRoaXJkIHBhc3M6IGhhbmRsZSBpbmRpdmlkdWFsIHdlbGxzIChza2lwIGlmIGFscmVhZHkgaW4gdHJpcGxpY2F0ZSBncm91cCkKICBBcnJheS5mcm9tKHNlbGVjdGVkV2VsbHMpLmZvckVhY2goa2V5ID0+IHsKICAgIC8vIFZlcmlmeSB0aGlzIHdlbGwgaXMgc3RpbGwgc2VsZWN0ZWQgKG1heSBoYXZlIGJlZW4gZGVzZWxlY3RlZCkKICAgIGlmICghc2VsZWN0ZWRXZWxscy5oYXMoa2V5KSkgewogICAgICByZXR1cm47IC8vIFNraXAgd2VsbHMgdGhhdCBhcmUgbm8gbG9uZ2VyIHNlbGVjdGVkCiAgICB9CiAgICAKICAgIGNvbnN0IFtwbGF0ZUlkLCB3ZWxsSWRdID0ga2V5LnNwbGl0KCI6Iik7CiAgICBjb25zdCBjb2x1bW4gPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICBjb25zdCBpc0NvbnRyb2wgPSBpc0NvbnRyb2xXZWxsKHdlbGxJZCk7CiAgICAKICAgIC8vIENvbnRyb2xzIGFyZSBhbHdheXMgaGFuZGxlZCBhcyBpbmRpdmlkdWFsIHdlbGxzIChubyBncm91cGluZykKICAgIGlmIChpc0NvbnRyb2wpIHsKICAgICAgLy8gQ29udGludWUgdG8gcHJvY2VzcyBhcyBpbmRpdmlkdWFsIHdlbGwKICAgIH0gZWxzZSB7CiAgICAgIC8vIFNURVAgMjogQ2hlY2sgaWYgdGhpcyB3ZWxsIGlzIHBhcnQgb2YgYSB0cmlwbGljYXRlIGdyb3VwIHdlJ3ZlIGFscmVhZHkgcHJvY2Vzc2VkCiAgICAgIC8vIE9ubHkgc2tpcCBpZiBncm91cGluZyBpcyBlbmFibGVkIGFuZCB0aGlzIHdlbGwgd2FzIGdyb3VwZWQKICAgICAgaWYgKGdyb3VwVHJpcGxpY2F0ZXMpIHsKICAgICAgICBjb25zdCB0cmlwbGljYXRlR3JvdXAgPSBnZXRUcmlwbGljYXRlR3JvdXAod2VsbElkLCBjb2x1bW4pOwogICAgICAgIGlmICh0cmlwbGljYXRlR3JvdXApIHsKICAgICAgICAgIC8vIEFscmVhZHkgaGFuZGxlZCBpbiB0cmlwbGljYXRlR3JvdXBzRm91bmQgLSBza2lwCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAKICAgIC8vIEZpbHRlciBieSBlbmFibGVkV2VsbHMgaWYgYW55IGFyZSBzZXQKICAgIGNvbnN0IG5vcm1hbGl6ZWRXZWxsSWQgPSBub3JtYWxpemVXZWxsSWQod2VsbElkKTsKICAgIGlmIChlbmFibGVkV2VsbHMuc2l6ZSA+IDAgJiYgIWVuYWJsZWRXZWxscy5oYXMod2VsbElkKSAmJiAhZW5hYmxlZFdlbGxzLmhhcyhub3JtYWxpemVkV2VsbElkKSkgewogICAgICByZXR1cm47IC8vIFNraXAgZXhjbHVkZWQgd2VsbHMKICAgIH0KICAgIAogICAgLy8gSW5kaXZpZHVhbCB3ZWxsIChub3QgcGFydCBvZiBhIHRyaXBsaWNhdGUgZ3JvdXApCiAgICBjb25zdCBncm91cEtleSA9IGB3ZWxsXyR7d2VsbElkfWA7CiAgICBpZiAoIWdyb3VwZWRTZWxlY3Rpb25zW2dyb3VwS2V5XSkgewogICAgICBjb25zdCBjb25maWcgPSB2aWV3ZXJEYXRhLmNvbmZpZyB8fCB7fTsKICAgICAgY29uc3Qgd2VsbExhYmVscyA9IGNvbmZpZy53ZWxsX2xhYmVscyB8fCB7fTsKICAgICAgLy8gR2V0IGxhYmVsIGZyb20gcm93LWJhc2VkIGNvbmZpZyBvciB3ZWxsIGRhdGEKICAgICAgY29uc3Qgcm93TGV0dGVyID0gZ2V0Um93TGV0dGVyKHdlbGxJZCk7CiAgICAgIGxldCBsYWJlbCA9IHdlbGxMYWJlbHNbcm93TGV0dGVyXTsKICAgICAgaWYgKCFsYWJlbCkgewogICAgICAgIGZvciAoY29uc3QgcElkIG9mIHNlbGVjdGVkRGF0YXNldHMpIHsKICAgICAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BJZF0gfHwge307CiAgICAgICAgICBjb25zdCB3ZWxsRGF0YSA9IHdlbGxzW25vcm1hbGl6ZWRXZWxsSWRdIHx8IHdlbGxzW3dlbGxJZF07CiAgICAgICAgICBpZiAod2VsbERhdGEpIHsKICAgICAgICAgICAgbGFiZWwgPSB3ZWxsRGF0YS5sYWJlbCB8fCB3ZWxsRGF0YS5jb250ZW50IHx8IGBXZWxsICR7d2VsbElkfWA7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBncm91cGVkU2VsZWN0aW9uc1tncm91cEtleV0gPSB7CiAgICAgICAgdHlwZTogInNpbmdsZSIsCiAgICAgICAgd2VsbHM6IFtdLAogICAgICAgIGxhYmVsOiBmb3JtYXRMYWJlbChsYWJlbCkgfHwgYFdlbGwgJHt3ZWxsSWR9YAogICAgICB9OwogICAgfQogICAgCiAgICAvLyBBZGQgdGhpcyB3ZWxsJ3MgZGF0YSBpZiBpdCBleGlzdHMKICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgY29uc3Qgd2VsbERhdGEgPSB3ZWxsc1tub3JtYWxpemVkV2VsbElkXSB8fCB3ZWxsc1t3ZWxsSWRdOwogICAgaWYgKHdlbGxEYXRhKSB7CiAgICAgIGNvbnN0IGV4aXN0aW5nID0gZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldLndlbGxzLmZpbmQodyA9PiB3LndlbGxJZCA9PT0gd2VsbElkICYmIHcucGxhdGVJZCA9PT0gcGxhdGVJZCk7CiAgICAgIGlmICghZXhpc3RpbmcpIHsKICAgICAgICAgIC8vIFNURVAgMTogQXBwbHkgbm9ybWFsaXphdGlvbiB1c2luZyBmaXR0ZWQgYmFzZWxpbmUgaWYgZW5hYmxlZCAobXVzdCBoYXBwZW4gYmVmb3JlIGdyb3VwaW5nKQogICAgICAgICAgbGV0IHByb2Nlc3NlZFdlbGxEYXRhID0gd2VsbERhdGE7CiAgICAgICAgICBpZiAobm9ybWFsaXplQmFzZWxpbmUpIHsKICAgICAgICAgICAgcHJvY2Vzc2VkV2VsbERhdGEgPSBub3JtYWxpemVXaXRoRml0dGVkQmFzZWxpbmUoCiAgICAgICAgICAgICAgcHJvY2Vzc2VkV2VsbERhdGEsCiAgICAgICAgICAgICAgbm9ybWFsaXplQmFzZWxpbmVFbmRUaW1lLAogICAgICAgICAgICAgIGJhc2VsaW5lTWV0aG9kLAogICAgICAgICAgICAgIGJhc2VsaW5lRnJhYywKICAgICAgICAgICAgICBiYXNlbGluZVBvbHlPcmRlciwKICAgICAgICAgICAgICBub3JtYWxpemF0aW9uTW9kZQogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoIXByb2Nlc3NlZFdlbGxEYXRhKSByZXR1cm47IC8vIFNraXAgaWYgbm9ybWFsaXphdGlvbiBmYWlsZWQKICAgICAgICAgIH0KICAgICAgICAgIC8vIFNURVAgNDogQXBwbHkgbm9ybWFsaXphdGlvbiB1c2luZyBmaXR0ZWQgYmFzZWxpbmUgaWYgZW5hYmxlZAogICAgICAgICAgaWYgKG5vcm1hbGl6ZUJhc2VsaW5lKSB7CiAgICAgICAgICAgIHByb2Nlc3NlZFdlbGxEYXRhID0gbm9ybWFsaXplV2l0aEZpdHRlZEJhc2VsaW5lKAogICAgICAgICAgICAgIHByb2Nlc3NlZFdlbGxEYXRhLAogICAgICAgICAgICAgIG5vcm1hbGl6ZUJhc2VsaW5lRW5kVGltZSwKICAgICAgICAgICAgICBiYXNlbGluZU1ldGhvZCwKICAgICAgICAgICAgICBiYXNlbGluZUZyYWMsCiAgICAgICAgICAgICAgYmFzZWxpbmVQb2x5T3JkZXIsCiAgICAgICAgICAgICAgbm9ybWFsaXphdGlvbk1vZGUKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKCFwcm9jZXNzZWRXZWxsRGF0YSkgcmV0dXJuOyAvLyBTa2lwIGlmIG5vcm1hbGl6YXRpb24gZmFpbGVkCiAgICAgICAgICB9CiAgICAgICAgICAvLyBBZGQgdG8gZ3JvdXAgKFN0ZXAgMiBoYXBwZW5zIGhlcmUgLSBncm91cGluZykKICAgICAgICAgIC8vIFN0ZXAgMyAoYXZlcmFnaW5nKSB3aWxsIGJlIGFwcGxpZWQgbGF0ZXIKICAgICAgICAgIGdyb3VwZWRTZWxlY3Rpb25zW2dyb3VwS2V5XS53ZWxscy5wdXNoKHsKICAgICAgICAgIHdlbGxJZCwgCiAgICAgICAgICBwbGF0ZUlkLCAKICAgICAgICAgIGRhdGE6IHByb2Nlc3NlZFdlbGxEYXRhCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9KTsKICAKICAvLyBDb250aW51ZSB3aXRoIGdyb3VwZWQgc2VsZWN0aW9ucyAoY29sb3JJZHggYWxyZWFkeSBpbml0aWFsaXplZCBmb3IgU3RlcCAwKQogIC8vIFByb2Nlc3MgZ3JvdXBlZCBzZWxlY3Rpb25zIHdoZW46CiAgLy8gMS4gU3RlcCAwIGlzIG5vdCBzaG93aW5nIChiZWNhdXNlIG90aGVyIHN0ZXBzIGFyZSBlbmFibGVkKSwgT1IKICAvLyAyLiBQcm9jZXNzaW5nIHN0ZXBzIGFyZSBlbmFibGVkICh3aGljaCBhdXRvbWF0aWNhbGx5IGRpc2FibGVzIFN0ZXAgMCkKICAvLyBUaGlzIGVuc3VyZXMgZGF0YSBhbHdheXMgc2hvd3MgLSBlaXRoZXIgU3RlcCAwIGluZGl2aWR1YWwgd2VsbHMgT1IgZ3JvdXBlZCBzZWxlY3Rpb25zCiAgaWYgKCFzaG93SW5kaXZpZHVhbFdlbGxzKSB7CiAgICBPYmplY3Qua2V5cyhncm91cGVkU2VsZWN0aW9ucykuZm9yRWFjaChncm91cEtleSA9PiB7CiAgICAgIGNvbnN0IGdyb3VwID0gZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldOwogICAgICAKICAgICAgLy8gRmlsdGVyIG91dCBhbnkgd2VsbHMgdGhhdCBhcmUgbm8gbG9uZ2VyIHNlbGVjdGVkIG9yIGFyZSBleGNsdWRlZAogICAgICBncm91cC53ZWxscyA9IGdyb3VwLndlbGxzLmZpbHRlcih3ID0+IHsKICAgICAgICBjb25zdCBrZXkgPSBgJHt3LnBsYXRlSWR9OiR7dy53ZWxsSWR9YDsKICAgICAgICAvLyBDaGVjayBpZiBzdGlsbCBzZWxlY3RlZAogICAgICAgIGlmICghc2VsZWN0ZWRXZWxscy5oYXMoa2V5KSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICAvLyBDaGVjayBpZiBleGNsdWRlZCB2aWEgZW5hYmxlZFdlbGxzCiAgICAgICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3LndlbGxJZCkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgICAKICAgICAgLy8gU2tpcCBncm91cHMgd2l0aCBubyB3ZWxscyBhZnRlciBmaWx0ZXJpbmcKICAgICAgaWYgKGdyb3VwLndlbGxzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybjsgLy8gU2tpcCB0byBuZXh0IGdyb3VwCiAgICAgIH0KICAgICAgCiAgICAgIGNvbnN0IGNvbG9yID0gY29sb3JzW2NvbG9ySWR4ICUlIGNvbG9ycy5sZW5ndGhdOwogICAgICBjb2xvcklkeCsrOwoKICAgIGlmIChncm91cC50eXBlID09PSAidHJpcGxpY2F0ZSIgJiYgZ3JvdXAud2VsbHMubGVuZ3RoID4gMCkgewogICAgICAvLyBTVEVQIDM6IEF2ZXJhZ2Ugd2l0aGluIHRyaXBsaWNhdGUgZ3JvdXAKICAgICAgY29uc3QgcmVzdWx0ID0gcHJvY2Vzc1dlbGxzQW5kQ2FsY3VsYXRlTWVhbigKICAgICAgICBncm91cC53ZWxscy5tYXAodyA9PiB3LmRhdGEpLAogICAgICAgIGZhbHNlLCAvLyBObyBub3JtYWxpemF0aW9uCiAgICAgICAgMCwgLy8gYmFzZWxpbmVFbmRUaW1lIG5vdCB1c2VkCiAgICAgICAgOTk5OTk5IC8vIGN1dG9mZlRpbWUgbm90IHVzZWQKICAgICAgKTsKICAgICAgY29uc3QgdGltZVBvaW50cyA9IHJlc3VsdC5maWx0ZXJlZFRpbWVQb2ludHM7CiAgICAgIGNvbnN0IG1lYW5zID0gcmVzdWx0Lm5vcm1hbGl6ZWRNZWFuczsKICAgICAgY29uc3QgZXJyb3JzID0gcmVzdWx0Lm5vcm1hbGl6ZWRFcnJvcnM7CiAgICAgIAogICAgICAvLyBDcmVhdGUgZGF0YXNldCB3aXRoIG1lYW4gYW5kIGVycm9yIGluZm9ybWF0aW9uCiAgICAgIGNvbnN0IGxpbmVEYXRhID0gdGltZVBvaW50cy5tYXAoKHQsIGkpID0+IHsKICAgICAgICBjb25zdCBwb2ludCA9IHsKICAgICAgICAgIHg6IHQsCiAgICAgICAgICB5OiBtZWFuc1tpXSwKICAgICAgICAgIGVycm9yOiBlcnJvcnNbaV0KICAgICAgICB9OwogICAgICAgIHJldHVybiBwb2ludDsKICAgICAgfSkuZmlsdGVyKGQgPT4gZC55ICE9PSBudWxsKTsKICAgICAgCiAgICAgIC8vIEdldCBncm91cCBuYW1lIGZyb20gZmlyc3Qgd2VsbCdzIHBsYXRlCiAgICAgIGNvbnN0IGZpcnN0UGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gZ3JvdXAud2VsbHNbMF0ucGxhdGVJZCk7CiAgICAgIGNvbnN0IGNvbHVtbkdyb3VwTmFtZSA9IGZpcnN0UGxhdGUgPyBmaXJzdFBsYXRlLmNvbHVtbl9ncm91cCA6ICIiOwogICAgICBjb25zdCBkYXRhc2V0Q291bnQgPSBuZXcgU2V0KGdyb3VwLndlbGxzLm1hcCh3ID0+IHcucGxhdGVJZCkpLnNpemU7CiAgICAgIGNvbnN0IHdlbGxDb3VudCA9IGdyb3VwLndlbGxzLmxlbmd0aDsKICAgICAgCiAgICAgIC8vIENyZWF0ZSBhcHByb3ByaWF0ZSBsYWJlbCBiYXNlZCBvbiBudW1iZXIgb2YgcmVwbGljYXRlcwogICAgICBsZXQgcmVwbGljYXRlTGFiZWwgPSAiIjsKICAgICAgaWYgKHdlbGxDb3VudCA9PT0gMykgewogICAgICAgIHJlcGxpY2F0ZUxhYmVsID0gInRyaXBsaWNhdGUiOwogICAgICB9IGVsc2UgaWYgKHdlbGxDb3VudCA9PT0gNikgewogICAgICAgIHJlcGxpY2F0ZUxhYmVsID0gImhleHBsaWNhdGUiOwogICAgICB9IGVsc2UgaWYgKHdlbGxDb3VudCA9PT0gOSkgewogICAgICAgIHJlcGxpY2F0ZUxhYmVsID0gIm5vbnVwbGljYXRlIjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXBsaWNhdGVMYWJlbCA9IGAke3dlbGxDb3VudH0tcGxpY2F0ZWA7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIEdldCBjb2x1bW4gbnVtYmVyIGZyb20gZmlyc3Qgd2VsbAogICAgICBjb25zdCBmaXJzdFdlbGxJZCA9IGdyb3VwLndlbGxzWzBdLndlbGxJZDsKICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZChmaXJzdFdlbGxJZCk7CiAgICAgIAogICAgICAvLyBBZGQgd2VsbCBJRHMgd2hlbiBTdGVwIDEgKG5vcm1hbGl6YXRpb24pIGlzIGVuYWJsZWQKICAgICAgbGV0IHdlbGxJZHNQcmVmaXggPSAiIjsKICAgICAgaWYgKG5vcm1hbGl6ZUJhc2VsaW5lICYmIGdyb3VwLndlbGxzLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCB3ZWxsSWRzID0gZ3JvdXAud2VsbHMubWFwKHcgPT4gdy53ZWxsSWQpLmpvaW4oIiwgIik7CiAgICAgICAgd2VsbElkc1ByZWZpeCA9IGAke3dlbGxJZHN9IC0gYDsKICAgICAgfQogICAgICAKICAgICAgY29uc3QgbGFiZWxTdWZmaXggPSBkYXRhc2V0Q291bnQgPiAxIAogICAgICAgID8gYCAoJHtyZXBsaWNhdGVMYWJlbH0sICR7ZGF0YXNldENvdW50fSBkYXRhc2V0cywgbWVhbiDCsSBTRSlgIAogICAgICAgIDogYCAoJHtyZXBsaWNhdGVMYWJlbH0sIG1lYW4gwrEgU0UpYDsKICAgICAgY29uc3QgZm9ybWF0dGVkTmFtZSA9IGZvcm1hdExhYmVsKGdyb3VwLm5hbWUpOwogICAgICBjb25zdCBsYWJlbCA9IGNvbHVtbkdyb3VwTmFtZSAKICAgICAgICA/IGAke3dlbGxJZHNQcmVmaXh9JHtmb3JtYXR0ZWROYW1lfSAoJHtjb2x1bW5Hcm91cE5hbWV9KSBDb2wgJHtjb2x1bW59JHtsYWJlbFN1ZmZpeH1gCiAgICAgICAgOiBgJHt3ZWxsSWRzUHJlZml4fSR7Zm9ybWF0dGVkTmFtZX0gQ29sICR7Y29sdW1ufSR7bGFiZWxTdWZmaXh9YDsKICAgICAgCiAgICAgIGRhdGFzZXRzLnB1c2goewogICAgICAgIGxhYmVsOiBsYWJlbCwKICAgICAgICBkYXRhOiBsaW5lRGF0YSwKICAgICAgICBib3JkZXJDb2xvcjogY29sb3IsCiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBjb2xvci5yZXBsYWNlKCIxLjAiLCAiMC4yIiksCiAgICAgICAgdGVuc2lvbjogMC4xNSwKICAgICAgICBwb2ludFJhZGl1czogMywKICAgICAgICBib3JkZXJXaWR0aDogMiwKICAgICAgICBmaWxsOiBmYWxzZQogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoZ3JvdXAudHlwZSA9PT0gInNpbmdsZSIpIHsKICAgICAgLy8gU2luZ2xlIHdlbGwgLSBjaGVjayBpZiBpdCdzIGEgZHVwbGljYXRlCiAgICAgIGNvbnN0IHdlbGxJZCA9IGdyb3VwLndlbGxzWzBdLndlbGxJZDsKICAgICAgY29uc3QgaXNEdXBsaWNhdGUgPSBpc0R1cGxpY2F0ZVdlbGwod2VsbElkKTsKICAgICAgCiAgICAgIGlmIChncm91cC53ZWxscy5sZW5ndGggPiAxICYmIGlzRHVwbGljYXRlKSB7CiAgICAgICAgLy8gRHVwbGljYXRlIHdlbGwgLSBzaG93IGVhY2ggZGF0YXNldCBzZXBhcmF0ZWx5IGZvciBjb21wYXJpc29uCiAgICAgICAgY29uc3QgbGluZVN0eWxlcyA9IFsic29saWQiLCAiZGFzaGVkIiwgImRvdHRlZCJdOwogICAgICAgIGNvbnN0IGZvcm1hdHRlZExhYmVsID0gZm9ybWF0TGFiZWwoZ3JvdXAubGFiZWwpOwogICAgICAgIAogICAgICAgIGdyb3VwLndlbGxzLmZvckVhY2goKHdlbGwsIGlkeCkgPT4gewogICAgICAgICAgY29uc3QgcGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gd2VsbC5wbGF0ZUlkKTsKICAgICAgICAgIGNvbnN0IGZpbGVuYW1lID0gcGxhdGUgPyAocGxhdGUuZmlsZSB8fCBwbGF0ZS5pZCkgOiB3ZWxsLnBsYXRlSWQ7CiAgICAgICAgICBjb25zdCBsaW5lU3R5bGUgPSBsaW5lU3R5bGVzW2lkeCAlJSBsaW5lU3R5bGVzLmxlbmd0aF07CiAgICAgICAgICAKICAgICAgICAgIC8vIFVzZSBzbGlnaHRseSBkaWZmZXJlbnQgc2hhZGVzIG9mIHRoZSBzYW1lIGNvbG9yIGZvciBkdXBsaWNhdGVzCiAgICAgICAgICBjb25zdCBiYXNlQ29sb3IgPSBjb2xvcjsKICAgICAgICAgIGNvbnN0IGFscGhhID0gMS4wIC0gKGlkeCAqIDAuMTUpOyAvLyBTbGlnaHRseSBmYWRlIGVhY2ggc3Vic2VxdWVudCBsaW5lCiAgICAgICAgICBjb25zdCBhZGp1c3RlZENvbG9yID0gYmFzZUNvbG9yLnJlcGxhY2UoIjEuMCIsIGFscGhhLnRvRml4ZWQoMSkpOwogICAgICAgICAgCiAgICAgICAgICBsZXQgdGltZVBvaW50cyA9IHdlbGwuZGF0YS50aW1lX3M7CiAgICAgICAgICBsZXQgdmFsdWVzID0gd2VsbC5kYXRhLnZhbHVlczsKICAgICAgICAgIAogICAgICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsLndlbGxJZCk7CiAgICAgICAgICAvLyBBZGQgd2VsbCBJRCB3aGVuIFN0ZXAgMSAobm9ybWFsaXphdGlvbikgaXMgZW5hYmxlZAogICAgICAgICAgY29uc3Qgd2VsbElkUHJlZml4ID0gbm9ybWFsaXplQmFzZWxpbmUgPyBgJHt3ZWxsLndlbGxJZH0gLSBgIDogIiI7CiAgICAgICAgICBkYXRhc2V0cy5wdXNoKHsKICAgICAgICAgICAgbGFiZWw6IGAke3dlbGxJZFByZWZpeH0ke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59ICgke2ZpbGVuYW1lfSlgLAogICAgICAgICAgICBkYXRhOiB0aW1lUG9pbnRzLm1hcCgodCwgaSkgPT4gewogICAgICAgICAgICAgIGNvbnN0IHBvaW50ID0geyB4OiB0LCB5OiB2YWx1ZXNbaV0gfTsKICAgICAgICAgICAgICByZXR1cm4gcG9pbnQ7CiAgICAgICAgICAgIH0pLmZpbHRlcihkID0+IGQueSAhPT0gbnVsbCksCiAgICAgICAgICAgIGJvcmRlckNvbG9yOiBhZGp1c3RlZENvbG9yLAogICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICAgIGJvcmRlckRhc2g6IGxpbmVTdHlsZSA9PT0gImRhc2hlZCIgPyBbNSwgNV0gOiBsaW5lU3R5bGUgPT09ICJkb3R0ZWQiID8gWzIsIDJdIDogW10sCiAgICAgICAgICAgIHRlbnNpb246IDAuMTUsCiAgICAgICAgICAgIHBvaW50UmFkaXVzOiAyLAogICAgICAgICAgICBib3JkZXJXaWR0aDogMS41LAogICAgICAgICAgICBmaWxsOiBmYWxzZSwKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKGdyb3VwLndlbGxzLmxlbmd0aCA+IDEpIHsKICAgICAgICAvLyBTVEVQIDM6IEF2ZXJhZ2UgbXVsdGlwbGUgZGF0YXNldHMgZm9yIHNhbWUgd2VsbCAobm90IGR1cGxpY2F0ZSkgLSBjYWxjdWxhdGUgbWVhbiBhbmQgZXJyb3IKICAgICAgICBjb25zdCByZXN1bHQgPSBwcm9jZXNzV2VsbHNBbmRDYWxjdWxhdGVNZWFuKAogICAgICAgICAgZ3JvdXAud2VsbHMubWFwKHcgPT4gdy5kYXRhKSwKICAgICAgICAgIGZhbHNlLCAvLyBObyBub3JtYWxpemF0aW9uCiAgICAgICAgICAwLCAvLyBiYXNlbGluZUVuZFRpbWUgbm90IHVzZWQKICAgICAgICAgIDk5OTk5OSAvLyBjdXRvZmZUaW1lIG5vdCB1c2VkCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0aW1lUG9pbnRzID0gcmVzdWx0LmZpbHRlcmVkVGltZVBvaW50czsKICAgICAgICBjb25zdCBtZWFucyA9IHJlc3VsdC5ub3JtYWxpemVkTWVhbnM7CiAgICAgICAgY29uc3QgZXJyb3JzID0gcmVzdWx0Lm5vcm1hbGl6ZWRFcnJvcnM7CiAgICAgICAgCiAgICAgICAgY29uc3QgbGluZURhdGEgPSB0aW1lUG9pbnRzLm1hcCgodCwgaSkgPT4gewogICAgICAgICAgY29uc3QgcG9pbnQgPSB7CiAgICAgICAgICAgIHg6IHQsCiAgICAgICAgICAgIHk6IG1lYW5zW2ldLAogICAgICAgICAgICBlcnJvcjogZXJyb3JzW2ldCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHBvaW50OwogICAgICAgIH0pLmZpbHRlcihkID0+IGQueSAhPT0gbnVsbCk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZGF0YXNldENvdW50ID0gZ3JvdXAud2VsbHMubGVuZ3RoOwogICAgICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgICAgICBjb25zdCBmb3JtYXR0ZWRMYWJlbCA9IGZvcm1hdExhYmVsKGdyb3VwLmxhYmVsKTsKICAgICAgICAvLyBBZGQgd2VsbCBJRCB3aGVuIFN0ZXAgMSAobm9ybWFsaXphdGlvbikgaXMgZW5hYmxlZAogICAgICAgIGNvbnN0IHdlbGxJZFByZWZpeCA9IG5vcm1hbGl6ZUJhc2VsaW5lID8gYCR7d2VsbElkfSAtIGAgOiAiIjsKICAgICAgICBjb25zdCBsYWJlbCA9IGAke3dlbGxJZFByZWZpeH0ke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59ICgke2RhdGFzZXRDb3VudH0gZGF0YXNldHMsIG1lYW4gwrEgU0UpYDsKICAgICAgICAKICAgICAgICBkYXRhc2V0cy5wdXNoKHsKICAgICAgICAgIGxhYmVsOiBsYWJlbCwKICAgICAgICAgIGRhdGE6IGxpbmVEYXRhLAogICAgICAgICAgYm9yZGVyQ29sb3I6IGNvbG9yLAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBjb2xvci5yZXBsYWNlKCIxLjAiLCAiMC4yIiksCiAgICAgICAgICB0ZW5zaW9uOiAwLjE1LAogICAgICAgICAgcG9pbnRSYWRpdXM6IDMsCiAgICAgICAgICBib3JkZXJXaWR0aDogMiwKICAgICAgICAgIGZpbGw6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU2luZ2xlIGRhdGFzZXQgZm9yIHRoaXMgd2VsbAogICAgICAgIC8vIFNraXAgc2hvd2luZyBwcm9jZXNzZWQgaW5kaXZpZHVhbCB3ZWxscyBpZiBTdGVwIDAgaXMgYWxyZWFkeSBzaG93aW5nIHRoZSByYXcgZGF0YQogICAgICAgIC8vIEJ1dCBvbmx5IHNraXAgaWYgU3RlcCAwIGlzIGFjdHVhbGx5IGVuYWJsZWQgKG5vdCBqdXN0IHJlcXVlc3RlZCkKICAgICAgICBpZiAoc2hvd0luZGl2aWR1YWxXZWxscyAmJiAhYW55UHJvY2Vzc2luZ1N0ZXBFbmFibGVkKSB7CiAgICAgICAgICAvLyBTdGVwIDAgYWxyZWFkeSBzaG93cyB0aGlzIHdlbGwsIHNraXAgdGhlIHByb2Nlc3NlZCB2ZXJzaW9uIHRvIGF2b2lkIGR1cGxpY2F0ZXMKICAgICAgICAgIHJldHVybjsgLy8gU2tpcCB0byBuZXh0IGdyb3VwIGluIGZvckVhY2gKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgY29uc3Qgd2VsbCA9IGdyb3VwLndlbGxzWzBdOwogICAgICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbC53ZWxsSWQpOwogICAgICAgIGNvbnN0IGZvcm1hdHRlZExhYmVsID0gZm9ybWF0TGFiZWwoZ3JvdXAubGFiZWwpOwogICAgICAgIAogICAgICAgIGxldCB0aW1lUG9pbnRzID0gd2VsbC5kYXRhLnRpbWVfczsKICAgICAgICBsZXQgdmFsdWVzID0gd2VsbC5kYXRhLnZhbHVlczsKICAgICAgICAKICAgICAgICAvLyBBZGQgd2VsbCBJRCB3aGVuIFN0ZXAgMSAobm9ybWFsaXphdGlvbikgaXMgZW5hYmxlZAogICAgICAgIGNvbnN0IHdlbGxJZFByZWZpeCA9IG5vcm1hbGl6ZUJhc2VsaW5lID8gYCR7d2VsbC53ZWxsSWR9IC0gYCA6ICIiOwogICAgICAgIGNvbnN0IGxhYmVsID0gZm9ybWF0dGVkTGFiZWwgCiAgICAgICAgICA/IGAke3dlbGxJZFByZWZpeH0ke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59YCAKICAgICAgICAgIDogYCR7d2VsbElkUHJlZml4fVdlbGwgJHt3ZWxsLndlbGxJZH0gQ29sICR7Y29sdW1ufWA7CiAgICAgICAgCiAgICAgICAgZGF0YXNldHMucHVzaCh7CiAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICBkYXRhOiB0aW1lUG9pbnRzLm1hcCgodCwgaSkgPT4gewogICAgICAgICAgICBjb25zdCBwb2ludCA9IHsgeDogdCwgeTogdmFsdWVzW2ldIH07CiAgICAgICAgICAgIHJldHVybiBwb2ludDsKICAgICAgICAgIH0pLmZpbHRlcihkID0+IGQueSAhPT0gbnVsbCksCiAgICAgICAgICBib3JkZXJDb2xvcjogY29sb3IsCiAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICB0ZW5zaW9uOiAwLjE1LAogICAgICAgICAgcG9pbnRSYWRpdXM6IDIsCiAgICAgICAgICBib3JkZXJXaWR0aDogMS41LAogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICB9KTsKICB9CgogIC8vIFNURVAgMzogQXBwbHkgY3V0b2ZmIGZpbHRlcmluZyB0byBhbGwgZGF0YXNldHMKICBsZXQgeEF4aXNNaW4gPSB1bmRlZmluZWQ7CiAgbGV0IHhBeGlzTWF4ID0gdW5kZWZpbmVkOwogIAogIGlmIChjdXRvZmZCYXNlbGluZSkgewogICAgZGF0YXNldHMuZm9yRWFjaChkYXRhc2V0ID0+IHsKICAgICAgaWYgKGRhdGFzZXQuZGF0YSAmJiBkYXRhc2V0LmRhdGEubGVuZ3RoID4gMCkgewogICAgICAgIC8vIEZpbmQgZmlyc3QgcmVhbCB0aW1lcG9pbnQgKGZpcnN0IG5vbi1udWxsIHRpbWUpCiAgICAgICAgbGV0IGZpcnN0VGltZXBvaW50ID0gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGFzZXQuZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGRhdGFzZXQuZGF0YVtpXS54ICE9PSBudWxsICYmIGlzRmluaXRlKGRhdGFzZXQuZGF0YVtpXS54KSkgewogICAgICAgICAgICBmaXJzdFRpbWVwb2ludCA9IGRhdGFzZXQuZGF0YVtpXS54OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gRGV0ZXJtaW5lIG1pbmltdW0gdGltZSB0byBpbmNsdWRlCiAgICAgICAgLy8gSWYgbm9ybWFsaXphdGlvbiBpcyBlbmFibGVkLCBleGNsdWRlIGJhc2VsaW5lIHBlcmlvZCAocG9pbnRzIGJlZm9yZSBiYXNlbGluZUVuZFRpbWUpCiAgICAgICAgLy8gT3RoZXJ3aXNlLCBleGNsdWRlIHBvaW50cyBiZWZvcmUgZmlyc3QgcmVhbCB0aW1lcG9pbnQKICAgICAgICBjb25zdCBtaW5UaW1lID0gbm9ybWFsaXplQmFzZWxpbmUgPyBub3JtYWxpemVCYXNlbGluZUVuZFRpbWUgOiAoZmlyc3RUaW1lcG9pbnQgIT09IG51bGwgPyBmaXJzdFRpbWVwb2ludCA6IC1JbmZpbml0eSk7CiAgICAgICAgCiAgICAgICAgLy8gRmlsdGVyIGRhdGEgcG9pbnRzOiBleGNsdWRlIGJlZm9yZSBtaW5UaW1lIGFuZCBhZnRlciBjdXRvZmYgdGltZQogICAgICAgIGRhdGFzZXQuZGF0YSA9IGRhdGFzZXQuZGF0YS5maWx0ZXIocG9pbnQgPT4gewogICAgICAgICAgaWYgKHBvaW50LnggPT09IG51bGwgfHwgIWlzRmluaXRlKHBvaW50LngpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICBpZiAocG9pbnQueCA8IG1pblRpbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgIGlmIChwb2ludC54ID4gY3V0b2ZmQmFzZWxpbmVUaW1lKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICAvLyBUcmFjayBtaW4vbWF4IHggdmFsdWVzIGZvciBheGlzIGFkanVzdG1lbnQKICAgICAgICBpZiAoZGF0YXNldC5kYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IHRpbWVzID0gZGF0YXNldC5kYXRhLm1hcChwID0+IHAueCkuZmlsdGVyKHQgPT4gdCAhPT0gbnVsbCAmJiBpc0Zpbml0ZSh0KSk7CiAgICAgICAgICBpZiAodGltZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBkYXRhc2V0TWluID0gTWF0aC5taW4oLi4udGltZXMpOwogICAgICAgICAgICBjb25zdCBkYXRhc2V0TWF4ID0gTWF0aC5tYXgoLi4udGltZXMpOwogICAgICAgICAgICBpZiAoeEF4aXNNaW4gPT09IHVuZGVmaW5lZCB8fCBkYXRhc2V0TWluIDwgeEF4aXNNaW4pIHsKICAgICAgICAgICAgICB4QXhpc01pbiA9IGRhdGFzZXRNaW47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHhBeGlzTWF4ID09PSB1bmRlZmluZWQgfHwgZGF0YXNldE1heCA+IHhBeGlzTWF4KSB7CiAgICAgICAgICAgICAgeEF4aXNNYXggPSBkYXRhc2V0TWF4OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9IGVsc2UgewogICAgLy8gRXZlbiBpZiBjdXRvZmYgaXMgZGlzYWJsZWQsIGNhbGN1bGF0ZSB4LWF4aXMgcmFuZ2UgZnJvbSBhbGwgZGF0YXNldHMgZm9yIHByb3BlciBkaXNwbGF5CiAgICBkYXRhc2V0cy5mb3JFYWNoKGRhdGFzZXQgPT4gewogICAgICBpZiAoZGF0YXNldC5kYXRhICYmIGRhdGFzZXQuZGF0YS5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3QgdGltZXMgPSBkYXRhc2V0LmRhdGEubWFwKHAgPT4gcC54KS5maWx0ZXIodCA9PiB0ICE9PSBudWxsICYmIGlzRmluaXRlKHQpKTsKICAgICAgICBpZiAodGltZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgY29uc3QgZGF0YXNldE1pbiA9IE1hdGgubWluKC4uLnRpbWVzKTsKICAgICAgICAgIGNvbnN0IGRhdGFzZXRNYXggPSBNYXRoLm1heCguLi50aW1lcyk7CiAgICAgICAgICBpZiAoeEF4aXNNaW4gPT09IHVuZGVmaW5lZCB8fCBkYXRhc2V0TWluIDwgeEF4aXNNaW4pIHsKICAgICAgICAgICAgeEF4aXNNaW4gPSBkYXRhc2V0TWluOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHhBeGlzTWF4ID09PSB1bmRlZmluZWQgfHwgZGF0YXNldE1heCA+IHhBeGlzTWF4KSB7CiAgICAgICAgICAgIHhBeGlzTWF4ID0gZGF0YXNldE1heDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICAKICAvLyBTVEVQIDQ6IEFkZCByZWdyZXNzaW9uIGN1cnZlcyB0byBkYXRhc2V0cwogIGlmIChmaXRSZWdyZXNzaW9uKSB7CiAgICBjb25zdCByZWdyZXNzaW9uRGF0YXNldHMgPSBbXTsKICAgIGNvbnN0IG1vbm9FeHBQYXJhbXMgPSBbXTsgLy8gU3RvcmUgcGFyYW1ldGVycyBmb3IgbW9uby1leHBvbmVudGlhbCBmaXRzCiAgICAKICAgIGRhdGFzZXRzLmZvckVhY2goZGF0YXNldCA9PiB7CiAgICAgIGlmIChkYXRhc2V0LmRhdGEgJiYgZGF0YXNldC5kYXRhLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBkYXRhc2V0IHJlcHJlc2VudHMgYSBjb250cm9sIHdlbGwKICAgICAgICAvLyBFeHRyYWN0IHdlbGxJZCBmcm9tIGxhYmVsIChmb3JtYXQ6ICJOMSAtIExhYmVsIiBvciAiTjEgLSBMYWJlbCBDb250cm9sIENvbCAxIikKICAgICAgICBsZXQgaXNDb250cm9sID0gZmFsc2U7CiAgICAgICAgY29uc3QgbGFiZWwgPSBkYXRhc2V0LmxhYmVsIHx8ICIiOwogICAgICAgIAogICAgICAgIC8vIE1ldGhvZCAxOiBDaGVjayBpZiBsYWJlbCBjb250YWlucyAiQ29udHJvbCIgKGNhc2UtaW5zZW5zaXRpdmUpCiAgICAgICAgaWYgKGxhYmVsLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoImNvbnRyb2wiKSkgewogICAgICAgICAgaXNDb250cm9sID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gTWV0aG9kIDI6IFRyeSB0byBleHRyYWN0IHdlbGxJZCBmcm9tIGxhYmVsIGFuZCBjaGVjawogICAgICAgICAgLy8gTGFiZWwgZm9ybWF0IGlzIHR5cGljYWxseTogIk4xIC0gTGFiZWwgQ29sIDEiIG9yICJOMSAtIExhYmVsIgogICAgICAgICAgY29uc3Qgd2VsbElkTWF0Y2ggPSBsYWJlbC5tYXRjaCgvXihbQS1aXVxkKylccyotLyk7CiAgICAgICAgICBpZiAod2VsbElkTWF0Y2gpIHsKICAgICAgICAgICAgY29uc3Qgd2VsbElkID0gd2VsbElkTWF0Y2hbMV07CiAgICAgICAgICAgIGlzQ29udHJvbCA9IGlzQ29udHJvbFdlbGwod2VsbElkKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gVXNlIGxpbmVhciByZWdyZXNzaW9uIGZvciBjb250cm9scywgb3RoZXJ3aXNlIHVzZSBzZWxlY3RlZCByZWdyZXNzaW9uIHR5cGUKICAgICAgICBjb25zdCByZWdyZXNzaW9uVHlwZVRvVXNlID0gaXNDb250cm9sID8gJ2xpbmVhcicgOiByZWdyZXNzaW9uVHlwZTsKICAgICAgICAKICAgICAgICAvLyBGaXQgcmVncmVzc2lvbiBjdXJ2ZQogICAgICAgIGNvbnN0IGZpdEZ1bmN0aW9uID0gZml0UmVncmVzc2lvbkN1cnZlKGRhdGFzZXQuZGF0YSwgcmVncmVzc2lvblR5cGVUb1VzZSwgcG9seW5vbWlhbE9yZGVyKTsKICAgICAgICBpZiAoZml0RnVuY3Rpb24pIHsKICAgICAgICAgIC8vIEdldCB0aW1lIHJhbmdlIGZyb20gZGF0YQogICAgICAgICAgY29uc3QgdGltZXMgPSBkYXRhc2V0LmRhdGEubWFwKHAgPT4gcC54KS5maWx0ZXIodCA9PiB0ICE9PSBudWxsICYmIGlzRmluaXRlKHQpKTsKICAgICAgICAgIGlmICh0aW1lcy5sZW5ndGggPT09IDApIHJldHVybjsKICAgICAgICAgIAogICAgICAgICAgY29uc3QgbWluVGltZSA9IE1hdGgubWluKC4uLnRpbWVzKTsKICAgICAgICAgIGNvbnN0IG1heFRpbWUgPSBNYXRoLm1heCguLi50aW1lcyk7CiAgICAgICAgICAKICAgICAgICAgIC8vIEdlbmVyYXRlIHJlZ3Jlc3Npb24gY3VydmUgcG9pbnRzCiAgICAgICAgICBjb25zdCBudW1Qb2ludHMgPSAxMDA7CiAgICAgICAgICBjb25zdCByZWdyZXNzaW9uRGF0YSA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gbnVtUG9pbnRzOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdCA9IG1pblRpbWUgKyAobWF4VGltZSAtIG1pblRpbWUpICogKGkgLyBudW1Qb2ludHMpOwogICAgICAgICAgICBjb25zdCB5ID0gZml0RnVuY3Rpb24odCk7CiAgICAgICAgICAgIGlmICh5ICE9PSBudWxsICYmIGlzRmluaXRlKHkpKSB7CiAgICAgICAgICAgICAgcmVncmVzc2lvbkRhdGEucHVzaCh7IHg6IHQsIHk6IHkgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIAogICAgICAgICAgaWYgKHJlZ3Jlc3Npb25EYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIHJlZ3Jlc3Npb24gZGF0YXNldCB3aXRoIHNhbWUgY29sb3IgYnV0IGRpZmZlcmVudCBzdHlsZQogICAgICAgICAgICBjb25zdCByZWdyZXNzaW9uQ29sb3IgPSBkYXRhc2V0LmJvcmRlckNvbG9yIHx8IGRhdGFzZXQuYmFja2dyb3VuZENvbG9yIHx8ICJyZ2JhKDEyOCwgMTI4LCAxMjgsIDEuMCkiOwogICAgICAgICAgICByZWdyZXNzaW9uRGF0YXNldHMucHVzaCh7CiAgICAgICAgICAgICAgbGFiZWw6IGAke2RhdGFzZXQubGFiZWx9ICgke3JlZ3Jlc3Npb25UeXBlVG9Vc2V9IGZpdClgLAogICAgICAgICAgICAgIGRhdGE6IHJlZ3Jlc3Npb25EYXRhLAogICAgICAgICAgICAgIGJvcmRlckNvbG9yOiByZWdyZXNzaW9uQ29sb3IsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgIGJvcmRlcldpZHRoOiAyLAogICAgICAgICAgICAgIGJvcmRlckRhc2g6IFs1LCA1XSwgLy8gRGFzaGVkIGxpbmUgZm9yIHJlZ3Jlc3Npb24KICAgICAgICAgICAgICBwb2ludFJhZGl1czogMCwgLy8gTm8gcG9pbnRzIG9uIHJlZ3Jlc3Npb24gbGluZQogICAgICAgICAgICAgIHRlbnNpb246IDAsCiAgICAgICAgICAgICAgZmlsbDogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdG9yZSBtb25vLWV4cG9uZW50aWFsIHBhcmFtZXRlcnMgZm9yIGluZm8gcGFuZWwKICAgICAgICAgICAgLy8gT25seSBzdG9yZSBpZiB1c2luZyBtb25vLWV4cG9uZW50aWFsIChub3QgZm9yIGNvbnRyb2xzIHdoaWNoIHVzZSBsaW5lYXIpCiAgICAgICAgICAgIGlmIChyZWdyZXNzaW9uVHlwZVRvVXNlID09PSAnbW9uby1leHBvbmVudGlhbCcgJiYgZml0RnVuY3Rpb24ucGFyYW1zKSB7CiAgICAgICAgICAgICAgLy8gUmVtb3ZlIHJlcGxpY2F0ZSBhbmQgZGF0YXNldCBpbmZvIGZyb20gbGFiZWwgZm9yIHJlZ3Jlc3Npb24gbGluZXMKICAgICAgICAgICAgICAvLyBQYXR0ZXJuOiByZW1vdmUgIihYLXBsaWNhdGUsIFkgZGF0YXNldHMsIG1lYW4gwrEgU0UpIiBvciBzaW1pbGFyIHBhdHRlcm5zCiAgICAgICAgICAgICAgbGV0IGNsZWFuTGFiZWwgPSBkYXRhc2V0LmxhYmVsOwogICAgICAgICAgICAgIC8vIFJlbW92ZSBwYXR0ZXJucyBjb250YWluaW5nIHBsaWNhdGUsIGRhdGFzZXRzLCBvciBtZWFuIMKxIFNFIGluIHBhcmVudGhlc2VzCiAgICAgICAgICAgICAgY2xlYW5MYWJlbCA9IGNsZWFuTGFiZWwucmVwbGFjZSgvXHMqXChbXildKig/OnBsaWNhdGV8ZGF0YXNldHN8bWVhblxzKsKxXHMqU0UpW14pXSpcKS9naSwgJycpOwogICAgICAgICAgICAgIC8vIENsZWFuIHVwIGFueSBkb3VibGUgc3BhY2VzIG9yIHRyYWlsaW5nL2xlYWRpbmcgc3BhY2VzCiAgICAgICAgICAgICAgY2xlYW5MYWJlbCA9IGNsZWFuTGFiZWwucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgIG1vbm9FeHBQYXJhbXMucHVzaCh7CiAgICAgICAgICAgICAgICBsYWJlbDogY2xlYW5MYWJlbCwKICAgICAgICAgICAgICAgIHBhcmFtczogZml0RnVuY3Rpb24ucGFyYW1zLAogICAgICAgICAgICAgICAgY29sb3I6IHJlZ3Jlc3Npb25Db2xvciAvLyBVc2UgdGhlIHNhbWUgY29sb3IgYXMgdGhlIHJlZ3Jlc3Npb24gY3VydmUKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICAKICAgIC8vIEFkZCByZWdyZXNzaW9uIGRhdGFzZXRzIHRvIHRoZSBtYWluIGRhdGFzZXRzIGFycmF5CiAgICBkYXRhc2V0cy5wdXNoKC4uLnJlZ3Jlc3Npb25EYXRhc2V0cyk7CiAgICAKICAgIC8vIFVwZGF0ZSBpbmZvIHBhbmVsIGZvciBtb25vLWV4cG9uZW50aWFsCiAgICBpZiAocmVncmVzc2lvblR5cGUgPT09ICdtb25vLWV4cG9uZW50aWFsJykgewogICAgICB1cGRhdGVNb25vRXhwb25lbnRpYWxJbmZvUGFuZWwobW9ub0V4cFBhcmFtcyk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBpbmZvUGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi1pbmZvLXBhbmVsIik7CiAgICAgIGlmIChpbmZvUGFuZWwpIHsKICAgICAgICBpbmZvUGFuZWwuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgfQogICAgfQogICAgCiAgICAvLyBSZWNhbGN1bGF0ZSB4LWF4aXMgcmFuZ2UgdG8gaW5jbHVkZSByZWdyZXNzaW9uIGN1cnZlcwogICAgaWYgKGN1dG9mZkJhc2VsaW5lKSB7CiAgICAgIGRhdGFzZXRzLmZvckVhY2goZGF0YXNldCA9PiB7CiAgICAgICAgaWYgKGRhdGFzZXQuZGF0YSAmJiBkYXRhc2V0LmRhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgY29uc3QgdGltZXMgPSBkYXRhc2V0LmRhdGEubWFwKHAgPT4gcC54KS5maWx0ZXIodCA9PiB0ICE9PSBudWxsICYmIGlzRmluaXRlKHQpKTsKICAgICAgICAgIGlmICh0aW1lcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGFzZXRNaW4gPSBNYXRoLm1pbiguLi50aW1lcyk7CiAgICAgICAgICAgIGNvbnN0IGRhdGFzZXRNYXggPSBNYXRoLm1heCguLi50aW1lcyk7CiAgICAgICAgICAgIGlmICh4QXhpc01pbiA9PT0gdW5kZWZpbmVkIHx8IGRhdGFzZXRNaW4gPCB4QXhpc01pbikgewogICAgICAgICAgICAgIHhBeGlzTWluID0gZGF0YXNldE1pbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoeEF4aXNNYXggPT09IHVuZGVmaW5lZCB8fCBkYXRhc2V0TWF4ID4geEF4aXNNYXgpIHsKICAgICAgICAgICAgICB4QXhpc01heCA9IGRhdGFzZXRNYXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KCiAgLy8gRGV0ZXJtaW5lIHktYXhpcyBsYWJlbCBiYXNlZCBvbiBwcm9jZXNzaW5nIHN0ZXBzCiAgbGV0IHlBeGlzTGFiZWwgPSAiRmx1b3Jlc2NlbmNlIChGSSkiOwogIGlmIChub3JtYWxpemVCYXNlbGluZSkgewogICAgaWYgKG5vcm1hbGl6YXRpb25Nb2RlID09PSAnZGVsdGFfZl9vdmVyX2YnKSB7CiAgICAgIHlBeGlzTGFiZWwgPSAizpRGL0YgKE5vcm1hbGl6ZWQpIjsKICAgIH0gZWxzZSB7CiAgICAgIHlBeGlzTGFiZWwgPSAiRi9G4oKAIChOb3JtYWxpemVkKSI7CiAgICB9CiAgfQoKICAvLyBUcmFuc2Zvcm0gZXhpc3RpbmcgY2hhcnQgaW5zdGVhZCBvZiByZWNyZWF0aW5nCiAgaWYgKGNoYXJ0KSB7CiAgICAvLyBDbGVhciBleGlzdGluZyBkYXRhc2V0cwogICAgd2hpbGUgKGNoYXJ0LmRhdGEuZGF0YXNldHMubGVuZ3RoID4gMCkgewogICAgICBjaGFydC5kYXRhLmRhdGFzZXRzLnBvcCgpOwogICAgfQogICAgCiAgICAvLyBBZGQgbmV3IGRhdGFzZXRzCiAgICBkYXRhc2V0cy5mb3JFYWNoKGRhdGFzZXQgPT4gewogICAgICBjaGFydC5kYXRhLmRhdGFzZXRzLnB1c2goZGF0YXNldCk7CiAgICB9KTsKICAgIAogICAgLy8gVXBkYXRlIGNoYXJ0IG9wdGlvbnMKICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLngudGl0bGUudGV4dCA9ICJUaW1lIChzKSI7CiAgICBjaGFydC5vcHRpb25zLnNjYWxlcy55LnRpdGxlLnRleHQgPSB5QXhpc0xhYmVsOwogICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueS5taW4gPSB1bmRlZmluZWQ7CiAgICAKICAgIC8vIEFkanVzdCB4LWF4aXMgcmFuZ2UgYmFzZWQgb24gZmlsdGVyZWQgZGF0YSAoU3RlcCAzKQogICAgaWYgKGN1dG9mZkJhc2VsaW5lICYmIHhBeGlzTWluICE9PSB1bmRlZmluZWQgJiYgeEF4aXNNYXggIT09IHVuZGVmaW5lZCkgewogICAgICAvLyBBZGQgc21hbGwgcGFkZGluZyAoMiUlIG9mIHJhbmdlKSBmb3IgYmV0dGVyIHZpc3VhbGl6YXRpb24KICAgICAgY29uc3QgcGFkZGluZyA9ICh4QXhpc01heCAtIHhBeGlzTWluKSAqIDAuMDI7CiAgICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLngubWluID0gTWF0aC5tYXgoMCwgeEF4aXNNaW4gLSBwYWRkaW5nKTsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueC5tYXggPSB4QXhpc01heCArIHBhZGRpbmc7CiAgICB9IGVsc2UgewogICAgICAvLyBSZXNldCB0byBhdXRvIGlmIGN1dG9mZiBpcyBkaXNhYmxlZAogICAgICBjaGFydC5vcHRpb25zLnNjYWxlcy54Lm1pbiA9IHVuZGVmaW5lZDsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueC5tYXggPSB1bmRlZmluZWQ7CiAgICB9CiAgICAKICAgIC8vIENvdW50IG9ubHkgd2VsbHMgdGhhdCBhcmUgYWN0dWFsbHkgZGlzcGxheWVkIChhY2NvdW50aW5nIGZvciBleGNsdXNpb25zKQogICAgLy8gQ291bnQgdW5pcXVlIHdlbGwgZ3JvdXBzL2RhdGFzZXRzIHRoYXQgYXJlIGFjdHVhbGx5IGRpc3BsYXllZAogICAgY29uc3QgZGlzcGxheWVkV2VsbENvdW50ID0gZGF0YXNldHMubGVuZ3RoOwogICAgY2hhcnQub3B0aW9ucy5wbHVnaW5zLnRpdGxlLnRleHQgPSBgVGltZSBDb3Vyc2UgLSAke2Rpc3BsYXllZFdlbGxDb3VudH0gd2VsbChzKSBzZWxlY3RlZGA7CiAgICBjaGFydC5vcHRpb25zLnBsdWdpbnMubGVnZW5kLmRpc3BsYXkgPSBkYXRhc2V0cy5sZW5ndGggPiAwOwogICAgCiAgICAvLyBGb3JjZSBDaGFydC5qcyB0byB1cGRhdGUgLSB1c2UgdXBkYXRlKCkgd2l0aG91dCBtb2RlIHRvIGVuc3VyZSBwcm9wZXIgcmVkcmF3CiAgICBjaGFydC51cGRhdGUoKTsKICB9IGVsc2UgewogICAgLy8gQ3JlYXRlIG5ldyBjaGFydCBvbmx5IGlmIGl0IGRvZXNuJ3QgZXhpc3QKICAgIGNoYXJ0ID0gbmV3IENoYXJ0KGN0eCwgewogICAgICB0eXBlOiAibGluZSIsCiAgICAgIGRhdGE6IHsKICAgICAgICBkYXRhc2V0czogZGF0YXNldHMKICAgICAgfSwKICAgICAgb3B0aW9uczogewogICAgICAgIHJlc3BvbnNpdmU6IHRydWUsCiAgICAgICAgbWFpbnRhaW5Bc3BlY3RSYXRpbzogZmFsc2UsCiAgICAgICAgcGFyc2luZzogZmFsc2UsCiAgICAgICAgc2NhbGVzOiB7CiAgICAgICAgICAgIHg6IHsgCiAgICAgICAgICAgICAgdHlwZTogImxpbmVhciIsIAogICAgICAgICAgICAgIHRpdGxlOiB7IAogICAgICAgICAgICAgICAgZGlzcGxheTogdHJ1ZSwKICAgICAgICAgICAgICAgIHRleHQ6ICJUaW1lIChzKSIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG1pbjogY3V0b2ZmQmFzZWxpbmUgJiYgeEF4aXNNaW4gIT09IHVuZGVmaW5lZCA/IE1hdGgubWF4KDAsIHhBeGlzTWluIC0gKHhBeGlzTWF4IC0geEF4aXNNaW4pICogMC4wMikgOiB1bmRlZmluZWQsCiAgICAgICAgICAgICAgbWF4OiBjdXRvZmZCYXNlbGluZSAmJiB4QXhpc01heCAhPT0gdW5kZWZpbmVkID8geEF4aXNNYXggKyAoeEF4aXNNYXggLSB4QXhpc01pbikgKiAwLjAyIDogdW5kZWZpbmVkCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHk6IHsgCiAgICAgICAgICAgICAgdGl0bGU6IHsgCiAgICAgICAgICAgICAgICBkaXNwbGF5OiB0cnVlLAogICAgICAgICAgICAgICAgdGV4dDogeUF4aXNMYWJlbAogICAgICAgICAgICB9LAogICAgICAgICAgICBtaW46IHVuZGVmaW5lZAogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcGx1Z2luczogewogICAgICAgICAgbGVnZW5kOiB7CiAgICAgICAgICAgIGRpc3BsYXk6IGRhdGFzZXRzLmxlbmd0aCA+IDAsIC8vIFNob3cgbGVnZW5kIHdoZW4gdGhlcmUgYXJlIGRhdGFzZXRzCiAgICAgICAgICAgIHBvc2l0aW9uOiAidG9wIiwKICAgICAgICAgICAgb25DbGljazogbnVsbCwKICAgICAgICAgICAgbGFiZWxzOiB7CiAgICAgICAgICAgICAgdXNlUG9pbnRTdHlsZTogdHJ1ZSwKICAgICAgICAgICAgICBwYWRkaW5nOiAxNSwKICAgICAgICAgICAgICBmb250OiB7CiAgICAgICAgICAgICAgICBzaXplOiAxMQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZ2VuZXJhdGVMYWJlbHM6IGZ1bmN0aW9uKGNoYXJ0KSB7CiAgICAgICAgICAgICAgICAvLyBDdXN0b20gbGFiZWwgZ2VuZXJhdGlvbiB0byBzaG93IGNvbG9yIGFuZCB3ZWxsIG5hbWUgY2xlYXJseQogICAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWwgPSBDaGFydC5kZWZhdWx0cy5wbHVnaW5zLmxlZ2VuZC5sYWJlbHMuZ2VuZXJhdGVMYWJlbHM7CiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbHMgPSBvcmlnaW5hbC5jYWxsKHRoaXMsIGNoYXJ0KTsKICAgICAgICAgICAgICAgIC8vIExhYmVscyBhbHJlYWR5IGhhdmUgdGhlIGNvcnJlY3QgdGV4dCBmcm9tIGRhdGFzZXQubGFiZWwKICAgICAgICAgICAgICAgIHJldHVybiBsYWJlbHM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgdGl0bGU6IHsKICAgICAgICAgICAgZGlzcGxheTogdHJ1ZSwKICAgICAgICAgICAgdGV4dDogYFRpbWUgQ291cnNlIC0gJHtkYXRhc2V0cy5sZW5ndGh9IHdlbGwocykgc2VsZWN0ZWRgCiAgICAgICAgICB9LAogICAgICAgICAgdG9vbHRpcDogewogICAgICAgICAgICBjYWxsYmFja3M6IHsKICAgICAgICAgICAgICBsYWJlbDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgICAgbGV0IGxhYmVsID0gY29udGV4dC5kYXRhc2V0LmxhYmVsIHx8ICIiOwogICAgICAgICAgICAgICAgaWYgKGxhYmVsKSB7CiAgICAgICAgICAgICAgICAgIGxhYmVsICs9ICI6ICI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY29udGV4dC5wYXJzZWQueSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsYWJlbCArPSBjb250ZXh0LnBhcnNlZC55LnRvRml4ZWQoMik7CiAgICAgICAgICAgICAgICAgIC8vIFNob3cgZXJyb3IgaWYgYXZhaWxhYmxlCiAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0LnJhdyAmJiBjb250ZXh0LnJhdy5lcnJvciAhPT0gdW5kZWZpbmVkICYmIGNvbnRleHQucmF3LmVycm9yICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbGFiZWwgKz0gIiDCsSAiICsgY29udGV4dC5yYXcuZXJyb3IudG9GaXhlZCgyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGxhYmVsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQp9CgovLyBJbml0aWFsaXplIHNldHRpbmdzIGRpc3BsYXkgb24gcGFnZSBsb2FkCnVwZGF0ZUN1cnJlbnRTZXR0aW5nc0Rpc3BsYXkoKTsKLy8gSW5pdGlhbGl6ZSBiYXNlbGluZSBtZXRob2QgcGFyYW1zIHRvIHNob3cvaGlkZSBMT1dFU1MvcG9seW5vbWlhbCBwYXJhbWV0ZXJzIGJhc2VkIG9uIGRlZmF1bHQgc2VsZWN0aW9uCnVwZGF0ZUJhc2VsaW5lTWV0aG9kUGFyYW1zKCk7Ci8vIEluaXRpYWxpemUgcmVncmVzc2lvbiB0eXBlIHBhcmFtcyB0byBzaG93L2hpZGUgaW5mbyBwYW5lbCBiYXNlZCBvbiBkZWZhdWx0IHNlbGVjdGlvbgovLyBTa2lwIGNoYXJ0IHVwZGF0ZSBkdXJpbmcgaW5pdGlhbGl6YXRpb24KdXBkYXRlUmVncmVzc2lvblR5cGVQYXJhbXModHJ1ZSk7Cgpsb2FkRGF0YSgpLmNhdGNoKGVyciA9PiB7CiAgY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIGxvYWQgdmlld2VyX2RhdGEuanNvbjoiLCBlcnIpOwogIGFsZXJ0KCJDb3VsZCBub3QgbG9hZCB2aWV3ZXJfZGF0YS5qc29uLiBEaWQgeW91IHJ1biB0aGUgUHl0aG9uIHNjcmlwdCBpbiB0aGUgc2FtZSBmb2xkZXI/Iik7Cn0pOwo8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+CiIiIgoKCmRlZiB3cml0ZV9odG1sKGh0bWxfcGF0aDogc3RyKToKICAgIGh0bWwgPSBIVE1MX1RFTVBMQVRFICUgewogICAgICAgICJyb3dzIjogUExBVEVfUk9XUywKICAgICAgICAiY29scyI6IFBMQVRFX0NPTFMsCiAgICB9CiAgICB3aXRoIG9wZW4oaHRtbF9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZi53cml0ZShodG1sKQoKCmRlZiB3cml0ZV93ZWJfY29tbWFuZChzY3JpcHRfZGlyOiBzdHIsIHdlYl9kaXI6IHN0cik6CiAgICAiIiIKICAgIENyZWF0ZSBkb3VibGUtY2xpY2thYmxlIGxhdW5jaGVyIGZpbGVzIGZvciB3ZWIgc2VydmVyOgogICAgLSAnd2ViLmNvbW1hbmQnIGZvciBtYWNPUy9MaW51eCAoZG91YmxlLWNsaWNrYWJsZSBpbiBGaW5kZXIpCiAgICAtICd3ZWIuYmF0JyBmb3IgV2luZG93cyAoZG91YmxlLWNsaWNrYWJsZSBpbiBFeHBsb3JlcikKICAgICIiIgogICAgd2ViX2NvbW1hbmRfcGF0aCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAid2ViLmNvbW1hbmQiKQogICAgCiAgICB3ZWJfY29tbWFuZF9jb250ZW50ID0gZiIiIiMhL2Jpbi9iYXNoCiMgRG91YmxlLWNsaWNrYWJsZSB3ZWIgc2VydmVyIGxhdW5jaGVyIGZvciBQbGF0ZSBWaWV3ZXIKIyBUaGlzIGZpbGUgaXMgYXV0by1nZW5lcmF0ZWQgYnkgcGxhdGVfdmlld2VyLnB5CgpQT1JUPTgwMDAKIyBHZXQgdGhlIGRpcmVjdG9yeSB3aGVyZSB0aGlzIHNjcmlwdCBpcyBsb2NhdGVkClNDUklQVF9ESVI9IiQoY2QgIiQoZGlybmFtZSAiJDAiKSIgJiYgcHdkKSIKV0VCX0RJUj0iJFNDUklQVF9ESVIvd2ViIgoKIyBDaGFuZ2UgdG8gd2ViIGRpcmVjdG9yeQpjZCAiJFdFQl9ESVIiIHx8IHt7CiAgICBlY2hvICJFcnJvcjogQ291bGQgbm90IGZpbmQgd2ViIGRpcmVjdG9yeTogJFdFQl9ESVIiCiAgICBlY2hvICJQbGVhc2UgcnVuIHBsYXRlX3ZpZXdlci5weSBmaXJzdCB0byBnZW5lcmF0ZSB0aGUgd2ViIGZpbGVzLiIKICAgIHJlYWQgLXAgIlByZXNzIEVudGVyIHRvIGV4aXQuLi4iCiAgICBleGl0IDEKfX0KCiMgQ2hlY2sgaWYgdmlld2VyX2RhdGEuanNvbiBleGlzdHMKaWYgWyAhIC1mICJ2aWV3ZXJfZGF0YS5qc29uIiBdOyB0aGVuCiAgICBlY2hvICJXYXJuaW5nOiB2aWV3ZXJfZGF0YS5qc29uIG5vdCBmb3VuZCEiCiAgICBlY2hvICJQbGVhc2UgcnVuIHBsYXRlX3ZpZXdlci5weSBmaXJzdCB0byBnZW5lcmF0ZSB0aGUgZGF0YSBmaWxlcy4iCiAgICBlY2hvICIiCmZpCgpVUkw9Imh0dHA6Ly9sb2NhbGhvc3Q6JHt7UE9SVH19L2luZGV4Lmh0bWwiCgplY2hvICI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iCmVjaG8gIlBsYXRlIFZpZXdlciBXZWIgU2VydmVyIgplY2hvICI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iCmVjaG8gIlNlcnZlciBydW5uaW5nIGF0OiAkVVJMIgplY2hvICJTZXJ2aW5nIGRpcmVjdG9yeTogJFdFQl9ESVIiCmVjaG8gIiIKZWNobyAiUHJlc3MgQ3RybCtDIHRvIHN0b3AgdGhlIHNlcnZlciIKZWNobyAiPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IgplY2hvICIiCgojIFRyeSB0byBvcGVuIGJyb3dzZXIgYXV0b21hdGljYWxseSBhZnRlciBhIHNob3J0IGRlbGF5CihzbGVlcCAyICYmIGlmIGNvbW1hbmQgLXYgb3BlbiAmPiAvZGV2L251bGw7IHRoZW4KICAgIG9wZW4gIiRVUkwiIDI+L2Rldi9udWxsICYmIGVjaG8gIk9wZW5lZCAkVVJMIGluIHlvdXIgZGVmYXVsdCBicm93c2VyIiB8fCBlY2hvICJQbGVhc2Ugb3BlbiAkVVJMIG1hbnVhbGx5IGluIHlvdXIgYnJvd3NlciIKZWxpZiBjb21tYW5kIC12IHhkZy1vcGVuICY+IC9kZXYvbnVsbDsgdGhlbgogICAgeGRnLW9wZW4gIiRVUkwiIDI+L2Rldi9udWxsICYmIGVjaG8gIk9wZW5lZCAkVVJMIGluIHlvdXIgZGVmYXVsdCBicm93c2VyIiB8fCBlY2hvICJQbGVhc2Ugb3BlbiAkVVJMIG1hbnVhbGx5IGluIHlvdXIgYnJvd3NlciIKZWxzZQogICAgZWNobyAiUGxlYXNlIG9wZW4gJFVSTCBtYW51YWxseSBpbiB5b3VyIGJyb3dzZXIiCmZpKSAmCgojIFRyeSBQeXRob24gMyBmaXJzdCwgdGhlbiBQeXRob24gMiwgdGhlbiBleGl0IHdpdGggZXJyb3IKaWYgY29tbWFuZCAtdiBweXRob24zICY+IC9kZXYvbnVsbDsgdGhlbgogICAgcHl0aG9uMyAtbSBodHRwLnNlcnZlciAiJFBPUlQiCmVsaWYgY29tbWFuZCAtdiBweXRob24gJj4gL2Rldi9udWxsOyB0aGVuCiAgICBweXRob24gLW0gU2ltcGxlSFRUUFNlcnZlciAiJFBPUlQiCmVsc2UKICAgIGVjaG8gIkVycm9yOiBQeXRob24gbm90IGZvdW5kLiBQbGVhc2UgaW5zdGFsbCBQeXRob24gdG8gcnVuIGEgbG9jYWwgc2VydmVyLiIKICAgIHJlYWQgLXAgIlByZXNzIEVudGVyIHRvIGV4aXQuLi4iCiAgICBleGl0IDEKZmkKIiIiCiAgICAKICAgIHdpdGggb3Blbih3ZWJfY29tbWFuZF9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZi53cml0ZSh3ZWJfY29tbWFuZF9jb250ZW50KQogICAgCiAgICAjIE1ha2UgaXQgZXhlY3V0YWJsZQogICAgb3MuY2htb2Qod2ViX2NvbW1hbmRfcGF0aCwgMG83NTUpCiAgICAKICAgICMgQ3JlYXRlIFdpbmRvd3MgLmJhdCBmaWxlCiAgICB3ZWJfYmF0X3BhdGggPSBvcy5wYXRoLmpvaW4oc2NyaXB0X2RpciwgIndlYi5iYXQiKQogICAgCiAgICB3ZWJfYmF0X2NvbnRlbnQgPSBmIiIiQGVjaG8gb2ZmClJFTSBEb3VibGUtY2xpY2thYmxlIHdlYiBzZXJ2ZXIgbGF1bmNoZXIgZm9yIFBsYXRlIFZpZXdlciAoV2luZG93cykKUkVNIFRoaXMgZmlsZSBpcyBhdXRvLWdlbmVyYXRlZCBieSBwbGF0ZV92aWV3ZXIucHkKCnNldCBQT1JUPTgwMDAKUkVNIEdldCB0aGUgZGlyZWN0b3J5IHdoZXJlIHRoaXMgc2NyaXB0IGlzIGxvY2F0ZWQKc2V0ICJTQ1JJUFRfRElSPSV+ZHAwIgpzZXQgIldFQl9ESVI9JVNDUklQVF9ESVIld2ViIgoKUkVNIENoYW5nZSB0byB3ZWIgZGlyZWN0b3J5CmNkIC9kICIlV0VCX0RJUiUiIDI+bnVsIHx8ICgKICAgIGVjaG8gRXJyb3I6IENvdWxkIG5vdCBmaW5kIHdlYiBkaXJlY3Rvcnk6ICVXRUJfRElSJQogICAgZWNobyBQbGVhc2UgcnVuIHBsYXRlX3ZpZXdlci5weSBmaXJzdCB0byBnZW5lcmF0ZSB0aGUgd2ViIGZpbGVzLgogICAgcGF1c2UKICAgIGV4aXQgL2IgMQopCgpSRU0gQ2hlY2sgaWYgdmlld2VyX2RhdGEuanNvbiBleGlzdHMKaWYgbm90IGV4aXN0ICJ2aWV3ZXJfZGF0YS5qc29uIiAoCiAgICBlY2hvIFdhcm5pbmc6IHZpZXdlcl9kYXRhLmpzb24gbm90IGZvdW5kIQogICAgZWNobyBQbGVhc2UgcnVuIHBsYXRlX3ZpZXdlci5weSBmaXJzdCB0byBnZW5lcmF0ZSB0aGUgZGF0YSBmaWxlcy4KICAgIGVjaG8uCikKCnNldCAiVVJMPWh0dHA6Ly9sb2NhbGhvc3Q6JVBPUlQlL2luZGV4Lmh0bWwiCgplY2hvID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQplY2hvIFBsYXRlIFZpZXdlciBXZWIgU2VydmVyCmVjaG8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CmVjaG8gU2VydmVyIHJ1bm5pbmcgYXQ6ICVVUkwlCmVjaG8gU2VydmluZyBkaXJlY3Rvcnk6ICVXRUJfRElSJQplY2hvLgplY2hvIFByZXNzIEN0cmwrQyB0byBzdG9wIHRoZSBzZXJ2ZXIKZWNobyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KZWNoby4KClJFTSBUcnkgdG8gb3BlbiBicm93c2VyIGF1dG9tYXRpY2FsbHkgYWZ0ZXIgYSBzaG9ydCBkZWxheQpzdGFydCAiIiBjbWQgL2MgInRpbWVvdXQgL3QgMiAvbm9icmVhayA+bnVsICYmIHN0YXJ0ICVVUkwlIgoKUkVNIFRyeSBQeXRob24gMyBmaXJzdCwgdGhlbiBQeXRob24gMiwgdGhlbiBleGl0IHdpdGggZXJyb3IKd2hlcmUgcHl0aG9uMyA+bnVsIDI+JjEKaWYgJUVSUk9STEVWRUwlID09IDAgKAogICAgcHl0aG9uMyAtbSBodHRwLnNlcnZlciAlUE9SVCUKKSBlbHNlICgKICAgIHdoZXJlIHB5dGhvbiA+bnVsIDI+JjEKICAgIGlmICVFUlJPUkxFVkVMJSA9PSAwICgKICAgICAgICBweXRob24gLW0gaHR0cC5zZXJ2ZXIgJVBPUlQlCiAgICApIGVsc2UgKAogICAgICAgIGVjaG8gRXJyb3I6IFB5dGhvbiBub3QgZm91bmQuIFBsZWFzZSBpbnN0YWxsIFB5dGhvbiB0byBydW4gYSBsb2NhbCBzZXJ2ZXIuCiAgICAgICAgcGF1c2UKICAgICAgICBleGl0IC9iIDEKICAgICkKKQoiIiIKICAgIAogICAgd2l0aCBvcGVuKHdlYl9iYXRfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgIGYud3JpdGUod2ViX2JhdF9jb250ZW50KQogICAgCiAgICByZXR1cm4gd2ViX2NvbW1hbmRfcGF0aCwgd2ViX2JhdF9wYXRoCgoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgQmFzZWxpbmUgSWRlbnRpZmljYXRpb24gYW5kIE5vcm1hbGl6YXRpb24gRnVuY3Rpb25zCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKZGVmIGlkZW50aWZ5X2Jhc2VsaW5lX3dpbmRvdyhkZjogcGQuRGF0YUZyYW1lLCBiYXNlbGluZV9lbmRfdGltZTogZmxvYXQgPSAyNC4wKSAtPiBEaWN0W3N0ciwgcGQuRGF0YUZyYW1lXToKICAgICIiIgogICAgRm9yIGVhY2ggd2VsbCBjb2x1bW4sIGRlZmluZSB0aGUgYmFzZWxpbmUgd2luZG93IGFzIGFsbCByb3dzIHdpdGggVGltZV9zIDw9IGJhc2VsaW5lX2VuZF90aW1lLgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIGRmIDogcGQuRGF0YUZyYW1lCiAgICAgICAgTG9uZy1mb3JtYXQgRGF0YUZyYW1lIHdpdGggY29sdW1ucyBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgYmFzZWxpbmVfZW5kX3RpbWUgOiBmbG9hdAogICAgICAgIE1heGltdW0gdGltZSAoaW4gc2Vjb25kcykgZm9yIGJhc2VsaW5lIHdpbmRvdyAoZGVmYXVsdDogMjQuMCkKICAgIAogICAgUmV0dXJuczoKICAgIC0tLS0tLS0tCiAgICBEaWN0W3N0ciwgcGQuRGF0YUZyYW1lXQogICAgICAgIERpY3Rpb25hcnkgbWFwcGluZyB3ZWxsX2lkIHRvIERhdGFGcmFtZSBjb250YWluaW5nIG9ubHkgYmFzZWxpbmUgcG9pbnRzIGZvciB0aGF0IHdlbGwKICAgICIiIgogICAgYmFzZWxpbmVfZGF0YSA9IHt9CiAgICAKICAgIGZvciB3ZWxsX2lkLCB3ZWxsX2RmIGluIGRmLmdyb3VwYnkoJ3dlbGwnKToKICAgICAgICBiYXNlbGluZV9tYXNrID0gd2VsbF9kZlsndGltZV9zJ10gPD0gYmFzZWxpbmVfZW5kX3RpbWUKICAgICAgICBiYXNlbGluZV9kYXRhW3dlbGxfaWRdID0gd2VsbF9kZltiYXNlbGluZV9tYXNrXS5jb3B5KCkKICAgIAogICAgcmV0dXJuIGJhc2VsaW5lX2RhdGEKCgpkZWYgZml0X2Jhc2VsaW5lKAogICAgdGltZTogcGQuU2VyaWVzLAogICAgZmx1b3Jlc2NlbmNlOiBwZC5TZXJpZXMsCiAgICBtZXRob2Q6IHN0ciA9ICdsb3dlc3MnLAogICAgZnJhYzogZmxvYXQgPSAwLjUsCiAgICBwb2x5X29yZGVyOiBpbnQgPSAxLAogICAgd2VsbF9pZDogc3RyID0gTm9uZQopIC0+IHBkLlNlcmllczoKICAgICIiIgogICAgRml0IGEgc21vb3RoIGJhc2VsaW5lIGZ1bmN0aW9uIG9uIHRoZSBiYXNlbGluZSB3aW5kb3cgYW5kIGV4dHJhcG9sYXRlIHRvIGZ1bGwgdGltZWNvdXJzZS4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICB0aW1lIDogcGQuU2VyaWVzCiAgICAgICAgVGltZSB2YWx1ZXMgZm9yIGJhc2VsaW5lIHdpbmRvdwogICAgZmx1b3Jlc2NlbmNlIDogcGQuU2VyaWVzCiAgICAgICAgRmx1b3Jlc2NlbmNlIHZhbHVlcyBmb3IgYmFzZWxpbmUgd2luZG93CiAgICBtZXRob2QgOiBzdHIKICAgICAgICBCYXNlbGluZSBmaXR0aW5nIG1ldGhvZDogJ2xvd2VzcycsICdjb25zdGFudCcsIG9yICdwb2x5bm9taWFsJyAoZGVmYXVsdDogJ2NvbnN0YW50JykKICAgICAgICAtICdsb3dlc3MnOiBMb2NhbGx5IFdlaWdodGVkIFNjYXR0ZXJwbG90IFNtb290aGluZy4gVXNlIHdoZW4gYmFzZWxpbmUgaGFzIGdyYWR1YWwgZHJpZnQuCiAgICAgICAgICBCZXN0IGZvciBub24tbGluZWFyIGJhc2VsaW5lcyB3aXRoIHNtb290aCB0cmVuZHMuIEZvcm11bGE6IGcodCkgPSBMT1dFU1MoRl9iYXNlbGluZSwgdF9iYXNlbGluZSwgZnJhYykKICAgICAgICAtICdjb25zdGFudCc6IENvbnN0YW50IG1lYW4gYmFzZWxpbmUuIFVzZSB3aGVuIGJhc2VsaW5lIGlzIHN0YWJsZS9mbGF0LgogICAgICAgICAgQmVzdCBmb3Igc3RhYmxlIGJhc2VsaW5lcyB3aXRoIG1pbmltYWwgZHJpZnQuIEZvcm11bGE6IGcodCkgPSBtZWFuKEZfYmFzZWxpbmUpCiAgICAgICAgLSAncG9seW5vbWlhbCc6IFBvbHlub21pYWwgZml0LiBVc2Ugd2hlbiBiYXNlbGluZSBoYXMgbGluZWFyIG9yIHBvbHlub21pYWwgZHJpZnQuCiAgICAgICAgICBCZXN0IGZvciBiYXNlbGluZXMgd2l0aCBrbm93biBwb2x5bm9taWFsIHRyZW5kcy4gRm9ybXVsYTogZyh0KSA9IGPigoAgKyBj4oKBdCArIGPigoJ0wrIgKyAuLi4KICAgIGZyYWMgOiBmbG9hdAogICAgICAgIEZyYWN0aW9uIG9mIGRhdGEgdXNlZCBmb3IgTE9XRVNTIHNtb290aGluZyAoZGVmYXVsdDogMC41KS4gSGlnaGVyID0gc21vb3RoZXIsIGxvd2VyID0gbW9yZSBsb2NhbC4KICAgIHBvbHlfb3JkZXIgOiBpbnQKICAgICAgICBQb2x5bm9taWFsIG9yZGVyIGZvciBwb2x5bm9taWFsIGZpdCAoZGVmYXVsdDogMSkuIDEgPSBsaW5lYXIsIDIgPSBxdWFkcmF0aWMsIGV0Yy4KICAgIHdlbGxfaWQgOiBzdHIsIG9wdGlvbmFsCiAgICAgICAgV2VsbCBpZGVudGlmaWVyIGZvciBvdXRwdXQKICAgIAogICAgUmV0dXJuczoKICAgIC0tLS0tLS0tCiAgICBwZC5TZXJpZXMKICAgICAgICBGaXR0ZWQgYmFzZWxpbmUgdmFsdWVzIGZvciBhbGwgdGltZXBvaW50cyAoc2FtZSBpbmRleCBhcyBpbnB1dCB0aW1lKQogICAgIiIiCiAgICBpbXBvcnQgbnVtcHkgYXMgbnAKICAgIAogICAgIyBSZW1vdmUgTmFOIHZhbHVlcwogICAgdmFsaWRfbWFzayA9IH4ocGQuaXNuYSh0aW1lKSB8IHBkLmlzbmEoZmx1b3Jlc2NlbmNlKSkKICAgIHRpbWVfY2xlYW4gPSB0aW1lW3ZhbGlkX21hc2tdLnZhbHVlcwogICAgZmx1b19jbGVhbiA9IGZsdW9yZXNjZW5jZVt2YWxpZF9tYXNrXS52YWx1ZXMKICAgIAogICAgaWYgbGVuKHRpbWVfY2xlYW4pID09IDA6CiAgICAgICAgIyBObyB2YWxpZCBkYXRhLCByZXR1cm4gTmFOIHNlcmllcwogICAgICAgIHJldHVybiBwZC5TZXJpZXMoaW5kZXg9dGltZS5pbmRleCwgZHR5cGU9ZmxvYXQpCiAgICAKICAgIGlmIG1ldGhvZCA9PSAnY29uc3RhbnQnOgogICAgICAgICMgMHRoLW9yZGVyIChjb25zdGFudCBtZWFuIGJhc2VsaW5lKQogICAgICAgICMgRm9ybXVsYTogZyh0KSA9IG1lYW4oRl9iYXNlbGluZSkgZm9yIGFsbCB0CiAgICAgICAgYmFzZWxpbmVfdmFsdWUgPSBucC5tZWFuKGZsdW9fY2xlYW4pCiAgICAgICAgYmFzZWxpbmVfZml0ID0gcGQuU2VyaWVzKGJhc2VsaW5lX3ZhbHVlLCBpbmRleD10aW1lLmluZGV4KQogICAgCiAgICBlbGlmIG1ldGhvZCA9PSAncG9seW5vbWlhbCc6CiAgICAgICAgIyBQb2x5bm9taWFsIGZpdCB1c2luZyBucC5wb2x5Zml0CiAgICAgICAgIyBGb3JtdWxhOiBnKHQpID0gY+KCgCArIGPigoF0ICsgY+KCgnTCsiArIC4uLiAoZGVwZW5kaW5nIG9uIG9yZGVyKQogICAgICAgIGNvZWZmcyA9IG5wLnBvbHlmaXQodGltZV9jbGVhbiwgZmx1b19jbGVhbiwgcG9seV9vcmRlcikKICAgICAgICBwb2x5X2Z1bmMgPSBucC5wb2x5MWQoY29lZmZzKQogICAgICAgIGJhc2VsaW5lX2ZpdCA9IHBkLlNlcmllcyhwb2x5X2Z1bmModGltZS52YWx1ZXMpLCBpbmRleD10aW1lLmluZGV4KQogICAgCiAgICBlbGlmIG1ldGhvZCA9PSAnbG93ZXNzJzoKICAgICAgICAjIExPV0VTUyBzbW9vdGhpbmcKICAgICAgICAjIEZvcm11bGE6IGcodCkgPSBMT1dFU1MoRl9iYXNlbGluZSwgdF9iYXNlbGluZSwgZnJhYykgaW50ZXJwb2xhdGVkL2V4dHJhcG9sYXRlZAogICAgICAgIHRyeToKICAgICAgICAgICAgZnJvbSBzdGF0c21vZGVscy5ub25wYXJhbWV0cmljLnNtb290aGVyc19sb3dlc3MgaW1wb3J0IGxvd2VzcwogICAgICAgICAgICAjIExPV0VTUyByZXR1cm5zIGFycmF5IG9mIFt4LCB5XSBwYWlycwogICAgICAgICAgICBzbW9vdGhlZCA9IGxvd2VzcyhmbHVvX2NsZWFuLCB0aW1lX2NsZWFuLCBmcmFjPWZyYWMsIHJldHVybl9zb3J0ZWQ9RmFsc2UpCiAgICAgICAgICAgICMgSW50ZXJwb2xhdGUvZXh0cmFwb2xhdGUgdG8gZnVsbCB0aW1lY291cnNlCiAgICAgICAgICAgIGZyb20gc2NpcHkuaW50ZXJwb2xhdGUgaW1wb3J0IGludGVycDFkCiAgICAgICAgICAgIGludGVycF9mdW5jID0gaW50ZXJwMWQoCiAgICAgICAgICAgICAgICB0aW1lX2NsZWFuLCBzbW9vdGhlZCwgCiAgICAgICAgICAgICAgICBraW5kPSdsaW5lYXInLCAKICAgICAgICAgICAgICAgIGJvdW5kc19lcnJvcj1GYWxzZSwgCiAgICAgICAgICAgICAgICBmaWxsX3ZhbHVlPSdleHRyYXBvbGF0ZScKICAgICAgICAgICAgKQogICAgICAgICAgICBiYXNlbGluZV9maXQgPSBwZC5TZXJpZXMoaW50ZXJwX2Z1bmModGltZS52YWx1ZXMpLCBpbmRleD10aW1lLmluZGV4KQogICAgICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IoCiAgICAgICAgICAgICAgICAic3RhdHNtb2RlbHMgaXMgcmVxdWlyZWQgZm9yIExPV0VTUyBmaXR0aW5nLiAiCiAgICAgICAgICAgICAgICAiSW5zdGFsbCB3aXRoOiBwaXAgaW5zdGFsbCBzdGF0c21vZGVscyIKICAgICAgICAgICAgKQogICAgCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZiJVbmtub3duIGJhc2VsaW5lIG1ldGhvZDoge21ldGhvZH0uIENob29zZSBmcm9tICdsb3dlc3MnLCAnY29uc3RhbnQnLCBvciAncG9seW5vbWlhbCciKQogICAgCiAgICByZXR1cm4gYmFzZWxpbmVfZml0CgoKZGVmIGZpdF93ZWxsX2Jhc2VsaW5lcygKICAgIGRmOiBwZC5EYXRhRnJhbWUsCiAgICBiYXNlbGluZV9lbmRfdGltZTogZmxvYXQgPSAyNC4wLAogICAgbWV0aG9kOiBzdHIgPSAnbG93ZXNzJywKICAgIGZyYWM6IGZsb2F0ID0gMC41LAogICAgcG9seV9vcmRlcjogaW50ID0gMSwKICAgIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lCikgLT4gRGljdFtzdHIsIHBkLlNlcmllc106CiAgICAiIiIKICAgIEZvciBlYWNoIHdlbGwsIGZpdCBhIHNtb290aCBiYXNlbGluZSBmdW5jdGlvbiBvbiB0aGUgYmFzZWxpbmUgd2luZG93IE9OTFksCiAgICB0aGVuIGV4dHJhcG9sYXRlIG92ZXIgdGhlIGZ1bGwgdGltZWNvdXJzZS4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBkZiA6IHBkLkRhdGFGcmFtZQogICAgICAgIExvbmctZm9ybWF0IERhdGFGcmFtZSB3aXRoIGNvbHVtbnMgWydwbGF0ZV9pZCcsICd3ZWxsJywgJ2NvbnRlbnQnLCAndGltZV9zJywgJ3ZhbHVlJ10KICAgIGJhc2VsaW5lX2VuZF90aW1lIDogZmxvYXQKICAgICAgICBNYXhpbXVtIHRpbWUgKGluIHNlY29uZHMpIGZvciBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQ6IDI0LjApCiAgICBtZXRob2QgOiBzdHIKICAgICAgICBCYXNlbGluZSBmaXR0aW5nIG1ldGhvZDogJ2xvd2VzcycsICdjb25zdGFudCcsIG9yICdwb2x5bm9taWFsJyAoZGVmYXVsdDogJ2NvbnN0YW50JykKICAgIGZyYWMgOiBmbG9hdAogICAgICAgIEZyYWN0aW9uIG9mIGRhdGEgdXNlZCBmb3IgTE9XRVNTIHNtb290aGluZyAoZGVmYXVsdDogMC41KQogICAgcG9seV9vcmRlciA6IGludAogICAgICAgIFBvbHlub21pYWwgb3JkZXIgZm9yIHBvbHlub21pYWwgZml0IChkZWZhdWx0OiAxKQogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIERpY3Rbc3RyLCBwZC5TZXJpZXNdCiAgICAgICAgRGljdGlvbmFyeSBtYXBwaW5nIHdlbGxfaWQgdG8gU2VyaWVzIG9mIGZpdHRlZCBiYXNlbGluZSB2YWx1ZXMgKGluZGV4ZWQgYnkgdGltZV9zKQogICAgIiIiCiAgICBiYXNlbGluZV9maXRzID0ge30KICAgIAogICAgIyBGaWx0ZXIgb3V0IGJhZCB3ZWxscyBpZiBjb25maWcgaXMgcHJvdmlkZWQKICAgIGlmIGNvbmZpZyBpcyBub3QgTm9uZToKICAgICAgICBiYWRfd2VsbHNfbGlzdCA9IGNvbmZpZy5nZXQoImJhZF93ZWxscyIsIFtdKQogICAgICAgIGlmIGJhZF93ZWxsc19saXN0OgogICAgICAgICAgICBkZiA9IGRmW35kZlsid2VsbCJdLmFwcGx5KGxhbWJkYSB3OiBpc19iYWRfd2VsbCh3LCBjb25maWcpKV0KICAgIAogICAgIyBHZXQgYmFzZWxpbmUgd2luZG93cyBmb3IgZWFjaCB3ZWxsCiAgICBiYXNlbGluZV93aW5kb3dzID0gaWRlbnRpZnlfYmFzZWxpbmVfd2luZG93KGRmLCBiYXNlbGluZV9lbmRfdGltZSkKICAgIAogICAgIyBGaXQgYmFzZWxpbmUgZm9yIGVhY2ggd2VsbAogICAgZm9yIHdlbGxfaWQsIHdlbGxfZGYgaW4gZGYuZ3JvdXBieSgnd2VsbCcpOgogICAgICAgICMgR2V0IGZ1bGwgdGltZWNvdXJzZSBmb3IgdGhpcyB3ZWxsCiAgICAgICAgZnVsbF90aW1lY291cnNlID0gd2VsbF9kZi5zb3J0X3ZhbHVlcygndGltZV9zJykKICAgICAgICAKICAgICAgICAjIEdldCBiYXNlbGluZSB3aW5kb3cKICAgICAgICBiYXNlbGluZV93aW5kb3cgPSBiYXNlbGluZV93aW5kb3dzLmdldCh3ZWxsX2lkKQogICAgICAgIAogICAgICAgIGlmIGJhc2VsaW5lX3dpbmRvdyBpcyBOb25lIG9yIGxlbihiYXNlbGluZV93aW5kb3cpID09IDA6CiAgICAgICAgICAgICMgTm8gYmFzZWxpbmUgZGF0YSwgY3JlYXRlIE5hTiBzZXJpZXMKICAgICAgICAgICAgYmFzZWxpbmVfZml0c1t3ZWxsX2lkXSA9IHBkLlNlcmllcygKICAgICAgICAgICAgICAgIGluZGV4PWZ1bGxfdGltZWNvdXJzZVsndGltZV9zJ10sCiAgICAgICAgICAgICAgICBkdHlwZT1mbG9hdAogICAgICAgICAgICApCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgCiAgICAgICAgIyBTb3J0IGJhc2VsaW5lIHdpbmRvdyBieSB0aW1lCiAgICAgICAgYmFzZWxpbmVfd2luZG93ID0gYmFzZWxpbmVfd2luZG93LnNvcnRfdmFsdWVzKCd0aW1lX3MnKQogICAgICAgIAogICAgICAgICMgRml0IGJhc2VsaW5lIG9uIGJhc2VsaW5lIHdpbmRvdyBvbmx5CiAgICAgICAgYmFzZWxpbmVfZml0ID0gZml0X2Jhc2VsaW5lKAogICAgICAgICAgICBiYXNlbGluZV93aW5kb3dbJ3RpbWVfcyddLAogICAgICAgICAgICBiYXNlbGluZV93aW5kb3dbJ3ZhbHVlJ10sCiAgICAgICAgICAgIG1ldGhvZD1tZXRob2QsCiAgICAgICAgICAgIGZyYWM9ZnJhYywKICAgICAgICAgICAgcG9seV9vcmRlcj1wb2x5X29yZGVyLAogICAgICAgICAgICB3ZWxsX2lkPXdlbGxfaWQKICAgICAgICApCiAgICAgICAgCiAgICAgICAgIyBFeHRyYXBvbGF0ZSB0byBmdWxsIHRpbWVjb3Vyc2UKICAgICAgICBmdWxsX3RpbWVzID0gZnVsbF90aW1lY291cnNlWyd0aW1lX3MnXS52YWx1ZXMKICAgICAgICAKICAgICAgICAjIEZvciBjb25zdGFudCBtZXRob2QsIHdlIGNhbiBjcmVhdGUgdGhlIFNlcmllcyBkaXJlY3RseSB3aXRob3V0IHNjaXB5CiAgICAgICAgaWYgbWV0aG9kID09ICdjb25zdGFudCc6CiAgICAgICAgICAgICMgYmFzZWxpbmVfZml0IGFscmVhZHkgY29udGFpbnMgdGhlIGNvbnN0YW50IHZhbHVlCiAgICAgICAgICAgIGNvbnN0YW50X3ZhbHVlID0gYmFzZWxpbmVfZml0Lmlsb2NbMF0gaWYgbGVuKGJhc2VsaW5lX2ZpdCkgPiAwIGVsc2UgbnAubmFuCiAgICAgICAgICAgIGV4dHJhcG9sYXRlZF9iYXNlbGluZSA9IHBkLlNlcmllcygKICAgICAgICAgICAgICAgIGNvbnN0YW50X3ZhbHVlLAogICAgICAgICAgICAgICAgaW5kZXg9ZnVsbF90aW1lY291cnNlWyd0aW1lX3MnXQogICAgICAgICAgICApCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBGb3IgcG9seW5vbWlhbCBhbmQgbG93ZXNzIG1ldGhvZHMsIG5lZWQgaW50ZXJwb2xhdGlvbgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBmcm9tIHNjaXB5LmludGVycG9sYXRlIGltcG9ydCBpbnRlcnAxZAogICAgICAgICAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgICAgICAgICByYWlzZSBJbXBvcnRFcnJvcigKICAgICAgICAgICAgICAgICAgICAic2NpcHkgaXMgcmVxdWlyZWQgZm9yIGJhc2VsaW5lIG1ldGhvZHMgJ3BvbHlub21pYWwnIGFuZCAnbG93ZXNzJy4gIgogICAgICAgICAgICAgICAgICAgICJJbnN0YWxsIHdpdGg6IHBpcCBpbnN0YWxsIHNjaXB5XG4iCiAgICAgICAgICAgICAgICAgICAgIk9yIHVzZSBtZXRob2Q9J2NvbnN0YW50JyB3aGljaCBkb2VzIG5vdCByZXF1aXJlIHNjaXB5LiIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR2V0IHVuaXF1ZSB0aW1lcG9pbnRzIGZyb20gYmFzZWxpbmUgZml0CiAgICAgICAgICAgIGJhc2VsaW5lX3RpbWVzID0gYmFzZWxpbmVfZml0LmluZGV4LnZhbHVlcwogICAgICAgICAgICBiYXNlbGluZV92YWx1ZXMgPSBiYXNlbGluZV9maXQudmFsdWVzCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENyZWF0ZSBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uCiAgICAgICAgICAgIGludGVycF9mdW5jID0gaW50ZXJwMWQoCiAgICAgICAgICAgICAgICBiYXNlbGluZV90aW1lcywKICAgICAgICAgICAgICAgIGJhc2VsaW5lX3ZhbHVlcywKICAgICAgICAgICAgICAgIGtpbmQ9J2xpbmVhcicsCiAgICAgICAgICAgICAgICBib3VuZHNfZXJyb3I9RmFsc2UsCiAgICAgICAgICAgICAgICBmaWxsX3ZhbHVlPSdleHRyYXBvbGF0ZScKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBJbnRlcnBvbGF0ZSB0byBmdWxsIHRpbWVjb3Vyc2UgdGltZXBvaW50cwogICAgICAgICAgICBleHRyYXBvbGF0ZWRfYmFzZWxpbmUgPSBwZC5TZXJpZXMoCiAgICAgICAgICAgICAgICBpbnRlcnBfZnVuYyhmdWxsX3RpbWVzKSwKICAgICAgICAgICAgICAgIGluZGV4PWZ1bGxfdGltZWNvdXJzZVsndGltZV9zJ10KICAgICAgICAgICAgKQogICAgICAgIAogICAgICAgIGJhc2VsaW5lX2ZpdHNbd2VsbF9pZF0gPSBleHRyYXBvbGF0ZWRfYmFzZWxpbmUKICAgIAogICAgcmV0dXJuIGJhc2VsaW5lX2ZpdHMKCgpkZWYgbm9ybWFsaXplX3dlbGxzKAogICAgZGY6IHBkLkRhdGFGcmFtZSwKICAgIGJhc2VsaW5lX2ZpdHM6IERpY3Rbc3RyLCBwZC5TZXJpZXNdLAogICAgbm9ybWFsaXphdGlvbl9tb2RlOiBzdHIgPSAnbXVsdGlwbGljYXRpdmUnCikgLT4gcGQuRGF0YUZyYW1lOgogICAgIiIiCiAgICBGb3IgZWFjaCB3ZWxsIGFuZCBlYWNoIHRpbWVwb2ludCwgY29tcHV0ZSBub3JtYWxpemVkIGZsdW9yZXNjZW5jZSB1c2luZyB0aGUgZml0dGVkIGJhc2VsaW5lLgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIGRmIDogcGQuRGF0YUZyYW1lCiAgICAgICAgTG9uZy1mb3JtYXQgRGF0YUZyYW1lIHdpdGggY29sdW1ucyBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgYmFzZWxpbmVfZml0cyA6IERpY3Rbc3RyLCBwZC5TZXJpZXNdCiAgICAgICAgRGljdGlvbmFyeSBtYXBwaW5nIHdlbGxfaWQgdG8gU2VyaWVzIG9mIGZpdHRlZCBiYXNlbGluZSB2YWx1ZXMKICAgIG5vcm1hbGl6YXRpb25fbW9kZSA6IHN0cgogICAgICAgIE5vcm1hbGl6YXRpb24gbW9kZSAoZGVmYXVsdDogJ211bHRpcGxpY2F0aXZlJykKICAgICAgICAtICdkZWx0YV9mX292ZXJfZic6IM6URi9GIG5vcm1hbGl6YXRpb24uIEZvcm11bGE6IEYnKHQpID0gKEYodCkgLSBnKHQpKSAvIGcodCkKICAgICAgICAgIFVzZSB3aGVuIHlvdSB3YW50IHRvIG1lYXN1cmUgcmVsYXRpdmUgY2hhbmdlIGZyb20gYmFzZWxpbmUuIEJlc3QgZm9yIGRldGVjdGluZwogICAgICAgICAgaW5jcmVhc2VzL2RlY3JlYXNlcyByZWxhdGl2ZSB0byBiYXNlbGluZS4gVmFsdWVzIGNhbiBiZSBuZWdhdGl2ZSAoYmVsb3cgYmFzZWxpbmUpCiAgICAgICAgICBvciBwb3NpdGl2ZSAoYWJvdmUgYmFzZWxpbmUpLgogICAgICAgIC0gJ211bHRpcGxpY2F0aXZlJzogTXVsdGlwbGljYXRpdmUgbm9ybWFsaXphdGlvbi4gRm9ybXVsYTogRl9ub3JtKHQpID0gRih0KSAvIGcodCkKICAgICAgICAgIFVzZSB3aGVuIHlvdSB3YW50IHRvIG5vcm1hbGl6ZSBieSBiYXNlbGluZSB3aXRob3V0IHN1YnRyYWN0aW5nLiBCZXN0IGZvciBmb2xkLWNoYW5nZQogICAgICAgICAgYW5hbHlzaXMuIFZhbHVlcyBhcmUgYWx3YXlzIHBvc2l0aXZlIChyYXRpbyB0byBiYXNlbGluZSkuCiAgICAKICAgIFJldHVybnM6CiAgICAtLS0tLS0tLQogICAgcGQuRGF0YUZyYW1lCiAgICAgICAgRGF0YUZyYW1lIHdpdGggc2FtZSBzaGFwZSBhcyBpbnB1dCBidXQgd2l0aCBub3JtYWxpemVkICd2YWx1ZScgY29sdW1uCiAgICAiIiIKICAgIG5vcm1fZGYgPSBkZi5jb3B5KCkKICAgIG5vcm1fdmFsdWVzID0gW10KICAgIAogICAgZm9yIGlkeCwgcm93IGluIGRmLml0ZXJyb3dzKCk6CiAgICAgICAgd2VsbF9pZCA9IHJvd1snd2VsbCddCiAgICAgICAgdGltZV9zID0gcm93Wyd0aW1lX3MnXQogICAgICAgIHZhbHVlID0gcm93Wyd2YWx1ZSddCiAgICAgICAgCiAgICAgICAgIyBHZXQgYmFzZWxpbmUgZml0IGZvciB0aGlzIHdlbGwKICAgICAgICBiYXNlbGluZV9zZXJpZXMgPSBiYXNlbGluZV9maXRzLmdldCh3ZWxsX2lkKQogICAgICAgIAogICAgICAgIGlmIGJhc2VsaW5lX3NlcmllcyBpcyBOb25lIG9yIGxlbihiYXNlbGluZV9zZXJpZXMpID09IDA6CiAgICAgICAgICAgIG5vcm1fdmFsdWVzLmFwcGVuZChucC5uYW4pCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgCiAgICAgICAgIyBGaW5kIGNsb3Nlc3QgdGltZXBvaW50IGluIGJhc2VsaW5lIHNlcmllcwogICAgICAgIGJhc2VsaW5lX3RpbWVzID0gYmFzZWxpbmVfc2VyaWVzLmluZGV4LnZhbHVlcwogICAgICAgIGNsb3Nlc3RfaWR4ID0gbnAuYXJnbWluKG5wLmFicyhiYXNlbGluZV90aW1lcyAtIHRpbWVfcykpCiAgICAgICAgYmFzZWxpbmVfdmFsdWUgPSBiYXNlbGluZV9zZXJpZXMuaWxvY1tjbG9zZXN0X2lkeF0KICAgICAgICAKICAgICAgICBpZiBwZC5pc25hKGJhc2VsaW5lX3ZhbHVlKSBvciBiYXNlbGluZV92YWx1ZSA9PSAwOgogICAgICAgICAgICBub3JtX3ZhbHVlcy5hcHBlbmQobnAubmFuKQogICAgICAgICAgICBjb250aW51ZQogICAgICAgIAogICAgICAgICMgQXBwbHkgbm9ybWFsaXphdGlvbgogICAgICAgIGlmIG5vcm1hbGl6YXRpb25fbW9kZSA9PSAnZGVsdGFfZl9vdmVyX2YnOgogICAgICAgICAgICAjIM6URi9GID0gKEYodCkgLSBnKHQpKSAvIGcodCkKICAgICAgICAgICAgbm9ybV92YWx1ZSA9ICh2YWx1ZSAtIGJhc2VsaW5lX3ZhbHVlKSAvIGJhc2VsaW5lX3ZhbHVlCiAgICAgICAgZWxpZiBub3JtYWxpemF0aW9uX21vZGUgPT0gJ211bHRpcGxpY2F0aXZlJzoKICAgICAgICAgICAgIyBGX25vcm0odCkgPSBGKHQpIC8gZyh0KQogICAgICAgICAgICBub3JtX3ZhbHVlID0gdmFsdWUgLyBiYXNlbGluZV92YWx1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgICAgICBmIlVua25vd24gbm9ybWFsaXphdGlvbl9tb2RlOiB7bm9ybWFsaXphdGlvbl9tb2RlfS4gIgogICAgICAgICAgICAgICAgIkNob29zZSBmcm9tICdkZWx0YV9mX292ZXJfZicgb3IgJ211bHRpcGxpY2F0aXZlJyIKICAgICAgICAgICAgKQogICAgICAgIAogICAgICAgIG5vcm1fdmFsdWVzLmFwcGVuZChub3JtX3ZhbHVlKQogICAgCiAgICBub3JtX2RmWyd2YWx1ZSddID0gbm9ybV92YWx1ZXMKICAgIHJldHVybiBub3JtX2RmCgoKZGVmIGdldF90cmlwbGljYXRlX2dyb3VwX2NvbG9yKAogICAgZ3JvdXBfbmFtZTogc3RyLAogICAgY29uZmlnOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUKKSAtPiBzdHI6CiAgICAiIiIKICAgIEdldCB0aGUgY29sb3IgZm9yIGEgZ3JvdXAgbmFtZS4KICAgIE1hdGNoZXMgdGhlIGNvbG9yIGFzc2lnbm1lbnQgZnJvbSB0aGUgd2ViIGludGVyZmFjZS4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBncm91cF9uYW1lIDogc3RyCiAgICAgICAgTmFtZSBvZiB0aGUgZ3JvdXAKICAgIGNvbmZpZyA6IERpY3Rbc3RyLCBBbnldLCBvcHRpb25hbAogICAgICAgIENvbmZpZ3VyYXRpb24gZGljdGlvbmFyeSB3aXRoICdncm91cHMnIGtleSAoYXV0by1nZW5lcmF0ZWQgZnJvbSB3ZWxsX2xhYmVscykKICAgIAogICAgUmV0dXJuczoKICAgIC0tLS0tLS0tCiAgICBzdHIKICAgICAgICBIZXggY29sb3IgY29kZSBmb3IgdGhlIGdyb3VwCiAgICAiIiIKICAgIGlmIGNvbmZpZyBpcyBOb25lOgogICAgICAgIHNjcmlwdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgICAgICBjb25maWdfcGF0aCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAicGxhdGVfY29uZmlnLmpzb24iKQogICAgICAgIGNvbmZpZyA9IGxvYWRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgCiAgICAjIFVzZSBhdXRvLWdlbmVyYXRlZCBncm91cHMgZnJvbSBjb25maWcgKGdlbmVyYXRlZCBmcm9tIHdlbGxfbGFiZWxzKQogICAgZ3JvdXBzID0gY29uZmlnLmdldCgiZ3JvdXBzIiwgW10pCiAgICAKICAgICMgQnVpbGQgY29sb3IgbWFwOiBncm91cCBuYW1lIC0+IGNvbG9yIGluZGV4CiAgICBjb2xvcl9tYXAgPSB7fQogICAgZm9yIGlkeCwgZ3JvdXAgaW4gZW51bWVyYXRlKGdyb3Vwcyk6CiAgICAgICAgbmFtZSA9IGdyb3VwLmdldCgibmFtZSIsICIiKS5zdHJpcCgpCiAgICAgICAgaWYgbmFtZSBhbmQgbmFtZSBub3QgaW4gY29sb3JfbWFwOgogICAgICAgICAgICBjb2xvcl9tYXBbbmFtZV0gPSBpZHgKICAgIAogICAgIyBHZXQgY29sb3IgaW5kZXggZm9yIHRoaXMgZ3JvdXAKICAgIG5vcm1hbGl6ZWRfbmFtZSA9IGdyb3VwX25hbWUuc3RyaXAoKSBpZiBncm91cF9uYW1lIGVsc2UgIiIKICAgIGNvbG9yX2lkeCA9IGNvbG9yX21hcC5nZXQobm9ybWFsaXplZF9uYW1lLCAwKQogICAgCiAgICAjIFJldHVybiBjb2xvciBmcm9tIHBhbGV0dGUgKGN5Y2xlIGlmIG5lZWRlZCkKICAgIHJldHVybiBUUklQTElDQVRFX0NPTE9SU1tjb2xvcl9pZHggJSBsZW4oVFJJUExJQ0FURV9DT0xPUlMpXQoKCmRlZiBidWlsZF9jb25kaXRpb25fbWFwKAogICAgZGY6IHBkLkRhdGFGcmFtZSwKICAgIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lCikgLT4gRGljdFtzdHIsIHN0cl06CiAgICAiIiIKICAgIEJ1aWxkIGEgbWFwcGluZyBmcm9tIHdlbGxfaWQgdG8gY29uZGl0aW9uIG5hbWUuCiAgICAKICAgIFVzZXMgZ3JvdXAgbmFtZXMgZnJvbSBjb25maWcgdG8gYXNzaWduIGNvbmRpdGlvbnMuCiAgICBXZWxscyBpbiB0aGUgc2FtZSBncm91cCAoc2FtZSByb3cgcGF0dGVybikgZ2V0IHRoZSBzYW1lIGNvbmRpdGlvbi4KICAgIEdyb3VwcyBhcmUgYXV0by1nZW5lcmF0ZWQgZnJvbSB3ZWxsX2xhYmVscy4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBkZiA6IHBkLkRhdGFGcmFtZQogICAgICAgIExvbmctZm9ybWF0IERhdGFGcmFtZSB3aXRoIGNvbHVtbnMgWydwbGF0ZV9pZCcsICd3ZWxsJywgJ2NvbnRlbnQnLCAndGltZV9zJywgJ3ZhbHVlJ10KICAgIGNvbmZpZyA6IERpY3Rbc3RyLCBBbnldCiAgICAgICAgQ29uZmlndXJhdGlvbiBkaWN0aW9uYXJ5IHdpdGggJ2dyb3Vwcycga2V5IChhdXRvLWdlbmVyYXRlZCBmcm9tIHdlbGxfbGFiZWxzKQogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIERpY3Rbc3RyLCBzdHJdCiAgICAgICAgRGljdGlvbmFyeSBtYXBwaW5nIHdlbGxfaWQgdG8gY29uZGl0aW9uIG5hbWUKICAgICIiIgogICAgaWYgY29uZmlnIGlzIE5vbmU6CiAgICAgICAgc2NyaXB0X2RpciA9IG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmFic3BhdGgoX19maWxlX18pKQogICAgICAgIGNvbmZpZ19wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJwbGF0ZV9jb25maWcuanNvbiIpCiAgICAgICAgY29uZmlnID0gbG9hZF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAKICAgIGNvbmRpdGlvbl9tYXAgPSB7fQogICAgIyBVc2UgYXV0by1nZW5lcmF0ZWQgZ3JvdXBzIGZyb20gY29uZmlnIChnZW5lcmF0ZWQgZnJvbSB3ZWxsX2xhYmVscykKICAgIGdyb3VwcyA9IGNvbmZpZy5nZXQoImdyb3VwcyIsIFtdKQogICAgCiAgICAjIEJ1aWxkIG1hcHBpbmc6IHJvd19sZXR0ZXIgLT4gY29uZGl0aW9uIG5hbWUKICAgIHJvd190b19jb25kaXRpb24gPSB7fQogICAgZm9yIGdyb3VwIGluIGdyb3VwczoKICAgICAgICBncm91cF9uYW1lID0gZ3JvdXAuZ2V0KCJuYW1lIiwgIiIpCiAgICAgICAgZ3JvdXBfd2VsbHMgPSBncm91cC5nZXQoIndlbGxzIiwgW10pCiAgICAgICAgZm9yIHdlbGxfcGF0dGVybiBpbiBncm91cF93ZWxsczoKICAgICAgICAgICAgIyBFeHRyYWN0IHJvdyBsZXR0ZXIgZnJvbSB3ZWxsIHBhdHRlcm4gKGUuZy4sICJCIiBmcm9tICJCIiBvciAiQjEzIikKICAgICAgICAgICAgcm93X2xldHRlciA9IHdlbGxfcGF0dGVyblswXSBpZiB3ZWxsX3BhdHRlcm4gYW5kIHdlbGxfcGF0dGVyblswXS5pc2FscGhhKCkgZWxzZSAiIgogICAgICAgICAgICBpZiByb3dfbGV0dGVyOgogICAgICAgICAgICAgICAgcm93X3RvX2NvbmRpdGlvbltyb3dfbGV0dGVyXSA9IGdyb3VwX25hbWUKICAgIAogICAgIyBNYXAgZWFjaCB3ZWxsIHRvIGl0cyBjb25kaXRpb24gYmFzZWQgb24gcm93IGxldHRlcgogICAgZm9yIHdlbGxfaWQgaW4gZGZbJ3dlbGwnXS51bmlxdWUoKToKICAgICAgICBpZiB3ZWxsX2lkIGFuZCBsZW4od2VsbF9pZCkgPiAwOgogICAgICAgICAgICByb3dfbGV0dGVyID0gd2VsbF9pZFswXSBpZiB3ZWxsX2lkWzBdLmlzYWxwaGEoKSBlbHNlICIiCiAgICAgICAgICAgIGNvbmRpdGlvbiA9IHJvd190b19jb25kaXRpb24uZ2V0KHJvd19sZXR0ZXIsIHdlbGxfaWQpICAjIERlZmF1bHQgdG8gd2VsbF9pZCBpZiBub3QgZm91bmQKICAgICAgICAgICAgY29uZGl0aW9uX21hcFt3ZWxsX2lkXSA9IGNvbmRpdGlvbgogICAgCiAgICByZXR1cm4gY29uZGl0aW9uX21hcAoKCmRlZiBjb21wdXRlX2NvbmRpdGlvbl9zdGF0aXN0aWNzKAogICAgbm9ybV9kZjogcGQuRGF0YUZyYW1lLAogICAgY29uZGl0aW9uX21hcDogRGljdFtzdHIsIHN0cl0KKSAtPiBwZC5EYXRhRnJhbWU6CiAgICAiIiIKICAgIEdyb3VwIHdlbGxzIGJ5IGNvbmRpdGlvbiBhbmQgY29tcHV0ZSBtZWFuIMKxIFNFTSBmb3IgZWFjaCBjb25kaXRpb24gYW5kIHRpbWVwb2ludC4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBub3JtX2RmIDogcGQuRGF0YUZyYW1lCiAgICAgICAgTm9ybWFsaXplZCBEYXRhRnJhbWUgd2l0aCBjb2x1bW5zIFsncGxhdGVfaWQnLCAnd2VsbCcsICdjb250ZW50JywgJ3RpbWVfcycsICd2YWx1ZSddCiAgICBjb25kaXRpb25fbWFwIDogRGljdFtzdHIsIHN0cl0KICAgICAgICBEaWN0aW9uYXJ5IG1hcHBpbmcgd2VsbF9pZCB0byBjb25kaXRpb24gbmFtZQogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIHBkLkRhdGFGcmFtZQogICAgICAgIFRpZHkgRGF0YUZyYW1lIHdpdGggY29sdW1uczogWydUaW1lX3MnLCAnY29uZGl0aW9uJywgJ21lYW4nLCAnc2QnLCAnc2VtJywgJ24nXQogICAgIiIiCiAgICBpbXBvcnQgbnVtcHkgYXMgbnAKICAgIAogICAgIyBBZGQgY29uZGl0aW9uIGNvbHVtbgogICAgbm9ybV9kZiA9IG5vcm1fZGYuY29weSgpCiAgICBub3JtX2RmWydjb25kaXRpb24nXSA9IG5vcm1fZGZbJ3dlbGwnXS5tYXAoY29uZGl0aW9uX21hcCkKICAgIAogICAgIyBHcm91cCBieSBjb25kaXRpb24gYW5kIHRpbWUKICAgIHJlc3VsdHMgPSBbXQogICAgCiAgICBmb3IgKGNvbmRpdGlvbiwgdGltZV9zKSwgZ3JvdXAgaW4gbm9ybV9kZi5ncm91cGJ5KFsnY29uZGl0aW9uJywgJ3RpbWVfcyddKToKICAgICAgICB2YWx1ZXMgPSBncm91cFsndmFsdWUnXS5kcm9wbmEoKS52YWx1ZXMKICAgICAgICAKICAgICAgICBpZiBsZW4odmFsdWVzKSA9PSAwOgogICAgICAgICAgICBjb250aW51ZQogICAgICAgIAogICAgICAgIG4gPSBsZW4odmFsdWVzKQogICAgICAgIG1lYW4gPSBucC5tZWFuKHZhbHVlcykKICAgICAgICBzZCA9IG5wLnN0ZCh2YWx1ZXMsIGRkb2Y9MSkgICMgU2FtcGxlIHN0YW5kYXJkIGRldmlhdGlvbgogICAgICAgIHNlbSA9IHNkIC8gbnAuc3FydChuKSBpZiBuID4gMCBlbHNlIG5wLm5hbgogICAgICAgIAogICAgICAgIHJlc3VsdHMuYXBwZW5kKHsKICAgICAgICAgICAgJ1RpbWVfcyc6IHRpbWVfcywKICAgICAgICAgICAgJ2NvbmRpdGlvbic6IGNvbmRpdGlvbiwKICAgICAgICAgICAgJ21lYW4nOiBtZWFuLAogICAgICAgICAgICAnc2QnOiBzZCwKICAgICAgICAgICAgJ3NlbSc6IHNlbSwKICAgICAgICAgICAgJ24nOiBuCiAgICAgICAgfSkKICAgIAogICAgc3RhdHNfZGYgPSBwZC5EYXRhRnJhbWUocmVzdWx0cykKICAgIHJldHVybiBzdGF0c19kZi5zb3J0X3ZhbHVlcyhbJ2NvbmRpdGlvbicsICdUaW1lX3MnXSkucmVzZXRfaW5kZXgoZHJvcD1UcnVlKQoKCmRlZiBwbG90X3RpbWVjb3Vyc2UoCiAgICBzdGF0c19kZjogcGQuRGF0YUZyYW1lLAogICAgY29uZGl0aW9uczogTGlzdFtzdHJdID0gTm9uZSwKICAgIGZpZ3NpemU6IHR1cGxlID0gKDEwLCA2KSwKICAgIHNhdmVfcGF0aDogc3RyID0gTm9uZSwKICAgIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lCik6CiAgICAiIiIKICAgIEdlbmVyYXRlIHRpbWUtY291cnNlIHBsb3RzIHdpdGggbWVhbiDCsSBTRU0gZm9yIGVhY2ggY29uZGl0aW9uLgogICAgVXNlcyB0cmlwbGljYXRlIGdyb3VwIGNvbG9ycyB0byBtYXRjaCB0aGUgd2ViIGludGVyZmFjZS4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBzdGF0c19kZiA6IHBkLkRhdGFGcmFtZQogICAgICAgIFN0YXRpc3RpY3MgRGF0YUZyYW1lIHdpdGggY29sdW1ucyBbJ1RpbWVfcycsICdjb25kaXRpb24nLCAnbWVhbicsICdzZW0nXQogICAgY29uZGl0aW9ucyA6IExpc3Rbc3RyXSwgb3B0aW9uYWwKICAgICAgICBTdWJzZXQgb2YgY29uZGl0aW9ucyB0byBwbG90LiBJZiBOb25lLCBwbG90cyBhbGwgY29uZGl0aW9ucy4KICAgIGZpZ3NpemUgOiB0dXBsZQogICAgICAgIEZpZ3VyZSBzaXplICh3aWR0aCwgaGVpZ2h0KSBpbiBpbmNoZXMgKGRlZmF1bHQ6ICgxMCwgNikpCiAgICBzYXZlX3BhdGggOiBzdHIsIG9wdGlvbmFsCiAgICAgICAgUGF0aCB0byBzYXZlIHRoZSBmaWd1cmUuIElmIE5vbmUsIGRpc3BsYXlzIHRoZSBwbG90LgogICAgY29uZmlnIDogRGljdFtzdHIsIEFueV0sIG9wdGlvbmFsCiAgICAgICAgQ29uZmlndXJhdGlvbiBkaWN0aW9uYXJ5IHdpdGggJ2dyb3Vwcycga2V5IChhdXRvLWdlbmVyYXRlZCBmcm9tIHdlbGxfbGFiZWxzKQogICAgIiIiCiAgICBpbXBvcnQgbWF0cGxvdGxpYi5weXBsb3QgYXMgcGx0CiAgICAKICAgIGlmIGNvbmZpZyBpcyBOb25lOgogICAgICAgIHNjcmlwdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgICAgICBjb25maWdfcGF0aCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAicGxhdGVfY29uZmlnLmpzb24iKQogICAgICAgIGNvbmZpZyA9IGxvYWRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgCiAgICBpZiBjb25kaXRpb25zIGlzIE5vbmU6CiAgICAgICAgY29uZGl0aW9ucyA9IHN0YXRzX2RmWydjb25kaXRpb24nXS51bmlxdWUoKQogICAgCiAgICBmaWcsIGF4ID0gcGx0LnN1YnBsb3RzKGZpZ3NpemU9Zmlnc2l6ZSkKICAgIAogICAgZm9yIGlkeCwgY29uZGl0aW9uIGluIGVudW1lcmF0ZShjb25kaXRpb25zKToKICAgICAgICBjb25kX2RhdGEgPSBzdGF0c19kZltzdGF0c19kZlsnY29uZGl0aW9uJ10gPT0gY29uZGl0aW9uXS5zb3J0X3ZhbHVlcygnVGltZV9zJykKICAgICAgICAKICAgICAgICBpZiBsZW4oY29uZF9kYXRhKSA9PSAwOgogICAgICAgICAgICBjb250aW51ZQogICAgICAgIAogICAgICAgIHRpbWVzID0gY29uZF9kYXRhWydUaW1lX3MnXS52YWx1ZXMKICAgICAgICBtZWFucyA9IGNvbmRfZGF0YVsnbWVhbiddLnZhbHVlcwogICAgICAgIHNlbXMgPSBjb25kX2RhdGFbJ3NlbSddLnZhbHVlcwogICAgICAgIAogICAgICAgICMgR2V0IGNvbG9yIGZvciB0aGlzIGNvbmRpdGlvbiAodHJpcGxpY2F0ZSBncm91cCBuYW1lKQogICAgICAgICMgVXNlIHRyaXBsaWNhdGUgZ3JvdXAgY29sb3IgaWYgY29uZGl0aW9uIG1hdGNoZXMgYSBncm91cCBuYW1lLCBvdGhlcndpc2UgdXNlIGRlZmF1bHQgcGFsZXR0ZQogICAgICAgIGNvbG9yID0gZ2V0X3RyaXBsaWNhdGVfZ3JvdXBfY29sb3IoY29uZGl0aW9uLCBjb25maWcpCiAgICAgICAgCiAgICAgICAgIyBQbG90IGxpbmUKICAgICAgICBheC5wbG90KHRpbWVzLCBtZWFucywgbGFiZWw9Y29uZGl0aW9uLCBjb2xvcj1jb2xvciwgbGluZXdpZHRoPTIpCiAgICAgICAgCiAgICAgICAgIyBQbG90IGVycm9yIGJhcnMKICAgICAgICBheC5lcnJvcmJhcigKICAgICAgICAgICAgdGltZXMsIG1lYW5zLCB5ZXJyPXNlbXMsCiAgICAgICAgICAgIGNvbG9yPWNvbG9yLAogICAgICAgICAgICBhbHBoYT0wLjUsCiAgICAgICAgICAgIGNhcHNpemU9MywKICAgICAgICAgICAgY2FwdGhpY2s9MSwKICAgICAgICAgICAgZWxpbmV3aWR0aD0xCiAgICAgICAgKQogICAgCiAgICBheC5zZXRfeGxhYmVsKCdUaW1lIChzKScsIGZvbnRzaXplPTEyKQogICAgYXguc2V0X3lsYWJlbCgnzpRGL0YnLCBmb250c2l6ZT0xMikKICAgIGF4LnNldF90aXRsZSgnVGltZSBDb3Vyc2UgYnkgQ29uZGl0aW9uJywgZm9udHNpemU9MTQpCiAgICBheC5sZWdlbmQobG9jPSdiZXN0JywgZm9udHNpemU9MTApCiAgICBheC5ncmlkKFRydWUsIGFscGhhPTAuMykKICAgIAogICAgcGx0LnRpZ2h0X2xheW91dCgpCiAgICAKICAgIGlmIHNhdmVfcGF0aDoKICAgICAgICBwbHQuc2F2ZWZpZyhzYXZlX3BhdGgsIGRwaT0zMDAsIGJib3hfaW5jaGVzPSd0aWdodCcpCiAgICAgICAgcHJpbnQoZiJQbG90IHNhdmVkIHRvIHtzYXZlX3BhdGh9IikKICAgIGVsc2U6CiAgICAgICAgcGx0LnNob3coKQogICAgCiAgICBwbHQuY2xvc2UoKQoKCmRlZiBwcmludF9iYXNlbGluZV9vcHRpb25zKCk6CiAgICAiIiIKICAgIFByaW50IGRlc2NyaXB0aW9ucyBvZiBiYXNlbGluZSBmaXR0aW5nIGFuZCBub3JtYWxpemF0aW9uIG9wdGlvbnMuCiAgICAiIiIKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoIkJBU0VMSU5FIEZJVFRJTkcgT1BUSU9OUyIpCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KCJcbjEuIExPV0VTUyAoTG9jYWxseSBXZWlnaHRlZCBTY2F0dGVycGxvdCBTbW9vdGhpbmcpIikKICAgIHByaW50KCIgICBGb3JtdWxhOiBnKHQpID0gTE9XRVNTKEZfYmFzZWxpbmUsIHRfYmFzZWxpbmUsIGZyYWMpIikKICAgIHByaW50KCIgICBXaGVuIHRvIHVzZTogQmFzZWxpbmUgaGFzIGdyYWR1YWwgZHJpZnQgb3Igbm9uLWxpbmVhciB0cmVuZHMiKQogICAgcHJpbnQoIiAgIEJlc3QgZm9yOiBOb24tbGluZWFyIGJhc2VsaW5lcyB3aXRoIHNtb290aCB0cmVuZHMiKQogICAgcHJpbnQoIiAgIFBhcmFtZXRlcnM6IikKICAgIHByaW50KCIgICAgIC0gZnJhYzogRnJhY3Rpb24gb2YgZGF0YSB1c2VkIGZvciBzbW9vdGhpbmcgKGRlZmF1bHQ6IDAuNSkiKQogICAgcHJpbnQoIiAgICAgICAqIEhpZ2hlciBmcmFjICgwLjctMC45KSA9IHNtb290aGVyLCBtb3JlIGdsb2JhbCBmaXQiKQogICAgcHJpbnQoIiAgICAgICAqIExvd2VyIGZyYWMgKDAuMi0wLjQpID0gbW9yZSBsb2NhbCwgZm9sbG93cyBkYXRhIGNsb3NlbHkiKQogICAgcHJpbnQoKQogICAgcHJpbnQoIjIuIENPTlNUQU5UICgwdGgtb3JkZXIgcG9seW5vbWlhbCkiKQogICAgcHJpbnQoIiAgIEZvcm11bGE6IGcodCkgPSBtZWFuKEZfYmFzZWxpbmUpIGZvciBhbGwgdCIpCiAgICBwcmludCgiICAgV2hlbiB0byB1c2U6IEJhc2VsaW5lIGlzIHN0YWJsZS9mbGF0IHdpdGggbWluaW1hbCBkcmlmdCIpCiAgICBwcmludCgiICAgQmVzdCBmb3I6IFN0YWJsZSBiYXNlbGluZXMgd2l0aCBubyB0aW1lLWRlcGVuZGVudCB0cmVuZHMiKQogICAgcHJpbnQoIiAgIFBhcmFtZXRlcnM6IE5vbmUiKQogICAgcHJpbnQoKQogICAgcHJpbnQoIjMuIFBPTFlOT01JQUwgKDFzdC1vcmRlciBvciBoaWdoZXIpIikKICAgIHByaW50KCIgICBGb3JtdWxhOiBnKHQpID0gY+KCgCArIGPigoF0ICsgY+KCgnTCsiArIC4uLiIpCiAgICBwcmludCgiICAgV2hlbiB0byB1c2U6IEJhc2VsaW5lIGhhcyBsaW5lYXIgb3IgcG9seW5vbWlhbCBkcmlmdCIpCiAgICBwcmludCgiICAgQmVzdCBmb3I6IEJhc2VsaW5lcyB3aXRoIGtub3duIHBvbHlub21pYWwgdHJlbmRzIikKICAgIHByaW50KCIgICBQYXJhbWV0ZXJzOiIpCiAgICBwcmludCgiICAgICAtIHBvbHlfb3JkZXI6IFBvbHlub21pYWwgb3JkZXIgKGRlZmF1bHQ6IDEgPSBsaW5lYXIpIikKICAgIHByaW50KCIgICAgICAgKiBPcmRlciAxOiBMaW5lYXIgZHJpZnQgKGcodCkgPSBj4oKAICsgY+KCgXQpIikKICAgIHByaW50KCIgICAgICAgKiBPcmRlciAyOiBRdWFkcmF0aWMgZHJpZnQgKGcodCkgPSBj4oKAICsgY+KCgXQgKyBj4oKCdMKyKSIpCiAgICBwcmludCgiICAgICAgICogSGlnaGVyIG9yZGVyczogTW9yZSBjb21wbGV4IHRyZW5kcyIpCiAgICBwcmludCgpCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KCJOT1JNQUxJWkFUSU9OIE9QVElPTlMiKQogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgiXG4xLiBERUxUQV9GX09WRVJfRiAozpRGL0YpIikKICAgIHByaW50KCIgICBGb3JtdWxhOiBGJyh0KSA9IChGKHQpIC0gZyh0KSkgLyBnKHQpIikKICAgIHByaW50KCIgICBXaGVuIHRvIHVzZTogTWVhc3VyZSByZWxhdGl2ZSBjaGFuZ2UgZnJvbSBiYXNlbGluZSIpCiAgICBwcmludCgiICAgQmVzdCBmb3I6IERldGVjdGluZyBpbmNyZWFzZXMvZGVjcmVhc2VzIHJlbGF0aXZlIHRvIGJhc2VsaW5lIikKICAgIHByaW50KCIgICBJbnRlcnByZXRhdGlvbjoiKQogICAgcHJpbnQoIiAgICAgKiBGJyh0KSA9IDA6IE5vIGNoYW5nZSBmcm9tIGJhc2VsaW5lIikKICAgIHByaW50KCIgICAgICogRicodCkgPiAwOiBJbmNyZWFzZSBhYm92ZSBiYXNlbGluZSAoZS5nLiwgMC41ID0gNTAlIGluY3JlYXNlKSIpCiAgICBwcmludCgiICAgICAqIEYnKHQpIDwgMDogRGVjcmVhc2UgYmVsb3cgYmFzZWxpbmUgKGUuZy4sIC0wLjMgPSAzMCUgZGVjcmVhc2UpIikKICAgIHByaW50KCIgICBWYWx1ZXMgY2FuIGJlIG5lZ2F0aXZlIChiZWxvdyBiYXNlbGluZSkgb3IgcG9zaXRpdmUgKGFib3ZlIGJhc2VsaW5lKSIpCiAgICBwcmludCgpCiAgICBwcmludCgiMi4gTVVMVElQTElDQVRJVkUiKQogICAgcHJpbnQoIiAgIEZvcm11bGE6IEZfbm9ybSh0KSA9IEYodCkgLyBnKHQpIikKICAgIHByaW50KCIgICBXaGVuIHRvIHVzZTogTm9ybWFsaXplIGJ5IGJhc2VsaW5lIHdpdGhvdXQgc3VidHJhY3RpbmciKQogICAgcHJpbnQoIiAgIEJlc3QgZm9yOiBGb2xkLWNoYW5nZSBhbmFseXNpcyIpCiAgICBwcmludCgiICAgSW50ZXJwcmV0YXRpb246IikKICAgIHByaW50KCIgICAgICogRl9ub3JtKHQpID0gMS4wOiBObyBjaGFuZ2UgZnJvbSBiYXNlbGluZSIpCiAgICBwcmludCgiICAgICAqIEZfbm9ybSh0KSA9IDIuMDogMi1mb2xkIGluY3JlYXNlICgxMDAlIGluY3JlYXNlKSIpCiAgICBwcmludCgiICAgICAqIEZfbm9ybSh0KSA9IDAuNTogMi1mb2xkIGRlY3JlYXNlICg1MCUgb2YgYmFzZWxpbmUpIikKICAgIHByaW50KCIgICBWYWx1ZXMgYXJlIGFsd2F5cyBwb3NpdGl2ZSAocmF0aW8gdG8gYmFzZWxpbmUpIikKICAgIHByaW50KCkKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoIlNUQVRJU1RJQ1MgQ09NUFVUQVRJT04iKQogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgiXG5Gb3IgZWFjaCBjb25kaXRpb24gYW5kIHRpbWVwb2ludCwgdGhlIGZvbGxvd2luZyBzdGF0aXN0aWNzIGFyZSBjb21wdXRlZDoiKQogICAgcHJpbnQoIiAgTWVhbjogzrwodCkgPSAoMS9uKSAqIM6jIEYnKHQpIikKICAgIHByaW50KCIgICAgQXZlcmFnZSBub3JtYWxpemVkIHZhbHVlIGFjcm9zcyBhbGwgd2VsbHMgaW4gdGhlIGNvbmRpdGlvbiIpCiAgICBwcmludCgpCiAgICBwcmludCgiICBTRDogz4ModCkgPSBzcXJ0KM6jKEYnKHQpIC0gzrwodCkpwrIgLyAobi0xKSkiKQogICAgcHJpbnQoIiAgICBTYW1wbGUgc3RhbmRhcmQgZGV2aWF0aW9uIChkZG9mPTEpIGFjcm9zcyB3ZWxscyIpCiAgICBwcmludCgpCiAgICBwcmludCgiICBTRU06IFNFTSh0KSA9IM+DKHQpIC8gc3FydChuKSIpCiAgICBwcmludCgiICAgIFN0YW5kYXJkIGVycm9yIG9mIHRoZSBtZWFuID0gU0QgLyBzcXJ0KG5fd2VsbHMpIikKICAgIHByaW50KCIgICAgTm90ZTogU0VNIGlzIGNvbXB1dGVkIGFjcm9zcyB3ZWxscywgbm90IHByb3BhZ2F0ZWQgZnJvbSBiYXNlbGluZSBlcnJvciIpCiAgICBwcmludCgpCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KCkKCgpkZWYgcHJvY2Vzc19iYXNlbGluZV9ub3JtYWxpemF0aW9uKAogICAgZGY6IHBkLkRhdGFGcmFtZSwKICAgIGJhc2VsaW5lX2VuZF90aW1lOiBmbG9hdCA9IDI0LjAsCiAgICBiYXNlbGluZV9tZXRob2Q6IHN0ciA9ICdjb25zdGFudCcsCiAgICBiYXNlbGluZV9mcmFjOiBmbG9hdCA9IDAuNSwKICAgIGJhc2VsaW5lX3BvbHlfb3JkZXI6IGludCA9IDEsCiAgICBub3JtYWxpemF0aW9uX21vZGU6IHN0ciA9ICdtdWx0aXBsaWNhdGl2ZScsCiAgICBjb25maWc6IERpY3Rbc3RyLCBBbnldID0gTm9uZSwKICAgIG91dHB1dF9kaXI6IHN0ciA9IE5vbmUKKSAtPiB0dXBsZToKICAgICIiIgogICAgQ29tcGxldGUgcGlwZWxpbmU6IGJhc2VsaW5lIGlkZW50aWZpY2F0aW9uLCBmaXR0aW5nLCBub3JtYWxpemF0aW9uLCBhbmQgc3RhdGlzdGljcy4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBkZiA6IHBkLkRhdGFGcmFtZQogICAgICAgIExvbmctZm9ybWF0IERhdGFGcmFtZSB3aXRoIGNvbHVtbnMgWydwbGF0ZV9pZCcsICd3ZWxsJywgJ2NvbnRlbnQnLCAndGltZV9zJywgJ3ZhbHVlJ10KICAgIGJhc2VsaW5lX2VuZF90aW1lIDogZmxvYXQKICAgICAgICBNYXhpbXVtIHRpbWUgKGluIHNlY29uZHMpIGZvciBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQ6IDI0LjApCiAgICBiYXNlbGluZV9tZXRob2QgOiBzdHIKICAgICAgICBCYXNlbGluZSBmaXR0aW5nIG1ldGhvZDogJ2xvd2VzcycsICdjb25zdGFudCcsIG9yICdwb2x5bm9taWFsJyAoZGVmYXVsdDogJ2NvbnN0YW50JykKICAgIGJhc2VsaW5lX2ZyYWMgOiBmbG9hdAogICAgICAgIEZyYWN0aW9uIG9mIGRhdGEgdXNlZCBmb3IgTE9XRVNTIHNtb290aGluZyAoZGVmYXVsdDogMC41KQogICAgYmFzZWxpbmVfcG9seV9vcmRlciA6IGludAogICAgICAgIFBvbHlub21pYWwgb3JkZXIgZm9yIHBvbHlub21pYWwgZml0IChkZWZhdWx0OiAxKQogICAgbm9ybWFsaXphdGlvbl9tb2RlIDogc3RyCiAgICAgICAgTm9ybWFsaXphdGlvbiBtb2RlOiAnZGVsdGFfZl9vdmVyX2YnIG9yICdtdWx0aXBsaWNhdGl2ZScgKGRlZmF1bHQ6ICdtdWx0aXBsaWNhdGl2ZScpCiAgICBjb25maWcgOiBEaWN0W3N0ciwgQW55XSwgb3B0aW9uYWwKICAgICAgICBDb25maWd1cmF0aW9uIGRpY3Rpb25hcnkuIElmIE5vbmUsIGxvYWRzIGZyb20gcGxhdGVfY29uZmlnLmpzb24KICAgIG91dHB1dF9kaXIgOiBzdHIsIG9wdGlvbmFsCiAgICAgICAgRGlyZWN0b3J5IHRvIHNhdmUgb3V0cHV0cy4gSWYgTm9uZSwgdXNlcyBjdXJyZW50IGRpcmVjdG9yeS4KICAgIAogICAgUmV0dXJuczoKICAgIC0tLS0tLS0tCiAgICB0dXBsZQogICAgICAgIChub3JtX2RmLCBzdGF0c19kZiwgYmFzZWxpbmVfZml0cykKICAgICAgICAtIG5vcm1fZGY6IE5vcm1hbGl6ZWQgRGF0YUZyYW1lCiAgICAgICAgLSBzdGF0c19kZjogQ29uZGl0aW9uIHN0YXRpc3RpY3MgRGF0YUZyYW1lCiAgICAgICAgLSBiYXNlbGluZV9maXRzOiBEaWN0aW9uYXJ5IG9mIGJhc2VsaW5lIGZpdHMgcGVyIHdlbGwKICAgICIiIgogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgiQkFTRUxJTkUgSURFTlRJRklDQVRJT04gQU5EIE5PUk1BTElaQVRJT04gUElQRUxJTkUiKQogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludChmIlxuQ3VycmVudCBTZXR0aW5nczoiKQogICAgcHJpbnQoZiIgIEJhc2VsaW5lIHdpbmRvdzogVGltZV9zIDw9IHtiYXNlbGluZV9lbmRfdGltZX0gcyIpCiAgICBwcmludChmIiAgQmFzZWxpbmUgbWV0aG9kOiB7YmFzZWxpbmVfbWV0aG9kfSIpCiAgICBpZiBiYXNlbGluZV9tZXRob2QgPT0gJ2xvd2Vzcyc6CiAgICAgICAgcHJpbnQoZiIgICAgTE9XRVNTIHNtb290aGluZyBmcmFjdGlvbiAoZnJhYyk6IHtiYXNlbGluZV9mcmFjfSIpCiAgICBlbGlmIGJhc2VsaW5lX21ldGhvZCA9PSAncG9seW5vbWlhbCc6CiAgICAgICAgcHJpbnQoZiIgICAgUG9seW5vbWlhbCBvcmRlcjoge2Jhc2VsaW5lX3BvbHlfb3JkZXJ9IikKICAgIHByaW50KGYiICBOb3JtYWxpemF0aW9uIG1vZGU6IHtub3JtYWxpemF0aW9uX21vZGV9IikKICAgIHByaW50KCkKICAgIHByaW50KCJGb3IgZGV0YWlsZWQgb3B0aW9uIGRlc2NyaXB0aW9ucywgY2FsbDogcHJpbnRfYmFzZWxpbmVfb3B0aW9ucygpIikKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoKQogICAgCiAgICAjIExvYWQgY29uZmlnIGlmIG5vdCBwcm92aWRlZAogICAgaWYgY29uZmlnIGlzIE5vbmU6CiAgICAgICAgc2NyaXB0X2RpciA9IG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmFic3BhdGgoX19maWxlX18pKQogICAgICAgIGNvbmZpZ19wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJwbGF0ZV9jb25maWcuanNvbiIpCiAgICAgICAgY29uZmlnID0gbG9hZF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAKICAgICMgRmlsdGVyIG91dCBiYWQgd2VsbHMgYmVmb3JlIHByb2Nlc3NpbmcKICAgIGJhZF93ZWxsc19saXN0ID0gY29uZmlnLmdldCgiYmFkX3dlbGxzIiwgW10pCiAgICBpZiBiYWRfd2VsbHNfbGlzdDoKICAgICAgICBvcmlnaW5hbF9jb3VudCA9IGxlbihkZikKICAgICAgICBkZiA9IGRmW35kZlsid2VsbCJdLmFwcGx5KGxhbWJkYSB3OiBpc19iYWRfd2VsbCh3LCBjb25maWcpKV0KICAgICAgICBmaWx0ZXJlZF9jb3VudCA9IGxlbihkZikKICAgICAgICBpZiBvcmlnaW5hbF9jb3VudCAhPSBmaWx0ZXJlZF9jb3VudDoKICAgICAgICAgICAgcHJpbnQoZiJFeGNsdWRpbmcge29yaWdpbmFsX2NvdW50IC0gZmlsdGVyZWRfY291bnR9IGRhdGEgcG9pbnRzIGZyb20gYmFkIHdlbGxzIiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgcHJpbnQoIlN0ZXAgMTogSWRlbnRpZnlpbmcgYmFzZWxpbmUgd2luZG93cy4uLiIsIGZsdXNoPVRydWUpCiAgICBiYXNlbGluZV93aW5kb3dzID0gaWRlbnRpZnlfYmFzZWxpbmVfd2luZG93KGRmLCBiYXNlbGluZV9lbmRfdGltZSkKICAgIHByaW50KGYiICBJZGVudGlmaWVkIGJhc2VsaW5lIHdpbmRvd3MgZm9yIHtsZW4oYmFzZWxpbmVfd2luZG93cyl9IHdlbGxzIiwgZmx1c2g9VHJ1ZSkKICAgIHRvdGFsX2Jhc2VsaW5lX3BvaW50cyA9IHN1bShsZW4oYncpIGZvciBidyBpbiBiYXNlbGluZV93aW5kb3dzLnZhbHVlcygpKQogICAgcHJpbnQoZiIgIFRvdGFsIGJhc2VsaW5lIHBvaW50czoge3RvdGFsX2Jhc2VsaW5lX3BvaW50c30iLCBmbHVzaD1UcnVlKQogICAgCiAgICBwcmludCgiU3RlcCAyOiBGaXR0aW5nIGJhc2VsaW5lcy4uLiIsIGZsdXNoPVRydWUpCiAgICBiYXNlbGluZV9maXRzID0gZml0X3dlbGxfYmFzZWxpbmVzKAogICAgICAgIGRmLAogICAgICAgIGJhc2VsaW5lX2VuZF90aW1lPWJhc2VsaW5lX2VuZF90aW1lLAogICAgICAgIG1ldGhvZD1iYXNlbGluZV9tZXRob2QsCiAgICAgICAgZnJhYz1iYXNlbGluZV9mcmFjLAogICAgICAgIHBvbHlfb3JkZXI9YmFzZWxpbmVfcG9seV9vcmRlciwKICAgICAgICBjb25maWc9Y29uZmlnCiAgICApCiAgICBwcmludChmIiAgRml0dGVkIGJhc2VsaW5lcyBmb3Ige2xlbihiYXNlbGluZV9maXRzKX0gd2VsbHMiLCBmbHVzaD1UcnVlKQogICAgCiAgICBwcmludCgiU3RlcCAzOiBOb3JtYWxpemluZyB3ZWxscy4uLiIsIGZsdXNoPVRydWUpCiAgICBub3JtX2RmID0gbm9ybWFsaXplX3dlbGxzKGRmLCBiYXNlbGluZV9maXRzLCBub3JtYWxpemF0aW9uX21vZGU9bm9ybWFsaXphdGlvbl9tb2RlKQogICAgcHJpbnQoZiIgIE5vcm1hbGl6ZWQge2xlbihub3JtX2RmKX0gZGF0YSBwb2ludHMiLCBmbHVzaD1UcnVlKQogICAgCiAgICBwcmludCgiU3RlcCA0OiBCdWlsZGluZyBjb25kaXRpb24gbWFwLi4uIiwgZmx1c2g9VHJ1ZSkKICAgIGNvbmRpdGlvbl9tYXAgPSBidWlsZF9jb25kaXRpb25fbWFwKGRmLCBjb25maWc9Y29uZmlnKQogICAgcHJpbnQoZiIgIE1hcHBlZCB7bGVuKGNvbmRpdGlvbl9tYXApfSB3ZWxscyB0byBjb25kaXRpb25zIiwgZmx1c2g9VHJ1ZSkKICAgIGNvbmRpdGlvbl9jb3VudHMgPSB7fQogICAgZm9yIHdlbGxfaWQsIGNvbmRpdGlvbiBpbiBjb25kaXRpb25fbWFwLml0ZW1zKCk6CiAgICAgICAgY29uZGl0aW9uX2NvdW50c1tjb25kaXRpb25dID0gY29uZGl0aW9uX2NvdW50cy5nZXQoY29uZGl0aW9uLCAwKSArIDEKICAgIHByaW50KGYiICBDb25kaXRpb24gZGlzdHJpYnV0aW9uOiIsIGZsdXNoPVRydWUpCiAgICBmb3IgY29uZGl0aW9uLCBjb3VudCBpbiBzb3J0ZWQoY29uZGl0aW9uX2NvdW50cy5pdGVtcygpKToKICAgICAgICBwcmludChmIiAgICB7Y29uZGl0aW9ufToge2NvdW50fSB3ZWxscyIsIGZsdXNoPVRydWUpCiAgICAKICAgIHByaW50KCJTdGVwIDU6IENvbXB1dGluZyBjb25kaXRpb24gc3RhdGlzdGljcy4uLiIsIGZsdXNoPVRydWUpCiAgICBzdGF0c19kZiA9IGNvbXB1dGVfY29uZGl0aW9uX3N0YXRpc3RpY3Mobm9ybV9kZiwgY29uZGl0aW9uX21hcCkKICAgIHByaW50KGYiICBDb21wdXRlZCBzdGF0aXN0aWNzIGZvciB7bGVuKHN0YXRzX2RmKX0gY29uZGl0aW9uLXRpbWVwb2ludCBjb21iaW5hdGlvbnMiLCBmbHVzaD1UcnVlKQogICAgCiAgICAjIFNhdmUgb3V0cHV0cyBpZiBvdXRwdXRfZGlyIGlzIHByb3ZpZGVkCiAgICBpZiBvdXRwdXRfZGlyOgogICAgICAgIGVuc3VyZV9kaXIob3V0cHV0X2RpcikKICAgICAgICAKICAgICAgICBwcmludCgiU3RlcCA2OiBTYXZpbmcgb3V0cHV0cy4uLiIsIGZsdXNoPVRydWUpCiAgICAgICAgCiAgICAgICAgIyBTYXZlIG5vcm1hbGl6ZWQgZGF0YQogICAgICAgIG5vcm1fY3N2X3BhdGggPSBvcy5wYXRoLmpvaW4ob3V0cHV0X2RpciwgIm5vcm1hbGl6ZWRfZGF0YS5jc3YiKQogICAgICAgIG5vcm1fZGYudG9fY3N2KG5vcm1fY3N2X3BhdGgsIGluZGV4PUZhbHNlKQogICAgICAgIHByaW50KGYiICBTYXZlZCBub3JtYWxpemVkIGRhdGEgdG8ge25vcm1fY3N2X3BhdGh9IiwgZmx1c2g9VHJ1ZSkKICAgICAgICAKICAgICAgICAjIFNhdmUgY29uZGl0aW9uIHN0YXRpc3RpY3MKICAgICAgICBzdGF0c19jc3ZfcGF0aCA9IG9zLnBhdGguam9pbihvdXRwdXRfZGlyLCAiY29uZGl0aW9uX3N0YXRpc3RpY3MuY3N2IikKICAgICAgICBzdGF0c19kZi50b19jc3Yoc3RhdHNfY3N2X3BhdGgsIGluZGV4PUZhbHNlKQogICAgICAgIHByaW50KGYiICBTYXZlZCBjb25kaXRpb24gc3RhdGlzdGljcyB0byB7c3RhdHNfY3N2X3BhdGh9IiwgZmx1c2g9VHJ1ZSkKICAgICAgICAKICAgICAgICAjIFNhdmUgcGxvdAogICAgICAgIHBsb3RfcGF0aCA9IG9zLnBhdGguam9pbihvdXRwdXRfZGlyLCAidGltZWNvdXJzZV9wbG90LnBuZyIpCiAgICAgICAgcGxvdF90aW1lY291cnNlKHN0YXRzX2RmLCBzYXZlX3BhdGg9cGxvdF9wYXRoLCBjb25maWc9Y29uZmlnKQogICAgICAgIHByaW50KGYiICBTYXZlZCBwbG90IHRvIHtwbG90X3BhdGh9IiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgcmV0dXJuIG5vcm1fZGYsIHN0YXRzX2RmLCBiYXNlbGluZV9maXRzCgoKZGVmIHByb21wdF9iYXNlbGluZV9zZXR0aW5ncygpOgogICAgIiIiCiAgICBQcm9tcHQgdXNlciBmb3IgYmFzZWxpbmUgYW5kIG5vcm1hbGl6YXRpb24gc2V0dGluZ3MuCiAgICBSZXR1cm5zIGEgdHVwbGUgb2YgKGJhc2VsaW5lX2VuZF90aW1lLCBiYXNlbGluZV9tZXRob2QsIGJhc2VsaW5lX2ZyYWMsIGJhc2VsaW5lX3BvbHlfb3JkZXIsIG5vcm1hbGl6YXRpb25fbW9kZSkKICAgIAogICAgSWYgc3RkaW4gaXMgbm90IGF2YWlsYWJsZSAobm9uLWludGVyYWN0aXZlIG1vZGUpIG9yIGNvbW1hbmQtbGluZSBhcmd1bWVudHMgYXJlIHByb3ZpZGVkLAogICAgcmV0dXJucyBkZWZhdWx0IHZhbHVlcyBvciB2YWx1ZXMgZnJvbSBjb21tYW5kLWxpbmUgYXJndW1lbnRzLgogICAgCiAgICBDb21tYW5kLWxpbmUgYXJndW1lbnRzIChvcHRpb25hbCk6CiAgICAgICAgLS1iYXNlbGluZS1lbmQtdGltZSBGTE9BVAogICAgICAgIC0tYmFzZWxpbmUtbWV0aG9kIHtjb25zdGFudHxsb3dlc3N8cG9seW5vbWlhbH0KICAgICAgICAtLWJhc2VsaW5lLWZyYWMgRkxPQVQgKGZvciBMT1dFU1MpCiAgICAgICAgLS1iYXNlbGluZS1wb2x5LW9yZGVyIElOVCAoZm9yIHBvbHlub21pYWwpCiAgICAgICAgLS1ub3JtYWxpemF0aW9uLW1vZGUge211bHRpcGxpY2F0aXZlfGRlbHRhX2Zfb3Zlcl9mfQogICAgIiIiCiAgICBpbXBvcnQgYXJncGFyc2UKICAgIAogICAgIyBQYXJzZSBjb21tYW5kLWxpbmUgYXJndW1lbnRzIGZpcnN0CiAgICBwYXJzZXIgPSBhcmdwYXJzZS5Bcmd1bWVudFBhcnNlcihhZGRfaGVscD1GYWxzZSkgICMgRG9uJ3Qgc2hvdyBoZWxwLCB3ZSdsbCBoYW5kbGUgcHJvbXB0cwogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgnLS1iYXNlbGluZS1lbmQtdGltZScsIHR5cGU9ZmxvYXQsIGRlZmF1bHQ9Tm9uZSkKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoJy0tYmFzZWxpbmUtbWV0aG9kJywgdHlwZT1zdHIsIGNob2ljZXM9Wydjb25zdGFudCcsICdsb3dlc3MnLCAncG9seW5vbWlhbCddLCBkZWZhdWx0PU5vbmUpCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCctLWJhc2VsaW5lLWZyYWMnLCB0eXBlPWZsb2F0LCBkZWZhdWx0PU5vbmUpCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCctLWJhc2VsaW5lLXBvbHktb3JkZXInLCB0eXBlPWludCwgZGVmYXVsdD1Ob25lKQogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgnLS1ub3JtYWxpemF0aW9uLW1vZGUnLCB0eXBlPXN0ciwgY2hvaWNlcz1bJ211bHRpcGxpY2F0aXZlJywgJ2RlbHRhX2Zfb3Zlcl9mJ10sIGRlZmF1bHQ9Tm9uZSkKICAgIAogICAgIyBQYXJzZSBrbm93biBhcmdzIG9ubHkgKGlnbm9yZSB1bmtub3duIGFyZ3MgdGhhdCBtaWdodCBiZSB1c2VkIGVsc2V3aGVyZSkKICAgIGFyZ3MsIF8gPSBwYXJzZXIucGFyc2Vfa25vd25fYXJncygpCiAgICAKICAgICMgSWYgYWxsIHNldHRpbmdzIHByb3ZpZGVkIHZpYSBjb21tYW5kLWxpbmUsIHVzZSB0aGVtIChub24taW50ZXJhY3RpdmUpCiAgICBpZiBhbGwoW2FyZ3MuYmFzZWxpbmVfZW5kX3RpbWUgaXMgbm90IE5vbmUsIGFyZ3MuYmFzZWxpbmVfbWV0aG9kIGlzIG5vdCBOb25lLCAKICAgICAgICAgICAgYXJncy5ub3JtYWxpemF0aW9uX21vZGUgaXMgbm90IE5vbmVdKToKICAgICAgICBiYXNlbGluZV9lbmRfdGltZSA9IGFyZ3MuYmFzZWxpbmVfZW5kX3RpbWUKICAgICAgICBiYXNlbGluZV9tZXRob2QgPSBhcmdzLmJhc2VsaW5lX21ldGhvZAogICAgICAgIGJhc2VsaW5lX2ZyYWMgPSBhcmdzLmJhc2VsaW5lX2ZyYWMgaWYgYXJncy5iYXNlbGluZV9mcmFjIGlzIG5vdCBOb25lIGVsc2UgMC41CiAgICAgICAgYmFzZWxpbmVfcG9seV9vcmRlciA9IGFyZ3MuYmFzZWxpbmVfcG9seV9vcmRlciBpZiBhcmdzLmJhc2VsaW5lX3BvbHlfb3JkZXIgaXMgbm90IE5vbmUgZWxzZSAxCiAgICAgICAgCiAgICAgICAgcHJpbnQoIlxu4pyTIFVzaW5nIGNvbW1hbmQtbGluZSBzZXR0aW5nczoiKQogICAgICAgIHByaW50KGYiICBCYXNlbGluZSB3aW5kb3cgZW5kIHRpbWU6IHtiYXNlbGluZV9lbmRfdGltZX0gcyIpCiAgICAgICAgcHJpbnQoZiIgIEJhc2VsaW5lIG1ldGhvZDoge2Jhc2VsaW5lX21ldGhvZH0iKQogICAgICAgIGlmIGJhc2VsaW5lX21ldGhvZCA9PSAnbG93ZXNzJzoKICAgICAgICAgICAgcHJpbnQoZiIgIExPV0VTUyBzbW9vdGhpbmcgZnJhY3Rpb246IHtiYXNlbGluZV9mcmFjfSIpCiAgICAgICAgZWxpZiBiYXNlbGluZV9tZXRob2QgPT0gJ3BvbHlub21pYWwnOgogICAgICAgICAgICBwcmludChmIiAgUG9seW5vbWlhbCBvcmRlcjoge2Jhc2VsaW5lX3BvbHlfb3JkZXJ9IikKICAgICAgICBwcmludChmIiAgTm9ybWFsaXphdGlvbiBtb2RlOiB7YXJncy5ub3JtYWxpemF0aW9uX21vZGV9XG4iKQogICAgICAgIHJldHVybiBiYXNlbGluZV9lbmRfdGltZSwgYmFzZWxpbmVfbWV0aG9kLCBiYXNlbGluZV9mcmFjLCBiYXNlbGluZV9wb2x5X29yZGVyLCBhcmdzLm5vcm1hbGl6YXRpb25fbW9kZQogICAgCiAgICAjIENoZWNrIGlmIHN0ZGluIGlzIGF2YWlsYWJsZSAoaW50ZXJhY3RpdmUgbW9kZSkKICAgIGlmIG5vdCBzeXMuc3RkaW4uaXNhdHR5KCk6CiAgICAgICAgcHJpbnQoIlxu4pqg77iPICBSdW5uaW5nIGluIG5vbi1pbnRlcmFjdGl2ZSBtb2RlLiBVc2luZyBkZWZhdWx0IHNldHRpbmdzOiIpCiAgICAgICAgcHJpbnQoIiAgQmFzZWxpbmUgd2luZG93IGVuZCB0aW1lOiAyNC4wIHMiKQogICAgICAgIHByaW50KCIgIEJhc2VsaW5lIG1ldGhvZDogY29uc3RhbnQiKQogICAgICAgIHByaW50KCIgIE5vcm1hbGl6YXRpb24gbW9kZTogbXVsdGlwbGljYXRpdmVcbiIpCiAgICAgICAgcmV0dXJuIDI0LjAsICdjb25zdGFudCcsIDAuNSwgMSwgJ211bHRpcGxpY2F0aXZlJwogICAgCiAgICBwcmludCgiXG4iICsgIj0iICogNzApCiAgICBwcmludCgiQkFTRUxJTkUgQU5EIE5PUk1BTElaQVRJT04gU0VUVElOR1MiKQogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgiXG5UaGVzZSBzZXR0aW5ncyB3aWxsIGJlIHVzZWQgZm9yIENTViBnZW5lcmF0aW9uIGFuZCBub3JtYWxpemF0aW9uLiIpCiAgICBwcmludCgiWW91IGNhbiBjaGFuZ2UgdGhlbSBsYXRlciBpbiB0aGUgd2ViIGludGVyZmFjZSBmb3IgdmlzdWFsaXphdGlvbi4iKQogICAgcHJpbnQoIihQcmVzcyBFbnRlciB0byBhY2NlcHQgZGVmYXVsdHMpXG4iKQogICAgCiAgICAjIFByb21wdCBmb3IgYmFzZWxpbmUgZW5kIHRpbWUgKHVzZSBjb21tYW5kLWxpbmUgYXJnIGlmIHByb3ZpZGVkKQogICAgYmFzZWxpbmVfZW5kX3RpbWUgPSBOb25lCiAgICBpZiBhcmdzLmJhc2VsaW5lX2VuZF90aW1lIGlzIG5vdCBOb25lOgogICAgICAgIGJhc2VsaW5lX2VuZF90aW1lID0gYXJncy5iYXNlbGluZV9lbmRfdGltZQogICAgICAgIHByaW50KGYiQmFzZWxpbmUgd2luZG93IGVuZCB0aW1lOiB7YmFzZWxpbmVfZW5kX3RpbWV9IHMgKGZyb20gY29tbWFuZC1saW5lKSIpCiAgICBlbHNlOgogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGJhc2VsaW5lX2lucHV0ID0gaW5wdXQoIkJhc2VsaW5lIHdpbmRvdyBlbmQgdGltZSAoc2Vjb25kcykgW2RlZmF1bHQ6IDI0LjBdOiAiKS5zdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBub3QgYmFzZWxpbmVfaW5wdXQ6CiAgICAgICAgICAgICAgICAgICAgYmFzZWxpbmVfZW5kX3RpbWUgPSAyNC4wCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGJhc2VsaW5lX2VuZF90aW1lID0gZmxvYXQoYmFzZWxpbmVfaW5wdXQpCiAgICAgICAgICAgICAgICAgICAgaWYgYmFzZWxpbmVfZW5kX3RpbWUgPD0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoIiAg4pqg77iPICBQbGVhc2UgZW50ZXIgYSBwb3NpdGl2ZSBudW1iZXIuIikKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGV4Y2VwdCAoVmFsdWVFcnJvciwgRU9GRXJyb3IsIEtleWJvYXJkSW50ZXJydXB0KToKICAgICAgICAgICAgICAgIHByaW50KCJcbiAg4pqg77iPICBVc2luZyBkZWZhdWx0IHZhbHVlOiAyNC4wIikKICAgICAgICAgICAgICAgIGJhc2VsaW5lX2VuZF90aW1lID0gMjQuMAogICAgICAgICAgICAgICAgYnJlYWsKICAgIAogICAgIyBQcm9tcHQgZm9yIGJhc2VsaW5lIG1ldGhvZCAodXNlIGNvbW1hbmQtbGluZSBhcmcgaWYgcHJvdmlkZWQpCiAgICBpZiBhcmdzLmJhc2VsaW5lX21ldGhvZCBpcyBub3QgTm9uZToKICAgICAgICBiYXNlbGluZV9tZXRob2QgPSBhcmdzLmJhc2VsaW5lX21ldGhvZAogICAgICAgIHByaW50KGYiXG5CYXNlbGluZSBtZXRob2Q6IHtiYXNlbGluZV9tZXRob2R9IChmcm9tIGNvbW1hbmQtbGluZSkiKQogICAgZWxzZToKICAgICAgICBwcmludCgiXG5CYXNlbGluZSBmaXR0aW5nIG1ldGhvZDoiKQogICAgICAgIHByaW50KCIgIDEuIGNvbnN0YW50IC0gTWVhbiBvZiBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQpIikKICAgICAgICBwcmludCgiICAyLiBsb3dlc3MgLSBMb2NhbGx5IFdlaWdodGVkIFNjYXR0ZXJwbG90IFNtb290aGluZyIpCiAgICAgICAgcHJpbnQoIiAgMy4gcG9seW5vbWlhbCAtIFBvbHlub21pYWwgZml0IikKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBtZXRob2RfaW5wdXQgPSBpbnB1dCgiU2VsZWN0IG1ldGhvZCBbMS0zLCBkZWZhdWx0OiAxXTogIikuc3RyaXAoKQogICAgICAgICAgICAgICAgaWYgbm90IG1ldGhvZF9pbnB1dDoKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9tZXRob2QgPSAnY29uc3RhbnQnCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsaWYgbWV0aG9kX2lucHV0ID09ICcxJzoKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9tZXRob2QgPSAnY29uc3RhbnQnCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsaWYgbWV0aG9kX2lucHV0ID09ICcyJzoKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9tZXRob2QgPSAnbG93ZXNzJwogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBlbGlmIG1ldGhvZF9pbnB1dCA9PSAnMyc6CiAgICAgICAgICAgICAgICAgICAgYmFzZWxpbmVfbWV0aG9kID0gJ3BvbHlub21pYWwnCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoIiAg4pqg77iPICBQbGVhc2UgZW50ZXIgMSwgMiwgb3IgMy4iKQogICAgICAgICAgICBleGNlcHQgKEVPRkVycm9yLCBLZXlib2FyZEludGVycnVwdCk6CiAgICAgICAgICAgICAgICBwcmludCgiXG4gIOKaoO+4jyAgVXNpbmcgZGVmYXVsdCBtZXRob2Q6IGNvbnN0YW50IikKICAgICAgICAgICAgICAgIGJhc2VsaW5lX21ldGhvZCA9ICdjb25zdGFudCcKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAKICAgICMgUHJvbXB0IGZvciBMT1dFU1MgZnJhYyAoaWYgTE9XRVNTIHNlbGVjdGVkKQogICAgaWYgYXJncy5iYXNlbGluZV9mcmFjIGlzIG5vdCBOb25lOgogICAgICAgIGJhc2VsaW5lX2ZyYWMgPSBhcmdzLmJhc2VsaW5lX2ZyYWMKICAgICAgICBpZiBiYXNlbGluZV9tZXRob2QgPT0gJ2xvd2Vzcyc6CiAgICAgICAgICAgIHByaW50KGYiTE9XRVNTIHNtb290aGluZyBmcmFjdGlvbjoge2Jhc2VsaW5lX2ZyYWN9IChmcm9tIGNvbW1hbmQtbGluZSkiKQogICAgZWxzZToKICAgICAgICBiYXNlbGluZV9mcmFjID0gMC41CiAgICAgICAgaWYgYmFzZWxpbmVfbWV0aG9kID09ICdsb3dlc3MnOgogICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGZyYWNfaW5wdXQgPSBpbnB1dCgiTE9XRVNTIHNtb290aGluZyBmcmFjdGlvbiAoMC4xLTEuMCkgW2RlZmF1bHQ6IDAuNV06ICIpLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgZnJhY19pbnB1dDoKICAgICAgICAgICAgICAgICAgICAgICAgYmFzZWxpbmVfZnJhYyA9IDAuNQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2VsaW5lX2ZyYWMgPSBmbG9hdChmcmFjX2lucHV0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiBiYXNlbGluZV9mcmFjIDwgMC4xIG9yIGJhc2VsaW5lX2ZyYWMgPiAxLjA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludCgiICDimqDvuI8gIFBsZWFzZSBlbnRlciBhIHZhbHVlIGJldHdlZW4gMC4xIGFuZCAxLjAuIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGV4Y2VwdCAoVmFsdWVFcnJvciwgRU9GRXJyb3IsIEtleWJvYXJkSW50ZXJydXB0KToKICAgICAgICAgICAgICAgICAgICBwcmludCgiXG4gIOKaoO+4jyAgVXNpbmcgZGVmYXVsdCB2YWx1ZTogMC41IikKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9mcmFjID0gMC41CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgIAogICAgIyBQcm9tcHQgZm9yIHBvbHlub21pYWwgb3JkZXIgKGlmIHBvbHlub21pYWwgc2VsZWN0ZWQpCiAgICBpZiBhcmdzLmJhc2VsaW5lX3BvbHlfb3JkZXIgaXMgbm90IE5vbmU6CiAgICAgICAgYmFzZWxpbmVfcG9seV9vcmRlciA9IGFyZ3MuYmFzZWxpbmVfcG9seV9vcmRlcgogICAgICAgIGlmIGJhc2VsaW5lX21ldGhvZCA9PSAncG9seW5vbWlhbCc6CiAgICAgICAgICAgIHByaW50KGYiUG9seW5vbWlhbCBvcmRlcjoge2Jhc2VsaW5lX3BvbHlfb3JkZXJ9IChmcm9tIGNvbW1hbmQtbGluZSkiKQogICAgZWxzZToKICAgICAgICBiYXNlbGluZV9wb2x5X29yZGVyID0gMQogICAgICAgIGlmIGJhc2VsaW5lX21ldGhvZCA9PSAncG9seW5vbWlhbCc6CiAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgb3JkZXJfaW5wdXQgPSBpbnB1dCgiUG9seW5vbWlhbCBvcmRlciAoMS01KSBbZGVmYXVsdDogMV06ICIpLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgb3JkZXJfaW5wdXQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2VsaW5lX3BvbHlfb3JkZXIgPSAxCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgYmFzZWxpbmVfcG9seV9vcmRlciA9IGludChvcmRlcl9pbnB1dCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYmFzZWxpbmVfcG9seV9vcmRlciA8IDEgb3IgYmFzZWxpbmVfcG9seV9vcmRlciA+IDU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludCgiICDimqDvuI8gIFBsZWFzZSBlbnRlciBhIHZhbHVlIGJldHdlZW4gMSBhbmQgNS4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgZXhjZXB0IChWYWx1ZUVycm9yLCBFT0ZFcnJvciwgS2V5Ym9hcmRJbnRlcnJ1cHQpOgogICAgICAgICAgICAgICAgICAgIHByaW50KCJcbiAg4pqg77iPICBVc2luZyBkZWZhdWx0IHZhbHVlOiAxIikKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9wb2x5X29yZGVyID0gMQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAKICAgICMgUHJvbXB0IGZvciBub3JtYWxpemF0aW9uIG1vZGUgKHVzZSBjb21tYW5kLWxpbmUgYXJnIGlmIHByb3ZpZGVkKQogICAgaWYgYXJncy5ub3JtYWxpemF0aW9uX21vZGUgaXMgbm90IE5vbmU6CiAgICAgICAgbm9ybWFsaXphdGlvbl9tb2RlID0gYXJncy5ub3JtYWxpemF0aW9uX21vZGUKICAgICAgICBwcmludChmIlxuTm9ybWFsaXphdGlvbiBtb2RlOiB7bm9ybWFsaXphdGlvbl9tb2RlfSAoZnJvbSBjb21tYW5kLWxpbmUpIikKICAgIGVsc2U6CiAgICAgICAgcHJpbnQoIlxuTm9ybWFsaXphdGlvbiBtb2RlOiIpCiAgICAgICAgcHJpbnQoIiAgMS4gbXVsdGlwbGljYXRpdmUgLSBGKHQpIC8gZyh0KSAoZGVmYXVsdCkiKQogICAgICAgIHByaW50KCIgIDIuIGRlbHRhX2Zfb3Zlcl9mIC0gKEYodCkgLSBnKHQpKSAvIGcodCkiKQogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG5vcm1faW5wdXQgPSBpbnB1dCgiU2VsZWN0IG1vZGUgWzEtMiwgZGVmYXVsdDogMV06ICIpLnN0cmlwKCkKICAgICAgICAgICAgICAgIGlmIG5vdCBub3JtX2lucHV0OgogICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6YXRpb25fbW9kZSA9ICdtdWx0aXBsaWNhdGl2ZScKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgZWxpZiBub3JtX2lucHV0ID09ICcxJzoKICAgICAgICAgICAgICAgICAgICBub3JtYWxpemF0aW9uX21vZGUgPSAnbXVsdGlwbGljYXRpdmUnCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsaWYgbm9ybV9pbnB1dCA9PSAnMic6CiAgICAgICAgICAgICAgICAgICAgbm9ybWFsaXphdGlvbl9tb2RlID0gJ2RlbHRhX2Zfb3Zlcl9mJwogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHByaW50KCIgIOKaoO+4jyAgUGxlYXNlIGVudGVyIDEgb3IgMi4iKQogICAgICAgICAgICBleGNlcHQgKEVPRkVycm9yLCBLZXlib2FyZEludGVycnVwdCk6CiAgICAgICAgICAgICAgICBwcmludCgiXG4gIOKaoO+4jyAgVXNpbmcgZGVmYXVsdCBtb2RlOiBtdWx0aXBsaWNhdGl2ZSIpCiAgICAgICAgICAgICAgICBub3JtYWxpemF0aW9uX21vZGUgPSAnbXVsdGlwbGljYXRpdmUnCiAgICAgICAgICAgICAgICBicmVhawogICAgCiAgICAjIE9ubHkgcHJpbnQgc3VtbWFyeSBpZiB3ZSBwcm9tcHRlZCAobm90IGlmIGFsbCBzZXR0aW5ncyBjYW1lIGZyb20gY29tbWFuZC1saW5lKQogICAgaWYgbm90IGFsbChbYXJncy5iYXNlbGluZV9lbmRfdGltZSBpcyBub3QgTm9uZSwgYXJncy5iYXNlbGluZV9tZXRob2QgaXMgbm90IE5vbmUsIAogICAgICAgICAgICAgICAgYXJncy5ub3JtYWxpemF0aW9uX21vZGUgaXMgbm90IE5vbmVdKToKICAgICAgICBwcmludCgiXG4iICsgIj0iICogNzApCiAgICAgICAgcHJpbnQoIlNFTEVDVEVEIFNFVFRJTkdTOiIpCiAgICAgICAgcHJpbnQoZiIgIEJhc2VsaW5lIHdpbmRvdyBlbmQgdGltZToge2Jhc2VsaW5lX2VuZF90aW1lfSBzIikKICAgICAgICBwcmludChmIiAgQmFzZWxpbmUgbWV0aG9kOiB7YmFzZWxpbmVfbWV0aG9kfSIpCiAgICAgICAgaWYgYmFzZWxpbmVfbWV0aG9kID09ICdsb3dlc3MnOgogICAgICAgICAgICBwcmludChmIiAgTE9XRVNTIHNtb290aGluZyBmcmFjdGlvbjoge2Jhc2VsaW5lX2ZyYWN9IikKICAgICAgICBlbGlmIGJhc2VsaW5lX21ldGhvZCA9PSAncG9seW5vbWlhbCc6CiAgICAgICAgICAgIHByaW50KGYiICBQb2x5bm9taWFsIG9yZGVyOiB7YmFzZWxpbmVfcG9seV9vcmRlcn0iKQogICAgICAgIHByaW50KGYiICBOb3JtYWxpemF0aW9uIG1vZGU6IHtub3JtYWxpemF0aW9uX21vZGV9IikKICAgICAgICBwcmludCgiPSIgKiA3MCArICJcbiIpCiAgICAKICAgIHJldHVybiBiYXNlbGluZV9lbmRfdGltZSwgYmFzZWxpbmVfbWV0aG9kLCBiYXNlbGluZV9mcmFjLCBiYXNlbGluZV9wb2x5X29yZGVyLCBub3JtYWxpemF0aW9uX21vZGUKCgpkZWYgbWFpbigpOgogICAgIyBVc2UgdGhlIGRpcmVjdG9yeSB3aGVyZSB0aGlzIHNjcmlwdCBsaXZlcyBhcyB0aGUgd29ya2luZyBkaXJlY3RvcnkKICAgIHNjcmlwdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgIG9zLmNoZGlyKHNjcmlwdF9kaXIpCiAgICAKICAgICMgUHJvbXB0IGZvciBiYXNlbGluZSBhbmQgbm9ybWFsaXphdGlvbiBzZXR0aW5ncwogICAgYmFzZWxpbmVfZW5kX3RpbWUsIGJhc2VsaW5lX21ldGhvZCwgYmFzZWxpbmVfZnJhYywgYmFzZWxpbmVfcG9seV9vcmRlciwgbm9ybWFsaXphdGlvbl9tb2RlID0gcHJvbXB0X2Jhc2VsaW5lX3NldHRpbmdzKCkKCiAgICAjIEZpbmQgRXhjZWwgZmlsZXMgaW4gdGhpcyBkaXJlY3RvcnkKICAgIGV4Y2VsX2ZpbGVzID0gWwogICAgICAgIGYgZm9yIGYgaW4gb3MubGlzdGRpcigiLiIpCiAgICAgICAgaWYgZi5sb3dlcigpLmVuZHN3aXRoKCIueGxzeCIpIGFuZCBub3QgZi5zdGFydHN3aXRoKCJ+JCIpCiAgICBdCgogICAgaWYgbm90IGV4Y2VsX2ZpbGVzOgogICAgICAgIHByaW50KCJObyAueGxzeCBmaWxlcyBmb3VuZCBpbiB0aGlzIGZvbGRlci4iLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAgICAgc3lzLmV4aXQoMSkKICAgIAogICAgIyBWYWxpZGF0ZSBmaWxlbmFtZSBmb3JtYXRzIGJlZm9yZSBwcm9jZXNzaW5nCiAgICBwcmludCgiU3RhcnRpbmcgcGxhdGUgdmlld2VyIHNjcmlwdC4uLiIsIGZsdXNoPVRydWUpCiAgICBwcmludCgiVmFsaWRhdGluZyBmaWxlbmFtZSBmb3JtYXRzLi4uIiwgZmx1c2g9VHJ1ZSkKICAgIGludmFsaWRfZmlsZXMgPSBbXQogICAgZm9yIGZuYW1lIGluIGV4Y2VsX2ZpbGVzOgogICAgICAgIHRyeToKICAgICAgICAgICAgdmFsaWRhdGVfZmlsZW5hbWVfZm9ybWF0KGZuYW1lKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yIGFzIGU6CiAgICAgICAgICAgIGludmFsaWRfZmlsZXMuYXBwZW5kKChmbmFtZSwgc3RyKGUpKSkKICAgIAogICAgaWYgaW52YWxpZF9maWxlczoKICAgICAgICBwcmludCgiXG7inYwgRVJST1I6IEludmFsaWQgZmlsZW5hbWUgZm9ybWF0KHMpIGRldGVjdGVkOiIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBmb3IgZm5hbWUsIGVycm9yX21zZyBpbiBpbnZhbGlkX2ZpbGVzOgogICAgICAgICAgICBwcmludChmIlxuRmlsZToge2ZuYW1lfSIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICAgICAgcHJpbnQoZXJyb3JfbXNnLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAgICAgcHJpbnQoIlxuUGxlYXNlIHJlbmFtZSB0aGUgZmlsZShzKSB0byBtYXRjaCB0aGUgZXhwZWN0ZWQgZm9ybWF0IGFuZCByZXJ1biB0aGUgc2NyaXB0LiIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBzeXMuZXhpdCgxKQogICAgCiAgICBwcmludChmIuKckyBBbGwge2xlbihleGNlbF9maWxlcyl9IGZpbGUocykgaGF2ZSB2YWxpZCBmaWxlbmFtZSBmb3JtYXRzIiwgZmx1c2g9VHJ1ZSkKCiAgICBhbGxfcGxhdGVzOiBEaWN0W3N0ciwgcGQuRGF0YUZyYW1lXSA9IHt9CiAgICBjc3Zfcm9vdCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAiY3N2IikKICAgIAogICAgIyBEZWxldGUgb2xkIENTViBmb2xkZXIgaWYgaXQgZXhpc3RzCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhjc3Zfcm9vdCk6CiAgICAgICAgcHJpbnQoZiJEZWxldGluZyBleGlzdGluZyBDU1YgZm9sZGVyOiB7Y3N2X3Jvb3R9IiwgZmx1c2g9VHJ1ZSkKICAgICAgICBzaHV0aWwucm10cmVlKGNzdl9yb290KQogICAgCiAgICAjIExvYWQgY29uZmlndXJhdGlvbiBmaWxlIGVhcmx5IHNvIGl0IGNhbiBiZSB1c2VkIGZvciBDU1YgZ2VuZXJhdGlvbgogICAgY29uZmlnX3BhdGggPSBvcy5wYXRoLmpvaW4oc2NyaXB0X2RpciwgInBsYXRlX2NvbmZpZy5qc29uIikKICAgIGNvbmZpZyA9IGxvYWRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgCiAgICAjIFRyYWNrIHBsYXRlX2lkcyBhbmQgdGhlaXIgc291cmNlIGZpbGVzIHRvIGRldGVjdCBkdXBsaWNhdGVzCiAgICBwbGF0ZV9pZF90b19maWxlczogRGljdFtzdHIsIExpc3Rbc3RyXV0gPSB7fQogICAgIyBUcmFjayBwbGF0ZV9pZCB0byBvcmlnaW5hbCBmaWxlbmFtZSBtYXBwaW5nCiAgICBwbGF0ZV9pZF90b19maWxlbmFtZTogRGljdFtzdHIsIHN0cl0gPSB7fQoKICAgIGZvciBpZHgsIGZuYW1lIGluIGVudW1lcmF0ZShleGNlbF9maWxlcywgMSk6CiAgICAgICAgcHJpbnQoZiJcblt7aWR4fS97bGVuKGV4Y2VsX2ZpbGVzKX1dIFByb2Nlc3Npbmcge2ZuYW1lfS4uLiIsIGZsdXNoPVRydWUpCiAgICAgICAgcGF0aCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCBmbmFtZSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvbmdfZGYgPSBwYXJzZV9wbGF0ZV9maWxlKHBhdGgpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkVycm9yIHBhcnNpbmcge2ZuYW1lfToge2V9IiwgZmlsZT1zeXMuc3RkZXJyLCBmbHVzaD1UcnVlKQogICAgICAgICAgICBjb250aW51ZQoKICAgICAgICBwbGF0ZV9pZCA9IGxvbmdfZGZbInBsYXRlX2lkIl0uaWxvY1swXQogICAgICAgIAogICAgICAgICMgVHJhY2sgd2hpY2ggZmlsZXMgcHJvZHVjZSB3aGljaCBwbGF0ZV9pZAogICAgICAgIGlmIHBsYXRlX2lkIG5vdCBpbiBwbGF0ZV9pZF90b19maWxlczoKICAgICAgICAgICAgcGxhdGVfaWRfdG9fZmlsZXNbcGxhdGVfaWRdID0gW10KICAgICAgICBwbGF0ZV9pZF90b19maWxlc1twbGF0ZV9pZF0uYXBwZW5kKGZuYW1lKQogICAgICAgIAogICAgICAgICMgVHJhY2sgZmlsZW5hbWUgZm9yIHRoaXMgcGxhdGVfaWQgKHVzZSBmaXJzdCBvY2N1cnJlbmNlKQogICAgICAgIGlmIHBsYXRlX2lkIG5vdCBpbiBwbGF0ZV9pZF90b19maWxlbmFtZToKICAgICAgICAgICAgcGxhdGVfaWRfdG9fZmlsZW5hbWVbcGxhdGVfaWRdID0gZm5hbWUKICAgICAgICAKICAgICAgICAjIElmIHRoaXMgcGxhdGVfaWQgYWxyZWFkeSBleGlzdHMsIG1ha2UgaXQgdW5pcXVlIGJ5IGFwcGVuZGluZyBmaWxlbmFtZQogICAgICAgIGlmIHBsYXRlX2lkIGluIGFsbF9wbGF0ZXM6CiAgICAgICAgICAgICMgVGhpcyBpcyBhIGR1cGxpY2F0ZSAtIHdlJ2xsIGhhbmRsZSBpdCBiZWxvdwogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYWxsX3BsYXRlc1twbGF0ZV9pZF0gPSBsb25nX2RmCiAgICAgICAgICAgIHdyaXRlX2NzdnNfZm9yX3BsYXRlKAogICAgICAgICAgICAgICAgbG9uZ19kZiwgCiAgICAgICAgICAgICAgICBjc3Zfcm9vdCwgCiAgICAgICAgICAgICAgICBjb25maWcsIAogICAgICAgICAgICAgICAgZm5hbWUsCiAgICAgICAgICAgICAgICBiYXNlbGluZV9lbmRfdGltZT1iYXNlbGluZV9lbmRfdGltZSwKICAgICAgICAgICAgICAgIGJhc2VsaW5lX21ldGhvZD1iYXNlbGluZV9tZXRob2QsCiAgICAgICAgICAgICAgICBiYXNlbGluZV9mcmFjPWJhc2VsaW5lX2ZyYWMsCiAgICAgICAgICAgICAgICBiYXNlbGluZV9wb2x5X29yZGVyPWJhc2VsaW5lX3BvbHlfb3JkZXIsCiAgICAgICAgICAgICAgICBub3JtYWxpemF0aW9uX21vZGU9bm9ybWFsaXphdGlvbl9tb2RlCiAgICAgICAgICAgICkKCiAgICAjIENoZWNrIGZvciBkdXBsaWNhdGVzIGFuZCB3YXJuCiAgICBkdXBsaWNhdGVzX2ZvdW5kID0gRmFsc2UKICAgIGZvciBwbGF0ZV9pZCwgZmlsZXMgaW4gcGxhdGVfaWRfdG9fZmlsZXMuaXRlbXMoKToKICAgICAgICBpZiBsZW4oZmlsZXMpID4gMToKICAgICAgICAgICAgZHVwbGljYXRlc19mb3VuZCA9IFRydWUKICAgICAgICAgICAgcHJpbnQoZiJcbuKaoO+4jyAgV0FSTklORzogRHVwbGljYXRlIGRhdGFzZXQgZGV0ZWN0ZWQhIiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgICAgICBwcmludChmIiAgIFBsYXRlIElEICd7cGxhdGVfaWR9JyBpcyBwcm9kdWNlZCBieSBtdWx0aXBsZSBmaWxlczoiLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAgICAgICAgIGZvciBmIGluIGZpbGVzOgogICAgICAgICAgICAgICAgcHJpbnQoZiIgICAgIC0ge2Z9IiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgICAgICBwcmludChmIiAgIFBsZWFzZSBkZWxldGUgdGhlIGR1cGxpY2F0ZSBmaWxlKHMpIGFuZCByZXJ1biB0aGUgc2NyaXB0LiIsIGZpbGU9c3lzLnN0ZGVycikKICAgIAogICAgaWYgZHVwbGljYXRlc19mb3VuZDoKICAgICAgICBwcmludCgiXG7imqDvuI8gIEVSUk9SOiBEdXBsaWNhdGUgZGF0YXNldHMgZm91bmQuIFBsZWFzZSBkZWxldGUgZHVwbGljYXRlcyBhbmQgcmVydW4uIiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgIHByaW50KCIgICBPbmx5IHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGVhY2ggZHVwbGljYXRlIHdpbGwgYmUgaW5jbHVkZWQuIiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgIHN5cy5leGl0KDEpCgogICAgaWYgbm90IGFsbF9wbGF0ZXM6CiAgICAgICAgcHJpbnQoIk5vIHBsYXRlcyB3ZXJlIHN1Y2Nlc3NmdWxseSBwYXJzZWQuIiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgIHN5cy5leGl0KDEpCiAgICAKICAgIHByaW50KGYiXG7inJMgU3VjY2Vzc2Z1bGx5IGxvYWRlZCB7bGVuKGFsbF9wbGF0ZXMpfSBkYXRhc2V0KHMpOiIsIGZsdXNoPVRydWUpCiAgICBmb3IgcGxhdGVfaWQgaW4gc29ydGVkKGFsbF9wbGF0ZXMua2V5cygpKToKICAgICAgICBwcmludChmIiAgIC0ge3BsYXRlX2lkfSIsIGZsdXNoPVRydWUpCgogICAgIyBDb25maWcgYWxyZWFkeSBsb2FkZWQgYWJvdmUKCiAgICAjIEJ1aWxkIEpTT04gZm9yIHZpZXdlcgogICAgd2ViX2RpciA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAid2ViIikKICAgIGVuc3VyZV9kaXIod2ViX2RpcikKICAgIGpzb25fcGF0aCA9IG9zLnBhdGguam9pbih3ZWJfZGlyLCAidmlld2VyX2RhdGEuanNvbiIpCiAgICBidWlsZF92aWV3ZXJfanNvbihhbGxfcGxhdGVzLCBqc29uX3BhdGgsIGNvbmZpZywgcGxhdGVfaWRfdG9fZmlsZW5hbWUpCgogICAgIyBXcml0ZSBIVE1MCiAgICBodG1sX3BhdGggPSBvcy5wYXRoLmpvaW4od2ViX2RpciwgImluZGV4Lmh0bWwiKQogICAgd3JpdGVfaHRtbChodG1sX3BhdGgpCgogICAgIyBDcmVhdGUgZG91YmxlLWNsaWNrYWJsZSBsYXVuY2hlciBmaWxlcwogICAgd2ViX2NvbW1hbmRfcGF0aCwgd2ViX2JhdF9wYXRoID0gd3JpdGVfd2ViX2NvbW1hbmQoc2NyaXB0X2Rpciwgd2ViX2RpcikKCiAgICBwcmludCgiRG9uZS4iLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoIkdlbmVyYXRlZDoiLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoZiIgIENTVnMgaW46IHtjc3Zfcm9vdH0iLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoZiIgIFdlYiB2aWV3ZXI6IHtodG1sX3BhdGh9IiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KGYiICBXZWIgbGF1bmNoZXIgKG1hY09TL0xpbnV4KToge3dlYl9jb21tYW5kX3BhdGh9IiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KGYiICBXZWIgbGF1bmNoZXIgKFdpbmRvd3MpOiB7d2ViX2JhdF9wYXRofSIsIGZsdXNoPVRydWUpCiAgICBwcmludCgiXG5UbyB2aWV3IHRoZSBwbGF0ZXM6IiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KGYiICBtYWNPUy9MaW51eDogRG91YmxlLWNsaWNrICd3ZWIuY29tbWFuZCcgaW4gRmluZGVyLCBvciBydW46IC4vd2ViLmNvbW1hbmQiLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoZiIgIFdpbmRvd3M6IERvdWJsZS1jbGljayAnd2ViLmJhdCcgaW4gRXhwbG9yZXIiLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoIlRoZSBicm93c2VyIHdpbGwgb3BlbiBhdXRvbWF0aWNhbGx5LiIsIGZsdXNoPVRydWUpCgoKaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoKICAgIG1haW4oKQ=="
		
		-- Prompt user for baseline and normalization settings
		set baselineEndTime to "24.0"
		set baselineMethod to "constant"
		set baselineFrac to "0.5"
		set baselinePolyOrder to "1"
		set normalizationMode to "multiplicative"
		
		-- Prompt for baseline window end time
		try
			set baselineEndTimeInput to text returned of (display dialog "Baseline window end time (seconds):" default answer baselineEndTime with title "Baseline Settings" buttons {"Cancel", "OK"} default button "OK")
			if baselineEndTimeInput is not "" then
				set baselineEndTime to baselineEndTimeInput
			end if
		on error
			-- User cancelled, use default
		end try
		
		-- Prompt for baseline method
		try
			set baselineMethodChoice to choose from list {"constant", "lowess", "polynomial"} with title "Baseline Fitting Method" with prompt "Select baseline fitting method:" default items {baselineMethod} without multiple selections allowed and empty selection allowed
			if baselineMethodChoice is not false then
				set baselineMethod to item 1 of baselineMethodChoice
			end if
		on error
			-- User cancelled, use default
		end try
		
		-- Prompt for LOWESS frac if LOWESS selected
		if baselineMethod is "lowess" then
			try
				set baselineFracInput to text returned of (display dialog "LOWESS smoothing fraction (0.1-1.0):" default answer baselineFrac with title "LOWESS Settings" buttons {"Cancel", "OK"} default button "OK")
				if baselineFracInput is not "" then
					set baselineFrac to baselineFracInput
				end if
			on error
				-- User cancelled, use default
			end try
		end if
		
		-- Prompt for polynomial order if polynomial selected
		if baselineMethod is "polynomial" then
			try
				set baselinePolyOrderInput to text returned of (display dialog "Polynomial order (1-5):" default answer baselinePolyOrder with title "Polynomial Settings" buttons {"Cancel", "OK"} default button "OK")
				if baselinePolyOrderInput is not "" then
					set baselinePolyOrder to baselinePolyOrderInput
				end if
			on error
				-- User cancelled, use default
			end try
		end if
		
		-- Prompt for normalization mode
		try
			set normalizationModeChoice to choose from list {"multiplicative", "delta_f_over_f"} with title "Normalization Mode" with prompt "Select normalization mode:" default items {normalizationMode} without multiple selections allowed and empty selection allowed
			if normalizationModeChoice is not false then
				set normalizationMode to item 1 of normalizationModeChoice
			end if
		on error
			-- User cancelled, use default
		end try
		
		-- Build command-line arguments (properly quoted)
		set pythonArgs to "--baseline-end-time " & quoted form of baselineEndTime & " --baseline-method " & quoted form of baselineMethod & " --normalization-mode " & quoted form of normalizationMode
		if baselineMethod is "lowess" then
			set pythonArgs to pythonArgs & " --baseline-frac " & quoted form of baselineFrac
		end if
		if baselineMethod is "polynomial" then
			set pythonArgs to pythonArgs & " --baseline-poly-order " & quoted form of baselinePolyOrder
		end if
		
		-- Decode and execute the Python code with command-line arguments
		do shell script "cd " & quoted form of folderPath & " && echo " & quoted form of pythonCodeBase64 & " | base64 -d | python3 - " & pythonArgs
		
		display notification "Plate viewer script completed successfully!" with title "Plate Viewer"
		
	on error errMsg
		display alert "Error" message errMsg
	end try
	
	return input
end run
