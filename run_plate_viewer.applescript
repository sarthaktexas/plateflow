-- AppleScript to run plate_viewer.py
-- The Python code is embedded directly in this script (base64 encoded)
-- Required packages will be installed automatically if needed

on run {input, parameters}
	try
		-- Get the selected folder from Finder or Automator
		if input is {} or input is missing value or (count of input) = 0 then
			set selectedFolder to choose folder with prompt "Select a folder containing .xlsx files:"
			if selectedFolder is {} then
				return
			end if
		else
			set selectedFolder to item 1 of input
		end if
		
		-- Get the folder path
		set folderPath to POSIX path of selectedFolder
		
		-- Remove trailing slash if present
		if folderPath ends with "/" then
			set folderPath to text 1 thru -2 of folderPath
		end if
		
		-- Install required Python packages if needed
		set requiredPackages to "pandas numpy scipy matplotlib openpyxl"
		
		-- Try installation with different methods (in order of preference)
		set installSuccess to false
		set lastError to ""
		
		-- Method 1: Try with --user flag (works on most systems, safest)
		try
			do shell script "python3 -m pip install --user " & requiredPackages & " 2>&1"
			set installSuccess to true
		on error installError1
			set lastError to installError1
			-- Method 2: Check Python version and try with --break-system-packages if supported
			try
				set pythonVersion to (do shell script "python3 --version 2>&1 | awk '{print $2}'")
				set pythonMajor to (do shell script "echo " & quoted form of pythonVersion & " | cut -d. -f1")
				set pythonMinor to (do shell script "echo " & quoted form of pythonVersion & " | cut -d. -f2")
				
				if (pythonMajor as integer) >= 3 and (pythonMinor as integer) >= 11 then
					-- Python 3.11+, try with --break-system-packages --user
					try
						do shell script "python3 -m pip install --break-system-packages --user " & requiredPackages & " 2>&1"
						set installSuccess to true
					on error installError2
						set lastError to installError2
						-- Try with --break-system-packages without --user
						try
							do shell script "python3 -m pip install --break-system-packages " & requiredPackages & " 2>&1"
							set installSuccess to true
						on error installError3
							set lastError to installError3
						end try
					end try
				end if
			on error
				-- Version check failed, continue to next method
			end try
			
			-- Method 3: If still not successful, try without any flags (may work if pip is configured)
			if not installSuccess then
				try
					do shell script "python3 -m pip install " & requiredPackages & " 2>&1"
					set installSuccess to true
				on error installError4
					set lastError to installError4
				end try
			end if
			
			-- If all methods failed, show warning but continue
			if not installSuccess then
				display alert "Warning" message "Could not install required packages automatically.\n\nLast error: " & lastError & "\n\nPlease install manually: " & requiredPackages & "\n\nRun: python3 -m pip install --user " & requiredPackages buttons {"Continue", "Cancel"} default button "Continue" as warning
				if button returned of result is "Cancel" then
					return
				end if
			end if
		end try
		
		-- Embedded Python code (base64 encoded)
		set pythonCodeBase64 to "IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwppbXBvcnQgb3MKaW1wb3J0IHN5cwppbXBvcnQganNvbgppbXBvcnQgc2h1dGlsCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBBbnksIExpc3QKCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IG51bXB5IGFzIG5wCgojIC0tLS0tIENPTkZJRyAtLS0tLQojIDM4NC13ZWxsIHBsYXRlOiAxNiByb3dzIChBLVApIHggMjQgY29sdW1uczsgY2hhbmdlIGlmIG5lZWRlZC4KUExBVEVfUk9XUyA9ICJBQkNERUZHSElKS0xNTk9QIiAgIyAxNiByb3dzClBMQVRFX0NPTFMgPSAyNAoKU0hFRVRfTkFNRV9QUkVGRVJSRUQgPSAiVGFibGUgQWxsIERhdGEgcG9pbnRzIiAgIyBmcm9tIHlvdXIgZXhhbXBsZQoKIyBEZWZhdWx0IHdlbGwgbGFiZWxzIGFuZCB0cmlwbGljYXRlIGdyb3VwcwpERUZBVUxUX1dFTExfTEFCRUxTID0gewogICAgIkIxMyI6ICIyNTAtMTAtMiIsCiAgICAiQzEzIjogIjI1MC0xMC0yIiwKICAgICJEMTMiOiAiMjUwLTEwLTIiLAogICAgIkUxMyI6ICI1MDAtMTAtMiIsCiAgICAiRjEzIjogIjUwMC0xMC0yIiwKICAgICJHMTMiOiAiNTAwLTEwLTIiLAogICAgIkgxMyI6ICIyNTAtNS0yIiwKICAgICJJMTMiOiAiMjUwLTUtMiIsCiAgICAiSjEzIjogIjI1MC01LTIiLAogICAgIksxMyI6ICI1MDAtNS0yIiwKICAgICJMMTMiOiAiNTAwLTUtMiIsCiAgICAiTTEzIjogIjUwMC01LTIiLAogICAgIk4xMyI6ICI1MDAtMTAtMiIsCiAgICAiTzEzIjogIjUwMC01LTIiCn0KCiMgQ29sb3IgcGFsZXR0ZSBmb3IgdHJpcGxpY2F0ZSBncm91cHMgLSBtYXRjaGVzIHdlYiBpbnRlcmZhY2UKIyBFYWNoIGdyb3VwIGdldHMgYSBkaXN0aW5jdCBjb2xvciAodXNpbmcgYm9yZGVyIGNvbG9yIGZvciBwbG90cykKVFJJUExJQ0FURV9DT0xPUlMgPSBbCiAgICAiI2ZmNmI2YiIsICAjIFJlZAogICAgIiM0ZWNkYzQiLCAgIyBUZWFsCiAgICAiIzQ1YjdkMSIsICAjIEJsdWUKICAgICIjZjljYTI0IiwgICMgWWVsbG93CiAgICAiIzZjNWNlNyIsICAjIFB1cnBsZQogICAgIiNhMjliZmUiLCAgIyBMaWdodCBQdXJwbGUKICAgICIjZmQ3OWE4IiwgICMgUGluawogICAgIiMwMGI4OTQiLCAgIyBHcmVlbgogICAgIiNlMTcwNTUiLCAgIyBPcmFuZ2UKICAgICIjNzRiOWZmIiwgICMgTGlnaHQgQmx1ZQogICAgIiM1NWVmYzQiLCAgIyBNaW50CiAgICAiI2ZkY2I2ZSIgICAjIExpZ2h0IE9yYW5nZQpdCgpkZWYgaXNfY29udHJvbF93ZWxsKHdlbGxfaWQ6IHN0ciwgY29udHJvbF9yb3dzOiBMaXN0W3N0cl0gPSBOb25lKSAtPiBib29sOgogICAgIiIiCiAgICBDaGVjayBpZiBhIHdlbGwgaXMgYSBjb250cm9sIHdlbGwuCiAgICBEZWZhdWx0IGNvbnRyb2wgcm93cyBhcmUgTiBhbmQgTywgYnV0IHRoaXMgY2FuIGJlIGNvbmZpZ3VyZWQgdmlhIGNvbnRyb2xfcm93cyBwYXJhbWV0ZXIuCiAgICBDb250cm9sIHdlbGxzIHNob3VsZCBiZSBpbmRlcGVuZGVudGx5IHNlbGVjdGFibGUgYW5kIG5vdCBncm91cGVkIGFzIHRyaXBsaWNhdGVzLgogICAgIiIiCiAgICBpZiBub3Qgd2VsbF9pZDoKICAgICAgICByZXR1cm4gRmFsc2UKICAgIGlmIGNvbnRyb2xfcm93cyBpcyBOb25lOgogICAgICAgIGNvbnRyb2xfcm93cyA9IFsiTiIsICJPIl0gICMgRGVmYXVsdCBjb250cm9sIHJvd3MKICAgIHJvd19sZXR0ZXIgPSB3ZWxsX2lkWzBdIGlmIHdlbGxfaWRbMF0uaXNhbHBoYSgpIGVsc2UgIiIKICAgIHJldHVybiByb3dfbGV0dGVyIGluIGNvbnRyb2xfcm93cwoKCmRlZiB2YWxpZGF0ZV9maWxlbmFtZV9mb3JtYXQoZmlsZW5hbWU6IHN0cik6CiAgICAiIiIKICAgIFZhbGlkYXRlIHRoYXQgZmlsZW5hbWUgbWF0Y2hlcyB0aGUgZXhwZWN0ZWQgZm9ybWF0OgogICAgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJbX3NjaWVudGlzdF1bX251bWJlcl0ueGxzeAogICAgCiAgICBFeHBlY3RlZCBmb3JtYXQ6IEF0IGxlYXN0IDMgdW5kZXJzY29yZS1zZXBhcmF0ZWQgcGFydHMgYmVmb3JlIHRoZSAueGxzeCBleHRlbnNpb24uCiAgICBFeGFtcGxlczoKICAgIC0gUExDYl9XVF9DYV9NQy54bHN4ICg0IHBhcnRzKQogICAgLSBQTENiX1dUX0NhX01DXzEzLnhsc3ggKDUgcGFydHMpCiAgICAtIFBMQ2JfSDMzMkFfQ2FfU01fMTIueGxzeCAoNSBwYXJ0cykKICAgIAogICAgUmFpc2VzIFZhbHVlRXJyb3IgaWYgZm9ybWF0IGlzIGludmFsaWQuCiAgICAiIiIKICAgIGlmIG5vdCBmaWxlbmFtZS5sb3dlcigpLmVuZHN3aXRoKCcueGxzeCcpOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiSW52YWxpZCBmaWxlbmFtZSBmb3JtYXQ6ICd7ZmlsZW5hbWV9J1xuIgogICAgICAgICAgICBmIkV4cGVjdGVkIGZvcm1hdDogcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJbX3NjaWVudGlzdF1bX251bWJlcl0ueGxzeFxuIgogICAgICAgICAgICBmIkZpbGVuYW1lIG11c3QgZW5kIHdpdGggLnhsc3ggZXh0ZW5zaW9uLiIKICAgICAgICApCiAgICAKICAgICMgUmVtb3ZlIC54bHN4IGV4dGVuc2lvbgogICAgYmFzZV9uYW1lID0gb3MucGF0aC5zcGxpdGV4dChmaWxlbmFtZSlbMF0KICAgIAogICAgIyBTcGxpdCBieSB1bmRlcnNjb3JlCiAgICBwYXJ0cyA9IGJhc2VfbmFtZS5zcGxpdCgiXyIpCiAgICAKICAgIGlmIGxlbihwYXJ0cykgPCAzOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiSW52YWxpZCBmaWxlbmFtZSBmb3JtYXQ6ICd7ZmlsZW5hbWV9J1xuIgogICAgICAgICAgICBmIkV4cGVjdGVkIGZvcm1hdDogcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJbX3NjaWVudGlzdF1bX251bWJlcl0ueGxzeFxuIgogICAgICAgICAgICBmIlRoZSBmaWxlbmFtZSBtdXN0IGhhdmUgYXQgbGVhc3QgMyB1bmRlcnNjb3JlLXNlcGFyYXRlZCBwYXJ0cyBiZWZvcmUgdGhlIC54bHN4IGV4dGVuc2lvbi5cbiIKICAgICAgICAgICAgZiJGb3VuZCB7bGVuKHBhcnRzKX0gcGFydChzKToge3BhcnRzfVxuIgogICAgICAgICAgICBmIkV4YW1wbGUgdmFsaWQgZm9ybWF0czpcbiIKICAgICAgICAgICAgZiIgIC0gUExDYl9XVF9DYV9NQy54bHN4XG4iCiAgICAgICAgICAgIGYiICAtIFBMQ2JfV1RfQ2FfTUNfMTMueGxzeFxuIgogICAgICAgICAgICBmIiAgLSBQTENiX0gzMzJBX0NhX1NNXzEyLnhsc3giCiAgICAgICAgKQoKCmRlZiBwYXJzZV9jb2x1bW5fZ3JvdXBfZnJvbV9maWxlbmFtZShmaWxlbmFtZTogc3RyKSAtPiBEaWN0W3N0ciwgc3RyXToKICAgICIiIgogICAgUGFyc2UgY29sdW1uIGdyb3VwIGluZm9ybWF0aW9uIGZyb20gZmlsZW5hbWUgZm9ybWF0OgogICAgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJfaW5pdGlhbHMtb2Ytc2NpZW50aXN0X2FyYml0cmFyeS1udW1iZXIueGxzeAogICAgCiAgICBSZXR1cm5zIGEgZGljdGlvbmFyeSB3aXRoOgogICAgLSAiY29sdW1uX2dyb3VwIjogInByb3RlaW5fZ2Vub3R5cGVfYnVmZmVyIiAodXNlZCBmb3IgZ3JvdXBpbmcpCiAgICAtICJwcm90ZWluIjogcHJvdGVpbiBuYW1lCiAgICAtICJnZW5vdHlwZSI6IGdlbm90eXBlCiAgICAtICJidWZmZXIiOiBidWZmZXIKICAgIC0gInNjaWVudGlzdCI6IGluaXRpYWxzLW9mLXNjaWVudGlzdAogICAgLSAibnVtYmVyIjogYXJiaXRyYXJ5LW51bWJlcgogICAgIiIiCiAgICAjIFZhbGlkYXRlIGZpbGVuYW1lIGZvcm1hdCBmaXJzdAogICAgdmFsaWRhdGVfZmlsZW5hbWVfZm9ybWF0KGZpbGVuYW1lKQogICAgCiAgICAjIFJlbW92ZSAueGxzeCBleHRlbnNpb24KICAgIGJhc2VfbmFtZSA9IG9zLnBhdGguc3BsaXRleHQoZmlsZW5hbWUpWzBdCiAgICAKICAgICMgU3BsaXQgYnkgdW5kZXJzY29yZQogICAgcGFydHMgPSBiYXNlX25hbWUuc3BsaXQoIl8iKQogICAgCiAgICAjIEF0IHRoaXMgcG9pbnQgd2Uga25vdyB3ZSBoYXZlIGF0IGxlYXN0IDMgcGFydHMgZHVlIHRvIHZhbGlkYXRpb24KICAgICMgSWYgd2UgaGF2ZSBhdCBsZWFzdCAzIHBhcnRzLCB1c2UgZmlyc3QgMyBmb3IgY29sdW1uX2dyb3VwIChwcm90ZWluX2dlbm90eXBlX2J1ZmZlcikKICAgICMgVGhpcyBoYW5kbGVzIGNhc2VzIGxpa2UgIlBMQ2JfV1RfRUdUQV9NQyIgKDQgcGFydHMpIG9yICJQTENiX1dUX0VHVEFfTUNfMTMiICg1IHBhcnRzKQogICAgcHJvdGVpbiA9IHBhcnRzWzBdCiAgICBnZW5vdHlwZSA9IHBhcnRzWzFdCiAgICBidWZmZXIgPSBwYXJ0c1syXQogICAgc2NpZW50aXN0ID0gcGFydHNbM10gaWYgbGVuKHBhcnRzKSA+IDMgZWxzZSAiIgogICAgbnVtYmVyID0gcGFydHNbNF0gaWYgbGVuKHBhcnRzKSA+IDQgZWxzZSAiIgogICAgCiAgICAjIENvbHVtbiBncm91cCBpcyBhbHdheXMgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXIgKGZpcnN0IDMgcGFydHMpCiAgICBjb2x1bW5fZ3JvdXAgPSBmIntwcm90ZWlufV97Z2Vub3R5cGV9X3tidWZmZXJ9IgogICAgCiAgICByZXR1cm4gewogICAgICAgICJjb2x1bW5fZ3JvdXAiOiBjb2x1bW5fZ3JvdXAsCiAgICAgICAgInByb3RlaW4iOiBwcm90ZWluLAogICAgICAgICJnZW5vdHlwZSI6IGdlbm90eXBlLAogICAgICAgICJidWZmZXIiOiBidWZmZXIsCiAgICAgICAgInNjaWVudGlzdCI6IHNjaWVudGlzdCwKICAgICAgICAibnVtYmVyIjogbnVtYmVyCiAgICB9CiAgICAKICAgICMgSWYgd2UgaGF2ZSBhdCBsZWFzdCAzIHBhcnRzLCB1c2UgZmlyc3QgMyBmb3IgY29sdW1uX2dyb3VwIChwcm90ZWluX2dlbm90eXBlX2J1ZmZlcikKICAgICMgVGhpcyBoYW5kbGVzIGNhc2VzIGxpa2UgIlBMQ2JfV1RfRUdUQV9NQyIgKDQgcGFydHMpIG9yICJQTENiX1dUX0VHVEFfTUNfMTMiICg1IHBhcnRzKQogICAgcHJvdGVpbiA9IHBhcnRzWzBdCiAgICBnZW5vdHlwZSA9IHBhcnRzWzFdCiAgICBidWZmZXIgPSBwYXJ0c1syXQogICAgc2NpZW50aXN0ID0gcGFydHNbM10gaWYgbGVuKHBhcnRzKSA+IDMgZWxzZSAiIgogICAgbnVtYmVyID0gcGFydHNbNF0gaWYgbGVuKHBhcnRzKSA+IDQgZWxzZSAiIgogICAgCiAgICAjIENvbHVtbiBncm91cCBpcyBhbHdheXMgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXIgKGZpcnN0IDMgcGFydHMpCiAgICBjb2x1bW5fZ3JvdXAgPSBmIntwcm90ZWlufV97Z2Vub3R5cGV9X3tidWZmZXJ9IgogICAgCiAgICByZXR1cm4gewogICAgICAgICJjb2x1bW5fZ3JvdXAiOiBjb2x1bW5fZ3JvdXAsCiAgICAgICAgInByb3RlaW4iOiBwcm90ZWluLAogICAgICAgICJnZW5vdHlwZSI6IGdlbm90eXBlLAogICAgICAgICJidWZmZXIiOiBidWZmZXIsCiAgICAgICAgInNjaWVudGlzdCI6IHNjaWVudGlzdCwKICAgICAgICAibnVtYmVyIjogbnVtYmVyCiAgICB9CiAgICAKCgpkZWYgZmluZF9oZWFkZXJfYW5kX3RpbWVfcm93cyhkZjogcGQuRGF0YUZyYW1lKSAtPiAoaW50LCBpbnQpOgogICAgIiIiCiAgICBGaW5kIHRoZSAnV2VsbCcgaGVhZGVyIHJvdyBhbmQgdGhlICdUaW1lIFtzXScgcm93LgogICAgUmV0dXJucyAoaGVhZGVyX3Jvd19pbmRleCwgdGltZV9yb3dfaW5kZXgpLgogICAgIiIiCiAgICBoZWFkZXJfcm93X2lkeCA9IE5vbmUKICAgIHRpbWVfcm93X2lkeCA9IE5vbmUKCiAgICBmb3IgaSBpbiByYW5nZShsZW4oZGYpKToKICAgICAgICBjZWxsMCA9IHN0cihkZi5pYXRbaSwgMF0pIGlmIG5vdCBwZC5pc25hKGRmLmlhdFtpLCAwXSkgZWxzZSAiIgogICAgICAgIGNlbGwxID0gc3RyKGRmLmlhdFtpLCAxXSkgaWYgbm90IHBkLmlzbmEoZGYuaWF0W2ksIDFdKSBlbHNlICIiCiAgICAgICAgaWYgY2VsbDAuc3RyaXAoKSA9PSAiV2VsbCI6CiAgICAgICAgICAgIGhlYWRlcl9yb3dfaWR4ID0gaQogICAgICAgIGlmICJUaW1lIiBpbiBjZWxsMSBhbmQgIltzXSIgaW4gY2VsbDE6CiAgICAgICAgICAgIHRpbWVfcm93X2lkeCA9IGkKCiAgICBpZiBoZWFkZXJfcm93X2lkeCBpcyBOb25lIG9yIHRpbWVfcm93X2lkeCBpcyBOb25lOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIkNvdWxkIG5vdCBmaW5kICdXZWxsJyBoZWFkZXIgcm93IG9yICdUaW1lIFtzXScgcm93IGluIEV4Y2VsIHNoZWV0LiIpCgogICAgaWYgdGltZV9yb3dfaWR4ICE9IGhlYWRlcl9yb3dfaWR4ICsgMToKICAgICAgICAjIE5vdCBmYXRhbCwgYnV0IHdhcm4gaW4gY2FzZSBmb3JtYXQgZHJpZnRzCiAgICAgICAgcHJpbnQoZiJXYXJuaW5nOiBUaW1lIHJvdyAoaW5kZXgge3RpbWVfcm93X2lkeH0pIGlzIG5vdCBkaXJlY3RseSBhZnRlciBoZWFkZXIgcm93IChpbmRleCB7aGVhZGVyX3Jvd19pZHh9KS4iLAogICAgICAgICAgICAgIGZpbGU9c3lzLnN0ZGVycikKCiAgICByZXR1cm4gaGVhZGVyX3Jvd19pZHgsIHRpbWVfcm93X2lkeAoKCmRlZiBwYXJzZV9wbGF0ZV9maWxlKHhsc3hfcGF0aDogc3RyKSAtPiBwZC5EYXRhRnJhbWU6CiAgICAiIiIKICAgIFBhcnNlIGEgc2luZ2xlIEV4Y2VsIGZpbGUgaW50byBhIGxvbmctZm9ybWF0IERhdGFGcmFtZSB3aXRoIGNvbHVtbnM6CiAgICBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgIiIiCiAgICBwcmludChmIlBhcnNpbmcge29zLnBhdGguYmFzZW5hbWUoeGxzeF9wYXRoKX0uLi4iLCBmbHVzaD1UcnVlKQogICAgdHJ5OgogICAgICAgIHByaW50KGYiICBPcGVuaW5nIEV4Y2VsIGZpbGUuLi4iLCBmbHVzaD1UcnVlKQogICAgICAgICMgRXhwbGljaXRseSB1c2Ugb3BlbnB5eGwgZW5naW5lIGZvciAueGxzeCBmaWxlcyB0byBhdm9pZCBoYW5naW5nCiAgICAgICAgeGxzID0gcGQuRXhjZWxGaWxlKHhsc3hfcGF0aCwgZW5naW5lPSdvcGVucHl4bCcpCiAgICAgICAgaWYgU0hFRVRfTkFNRV9QUkVGRVJSRUQgaW4geGxzLnNoZWV0X25hbWVzOgogICAgICAgICAgICBzaGVldF9uYW1lID0gU0hFRVRfTkFNRV9QUkVGRVJSRUQKICAgICAgICBlbHNlOgogICAgICAgICAgICBzaGVldF9uYW1lID0geGxzLnNoZWV0X25hbWVzWzBdCiAgICAgICAgICAgIHByaW50KGYiICBTaGVldCAne1NIRUVUX05BTUVfUFJFRkVSUkVEfScgbm90IGZvdW5kOyB1c2luZyBmaXJzdCBzaGVldCAne3NoZWV0X25hbWV9JyBpbnN0ZWFkLiIsIGZsdXNoPVRydWUpCiAgICAgICAgcHJpbnQoZiIgIFJlYWRpbmcgc2hlZXQgJ3tzaGVldF9uYW1lfScuLi4iLCBmbHVzaD1UcnVlKQogICAgICAgICMgVXNlIHRoZSBzYW1lIGVuZ2luZSBmb3IgcmVhZF9leGNlbAogICAgICAgIGRmID0gcGQucmVhZF9leGNlbCh4bHN4X3BhdGgsIHNoZWV0X25hbWU9c2hlZXRfbmFtZSwgaGVhZGVyPU5vbmUsIGVuZ2luZT0nb3BlbnB5eGwnKQogICAgICAgIHByaW50KGYiICBTaGVldCBsb2FkZWQ6IHtsZW4oZGYpfSByb3dzLCB7bGVuKGRmLmNvbHVtbnMpfSBjb2x1bW5zIiwgZmx1c2g9VHJ1ZSkKICAgICAgICAjIENsb3NlIHRoZSBFeGNlbEZpbGUgdG8gZnJlZSByZXNvdXJjZXMKICAgICAgICB4bHMuY2xvc2UoKQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIkZpbGUgbm90IGZvdW5kOiB7eGxzeF9wYXRofSIpCiAgICBleGNlcHQgUGVybWlzc2lvbkVycm9yOgogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIlBlcm1pc3Npb24gZGVuaWVkOiB7eGxzeF9wYXRofSAoZmlsZSBtYXkgYmUgb3BlbiBpbiBhbm90aGVyIHByb2dyYW0pIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBlcnJvcl90eXBlID0gdHlwZShlKS5fX25hbWVfXwogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIkZhaWxlZCB0byByZWFkIHt4bHN4X3BhdGh9OiB7ZXJyb3JfdHlwZX06IHtlfSIpCgogICAgcHJpbnQoZiIgIEZpbmRpbmcgaGVhZGVyIGFuZCB0aW1lIHJvd3MuLi4iLCBmbHVzaD1UcnVlKQogICAgaGVhZGVyX3Jvd19pZHgsIHRpbWVfcm93X2lkeCA9IGZpbmRfaGVhZGVyX2FuZF90aW1lX3Jvd3MoZGYpCgogICAgIyBUaW1lIHJvdzogY29sdW1uIDEgaXMgIlRpbWUgW3NdIiwgbWVhc3VyZW1lbnQgdGltZXMgc3RhcnQgZnJvbSBjb2x1bW4gMiBvbndhcmQuCiAgICB0aW1lX3JvdyA9IGRmLmlsb2NbdGltZV9yb3dfaWR4XQogICAgdGltZV92YWx1ZXMgPSB0aW1lX3Jvdy5pbG9jWzI6XS50b2xpc3QoKQogICAgIyBDbGVhbiB1cCB0aW1lcwogICAgdGltZV92YWx1ZXNfY2xlYW4gPSBbXQogICAgZm9yIHQgaW4gdGltZV92YWx1ZXM6CiAgICAgICAgaWYgcGQuaXNuYSh0KToKICAgICAgICAgICAgYnJlYWsKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRpbWVfdmFsdWVzX2NsZWFuLmFwcGVuZChmbG9hdCh0KSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAjIFN0b3AgYXQgdGhlIGZpcnN0IG5vbi1udW1lcmljIC8gd2VpcmQgdGhpbmcKICAgICAgICAgICAgYnJlYWsKCiAgICBudW1fdGltZV9wb2ludHMgPSBsZW4odGltZV92YWx1ZXNfY2xlYW4pCiAgICBpZiBudW1fdGltZV9wb2ludHMgPT0gMDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiTm8gdGltZXBvaW50cyBwYXJzZWQgaW4ge3hsc3hfcGF0aH0uIikKCiAgICBwbGF0ZV9pZCA9IG9zLnBhdGguc3BsaXRleHQob3MucGF0aC5iYXNlbmFtZSh4bHN4X3BhdGgpKVswXQoKICAgIHJlY29yZHM6IExpc3RbRGljdFtzdHIsIEFueV1dID0gW10KCiAgICAjIERhdGEgcm93czogZnJvbSB0aW1lX3Jvd19pZHggKyAxIGRvd253YXJkcyB1bnRpbCB3ZSBoaXQgZW1wdHkgIldlbGwiIGNlbGwKICAgIHByaW50KGYiICBQcm9jZXNzaW5nIGRhdGEgcm93cyAoc3RhcnRpbmcgZnJvbSByb3cge3RpbWVfcm93X2lkeCArIDF9KS4uLiIsIGZsdXNoPVRydWUpCiAgICByb3dzX3Byb2Nlc3NlZCA9IDAKICAgIGZvciBpIGluIHJhbmdlKHRpbWVfcm93X2lkeCArIDEsIGxlbihkZikpOgogICAgICAgIHdlbGwgPSBkZi5pYXRbaSwgMF0KICAgICAgICBjb250ZW50ID0gZGYuaWF0W2ksIDFdCgogICAgICAgIGlmIHBkLmlzbmEod2VsbCkgb3Igc3RyKHdlbGwpLnN0cmlwKCkgPT0gIiI6CiAgICAgICAgICAgICMgQXNzdW1lIHdlJ3ZlIHJlYWNoZWQgdGhlIGVuZCBvZiBkYXRhCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHdlbGxfaWQgPSBzdHIod2VsbCkuc3RyaXAoKQogICAgICAgIGNvbnRlbnRfc3RyID0gIiIgaWYgcGQuaXNuYShjb250ZW50KSBlbHNlIHN0cihjb250ZW50KS5zdHJpcCgpCgogICAgICAgIHJvd192YWxzID0gZGYuaWxvY1tpLCAyOjIgKyBudW1fdGltZV9wb2ludHNdLnRvbGlzdCgpCiAgICAgICAgIyBFbnN1cmUgc2FtZSBsZW5ndGggYXMgdGltZSBsaXN0CiAgICAgICAgcm93X3ZhbHMgPSByb3dfdmFsc1s6bnVtX3RpbWVfcG9pbnRzXQoKICAgICAgICBmb3IgdCwgdiBpbiB6aXAodGltZV92YWx1ZXNfY2xlYW4sIHJvd192YWxzKToKICAgICAgICAgICAgaWYgcGQuaXNuYSh2KToKICAgICAgICAgICAgICAgICMgU2tpcCBtaXNzaW5nIHZhbHVlcywgYnV0IGtlZXAgdGltZXBvaW50IGluIG92ZXJhbGwgc2NoZW1lCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB2X2Zsb2F0ID0gZmxvYXQodikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICByZWNvcmRzLmFwcGVuZCgKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAicGxhdGVfaWQiOiBwbGF0ZV9pZCwKICAgICAgICAgICAgICAgICAgICAid2VsbCI6IHdlbGxfaWQsCiAgICAgICAgICAgICAgICAgICAgImNvbnRlbnQiOiBjb250ZW50X3N0ciwKICAgICAgICAgICAgICAgICAgICAidGltZV9zIjogZmxvYXQodCksCiAgICAgICAgICAgICAgICAgICAgInZhbHVlIjogdl9mbG9hdCwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgIAogICAgICAgIHJvd3NfcHJvY2Vzc2VkICs9IDEKICAgICAgICBpZiByb3dzX3Byb2Nlc3NlZCAlIDEwMCA9PSAwOgogICAgICAgICAgICBwcmludChmIiAgICBQcm9jZXNzZWQge3Jvd3NfcHJvY2Vzc2VkfSByb3dzLi4uIiwgZmx1c2g9VHJ1ZSkKCiAgICBwcmludChmIiAgUHJvY2Vzc2VkIHtyb3dzX3Byb2Nlc3NlZH0gcm93cywgY3JlYXRlZCB7bGVuKHJlY29yZHMpfSBkYXRhIHBvaW50cyIsIGZsdXNoPVRydWUpCgogICAgaWYgbm90IHJlY29yZHM6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIk5vIGRhdGEgcm93cyBmb3VuZCBpbiB7eGxzeF9wYXRofSBhZnRlciBwYXJzaW5nLiIpCgogICAgcHJpbnQoZiIgIENyZWF0aW5nIERhdGFGcmFtZS4uLiIsIGZsdXNoPVRydWUpCiAgICBsb25nX2RmID0gcGQuRGF0YUZyYW1lLmZyb21fcmVjb3JkcyhyZWNvcmRzKQogICAgcHJpbnQoZiIgIOKckyBDb21wbGV0ZWQgcGFyc2luZyB7b3MucGF0aC5iYXNlbmFtZSh4bHN4X3BhdGgpfSIsIGZsdXNoPVRydWUpCiAgICByZXR1cm4gbG9uZ19kZgoKCmRlZiBlbnN1cmVfZGlyKHBhdGg6IHN0cik6CiAgICBvcy5tYWtlZGlycyhwYXRoLCBleGlzdF9vaz1UcnVlKQoKCmRlZiB3cml0ZV9jc3ZzX2Zvcl9wbGF0ZSgKICAgIGxvbmdfZGY6IHBkLkRhdGFGcmFtZSwgCiAgICBjc3Zfcm9vdDogc3RyLCAKICAgIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lLCAKICAgIGZpbGVuYW1lOiBzdHIgPSBOb25lLAogICAgYmFzZWxpbmVfc3RhcnRfdGltZTogZmxvYXQgPSAwLjAsCiAgICBiYXNlbGluZV9lbmRfdGltZTogZmxvYXQgPSAyMC4wLAogICAgYmFzZWxpbmVfbWV0aG9kOiBzdHIgPSAnY29uc3RhbnQnLAogICAgYmFzZWxpbmVfZnJhYzogZmxvYXQgPSAwLjUsCiAgICBiYXNlbGluZV9wb2x5X29yZGVyOiBpbnQgPSAxLAogICAgbm9ybWFsaXphdGlvbl9tb2RlOiBzdHIgPSAnbXVsdGlwbGljYXRpdmUnCik6CiAgICAiIiIKICAgIFdyaXRlIENTViBmaWxlczoKICAgICAgLSBjc3Zfcm9vdC88cGxhdGVfaWQ+LzxwbGF0ZV9pZD5fPHdlbGw+LmNzdiAocGVyIHdlbGwsIG5vcm1hbGl6ZWQgdmFsdWVzIHdpdGggYmFzZWxpbmUpCiAgICAgIC0gY3N2X3Jvb3QvPGNvbmRpdGlvbj5fPHRyaXBsaWNhdGVfbmFtZT4uY3N2IChwZXIgY29uZGl0aW9uLXRyaXBsaWNhdGUgY29tYmluYXRpb24sIHVzaW5nIG5vcm1hbGl6ZWQgdmFsdWVzIHdpdGggbWVhbiBhbmQgU0VNKQogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIGxvbmdfZGYgOiBwZC5EYXRhRnJhbWUKICAgICAgICBMb25nLWZvcm1hdCBEYXRhRnJhbWUgd2l0aCBjb2x1bW5zIFsncGxhdGVfaWQnLCAnd2VsbCcsICdjb250ZW50JywgJ3RpbWVfcycsICd2YWx1ZSddCiAgICBjc3Zfcm9vdCA6IHN0cgogICAgICAgIFJvb3QgZGlyZWN0b3J5IGZvciBDU1Ygb3V0cHV0CiAgICBjb25maWcgOiBEaWN0W3N0ciwgQW55XSwgb3B0aW9uYWwKICAgICAgICBDb25maWd1cmF0aW9uIGRpY3Rpb25hcnkKICAgIGZpbGVuYW1lIDogc3RyLCBvcHRpb25hbAogICAgICAgIFNvdXJjZSBmaWxlbmFtZSBmb3IgcGFyc2luZyBjb2x1bW4gaW5mbwogICAgYmFzZWxpbmVfc3RhcnRfdGltZSA6IGZsb2F0CiAgICAgICAgTWluaW11bSB0aW1lIChpbiBzZWNvbmRzKSBmb3IgYmFzZWxpbmUgd2luZG93IChkZWZhdWx0OiAwLjApCiAgICBiYXNlbGluZV9lbmRfdGltZSA6IGZsb2F0CiAgICAgICAgTWF4aW11bSB0aW1lIChpbiBzZWNvbmRzKSBmb3IgYmFzZWxpbmUgd2luZG93IChkZWZhdWx0OiAyMC4wKQogICAgYmFzZWxpbmVfbWV0aG9kIDogc3RyCiAgICAgICAgQmFzZWxpbmUgZml0dGluZyBtZXRob2Q6ICdsb3dlc3MnLCAnY29uc3RhbnQnLCBvciAncG9seW5vbWlhbCcgKGRlZmF1bHQ6ICdjb25zdGFudCcpCiAgICBiYXNlbGluZV9mcmFjIDogZmxvYXQKICAgICAgICBGcmFjdGlvbiBvZiBkYXRhIHVzZWQgZm9yIExPV0VTUyBzbW9vdGhpbmcgKGRlZmF1bHQ6IDAuNSkKICAgIGJhc2VsaW5lX3BvbHlfb3JkZXIgOiBpbnQKICAgICAgICBQb2x5bm9taWFsIG9yZGVyIGZvciBwb2x5bm9taWFsIGZpdCAoZGVmYXVsdDogMSkKICAgIG5vcm1hbGl6YXRpb25fbW9kZSA6IHN0cgogICAgICAgIE1vZGU6ICdkZWx0YV9mX292ZXJfZicsICdtdWx0aXBsaWNhdGl2ZScsICdsb3dlc3RfcG9pbnQnLCAnZmlyc3RfcG9pbnQnLCAnbm9uZScsICdiYXNlbGluZV9zdWJ0cmFjdF9sb3dlc3QnLCBvciAnYmFzZWxpbmVfc3VidHJhY3RfZmlyc3QnIChkZWZhdWx0OiAnbXVsdGlwbGljYXRpdmUnKQogICAgIiIiCiAgICBwbGF0ZV9pZCA9IGxvbmdfZGZbInBsYXRlX2lkIl0uaWxvY1swXQogICAgcHJpbnQoZiIgIFdyaXRpbmcgQ1NWcyBmb3Ige3BsYXRlX2lkfS4uLiIsIGZsdXNoPVRydWUpCgogICAgIyBMb2FkIGNvbmZpZyBpZiBub3QgcHJvdmlkZWQKICAgIGlmIGNvbmZpZyBpcyBOb25lOgogICAgICAgIHNjcmlwdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgICAgICBjb25maWdfcGF0aCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAicGxhdGVfY29uZmlnLmpzb24iKQogICAgICAgIGNvbmZpZyA9IGxvYWRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgCiAgICAjIEZpbHRlciBvdXQgYmFkIHdlbGxzIGJlZm9yZSBwcm9jZXNzaW5nCiAgICBiYWRfd2VsbHNfbGlzdCA9IGNvbmZpZy5nZXQoImJhZF93ZWxscyIsIFtdKQogICAgaWYgYmFkX3dlbGxzX2xpc3Q6CiAgICAgICAgb3JpZ2luYWxfY291bnQgPSBsZW4obG9uZ19kZikKICAgICAgICBsb25nX2RmID0gbG9uZ19kZlt+bG9uZ19kZlsid2VsbCJdLmFwcGx5KGxhbWJkYSB3OiBpc19iYWRfd2VsbCh3LCBjb25maWcpKV0KICAgICAgICBmaWx0ZXJlZF9jb3VudCA9IGxlbihsb25nX2RmKQogICAgICAgIGlmIG9yaWdpbmFsX2NvdW50ICE9IGZpbHRlcmVkX2NvdW50OgogICAgICAgICAgICBwcmludChmIiAgICBFeGNsdWRpbmcge29yaWdpbmFsX2NvdW50IC0gZmlsdGVyZWRfY291bnR9IGRhdGEgcG9pbnRzIGZyb20gYmFkIHdlbGxzIiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgIyBOb3JtYWxpemUsIGJhc2VsaW5lLXN1YnRyYWN0LCBvciB1c2UgcmF3IHZhbHVlcyBiZWZvcmUgd3JpdGluZyBDU1ZzCiAgICBpZiBub3JtYWxpemF0aW9uX21vZGUgPT0gJ25vbmUnOgogICAgICAgIHByaW50KGYiICAgIFNraXBwaW5nIG5vcm1hbGl6YXRpb24gKG1vZGU6IG5vbmUpLiBVc2luZyByYXcgdmFsdWVzLi4uIiwgZmx1c2g9VHJ1ZSkKICAgICAgICBub3JtX2RmID0gbG9uZ19kZi5jb3B5KCkKICAgIGVsaWYgbm9ybWFsaXphdGlvbl9tb2RlIGluICgnYmFzZWxpbmVfc3VidHJhY3RfbG93ZXN0JywgJ2Jhc2VsaW5lX3N1YnRyYWN0X2ZpcnN0Jyk6CiAgICAgICAgcHJpbnQoZiIgICAgQmFzZWxpbmUgc3VidHJhY3Rpb24gKG1vZGU6IHtub3JtYWxpemF0aW9uX21vZGV9KS4uLiIsIGZsdXNoPVRydWUpCiAgICAgICAgbm9ybV9kZiA9IGxvbmdfZGYuY29weSgpCiAgICAgICAgcmVmX3Blcl93ZWxsOiBEaWN0W3N0ciwgZmxvYXRdID0ge30KICAgICAgICBmb3Igd2VsbF9pZCwgZ3JwIGluIGxvbmdfZGYuZ3JvdXBieSgid2VsbCIpOgogICAgICAgICAgICBncnBfc29ydGVkID0gZ3JwLnNvcnRfdmFsdWVzKCJ0aW1lX3MiKQogICAgICAgICAgICBpZiBub3JtYWxpemF0aW9uX21vZGUgPT0gJ2Jhc2VsaW5lX3N1YnRyYWN0X2xvd2VzdCc6CiAgICAgICAgICAgICAgICBiYXNlbGluZV92YWxzID0gZ3JwX3NvcnRlZC5sb2NbZ3JwX3NvcnRlZFsidGltZV9zIl0gPD0gYmFzZWxpbmVfZW5kX3RpbWUsICJ2YWx1ZSJdLmRyb3BuYSgpCiAgICAgICAgICAgICAgICBpZiBsZW4oYmFzZWxpbmVfdmFscykgPT0gMDoKICAgICAgICAgICAgICAgICAgICByZWZfcGVyX3dlbGxbd2VsbF9pZF0gPSBucC5uYW4KICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcmVmX3Blcl93ZWxsW3dlbGxfaWRdID0gZmxvYXQoYmFzZWxpbmVfdmFscy5taW4oKSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGFmdGVyID0gZ3JwX3NvcnRlZFtncnBfc29ydGVkWyJ0aW1lX3MiXSA+IGJhc2VsaW5lX2VuZF90aW1lXQogICAgICAgICAgICAgICAgaWYgbGVuKGFmdGVyKSA9PSAwOgogICAgICAgICAgICAgICAgICAgIHJlZl9wZXJfd2VsbFt3ZWxsX2lkXSA9IG5wLm5hbgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByZWZfcGVyX3dlbGxbd2VsbF9pZF0gPSBmbG9hdChhZnRlclsidmFsdWUiXS5pbG9jWzBdKQogICAgICAgIG5vcm1fZGZbInZhbHVlIl0gPSBub3JtX2RmLmFwcGx5KAogICAgICAgICAgICBsYW1iZGEgcm93OiAocm93WyJ2YWx1ZSJdIC0gcmVmX3Blcl93ZWxsW3Jvd1sid2VsbCJdXSkgaWYgbm90IG5wLmlzbmFuKHJlZl9wZXJfd2VsbC5nZXQocm93WyJ3ZWxsIl0sIG5wLm5hbikpIGVsc2Ugcm93WyJ2YWx1ZSJdLAogICAgICAgICAgICBheGlzPTEKICAgICAgICApCiAgICAgICAgcHJpbnQoZiIgICAg4pyTIEJhc2VsaW5lLXN1YnRyYWN0ZWQge2xlbihub3JtX2RmKX0gZGF0YSBwb2ludHMiLCBmbHVzaD1UcnVlKQogICAgZWxzZToKICAgICAgICBwcmludChmIiAgICBOb3JtYWxpemluZyBkYXRhIHdpdGggYmFzZWxpbmUgKG1ldGhvZD17YmFzZWxpbmVfbWV0aG9kfSwgbW9kZT17bm9ybWFsaXphdGlvbl9tb2RlfSkuLi4iLCBmbHVzaD1UcnVlKQogICAgICAgIGJhc2VsaW5lX3dpbmRvd3MgPSBpZGVudGlmeV9iYXNlbGluZV93aW5kb3cobG9uZ19kZiwgYmFzZWxpbmVfc3RhcnRfdGltZSwgYmFzZWxpbmVfZW5kX3RpbWUpCiAgICAgICAgYmFzZWxpbmVfZml0cyA9IGZpdF93ZWxsX2Jhc2VsaW5lcygKICAgICAgICAgICAgbG9uZ19kZiwKICAgICAgICAgICAgYmFzZWxpbmVfc3RhcnRfdGltZT1iYXNlbGluZV9zdGFydF90aW1lLAogICAgICAgICAgICBiYXNlbGluZV9lbmRfdGltZT1iYXNlbGluZV9lbmRfdGltZSwKICAgICAgICAgICAgbWV0aG9kPWJhc2VsaW5lX21ldGhvZCwKICAgICAgICAgICAgZnJhYz1iYXNlbGluZV9mcmFjLAogICAgICAgICAgICBwb2x5X29yZGVyPWJhc2VsaW5lX3BvbHlfb3JkZXIsCiAgICAgICAgICAgIGNvbmZpZz1jb25maWcKICAgICAgICApCiAgICAgICAgbm9ybV9kZiA9IG5vcm1hbGl6ZV93ZWxscyhsb25nX2RmLCBiYXNlbGluZV9maXRzLCBub3JtYWxpemF0aW9uX21vZGU9bm9ybWFsaXphdGlvbl9tb2RlLCBiYXNlbGluZV93aW5kb3dzPWJhc2VsaW5lX3dpbmRvd3MsIGJhc2VsaW5lX3N0YXJ0X3RpbWU9YmFzZWxpbmVfc3RhcnRfdGltZSwgYmFzZWxpbmVfZW5kX3RpbWU9YmFzZWxpbmVfZW5kX3RpbWUpCiAgICAgICAgcHJpbnQoZiIgICAg4pyTIE5vcm1hbGl6ZWQge2xlbihub3JtX2RmKX0gZGF0YSBwb2ludHMiLCBmbHVzaD1UcnVlKQogICAgIyBBZGQgbm9ybWFsaXplZCB3ZWxsIElEIGNvbHVtbiBmb3IgY29uc2lzdGVudCBtYXRjaGluZwogICAgbm9ybV9kZiA9IG5vcm1fZGYuY29weSgpCiAgICBub3JtX2RmWyJ3ZWxsX25vcm1hbGl6ZWQiXSA9IG5vcm1fZGZbIndlbGwiXS5hcHBseShsYW1iZGEgdzogbm9ybWFsaXplX3dlbGxfaWQoc3RyKHcpLnN0cmlwKCkpKQogICAgCiAgICAjIFBhcnNlIGNvbHVtbiBpbmZvIGZyb20gZmlsZW5hbWUgaWYgcHJvdmlkZWQKICAgIGNvbHVtbl9pbmZvID0gTm9uZQogICAgaWYgZmlsZW5hbWU6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb2x1bW5faW5mbyA9IHBhcnNlX2NvbHVtbl9ncm91cF9mcm9tX2ZpbGVuYW1lKGZpbGVuYW1lKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgIAogICAgIyBHZXQgd2VsbF9sYWJlbHMgYW5kIGNvbnRyb2xfcm93cyBmcm9tIGNvbmZpZwogICAgY29uZmlnX3dlbGxfbGFiZWxzID0gY29uZmlnLmdldCgid2VsbF9sYWJlbHMiLCB7fSkKICAgIHdlbGxfbGFiZWxzID0ge30KICAgIAogICAgIyBQcm9jZXNzIGNvbmZpZyBsYWJlbHMgLSBjb252ZXJ0IHdlbGwtc3BlY2lmaWMgdG8gcm93LWJhc2VkIGlmIG5lZWRlZAogICAgZm9yIGtleSwgdmFsdWUgaW4gY29uZmlnX3dlbGxfbGFiZWxzLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGtleSkgPiAxIGFuZCBrZXlbMF0uaXNhbHBoYSgpIGFuZCBrZXlbMTpdLmlzZGlnaXQoKToKICAgICAgICAgICAgIyBPbGQgZm9ybWF0OiAiQjEzIiAtPiBleHRyYWN0IHJvdyAiQiIKICAgICAgICAgICAgcm93X2xldHRlciA9IGtleVswXQogICAgICAgICAgICBpZiByb3dfbGV0dGVyIG5vdCBpbiB3ZWxsX2xhYmVsczoKICAgICAgICAgICAgICAgIHdlbGxfbGFiZWxzW3Jvd19sZXR0ZXJdID0gdmFsdWUKICAgICAgICAgICAgZWxpZiBub3Qgd2VsbF9sYWJlbHNbcm93X2xldHRlcl0gb3Igbm90IHdlbGxfbGFiZWxzW3Jvd19sZXR0ZXJdLnN0cmlwKCk6CiAgICAgICAgICAgICAgICB3ZWxsX2xhYmVsc1tyb3dfbGV0dGVyXSA9IHZhbHVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBOZXcgZm9ybWF0OiAiQiIgLT4gdXNlIGFzIGlzCiAgICAgICAgICAgIHdlbGxfbGFiZWxzW2tleV0gPSB2YWx1ZQogICAgCiAgICAjIEFsc28gY29udmVydCBERUZBVUxUX1dFTExfTEFCRUxTIHRvIHJvdy1iYXNlZCBmb3JtYXQKICAgIGRlZmF1bHRfcm93X2xhYmVscyA9IHt9CiAgICBmb3Iga2V5LCB2YWx1ZSBpbiBERUZBVUxUX1dFTExfTEFCRUxTLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGtleSkgPiAxIGFuZCBrZXlbMF0uaXNhbHBoYSgpOgogICAgICAgICAgICByb3dfbGV0dGVyID0ga2V5WzBdCiAgICAgICAgICAgIGlmIHJvd19sZXR0ZXIgbm90IGluIGRlZmF1bHRfcm93X2xhYmVsczoKICAgICAgICAgICAgICAgIGRlZmF1bHRfcm93X2xhYmVsc1tyb3dfbGV0dGVyXSA9IHZhbHVlCiAgICAKICAgICMgTWVyZ2UgZGVmYXVsdHMgd2l0aCBjb25maWcgKGNvbmZpZyB0YWtlcyBwcmVjZWRlbmNlKQogICAgd2VsbF9sYWJlbHMgPSB7KipkZWZhdWx0X3Jvd19sYWJlbHMsICoqd2VsbF9sYWJlbHN9CiAgICAKICAgIGNvbnRyb2xfcm93cyA9IGNvbmZpZy5nZXQoImNvbnRyb2xfcm93cyIsIFsiTiIsICJPIl0pCiAgICAKICAgICMgQXV0by1nZW5lcmF0ZSBncm91cHMgZnJvbSB3ZWxsX2xhYmVscwogICAgZ3JvdXBzID0gW10KICAgIGxhYmVsX3RvX3Jvd3M6IERpY3Rbc3RyLCBMaXN0W3N0cl1dID0ge30KICAgIAogICAgIyBHcm91cCByb3cgbGV0dGVycyBieSB0aGVpciBsYWJlbHMKICAgIGZvciByb3dfbGV0dGVyLCBsYWJlbCBpbiB3ZWxsX2xhYmVscy5pdGVtcygpOgogICAgICAgICMgRmlsdGVyIG91dCBjb250cm9sIHdlbGxzCiAgICAgICAgaWYgbm90IGlzX2NvbnRyb2xfd2VsbChyb3dfbGV0dGVyLCBjb250cm9sX3Jvd3MpOgogICAgICAgICAgICBpZiBsYWJlbCBhbmQgc3RyKGxhYmVsKS5zdHJpcCgpOgogICAgICAgICAgICAgICAgaWYgbGFiZWwgbm90IGluIGxhYmVsX3RvX3Jvd3M6CiAgICAgICAgICAgICAgICAgICAgbGFiZWxfdG9fcm93c1tsYWJlbF0gPSBbXQogICAgICAgICAgICAgICAgaWYgcm93X2xldHRlciBub3QgaW4gbGFiZWxfdG9fcm93c1tsYWJlbF06CiAgICAgICAgICAgICAgICAgICAgbGFiZWxfdG9fcm93c1tsYWJlbF0uYXBwZW5kKHJvd19sZXR0ZXIpCiAgICAKICAgICMgQ3JlYXRlIGdyb3VwcyBmcm9tIGxhYmVscwogICAgZm9yIGxhYmVsLCByb3dfbGV0dGVycyBpbiBsYWJlbF90b19yb3dzLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKHJvd19sZXR0ZXJzKSA+PSAxOiAgIyBBdCBsZWFzdCAxIHJvdyB3aXRoIHRoaXMgbGFiZWwKICAgICAgICAgICAgZ3JvdXBzLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAibmFtZSI6IGxhYmVsLAogICAgICAgICAgICAgICAgIndlbGxzIjogc29ydGVkKHJvd19sZXR0ZXJzKSAgIyBTdG9yZSByb3cgbGV0dGVycyBvbmx5CiAgICAgICAgICAgIH0pCiAgICAKICAgICMgQnVpbGQgbWFwcGluZzogd2VsbF9pZCAtPiBncm91cCBuYW1lCiAgICAjIFVzZSBub3JtYWxpemVkIHdlbGwgSURzIGZvciBjb25zaXN0ZW50IG1hdGNoaW5nCiAgICB3ZWxsX3RvX2dyb3VwID0ge30KICAgIGZvciBncm91cCBpbiBncm91cHM6CiAgICAgICAgZ3JvdXBfbmFtZSA9IGdyb3VwLmdldCgibmFtZSIsICIiKQogICAgICAgIGdyb3VwX3dlbGxzID0gZ3JvdXAuZ2V0KCJ3ZWxscyIsIFtdKQogICAgICAgIGZvciByb3dfbGV0dGVyIGluIGdyb3VwX3dlbGxzOgogICAgICAgICAgICAjIEZpbmQgYWxsIHdlbGxzIGluIHRoaXMgcm93IGFjcm9zcyBhbGwgY29sdW1ucwogICAgICAgICAgICAjIFVzZSB3ZWxsX25vcm1hbGl6ZWQgY29sdW1uIGZvciBjb25zaXN0ZW50IG1hdGNoaW5nCiAgICAgICAgICAgIGZvciBub3JtYWxpemVkX3dlbGxfaWQgaW4gbm9ybV9kZlsid2VsbF9ub3JtYWxpemVkIl0udW5pcXVlKCk6CiAgICAgICAgICAgICAgICBpZiBub3JtYWxpemVkX3dlbGxfaWQ6CiAgICAgICAgICAgICAgICAgICAgIyBDaGVjayBpZiBub3JtYWxpemVkIHdlbGwgSUQgc3RhcnRzIHdpdGggdGhlIHJvdyBsZXR0ZXIKICAgICAgICAgICAgICAgICAgICBpZiBub3JtYWxpemVkX3dlbGxfaWQgYW5kIG5vcm1hbGl6ZWRfd2VsbF9pZFswXSA9PSByb3dfbGV0dGVyOgogICAgICAgICAgICAgICAgICAgICAgICAjIFN0b3JlIG1hcHBpbmcgdXNpbmcgbm9ybWFsaXplZCB3ZWxsIElEIChjb25zaXN0ZW50IGZvcm1hdCkKICAgICAgICAgICAgICAgICAgICAgICAgd2VsbF90b19ncm91cFtub3JtYWxpemVkX3dlbGxfaWRdID0gZ3JvdXBfbmFtZQogICAgCiAgICAjIFBlci13ZWxsIENTVnMgKG5vcm1hbGl6ZWQgdmFsdWVzIHdpdGggYmFzZWxpbmUsIHdpdGhvdXQgU0VNIC0gU0VNIG9ubHkgYmVsb25ncyBpbiB0cmlwbGljYXRlIENTVnMpCiAgICBwbGF0ZV9mb2xkZXIgPSBvcy5wYXRoLmpvaW4oY3N2X3Jvb3QsIHBsYXRlX2lkKQogICAgZW5zdXJlX2RpcihwbGF0ZV9mb2xkZXIpCiAgICAKICAgIHdlbGxzID0gbm9ybV9kZi5ncm91cGJ5KCJ3ZWxsIikKICAgIHByaW50KGYiICAgIFdyaXRpbmcge2xlbih3ZWxscyl9IHBlci13ZWxsIENTVnMgKG5vcm1hbGl6ZWQgdmFsdWVzKS4uLiIsIGZsdXNoPVRydWUpCiAgICAKICAgICMgV3JpdGUgcGVyLXdlbGwgQ1NWcyB3aXRoIG5vcm1hbGl6ZWQgdmFsdWVzCiAgICBmb3IgaWR4LCAod2VsbF9pZCwgZykgaW4gZW51bWVyYXRlKHdlbGxzLCAxKToKICAgICAgICAjIE5vcm1hbGl6ZSB3ZWxsIElEIGZvciBjb25zaXN0ZW50IGZpbGUgbmFtaW5nCiAgICAgICAgbm9ybWFsaXplZF93ZWxsX2lkID0gbm9ybWFsaXplX3dlbGxfaWQoc3RyKHdlbGxfaWQpLnN0cmlwKCkpCiAgICAgICAgc2FmZV93ZWxsID0gbm9ybWFsaXplZF93ZWxsX2lkLnJlcGxhY2UoIiAiLCAiIikucmVwbGFjZSgiOiIsICItIikKICAgICAgICBvdXRfcGF0aCA9IG9zLnBhdGguam9pbihwbGF0ZV9mb2xkZXIsIGYie3BsYXRlX2lkfV97c2FmZV93ZWxsfS5jc3YiKQogICAgICAgIGdfc29ydGVkID0gZy5zb3J0X3ZhbHVlcygidGltZV9zIikKICAgICAgICAKICAgICAgICAjIENyZWF0ZSBvdXRwdXQgRGF0YUZyYW1lIHdpdGggdGltZSBhbmQgbm9ybWFsaXplZCB2YWx1ZSBvbmx5IChubyBTRU0pCiAgICAgICAgb3V0cHV0X2RmID0gcGQuRGF0YUZyYW1lKHsKICAgICAgICAgICAgInRpbWVfcyI6IGdfc29ydGVkWyJ0aW1lX3MiXS52YWx1ZXMsCiAgICAgICAgICAgICJ2YWx1ZSI6IGdfc29ydGVkWyJ2YWx1ZSJdLnZhbHVlcyAgIyBUaGlzIGlzIG5vdyBub3JtYWxpemVkCiAgICAgICAgfSkKICAgICAgICBvdXRwdXRfZGYudG9fY3N2KG91dF9wYXRoLCBpbmRleD1GYWxzZSkKICAgICAgICAKICAgICAgICBpZiBpZHggJSA1ID09IDA6CiAgICAgICAgICAgIHByaW50KGYiICAgICAgV3JpdHRlbiB7aWR4fS97bGVuKHdlbGxzKX0gd2VsbHMuLi4iLCBmbHVzaD1UcnVlKQogICAgCiAgICAjIFdyaXRlIGNvbmRpdGlvbi1zcGVjaWZpYyBDU1ZzIChnZW5vdHlwZS1idWZmZXItdHJpcGxpY2F0ZSkKICAgICMgT25lIENTViBwZXIgY29uZGl0aW9uLXRyaXBsaWNhdGUtY29sdW1uIGNvbWJpbmF0aW9uCiAgICAjIFVzaW5nIG5vcm1hbGl6ZWQgdmFsdWVzIGZyb20gbm9ybV9kZgogICAgaWYgY29sdW1uX2luZm86CiAgICAgICAgcHJpbnQoZiIgICAgV3JpdGluZyBjb25kaXRpb24tc3BlY2lmaWMgQ1NWcyAodXNpbmcgbm9ybWFsaXplZCB2YWx1ZXMpLi4uIiwgZmx1c2g9VHJ1ZSkKICAgICAgICBnZW5vdHlwZSA9IGNvbHVtbl9pbmZvLmdldCgiZ2Vub3R5cGUiLCAiIikKICAgICAgICBidWZmZXIgPSBjb2x1bW5faW5mby5nZXQoImJ1ZmZlciIsICIiKQogICAgICAgIAogICAgICAgICMgR3JvdXAgYnkgZ3JvdXAgbmFtZSBhbmQgY29sdW1uCiAgICAgICAgZm9yIGdyb3VwIGluIGdyb3VwczoKICAgICAgICAgICAgZ3JvdXBfbmFtZSA9IGdyb3VwLmdldCgibmFtZSIsICIiKQogICAgICAgICAgICBpZiBub3QgZ3JvdXBfbmFtZToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdldCBhbGwgd2VsbHMgaW4gdGhpcyB0cmlwbGljYXRlIGdyb3VwIChhY3Jvc3MgYWxsIGNvbHVtbnMpCiAgICAgICAgICAgICMgVXNlIG5vcm1hbGl6ZWQgd2VsbCBJRHMgZm9yIGNvbnNpc3RlbnQgbWF0Y2hpbmcKICAgICAgICAgICAgZ3JvdXBfd2VsbHMgPSBbXQogICAgICAgICAgICBmb3Igbm9ybWFsaXplZF93ZWxsX2lkIGluIG5vcm1fZGZbIndlbGxfbm9ybWFsaXplZCJdLnVuaXF1ZSgpOgogICAgICAgICAgICAgICAgIyBDaGVjayB1c2luZyBub3JtYWxpemVkIHdlbGwgSUQKICAgICAgICAgICAgICAgIGlmIG5vcm1hbGl6ZWRfd2VsbF9pZCBpbiB3ZWxsX3RvX2dyb3VwIGFuZCB3ZWxsX3RvX2dyb3VwW25vcm1hbGl6ZWRfd2VsbF9pZF0gPT0gZ3JvdXBfbmFtZToKICAgICAgICAgICAgICAgICAgICAjIFN0b3JlIG5vcm1hbGl6ZWQgd2VsbCBJRCBmb3IgY29uc2lzdGVuY3kKICAgICAgICAgICAgICAgICAgICBncm91cF93ZWxscy5hcHBlbmQobm9ybWFsaXplZF93ZWxsX2lkKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGdyb3VwX3dlbGxzOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR3JvdXAgd2VsbHMgYnkgY29sdW1uIG51bWJlcgogICAgICAgICAgICAjIE5vdGU6IGdyb3VwX3dlbGxzIG5vdyBjb250YWlucyBub3JtYWxpemVkIHdlbGwgSURzCiAgICAgICAgICAgIHdlbGxzX2J5X2NvbHVtbiA9IHt9CiAgICAgICAgICAgIGZvciBub3JtYWxpemVkX3dlbGxfaWQgaW4gZ3JvdXBfd2VsbHM6CiAgICAgICAgICAgICAgICAjIEV4dHJhY3QgY29sdW1uIG51bWJlciBmcm9tIG5vcm1hbGl6ZWQgd2VsbCBJRCAoZS5nLiwgIkIxMyIgLT4gMTMsICJCMDUiIC0+IDUpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgY29sdW1uX251bSA9IGludCgnJy5qb2luKGZpbHRlcihzdHIuaXNkaWdpdCwgc3RyKG5vcm1hbGl6ZWRfd2VsbF9pZCkpKSkKICAgICAgICAgICAgICAgICAgICBpZiBjb2x1bW5fbnVtIG5vdCBpbiB3ZWxsc19ieV9jb2x1bW46CiAgICAgICAgICAgICAgICAgICAgICAgIHdlbGxzX2J5X2NvbHVtbltjb2x1bW5fbnVtXSA9IFtdCiAgICAgICAgICAgICAgICAgICAgd2VsbHNfYnlfY29sdW1uW2NvbHVtbl9udW1dLmFwcGVuZChub3JtYWxpemVkX3dlbGxfaWQpCiAgICAgICAgICAgICAgICBleGNlcHQgKFZhbHVlRXJyb3IsIEF0dHJpYnV0ZUVycm9yKToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDcmVhdGUgb25lIENTViBwZXIgY29sdW1uIGZvciB0aGlzIHRyaXBsaWNhdGUgZ3JvdXAKICAgICAgICAgICAgZm9yIGNvbHVtbl9udW0gaW4gc29ydGVkKHdlbGxzX2J5X2NvbHVtbi5rZXlzKCkpOgogICAgICAgICAgICAgICAgY29sdW1uX3dlbGxzID0gd2VsbHNfYnlfY29sdW1uW2NvbHVtbl9udW1dCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgR2V0IGFsbCB0aW1lIHBvaW50cyBmb3IgdGhpcyBjb2x1bW4ncyB3ZWxscyAodXNpbmcgbm9ybWFsaXplZCBkYXRhKQogICAgICAgICAgICAgICAgIyBjb2x1bW5fd2VsbHMgY29udGFpbnMgbm9ybWFsaXplZCB3ZWxsIElEcywgdXNlIHdlbGxfbm9ybWFsaXplZCBjb2x1bW4gZm9yIG1hdGNoaW5nCiAgICAgICAgICAgICAgICAjIEZpbHRlciBvdXQgYmFkIHdlbGxzIGZyb20gY29sdW1uX3dlbGxzCiAgICAgICAgICAgICAgICBjb2x1bW5fd2VsbHNfZmlsdGVyZWQgPSBbdyBmb3IgdyBpbiBjb2x1bW5fd2VsbHMgaWYgbm90IGlzX2JhZF93ZWxsKHcsIGNvbmZpZyldCiAgICAgICAgICAgICAgICBpZiBub3QgY29sdW1uX3dlbGxzX2ZpbHRlcmVkOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlICAjIFNraXAgdGhpcyBjb2x1bW4gaWYgYWxsIHdlbGxzIGFyZSBiYWQKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgYWxsX3RpbWVzID0gc29ydGVkKG5vcm1fZGZbbm9ybV9kZlsid2VsbF9ub3JtYWxpemVkIl0uaXNpbihjb2x1bW5fd2VsbHNfZmlsdGVyZWQpXVsidGltZV9zIl0udW5pcXVlKCkpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ2FsY3VsYXRlIG1lYW4gYW5kIFNFTSBmb3IgZWFjaCB0aW1lIHBvaW50IGFjcm9zcyB3ZWxscyBpbiB0aGlzIHRyaXBsaWNhdGUgZ3JvdXAgZm9yIHRoaXMgY29sdW1uCiAgICAgICAgICAgICAgICAjIFVzaW5nIG5vcm1hbGl6ZWQgdmFsdWVzCiAgICAgICAgICAgICAgICBtZWFuX3ZhbHVlcyA9IFtdCiAgICAgICAgICAgICAgICBzZW1fdmFsdWVzID0gW10KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIHRpbWUgaW4gYWxsX3RpbWVzOgogICAgICAgICAgICAgICAgICAgIHZhbHVlc19hdF90aW1lID0gW10KICAgICAgICAgICAgICAgICAgICBmb3Igbm9ybWFsaXplZF93ZWxsX2lkIGluIGNvbHVtbl93ZWxsc19maWx0ZXJlZDoKICAgICAgICAgICAgICAgICAgICAgICAgd2VsbF9kYXRhID0gbm9ybV9kZlsobm9ybV9kZlsid2VsbF9ub3JtYWxpemVkIl0gPT0gbm9ybWFsaXplZF93ZWxsX2lkKSAmIChub3JtX2RmWyJ0aW1lX3MiXSA9PSB0aW1lKV0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHdlbGxfZGF0YS5lbXB0eToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlc19hdF90aW1lLmFwcGVuZCh3ZWxsX2RhdGFbInZhbHVlIl0uaWxvY1swXSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBsZW4odmFsdWVzX2F0X3RpbWUpID49IDI6CiAgICAgICAgICAgICAgICAgICAgICAgIG1lYW4gPSBzdW0odmFsdWVzX2F0X3RpbWUpIC8gbGVuKHZhbHVlc19hdF90aW1lKQogICAgICAgICAgICAgICAgICAgICAgICB2YXJpYW5jZSA9IHN1bSgodiAtIG1lYW4pICoqIDIgZm9yIHYgaW4gdmFsdWVzX2F0X3RpbWUpIC8gKGxlbih2YWx1ZXNfYXRfdGltZSkgLSAxKSAjIFNhbXBsZSB2YXJpYW5jZSB1c2luZyBCZXNzZWwncyBjb3JyZWN0aW9uL3NhbXBsZSBzdGFuZGFyZCBkZXZpYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgc3RkX2RldiA9IHZhcmlhbmNlICoqIDAuNQogICAgICAgICAgICAgICAgICAgICAgICBzZW0gPSBzdGRfZGV2IC8gKGxlbih2YWx1ZXNfYXRfdGltZSkgKiogMC41KQogICAgICAgICAgICAgICAgICAgICAgICBtZWFuX3ZhbHVlcy5hcHBlbmQobWVhbikKICAgICAgICAgICAgICAgICAgICAgICAgc2VtX3ZhbHVlcy5hcHBlbmQoc2VtKQogICAgICAgICAgICAgICAgICAgIGVsaWYgbGVuKHZhbHVlc19hdF90aW1lKSA9PSAxOgogICAgICAgICAgICAgICAgICAgICAgICBtZWFuX3ZhbHVlcy5hcHBlbmQodmFsdWVzX2F0X3RpbWVbMF0pCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbV92YWx1ZXMuYXBwZW5kKE5vbmUpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbWVhbl92YWx1ZXMuYXBwZW5kKE5vbmUpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbV92YWx1ZXMuYXBwZW5kKE5vbmUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ3JlYXRlIGNvbmRpdGlvbiBDU1YgZmlsZW5hbWU6IHBsYXRlX2lkX3RyaXBsaWNhdGVfbmFtZV9jb2x7Y29sdW1ufQogICAgICAgICAgICAgICAgIyBQbGF0ZSBJRCBhbHJlYWR5IGNvbnRhaW5zIGdlbm90eXBlIGFuZCBidWZmZXIsIHNvIGp1c3QgdXNlIHRyaXBsaWNhdGUgbmFtZQogICAgICAgICAgICAgICAgIyBLZWVwIGh5cGhlbnMgaW4gZ3JvdXAgbmFtZSAoZS5nLiwgIjI1MC0xMC0yIiksIGp1c3Qgc2FuaXRpemUgc3BhY2VzIGFuZCBjb2xvbnMKICAgICAgICAgICAgICAgIHNhZmVfZ3JvdXBfbmFtZSA9IGdyb3VwX25hbWUucmVwbGFjZSgiICIsICJfIikucmVwbGFjZSgiOiIsICItIikKICAgICAgICAgICAgICAgIGNvbmRpdGlvbl9wYXRoID0gb3MucGF0aC5qb2luKGNzdl9yb290LCBmIntwbGF0ZV9pZH1fe3NhZmVfZ3JvdXBfbmFtZX1fY29se2NvbHVtbl9udW19LmNzdiIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgV3JpdGUgY29uZGl0aW9uIENTViB3aXRoIG5vcm1hbGl6ZWQgdmFsdWVzCiAgICAgICAgICAgICAgICBjb25kaXRpb25fZGYgPSBwZC5EYXRhRnJhbWUoewogICAgICAgICAgICAgICAgICAgICJ0aW1lX3MiOiBhbGxfdGltZXMsCiAgICAgICAgICAgICAgICAgICAgIm1lYW4iOiBtZWFuX3ZhbHVlcywKICAgICAgICAgICAgICAgICAgICAic2VtIjogc2VtX3ZhbHVlcwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIGNvbmRpdGlvbl9kZi50b19jc3YoY29uZGl0aW9uX3BhdGgsIGluZGV4PUZhbHNlKQogICAgICAgIAogICAgICAgIHByaW50KGYiICAgICAgV3JpdHRlbiBjb25kaXRpb24tc3BlY2lmaWMgQ1NWcyIsIGZsdXNoPVRydWUpCiAgICAKICAgIHByaW50KGYiICDinJMgQ29tcGxldGVkIHdyaXRpbmcgQ1NWcyBmb3Ige3BsYXRlX2lkfSIsIGZsdXNoPVRydWUpCgoKZGVmIHdyaXRlX2RlZmF1bHRfY29uZmlnKGNvbmZpZ19wYXRoOiBzdHIpOgogICAgIiIiV3JpdGUgZGVmYXVsdCBjb25maWd1cmF0aW9uIGZpbGUgZnJvbSBkZWZhdWx0cy4iIiIKICAgICMgQ29udmVydCBERUZBVUxUX1dFTExfTEFCRUxTIHRvIHJvdy1iYXNlZCBmb3JtYXQKICAgIHdlbGxfbGFiZWxzID0ge30KICAgIGZvciB3ZWxsX2lkLCBsYWJlbCBpbiBERUZBVUxUX1dFTExfTEFCRUxTLml0ZW1zKCk6CiAgICAgICAgaWYgd2VsbF9pZCBhbmQgbGVuKHdlbGxfaWQpID4gMCBhbmQgd2VsbF9pZFswXS5pc2FscGhhKCk6CiAgICAgICAgICAgIHJvd19sZXR0ZXIgPSB3ZWxsX2lkWzBdCiAgICAgICAgICAgIGlmIHJvd19sZXR0ZXIgbm90IGluIHdlbGxfbGFiZWxzOgogICAgICAgICAgICAgICAgd2VsbF9sYWJlbHNbcm93X2xldHRlcl0gPSBsYWJlbAogICAgCiAgICBkZWZhdWx0X2NvbmZpZyA9IHsKICAgICAgICAid2VsbF9sYWJlbHMiOiB3ZWxsX2xhYmVscywKICAgICAgICAiY29udHJvbF9yb3dzIjogWyJOIiwgIk8iXSwKICAgICAgICAiYmFkX3dlbGxzIjogW10KICAgIH0KICAgIAogICAgdHJ5OgogICAgICAgIHdpdGggb3Blbihjb25maWdfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBqc29uLmR1bXAoZGVmYXVsdF9jb25maWcsIGYsIGluZGVudD0yKQogICAgICAgIHByaW50KGYiICBHZW5lcmF0ZWQgZGVmYXVsdCBjb25maWd1cmF0aW9uIGZpbGU6IHtvcy5wYXRoLmJhc2VuYW1lKGNvbmZpZ19wYXRoKX0iLCBmbHVzaD1UcnVlKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiICBXYXJuaW5nOiBDb3VsZCBub3Qgd3JpdGUgZGVmYXVsdCBjb25maWcgZmlsZToge2V9IiwgZmx1c2g9VHJ1ZSkKCgpkZWYgbm9ybWFsaXplX3dlbGxfaWQod2VsbF9pZDogc3RyKSAtPiBzdHI6CiAgICAiIiIKICAgIE5vcm1hbGl6ZSB3ZWxsIElEIHRvIGNvbnNpc3RlbnQgZm9ybWF0OiB1cHBlcmNhc2Ugd2l0aCB6ZXJvLXBhZGRlZCBjb2x1bW4uCiAgICBFeGFtcGxlczogIkI1IiAtPiAiQjA1IiwgIkIxMyIgLT4gIkIxMyIsICJiNSIgLT4gIkIwNSIKICAgICIiIgogICAgaWYgbm90IHdlbGxfaWQ6CiAgICAgICAgcmV0dXJuICIiCiAgICAKICAgIHdlbGxfaWQgPSBzdHIod2VsbF9pZCkuc3RyaXAoKS51cHBlcigpCiAgICAKICAgICMgTWF0Y2ggcGF0dGVybjogbGV0dGVyIGZvbGxvd2VkIGJ5IGRpZ2l0cwogICAgaW1wb3J0IHJlCiAgICBtYXRjaCA9IHJlLm1hdGNoKHInXihbQS1aXSkoXGQrKSQnLCB3ZWxsX2lkKQogICAgaWYgbWF0Y2g6CiAgICAgICAgcm93ID0gbWF0Y2guZ3JvdXAoMSkKICAgICAgICBjb2wgPSBpbnQobWF0Y2guZ3JvdXAoMikpCiAgICAgICAgcmV0dXJuIGYie3Jvd317Y29sOjAyZH0iICAjIFplcm8tcGFkIHRvIDIgZGlnaXRzCiAgICAKICAgIHJldHVybiB3ZWxsX2lkCgoKZGVmIGlzX2JhZF93ZWxsKHdlbGxfaWQ6IHN0ciwgY29uZmlnOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUpIC0+IGJvb2w6CiAgICAiIiIKICAgIENoZWNrIGlmIGEgd2VsbCBpcyBpbiB0aGUgYmFkX3dlbGxzIGxpc3QgZnJvbSBjb25maWcuCiAgICAKICAgIFBhcmFtZXRlcnM6CiAgICAtLS0tLS0tLS0tLQogICAgd2VsbF9pZCA6IHN0cgogICAgICAgIFdlbGwgSUQgdG8gY2hlY2sgKGUuZy4sICJCMTMiLCAiQjA1IikKICAgIGNvbmZpZyA6IERpY3Rbc3RyLCBBbnldLCBvcHRpb25hbAogICAgICAgIENvbmZpZ3VyYXRpb24gZGljdGlvbmFyeS4gSWYgTm9uZSwgbG9hZHMgZnJvbSBwbGF0ZV9jb25maWcuanNvbgogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIGJvb2wKICAgICAgICBUcnVlIGlmIHRoZSB3ZWxsIGlzIGluIHRoZSBiYWRfd2VsbHMgbGlzdCwgRmFsc2Ugb3RoZXJ3aXNlCiAgICAiIiIKICAgIGlmIGNvbmZpZyBpcyBOb25lOgogICAgICAgIHNjcmlwdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgICAgICBjb25maWdfcGF0aCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAicGxhdGVfY29uZmlnLmpzb24iKQogICAgICAgIGNvbmZpZyA9IGxvYWRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgCiAgICBiYWRfd2VsbHMgPSBjb25maWcuZ2V0KCJiYWRfd2VsbHMiLCBbXSkKICAgIGlmIG5vdCBpc2luc3RhbmNlKGJhZF93ZWxscywgbGlzdCk6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgICMgTm9ybWFsaXplIHRoZSBpbnB1dCB3ZWxsIElEIGZvciBjb25zaXN0ZW50IG1hdGNoaW5nCiAgICBub3JtYWxpemVkX3dlbGxfaWQgPSBub3JtYWxpemVfd2VsbF9pZChzdHIod2VsbF9pZCkuc3RyaXAoKSkKICAgIAogICAgIyBDaGVjayBpZiBub3JtYWxpemVkIHdlbGwgSUQgbWF0Y2hlcyBhbnkgYmFkIHdlbGwgKG5vcm1hbGl6ZSBiYWQgd2VsbHMgdG9vKQogICAgZm9yIGJhZF93ZWxsIGluIGJhZF93ZWxsczoKICAgICAgICBub3JtYWxpemVkX2JhZF93ZWxsID0gbm9ybWFsaXplX3dlbGxfaWQoc3RyKGJhZF93ZWxsKS5zdHJpcCgpKQogICAgICAgIGlmIG5vcm1hbGl6ZWRfd2VsbF9pZCA9PSBub3JtYWxpemVkX2JhZF93ZWxsOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgbG9hZF9jb25maWcoY29uZmlnX3BhdGg6IHN0cikgLT4gRGljdFtzdHIsIEFueV06CiAgICAiIiJMb2FkIHBsYXRlIGNvbmZpZ3VyYXRpb24gZmlsZSBpZiBpdCBleGlzdHMsIG90aGVyd2lzZSBnZW5lcmF0ZSBmcm9tIGRlZmF1bHRzLiIiIgogICAgaWYgb3MucGF0aC5leGlzdHMoY29uZmlnX3BhdGgpOgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGNvbmZpZ19wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBjb25maWcgPSBqc29uLmxvYWQoZikKICAgICAgICAgICAgICAgIHByaW50KGYiICBMb2FkZWQgY29uZmlndXJhdGlvbiBmcm9tIHtvcy5wYXRoLmJhc2VuYW1lKGNvbmZpZ19wYXRoKX0iLCBmbHVzaD1UcnVlKQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbmZpZwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiIgIFdhcm5pbmc6IENvdWxkIG5vdCBsb2FkIGNvbmZpZyBmaWxlOiB7ZX0iLCBmbHVzaD1UcnVlKQogICAgICAgICAgICAjIEdlbmVyYXRlIGRlZmF1bHQgY29uZmlnIGlmIGxvYWRpbmcgZmFpbHMKICAgICAgICAgICAgd3JpdGVfZGVmYXVsdF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgZWxzZToKICAgICAgICAjIEdlbmVyYXRlIGRlZmF1bHQgY29uZmlnIGZpbGUgaWYgaXQgZG9lc24ndCBleGlzdAogICAgICAgIHdyaXRlX2RlZmF1bHRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgICAgIHJldHVybiB7fQoKCmRlZiBidWlsZF92aWV3ZXJfanNvbihhbGxfcGxhdGVzOiBEaWN0W3N0ciwgcGQuRGF0YUZyYW1lXSwganNvbl9wYXRoOiBzdHIsIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lLCBwbGF0ZV9pZF90b19maWxlbmFtZTogRGljdFtzdHIsIHN0cl0gPSBOb25lKToKICAgICIiIgogICAgQnVpbGQgdmlld2VyX2RhdGEuanNvbiB3aXRoIHN0cnVjdHVyZToKICAgIHsKICAgICAgImNvbmZpZyI6IHsKICAgICAgICAid2VsbF9sYWJlbHMiOiB7Li4ufSwKICAgICAgICAiZ3JvdXBzIjogWy4uLl0sICAjIHJvdy1sZXR0ZXIgZ3JvdXBzIChhcHBsaWVzIHRvIGFsbCBjb2x1bW5zLCBhdXRvLWdlbmVyYXRlZCBmcm9tIHdlbGxfbGFiZWxzKQogICAgICAgICJjb2x1bW5fZ3JvdXBzIjogey4uLn0gICMgbWFwcGluZyBvZiBjb2x1bW5fZ3JvdXAgdG8gbGlzdCBvZiBwbGF0ZV9pZHMKICAgICAgfSwKICAgICAgInBsYXRlcyI6IFsKICAgICAgICB7CiAgICAgICAgICAiaWQiOiAiPHBsYXRlX2lkPiIsCiAgICAgICAgICAiZmlsZSI6ICI8b3JpZ2luYWxfZmlsZV9uYW1lPiIsCiAgICAgICAgICAiY29sdW1uX2dyb3VwIjogIjxwcm90ZWluX2dlbm90eXBlX2J1ZmZlcj4iLAogICAgICAgICAgImNvbHVtbl9pbmZvIjogewogICAgICAgICAgICAicHJvdGVpbiI6ICIuLi4iLAogICAgICAgICAgICAiZ2Vub3R5cGUiOiAiLi4uIiwKICAgICAgICAgICAgImJ1ZmZlciI6ICIuLi4iLAogICAgICAgICAgICAic2NpZW50aXN0IjogIi4uLiIsCiAgICAgICAgICAgICJudW1iZXIiOiAiLi4uIgogICAgICAgICAgfSwKICAgICAgICAgICJ3ZWxscyI6IHsKICAgICAgICAgICAgIkIxNSI6IHsKICAgICAgICAgICAgICAiY29udGVudCI6ICJTYW1wbGUgWDEiLAogICAgICAgICAgICAgICJsYWJlbCI6ICJTYW1wbGUgWDEiLCAgIyBmcm9tIGNvbmZpZyBpZiBhdmFpbGFibGUKICAgICAgICAgICAgICAidGltZV9zIjogWy4uLl0sCiAgICAgICAgICAgICAgInZhbHVlcyI6IFsuLi5dCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC4uLgogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLi4uCiAgICAgIF0KICAgIH0KICAgICIiIgogICAgaWYgY29uZmlnIGlzIE5vbmU6CiAgICAgICAgY29uZmlnID0ge30KICAgIGlmIHBsYXRlX2lkX3RvX2ZpbGVuYW1lIGlzIE5vbmU6CiAgICAgICAgcGxhdGVfaWRfdG9fZmlsZW5hbWUgPSB7fQogICAgCiAgICAjIEdldCBjb250cm9sIHJvd3MgZnJvbSBjb25maWcgKGRlZmF1bHQ6IFsiTiIsICJPIl0pCiAgICBjb250cm9sX3Jvd3MgPSBjb25maWcuZ2V0KCJjb250cm9sX3Jvd3MiLCBbIk4iLCAiTyJdKQogICAgaWYgbm90IGlzaW5zdGFuY2UoY29udHJvbF9yb3dzLCBsaXN0KToKICAgICAgICBjb250cm9sX3Jvd3MgPSBbIk4iLCAiTyJdICAjIEZhbGxiYWNrIHRvIGRlZmF1bHQgaWYgaW52YWxpZAogICAgCiAgICAjIE1lcmdlIGRlZmF1bHQgd2VsbCBsYWJlbHMgd2l0aCBjb25maWcgbGFiZWxzIChjb25maWcgdGFrZXMgcHJlY2VkZW5jZSkKICAgICMgV2VsbCBsYWJlbHMgYXJlIG5vdyByb3ctYmFzZWQgKGUuZy4sICJCIjogImxhYmVsIikgaW5zdGVhZCBvZiB3ZWxsLXNwZWNpZmljIChlLmcuLCAiQjEzIjogImxhYmVsIikKICAgICMgQ29udmVydCBvbGQgZm9ybWF0IHRvIG5ldyBmb3JtYXQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkKICAgIGNvbmZpZ193ZWxsX2xhYmVscyA9IGNvbmZpZy5nZXQoIndlbGxfbGFiZWxzIiwge30pCiAgICB3ZWxsX2xhYmVscyA9IHt9CiAgICAKICAgICMgUHJvY2VzcyBjb25maWcgbGFiZWxzIC0gY29udmVydCB3ZWxsLXNwZWNpZmljIHRvIHJvdy1iYXNlZCBpZiBuZWVkZWQKICAgIGZvciBrZXksIHZhbHVlIGluIGNvbmZpZ193ZWxsX2xhYmVscy5pdGVtcygpOgogICAgICAgIGlmIGxlbihrZXkpID4gMSBhbmQga2V5WzBdLmlzYWxwaGEoKSBhbmQga2V5WzE6XS5pc2RpZ2l0KCk6CiAgICAgICAgICAgICMgT2xkIGZvcm1hdDogIkIxMyIgLT4gZXh0cmFjdCByb3cgIkIiCiAgICAgICAgICAgIHJvd19sZXR0ZXIgPSBrZXlbMF0KICAgICAgICAgICAgIyBVc2UgdGhlIGxhc3Qgbm9uLWVtcHR5IHZhbHVlIGZvciBlYWNoIHJvdyAoaW4gY2FzZSBvZiBkdXBsaWNhdGVzKQogICAgICAgICAgICBpZiByb3dfbGV0dGVyIG5vdCBpbiB3ZWxsX2xhYmVsczoKICAgICAgICAgICAgICAgIHdlbGxfbGFiZWxzW3Jvd19sZXR0ZXJdID0gdmFsdWUKICAgICAgICAgICAgZWxpZiBub3Qgd2VsbF9sYWJlbHNbcm93X2xldHRlcl0gb3Igbm90IHdlbGxfbGFiZWxzW3Jvd19sZXR0ZXJdLnN0cmlwKCk6CiAgICAgICAgICAgICAgICB3ZWxsX2xhYmVsc1tyb3dfbGV0dGVyXSA9IHZhbHVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBOZXcgZm9ybWF0OiAiQiIgLT4gdXNlIGFzIGlzCiAgICAgICAgICAgIHdlbGxfbGFiZWxzW2tleV0gPSB2YWx1ZQogICAgCiAgICAjIEFsc28gY29udmVydCBERUZBVUxUX1dFTExfTEFCRUxTIHRvIHJvdy1iYXNlZCBmb3JtYXQKICAgIGRlZmF1bHRfcm93X2xhYmVscyA9IHt9CiAgICBmb3Iga2V5LCB2YWx1ZSBpbiBERUZBVUxUX1dFTExfTEFCRUxTLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGtleSkgPiAxIGFuZCBrZXlbMF0uaXNhbHBoYSgpOgogICAgICAgICAgICByb3dfbGV0dGVyID0ga2V5WzBdCiAgICAgICAgICAgIGlmIHJvd19sZXR0ZXIgbm90IGluIGRlZmF1bHRfcm93X2xhYmVsczoKICAgICAgICAgICAgICAgIGRlZmF1bHRfcm93X2xhYmVsc1tyb3dfbGV0dGVyXSA9IHZhbHVlCiAgICAKICAgICMgTWVyZ2UgZGVmYXVsdHMgd2l0aCBjb25maWcgKGNvbmZpZyB0YWtlcyBwcmVjZWRlbmNlKQogICAgd2VsbF9sYWJlbHMgPSB7KipkZWZhdWx0X3Jvd19sYWJlbHMsICoqd2VsbF9sYWJlbHN9CiAgICAKICAgICMgUGFyc2UgY29sdW1uIGdyb3VwcyBmcm9tIGZpbGVuYW1lcwogICAgY29sdW1uX2dyb3VwczogRGljdFtzdHIsIExpc3Rbc3RyXV0gPSB7fSAgIyBjb2x1bW5fZ3JvdXAgLT4gbGlzdCBvZiBwbGF0ZV9pZHMKICAgIHBsYXRlX2NvbHVtbl9pbmZvOiBEaWN0W3N0ciwgRGljdFtzdHIsIHN0cl1dID0ge30gICMgcGxhdGVfaWQgLT4gY29sdW1uX2luZm8KICAgIAogICAgZm9yIHBsYXRlX2lkLCBkZiBpbiBhbGxfcGxhdGVzLml0ZW1zKCk6CiAgICAgICAgZmlsZW5hbWUgPSBwbGF0ZV9pZF90b19maWxlbmFtZS5nZXQocGxhdGVfaWQsIHBsYXRlX2lkICsgIi54bHN4IikKICAgICAgICBjb2x1bW5faW5mbyA9IHBhcnNlX2NvbHVtbl9ncm91cF9mcm9tX2ZpbGVuYW1lKGZpbGVuYW1lKQogICAgICAgIGNvbHVtbl9ncm91cCA9IGNvbHVtbl9pbmZvWyJjb2x1bW5fZ3JvdXAiXQogICAgICAgIAogICAgICAgIHBsYXRlX2NvbHVtbl9pbmZvW3BsYXRlX2lkXSA9IGNvbHVtbl9pbmZvCiAgICAgICAgCiAgICAgICAgaWYgY29sdW1uX2dyb3VwIG5vdCBpbiBjb2x1bW5fZ3JvdXBzOgogICAgICAgICAgICBjb2x1bW5fZ3JvdXBzW2NvbHVtbl9ncm91cF0gPSBbXQogICAgICAgIGlmIHBsYXRlX2lkIG5vdCBpbiBjb2x1bW5fZ3JvdXBzW2NvbHVtbl9ncm91cF06CiAgICAgICAgICAgIGNvbHVtbl9ncm91cHNbY29sdW1uX2dyb3VwXS5hcHBlbmQocGxhdGVfaWQpCiAgICAKICAgICMgQXV0by1nZW5lcmF0ZSBncm91cHMgZnJvbSB3ZWxsX2xhYmVscwogICAgIyBHcm91cHMgd2VsbHMgd2l0aCB0aGUgc2FtZSBsYWJlbCB0b2dldGhlcgogICAgIyBFeGNsdWRlIGNvbnRyb2wgd2VsbHMgZnJvbSBncm91cHMKICAgIGdyb3VwcyA9IFtdCiAgICBsYWJlbF90b19yb3dzOiBEaWN0W3N0ciwgTGlzdFtzdHJdXSA9IHt9CiAgICAKICAgICMgR3JvdXAgcm93IGxldHRlcnMgYnkgdGhlaXIgbGFiZWxzCiAgICBmb3Igcm93X2xldHRlciwgbGFiZWwgaW4gd2VsbF9sYWJlbHMuaXRlbXMoKToKICAgICAgICAjIEZpbHRlciBvdXQgY29udHJvbCB3ZWxscwogICAgICAgIGlmIG5vdCBpc19jb250cm9sX3dlbGwocm93X2xldHRlciwgY29udHJvbF9yb3dzKToKICAgICAgICAgICAgaWYgbGFiZWwgYW5kIHN0cihsYWJlbCkuc3RyaXAoKToKICAgICAgICAgICAgICAgIGlmIGxhYmVsIG5vdCBpbiBsYWJlbF90b19yb3dzOgogICAgICAgICAgICAgICAgICAgIGxhYmVsX3RvX3Jvd3NbbGFiZWxdID0gW10KICAgICAgICAgICAgICAgIGlmIHJvd19sZXR0ZXIgbm90IGluIGxhYmVsX3RvX3Jvd3NbbGFiZWxdOgogICAgICAgICAgICAgICAgICAgIGxhYmVsX3RvX3Jvd3NbbGFiZWxdLmFwcGVuZChyb3dfbGV0dGVyKQogICAgCiAgICAjIENyZWF0ZSBncm91cHMgZnJvbSBsYWJlbHMKICAgIGZvciBsYWJlbCwgcm93X2xldHRlcnMgaW4gbGFiZWxfdG9fcm93cy5pdGVtcygpOgogICAgICAgIGlmIGxlbihyb3dfbGV0dGVycykgPj0gMTogICMgQXQgbGVhc3QgMSByb3cgd2l0aCB0aGlzIGxhYmVsCiAgICAgICAgICAgIGdyb3Vwcy5hcHBlbmQoewogICAgICAgICAgICAgICAgIm5hbWUiOiBsYWJlbCwKICAgICAgICAgICAgICAgICJ3ZWxscyI6IHNvcnRlZChyb3dfbGV0dGVycykgICMgU3RvcmUgcm93IGxldHRlcnMgb25seQogICAgICAgICAgICB9KQogICAgCiAgICAjIFNvcnQgZ3JvdXBzIGJ5IG5hbWUKICAgIGdyb3Vwcy5zb3J0KGtleT1sYW1iZGEgeDogeC5nZXQoIm5hbWUiLCAiIikpCiAgICAKICAgIGlmIGdyb3VwczoKICAgICAgICBwcmludChmIiAgQXV0by1nZW5lcmF0ZWQge2xlbihncm91cHMpfSBncm91cChzKSBmcm9tIHdlbGxfbGFiZWxzIChhcHBsaWVzIHRvIGFsbCBjb2x1bW5zKSIsIGZsdXNoPVRydWUpCiAgICBlbHNlOgogICAgICAgIHByaW50KGYiICBObyBncm91cHMgZ2VuZXJhdGVkIGZyb20gd2VsbF9sYWJlbHMiLCBmbHVzaD1UcnVlKQogICAgCiAgICAjIERldGVjdCBkdXBsaWNhdGUgd2VsbCBJRHMgKHNhbWUgd2VsbCBJRCBhcHBlYXJzIGluIG11bHRpcGxlIGZpbGVzKQogICAgIyBPbmx5IGZsYWcgYXMgZHVwbGljYXRlIGlmIHNhbWUgc2NpZW50aXN0IEFORCBzYW1lIHdlbGwgSUQKICAgICMgVGhpcyBtZWFucyBkdXBsaWNhdGUgY29sdW1ucyBpbiB0aGUgcGxhdGUgZ3JpZAogICAgIyBTdHJ1Y3R1cmU6IChzY2llbnRpc3QsIHdlbGxfaWQpIC0+IGxpc3Qgb2YgZmlsZW5hbWVzCiAgICBzY2llbnRpc3Rfd2VsbF90b19maWxlczogRGljdFt0dXBsZSwgTGlzdFtzdHJdXSA9IHt9ICAjIChzY2llbnRpc3QsIHdlbGxfaWQpIC0+IGxpc3Qgb2YgZmlsZW5hbWVzCiAgICAKICAgICMgQnVpbGQgbWFwIG9mIHBsYXRlX2lkIHRvIHNjaWVudGlzdCBmb3IgcXVpY2sgbG9va3VwCiAgICBwbGF0ZV9pZF90b19zY2llbnRpc3Q6IERpY3Rbc3RyLCBzdHJdID0ge30KICAgIGZvciBwbGF0ZV9pZCwgZGYgaW4gYWxsX3BsYXRlcy5pdGVtcygpOgogICAgICAgIGZpbGVuYW1lID0gcGxhdGVfaWRfdG9fZmlsZW5hbWUuZ2V0KHBsYXRlX2lkLCBwbGF0ZV9pZCArICIueGxzeCIpCiAgICAgICAgY29sdW1uX2luZm8gPSBwbGF0ZV9jb2x1bW5faW5mby5nZXQocGxhdGVfaWQsIHBhcnNlX2NvbHVtbl9ncm91cF9mcm9tX2ZpbGVuYW1lKGZpbGVuYW1lKSkKICAgICAgICBzY2llbnRpc3QgPSBjb2x1bW5faW5mby5nZXQoInNjaWVudGlzdCIsICIiKQogICAgICAgIHBsYXRlX2lkX3RvX3NjaWVudGlzdFtwbGF0ZV9pZF0gPSBzY2llbnRpc3QKICAgIAogICAgZm9yIHBsYXRlX2lkLCBkZiBpbiBhbGxfcGxhdGVzLml0ZW1zKCk6CiAgICAgICAgZmlsZW5hbWUgPSBwbGF0ZV9pZF90b19maWxlbmFtZS5nZXQocGxhdGVfaWQsIHBsYXRlX2lkICsgIi54bHN4IikKICAgICAgICBzY2llbnRpc3QgPSBwbGF0ZV9pZF90b19zY2llbnRpc3QuZ2V0KHBsYXRlX2lkLCAiIikKICAgICAgICAjIEdldCBhbGwgdW5pcXVlIHdlbGwgSURzIGZyb20gdGhpcyBwbGF0ZQogICAgICAgIHVuaXF1ZV93ZWxscyA9IGRmWyJ3ZWxsIl0udW5pcXVlKCkKICAgICAgICBmb3Igd2VsbF9pZCBpbiB1bmlxdWVfd2VsbHM6CiAgICAgICAgICAgICMgTm9ybWFsaXplIHdlbGwgSUQgZm9yIGNvbnNpc3RlbnQgZHVwbGljYXRlIGRldGVjdGlvbgogICAgICAgICAgICB3ZWxsX2lkX3N0ciA9IG5vcm1hbGl6ZV93ZWxsX2lkKHN0cih3ZWxsX2lkKS5zdHJpcCgpKQogICAgICAgICAgICBrZXkgPSAoc2NpZW50aXN0LCB3ZWxsX2lkX3N0cikKICAgICAgICAgICAgaWYga2V5IG5vdCBpbiBzY2llbnRpc3Rfd2VsbF90b19maWxlczoKICAgICAgICAgICAgICAgIHNjaWVudGlzdF93ZWxsX3RvX2ZpbGVzW2tleV0gPSBbXQogICAgICAgICAgICBpZiBmaWxlbmFtZSBub3QgaW4gc2NpZW50aXN0X3dlbGxfdG9fZmlsZXNba2V5XToKICAgICAgICAgICAgICAgIHNjaWVudGlzdF93ZWxsX3RvX2ZpbGVzW2tleV0uYXBwZW5kKGZpbGVuYW1lKQogICAgCiAgICAjIEdyb3VwIGR1cGxpY2F0ZXMgYnkgZmlsZSBwYWlycyBmb3IgY2xlYW5lciBtZXNzYWdpbmcKICAgICMgT25seSBmbGFnIGlmIHNhbWUgc2NpZW50aXN0IEFORCBzYW1lIHdlbGwgSUQKICAgIGR1cGxpY2F0ZV9jb2x1bW5fd2FybmluZ3MgPSBbXQogICAgZmlsZV9wYWlyc190b19jb2x1bW5zOiBEaWN0W3N0ciwgTGlzdFtpbnRdXSA9IHt9ICAjICJmaWxlMXxmaWxlMiIgLT4gW2NvbHVtbl9udW1iZXJzXQogICAgCiAgICBmb3IgKHNjaWVudGlzdCwgd2VsbF9pZCksIGZpbGVzIGluIHNjaWVudGlzdF93ZWxsX3RvX2ZpbGVzLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGZpbGVzKSA+IDE6CiAgICAgICAgICAgICMgRXh0cmFjdCBjb2x1bW4gbnVtYmVyIGZyb20gd2VsbCBJRCAoZS5nLiwgIkIxMyIgLT4gMTMpCiAgICAgICAgICAgIGltcG9ydCByZQogICAgICAgICAgICBjb2xfbWF0Y2ggPSByZS5tYXRjaChyJ15bQS1aXShcZCspJCcsIHdlbGxfaWQpCiAgICAgICAgICAgIGlmIGNvbF9tYXRjaDoKICAgICAgICAgICAgICAgIGNvbHVtbl9udW0gPSBpbnQoY29sX21hdGNoLmdyb3VwKDEpKQogICAgICAgICAgICAgICAgIyBTb3J0IGZpbGVzIGFscGhhYmV0aWNhbGx5IGZvciBjb25zaXN0ZW50IG9yZGVyaW5nCiAgICAgICAgICAgICAgICBzb3J0ZWRfZmlsZXMgPSBzb3J0ZWQoZmlsZXMpCiAgICAgICAgICAgICAgICBmaWxlX2tleSA9ICJ8Ii5qb2luKHNvcnRlZF9maWxlcykKICAgICAgICAgICAgICAgIGlmIGZpbGVfa2V5IG5vdCBpbiBmaWxlX3BhaXJzX3RvX2NvbHVtbnM6CiAgICAgICAgICAgICAgICAgICAgZmlsZV9wYWlyc190b19jb2x1bW5zW2ZpbGVfa2V5XSA9IFtdCiAgICAgICAgICAgICAgICBpZiBjb2x1bW5fbnVtIG5vdCBpbiBmaWxlX3BhaXJzX3RvX2NvbHVtbnNbZmlsZV9rZXldOgogICAgICAgICAgICAgICAgICAgIGZpbGVfcGFpcnNfdG9fY29sdW1uc1tmaWxlX2tleV0uYXBwZW5kKGNvbHVtbl9udW0pCiAgICAKICAgICMgQnVpbGQgd2FybmluZ3MgZ3JvdXBlZCBieSBmaWxlIHBhaXJzIC0gb25seSBzaG93IGNvbHVtbiBudW1iZXJzCiAgICBmb3IgZmlsZV9rZXksIGNvbHVtbl9udW1iZXJzIGluIGZpbGVfcGFpcnNfdG9fY29sdW1ucy5pdGVtcygpOgogICAgICAgIGZpbGVzID0gZmlsZV9rZXkuc3BsaXQoInwiKQogICAgICAgIHNvcnRlZF9jb2x1bW5zID0gc29ydGVkKGNvbHVtbl9udW1iZXJzKQogICAgICAgIGR1cGxpY2F0ZV9jb2x1bW5fd2FybmluZ3MuYXBwZW5kKHsKICAgICAgICAgICAgImZpbGVzIjogZmlsZXMsCiAgICAgICAgICAgICJjb2x1bW5zIjogc29ydGVkX2NvbHVtbnMgICMgQ2hhbmdlZCBmcm9tIHdlbGxfaWRzIHRvIGNvbHVtbnMKICAgICAgICB9KQogICAgICAgIAogICAgICAgICMgQ29uc29sZSBtZXNzYWdlIC0gb25seSBzaG93IGNvbHVtbiBudW1iZXJzCiAgICAgICAgZmlsZXNfc3RyID0gIiBhbmQgIi5qb2luKGZpbGVzKQogICAgICAgIGNvbHVtbnNfc3RyID0gIiwgIi5qb2luKFtzdHIoYykgZm9yIGMgaW4gc29ydGVkX2NvbHVtbnNbOjEwXV0pICAjIFNob3cgZmlyc3QgMTAKICAgICAgICBpZiBsZW4oc29ydGVkX2NvbHVtbnMpID4gMTA6CiAgICAgICAgICAgIGNvbHVtbnNfc3RyICs9IGYiLCAuLi4gKHtsZW4oc29ydGVkX2NvbHVtbnMpfSB0b3RhbCkiCiAgICAgICAgcHJpbnQoZiIgIOKaoO+4jyAgV0FSTklORzoge2ZpbGVzX3N0cn0gaGF2ZSBkdXBsaWNhdGUgY29sdW1uczoge2NvbHVtbnNfc3RyfSIsIGZsdXNoPVRydWUpCiAgICAgICAgcHJpbnQoZiIgICAgIE9ubHkgZGF0YSBmcm9tICd7ZmlsZXNbMF19JyAoZmlyc3QgYWxwaGFiZXRpY2FsbHkpIGlzIHVzZWQuIiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgZGF0YSA9IHsKICAgICAgICAiY29uZmlnIjogewogICAgICAgICAgICAid2VsbF9sYWJlbHMiOiB3ZWxsX2xhYmVscywKICAgICAgICAgICAgImdyb3VwcyI6IGdyb3VwcywKICAgICAgICAgICAgImNvbHVtbl9ncm91cHMiOiBjb2x1bW5fZ3JvdXBzLAogICAgICAgICAgICAiY29udHJvbF9yb3dzIjogY29udHJvbF9yb3dzLAogICAgICAgICAgICAid2FybmluZ3MiOiB7CiAgICAgICAgICAgICAgICAiZHVwbGljYXRlX2NvbHVtbnMiOiBkdXBsaWNhdGVfY29sdW1uX3dhcm5pbmdzCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJwbGF0ZXMiOiBbXQogICAgfQogICAgCiAgICAjIEJ1aWxkIHBsYXRlcyBsaXN0IGFuZCBzb3J0IGJ5IHNjaWVudGlzdCBpbml0aWFscwogICAgcGxhdGVzX2xpc3QgPSBbXQogICAgZm9yIHBsYXRlX2lkLCBkZiBpbiBhbGxfcGxhdGVzLml0ZW1zKCk6CiAgICAgICAgd2VsbHNfZGljdDogRGljdFtzdHIsIEFueV0gPSB7fQogICAgICAgIGZvciB3ZWxsX2lkLCBnIGluIGRmLmdyb3VwYnkoIndlbGwiKToKICAgICAgICAgICAgIyBOb3JtYWxpemUgd2VsbCBJRCB0byBjb25zaXN0ZW50IGZvcm1hdCAoemVyby1wYWRkZWQpCiAgICAgICAgICAgIG5vcm1hbGl6ZWRfd2VsbF9pZCA9IG5vcm1hbGl6ZV93ZWxsX2lkKHdlbGxfaWQpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNraXAgYmFkIHdlbGxzCiAgICAgICAgICAgIGlmIGlzX2JhZF93ZWxsKG5vcm1hbGl6ZWRfd2VsbF9pZCwgY29uZmlnKToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgICAgICBnX3NvcnRlZCA9IGcuc29ydF92YWx1ZXMoInRpbWVfcyIpCiAgICAgICAgICAgIGNvbnRlbnQgPSBnX3NvcnRlZFsiY29udGVudCJdLmlsb2NbMF0KICAgICAgICAgICAgIyBVc2Ugcm93LWJhc2VkIGxhYmVsIGZyb20gY29uZmlnIGlmIGF2YWlsYWJsZSwgb3RoZXJ3aXNlIHVzZSBjb250ZW50CiAgICAgICAgICAgICMgRXh0cmFjdCByb3cgbGV0dGVyIGZyb20gbm9ybWFsaXplZCB3ZWxsX2lkIChlLmcuLCAiQjEzIiAtPiAiQiIpCiAgICAgICAgICAgIHJvd19sZXR0ZXIgPSBub3JtYWxpemVkX3dlbGxfaWRbMF0gaWYgbm9ybWFsaXplZF93ZWxsX2lkIGFuZCBub3JtYWxpemVkX3dlbGxfaWRbMF0uaXNhbHBoYSgpIGVsc2UgIiIKICAgICAgICAgICAgbGFiZWwgPSB3ZWxsX2xhYmVscy5nZXQocm93X2xldHRlciwgY29udGVudCkgaWYgcm93X2xldHRlciBlbHNlIGNvbnRlbnQKICAgICAgICAgICAgd2VsbHNfZGljdFtub3JtYWxpemVkX3dlbGxfaWRdID0gewogICAgICAgICAgICAgICAgImNvbnRlbnQiOiBjb250ZW50LAogICAgICAgICAgICAgICAgImxhYmVsIjogbGFiZWwsCiAgICAgICAgICAgICAgICAidGltZV9zIjogZ19zb3J0ZWRbInRpbWVfcyJdLnRvbGlzdCgpLAogICAgICAgICAgICAgICAgInZhbHVlcyI6IGdfc29ydGVkWyJ2YWx1ZSJdLnRvbGlzdCgpLAogICAgICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZmlsZW5hbWUgPSBwbGF0ZV9pZF90b19maWxlbmFtZS5nZXQocGxhdGVfaWQsIHBsYXRlX2lkICsgIi54bHN4IikKICAgICAgICBjb2x1bW5faW5mbyA9IHBsYXRlX2NvbHVtbl9pbmZvLmdldChwbGF0ZV9pZCwgcGFyc2VfY29sdW1uX2dyb3VwX2Zyb21fZmlsZW5hbWUoZmlsZW5hbWUpKQogICAgICAgIAogICAgICAgIHBsYXRlc19saXN0LmFwcGVuZCgKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgImlkIjogcGxhdGVfaWQsCiAgICAgICAgICAgICAgICAiZmlsZSI6IGZpbGVuYW1lLAogICAgICAgICAgICAgICAgImNvbHVtbl9ncm91cCI6IGNvbHVtbl9pbmZvWyJjb2x1bW5fZ3JvdXAiXSwKICAgICAgICAgICAgICAgICJjb2x1bW5faW5mbyI6IHsKICAgICAgICAgICAgICAgICAgICAicHJvdGVpbiI6IGNvbHVtbl9pbmZvWyJwcm90ZWluIl0sCiAgICAgICAgICAgICAgICAgICAgImdlbm90eXBlIjogY29sdW1uX2luZm9bImdlbm90eXBlIl0sCiAgICAgICAgICAgICAgICAgICAgImJ1ZmZlciI6IGNvbHVtbl9pbmZvWyJidWZmZXIiXSwKICAgICAgICAgICAgICAgICAgICAic2NpZW50aXN0IjogY29sdW1uX2luZm9bInNjaWVudGlzdCJdLAogICAgICAgICAgICAgICAgICAgICJudW1iZXIiOiBjb2x1bW5faW5mb1sibnVtYmVyIl0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAid2VsbHMiOiB3ZWxsc19kaWN0LAogICAgICAgICAgICB9CiAgICAgICAgKQogICAgCiAgICAjIFNvcnQgcGxhdGVzIGJ5IHNjaWVudGlzdCBpbml0aWFscyAoZW1wdHkgc2NpZW50aXN0IGdvZXMgbGFzdCkKICAgIHBsYXRlc19saXN0LnNvcnQoa2V5PWxhbWJkYSBwOiAocFsiY29sdW1uX2luZm8iXVsic2NpZW50aXN0Il0gb3IgInp6eiIsIHBbImZpbGUiXSkpCiAgICBkYXRhWyJwbGF0ZXMiXSA9IHBsYXRlc19saXN0CgogICAgd2l0aCBvcGVuKGpzb25fcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgIGpzb24uZHVtcChkYXRhLCBmLCBpbmRlbnQ9MikKCgpIVE1MX1RFTVBMQVRFID0gciIiIjwhRE9DVFlQRSBodG1sPgo8aHRtbCBsYW5nPSJlbiI+CjxoZWFkPgogIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICA8dGl0bGU+UGxhdGUgVmlld2VyPC90aXRsZT4KICA8c3R5bGU+CiAgICBib2R5IHsKICAgICAgZm9udC1mYW1pbHk6IHN5c3RlbS11aSwgLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCAiU2Vnb2UgVUkiLCBzYW5zLXNlcmlmOwogICAgICBtYXJnaW46IDA7CiAgICAgIHBhZGRpbmc6IDA7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgIGhlaWdodDogMTAwdmg7CiAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICB9CiAgICAjY29udGVudC13cmFwcGVyIHsKICAgICAgZGlzcGxheTogZ3JpZDsKICAgICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAzMjBweCAxZnI7CiAgICAgIGZsZXg6IDE7CiAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB9CiAgICBhc2lkZSB7CiAgICAgIGJvcmRlci1yaWdodDogMXB4IHNvbGlkICNjY2M7CiAgICAgIHBhZGRpbmc6IDE2cHg7CiAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICAgIGJhY2tncm91bmQ6ICNmN2Y3Zjc7CiAgICAgIG92ZXJmbG93LXk6IGF1dG87CiAgICB9CiAgICBtYWluIHsKICAgICAgcGFkZGluZzogMTZweDsKICAgICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgICAgb3ZlcmZsb3c6IGF1dG87CiAgICB9CiAgICBoMSB7CiAgICAgIGZvbnQtc2l6ZTogMS4ycmVtOwogICAgICBtYXJnaW4tdG9wOiAwOwogICAgfQogICAgbGFiZWwgewogICAgICBkaXNwbGF5OiBibG9jazsKICAgICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgICBmb250LXdlaWdodDogNjAwOwogICAgfQogICAgc2VsZWN0IHsKICAgICAgd2lkdGg6IDEwMCUlOwogICAgICBwYWRkaW5nOiA4cHg7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7CiAgICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgIGZvbnQtc2l6ZTogMC45cmVtOwogICAgICBtYXJnaW4tYm90dG9tOiAxNnB4OwogICAgfQogICAgLmRhdGFzZXQtbGluZS1pdGVtIHsKICAgICAgcGFkZGluZzogOHB4IDEycHg7CiAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkICNlZWU7CiAgICAgIGZvbnQtc2l6ZTogMC45cmVtOwogICAgICB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kLWNvbG9yIDAuMTVzIGVhc2U7CiAgICAgIHVzZXItc2VsZWN0OiBub25lOwogICAgfQogICAgLmRhdGFzZXQtbGluZS1pdGVtOmhvdmVyIHsKICAgICAgYmFja2dyb3VuZC1jb2xvcjogI2YwZjBmMDsKICAgIH0KICAgIC5kYXRhc2V0LWxpbmUtaXRlbS5zZWxlY3RlZCB7CiAgICAgIGJhY2tncm91bmQtY29sb3I6ICNlNGYwZmY7CiAgICAgIGJvcmRlci1sZWZ0OiAzcHggc29saWQgIzJhNmNmZjsKICAgICAgZm9udC13ZWlnaHQ6IDUwMDsKICAgIH0KICAgIC5kYXRhc2V0LWxpbmUtaXRlbTpsYXN0LWNoaWxkIHsKICAgICAgYm9yZGVyLWJvdHRvbTogbm9uZTsKICAgIH0KICAgICN3ZWxsLWluZm8gewogICAgICBtYXJnaW4tdG9wOiA4cHg7CiAgICAgIGZvbnQtc2l6ZTogMC45cmVtOwogICAgICBwYWRkaW5nOiA4cHg7CiAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7CiAgICB9CiAgICAjcGxhdGUtZ3JpZCB7CiAgICAgIGRpc3BsYXk6IGdyaWQ7CiAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogYXV0byByZXBlYXQoJShjb2xzKWQsIDFmcik7CiAgICAgIGdyaWQtYXV0by1yb3dzOiAzMnB4OwogICAgICBnYXA6IDJweDsKICAgICAgZm9udC1zaXplOiAxMXB4OwogICAgICBtYXJnaW4tYm90dG9tOiAxNnB4OwogICAgfQogICAgLmdyaWQtaGVhZGVyIHsKICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgfQogICAgLnJvdy1sYWJlbCwgLmNvbC1sYWJlbCB7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgfQogICAgLndlbGwgewogICAgICBib3JkZXI6IDFweCBzb2xpZCAjZGRkOwogICAgICBib3JkZXItcmFkaXVzOiAzcHg7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgIGJhY2tncm91bmQ6ICNmZmY7CiAgICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgICAgZm9udC1zaXplOiAxMHB4OwogICAgICBwb2ludGVyLWV2ZW50czogYXV0bzsKICAgICAgei1pbmRleDogMTsKICAgIH0KICAgIC53ZWxsW2RhdGEtaGFzLWRhdGE9InRydWUiXTpub3QoLnRyaXBsaWNhdGUtZ3JvdXApOm5vdCguY29udHJvbCkgewogICAgICBiYWNrZ3JvdW5kOiAjZTRmMGZmOwogICAgICBib3JkZXItY29sb3I6ICM2YzljZmY7CiAgICB9CiAgICAud2VsbC5zZWxlY3RlZCB7CiAgICAgIG91dGxpbmU6IDJweCBzb2xpZCAjMmE2Y2ZmOwogICAgICBvdXRsaW5lLW9mZnNldDogLTJweDsKICAgICAgYmFja2dyb3VuZDogI2U0ZjBmZjsKICAgIH0KICAgIC53ZWxsLnJlcGxpY2F0ZSB7CiAgICAgIGJvcmRlci1zdHlsZTogZGFzaGVkOwogICAgfQogICAgLndlbGwudHJpcGxpY2F0ZS1ncm91cCB7CiAgICAgIC8qIEJvcmRlcnMgYXJlIGFkZGVkIHZpYSBpbmxpbmUgc3R5bGVzIG9ubHkgd2hlbiBzZWxlY3RlZCAqLwogICAgfQogICAgLyogSW5kaXZpZHVhbCBjb2xvcnMgd2lsbCBiZSBhcHBsaWVkIHZpYSBpbmxpbmUgc3R5bGVzICovCiAgICAud2VsbC5jb250cm9sIHsKICAgICAgYmFja2dyb3VuZDogI2U4ZjVlOTsKICAgICAgYm9yZGVyOiAxcHggc29saWQgI2RkZDsKICAgIH0KICAgIC53ZWxsLmNvbnRyb2xbZGF0YS1oYXMtZGF0YT0idHJ1ZSJdIHsKICAgICAgYmFja2dyb3VuZDogI2M4ZTZjOTsKICAgICAgYm9yZGVyLWNvbG9yOiAjNmM5Y2ZmOwogICAgfQogICAgLndlbGwuY29udHJvbC5zZWxlY3RlZCB7CiAgICAgIGJhY2tncm91bmQ6ICNjOGU2Yzk7CiAgICAgIG91dGxpbmU6IDJweCBzb2xpZCAjMmE2Y2ZmOwogICAgICBvdXRsaW5lLW9mZnNldDogLTJweDsKICAgIH0KICAgIC53ZWxsLWxhYmVsIHsKICAgICAgZm9udC1zaXplOiA4cHg7CiAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgYm90dG9tOiAxcHg7CiAgICAgIGxlZnQ6IDFweDsKICAgICAgcmlnaHQ6IDFweDsKICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICB0ZXh0LW92ZXJmbG93OiBlbGxpcHNpczsKICAgICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICAgIHotaW5kZXg6IDI7CiAgICB9CiAgICAjY2hhcnQtY29udGFpbmVyIHsKICAgICAgbWFyZ2luLXRvcDogMTJweDsKICAgICAgaGVpZ2h0OiA4MDBweDsKICAgICAgbWluLWhlaWdodDogODAwcHg7CiAgICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIH0KICAgIGNhbnZhcyB7CiAgICAgIG1heC13aWR0aDogMTAwJSU7CiAgICAgIGhlaWdodDogODAwcHggIWltcG9ydGFudDsKICAgIH0KICAgIC5idG4gewogICAgICBwYWRkaW5nOiA2cHggMTJweDsKICAgICAgbWFyZ2luOiA0cHggMDsKICAgICAgYm9yZGVyOiAxcHggc29saWQgI2NjYzsKICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICBmb250LXNpemU6IDAuOXJlbTsKICAgIH0KICAgIC5idG46aG92ZXIgewogICAgICBiYWNrZ3JvdW5kOiAjZjBmMGYwOwogICAgfQogICAgLmJ0bi1wcmltYXJ5IHsKICAgICAgYmFja2dyb3VuZDogIzJhNmNmZjsKICAgICAgY29sb3I6IHdoaXRlOwogICAgICBib3JkZXItY29sb3I6ICMyYTZjZmY7CiAgICB9CiAgICAuYnRuLXByaW1hcnk6aG92ZXIgewogICAgICBiYWNrZ3JvdW5kOiAjMWE1Y2ZmOwogICAgfQogICAgI3dhcm5pbmctYmFubmVyIHsKICAgICAgYmFja2dyb3VuZDogI2ZmZjNjZDsKICAgICAgYm9yZGVyOiAycHggc29saWQgI2ZmYzEwNzsKICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICBwYWRkaW5nOiAxMnB4IDE2cHg7CiAgICAgIG1hcmdpbjogMTZweDsKICAgICAgbWFyZ2luLWJvdHRvbTogMDsKICAgICAgZm9udC1zaXplOiAwLjlyZW07CiAgICAgIGNvbG9yOiAjODU2NDA0OwogICAgICBkaXNwbGF5OiBub25lOwogICAgfQogICAgI3dhcm5pbmctYmFubmVyLnNob3cgewogICAgICBkaXNwbGF5OiBibG9jazsKICAgIH0KICAgICN3YXJuaW5nLWJhbm5lciBoMyB7CiAgICAgIG1hcmdpbjogMCAwIDhweCAwOwogICAgICBmb250LXNpemU6IDFyZW07CiAgICAgIGNvbG9yOiAjODU2NDA0OwogICAgfQogICAgI3dhcm5pbmctYmFubmVyIHVsIHsKICAgICAgbWFyZ2luOiA4cHggMCAwIDA7CiAgICAgIHBhZGRpbmctbGVmdDogMjBweDsKICAgIH0KICAgICN3YXJuaW5nLWJhbm5lciBsaSB7CiAgICAgIG1hcmdpbjogNHB4IDA7CiAgICB9CiAgICBpbnB1dFt0eXBlPSJjaGVja2JveCJdOmRpc2FibGVkIHsKICAgICAgb3BhY2l0eTogMC41OwogICAgICBjdXJzb3I6IG5vdC1hbGxvd2VkICFpbXBvcnRhbnQ7CiAgICB9CiAgICBpbnB1dFt0eXBlPSJjaGVja2JveCJdOmRpc2FibGVkICsgc3BhbiB7CiAgICAgIG9wYWNpdHk6IDAuNjsKICAgICAgY29sb3I6ICM5OTk7CiAgICB9CiAgPC9zdHlsZT4KICA8IS0tIENoYXJ0LmpzIHZpYSBDRE4gLS0+CiAgPHNjcmlwdCBzcmM9Imh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vY2hhcnQuanMiPjwvc2NyaXB0Pgo8L2hlYWQ+Cjxib2R5PgogIDxkaXYgaWQ9Indhcm5pbmctYmFubmVyIj48L2Rpdj4KICA8ZGl2IGlkPSJjb250ZW50LXdyYXBwZXIiPgogIDxhc2lkZT4KICAgIDxoMT5QbGF0ZSBWaWV3ZXI8L2gxPgogICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZ2FwOiA2cHg7IG1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICA8bGFiZWwgc3R5bGU9Im1hcmdpbjogMDsiPlNlbGVjdCBEYXRhc2V0IEdyb3Vwczo8L2xhYmVsPgogICAgICA8ZGl2IHN0eWxlPSJwb3NpdGlvbjogcmVsYXRpdmU7IGRpc3BsYXk6IGlubGluZS1ibG9jazsiPgogICAgICAgIDxzcGFuIHN0eWxlPSJjdXJzb3I6IGhlbHA7IGNvbG9yOiAjNjY2OyBmb250LXNpemU6IDAuOXJlbTsgZm9udC13ZWlnaHQ6IG5vcm1hbDsgdXNlci1zZWxlY3Q6IG5vbmU7IiAKICAgICAgICAgICAgICBpZD0iZGF0YXNldC1zZWxlY3QtaGVscCIgCiAgICAgICAgICAgICAgdGl0bGU9IkNsaWNrOiBTZWxlY3Qgc2luZ2xlIGl0ZW0mIzEwO1NoaWZ0K0NsaWNrOiBTZWxlY3QgcmFuZ2UmIzEwO0N0cmwvQ21kK0NsaWNrOiBUb2dnbGUgaXRlbSI+CiAgICAgICAgICDik5gKICAgICAgICA8L3NwYW4+CiAgICAgICAgPGRpdiBpZD0iZGF0YXNldC1zZWxlY3QtdG9vbHRpcCIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7IHBvc2l0aW9uOiBhYnNvbHV0ZTsgYm90dG9tOiAxMDAlJTsgbGVmdDogNTAlJTsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUlKTsgbWFyZ2luLWJvdHRvbTogOHB4OyBiYWNrZ3JvdW5kOiAjMzMzOyBjb2xvcjogd2hpdGU7IHBhZGRpbmc6IDEwcHggMTJweDsgYm9yZGVyLXJhZGl1czogNnB4OyBmb250LXNpemU6IDAuOHJlbTsgd2hpdGUtc3BhY2U6IG5vd3JhcDsgei1pbmRleDogMTAwMDsgYm94LXNoYWRvdzogMCAycHggOHB4IHJnYmEoMCwwLDAsMC4yKTsgcG9pbnRlci1ldmVudHM6IG5vbmU7Ij4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDRweDsiPjxzdHJvbmc+Q2xpY2s6PC9zdHJvbmc+IFNlbGVjdCBzaW5nbGUgaXRlbTwvZGl2PgogICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogNHB4OyI+PHN0cm9uZz5TaGlmdCtDbGljazo8L3N0cm9uZz4gU2VsZWN0IHJhbmdlPC9kaXY+CiAgICAgICAgICA8ZGl2PjxzdHJvbmc+Q3RybC9DbWQrQ2xpY2s6PC9zdHJvbmc+IFRvZ2dsZSBpdGVtPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJwb3NpdGlvbjogYWJzb2x1dGU7IGJvdHRvbTogLTZweDsgbGVmdDogNTAlJTsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUlKTsgd2lkdGg6IDA7IGhlaWdodDogMDsgYm9yZGVyLWxlZnQ6IDZweCBzb2xpZCB0cmFuc3BhcmVudDsgYm9yZGVyLXJpZ2h0OiA2cHggc29saWQgdHJhbnNwYXJlbnQ7IGJvcmRlci10b3A6IDZweCBzb2xpZCAjMzMzOyI+PC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IGlkPSJkYXRhc2V0LXNlbGVjdCIgc3R5bGU9Im1heC1oZWlnaHQ6IDIwMHB4OyBtaW4taGVpZ2h0OiA2MHB4OyBvdmVyZmxvdy15OiBhdXRvOyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiA0cHg7IGJhY2tncm91bmQ6IHdoaXRlOyBtYXJnaW4tYm90dG9tOiAxNnB4OyI+CiAgICAgIDxkaXYgc3R5bGU9InBhZGRpbmc6IDEycHg7IGNvbG9yOiAjNjY2OyBmb250LXNpemU6IDAuODVyZW07IHRleHQtYWxpZ246IGNlbnRlcjsiPkxvYWRpbmcgZGF0YXNldHMuLi48L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBpZD0iY29sdW1uLWxlZ2VuZCIgc3R5bGU9Im1hcmdpbi10b3A6IDE2cHg7IHBhZGRpbmc6IDEycHg7IGJhY2tncm91bmQ6IHdoaXRlOyBib3JkZXItcmFkaXVzOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGZvbnQtc2l6ZTogMC44NXJlbTsiPgogICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7Ij5TZWxlY3QgRGF0YXNldHMgYnkgQ29sdW1uPC9kaXY+CiAgICAgIDxkaXYgaWQ9ImNvbHVtbi1sZWdlbmQtY29udGVudCIgc3R5bGU9ImZvbnQtc2l6ZTogMC44cmVtOyBjb2xvcjogIzY2NjsiPk5vIGNvbHVtbiBpbmZvcm1hdGlvbiBhdmFpbGFibGUuPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgaWQ9IndlbGwtc2VsZWN0b3IiIHN0eWxlPSJtYXJnaW4tdG9wOiAxNnB4OyBwYWRkaW5nOiAxMnB4OyBiYWNrZ3JvdW5kOiB3aGl0ZTsgYm9yZGVyLXJhZGl1czogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyI+CiAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGN1cnNvcjogcG9pbnRlcjsgZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyIgb25jbGljaz0idG9nZ2xlV2VsbFNlbGVjdG9yKCkiPgogICAgICAgIDxzcGFuIGlkPSJ3ZWxsLXNlbGVjdG9yLWFycm93IiBzdHlsZT0ibWFyZ2luLXJpZ2h0OiA4cHg7Ij7ilrw8L3NwYW4+CiAgICAgICAgPHNwYW4+U2VsZWN0IFdlbGxzIChjbGljayB0byBleGNsdWRlKTwvc3Bhbj4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgaWQ9IndlbGwtc2VsZWN0b3ItZ3JpZC1jb250YWluZXIiIHN0eWxlPSJkaXNwbGF5OiBub25lOyI+CiAgICAgICAgPGRpdiBpZD0id2VsbC1zZWxlY3Rvci1ncmlkIiBzdHlsZT0iZGlzcGxheTogZ3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiBhdXRvIHJlcGVhdCgyNCwgMWZyKTsgZ3JpZC1hdXRvLXJvd3M6IDE4cHg7IGdhcDogMXB4OyBmb250LXNpemU6IDhweDsgbWFyZ2luLXRvcDogOHB4OyI+PC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLXRvcDogMTZweDsgdGV4dC1hbGlnbjogY2VudGVyOyI+CiAgICAgICAgICBDbGljayB3ZWxscyB0byBleGNsdWRlIHRoZW0gKOKclSA9IGV4Y2x1ZGVkKQogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBzdHlsZT0ibWFyZ2luLXRvcDogMTZweDsgcGFkZGluZzogMTJweDsgYmFja2dyb3VuZDogd2hpdGU7IGJvcmRlci1yYWRpdXM6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsiPgogICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7IGZvbnQtc2l6ZTogMC45NXJlbTsgY29sb3I6ICMzMzM7Ij5EYXRhIFByb2Nlc3NpbmcgV29ya2Zsb3c8L2Rpdj4KICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLWJvdHRvbTogMTJweDsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZjlmOWY5OyBib3JkZXItcmFkaXVzOiAzcHg7Ij4KICAgICAgICA8c3Ryb25nPlN0ZXAgMDo8L3N0cm9uZz4gQmFzZWxpbmUgc3VidHJhY3Rpb24gKGlmIGVuYWJsZWQpIOKAlCBzdWJ0cmFjdCBhbGwgcG9pbnRzIGZyb20gbG93ZXN0IG9yIGZpcnN0LWFmdGVyLWJhc2VsaW5lPGJyPgogICAgICAgIDxzdHJvbmc+U3RlcCAxOjwvc3Ryb25nPiBOb3JtYWxpemUgdXNpbmcgZml0dGVkIGJhc2VsaW5lIChpZiBlbmFibGVkKTxicj4KICAgICAgICA8c3Ryb25nPlN0ZXAgMjo8L3N0cm9uZz4gR3JvdXAgd2VsbHMgaW50byB0cmlwbGljYXRlIGdyb3VwcyAoaWYgZW5hYmxlZCkg4oCUIHJlcXVpcmVzIFN0ZXAgMCBvciBTdGVwIDE8YnI+CiAgICAgICAgPHN0cm9uZz5TdGVwIDM6PC9zdHJvbmc+IEN1dG9mZiBkYXRhIHBvaW50cyBiZWZvcmUgZmlyc3QgdGltZXBvaW50IGFuZCBhZnRlciB0aW1lIHBvaW50IChpZiBlbmFibGVkKTxicj4KICAgICAgICA8c3Ryb25nPlN0ZXAgNDo8L3N0cm9uZz4gRml0IHJlZ3Jlc3Npb24gY3VydmUgdG8gZGF0YSBwb2ludHMgKGlmIGVuYWJsZWQpCiAgICAgIDwvZGl2PgogICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGN1cnNvcjogcG9pbnRlcjsgZm9udC1zaXplOiAwLjlyZW07Ij4KICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJiYXNlbGluZS1zdWJ0cmFjdC10b2dnbGUiIHN0eWxlPSJtYXJnaW4tcmlnaHQ6IDhweDsgY3Vyc29yOiBwb2ludGVyOyIgb25jaGFuZ2U9InVwZGF0ZUNoYXJ0KCk7Ij4KICAgICAgICA8c3Bhbj48c3Ryb25nPlN0ZXAgMDo8L3N0cm9uZz4gQmFzZWxpbmUgc3VidHJhY3Rpb248L3NwYW4+CiAgICAgIDwvbGFiZWw+CiAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDRweDsgbWFyZ2luLWJvdHRvbTogOHB4OyBtYXJnaW4tbGVmdDogMjRweDsiPgogICAgICAgIFN1YnRyYWN0IGFsbCBwb2ludHMgZnJvbSBhIHJlZmVyZW5jZSAobG93ZXN0IGluIGJhc2VsaW5lIHJhbmdlIG9yIGZpcnN0IHBvaW50IGFmdGVyIGJhc2VsaW5lKS4gU2FtZSBzY2FsZSBhcyByYXcgZmx1b3Jlc2NlbmNlOyBubyBkaXZpc2lvbi4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgaWQ9ImJhc2VsaW5lLXN1YnRyYWN0LXBhcmFtZXRlcnMiIHN0eWxlPSJmb250LXNpemU6IDAuOHJlbTsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZjlmOWY5OyBib3JkZXItcmFkaXVzOiAzcHg7IGRpc3BsYXk6IG5vbmU7IG1hcmdpbi1sZWZ0OiAyNHB4OyBtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDEyMHB4OyI+QmFzZWxpbmUgd2luZG93IGVuZCAocyk6PC9zcGFuPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBpZD0iYmFzZWxpbmUtc3VidHJhY3QtZW5kLXRpbWUiIHZhbHVlPSIyNCIgbWluPSIwIiBzdGVwPSIwLjEiIHN0eWxlPSJ3aWR0aDogODBweDsgcGFkZGluZzogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7IiBvbmNoYW5nZT0idXBkYXRlQ2hhcnQoKTsiPgogICAgICAgICAgPC9sYWJlbD4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDEyMHB4OyI+UmVmZXJlbmNlOjwvc3Bhbj4KICAgICAgICAgICAgPHNlbGVjdCBpZD0iYmFzZWxpbmUtc3VidHJhY3QtbW9kZSIgc3R5bGU9ImZsZXg6IDE7IG1heC13aWR0aDogMjIwcHg7IHBhZGRpbmc6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsgYm9yZGVyLXJhZGl1czogM3B4OyBmb250LXNpemU6IDAuODVyZW07IiBvbmNoYW5nZT0idXBkYXRlQ2hhcnQoKTsiPgogICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9Imxvd2VzdF9wb2ludCI+TG93ZXN0IHBvaW50IGluIGJhc2VsaW5lIHJhbmdlPC9vcHRpb24+CiAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iZmlyc3RfcG9pbnQiPkZpcnN0IHBvaW50IGFmdGVyIGJhc2VsaW5lPC9vcHRpb24+CiAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgPC9sYWJlbD4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiA0cHg7Ij4KICAgICAgICAgIFN1YnRyYWN0IGVhY2ggdmFsdWUgZnJvbSB0aGUgY2hvc2VuIHJlZmVyZW5jZS4gU3RlcCAyIChncm91cGluZykgY2FuIGJlIGVuYWJsZWQgd2l0aCBTdGVwIDAgb25seSwgb3Igd2l0aCBTdGVwIDEsIG9yIGJvdGguIFdoZW4gU3RlcCAxIGlzIGFsc28gZW5hYmxlZCwgU3RlcCAxJ3MgYmFzZWxpbmUgd2luZG93IGlzIHVzZWQuCiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGN1cnNvcjogcG9pbnRlcjsgZm9udC1zaXplOiAwLjlyZW07IG1hcmdpbi10b3A6IDEycHg7Ij4KICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJub3JtYWxpemUtYmFzZWxpbmUtdG9nZ2xlIiBzdHlsZT0ibWFyZ2luLXJpZ2h0OiA4cHg7IGN1cnNvcjogcG9pbnRlcjsiIG9uY2hhbmdlPSJ1cGRhdGVDaGFydCgpOyI+CiAgICAgICAgPHNwYW4+PHN0cm9uZz5TdGVwIDE6PC9zdHJvbmc+IE5vcm1hbGl6ZSB1c2luZyBmaXR0ZWQgYmFzZWxpbmU8L3NwYW4+CiAgICAgIDwvbGFiZWw+CiAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDRweDsgbWFyZ2luLWJvdHRvbTogOHB4OyBtYXJnaW4tbGVmdDogMjRweDsiPgogICAgICAgIEZpdCBhIGJhc2VsaW5lIGZ1bmN0aW9uIChMT1dFU1MsIGNvbnN0YW50LCBvciBwb2x5bm9taWFsKSBvbiB0aGUgYmFzZWxpbmUgd2luZG93IGFuZCBub3JtYWxpemUgZWFjaCB3ZWxsIHVzaW5nIHRoZSBmaXR0ZWQgYmFzZWxpbmUuIFNlbGVjdCBtZXRob2QgYW5kIHBhcmFtZXRlcnMgaW4gdGhlICJCYXNlbGluZSBGaXR0aW5nICYgTm9ybWFsaXphdGlvbiBPcHRpb25zIiBzZWN0aW9uIGJlbG93LgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0ibm9ybWFsaXplLWJhc2VsaW5lLXBhcmFtZXRlcnMiIHN0eWxlPSJmb250LXNpemU6IDAuOHJlbTsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZjlmOWY5OyBib3JkZXItcmFkaXVzOiAzcHg7IGRpc3BsYXk6IG5vbmU7IG1hcmdpbi1sZWZ0OiAyNHB4OyBtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDEyMHB4OyI+QmFzZWxpbmUgd2luZG93IGVuZCAocyk6PC9zcGFuPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBpZD0ibm9ybWFsaXplLWJhc2VsaW5lLWVuZC10aW1lIiB2YWx1ZT0iMjQiIG1pbj0iMCIgc3RlcD0iMC4xIiBzdHlsZT0id2lkdGg6IDgwcHg7IHBhZGRpbmc6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsgYm9yZGVyLXJhZGl1czogM3B4OyBmb250LWZhbWlseTogbW9ub3NwYWNlOyIgb25jaGFuZ2U9InVwZGF0ZUNoYXJ0KCk7Ij4KICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLXRvcDogNHB4OyI+CiAgICAgICAgICBCYXNlbGluZSBmaXR0aW5nIG1ldGhvZCBhbmQgbm9ybWFsaXphdGlvbiBtb2RlIGFyZSBzZWxlY3RlZCBpbiB0aGUgIkJhc2VsaW5lIEZpdHRpbmcgJiBOb3JtYWxpemF0aW9uIE9wdGlvbnMiIHNlY3Rpb24gYmVsb3cuCiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBpZD0iY3VycmVudC1zZXR0aW5ncy1kaXNwbGF5IiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzMzMzsgbWFyZ2luLXRvcDogOHB4OyBwYWRkaW5nOiA2cHg7IGJhY2tncm91bmQ6ICNmMGYwZjA7IGJvcmRlci1yYWRpdXM6IDNweDsgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCAjMmE2Y2ZmOyI+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA0cHg7IGNvbG9yOiAjMmE2Y2ZmOyI+Q3VycmVudCBTZXR0aW5nczo8L2Rpdj4KICAgICAgICAgIDxkaXYgaWQ9ImN1cnJlbnQtc2V0dGluZ3MtY29udGVudCIgc3R5bGU9ImZvbnQtc2l6ZTogMC43cmVtOyBjb2xvcjogIzY2NjsiPgogICAgICAgICAgICBCYXNlbGluZTogPHNwYW4gaWQ9ImN1cnJlbnQtYmFzZWxpbmUtbWV0aG9kIj5Db25zdGFudDwvc3Bhbj4gfCBOb3JtYWxpemF0aW9uOiA8c3BhbiBpZD0iY3VycmVudC1ub3JtYWxpemF0aW9uLW1vZGUiPk11bHRpcGxpY2F0aXZlPC9zcGFuPiB8IEN1cnZlIEZpdDogPHNwYW4gaWQ9ImN1cnJlbnQtcmVncmVzc2lvbi10eXBlIj5Nb25vLWV4cG9uZW50aWFsIHBsYXRlYXU8L3NwYW4+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgY3Vyc29yOiBwb2ludGVyOyBmb250LXNpemU6IDAuOXJlbTsgbWFyZ2luLXRvcDogMTJweDsiPgogICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgaWQ9Imdyb3VwLXRyaXBsaWNhdGVzLXRvZ2dsZSIgc3R5bGU9Im1hcmdpbi1yaWdodDogOHB4OyBjdXJzb3I6IHBvaW50ZXI7IiBvbmNoYW5nZT0idXBkYXRlQ2hhcnQoKTsiPgogICAgICAgIDxzcGFuPjxzdHJvbmc+U3RlcCAyOjwvc3Ryb25nPiBHcm91cCB3ZWxscyBpbnRvIHRyaXBsaWNhdGUgZ3JvdXBzPC9zcGFuPgogICAgICA8L2xhYmVsPgogICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiA0cHg7IG1hcmdpbi1sZWZ0OiAyNHB4OyI+CiAgICAgICAgV2hlbiBlbmFibGVkLCB3ZWxscyB0aGF0IGFyZSBwYXJ0IG9mIHRyaXBsaWNhdGUgZ3JvdXBzIChlLmcuLCByb3dzIEIsIEMsIEQpIGFyZSBncm91cGVkIHRvZ2V0aGVyLiBXaGVuIGRpc2FibGVkLCBlYWNoIHdlbGwgaXMgc2hvd24gaW5kaXZpZHVhbGx5LiA8c3Ryb25nPk5vdGU6PC9zdHJvbmc+IFJlcXVpcmVzIFN0ZXAgMCAoYmFzZWxpbmUgc3VidHJhY3Rpb24pIG9yIFN0ZXAgMSAobm9ybWFsaXphdGlvbikgdG8gYmUgZW5hYmxlZC4KICAgICAgPC9kaXY+CiAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgY3Vyc29yOiBwb2ludGVyOyBmb250LXNpemU6IDAuOXJlbTsgbWFyZ2luLXRvcDogMTJweDsiPgogICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgaWQ9ImN1dG9mZi1iYXNlbGluZS10b2dnbGUiIHN0eWxlPSJtYXJnaW4tcmlnaHQ6IDhweDsgY3Vyc29yOiBwb2ludGVyOyIgb25jaGFuZ2U9InVwZGF0ZUNoYXJ0KCk7Ij4KICAgICAgICA8c3Bhbj48c3Ryb25nPlN0ZXAgMzo8L3N0cm9uZz4gQ3V0b2ZmIGRhdGEgcG9pbnRzIGJlZm9yZSBmaXJzdCB0aW1lcG9pbnQgYW5kIGFmdGVyIHRpbWUgcG9pbnQ8L3NwYW4+CiAgICAgIDwvbGFiZWw+CiAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDRweDsgbWFyZ2luLWxlZnQ6IDI0cHg7Ij4KICAgICAgICBXaGVuIGVuYWJsZWQsIGRhdGEgcG9pbnRzIGJlZm9yZSB0aGUgZmlyc3QgcmVhbCB0aW1lcG9pbnQgYW5kIGFmdGVyIHRoZSBjdXRvZmYgdGltZSB3aWxsIGJlIGV4Y2x1ZGVkIGZyb20gdGhlIGdyYXBoIGRpc3BsYXkuCiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGlkPSJjdXRvZmYtYmFzZWxpbmUtcGFyYW1ldGVycyIgc3R5bGU9ImZvbnQtc2l6ZTogMC44cmVtOyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsgZGlzcGxheTogbm9uZTsgbWFyZ2luLWxlZnQ6IDI0cHg7IG1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgPHNwYW4gc3R5bGU9Im1pbi13aWR0aDogMTIwcHg7Ij5DdXRvZmYgdGltZSAocyk6PC9zcGFuPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBpZD0iY3V0b2ZmLWJhc2VsaW5lLXRpbWUiIHZhbHVlPSIzNjAiIG1pbj0iMCIgc3RlcD0iMSIgc3R5bGU9IndpZHRoOiA4MHB4OyBwYWRkaW5nOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsiIG9uY2hhbmdlPSJ1cGRhdGVDaGFydCgpOyI+CiAgICAgICAgICA8L2xhYmVsPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDRweDsiPgogICAgICAgICAgRGF0YSBwb2ludHMgYmVmb3JlIHRoZSBmaXJzdCByZWFsIHRpbWVwb2ludCBhbmQgYWZ0ZXIgdGhpcyB0aW1lIHdpbGwgYmUgZXhjbHVkZWQgKGRlZmF1bHQ6IDYgbWludXRlcyA9IDM2MCBzZWNvbmRzKS4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgY3Vyc29yOiBwb2ludGVyOyBmb250LXNpemU6IDAuOXJlbTsgbWFyZ2luLXRvcDogMTJweDsiPgogICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgaWQ9ImZpdC1yZWdyZXNzaW9uLXRvZ2dsZSIgc3R5bGU9Im1hcmdpbi1yaWdodDogOHB4OyBjdXJzb3I6IHBvaW50ZXI7IiBvbmNoYW5nZT0idXBkYXRlUmVncmVzc2lvblR5cGVQYXJhbXModHJ1ZSk7IHVwZGF0ZUNoYXJ0KCk7Ij4KICAgICAgICA8c3Bhbj48c3Ryb25nPlN0ZXAgNDo8L3N0cm9uZz4gRml0IHJlZ3Jlc3Npb24gY3VydmUgdG8gZGF0YSBwb2ludHM8L3NwYW4+CiAgICAgIDwvbGFiZWw+CiAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDRweDsgbWFyZ2luLWxlZnQ6IDI0cHg7Ij4KICAgICAgICBXaGVuIGVuYWJsZWQsIGEgcmVncmVzc2lvbiBjdXJ2ZSB3aWxsIGJlIGZpdHRlZCB0byB0aGUgZGF0YSBwb2ludHMgYW5kIGRpc3BsYXllZCBvbiB0aGUgZ3JhcGguCiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGlkPSJmaXQtcmVncmVzc2lvbi1wYXJhbWV0ZXJzIiBzdHlsZT0iZm9udC1zaXplOiAwLjhyZW07IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyBkaXNwbGF5OiBub25lOyBtYXJnaW4tbGVmdDogMjRweDsgbWFyZ2luLWJvdHRvbTogOHB4OyI+CiAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogOHB4OyI+CiAgICAgICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICA8c3BhbiBzdHlsZT0ibWluLXdpZHRoOiAxNDBweDsiPlJlZ3Jlc3Npb24gdHlwZTo8L3NwYW4+CiAgICAgICAgICAgIDxzZWxlY3QgaWQ9InJlZ3Jlc3Npb24tdHlwZS1zZWxlY3QiIHN0eWxlPSJmbGV4OiAxOyBwYWRkaW5nOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1zaXplOiAwLjg1cmVtOyIgb25jaGFuZ2U9InVwZGF0ZVJlZ3Jlc3Npb25UeXBlUGFyYW1zKCk7Ij4KICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJsaW5lYXIiPkxpbmVhcjwvb3B0aW9uPgogICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9InBvbHlub21pYWwiPlBvbHlub21pYWw8L29wdGlvbj4KICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJleHBvbmVudGlhbCI+RXhwb25lbnRpYWw8L29wdGlvbj4KICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJsb2dhcml0aG1pYyI+TG9nYXJpdGhtaWM8L29wdGlvbj4KICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJtb25vLWV4cG9uZW50aWFsIiBzZWxlY3RlZD5Nb25vLWV4cG9uZW50aWFsIChyaXNlIHRvIHBsYXRlYXUpPC9vcHRpb24+CiAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgPC9sYWJlbD4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJyZWdyZXNzaW9uLXBvbHlub21pYWwtb3JkZXIiIHN0eWxlPSJtYXJnaW4tYm90dG9tOiA4cHg7IGRpc3BsYXk6IG5vbmU7Ij4KICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDE0MHB4OyI+UG9seW5vbWlhbCBvcmRlcjo8L3NwYW4+CiAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIGlkPSJwb2x5bm9taWFsLW9yZGVyLWlucHV0IiB2YWx1ZT0iMiIgbWluPSIyIiBtYXg9IjUiIHN0ZXA9IjEiIHN0eWxlPSJ3aWR0aDogODBweDsgcGFkZGluZzogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7IiBvbmNoYW5nZT0idXBkYXRlQ2hhcnQoKTsiPgogICAgICAgICAgPC9sYWJlbD4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiA0cHg7Ij4KICAgICAgICAgIFRoZSByZWdyZXNzaW9uIGN1cnZlIHdpbGwgYmUgb3ZlcmxhaWQgb24gdGhlIGRhdGEgcG9pbnRzLgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgaWQ9InJlZ3Jlc3Npb24taW5mby1wYW5lbCIgc3R5bGU9Im1hcmdpbi10b3A6IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2U4ZjRmZDsgYm9yZGVyLXJhZGl1czogM3B4OyBib3JkZXI6IDFweCBzb2xpZCAjMmE2Y2ZmOyBkaXNwbGF5OiBub25lOyI+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7IGNvbG9yOiAjMmE2Y2ZmOyI+TW9uby1leHBvbmVudGlhbCBGaXQgUGFyYW1ldGVyczwvZGl2PgogICAgICAgICAgPGRpdiBpZD0icmVncmVzc2lvbi1pbmZvLWNvbnRlbnQiIHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7Ij4KICAgICAgICAgICAgPCEtLSBQYXJhbWV0ZXJzIHdpbGwgYmUgcG9wdWxhdGVkIGhlcmUgLS0+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgc3R5bGU9Im1hcmdpbi10b3A6IDE2cHg7IHBhZGRpbmc6IDEycHg7IGJhY2tncm91bmQ6IHdoaXRlOyBib3JkZXItcmFkaXVzOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7Ij4KICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgY3Vyc29yOiBwb2ludGVyOyBmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7IGZvbnQtc2l6ZTogMC45NXJlbTsgY29sb3I6ICMzMzM7IiBvbmNsaWNrPSJ0b2dnbGVCYXNlbGluZU9wdGlvbnMoKSI+CiAgICAgICAgPHNwYW4gaWQ9ImJhc2VsaW5lLW9wdGlvbnMtYXJyb3ciIHN0eWxlPSJtYXJnaW4tcmlnaHQ6IDhweDsiPuKWvDwvc3Bhbj4KICAgICAgICA8c3Bhbj5CYXNlbGluZSBGaXR0aW5nICYgTm9ybWFsaXphdGlvbiBPcHRpb25zPC9zcGFuPgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0iYmFzZWxpbmUtb3B0aW9ucy1jb250ZW50IiBzdHlsZT0iZGlzcGxheTogbm9uZTsgZm9udC1zaXplOiAwLjhyZW07Ij4KICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNlOGY0ZmQ7IGJvcmRlci1yYWRpdXM6IDNweDsgYm9yZGVyOiAxcHggc29saWQgIzJhNmNmZjsiPgogICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyBjb2xvcjogIzJhNmNmZjsiPlNlbGVjdCBCYXNlbGluZSBGaXR0aW5nIE1ldGhvZDwvZGl2PgogICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogOHB4OyI+CiAgICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNHB4OyBmb250LXNpemU6IDAuODVyZW07Ij4KICAgICAgICAgICAgICA8c3BhbiBzdHlsZT0ibWluLXdpZHRoOiAxNDBweDsiPk1ldGhvZDo8L3NwYW4+CiAgICAgICAgICAgICAgPHNlbGVjdCBpZD0iYmFzZWxpbmUtbWV0aG9kLXNlbGVjdCIgc3R5bGU9ImZsZXg6IDE7IHBhZGRpbmc6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsgYm9yZGVyLXJhZGl1czogM3B4OyBmb250LXNpemU6IDAuODVyZW07IiBvbmNoYW5nZT0idXBkYXRlQmFzZWxpbmVNZXRob2RQYXJhbXMoKTsiPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibG93ZXNzIj5MT1dFU1M8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9ImNvbnN0YW50IiBzZWxlY3RlZD5Db25zdGFudDwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0icG9seW5vbWlhbCI+UG9seW5vbWlhbDwvb3B0aW9uPgogICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICA8L2xhYmVsPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGlkPSJiYXNlbGluZS1sb3dlc3MtcGFyYW1zIiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsgZGlzcGxheTogbm9uZTsiPgogICAgICAgICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDRweDsgZm9udC1zaXplOiAwLjg1cmVtOyI+CiAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9Im1pbi13aWR0aDogMTQwcHg7Ij5TbW9vdGhpbmcgZnJhY3Rpb24gKGZyYWMpOjwvc3Bhbj4KICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBpZD0iYmFzZWxpbmUtZnJhYy1pbnB1dCIgdmFsdWU9IjAuNSIgbWluPSIwLjEiIG1heD0iMS4wIiBzdGVwPSIwLjEiIHN0eWxlPSJmbGV4OiAxOyBwYWRkaW5nOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsgZm9udC1zaXplOiAwLjg1cmVtOyI+CiAgICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi1sZWZ0OiAxNDBweDsgbWFyZ2luLXRvcDogMnB4OyI+CiAgICAgICAgICAgICAgSGlnaGVyID0gc21vb3RoZXIgKDAuNy0wLjkpLCBMb3dlciA9IG1vcmUgbG9jYWwgKDAuMi0wLjQpCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IGlkPSJiYXNlbGluZS1wb2x5bm9taWFsLXBhcmFtcyIgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7IGRpc3BsYXk6IG5vbmU7Ij4KICAgICAgICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBtYXJnaW4tYm90dG9tOiA0cHg7IGZvbnQtc2l6ZTogMC44NXJlbTsiPgogICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDE0MHB4OyI+UG9seW5vbWlhbCBvcmRlcjo8L3NwYW4+CiAgICAgICAgICAgICAgPGlucHV0IHR5cGU9Im51bWJlciIgaWQ9ImJhc2VsaW5lLXBvbHktb3JkZXItaW5wdXQiIHZhbHVlPSIxIiBtaW49IjEiIG1heD0iNSIgc3RlcD0iMSIgc3R5bGU9ImZsZXg6IDE7IHBhZGRpbmc6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsgYm9yZGVyLXJhZGl1czogM3B4OyBmb250LWZhbWlseTogbW9ub3NwYWNlOyBmb250LXNpemU6IDAuODVyZW07Ij4KICAgICAgICAgICAgPC9sYWJlbD4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLWxlZnQ6IDE0MHB4OyBtYXJnaW4tdG9wOiAycHg7Ij4KICAgICAgICAgICAgICAxID0gbGluZWFyLCAyID0gcXVhZHJhdGljLCAzKyA9IGhpZ2hlciBvcmRlcgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE2cHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2U4ZjRmZDsgYm9yZGVyLXJhZGl1czogM3B4OyBib3JkZXI6IDFweCBzb2xpZCAjMmE2Y2ZmOyI+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7IGNvbG9yOiAjMmE2Y2ZmOyI+U2VsZWN0IE5vcm1hbGl6YXRpb24gTWV0aG9kPC9kaXY+CiAgICAgICAgICA8ZGl2PgogICAgICAgICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDRweDsgZm9udC1zaXplOiAwLjg1cmVtOyI+CiAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9Im1pbi13aWR0aDogMTQwcHg7Ij5Ob3JtYWxpemF0aW9uIG1vZGU6PC9zcGFuPgogICAgICAgICAgICAgIDxzZWxlY3QgaWQ9Im5vcm1hbGl6YXRpb24tbW9kZS1zZWxlY3QiIHN0eWxlPSJmbGV4OiAxOyBwYWRkaW5nOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1zaXplOiAwLjg1cmVtOyIgb25jaGFuZ2U9InVwZGF0ZUN1cnJlbnRTZXR0aW5nc0Rpc3BsYXkoKTsiPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iZGVsdGFfZl9vdmVyX2YiPs6URi9GIChEZWx0YSBGIG92ZXIgRik8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9Im11bHRpcGxpY2F0aXZlIiBzZWxlY3RlZD5NdWx0aXBsaWNhdGl2ZTwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibG93ZXN0X3BvaW50Ij5Mb3dlc3QgUG9pbnQgaW4gUmFuZ2U8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9ImZpcnN0X3BvaW50Ij5GaXJzdCBQb2ludCBBZnRlciBCYXNlbGluZTwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibm9uZSI+Tm9uZSAobm8gbm9ybWFsaXphdGlvbik8L29wdGlvbj4KICAgICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgICAgPC9sYWJlbD4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE2cHg7Ij4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsgY29sb3I6ICMyYTZjZmY7Ij5CYXNlbGluZSBGaXR0aW5nIE1ldGhvZHM8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDRweDsiPjEuIExPV0VTUyAoTG9jYWxseSBXZWlnaHRlZCBTY2F0dGVycGxvdCBTbW9vdGhpbmcpPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkZvcm11bGE6PC9zdHJvbmc+IGcodCkgPSBMT1dFU1MoRl9iYXNlbGluZSwgdF9iYXNlbGluZSwgZnJhYykKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPldoZW4gdG8gdXNlOjwvc3Ryb25nPiBCYXNlbGluZSBoYXMgZ3JhZHVhbCBkcmlmdCBvciBub24tbGluZWFyIHRyZW5kcwogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+QmVzdCBmb3I6PC9zdHJvbmc+IE5vbi1saW5lYXIgYmFzZWxpbmVzIHdpdGggc21vb3RoIHRyZW5kcwogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+UGFyYW1ldGVyczo8L3N0cm9uZz4KICAgICAgICAgICAgICA8dWwgc3R5bGU9Im1hcmdpbjogNHB4IDAgMCAyMHB4OyBwYWRkaW5nLWxlZnQ6IDA7Ij4KICAgICAgICAgICAgICAgIDxsaT48c3Ryb25nPmZyYWM6PC9zdHJvbmc+IEZyYWN0aW9uIG9mIGRhdGEgdXNlZCBmb3Igc21vb3RoaW5nIChkZWZhdWx0OiAwLjUpCiAgICAgICAgICAgICAgICAgIDx1bCBzdHlsZT0ibWFyZ2luOiAycHggMCAwIDIwcHg7IHBhZGRpbmctbGVmdDogMDsiPgogICAgICAgICAgICAgICAgICAgIDxsaT5IaWdoZXIgZnJhYyAoMC43LTAuOSkgPSBzbW9vdGhlciwgbW9yZSBnbG9iYWwgZml0PC9saT4KICAgICAgICAgICAgICAgICAgICA8bGk+TG93ZXIgZnJhYyAoMC4yLTAuNCkgPSBtb3JlIGxvY2FsLCBmb2xsb3dzIGRhdGEgY2xvc2VseTwvbGk+CiAgICAgICAgICAgICAgICAgIDwvdWw+CiAgICAgICAgICAgICAgICA8L2xpPgogICAgICAgICAgICAgIDwvdWw+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxMnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4yLiBDT05TVEFOVCAoMHRoLW9yZGVyIHBvbHlub21pYWwpPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkZvcm11bGE6PC9zdHJvbmc+IGcodCkgPSBtZWFuKEZfYmFzZWxpbmUpIGZvciBhbGwgdAogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+V2hlbiB0byB1c2U6PC9zdHJvbmc+IEJhc2VsaW5lIGlzIHN0YWJsZS9mbGF0IHdpdGggbWluaW1hbCBkcmlmdAogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+QmVzdCBmb3I6PC9zdHJvbmc+IFN0YWJsZSBiYXNlbGluZXMgd2l0aCBubyB0aW1lLWRlcGVuZGVudCB0cmVuZHMKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5QYXJhbWV0ZXJzOjwvc3Ryb25nPiBOb25lCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxMnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4zLiBQT0xZTk9NSUFMICgxc3Qtb3JkZXIgb3IgaGlnaGVyKTwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5Gb3JtdWxhOjwvc3Ryb25nPiBnKHQpID0gY+KCgCArIGPigoF0ICsgY+KCgnTCsiArIC4uLgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+V2hlbiB0byB1c2U6PC9zdHJvbmc+IEJhc2VsaW5lIGhhcyBsaW5lYXIgb3IgcG9seW5vbWlhbCBkcmlmdAogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+QmVzdCBmb3I6PC9zdHJvbmc+IEJhc2VsaW5lcyB3aXRoIGtub3duIHBvbHlub21pYWwgdHJlbmRzCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5QYXJhbWV0ZXJzOjwvc3Ryb25nPgogICAgICAgICAgICAgIDx1bCBzdHlsZT0ibWFyZ2luOiA0cHggMCAwIDIwcHg7IHBhZGRpbmctbGVmdDogMDsiPgogICAgICAgICAgICAgICAgPGxpPjxzdHJvbmc+cG9seV9vcmRlcjo8L3N0cm9uZz4gUG9seW5vbWlhbCBvcmRlciAoZGVmYXVsdDogMSA9IGxpbmVhcikKICAgICAgICAgICAgICAgICAgPHVsIHN0eWxlPSJtYXJnaW46IDJweCAwIDAgMjBweDsgcGFkZGluZy1sZWZ0OiAwOyI+CiAgICAgICAgICAgICAgICAgICAgPGxpPk9yZGVyIDE6IExpbmVhciBkcmlmdCAoZyh0KSA9IGPigoAgKyBj4oKBdCk8L2xpPgogICAgICAgICAgICAgICAgICAgIDxsaT5PcmRlciAyOiBRdWFkcmF0aWMgZHJpZnQgKGcodCkgPSBj4oKAICsgY+KCgXQgKyBj4oKCdMKyKTwvbGk+CiAgICAgICAgICAgICAgICAgICAgPGxpPkhpZ2hlciBvcmRlcnM6IE1vcmUgY29tcGxleCB0cmVuZHM8L2xpPgogICAgICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICAgICAgPC9saT4KICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE2cHg7Ij4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsgY29sb3I6ICMyYTZjZmY7Ij5Ob3JtYWxpemF0aW9uIE1ldGhvZHM8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDRweDsiPjEuIERFTFRBX0ZfT1ZFUl9GICjOlEYvRik8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+Rm9ybXVsYTo8L3N0cm9uZz4gRicodCkgPSAoRih0KSAtIGcodCkpIC8gZyh0KQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+V2hlbiB0byB1c2U6PC9zdHJvbmc+IE1lYXN1cmUgcmVsYXRpdmUgY2hhbmdlIGZyb20gYmFzZWxpbmUKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkJlc3QgZm9yOjwvc3Ryb25nPiBEZXRlY3RpbmcgaW5jcmVhc2VzL2RlY3JlYXNlcyByZWxhdGl2ZSB0byBiYXNlbGluZQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+SW50ZXJwcmV0YXRpb246PC9zdHJvbmc+CiAgICAgICAgICAgICAgPHVsIHN0eWxlPSJtYXJnaW46IDRweCAwIDAgMjBweDsgcGFkZGluZy1sZWZ0OiAwOyI+CiAgICAgICAgICAgICAgICA8bGk+RicodCkgPSAwOiBObyBjaGFuZ2UgZnJvbSBiYXNlbGluZTwvbGk+CiAgICAgICAgICAgICAgICA8bGk+RicodCkgPiAwOiBJbmNyZWFzZSBhYm92ZSBiYXNlbGluZSAoZS5nLiwgMC41ID0gNTAlJSBpbmNyZWFzZSk8L2xpPgogICAgICAgICAgICAgICAgPGxpPkYnKHQpIDwgMDogRGVjcmVhc2UgYmVsb3cgYmFzZWxpbmUgKGUuZy4sIC0wLjMgPSAzMCUlIGRlY3JlYXNlKTwvbGk+CiAgICAgICAgICAgICAgPC91bD4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyI+CiAgICAgICAgICAgICAgVmFsdWVzIGNhbiBiZSBuZWdhdGl2ZSAoYmVsb3cgYmFzZWxpbmUpIG9yIHBvc2l0aXZlIChhYm92ZSBiYXNlbGluZSkKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDRweDsiPjIuIE1VTFRJUExJQ0FUSVZFPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkZvcm11bGE6PC9zdHJvbmc+IEZfbm9ybSh0KSA9IEYodCkgLyBnKHQpCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5XaGVuIHRvIHVzZTo8L3N0cm9uZz4gTm9ybWFsaXplIGJ5IGJhc2VsaW5lIHdpdGhvdXQgc3VidHJhY3RpbmcKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkJlc3QgZm9yOjwvc3Ryb25nPiBGb2xkLWNoYW5nZSBhbmFseXNpcwogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+SW50ZXJwcmV0YXRpb246PC9zdHJvbmc+CiAgICAgICAgICAgICAgPHVsIHN0eWxlPSJtYXJnaW46IDRweCAwIDAgMjBweDsgcGFkZGluZy1sZWZ0OiAwOyI+CiAgICAgICAgICAgICAgICA8bGk+Rl9ub3JtKHQpID0gMS4wOiBObyBjaGFuZ2UgZnJvbSBiYXNlbGluZTwvbGk+CiAgICAgICAgICAgICAgICA8bGk+Rl9ub3JtKHQpID0gMi4wOiAyLWZvbGQgaW5jcmVhc2UgKDEwMCUlIGluY3JlYXNlKTwvbGk+CiAgICAgICAgICAgICAgICA8bGk+Rl9ub3JtKHQpID0gMC41OiAyLWZvbGQgZGVjcmVhc2UgKDUwJSUgb2YgYmFzZWxpbmUpPC9saT4KICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7Ij4KICAgICAgICAgICAgICBWYWx1ZXMgYXJlIGFsd2F5cyBwb3NpdGl2ZSAocmF0aW8gdG8gYmFzZWxpbmUpCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxMnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4zLiBMT1dFU1QgUE9JTlQgSU4gUkFOR0U8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+Rm9ybXVsYTo8L3N0cm9uZz4gRl9ub3JtKHQpID0gRih0KSAvIG1pbihGX2Jhc2VsaW5lX3JhbmdlKQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+V2hlbiB0byB1c2U6PC9zdHJvbmc+IE5vcm1hbGl6ZSB1c2luZyB0aGUgbWluaW11bSB2YWx1ZSBpbiB0aGUgYmFzZWxpbmUgcmFuZ2UKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkJlc3QgZm9yOjwvc3Ryb25nPiBXaGVuIHlvdSB3YW50IHRvIG5vcm1hbGl6ZSByZWxhdGl2ZSB0byB0aGUgbG93ZXN0IGJhc2VsaW5lIHBvaW50CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5JbnRlcnByZXRhdGlvbjo8L3N0cm9uZz4KICAgICAgICAgICAgICA8dWwgc3R5bGU9Im1hcmdpbjogNHB4IDAgMCAyMHB4OyBwYWRkaW5nLWxlZnQ6IDA7Ij4KICAgICAgICAgICAgICAgIDxsaT5Vc2VzIHRoZSBtaW5pbXVtIHZhbHVlIGZyb20gYWxsIHRpbWVwb2ludHMgaW4gdGhlIGJhc2VsaW5lIHJhbmdlICgwIHRvIGJhc2VsaW5lIGVuZCB0aW1lKTwvbGk+CiAgICAgICAgICAgICAgICA8bGk+QWxsIHN1YnNlcXVlbnQgdmFsdWVzIGFyZSBkaXZpZGVkIGJ5IHRoaXMgbWluaW11bSBiYXNlbGluZSB2YWx1ZTwvbGk+CiAgICAgICAgICAgICAgICA8bGk+VXNlZnVsIHdoZW4gYmFzZWxpbmUgaGFzIHNvbWUgbm9pc2UgYW5kIHlvdSB3YW50IHRvIG5vcm1hbGl6ZSB0byB0aGUgbG93ZXN0IHBvaW50PC9saT4KICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7Ij4KICAgICAgICAgICAgICBWYWx1ZXMgYXJlIGFsd2F5cyBwb3NpdGl2ZSAocmF0aW8gdG8gbWluaW11bSBiYXNlbGluZSkKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDRweDsiPjQuIEZJUlNUIFBPSU5UIEFGVEVSIEJBU0VMSU5FPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkZvcm11bGE6PC9zdHJvbmc+IEZfbm9ybSh0KSA9IEYodCkgLyBGX2ZpcnN0X2FmdGVyX2Jhc2VsaW5lCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5XaGVuIHRvIHVzZTo8L3N0cm9uZz4gTm9ybWFsaXplIHVzaW5nIHRoZSBmaXJzdCBkYXRhIHBvaW50IGFmdGVyIHRoZSBiYXNlbGluZSByYW5nZSBlbmRzCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5CZXN0IGZvcjo8L3N0cm9uZz4gV2hlbiBlYWNoIHJ1biBoYXMgYSBkaWZmZXJlbnQgImZpcnN0IHBvaW50IiBhZnRlciBiYXNlbGluZSBhbmQgeW91IHdhbnQgdG8gbm9ybWFsaXplIHRvIHRoYXQgcG9pbnQKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkludGVycHJldGF0aW9uOjwvc3Ryb25nPgogICAgICAgICAgICAgIDx1bCBzdHlsZT0ibWFyZ2luOiA0cHggMCAwIDIwcHg7IHBhZGRpbmctbGVmdDogMDsiPgogICAgICAgICAgICAgICAgPGxpPkZpbmRzIHRoZSBmaXJzdCB0aW1lcG9pbnQgYWZ0ZXIgdGhlIGJhc2VsaW5lIHJhbmdlIGVuZHMgKHRpbWUgPiBiYXNlbGluZSBlbmQgdGltZSk8L2xpPgogICAgICAgICAgICAgICAgPGxpPlVzZXMgdGhhdCBwb2ludCdzIHZhbHVlIGFzIHRoZSBub3JtYWxpemF0aW9uIGNvbnN0YW50IGZvciB0aGF0IHdlbGwvcnVuPC9saT4KICAgICAgICAgICAgICAgIDxsaT5FYWNoIHdlbGwvcnVuIHdpbGwgaGF2ZSBpdHMgb3duICJmaXJzdCBwb2ludCIgYWZ0ZXIgYmFzZWxpbmU8L2xpPgogICAgICAgICAgICAgICAgPGxpPkFsbCB2YWx1ZXMgZm9yIHRoYXQgd2VsbCBhcmUgZGl2aWRlZCBieSBpdHMgc3BlY2lmaWMgZmlyc3QgcG9pbnQgYWZ0ZXIgYmFzZWxpbmU8L2xpPgogICAgICAgICAgICAgIDwvdWw+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsiPgogICAgICAgICAgICAgIFZhbHVlcyBhcmUgYWx3YXlzIHBvc2l0aXZlIChyYXRpbyB0byBmaXJzdCBwb2ludCBhZnRlciBiYXNlbGluZSkKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2PgogICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyBjb2xvcjogIzJhNmNmZjsiPlN0YXRpc3RpY3MgQ29tcHV0YXRpb248L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9InBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICAgICAgICAgIEZvciBlYWNoIGNvbmRpdGlvbiBhbmQgdGltZXBvaW50LCB0aGUgZm9sbG93aW5nIHN0YXRpc3RpY3MgYXJlIGNvbXB1dGVkOgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogNnB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5NZWFuOjwvc3Ryb25nPiDOvCh0KSA9ICgxL24pIMOXIM6jIEYnKHQpCiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IGZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7Ij4KICAgICAgICAgICAgICAgIEF2ZXJhZ2Ugbm9ybWFsaXplZCB2YWx1ZSBhY3Jvc3MgYWxsIHdlbGxzIGluIHRoZSBjb25kaXRpb24KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDZweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+U0Q6PC9zdHJvbmc+IM+DKHQpID0gc3FydCjOoyhGJyh0KSAtIM68KHQpKcKyIC8gKG4tMSkpCiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IGZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7Ij4KICAgICAgICAgICAgICAgIFNhbXBsZSBzdGFuZGFyZCBkZXZpYXRpb24gKGRkb2Y9MSkgYWNyb3NzIHdlbGxzCiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgIDxzdHJvbmc+U0VNOjwvc3Ryb25nPiBTRU0odCkgPSDPgyh0KSAvIHNxcnQobikKICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsiPgogICAgICAgICAgICAgICAgU3RhbmRhcmQgZXJyb3Igb2YgdGhlIG1lYW4gPSBTRCAvIHNxcnQobl93ZWxscykKICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLXRvcDogNHB4OyI+CiAgICAgICAgICAgICAgICA8c3Ryb25nPk5vdGU6PC9zdHJvbmc+IFNFTSBpcyBjb21wdXRlZCBhY3Jvc3Mgd2VsbHMsIG5vdCBwcm9wYWdhdGVkIGZyb20gYmFzZWxpbmUgZXJyb3IKICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tcHJpbWFyeSIgb25jbGljaz0idXBkYXRlQ2hhcnQoKSIgc3R5bGU9Im1hcmdpbi10b3A6IDE2cHg7Ij5VcGRhdGUgQ2hhcnQ8L2J1dHRvbj4KICAgIDxidXR0b24gY2xhc3M9ImJ0biIgb25jbGljaz0iY2xlYXJTZWxlY3Rpb24oKSI+Q2xlYXIgU2VsZWN0aW9uPC9idXR0b24+CiAgICA8ZGl2IGlkPSJ3ZWxsLWluZm8iIHN0eWxlPSJtYXJnaW4tdG9wOiAxNnB4OyI+Q2xpY2sgd2VsbHMgb24gdGhlIHBsYXRlIHRvIGFkZCB0aGVtIHRvIHRoZSBjaGFydC48L2Rpdj4KICA8L2FzaWRlPgogIDxtYWluPgogICAgPGRpdiBpZD0icGxhdGUtZ3JpZHMtY29udGFpbmVyIj48L2Rpdj4KICAgIDxkaXYgaWQ9ImNoYXJ0LWNvbnRhaW5lciI+CiAgICAgIDxkaXYgaWQ9ImNoYXJ0LXRvb2xiYXIiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBnYXA6IDhweDsgbWFyZ2luLWJvdHRvbTogOHB4OyBhbGlnbi1pdGVtczogY2VudGVyOyBmbGV4LXdyYXA6IHdyYXA7Ij4KICAgICAgICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImJ0biIgb25jbGljaz0iY29weUNoYXJ0QXNJbWFnZSgpIiB0aXRsZT0iQ29weSB0aGUgY3VycmVudCBjaGFydCB0byBjbGlwYm9hcmQiPkNvcHkgYXMgaW1hZ2U8L2J1dHRvbj4KICAgICAgICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImJ0biIgb25jbGljaz0iZG93bmxvYWRDaGFydEFzSW1hZ2UoKSIgdGl0bGU9IlNhdmUgdGhlIGN1cnJlbnQgY2hhcnQgYXMgYSBQTkcgZmlsZSI+RG93bmxvYWQgYXMgaW1hZ2U8L2J1dHRvbj4KICAgICAgPC9kaXY+CiAgICAgIDxjYW52YXMgaWQ9IndlbGwtY2hhcnQiPjwvY2FudmFzPgogICAgPC9kaXY+CiAgPC9tYWluPgogIDwvZGl2PgoKPHNjcmlwdD4KY29uc3QgUExBVEVfUk9XUyA9ICIlKHJvd3MpcyIuc3BsaXQoIiIpOwpjb25zdCBQTEFURV9DT0xTID0gJShjb2xzKWQ7CgpsZXQgdmlld2VyRGF0YSA9IG51bGw7CmxldCBjaGFydCA9IG51bGw7CmxldCBzZWxlY3RlZFdlbGxzID0gbmV3IFNldCgpOyAvLyBTZXQgb2Yge3BsYXRlSWQ6d2VsbElkfSBzdHJpbmdzCmxldCBhbGxXZWxsc0RhdGEgPSB7fTsgLy8gQ29tYmluZWQgd2VsbHMgZnJvbSBhbGwgcGxhdGVzOiB7cGxhdGVJZDoge3dlbGxJZDogey4uLn19fQpsZXQgc2VsZWN0ZWREYXRhc2V0SWRzID0gbmV3IFNldCgpOyAvLyBTZXQgb2Ygc2VsZWN0ZWQgZGF0YXNldCBncm91cCBJRHMgKGUuZy4sICJncm91cDpHUk9VUF9OQU1FIikKbGV0IGxhc3RTZWxlY3RlZEluZGV4ID0gLTE7IC8vIFRyYWNrIGxhc3Qgc2VsZWN0ZWQgaW5kZXggZm9yIHNoaWZ0LWNsaWNrCmxldCBlbmFibGVkRGF0YXNldHMgPSBuZXcgU2V0KCk7IC8vIFNldCBvZiBlbmFibGVkIGRhdGFzZXQgSURzIChlbXB0eSA9IGFsbCBlbmFibGVkKQpsZXQgZW5hYmxlZFdlbGxzID0gbmV3IFNldCgpOyAvLyBTZXQgb2YgZW5hYmxlZCB3ZWxsIElEcyAoZW1wdHkgPSBhbGwgZW5hYmxlZCkKbGV0IGVuYWJsZWRDb2x1bW5zQnlTY2llbnRpc3QgPSB7fTsgLy8gTWFwOiBzY2llbnRpc3QgLT4gU2V0IG9mIGVuYWJsZWQgY29sdW1uIG51bWJlcnMgKGVtcHR5IHNldCA9IGFsbCBlbmFibGVkKQpsZXQgcGxhdGVJbmRpY2F0b3JDbGVhbnVwID0gbnVsbDsgLy8gU3RvcmUgY2xlYW51cCBmdW5jdGlvbnMgZm9yIHBsYXRlIGluZGljYXRvciBldmVudCBsaXN0ZW5lcnMKCi8vIEhlbHBlciBmdW5jdGlvbiB0byBnZXQgZW5hYmxlZCBjb2x1bW5zIGZvciBhIHNjaWVudGlzdApmdW5jdGlvbiBnZXRFbmFibGVkQ29sdW1uc0ZvclNjaWVudGlzdChzY2llbnRpc3QpIHsKICBpZiAoIWVuYWJsZWRDb2x1bW5zQnlTY2llbnRpc3Rbc2NpZW50aXN0XSkgewogICAgZW5hYmxlZENvbHVtbnNCeVNjaWVudGlzdFtzY2llbnRpc3RdID0gbmV3IFNldCgpOwogIH0KICByZXR1cm4gZW5hYmxlZENvbHVtbnNCeVNjaWVudGlzdFtzY2llbnRpc3RdOwp9CgovLyBSZWdpc3RlciBlcnJvciBiYXIgcGx1Z2luIGdsb2JhbGx5CkNoYXJ0LnJlZ2lzdGVyKHsKICBpZDogImVycm9yQmFycyIsCiAgYWZ0ZXJEYXRhc2V0c0RyYXc6IChjaGFydCkgPT4gewogICAgY29uc3QgY3R4ID0gY2hhcnQuY3R4OwogICAgY2hhcnQuZGF0YS5kYXRhc2V0cy5mb3JFYWNoKChkYXRhc2V0LCBkYXRhc2V0SW5kZXgpID0+IHsKICAgICAgaWYgKCFkYXRhc2V0LmRhdGEgfHwgZGF0YXNldC5kYXRhLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwogICAgICAKICAgICAgLy8gQ2hlY2sgaWYgYW55IGRhdGEgcG9pbnQgaGFzIGVycm9yIGluZm9ybWF0aW9uCiAgICAgIGNvbnN0IGhhc0Vycm9ycyA9IGRhdGFzZXQuZGF0YS5zb21lKGQgPT4gZCAmJiBkLmVycm9yICE9PSB1bmRlZmluZWQgJiYgZC5lcnJvciAhPT0gbnVsbCk7CiAgICAgIGlmICghaGFzRXJyb3JzKSByZXR1cm47CiAgICAgIAogICAgICBjb25zdCBtZXRhID0gY2hhcnQuZ2V0RGF0YXNldE1ldGEoZGF0YXNldEluZGV4KTsKICAgICAgY3R4LnNhdmUoKTsKICAgICAgY3R4LnN0cm9rZVN0eWxlID0gZGF0YXNldC5ib3JkZXJDb2xvciB8fCAicmdiYSgwLDAsMCwwLjUpIjsKICAgICAgY3R4LmxpbmVXaWR0aCA9IDE7CiAgICAgIAogICAgICBtZXRhLmRhdGEuZm9yRWFjaCgocG9pbnQsIGluZGV4KSA9PiB7CiAgICAgICAgaWYgKCFwb2ludCB8fCAhZGF0YXNldC5kYXRhW2luZGV4XSB8fCBkYXRhc2V0LmRhdGFbaW5kZXhdLmVycm9yID09PSB1bmRlZmluZWQgfHwgZGF0YXNldC5kYXRhW2luZGV4XS5lcnJvciA9PT0gbnVsbCkgcmV0dXJuOwogICAgICAgIAogICAgICAgIGNvbnN0IHggPSBwb2ludC54OwogICAgICAgIGNvbnN0IHkgPSBwb2ludC55OwogICAgICAgIGNvbnN0IGVycm9yID0gZGF0YXNldC5kYXRhW2luZGV4XS5lcnJvcjsKICAgICAgICBjb25zdCB5U2NhbGUgPSBjaGFydC5zY2FsZXMueTsKICAgICAgICBjb25zdCBlcnJvclBpeGVscyA9IE1hdGguYWJzKHlTY2FsZS5nZXRQaXhlbEZvclZhbHVlKHkgKyBlcnJvcikgLSB5U2NhbGUuZ2V0UGl4ZWxGb3JWYWx1ZSh5KSk7CiAgICAgICAgCiAgICAgICAgLy8gRHJhdyB2ZXJ0aWNhbCBlcnJvciBiYXIKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyh4LCB5IC0gZXJyb3JQaXhlbHMpOwogICAgICAgIGN0eC5saW5lVG8oeCwgeSArIGVycm9yUGl4ZWxzKTsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgCiAgICAgICAgLy8gRHJhdyBob3Jpem9udGFsIGNhcHMKICAgICAgICBjb25zdCBjYXBXaWR0aCA9IDQ7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oeCAtIGNhcFdpZHRoLCB5IC0gZXJyb3JQaXhlbHMpOwogICAgICAgIGN0eC5saW5lVG8oeCArIGNhcFdpZHRoLCB5IC0gZXJyb3JQaXhlbHMpOwogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyh4IC0gY2FwV2lkdGgsIHkgKyBlcnJvclBpeGVscyk7CiAgICAgICAgY3R4LmxpbmVUbyh4ICsgY2FwV2lkdGgsIHkgKyBlcnJvclBpeGVscyk7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICB9KTsKICAgICAgCiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICB9KTsKICB9Cn0pOwoKLy8gUmVnaXN0ZXIgYmFzZWxpbmUgbGFiZWwgcGx1Z2luIHRvIGRpc3BsYXkgYmFzZWxpbmUgbnVtYmVycyBvbiB0aGUgY2hhcnQKQ2hhcnQucmVnaXN0ZXIoewogIGlkOiAiYmFzZWxpbmVMYWJlbHMiLAogIGFmdGVyRGF0YXNldHNEcmF3OiAoY2hhcnQpID0+IHsKICAgIGNvbnN0IGN0eCA9IGNoYXJ0LmN0eDsKICAgIGNvbnN0IHhTY2FsZSA9IGNoYXJ0LnNjYWxlcy54OwogICAgY29uc3QgeVNjYWxlID0gY2hhcnQuc2NhbGVzLnk7CiAgICAKICAgIGNoYXJ0LmRhdGEuZGF0YXNldHMuZm9yRWFjaCgoZGF0YXNldCwgZGF0YXNldEluZGV4KSA9PiB7CiAgICAgIC8vIE9ubHkgcHJvY2VzcyBiYXNlbGluZSBsaW5lcyAoaWRlbnRpZmllZCBieSBoYXZpbmcgZXhhY3RseSAyIHBvaW50cyBhbmQgb3JkZXIgPT09IDEwMDApCiAgICAgIGlmICghZGF0YXNldC5kYXRhIHx8IGRhdGFzZXQuZGF0YS5sZW5ndGggIT09IDIgfHwgZGF0YXNldC5vcmRlciAhPT0gMTAwMCkgcmV0dXJuOwogICAgICAKICAgICAgLy8gRXh0cmFjdCBiYXNlbGluZSB2YWx1ZSBmcm9tIGxhYmVsIChmb3JtYXQ6ICJsYWJlbCAoYmFzZWxpbmU6IHZhbHVlKSIpCiAgICAgIGNvbnN0IGJhc2VsaW5lTWF0Y2ggPSBkYXRhc2V0LmxhYmVsLm1hdGNoKC9cKGJhc2VsaW5lOlxzKihbXGQuXSspXCkvKTsKICAgICAgaWYgKCFiYXNlbGluZU1hdGNoKSByZXR1cm47CiAgICAgIAogICAgICBjb25zdCBiYXNlbGluZVZhbHVlID0gcGFyc2VGbG9hdChiYXNlbGluZU1hdGNoWzFdKTsKICAgICAgaWYgKGlzTmFOKGJhc2VsaW5lVmFsdWUpKSByZXR1cm47CiAgICAgIAogICAgICAvLyBHZXQgdGhlIHkgcG9zaXRpb24gb2YgdGhlIGJhc2VsaW5lCiAgICAgIGNvbnN0IGJhc2VsaW5lWSA9IGRhdGFzZXQuZGF0YVswXS55OwogICAgICBjb25zdCB5UGl4ZWwgPSB5U2NhbGUuZ2V0UGl4ZWxGb3JWYWx1ZShiYXNlbGluZVkpOwogICAgICAKICAgICAgLy8gUG9zaXRpb24gdGV4dCBhdCB0aGUgcmlnaHQgZWRnZSBvZiB0aGUgY2hhcnQsIHNsaWdodGx5IG9mZnNldCBmcm9tIHRoZSBsaW5lCiAgICAgIGNvbnN0IGNoYXJ0QXJlYSA9IGNoYXJ0LmNoYXJ0QXJlYTsKICAgICAgY29uc3QgdGV4dFggPSBjaGFydEFyZWEucmlnaHQgLSAxMDsgLy8gMTBweCBmcm9tIHJpZ2h0IGVkZ2UKICAgICAgY29uc3QgdGV4dFkgPSB5UGl4ZWwgLSA1OyAvLyA1cHggYWJvdmUgdGhlIGxpbmUKICAgICAgCiAgICAgIGN0eC5zYXZlKCk7CiAgICAgIGN0eC5mb250ID0gIjEycHggQXJpYWwiOwogICAgICBjdHguZmlsbFN0eWxlID0gZGF0YXNldC5ib3JkZXJDb2xvciB8fCAicmdiYSgxMjgsIDEyOCwgMTI4LCAwLjcpIjsKICAgICAgY3R4LnRleHRBbGlnbiA9ICJyaWdodCI7CiAgICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAiYm90dG9tIjsKICAgICAgCiAgICAgIC8vIERyYXcgYmFja2dyb3VuZCByZWN0YW5nbGUgZm9yIGJldHRlciByZWFkYWJpbGl0eQogICAgICBjb25zdCB0ZXh0ID0gYmFzZWxpbmVWYWx1ZS50b0ZpeGVkKDIpOwogICAgICBjb25zdCB0ZXh0TWV0cmljcyA9IGN0eC5tZWFzdXJlVGV4dCh0ZXh0KTsKICAgICAgY29uc3QgcGFkZGluZyA9IDQ7CiAgICAgIGN0eC5maWxsU3R5bGUgPSAicmdiYSgyNTUsIDI1NSwgMjU1LCAwLjgpIjsKICAgICAgY3R4LmZpbGxSZWN0KAogICAgICAgIHRleHRYIC0gdGV4dE1ldHJpY3Mud2lkdGggLSBwYWRkaW5nLAogICAgICAgIHRleHRZIC0gMTIgLSBwYWRkaW5nLAogICAgICAgIHRleHRNZXRyaWNzLndpZHRoICsgcGFkZGluZyAqIDIsCiAgICAgICAgMTIgKyBwYWRkaW5nICogMgogICAgICApOwogICAgICAKICAgICAgLy8gRHJhdyB0aGUgdGV4dAogICAgICBjdHguZmlsbFN0eWxlID0gZGF0YXNldC5ib3JkZXJDb2xvciB8fCAicmdiYSgxMjgsIDEyOCwgMTI4LCAwLjkpIjsKICAgICAgY3R4LmZpbGxUZXh0KHRleHQsIHRleHRYLCB0ZXh0WSk7CiAgICAgIAogICAgICBjdHgucmVzdG9yZSgpOwogICAgfSk7CiAgfQp9KTsKCmZ1bmN0aW9uIGRpc3BsYXlXYXJuaW5ncygpIHsKICBjb25zdCB3YXJuaW5nQmFubmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIndhcm5pbmctYmFubmVyIik7CiAgaWYgKCF3YXJuaW5nQmFubmVyIHx8ICF2aWV3ZXJEYXRhIHx8ICF2aWV3ZXJEYXRhLmNvbmZpZykgewogICAgcmV0dXJuOwogIH0KICAKICBjb25zdCB3YXJuaW5ncyA9IHZpZXdlckRhdGEuY29uZmlnLndhcm5pbmdzIHx8IHt9OwogIGNvbnN0IGR1cGxpY2F0ZUNvbHVtbnMgPSB3YXJuaW5ncy5kdXBsaWNhdGVfY29sdW1ucyB8fCBbXTsKICAKICBpZiAoZHVwbGljYXRlQ29sdW1ucy5sZW5ndGggPT09IDApIHsKICAgIHdhcm5pbmdCYW5uZXIuY2xhc3NMaXN0LnJlbW92ZSgic2hvdyIpOwogICAgcmV0dXJuOwogIH0KICAKICAvLyBCdWlsZCB3YXJuaW5nIG1lc3NhZ2UgLSBvbmx5IHNob3cgY29sdW1uIG51bWJlcnMKICBsZXQgaHRtbCA9ICc8aDM+4pqg77iPIFdhcm5pbmc6IER1cGxpY2F0ZSBDb2x1bW5zIERldGVjdGVkPC9oMz4nOwogIAogIGR1cGxpY2F0ZUNvbHVtbnMuZm9yRWFjaCh3YXJuaW5nID0+IHsKICAgIGNvbnN0IGZpbGVzID0gd2FybmluZy5maWxlcyB8fCBbXTsKICAgIGNvbnN0IGNvbHVtbnMgPSB3YXJuaW5nLmNvbHVtbnMgfHwgW107CiAgICBjb25zdCBmaWxlc1N0ciA9IGZpbGVzLmpvaW4oIiBhbmQgIik7CiAgICBjb25zdCBjb2x1bW5zU3RyID0gY29sdW1ucy5sZW5ndGggPD0gMTAgCiAgICAgID8gY29sdW1ucy5qb2luKCIsICIpCiAgICAgIDogY29sdW1ucy5zbGljZSgwLCAxMCkuam9pbigiLCAiKSArIGAsIC4uLiAoJHtjb2x1bW5zLmxlbmd0aH0gdG90YWwpYDsKICAgIAogICAgaHRtbCArPSBgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogOHB4OyI+PHN0cm9uZz4ke2ZpbGVzU3RyfTwvc3Ryb25nPiBoYXZlIGR1cGxpY2F0ZSBjb2x1bW5zOiAke2NvbHVtbnNTdHJ9PC9kaXY+YDsKICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxNnB4OyBmb250LXNpemU6IDAuODVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tYm90dG9tOiAxMnB4OyI+T25seSBkYXRhIGZyb20gJzxzdHJvbmc+JHtmaWxlc1swXX08L3N0cm9uZz4nIChmaXJzdCBhbHBoYWJldGljYWxseSkgaXMgdXNlZC48L2Rpdj5gOwogIH0pOwogIAogIHdhcm5pbmdCYW5uZXIuaW5uZXJIVE1MID0gaHRtbDsKICB3YXJuaW5nQmFubmVyLmNsYXNzTGlzdC5hZGQoInNob3ciKTsKfQoKYXN5bmMgZnVuY3Rpb24gbG9hZERhdGEoKSB7CiAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2goInZpZXdlcl9kYXRhLmpzb24iKTsKICB2aWV3ZXJEYXRhID0gYXdhaXQgcmVzLmpzb24oKTsKICBjb21iaW5lQWxsV2VsbHMoKTsKICAvLyBJbml0aWFsaXplIHRyaXBsaWNhdGUgZ3JvdXAgY29sb3JzIGJlZm9yZSByZW5kZXJpbmcKICBpbml0aWFsaXplVHJpcGxpY2F0ZUdyb3VwQ29sb3JzKCk7CiAgZGlzcGxheVdhcm5pbmdzKCk7CiAgaW5pdERhdGFzZXRTZWxlY3QoKTsKICBpbml0RGF0YXNldFNlbGVjdFRvb2x0aXAoKTsKICByZW5kZXJQbGF0ZUdyaWQoKTsKfQoKZnVuY3Rpb24gaW5pdERhdGFzZXRTZWxlY3RUb29sdGlwKCkgewogIGNvbnN0IGhlbHBJY29uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImRhdGFzZXQtc2VsZWN0LWhlbHAiKTsKICBjb25zdCB0b29sdGlwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImRhdGFzZXQtc2VsZWN0LXRvb2x0aXAiKTsKICAKICBpZiAoIWhlbHBJY29uIHx8ICF0b29sdGlwKSByZXR1cm47CiAgCiAgbGV0IHRvb2x0aXBUaW1lb3V0OwogIAogIGhlbHBJY29uLmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlZW50ZXIiLCAoKSA9PiB7CiAgICBjbGVhclRpbWVvdXQodG9vbHRpcFRpbWVvdXQpOwogICAgdG9vbHRpcC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICB9KTsKICAKICBoZWxwSWNvbi5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWxlYXZlIiwgKCkgPT4gewogICAgdG9vbHRpcFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgdG9vbHRpcC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgfSwgMTAwKTsKICB9KTsKICAKICB0b29sdGlwLmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlZW50ZXIiLCAoKSA9PiB7CiAgICBjbGVhclRpbWVvdXQodG9vbHRpcFRpbWVvdXQpOwogICAgdG9vbHRpcC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICB9KTsKICAKICB0b29sdGlwLmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlbGVhdmUiLCAoKSA9PiB7CiAgICB0b29sdGlwVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICB0b29sdGlwLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICB9LCAxMDApOwogIH0pOwp9CgpmdW5jdGlvbiBjb21iaW5lQWxsV2VsbHMoKSB7CiAgLy8gQ29tYmluZSBhbGwgd2VsbHMgZnJvbSBhbGwgcGxhdGVzIGludG8gYSBzaW5nbGUgc3RydWN0dXJlCiAgYWxsV2VsbHNEYXRhID0ge307CiAgdmlld2VyRGF0YS5wbGF0ZXMuZm9yRWFjaChwbGF0ZSA9PiB7CiAgICBhbGxXZWxsc0RhdGFbcGxhdGUuaWRdID0gcGxhdGUud2VsbHM7CiAgfSk7Cn0KCmZ1bmN0aW9uIGluaXREYXRhc2V0U2VsZWN0KCkgewogIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJkYXRhc2V0LXNlbGVjdCIpOwogIGNvbnRhaW5lci5pbm5lckhUTUwgPSAiIjsKICAKICBpZiAoIXZpZXdlckRhdGEgfHwgIXZpZXdlckRhdGEucGxhdGVzIHx8IHZpZXdlckRhdGEucGxhdGVzLmxlbmd0aCA9PT0gMCkgewogICAgY29udGFpbmVyLmlubmVySFRNTCA9ICI8ZGl2IHN0eWxlPSdwYWRkaW5nOiAxMnB4OyBjb2xvcjogIzY2NjsgZm9udC1zaXplOiAwLjg1cmVtOyB0ZXh0LWFsaWduOiBjZW50ZXI7Jz5ObyBkYXRhc2V0cyBhdmFpbGFibGUuPC9kaXY+IjsKICAgIHJldHVybjsKICB9CiAgCiAgLy8gR3JvdXAgcGxhdGVzIGJ5IGNvbHVtbl9ncm91cAogIGNvbnN0IHBsYXRlc0J5R3JvdXAgPSB7fTsKICB2aWV3ZXJEYXRhLnBsYXRlcy5mb3JFYWNoKHBsYXRlID0+IHsKICAgIGNvbnN0IGdyb3VwID0gcGxhdGUuY29sdW1uX2dyb3VwIHx8ICJPdGhlciI7CiAgICBpZiAoIXBsYXRlc0J5R3JvdXBbZ3JvdXBdKSB7CiAgICAgIHBsYXRlc0J5R3JvdXBbZ3JvdXBdID0gW107CiAgICB9CiAgICBwbGF0ZXNCeUdyb3VwW2dyb3VwXS5wdXNoKHBsYXRlKTsKICB9KTsKICAKICAvLyBTb3J0IGdyb3VwcyBhbHBoYWJldGljYWxseQogIGNvbnN0IHNvcnRlZEdyb3VwcyA9IE9iamVjdC5rZXlzKHBsYXRlc0J5R3JvdXApLnNvcnQoKTsKICAKICAvLyBDcmVhdGUgbGluZSBpdGVtcyBmb3IgZWFjaCBncm91cAogIHNvcnRlZEdyb3Vwcy5mb3JFYWNoKChncm91cE5hbWUsIGluZGV4KSA9PiB7CiAgICBjb25zdCBwbGF0ZXMgPSBwbGF0ZXNCeUdyb3VwW2dyb3VwTmFtZV07CiAgICBjb25zdCBncm91cElkID0gYGdyb3VwOiR7Z3JvdXBOYW1lfWA7CiAgICAKICAgIC8vIENyZWF0ZSBmcmllbmRseSBuYW1lIGZyb20gZmlyc3QgcGxhdGUncyBjb2x1bW4gaW5mbwogICAgY29uc3QgZmlyc3RQbGF0ZSA9IHBsYXRlc1swXTsKICAgIGNvbnN0IGNvbHVtbkluZm8gPSBmaXJzdFBsYXRlLmNvbHVtbl9pbmZvIHx8IHt9OwogICAgY29uc3QgcGFydHMgPSBbXTsKICAgIGlmIChjb2x1bW5JbmZvLnByb3RlaW4pIHBhcnRzLnB1c2goY29sdW1uSW5mby5wcm90ZWluKTsKICAgIGlmIChjb2x1bW5JbmZvLmdlbm90eXBlKSBwYXJ0cy5wdXNoKGNvbHVtbkluZm8uZ2Vub3R5cGUpOwogICAgaWYgKGNvbHVtbkluZm8uYnVmZmVyKSBwYXJ0cy5wdXNoKGNvbHVtbkluZm8uYnVmZmVyKTsKICAgIAogICAgLy8gQ3JlYXRlIGRpc3BsYXkgdGV4dAogICAgbGV0IGRpc3BsYXlUZXh0OwogICAgaWYgKHBsYXRlcy5sZW5ndGggPiAxKSB7CiAgICAgIGRpc3BsYXlUZXh0ID0gcGFydHMubGVuZ3RoID4gMCAKICAgICAgICA/IGAke3BhcnRzLmpvaW4oIiAtICIpfSAoJHtwbGF0ZXMubGVuZ3RofSBkYXRhc2V0cylgCiAgICAgICAgOiBgJHtncm91cE5hbWV9ICgke3BsYXRlcy5sZW5ndGh9IGRhdGFzZXRzKWA7CiAgICB9IGVsc2UgewogICAgICBkaXNwbGF5VGV4dCA9IHBhcnRzLmxlbmd0aCA+IDAgCiAgICAgICAgPyBwYXJ0cy5qb2luKCIgLSAiKQogICAgICAgIDogZ3JvdXBOYW1lOwogICAgfQogICAgCiAgICAvLyBDcmVhdGUgbGluZSBpdGVtIGRpdgogICAgY29uc3QgbGluZUl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGxpbmVJdGVtLmNsYXNzTmFtZSA9ICJkYXRhc2V0LWxpbmUtaXRlbSI7CiAgICBsaW5lSXRlbS5kYXRhc2V0Lmdyb3VwSWQgPSBncm91cElkOwogICAgbGluZUl0ZW0uZGF0YXNldC5pbmRleCA9IGluZGV4OwogICAgbGluZUl0ZW0udGV4dENvbnRlbnQgPSBkaXNwbGF5VGV4dDsKICAgIAogICAgLy8gQWRkIGNsaWNrIGhhbmRsZXIKICAgIGxpbmVJdGVtLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgKGUpID0+IHsKICAgICAgaGFuZGxlRGF0YXNldEl0ZW1DbGljayhlLCBncm91cElkLCBpbmRleCk7CiAgICB9KTsKICAgIAogICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGxpbmVJdGVtKTsKICB9KTsKICAKICAvLyBTZWxlY3QgZmlyc3QgZ3JvdXAgYnkgZGVmYXVsdAogIGlmIChzb3J0ZWRHcm91cHMubGVuZ3RoID4gMCkgewogICAgY29uc3QgZmlyc3RHcm91cElkID0gYGdyb3VwOiR7c29ydGVkR3JvdXBzWzBdfWA7CiAgICBzZWxlY3RlZERhdGFzZXRJZHMuYWRkKGZpcnN0R3JvdXBJZCk7CiAgICBsYXN0U2VsZWN0ZWRJbmRleCA9IDA7CiAgICB1cGRhdGVEYXRhc2V0U2VsZWN0RGlzcGxheSgpOwogIH0KICAKfQoKZnVuY3Rpb24gaGFuZGxlRGF0YXNldEl0ZW1DbGljayhlLCBncm91cElkLCBpbmRleCkgewogIGNvbnN0IGlzU2hpZnRDbGljayA9IGUuc2hpZnRLZXk7CiAgY29uc3QgaXNDdHJsQ2xpY2sgPSBlLmN0cmxLZXkgfHwgZS5tZXRhS2V5OyAvLyBTdXBwb3J0IGJvdGggQ3RybCBhbmQgQ21kCiAgCiAgaWYgKGlzU2hpZnRDbGljayAmJiBsYXN0U2VsZWN0ZWRJbmRleCA+PSAwKSB7CiAgICAvLyBTaGlmdC1jbGljazogc2VsZWN0IHJhbmdlIGZyb20gbGFzdFNlbGVjdGVkSW5kZXggdG8gY3VycmVudCBpbmRleAogICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImRhdGFzZXQtc2VsZWN0Iik7CiAgICBjb25zdCBpdGVtcyA9IEFycmF5LmZyb20oY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3JBbGwoIi5kYXRhc2V0LWxpbmUtaXRlbSIpKTsKICAgIGNvbnN0IHN0YXJ0SWR4ID0gTWF0aC5taW4obGFzdFNlbGVjdGVkSW5kZXgsIGluZGV4KTsKICAgIGNvbnN0IGVuZElkeCA9IE1hdGgubWF4KGxhc3RTZWxlY3RlZEluZGV4LCBpbmRleCk7CiAgICAKICAgIGZvciAobGV0IGkgPSBzdGFydElkeDsgaSA8PSBlbmRJZHg7IGkrKykgewogICAgICBpZiAoaXRlbXNbaV0pIHsKICAgICAgICBjb25zdCBpdGVtR3JvdXBJZCA9IGl0ZW1zW2ldLmRhdGFzZXQuZ3JvdXBJZDsKICAgICAgICBzZWxlY3RlZERhdGFzZXRJZHMuYWRkKGl0ZW1Hcm91cElkKTsKICAgICAgfQogICAgfQogIH0gZWxzZSBpZiAoaXNDdHJsQ2xpY2spIHsKICAgIC8vIEN0cmwvQ21kLWNsaWNrOiB0b2dnbGUgdGhpcyBpdGVtCiAgICBpZiAoc2VsZWN0ZWREYXRhc2V0SWRzLmhhcyhncm91cElkKSkgewogICAgICBzZWxlY3RlZERhdGFzZXRJZHMuZGVsZXRlKGdyb3VwSWQpOwogICAgfSBlbHNlIHsKICAgICAgc2VsZWN0ZWREYXRhc2V0SWRzLmFkZChncm91cElkKTsKICAgIH0KICB9IGVsc2UgewogICAgLy8gUmVndWxhciBjbGljazogY2xlYXIgYWxsIGFuZCBzZWxlY3Qgb25seSB0aGlzIGl0ZW0KICAgIHNlbGVjdGVkRGF0YXNldElkcy5jbGVhcigpOwogICAgc2VsZWN0ZWREYXRhc2V0SWRzLmFkZChncm91cElkKTsKICB9CiAgCiAgbGFzdFNlbGVjdGVkSW5kZXggPSBpbmRleDsKICB1cGRhdGVEYXRhc2V0U2VsZWN0RGlzcGxheSgpOwogIAogIC8vIENsZWFuIHVwIHNlbGVjdGVkIHdlbGxzIC0gb25seSBrZWVwIHdlbGxzIGZyb20gc2VsZWN0ZWQgZGF0YXNldHMKICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogIGNvbnN0IG5ld1NlbGVjdGVkV2VsbHMgPSBuZXcgU2V0KCk7CiAgc2VsZWN0ZWRXZWxscy5mb3JFYWNoKGtleSA9PiB7CiAgICBjb25zdCBbcGxhdGVJZF0gPSBrZXkuc3BsaXQoIjoiKTsKICAgIGlmIChzZWxlY3RlZERhdGFzZXRzLmluY2x1ZGVzKHBsYXRlSWQpKSB7CiAgICAgIG5ld1NlbGVjdGVkV2VsbHMuYWRkKGtleSk7CiAgICB9CiAgfSk7CiAgc2VsZWN0ZWRXZWxscyA9IG5ld1NlbGVjdGVkV2VsbHM7CiAgCiAgLy8gUmVzZXQgZW5hYmxlZCBkYXRhc2V0cy93ZWxscy9jb2x1bW5zIHdoZW4gY2hhbmdpbmcgZGF0YXNldCBncm91cHMKICBlbmFibGVkRGF0YXNldHMuY2xlYXIoKTsKICBlbmFibGVkV2VsbHMuY2xlYXIoKTsKICBlbmFibGVkQ29sdW1uc0J5U2NpZW50aXN0ID0ge307IC8vIENsZWFyIGFsbCBzY2llbnRpc3Qtc3BlY2lmaWMgY29sdW1uIGZpbHRlcnMKICAKICByZW5kZXJQbGF0ZUdyaWQoKTsKICB1cGRhdGVXZWxsSW5mbygpOwogIHJlbmRlcldlbGxTZWxlY3RvckdyaWQoKTsKfQoKZnVuY3Rpb24gdXBkYXRlRGF0YXNldFNlbGVjdERpc3BsYXkoKSB7CiAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImRhdGFzZXQtc2VsZWN0Iik7CiAgY29uc3QgaXRlbXMgPSBjb250YWluZXIucXVlcnlTZWxlY3RvckFsbCgiLmRhdGFzZXQtbGluZS1pdGVtIik7CiAgCiAgaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgIGNvbnN0IGdyb3VwSWQgPSBpdGVtLmRhdGFzZXQuZ3JvdXBJZDsKICAgIGlmIChzZWxlY3RlZERhdGFzZXRJZHMuaGFzKGdyb3VwSWQpKSB7CiAgICAgIGl0ZW0uY2xhc3NMaXN0LmFkZCgic2VsZWN0ZWQiKTsKICAgIH0gZWxzZSB7CiAgICAgIGl0ZW0uY2xhc3NMaXN0LnJlbW92ZSgic2VsZWN0ZWQiKTsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gZ2V0U2VsZWN0ZWREYXRhc2V0cygpIHsKICAvLyBSZXR1cm4gYWxsIGRhdGFzZXRzIGluIHRoZSBzZWxlY3RlZCBncm91cHMsIGZpbHRlcmVkIGJ5IGVuYWJsZWREYXRhc2V0cwogIGlmIChzZWxlY3RlZERhdGFzZXRJZHMuc2l6ZSA9PT0gMCkgewogICAgcmV0dXJuIFtdOwogIH0KICAKICBsZXQgZGF0YXNldHMgPSBbXTsKICAKICAvLyBQcm9jZXNzIGFsbCBzZWxlY3RlZCBncm91cHMKICBzZWxlY3RlZERhdGFzZXRJZHMuZm9yRWFjaChncm91cElkID0+IHsKICAgIC8vIENoZWNrIGlmIGl0J3MgYSBncm91cCBzZWxlY3Rpb24gKGZvcm1hdDogImdyb3VwOkdST1VQX05BTUUiKQogICAgaWYgKGdyb3VwSWQuc3RhcnRzV2l0aCgiZ3JvdXA6IikpIHsKICAgICAgY29uc3QgZ3JvdXBOYW1lID0gZ3JvdXBJZC5zdWJzdHJpbmcoNik7IC8vIFJlbW92ZSAiZ3JvdXA6IiBwcmVmaXgKICAgICAgY29uc3Qgc2VsZWN0ZWRQbGF0ZXMgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maWx0ZXIocCA9PiBwLmNvbHVtbl9ncm91cCA9PT0gZ3JvdXBOYW1lKTsKICAgICAgZGF0YXNldHMucHVzaCguLi5zZWxlY3RlZFBsYXRlcy5tYXAocCA9PiBwLmlkKSk7CiAgICB9IGVsc2UgewogICAgICAvLyBPdGhlcndpc2UsIGl0J3MgYSBzaW5nbGUgZGF0YXNldCBzZWxlY3Rpb24gKGxlZ2FjeSBzdXBwb3J0KQogICAgICBjb25zdCBwbGF0ZSA9IHZpZXdlckRhdGEucGxhdGVzLmZpbmQocCA9PiBwLmlkID09PSBncm91cElkKTsKICAgICAgaWYgKHBsYXRlKSB7CiAgICAgICAgZGF0YXNldHMucHVzaChncm91cElkKTsKICAgICAgfQogICAgfQogIH0pOwogIAogIC8vIFJlbW92ZSBkdXBsaWNhdGVzCiAgZGF0YXNldHMgPSBbLi4ubmV3IFNldChkYXRhc2V0cyldOwogIAogIC8vIEZpbHRlciBieSBlbmFibGVkRGF0YXNldHMgaWYgYW55IGFyZSBzZXQKICBpZiAoZW5hYmxlZERhdGFzZXRzLnNpemUgPiAwKSB7CiAgICByZXR1cm4gZGF0YXNldHMuZmlsdGVyKGlkID0+IGVuYWJsZWREYXRhc2V0cy5oYXMoaWQpKTsKICB9CiAgCiAgcmV0dXJuIGRhdGFzZXRzOwp9CgpmdW5jdGlvbiB0b2dnbGVXZWxsU2VsZWN0b3IoKSB7CiAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIndlbGwtc2VsZWN0b3ItZ3JpZC1jb250YWluZXIiKTsKICBjb25zdCBhcnJvdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ3ZWxsLXNlbGVjdG9yLWFycm93Iik7CiAgaWYgKGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID09PSAibm9uZSIpIHsKICAgIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgIGFycm93LnRleHRDb250ZW50ID0gIuKWsiI7CiAgICByZW5kZXJXZWxsU2VsZWN0b3JHcmlkKCk7CiAgfSBlbHNlIHsKICAgIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgYXJyb3cudGV4dENvbnRlbnQgPSAi4pa8IjsKICB9Cn0KCmZ1bmN0aW9uIHRvZ2dsZUJhc2VsaW5lT3B0aW9ucygpIHsKICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtb3B0aW9ucy1jb250ZW50Iik7CiAgY29uc3QgYXJyb3cgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtb3B0aW9ucy1hcnJvdyIpOwogIGlmIChjb250YWluZXIuc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiKSB7CiAgICBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICBhcnJvdy50ZXh0Q29udGVudCA9ICLilrIiOwogIH0gZWxzZSB7CiAgICBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIGFycm93LnRleHRDb250ZW50ID0gIuKWvCI7CiAgfQp9CgpmdW5jdGlvbiB1cGRhdGVCYXNlbGluZU1ldGhvZFBhcmFtcygpIHsKICBjb25zdCBtZXRob2QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtbWV0aG9kLXNlbGVjdCIpLnZhbHVlOwogIGNvbnN0IGxvd2Vzc1BhcmFtcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJiYXNlbGluZS1sb3dlc3MtcGFyYW1zIik7CiAgY29uc3QgcG9seW5vbWlhbFBhcmFtcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJiYXNlbGluZS1wb2x5bm9taWFsLXBhcmFtcyIpOwogIAogIGlmIChtZXRob2QgPT09ICJsb3dlc3MiKSB7CiAgICBsb3dlc3NQYXJhbXMuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICBwb2x5bm9taWFsUGFyYW1zLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgfSBlbHNlIGlmIChtZXRob2QgPT09ICJwb2x5bm9taWFsIikgewogICAgbG93ZXNzUGFyYW1zLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICBwb2x5bm9taWFsUGFyYW1zLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogIH0gZWxzZSB7CiAgICAvLyBjb25zdGFudAogICAgbG93ZXNzUGFyYW1zLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICBwb2x5bm9taWFsUGFyYW1zLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgfQogIAogIHVwZGF0ZUN1cnJlbnRTZXR0aW5nc0Rpc3BsYXkoKTsKfQoKZnVuY3Rpb24gdXBkYXRlUmVncmVzc2lvblR5cGVQYXJhbXMoc2tpcENoYXJ0VXBkYXRlKSB7CiAgY29uc3QgcmVncmVzc2lvblR5cGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi10eXBlLXNlbGVjdCIpLnZhbHVlOwogIGNvbnN0IHBvbHlub21pYWxPcmRlckRpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZWdyZXNzaW9uLXBvbHlub21pYWwtb3JkZXIiKTsKICBjb25zdCBpbmZvUGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi1pbmZvLXBhbmVsIik7CiAgY29uc3QgZml0UmVncmVzc2lvblRvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJmaXQtcmVncmVzc2lvbi10b2dnbGUiKTsKICAKICBpZiAocmVncmVzc2lvblR5cGUgPT09ICJwb2x5bm9taWFsIiAmJiBwb2x5bm9taWFsT3JkZXJEaXYpIHsKICAgIHBvbHlub21pYWxPcmRlckRpdi5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICB9IGVsc2UgaWYgKHBvbHlub21pYWxPcmRlckRpdikgewogICAgcG9seW5vbWlhbE9yZGVyRGl2LnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgfQogIAogIC8vIFNob3cvaGlkZSBpbmZvIHBhbmVsIGZvciBtb25vLWV4cG9uZW50aWFsIChvbmx5IGlmIHJlZ3Jlc3Npb24gdG9nZ2xlIGlzIGNoZWNrZWQpCiAgaWYgKGluZm9QYW5lbCkgewogICAgY29uc3QgaXNSZWdyZXNzaW9uRW5hYmxlZCA9IGZpdFJlZ3Jlc3Npb25Ub2dnbGUgJiYgZml0UmVncmVzc2lvblRvZ2dsZS5jaGVja2VkOwogICAgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAibW9uby1leHBvbmVudGlhbCIgJiYgaXNSZWdyZXNzaW9uRW5hYmxlZCkgewogICAgICBpbmZvUGFuZWwuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICB9IGVsc2UgewogICAgICBpbmZvUGFuZWwuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIH0KICB9CiAgCiAgdXBkYXRlQ3VycmVudFNldHRpbmdzRGlzcGxheSgpOwogIAogIC8vIFVwZGF0ZSBjaGFydCB3aGVuIHJlZ3Jlc3Npb24gdHlwZSBjaGFuZ2VzICh1bmxlc3Mgc2tpcHBlZCBmb3IgaW5pdGlhbGl6YXRpb24pCiAgaWYgKCFza2lwQ2hhcnRVcGRhdGUpIHsKICAgIHVwZGF0ZUNoYXJ0KCk7CiAgfQp9CgpmdW5jdGlvbiB1cGRhdGVDdXJyZW50U2V0dGluZ3NEaXNwbGF5KCkgewogIGNvbnN0IGJhc2VsaW5lTWV0aG9kU2VsZWN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJhc2VsaW5lLW1ldGhvZC1zZWxlY3QiKTsKICBjb25zdCBub3JtYWxpemF0aW9uTW9kZVNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJub3JtYWxpemF0aW9uLW1vZGUtc2VsZWN0Iik7CiAgY29uc3QgcmVncmVzc2lvblR5cGVTZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi10eXBlLXNlbGVjdCIpOwogIAogIGNvbnN0IGJhc2VsaW5lTWV0aG9kRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3VycmVudC1iYXNlbGluZS1tZXRob2QiKTsKICBjb25zdCBub3JtYWxpemF0aW9uTW9kZUVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImN1cnJlbnQtbm9ybWFsaXphdGlvbi1tb2RlIik7CiAgY29uc3QgcmVncmVzc2lvblR5cGVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXJyZW50LXJlZ3Jlc3Npb24tdHlwZSIpOwogIAogIGlmIChiYXNlbGluZU1ldGhvZEVsICYmIGJhc2VsaW5lTWV0aG9kU2VsZWN0KSB7CiAgICBjb25zdCBtZXRob2QgPSBiYXNlbGluZU1ldGhvZFNlbGVjdC52YWx1ZTsKICAgIGJhc2VsaW5lTWV0aG9kRWwudGV4dENvbnRlbnQgPSBtZXRob2QuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBtZXRob2Quc2xpY2UoMSk7CiAgfQogIAogIGlmIChub3JtYWxpemF0aW9uTW9kZUVsICYmIG5vcm1hbGl6YXRpb25Nb2RlU2VsZWN0KSB7CiAgICBjb25zdCBtb2RlID0gbm9ybWFsaXphdGlvbk1vZGVTZWxlY3QudmFsdWU7CiAgICBsZXQgZGlzcGxheU5hbWU7CiAgICBpZiAobW9kZSA9PT0gImRlbHRhX2Zfb3Zlcl9mIikgewogICAgICBkaXNwbGF5TmFtZSA9ICLOlEYvRiI7CiAgICB9IGVsc2UgaWYgKG1vZGUgPT09ICJtdWx0aXBsaWNhdGl2ZSIpIHsKICAgICAgZGlzcGxheU5hbWUgPSAiTXVsdGlwbGljYXRpdmUiOwogICAgfSBlbHNlIGlmIChtb2RlID09PSAibG93ZXN0X3BvaW50IikgewogICAgICBkaXNwbGF5TmFtZSA9ICJMb3dlc3QgUG9pbnQiOwogICAgfSBlbHNlIGlmIChtb2RlID09PSAiZmlyc3RfcG9pbnQiKSB7CiAgICAgIGRpc3BsYXlOYW1lID0gIkZpcnN0IFBvaW50IEFmdGVyIjsKICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gIm5vbmUiKSB7CiAgICAgIGRpc3BsYXlOYW1lID0gIk5vbmUiOwogICAgfSBlbHNlIHsKICAgICAgZGlzcGxheU5hbWUgPSBtb2RlOwogICAgfQogICAgbm9ybWFsaXphdGlvbk1vZGVFbC50ZXh0Q29udGVudCA9IGRpc3BsYXlOYW1lOwogIH0KICAKICBpZiAocmVncmVzc2lvblR5cGVFbCAmJiByZWdyZXNzaW9uVHlwZVNlbGVjdCkgewogICAgY29uc3QgdHlwZSA9IHJlZ3Jlc3Npb25UeXBlU2VsZWN0LnZhbHVlOwogICAgY29uc3QgdHlwZUxhYmVscyA9IHsKICAgICAgImxpbmVhciI6ICJMaW5lYXIiLAogICAgICAicG9seW5vbWlhbCI6ICJQb2x5bm9taWFsIiwKICAgICAgImV4cG9uZW50aWFsIjogIkV4cG9uZW50aWFsIiwKICAgICAgImxvZ2FyaXRobWljIjogIkxvZ2FyaXRobWljIiwKICAgICAgIm1vbm8tZXhwb25lbnRpYWwiOiAiTW9uby1leHBvbmVudGlhbCBwbGF0ZWF1IgogICAgfTsKICAgIHJlZ3Jlc3Npb25UeXBlRWwudGV4dENvbnRlbnQgPSB0eXBlTGFiZWxzW3R5cGVdIHx8IHR5cGU7CiAgfQp9CgpmdW5jdGlvbiBwYXJzZUxhYmVsRm9yTGVnZW5kKGxhYmVsKSB7CiAgLy8gUGFyc2UgbGFiZWwgZm9ybWF0OiAiRTE3LCBGMTcsIEcxNywgRTE0LCBHMTQgLSA1MDAtMTAtMiAoUExDZV9XVF9DYSkgQ29sIDE3ICg1LXBsaWNhdGUsIDIgZGF0YXNldHMsIG1lYW4gwrEgU0UpIgogIC8vIEV4dHJhY3QgbWFpbiBoZWFkaW5nIChlLmcuLCAiNTAwLTEwLTIiKSBhbmQgcmV0dXJuIHJlc3QgYXMgZGV0YWlscwogIAogIGlmICghbGFiZWwpIHJldHVybiB7IG1haW5IZWFkaW5nOiBsYWJlbCwgZGV0YWlsczogIiIgfTsKICAKICAvLyBQYXR0ZXJuIHRvIG1hdGNoOiBudW1iZXItbnVtYmVyLW51bWJlciAodGhlIG1haW4gaGVhZGluZyBsaWtlICI1MDAtMTAtMiIpCiAgY29uc3QgbWFpbkhlYWRpbmdNYXRjaCA9IGxhYmVsLm1hdGNoKC9cYihcZCstXGQrLVxkKylcYi8pOwogIAogIGlmIChtYWluSGVhZGluZ01hdGNoKSB7CiAgICBjb25zdCBtYWluSGVhZGluZyA9IG1haW5IZWFkaW5nTWF0Y2hbMV07CiAgICBjb25zdCBtYXRjaEluZGV4ID0gbWFpbkhlYWRpbmdNYXRjaC5pbmRleDsKICAgIAogICAgLy8gR2V0IHBhcnRzIGJlZm9yZSBhbmQgYWZ0ZXIgdGhlIG1haW4gaGVhZGluZwogICAgY29uc3QgYmVmb3JlID0gbGFiZWwuc3Vic3RyaW5nKDAsIG1hdGNoSW5kZXgpLnRyaW0oKTsKICAgIGNvbnN0IGFmdGVyID0gbGFiZWwuc3Vic3RyaW5nKG1hdGNoSW5kZXggKyBtYWluSGVhZGluZy5sZW5ndGgpLnRyaW0oKTsKICAgIAogICAgLy8gQ29tYmluZSBiZWZvcmUgYW5kIGFmdGVyCiAgICBsZXQgZGV0YWlscyA9IChiZWZvcmUgKyAiICIgKyBhZnRlcikudHJpbSgpOwogICAgLy8gQ2xlYW4gdXAgZXh0cmEgc3BhY2VzIGFuZCBkYXNoZXMKICAgIGRldGFpbHMgPSBkZXRhaWxzLnJlcGxhY2UoL1xzKi1ccyovZywgIiAtICIpLnJlcGxhY2UoL1xzKy9nLCAiICIpLnRyaW0oKTsKICAgIC8vIFJlbW92ZSBsZWFkaW5nL3RyYWlsaW5nIGRhc2hlcyBhbmQgY2xlYW4gdXAKICAgIGRldGFpbHMgPSBkZXRhaWxzLnJlcGxhY2UoL14tXHMqLywgIiIpLnJlcGxhY2UoL1xzKi0kLywgIiIpLnRyaW0oKTsKICAgIAogICAgcmV0dXJuIHsgbWFpbkhlYWRpbmc6IG1haW5IZWFkaW5nLCBkZXRhaWxzOiBkZXRhaWxzIH07CiAgfQogIAogIC8vIElmIG5vIHBhdHRlcm4gbWF0Y2gsIHJldHVybiBvcmlnaW5hbCBhcyBtYWluIGhlYWRpbmcKICByZXR1cm4geyBtYWluSGVhZGluZzogbGFiZWwsIGRldGFpbHM6ICIiIH07Cn0KCmZ1bmN0aW9uIHVwZGF0ZU1vbm9FeHBvbmVudGlhbEluZm9QYW5lbChtb25vRXhwUGFyYW1zKSB7CiAgY29uc3QgaW5mb1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlZ3Jlc3Npb24taW5mby1wYW5lbCIpOwogIGNvbnN0IGluZm9Db250ZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlZ3Jlc3Npb24taW5mby1jb250ZW50Iik7CiAgCiAgaWYgKCFpbmZvUGFuZWwgfHwgIWluZm9Db250ZW50KSB7CiAgICByZXR1cm47CiAgfQogIAogIGlmIChtb25vRXhwUGFyYW1zLmxlbmd0aCA9PT0gMCkgewogICAgaW5mb0NvbnRlbnQuaW5uZXJIVE1MID0gIjxkaXYgc3R5bGU9J2NvbG9yOiAjNjY2Oyc+Tm8gZml0cyBhdmFpbGFibGUuIFNlbGVjdCB3ZWxscyBhbmQgZW5hYmxlIHJlZ3Jlc3Npb24uPC9kaXY+IjsKICAgIHJldHVybjsKICB9CiAgCiAgLy8gQnVpbGQgSFRNTCBmb3IgcGFyYW1ldGVycwogIGxldCBodG1sID0gIiI7CiAgCiAgLy8gTW9kZWwgZXF1YXRpb24KICBodG1sICs9ICI8ZGl2IHN0eWxlPSdtYXJnaW4tYm90dG9tOiA4cHg7IHBhZGRpbmc6IDRweDsgYmFja2dyb3VuZDogd2hpdGU7IGJvcmRlci1yYWRpdXM6IDJweDsnPiI7CiAgaHRtbCArPSAiPHN0cm9uZz5Nb2RlbDo8L3N0cm9uZz4geSh0KSA9IDEgKyBBKDEgLSBlPHN1cD4tayh0LXTigoApPC9zdXA+KSI7CiAgaHRtbCArPSAiPC9kaXY+IjsKICAKICAvLyBQYXJhbWV0ZXJzIGZvciBlYWNoIGZpdAogIG1vbm9FeHBQYXJhbXMuZm9yRWFjaCgoZml0LCBpZHgpID0+IHsKICAgIGNvbnN0IHAgPSBmaXQucGFyYW1zOwogICAgY29uc3QgYm9yZGVyQ29sb3IgPSBmaXQuY29sb3IgfHwgJyMyYTZjZmYnOyAvLyBVc2UgZGF0YXNldCBjb2xvciBvciBkZWZhdWx0IGJsdWUKICAgIAogICAgLy8gUGFyc2UgbGFiZWwgdG8gZXh0cmFjdCBtYWluIGhlYWRpbmcgYW5kIGRldGFpbHMKICAgIGNvbnN0IHBhcnNlZCA9IHBhcnNlTGFiZWxGb3JMZWdlbmQoZml0LmxhYmVsKTsKICAgIAogICAgaHRtbCArPSBgPGRpdiBzdHlsZT0nbWFyZ2luLWJvdHRvbTogMTJweDsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiB3aGl0ZTsgYm9yZGVyLXJhZGl1czogMnB4OyBib3JkZXItbGVmdDogM3B4IHNvbGlkICR7Ym9yZGVyQ29sb3J9Oyc+YDsKICAgIAogICAgLy8gTWFpbiBoZWFkaW5nIGluIGNhcmQgY29sb3IKICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9J2NvbG9yOiAke2JvcmRlckNvbG9yfTsgZm9udC13ZWlnaHQ6IDYwMDsgZm9udC1zaXplOiAwLjlyZW07IG1hcmdpbi1ib3R0b206IDRweDsnPiR7cGFyc2VkLm1haW5IZWFkaW5nfTwvZGl2PmA7CiAgICAKICAgIC8vIERldGFpbHMgaW4gZ3JheSBiZWxvdwogICAgaWYgKHBhcnNlZC5kZXRhaWxzKSB7CiAgICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9J2NvbG9yOiAjNjY2OyBmb250LXNpemU6IDAuN3JlbTsgbWFyZ2luLWJvdHRvbTogOHB4OyBsaW5lLWhlaWdodDogMS4zOyc+JHtwYXJzZWQuZGV0YWlsc308L2Rpdj5gOwogICAgfQogICAgCiAgICAvLyBQYXJhbWV0ZXJzIGdyaWQKICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9J2Rpc3BsYXk6IGdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyIDFmcjsgZ2FwOiA0cHg7IGZvbnQtc2l6ZTogMC43cmVtOyBtYXJnaW4tdG9wOiA4cHg7Jz5gOwogICAgCiAgICAvLyBMZWZ0IGNvbHVtbgogICAgaHRtbCArPSBgPGRpdj48c3Ryb25nPkEgKGFtcGxpdHVkZSk6PC9zdHJvbmc+ICR7cC5BLnRvRml4ZWQoNCl9PC9kaXY+YDsKICAgIGh0bWwgKz0gYDxkaXY+PHN0cm9uZz5rIChyYXRlIGNvbnN0YW50KTo8L3N0cm9uZz4gJHtwLmsudG9GaXhlZCg2KX0gc+KBu8K5PC9kaXY+YDsKICAgIGh0bWwgKz0gYDxkaXY+PHN0cm9uZz7PhCAodGltZSBjb25zdGFudCk6PC9zdHJvbmc+ICR7cC50YXUudG9GaXhlZCgyKX0gczwvZGl2PmA7CiAgICAKICAgIC8vIFJpZ2h0IGNvbHVtbgogICAgaHRtbCArPSBgPGRpdj48c3Ryb25nPnTigoAgKHN0YXJ0IHRpbWUpOjwvc3Ryb25nPiAke3AudDAudG9GaXhlZCgyKX0gczwvZGl2PmA7CiAgICBodG1sICs9IGA8ZGl2PjxzdHJvbmc+dOKCgS/igoIgKGhhbGYtdGltZSk6PC9zdHJvbmc+ICR7cC50SGFsZi50b0ZpeGVkKDIpfSBzPC9kaXY+YDsKICAgIGh0bWwgKz0gYDxkaXY+PHN0cm9uZz5QbGF0ZWF1Ojwvc3Ryb25nPiAke3AucGxhdGVhdS50b0ZpeGVkKDQpfTwvZGl2PmA7CiAgICAKICAgIGh0bWwgKz0gYDwvZGl2PjwvZGl2PmA7CiAgfSk7CiAgCiAgaW5mb0NvbnRlbnQuaW5uZXJIVE1MID0gaHRtbDsKfQoKZnVuY3Rpb24gcmVuZGVyV2VsbFNlbGVjdG9yR3JpZCgpIHsKICBjb25zdCBncmlkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIndlbGwtc2VsZWN0b3ItZ3JpZCIpOwogIGlmICghZ3JpZCB8fCBzZWxlY3RlZERhdGFzZXRJZHMuc2l6ZSA9PT0gMCkgewogICAgcmV0dXJuOwogIH0KICAKICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogIGlmIChzZWxlY3RlZERhdGFzZXRzLmxlbmd0aCA9PT0gMCkgewogICAgZ3JpZC5pbm5lckhUTUwgPSAiPGRpdiBzdHlsZT0nY29sb3I6ICM2NjY7IGZvbnQtc2l6ZTogMC44cmVtOyBwYWRkaW5nOiA4cHg7Jz5ObyBkYXRhc2V0cyBzZWxlY3RlZC48L2Rpdj4iOwogICAgcmV0dXJuOwogIH0KICAKICBncmlkLmlubmVySFRNTCA9ICIiOwogIAogIC8vIENvbGxlY3QgYWxsIHVuaXF1ZSB3ZWxsIElEcyBmcm9tIHNlbGVjdGVkIGRhdGFzZXRzCiAgY29uc3QgYWxsV2VsbHNTZXQgPSBuZXcgU2V0KCk7CiAgc2VsZWN0ZWREYXRhc2V0cy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICBPYmplY3Qua2V5cyh3ZWxscykuZm9yRWFjaCh3ZWxsSWQgPT4gewogICAgICBhbGxXZWxsc1NldC5hZGQod2VsbElkKTsKICAgIH0pOwogIH0pOwogIAogIC8vIFRvcC1sZWZ0IGNvcm5lcgogIGNvbnN0IGNvcm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogIGNvcm5lci5jbGFzc05hbWUgPSAid2VsbC1zZWxlY3Rvci1oZWFkZXIiOwogIGdyaWQuYXBwZW5kQ2hpbGQoY29ybmVyKTsKICAKICAvLyBDb2x1bW4gaGVhZGVycwogIGZvciAobGV0IGMgPSAxOyBjIDw9IFBMQVRFX0NPTFM7IGMrKykgewogICAgY29uc3QgaGVhZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBoZWFkZXIuY2xhc3NOYW1lID0gIndlbGwtc2VsZWN0b3ItaGVhZGVyIjsKICAgIGhlYWRlci50ZXh0Q29udGVudCA9IGM7CiAgICBncmlkLmFwcGVuZENoaWxkKGhlYWRlcik7CiAgfQogIAogIC8vIFJvd3MKICBQTEFURV9ST1dTLmZvckVhY2gocm93TGV0dGVyID0+IHsKICAgIC8vIFJvdyBsYWJlbAogICAgY29uc3Qgcm93TGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIHJvd0xhYmVsLmNsYXNzTmFtZSA9ICJ3ZWxsLXNlbGVjdG9yLWhlYWRlciI7CiAgICByb3dMYWJlbC50ZXh0Q29udGVudCA9IHJvd0xldHRlcjsKICAgIGdyaWQuYXBwZW5kQ2hpbGQocm93TGFiZWwpOwogICAgCiAgICAvLyBXZWxscwogICAgZm9yIChsZXQgY29sID0gMTsgY29sIDw9IFBMQVRFX0NPTFM7IGNvbCsrKSB7CiAgICAgIGNvbnN0IHdlbGxJZCA9IHJvd0xldHRlciArIFN0cmluZyhjb2wpOwogICAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgICAgIGNvbnN0IGNlbGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgY2VsbC5jbGFzc05hbWUgPSAid2VsbC1zZWxlY3Rvci1jZWxsIjsKICAgICAgCiAgICAgIC8vIENoZWNrIGZvciBkYXRhIHVzaW5nIG5vcm1hbGl6ZWQgSUQgKHNpbmNlIGFsbFdlbGxzRGF0YSBjb250YWlucyBub3JtYWxpemVkIElEcykKICAgICAgY29uc3QgaGFzRGF0YSA9IGFsbFdlbGxzU2V0Lmhhcyhub3JtYWxpemVkV2VsbElkKSB8fCBhbGxXZWxsc1NldC5oYXMod2VsbElkKTsKICAgICAgLy8gQ2hlY2sgZXhjbHVzaW9uIHVzaW5nIGJvdGggbm9ybWFsaXplZCBhbmQgbm9uLW5vcm1hbGl6ZWQgSURzCiAgICAgIGNvbnN0IGlzRXhjbHVkZWQgPSBlbmFibGVkV2VsbHMuc2l6ZSA+IDAgJiYgIWVuYWJsZWRXZWxscy5oYXMobm9ybWFsaXplZFdlbGxJZCkgJiYgIWVuYWJsZWRXZWxscy5oYXMod2VsbElkKTsKICAgICAgCiAgICAgIGlmIChoYXNEYXRhKSB7CiAgICAgICAgY2VsbC5jbGFzc0xpc3QuYWRkKCJoYXMtZGF0YSIpOwogICAgICAgIGlmIChpc0V4Y2x1ZGVkKSB7CiAgICAgICAgICAvLyBVc2UgaW5saW5lIHN0eWxlcyB3aXRoIHJnYiB0byBhdm9pZCBoZXggZXNjYXBpbmcgaXNzdWVzCiAgICAgICAgICBjZWxsLnN0eWxlLmJhY2tncm91bmQgPSAicmdiKDI1NSwgMjA0LCAyMDQpIjsKICAgICAgICAgIGNlbGwuc3R5bGUuYm9yZGVyQ29sb3IgPSAicmdiKDI1NSwgMTA3LCAxMDcpIjsKICAgICAgICAgIGNlbGwuc3R5bGUuY29sb3IgPSAicmdiKDIwNCwgMCwgMCkiOwogICAgICAgICAgY2VsbC5zdHlsZS5mb250V2VpZ2h0ID0gImJvbGQiOwogICAgICAgICAgY2VsbC50ZXh0Q29udGVudCA9ICLinJUiOwogICAgICAgICAgY2VsbC50aXRsZSA9IGBXZWxsICR7d2VsbElkfSAtIEVYQ0xVREVEIChjbGljayB0byBpbmNsdWRlKWA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNlbGwudGV4dENvbnRlbnQgPSBjb2w7CiAgICAgICAgICBjZWxsLnRpdGxlID0gYFdlbGwgJHt3ZWxsSWR9IC0gQ2xpY2sgdG8gZXhjbHVkZWA7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGNlbGwuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKSA9PiB7CiAgICAgICAgICB0b2dnbGVXZWxsRXhjbHVzaW9uKG5vcm1hbGl6ZWRXZWxsSWQpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGNlbGwuc3R5bGUuYmFja2dyb3VuZCA9ICIjZjJmMmYyIjsKICAgICAgICBjZWxsLnN0eWxlLmN1cnNvciA9ICJkZWZhdWx0IjsKICAgICAgICBjZWxsLnN0eWxlLm9wYWNpdHkgPSAiMC41IjsKICAgICAgfQogICAgICAKICAgICAgZ3JpZC5hcHBlbmRDaGlsZChjZWxsKTsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gdG9nZ2xlV2VsbEV4Y2x1c2lvbih3ZWxsSWQpIHsKICAvLyBOb3JtYWxpemUgdGhlIGluY29taW5nIHdlbGwgSUQgdG8gZW5zdXJlIGNvbnNpc3RlbnQgY29tcGFyaXNvbgogIC8vIHdlbGxJZCBtYXkgYWxyZWFkeSBiZSBub3JtYWxpemVkLCBidXQgbm9ybWFsaXplIGl0IHRvIGJlIHNhZmUKICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgCiAgaWYgKGVuYWJsZWRXZWxscy5zaXplID09PSAwKSB7CiAgICAvLyBJZiBubyBleGNsdXNpb25zIHlldCwgZmlyc3QgY29sbGVjdCBhbGwgYXZhaWxhYmxlIHdlbGxzCiAgICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogICAgY29uc3QgYWxsV2VsbHNTZXQgPSBuZXcgU2V0KCk7CiAgICBzZWxlY3RlZERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICBPYmplY3Qua2V5cyh3ZWxscykuZm9yRWFjaCh3SWQgPT4gewogICAgICAgIC8vIEFsbCB3ZWxsIElEcyBpbiBhbGxXZWxsc0RhdGEgYXJlIGFscmVhZHkgbm9ybWFsaXplZCwgYnV0IG5vcm1hbGl6ZSB0byBiZSBzYWZlCiAgICAgICAgY29uc3Qgbm9ybWFsaXplZFdJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3SWQpOwogICAgICAgIGFsbFdlbGxzU2V0LmFkZChub3JtYWxpemVkV0lkKTsKICAgICAgfSk7CiAgICB9KTsKICAgIC8vIEVuYWJsZSBhbGwgZXhjZXB0IHRoZSBvbmUgYmVpbmcgY2xpY2tlZCAodXNpbmcgbm9ybWFsaXplZCBJRCkKICAgIGFsbFdlbGxzU2V0LmZvckVhY2god0lkID0+IHsKICAgICAgaWYgKHdJZCAhPT0gbm9ybWFsaXplZFdlbGxJZCkgewogICAgICAgIGVuYWJsZWRXZWxscy5hZGQod0lkKTsKICAgICAgfQogICAgfSk7CiAgfSBlbHNlIHsKICAgIC8vIFRvZ2dsZSB0aGlzIHNwZWNpZmljIHdlbGwgKGNoZWNrIGJvdGggbm9ybWFsaXplZCBhbmQgbm9uLW5vcm1hbGl6ZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkpCiAgICBjb25zdCBoYXNOb3JtYWxpemVkID0gZW5hYmxlZFdlbGxzLmhhcyhub3JtYWxpemVkV2VsbElkKTsKICAgIGNvbnN0IGhhc09yaWdpbmFsID0gZW5hYmxlZFdlbGxzLmhhcyh3ZWxsSWQpOwogICAgCiAgICBpZiAoaGFzTm9ybWFsaXplZCB8fCBoYXNPcmlnaW5hbCkgewogICAgICAvLyBSZW1vdmUgYm90aCBub3JtYWxpemVkIGFuZCBub24tbm9ybWFsaXplZCB2ZXJzaW9ucyBpZiBwcmVzZW50CiAgICAgIGVuYWJsZWRXZWxscy5kZWxldGUobm9ybWFsaXplZFdlbGxJZCk7CiAgICAgIGVuYWJsZWRXZWxscy5kZWxldGUod2VsbElkKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIEFkZCBub3JtYWxpemVkIHZlcnNpb24KICAgICAgZW5hYmxlZFdlbGxzLmFkZChub3JtYWxpemVkV2VsbElkKTsKICAgIH0KICAgIAogICAgLy8gSWYgYWxsIHdlbGxzIGFyZSBlbmFibGVkLCBjbGVhciB0aGUgc2V0IChtZWFuaW5nIGFsbCBhcmUgZW5hYmxlZCkKICAgIGNvbnN0IHNlbGVjdGVkRGF0YXNldHMgPSBnZXRTZWxlY3RlZERhdGFzZXRzKCk7CiAgICBjb25zdCBhbGxXZWxsc1NldCA9IG5ldyBTZXQoKTsKICAgIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICAgIE9iamVjdC5rZXlzKHdlbGxzKS5mb3JFYWNoKHdJZCA9PiB7CiAgICAgICAgLy8gTm9ybWFsaXplIGFsbCB3ZWxsIElEcyBmb3IgY29uc2lzdGVudCBjb21wYXJpc29uCiAgICAgICAgY29uc3Qgbm9ybWFsaXplZFdJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3SWQpOwogICAgICAgIGFsbFdlbGxzU2V0LmFkZChub3JtYWxpemVkV0lkKTsKICAgICAgfSk7CiAgICB9KTsKICAgIAogICAgLy8gQ2hlY2sgaWYgYWxsIHdlbGxzIGFyZSBlbmFibGVkIChjaGVjayBib3RoIG5vcm1hbGl6ZWQgYW5kIG5vbi1ub3JtYWxpemVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5KQogICAgbGV0IGFsbEVuYWJsZWQgPSB0cnVlOwogICAgYWxsV2VsbHNTZXQuZm9yRWFjaChub3JtYWxpemVkV0lkID0+IHsKICAgICAgLy8gQ2hlY2sgYm90aCBub3JtYWxpemVkIGFuZCBvcmlnaW5hbCBmb3JtYXQKICAgICAgY29uc3Qgb3JpZ2luYWxXSWQgPSBub3JtYWxpemVkV0lkLnJlcGxhY2UoL14oW0EtWl0pKFxkezJ9KSQvLCAobWF0Y2gsIHJvdywgY29sKSA9PiB7CiAgICAgICAgY29uc3QgY29sTnVtID0gcGFyc2VJbnQoY29sKTsKICAgICAgICByZXR1cm4gcm93ICsgU3RyaW5nKGNvbE51bSk7CiAgICAgIH0pOwogICAgICBpZiAoIWVuYWJsZWRXZWxscy5oYXMobm9ybWFsaXplZFdJZCkgJiYgIWVuYWJsZWRXZWxscy5oYXMob3JpZ2luYWxXSWQpKSB7CiAgICAgICAgYWxsRW5hYmxlZCA9IGZhbHNlOwogICAgICB9CiAgICB9KTsKICAgIAogICAgaWYgKGFsbEVuYWJsZWQpIHsKICAgICAgZW5hYmxlZFdlbGxzLmNsZWFyKCk7IC8vIENsZWFyIG1lYW5zIGFsbCBlbmFibGVkCiAgICB9CiAgfQogIAogIHJlbmRlcldlbGxTZWxlY3RvckdyaWQoKTsKICByZW5kZXJQbGF0ZUdyaWQoKTsKICB1cGRhdGVXZWxsSW5mbygpOwp9CgpmdW5jdGlvbiBnZXRBbGxEYXRhc2V0c0luR3JvdXAoKSB7CiAgLy8gR2V0IGFsbCBkYXRhc2V0cyBpbiB0aGUgc2VsZWN0ZWQgZ3JvdXBzIChiZWZvcmUgZmlsdGVyaW5nIGJ5IGVuYWJsZWREYXRhc2V0cykKICBpZiAoc2VsZWN0ZWREYXRhc2V0SWRzLnNpemUgPT09IDApIHsKICAgIHJldHVybiBbXTsKICB9CiAgCiAgbGV0IGRhdGFzZXRzID0gW107CiAgCiAgc2VsZWN0ZWREYXRhc2V0SWRzLmZvckVhY2goZ3JvdXBJZCA9PiB7CiAgICBpZiAoZ3JvdXBJZC5zdGFydHNXaXRoKCJncm91cDoiKSkgewogICAgICBjb25zdCBncm91cE5hbWUgPSBncm91cElkLnN1YnN0cmluZyg2KTsKICAgICAgY29uc3Qgc2VsZWN0ZWRQbGF0ZXMgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maWx0ZXIocCA9PiBwLmNvbHVtbl9ncm91cCA9PT0gZ3JvdXBOYW1lKTsKICAgICAgZGF0YXNldHMucHVzaCguLi5zZWxlY3RlZFBsYXRlcy5tYXAocCA9PiBwLmlkKSk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBwbGF0ZSA9IHZpZXdlckRhdGEucGxhdGVzLmZpbmQocCA9PiBwLmlkID09PSBncm91cElkKTsKICAgICAgaWYgKHBsYXRlKSB7CiAgICAgICAgZGF0YXNldHMucHVzaChncm91cElkKTsKICAgICAgfQogICAgfQogIH0pOwogIAogIC8vIFJlbW92ZSBkdXBsaWNhdGVzCiAgcmV0dXJuIFsuLi5uZXcgU2V0KGRhdGFzZXRzKV07Cn0KCmZ1bmN0aW9uIGluaXRpYWxpemVUcmlwbGljYXRlR3JvdXBDb2xvcnMoKSB7CiAgLy8gSW5pdGlhbGl6ZSBjb2xvciBtYXAgaWYgbmVlZGVkIChkb24ndCByZXNldCAtIGtlZXAgY29uc2lzdGVudCBjb2xvcnMpCiAgLy8gVGhpcyBlbnN1cmVzIGFsbCB3ZWxscyB3aXRoIHRoZSBzYW1lIGdyb3VwIG5hbWUgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgLy8gRm9yIGV4YW1wbGUsIGFsbCB3ZWxscyBpbiByb3dzIEIsIEMsIEQgd2l0aCBncm91cCBuYW1lICIyNTAtMTAtMiIgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgaWYgKE9iamVjdC5rZXlzKHRyaXBsaWNhdGVHcm91cENvbG9yTWFwKS5sZW5ndGggPT09IDAgJiYgdmlld2VyRGF0YSAmJiB2aWV3ZXJEYXRhLmNvbmZpZykgewogICAgY29uc3QgZ3JvdXBzID0gdmlld2VyRGF0YS5jb25maWcuZ3JvdXBzIHx8IFtdOwogICAgbGV0IGNvbG9ySW5kZXggPSAwOwogICAgZ3JvdXBzLmZvckVhY2goZ3JvdXAgPT4gewogICAgICBjb25zdCBuYW1lID0gU3RyaW5nKGdyb3VwLm5hbWUgfHwgIiIpLnRyaW0oKTsKICAgICAgaWYgKG5hbWUgJiYgIXRyaXBsaWNhdGVHcm91cENvbG9yTWFwW25hbWVdKSB7CiAgICAgICAgdHJpcGxpY2F0ZUdyb3VwQ29sb3JNYXBbbmFtZV0gPSBUUklQTElDQVRFX0NPTE9SU1tjb2xvckluZGV4ICUlIFRSSVBMSUNBVEVfQ09MT1JTLmxlbmd0aF07CiAgICAgICAgY29sb3JJbmRleCsrOwogICAgICB9CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIHJlbmRlclBsYXRlR3JpZCgpIHsKICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicGxhdGUtZ3JpZHMtY29udGFpbmVyIik7CiAgY29udGFpbmVyLmlubmVySFRNTCA9ICIiOwogIAogIC8vIFNldCB1cCBob3Jpem9udGFsIHNjcm9sbGluZyBjb250YWluZXIKICBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsKICBjb250YWluZXIuc3R5bGUuZmxleERpcmVjdGlvbiA9ICJyb3ciOwogIGNvbnRhaW5lci5zdHlsZS5vdmVyZmxvd1ggPSAiYXV0byI7CiAgY29udGFpbmVyLnN0eWxlLm92ZXJmbG93WSA9ICJoaWRkZW4iOwogIGNvbnRhaW5lci5zdHlsZS5zY3JvbGxTbmFwVHlwZSA9ICJ4IG1hbmRhdG9yeSI7CiAgY29udGFpbmVyLnN0eWxlLnNjcm9sbFBhZGRpbmdMZWZ0ID0gIjE2cHgiOwogIGNvbnRhaW5lci5zdHlsZS5zY3JvbGxQYWRkaW5nUmlnaHQgPSAiMTZweCI7CiAgY29udGFpbmVyLnN0eWxlLnNjcm9sbEJlaGF2aW9yID0gInNtb290aCI7CiAgY29udGFpbmVyLnN0eWxlLmdhcCA9ICIyNHB4IjsKICBjb250YWluZXIuc3R5bGUucGFkZGluZ0JvdHRvbSA9ICI1MHB4IjsgLy8gU3BhY2UgZm9yIGluZGljYXRvcnMKICBjb250YWluZXIuc3R5bGUucGFkZGluZ0xlZnQgPSAiMTZweCI7CiAgY29udGFpbmVyLnN0eWxlLnBhZGRpbmdSaWdodCA9ICIxNnB4IjsKICBjb250YWluZXIuc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogIGNvbnRhaW5lci5zdHlsZS53aWR0aCA9ICIxMDAlJSI7CiAgY29udGFpbmVyLnN0eWxlLmhlaWdodCA9ICJhdXRvIjsKICAKICAvLyBTdHlsZSB0aGUgc2Nyb2xsYmFyCiAgY29udGFpbmVyLnN0eWxlLnNjcm9sbGJhcldpZHRoID0gInRoaW4iOwogIGNvbnRhaW5lci5zdHlsZS5zY3JvbGxiYXJDb2xvciA9ICIjY2NjIHRyYW5zcGFyZW50IjsKICAKICAvLyBJbml0aWFsaXplIGNvbG9yIG1hcCBpZiBuZWVkZWQgKGRvbid0IHJlc2V0IC0ga2VlcCBjb25zaXN0ZW50IGNvbG9ycykKICAvLyBUaGlzIGVuc3VyZXMgYWxsIHdlbGxzIHdpdGggdGhlIHNhbWUgZ3JvdXAgbmFtZSBnZXQgdGhlIHNhbWUgY29sb3IKICBpZiAoT2JqZWN0LmtleXModHJpcGxpY2F0ZUdyb3VwQ29sb3JNYXApLmxlbmd0aCA9PT0gMCkgewogICAgaW5pdGlhbGl6ZVRyaXBsaWNhdGVHcm91cENvbG9ycygpOwogIH0KCiAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICBjb25zdCBhbGxHcm91cERhdGFzZXRzID0gZ2V0QWxsRGF0YXNldHNJbkdyb3VwKCk7CiAgCiAgLy8gR3JvdXAgcGxhdGVzIGJ5IHNjaWVudGlzdCBpbml0aWFscwogIGNvbnN0IHBsYXRlc0J5U2NpZW50aXN0ID0ge307IC8vIHNjaWVudGlzdCAtPiBbcGxhdGVJZHNdCiAgYWxsR3JvdXBEYXRhc2V0cy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgY29uc3QgcGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gcGxhdGVJZCk7CiAgICBpZiAoIXBsYXRlIHx8ICFwbGF0ZS5jb2x1bW5faW5mbykgcmV0dXJuOwogICAgY29uc3Qgc2NpZW50aXN0ID0gcGxhdGUuY29sdW1uX2luZm8uc2NpZW50aXN0IHx8ICIiOwogICAgaWYgKCFwbGF0ZXNCeVNjaWVudGlzdFtzY2llbnRpc3RdKSB7CiAgICAgIHBsYXRlc0J5U2NpZW50aXN0W3NjaWVudGlzdF0gPSBbXTsKICAgIH0KICAgIHBsYXRlc0J5U2NpZW50aXN0W3NjaWVudGlzdF0ucHVzaChwbGF0ZUlkKTsKICB9KTsKICAKICAvLyBTb3J0IHNjaWVudGlzdHMgYnkgaW5pdGlhbHMgKGVtcHR5IHNjaWVudGlzdCBnb2VzIGxhc3QpCiAgY29uc3Qgc29ydGVkU2NpZW50aXN0cyA9IE9iamVjdC5rZXlzKHBsYXRlc0J5U2NpZW50aXN0KS5zb3J0KChhLCBiKSA9PiB7CiAgICBpZiAoYSA9PT0gIiIpIHJldHVybiAxOwogICAgaWYgKGIgPT09ICIiKSByZXR1cm4gLTE7CiAgICByZXR1cm4gYS5sb2NhbGVDb21wYXJlKGIpOwogIH0pOwogIAogIC8vIEJ1aWxkIGNvbHVtbiBpbmZvIG1hcDogY29sdW1uIC0+IHsgZ2Vub3R5cGUsIGJ1ZmZlciwgc2NpZW50aXN0IH0KICAvLyBVc2UgYWxsIGRhdGFzZXRzIGluIGdyb3VwIHRvIHNob3cgYWxsIGF2YWlsYWJsZSBjb2x1bW4gZ3JvdXBzCiAgY29uc3QgY29sdW1uSW5mb01hcCA9IHt9OyAvLyBjb2x1bW4gLT4geyBnZW5vdHlwZSwgYnVmZmVyLCBzY2llbnRpc3QgfQogIAogIGFsbEdyb3VwRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgIGNvbnN0IHBsYXRlID0gdmlld2VyRGF0YS5wbGF0ZXMuZmluZChwID0+IHAuaWQgPT09IHBsYXRlSWQpOwogICAgaWYgKCFwbGF0ZSB8fCAhcGxhdGUuY29sdW1uX2luZm8pIHJldHVybjsKICAgIAogICAgY29uc3QgY29sdW1uSW5mbyA9IHBsYXRlLmNvbHVtbl9pbmZvOwogICAgLy8gRmluZCB3aGljaCBjb2x1bW5zIGhhdmUgZGF0YSBmb3IgdGhpcyBwbGF0ZQogICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICBPYmplY3Qua2V5cyh3ZWxscykuZm9yRWFjaCh3ZWxsSWQgPT4gewogICAgICBjb25zdCBjb2wgPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAgIGlmICghY29sdW1uSW5mb01hcFtjb2xdKSB7CiAgICAgICAgY29sdW1uSW5mb01hcFtjb2xdID0gewogICAgICAgICAgZ2Vub3R5cGU6IGNvbHVtbkluZm8uZ2Vub3R5cGUgfHwgIiIsCiAgICAgICAgICBidWZmZXI6IGNvbHVtbkluZm8uYnVmZmVyIHx8ICIiLAogICAgICAgICAgc2NpZW50aXN0OiBjb2x1bW5JbmZvLnNjaWVudGlzdCB8fCAiIgogICAgICAgIH07CiAgICAgIH0KICAgIH0pOwogIH0pOwogIAogIC8vIFJlbmRlciBhIHNlcGFyYXRlIGdyaWQgZm9yIGVhY2ggc2NpZW50aXN0CiAgY29uc3QgcGxhdGVDb250YWluZXJzID0gW107CiAgc29ydGVkU2NpZW50aXN0cy5mb3JFYWNoKChzY2llbnRpc3QsIGluZGV4KSA9PiB7CiAgICBjb25zdCBzY2llbnRpc3RQbGF0ZUlkcyA9IHBsYXRlc0J5U2NpZW50aXN0W3NjaWVudGlzdF07CiAgICBjb25zdCBzY2llbnRpc3REYXRhc2V0cyA9IHNlbGVjdGVkRGF0YXNldHMuZmlsdGVyKGlkID0+IHNjaWVudGlzdFBsYXRlSWRzLmluY2x1ZGVzKGlkKSk7CiAgICAKICAgIC8vIENyZWF0ZSBjb250YWluZXIgZm9yIHRoaXMgc2NpZW50aXN0J3MgZ3JpZCB3aXRoIHNjcm9sbCBzbmFwCiAgICBjb25zdCBzY2llbnRpc3RDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIHNjaWVudGlzdENvbnRhaW5lci5zdHlsZS5mbGV4U2hyaW5rID0gIjAiOwogICAgLy8gVXNlIHZpZXdwb3J0IHdpZHRoIG1pbnVzIGFwcHJveGltYXRlIHNpZGViYXIgd2lkdGgsIHdpdGggbWluL21heCBjb25zdHJhaW50cwogICAgc2NpZW50aXN0Q29udGFpbmVyLnN0eWxlLndpZHRoID0gIm1pbihjYWxjKDEwMHZ3IC0gMzUwcHgpLCAxMjAwcHgpIjsKICAgIHNjaWVudGlzdENvbnRhaW5lci5zdHlsZS5taW5XaWR0aCA9ICI4MDBweCI7CiAgICBzY2llbnRpc3RDb250YWluZXIuc3R5bGUuc2Nyb2xsU25hcEFsaWduID0gInN0YXJ0IjsKICAgIHNjaWVudGlzdENvbnRhaW5lci5zdHlsZS5zY3JvbGxTbmFwU3RvcCA9ICJhbHdheXMiOwogICAgc2NpZW50aXN0Q29udGFpbmVyLnN0eWxlLnBhZGRpbmdMZWZ0ID0gIjE2cHgiOwogICAgc2NpZW50aXN0Q29udGFpbmVyLnN0eWxlLnBhZGRpbmdSaWdodCA9ICIxNnB4IjsKICAgIHNjaWVudGlzdENvbnRhaW5lci5zdHlsZS5ib3hTaXppbmcgPSAiYm9yZGVyLWJveCI7CiAgICBzY2llbnRpc3RDb250YWluZXIuZGF0YXNldC5zY2llbnRpc3RJbmRleCA9IGluZGV4OwogICAgCiAgICAvLyBBZGQgc2NpZW50aXN0IGxhYmVsCiAgICBjb25zdCBzY2llbnRpc3RMYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgc2NpZW50aXN0TGFiZWwuc3R5bGUuZm9udFNpemUgPSAiMS4xcmVtIjsKICAgIHNjaWVudGlzdExhYmVsLnN0eWxlLmZvbnRXZWlnaHQgPSAiNjAwIjsKICAgIHNjaWVudGlzdExhYmVsLnN0eWxlLm1hcmdpbkJvdHRvbSA9ICI4cHgiOwogICAgc2NpZW50aXN0TGFiZWwuc3R5bGUuY29sb3IgPSAiIzMzMyI7CiAgICBzY2llbnRpc3RMYWJlbC50ZXh0Q29udGVudCA9IHNjaWVudGlzdCB8fCAiTm8gU2NpZW50aXN0IjsKICAgIHNjaWVudGlzdENvbnRhaW5lci5hcHBlbmRDaGlsZChzY2llbnRpc3RMYWJlbCk7CiAgICAKICAgIC8vIENyZWF0ZSBncmlkIGZvciB0aGlzIHNjaWVudGlzdAogICAgY29uc3QgZ3JpZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgZ3JpZC5pZCA9IGBwbGF0ZS1ncmlkLSR7c2NpZW50aXN0IHx8ICJub25lIn1gOwogICAgZ3JpZC5jbGFzc05hbWUgPSAicGxhdGUtZ3JpZCI7CiAgICBncmlkLnN0eWxlLmRpc3BsYXkgPSAiZ3JpZCI7CiAgICBncmlkLnN0eWxlLmdyaWRUZW1wbGF0ZUNvbHVtbnMgPSBgYXV0byByZXBlYXQoJHtQTEFURV9DT0xTfSwgMWZyKWA7CiAgICBncmlkLnN0eWxlLmdyaWRBdXRvUm93cyA9ICIzMnB4IjsKICAgIGdyaWQuc3R5bGUuZ2FwID0gIjJweCI7CiAgICBncmlkLnN0eWxlLmZvbnRTaXplID0gIjExcHgiOwogICAgZ3JpZC5zdHlsZS5tYXJnaW5Cb3R0b20gPSAiMTZweCI7CiAgICAKICAgIHNjaWVudGlzdENvbnRhaW5lci5hcHBlbmRDaGlsZChncmlkKTsKICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChzY2llbnRpc3RDb250YWluZXIpOwogICAgcGxhdGVDb250YWluZXJzLnB1c2goc2NpZW50aXN0Q29udGFpbmVyKTsKCiAgICAvLyBUb3AtbGVmdCBibGFuawogICAgY29uc3QgY29ybmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBjb3JuZXIuY2xhc3NOYW1lID0gImdyaWQtaGVhZGVyIjsKICAgIGdyaWQuYXBwZW5kQ2hpbGQoY29ybmVyKTsKCiAgICAvLyBDb2x1bW4gbnVtYmVyIGxhYmVscwogICAgZm9yIChsZXQgYyA9IDE7IGMgPD0gUExBVEVfQ09MUzsgYysrKSB7CiAgICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBkaXYuY2xhc3NOYW1lID0gImdyaWQtaGVhZGVyIGNvbC1sYWJlbCI7CiAgICAgIGRpdi50ZXh0Q29udGVudCA9IGM7CiAgICAgIGdyaWQuYXBwZW5kQ2hpbGQoZGl2KTsKICAgIH0KCiAgICBjb25zdCB3ZWxsQ291bnRzID0ge307IC8vIFRyYWNrIGhvdyBtYW55IGRhdGFzZXRzIGhhdmUgZGF0YSBmb3IgZWFjaCB3ZWxsCgogICAgLy8gQ291bnQgZGF0YXNldHMgcGVyIHdlbGwsIGZpbHRlcmluZyBieSBlbmFibGVkIHdlbGxzCiAgICAvLyBOb3JtYWxpemUgd2VsbCBJRHMgdG8gZW5zdXJlIGNvbnNpc3RlbnQgbWF0Y2hpbmcgKHplcm8tcGFkZGVkIGZvcm1hdCkKICAgIC8vIE9ubHkgdXNlIGRhdGFzZXRzIGZvciB0aGlzIHNjaWVudGlzdAogICAgc2NpZW50aXN0RGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICAgIE9iamVjdC5rZXlzKHdlbGxzKS5mb3JFYWNoKHdlbGxJZCA9PiB7CiAgICAgICAgLy8gTm9ybWFsaXplIHdlbGwgSUQgdG8gemVyby1wYWRkZWQgZm9ybWF0IChlLmcuLCAiQjUiIC0+ICJCMDUiLCAiQjEzIiAtPiAiQjEzIikKICAgICAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgICAgICAgCiAgICAgICAgLy8gRmlsdGVyIGJ5IGVuYWJsZWRXZWxscyBpZiBhbnkgYXJlIHNldCAoY2hlY2sgYm90aCBvcmlnaW5hbCBhbmQgbm9ybWFsaXplZCkKICAgICAgICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCkgJiYgIWVuYWJsZWRXZWxscy5oYXMobm9ybWFsaXplZFdlbGxJZCkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gRmlsdGVyIGJ5IGVuYWJsZWRDb2x1bW5zIGlmIGFueSBhcmUgc2V0IChzY2llbnRpc3Qtc3BlY2lmaWMpCiAgICAgICAgLy8gVXNlIHRoZSBzY2llbnRpc3QgZnJvbSB0aGUgb3V0ZXIgbG9vcCAoYWxsIHBsYXRlcyBpbiBzY2llbnRpc3REYXRhc2V0cyBoYXZlIHRoZSBzYW1lIHNjaWVudGlzdCkKICAgICAgICBjb25zdCBjb2x1bW4gPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAgICAgY29uc3QgZW5hYmxlZENvbHVtbnMgPSBnZXRFbmFibGVkQ29sdW1uc0ZvclNjaWVudGlzdChzY2llbnRpc3QpOwogICAgICAgIGlmIChlbmFibGVkQ29sdW1ucy5zaXplID4gMCAmJiAhZW5hYmxlZENvbHVtbnMuaGFzKGNvbHVtbikpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKCF3ZWxsQ291bnRzW25vcm1hbGl6ZWRXZWxsSWRdKSB7CiAgICAgICAgICB3ZWxsQ291bnRzW25vcm1hbGl6ZWRXZWxsSWRdID0gbmV3IFNldCgpOyAvLyBVc2UgU2V0IHRvIGF2b2lkIGR1cGxpY2F0ZXMKICAgICAgICB9CiAgICAgICAgd2VsbENvdW50c1tub3JtYWxpemVkV2VsbElkXS5hZGQocGxhdGVJZCk7CiAgICAgIH0pOwogICAgfSk7CiAgICAKICAgIC8vIENvbnZlcnQgU2V0cyB0byBhcnJheXMgZm9yIGVhc2llciB1c2UKICAgIE9iamVjdC5rZXlzKHdlbGxDb3VudHMpLmZvckVhY2god2VsbElkID0+IHsKICAgICAgd2VsbENvdW50c1t3ZWxsSWRdID0gQXJyYXkuZnJvbSh3ZWxsQ291bnRzW3dlbGxJZF0pOwogICAgfSk7CgogICAgLy8gUm93cwogICAgUExBVEVfUk9XUy5mb3JFYWNoKHJvd0xldHRlciA9PiB7CiAgICAgIC8vIFJvdyBsYWJlbAogICAgICBjb25zdCBsYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBsYWJlbC5jbGFzc05hbWUgPSAiZ3JpZC1oZWFkZXIgcm93LWxhYmVsIjsKICAgICAgbGFiZWwudGV4dENvbnRlbnQgPSByb3dMZXR0ZXI7CiAgICAgIGdyaWQuYXBwZW5kQ2hpbGQobGFiZWwpOwoKICAgICAgLy8gV2VsbHMKICAgICAgZm9yIChsZXQgY29sID0gMTsgY29sIDw9IFBMQVRFX0NPTFM7IGNvbCsrKSB7CiAgICAgICAgY29uc3Qgd2VsbElkID0gcm93TGV0dGVyICsgU3RyaW5nKGNvbCk7CiAgICAgICAgY29uc3Qgbm9ybWFsaXplZFdlbGxJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpOyAvLyBOb3JtYWxpemUgdG8gemVyby1wYWRkZWQgZm9ybWF0IGZvciBtYXRjaGluZwogICAgICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIGRpdi5jbGFzc05hbWUgPSAid2VsbCI7CiAgICAgICAgY29uc3QgaGFzRGF0YSA9IHdlbGxDb3VudHMuaGFzT3duUHJvcGVydHkobm9ybWFsaXplZFdlbGxJZCk7CiAgICAgICAgZGl2LmRhdGFzZXQud2VsbElkID0gd2VsbElkOwogICAgICAgIGRpdi5kYXRhc2V0Lmhhc0RhdGEgPSBoYXNEYXRhID8gInRydWUiIDogImZhbHNlIjsKICAgICAgICAKICAgICAgICBpZiAoaGFzRGF0YSkgewogICAgICAgIGNvbnN0IHBsYXRlcyA9IHdlbGxDb3VudHNbbm9ybWFsaXplZFdlbGxJZF07CiAgICAgICAgCiAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyB3ZWxsIGlzIGEgY29udHJvbCB3ZWxsIChjb25maWd1cmFibGUgdmlhIGNvbnRyb2xfcm93cykKICAgICAgICBjb25zdCBpc0NvbnRyb2wgPSBpc0NvbnRyb2xXZWxsKHdlbGxJZCk7CiAgICAgICAgCiAgICAgICAgLy8gR2V0IGxhYmVsIGZyb20gcm93LWJhc2VkIGNvbmZpZyBvciBjb250ZW50CiAgICAgICAgLy8gVHJ5IHRvIGZpbmQgdGhlIGFjdHVhbCB3ZWxsIElEIGluIHRoZSBkYXRhIHVzaW5nIG5vcm1hbGl6ZWQgZm9ybWF0CiAgICAgICAgY29uc3QgZmlyc3RQbGF0ZUlkID0gcGxhdGVzWzBdOwogICAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW2ZpcnN0UGxhdGVJZF0gfHwge307CiAgICAgICAgLy8gVHJ5IG5vcm1hbGl6ZWQgSUQgZmlyc3QsIHRoZW4gc2VhcmNoIGZvciBtYXRjaGluZyB3ZWxsIHVzaW5nIG5vcm1hbGl6ZWQgZm9ybWF0CiAgICAgICAgbGV0IGFjdHVhbFdlbGxJZCA9IG5vcm1hbGl6ZWRXZWxsSWQ7CiAgICAgICAgaWYgKCF3ZWxsc1thY3R1YWxXZWxsSWRdKSB7CiAgICAgICAgICAvLyBTZWFyY2ggZm9yIG1hdGNoaW5nIHdlbGwgSUQgdXNpbmcgbm9ybWFsaXplZCBmb3JtYXQKICAgICAgICAgIGNvbnN0IG1hdGNoaW5nS2V5ID0gT2JqZWN0LmtleXMod2VsbHMpLmZpbmQoa2V5ID0+IAogICAgICAgICAgICBub3JtYWxpemVXZWxsSWQoa2V5KSA9PT0gbm9ybWFsaXplZFdlbGxJZAogICAgICAgICAgKTsKICAgICAgICAgIGlmIChtYXRjaGluZ0tleSkgewogICAgICAgICAgICBhY3R1YWxXZWxsSWQgPSBtYXRjaGluZ0tleTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3Qgd2VsbERhdGEgPSB3ZWxsc1thY3R1YWxXZWxsSWRdOwogICAgICAgIGlmICghd2VsbERhdGEpIHsKICAgICAgICAgIC8vIFdlbGwgZGF0YSBub3QgZm91bmQsIHNraXAgdGhpcyB3ZWxsCiAgICAgICAgICBkaXYuc3R5bGUuY3Vyc29yID0gImRlZmF1bHQiOwogICAgICAgICAgZGl2LnN0eWxlLmJhY2tncm91bmQgPSAiI2YyZjJmMiI7CiAgICAgICAgICBncmlkLmFwcGVuZENoaWxkKGRpdik7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgY29uc3QgY29uZmlnID0gdmlld2VyRGF0YS5jb25maWcgfHwge307CiAgICAgICAgY29uc3Qgd2VsbExhYmVscyA9IGNvbmZpZy53ZWxsX2xhYmVscyB8fCB7fTsKICAgICAgICAvLyBFeHRyYWN0IHJvdyBsZXR0ZXIgZnJvbSB3ZWxsSWQgKGUuZy4sICJCMTMiIC0+ICJCIikKICAgICAgICBjb25zdCByb3dMZXR0ZXIgPSBnZXRSb3dMZXR0ZXIod2VsbElkKTsKICAgICAgICAKICAgICAgICAvLyBDb3VudCB1bmlxdWUgZGF0YXNldHMgdGhhdCBhY3R1YWxseSBoYXZlIGRhdGEgZm9yIHRoaXMgd2VsbAogICAgICAgIGNvbnN0IHVuaXF1ZVBsYXRlcyA9IHBsYXRlcy5maWx0ZXIocGxhdGVJZCA9PiB7CiAgICAgICAgICBjb25zdCBwbGF0ZVdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBwbGF0ZSBoYXMgZGF0YSBmb3IgdGhpcyB3ZWxsIHVzaW5nIG5vcm1hbGl6ZWQgZm9ybWF0CiAgICAgICAgICByZXR1cm4gcGxhdGVXZWxsc1thY3R1YWxXZWxsSWRdIHx8IAogICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKHBsYXRlV2VsbHMpLnNvbWUoa2V5ID0+IG5vcm1hbGl6ZVdlbGxJZChrZXkpID09PSBub3JtYWxpemVkV2VsbElkKTsKICAgICAgICB9KTsKICAgICAgICBjb25zdCBkYXRhc2V0Q291bnQgPSB1bmlxdWVQbGF0ZXMubGVuZ3RoOwogICAgICAgIAogICAgICAgIC8vIEZvciBjb250cm9sIHdlbGxzOiBtYWluIHRleHQgaXMgIkNvbnRyb2wiLCBsYWJlbCBiZWxvdyBpcyB0aGUgY29udHJvbCBsYWJlbAogICAgICAgIC8vIEZvciBub24tY29udHJvbCB3ZWxsczogbWFpbiB0ZXh0IGlzIHBsYXRlIGNvdW50IG9yIHdlbGwgSUQsIGxhYmVsIGJlbG93IGlzIHRoZSBjb25maWd1cmVkIGxhYmVsCiAgICAgICAgbGV0IG1haW5UZXh0LCBsYWJlbDsKICAgICAgICBpZiAoaXNDb250cm9sKSB7CiAgICAgICAgICBtYWluVGV4dCA9ICJDb250cm9sIjsKICAgICAgICAgIC8vIEdldCB0aGUgY29udHJvbCBsYWJlbCBmcm9tIGNvbmZpZyBvciB3ZWxsIGRhdGEgYW5kIGZvcm1hdCBpdAogICAgICAgICAgbGFiZWwgPSB3ZWxsTGFiZWxzW3Jvd0xldHRlcl0gfHwgd2VsbERhdGEubGFiZWwgfHwgd2VsbERhdGEuY29udGVudCB8fCAiIjsKICAgICAgICAgIGlmIChsYWJlbCkgewogICAgICAgICAgICBsYWJlbCA9IGZvcm1hdExhYmVsKGxhYmVsKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gU2hvdyBkYXRhc2V0IGNvdW50IGlmIG1vcmUgdGhhbiAxLCBvdGhlcndpc2Ugc2hvdyB3ZWxsIElECiAgICAgICAgICBtYWluVGV4dCA9IGRhdGFzZXRDb3VudCA+IDEgPyBgJHtkYXRhc2V0Q291bnR9YCA6IHdlbGxJZDsKICAgICAgICAgIC8vIFVzZSByb3ctYmFzZWQgbGFiZWwgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgdXNlIHdlbGwncyBsYWJlbCBvciBjb250ZW50CiAgICAgICAgICBsYWJlbCA9IHdlbGxMYWJlbHNbcm93TGV0dGVyXSB8fCB3ZWxsRGF0YS5sYWJlbCB8fCB3ZWxsRGF0YS5jb250ZW50IHx8ICIiOwogICAgICAgICAgLy8gRm9ybWF0IGxhYmVsIChyZW1vdmUgdU0sIGZvcm1hdCBhcyBudW1iZXItbnVtYmVyLW51bWJlcikKICAgICAgICAgIGlmIChsYWJlbCkgewogICAgICAgICAgICBsYWJlbCA9IGZvcm1hdExhYmVsKGxhYmVsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZGl2LnRleHRDb250ZW50ID0gbWFpblRleHQ7CiAgICAgICAgZGl2LnN0eWxlLmN1cnNvciA9ICJwb2ludGVyIjsKICAgICAgICBkaXYuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJhdXRvIjsKICAgICAgICBkaXYuc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogICAgICAgIGRpdi5zdHlsZS56SW5kZXggPSAiMSI7CiAgICAgICAgCiAgICAgICAgLy8gQWRkIHZpc3VhbCBpbmRpY2F0b3IgZm9yIGR1cGxpY2F0ZSB3ZWxscwogICAgICAgIGlmIChpc0R1cGxpY2F0ZVdlbGwod2VsbElkKSkgewogICAgICAgICAgZGl2LnN0eWxlLmJvcmRlcldpZHRoID0gIjJweCI7CiAgICAgICAgICBkaXYuc3R5bGUuYm9yZGVyU3R5bGUgPSAiZG91YmxlIjsKICAgICAgICAgIGRpdi50aXRsZSA9IChkaXYudGl0bGUgfHwgIiIpICsgIiDimqDvuI8gRHVwbGljYXRlIHdlbGwgLSBjbGljayB0byBjb21wYXJlIGRhdGFzZXRzIjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKGxhYmVsKSB7CiAgICAgICAgICBjb25zdCBsYWJlbERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgbGFiZWxEaXYuY2xhc3NOYW1lID0gIndlbGwtbGFiZWwiOwogICAgICAgICAgbGFiZWxEaXYudGV4dENvbnRlbnQgPSBsYWJlbDsKICAgICAgICAgIGxhYmVsRGl2LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAibm9uZSI7CiAgICAgICAgICBkaXYuYXBwZW5kQ2hpbGQobGFiZWxEaXYpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBkaXYuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoZSkgPT4gewogICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIC8vIEdldCBhbGwgc2VsZWN0ZWQgZGF0YXNldHMgdGhhdCBoYXZlIGRhdGEgZm9yIHRoaXMgd2VsbCAobm90IGp1c3QgY3VycmVudCBzY2llbnRpc3QncyBncmlkKQogICAgICAgICAgLy8gVGhpcyBlbnN1cmVzIHRvZ2dsZXMgd29yayBhY3Jvc3MgYWxsIGRhdGFzZXRzIGluIHRoZSBzZWxlY3RlZCBncm91cAogICAgICAgICAgY29uc3QgYWxsU2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICAgICAgICAgIGNvbnN0IHBsYXRlc1dpdGhXZWxsID0gYWxsU2VsZWN0ZWREYXRhc2V0cy5maWx0ZXIocGxhdGVJZCA9PiB7CiAgICAgICAgICAgIGNvbnN0IHBsYXRlV2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoaXMgcGxhdGUgaGFzIGRhdGEgZm9yIHRoaXMgd2VsbCB1c2luZyBub3JtYWxpemVkIGZvcm1hdAogICAgICAgICAgICByZXR1cm4gcGxhdGVXZWxsc1tub3JtYWxpemVkV2VsbElkXSB8fCAKICAgICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKHBsYXRlV2VsbHMpLnNvbWUoa2V5ID0+IG5vcm1hbGl6ZVdlbGxJZChrZXkpID09PSBub3JtYWxpemVkV2VsbElkKTsKICAgICAgICAgIH0pOwogICAgICAgICAgdG9nZ2xlV2VsbFNlbGVjdGlvbih3ZWxsSWQsIHBsYXRlc1dpdGhXZWxsKTsKICAgICAgICB9KTsKICAgICAgICBpZiAoaXNDb250cm9sKSB7CiAgICAgICAgICBkaXYuY2xhc3NMaXN0LmFkZCgiY29udHJvbCIpOwogICAgICAgICAgZGl2LnRpdGxlID0gIkNvbnRyb2wgd2VsbCAoaW5kZXBlbmRlbnRseSBzZWxlY3RhYmxlKSI7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIENoZWNrIGlmIHRoaXMgd2VsbCBpcyBwYXJ0IG9mIGEgdHJpcGxpY2F0ZSBncm91cCAoY29udHJvbHMgYXJlIG5ldmVyIGluIHRyaXBsaWNhdGUgZ3JvdXBzKQogICAgICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgICAgICBjb25zdCB0cmlwbGljYXRlR3JvdXAgPSBnZXRUcmlwbGljYXRlR3JvdXAod2VsbElkLCBjb2x1bW4pOwogICAgICAgIAogICAgICAgIC8vIEFkZCB2aXN1YWwgaW5kaWNhdG9yIGZvciB0cmlwbGljYXRlIGdyb3VwcyB3aXRoIGRpc3RpbmN0IGNvbG9ycwogICAgICAgIC8vIEFsbCB3ZWxscyBpbiB0aGUgc2FtZSB0cmlwbGljYXRlIGdyb3VwIChzYW1lIG5hbWUpIGdldCB0aGUgc2FtZSBjb2xvcgogICAgICAgIC8vIEZvciBleGFtcGxlLCBhbGwgd2VsbHMgaW4gcm93cyBCLCBDLCBEIHdpdGggZ3JvdXAgbmFtZSAiMjUwLTEwLTIiIGdldCB0aGUgc2FtZSBjb2xvcgogICAgICAgIC8vIEJvcmRlcnMvc3Ryb2tlcyBvbmx5IGFwcGVhciB3aGVuIHNlbGVjdGVkCiAgICAgICAgaWYgKHRyaXBsaWNhdGVHcm91cCAmJiB0cmlwbGljYXRlR3JvdXAubmFtZSkgewogICAgICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoInRyaXBsaWNhdGUtZ3JvdXAiKTsKICAgICAgICAgIGRpdi50aXRsZSA9IGBUcmlwbGljYXRlIGdyb3VwOiAke3RyaXBsaWNhdGVHcm91cC5uYW1lfSAoY2xpY2sgdG8gc2VsZWN0IGFsbClgOwogICAgICAgICAgCiAgICAgICAgICAvLyBBcHBseSBkaXN0aW5jdCBjb2xvciBmb3IgdGhpcyB0cmlwbGljYXRlIGdyb3VwIChiYWNrZ3JvdW5kIG9ubHksIG5vIGJvcmRlciB1bmxlc3Mgc2VsZWN0ZWQpCiAgICAgICAgICAvLyBBbGwgd2VsbHMgd2l0aCB0aGUgc2FtZSBncm91cCBuYW1lIHdpbGwgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgICAgICAgICAvLyBUaGlzIGVuc3VyZXMgQiwgQywgRCByb3dzIGFsbCBnZXQgdGhlIHNhbWUgY29sb3IgZm9yIHRoZSBzYW1lIHRyaXBsaWNhdGUgZ3JvdXAKICAgICAgICAgIGNvbnN0IGdyb3VwTmFtZSA9IFN0cmluZyh0cmlwbGljYXRlR3JvdXAubmFtZSB8fCAiIikudHJpbSgpOyAvLyBOb3JtYWxpemUgZ3JvdXAgbmFtZQogICAgICAgICAgY29uc3QgY29sb3IgPSBnZXRUcmlwbGljYXRlR3JvdXBDb2xvcihncm91cE5hbWUpOwogICAgICAgICAgaWYgKGNvbG9yICYmIGNvbG9yLmJnSGFzRGF0YSkgewogICAgICAgICAgICAvLyBTZXQgYmFja2dyb3VuZCBjb2xvciBvbmx5IC0gYm9yZGVycyB3aWxsIGJlIGFkZGVkIHdoZW4gc2VsZWN0ZWQKICAgICAgICAgICAgY29uc3QgYmdDb2xvciA9IGhhc0RhdGEgPyBjb2xvci5iZ0hhc0RhdGEgOiBjb2xvci5iZzsKICAgICAgICAgICAgZGl2LnN0eWxlLnNldFByb3BlcnR5KCJiYWNrZ3JvdW5kLWNvbG9yIiwgYmdDb2xvciwgImltcG9ydGFudCIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICAgIC8vIEhpZ2hsaWdodCBpZiBzZWxlY3RlZCAoY2hlY2sgaWYgYW55IHNlbGVjdGVkIGRhdGFzZXQgaGFzIHRoaXMgd2VsbCBzZWxlY3RlZCkKICAgICAgICAgIC8vIEFsc28gY2hlY2sgaWYgdGhpcyB3ZWxsIGlzIHBhcnQgb2YgYSB0cmlwbGljYXRlIGdyb3VwIHRoYXQncyBzZWxlY3RlZAogICAgICAgICAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0c0ZvckNoZWNrID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogICAgICAgICAgbGV0IGlzU2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgICAgIAogICAgICAgICAgaWYgKHRyaXBsaWNhdGVHcm91cCkgewogICAgICAgICAgICAvLyBDaGVjayBpZiBhbnkgd2VsbCBpbiB0aGlzIHRyaXBsaWNhdGUgZ3JvdXAgKHNhbWUgcm93IHBhdHRlcm4sIHNhbWUgY29sdW1uKSBpcyBzZWxlY3RlZAogICAgICAgICAgICBjb25zdCBncm91cFJvd0xldHRlcnMgPSBnZXRSb3dMZXR0ZXJzRnJvbVdlbGxzKHRyaXBsaWNhdGVHcm91cC53ZWxscyk7CiAgICAgICAgICAgIHNlbGVjdGVkRGF0YXNldHNGb3JDaGVjay5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICAgICAgICAgIGlmICghcGxhdGVzLmluY2x1ZGVzKHBsYXRlSWQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGdyb3VwUm93TGV0dGVycy5mb3JFYWNoKHJvd0xldHRlciA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB3SWQgPSByb3dMZXR0ZXIgKyBjb2x1bW47CiAgICAgICAgICAgICAgICBjb25zdCBub3JtYWxpemVkV0lkID0gbm9ybWFsaXplV2VsbElkKHdJZCk7CiAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke25vcm1hbGl6ZWRXSWR9YDsKICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZFdlbGxzLmhhcyhrZXkpKSB7CiAgICAgICAgICAgICAgICAgIGlzU2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoaXMgc3BlY2lmaWMgd2VsbCBpcyBzZWxlY3RlZAogICAgICAgICAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgICAgICAgICAgIGlzU2VsZWN0ZWQgPSBzZWxlY3RlZERhdGFzZXRzRm9yQ2hlY2suc29tZShwbGF0ZUlkID0+IHsKICAgICAgICAgICAgICBpZiAocGxhdGVzLmluY2x1ZGVzKHBsYXRlSWQpKSB7CiAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke25vcm1hbGl6ZWRXZWxsSWR9YDsKICAgICAgICAgICAgICAgIHJldHVybiBzZWxlY3RlZFdlbGxzLmhhcyhrZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgCiAgICAgICAgICBpZiAoaXNTZWxlY3RlZCkgewogICAgICAgICAgICBkaXYuY2xhc3NMaXN0LmFkZCgic2VsZWN0ZWQiKTsKICAgICAgICAgICAgLy8gVXBkYXRlIGJhY2tncm91bmQgY29sb3IgYW5kIGFkZCBib3JkZXIgZm9yIHNlbGVjdGVkIHRyaXBsaWNhdGUgZ3JvdXBzCiAgICAgICAgICAgIGlmICh0cmlwbGljYXRlR3JvdXAgJiYgdHJpcGxpY2F0ZUdyb3VwLm5hbWUpIHsKICAgICAgICAgICAgICBjb25zdCBncm91cE5hbWUgPSBTdHJpbmcodHJpcGxpY2F0ZUdyb3VwLm5hbWUgfHwgIiIpLnRyaW0oKTsgLy8gTm9ybWFsaXplIGdyb3VwIG5hbWUKICAgICAgICAgICAgICBjb25zdCBjb2xvciA9IGdldFRyaXBsaWNhdGVHcm91cENvbG9yKGdyb3VwTmFtZSk7CiAgICAgICAgICAgICAgaWYgKGNvbG9yKSB7CiAgICAgICAgICAgICAgICBkaXYuc3R5bGUuc2V0UHJvcGVydHkoImJhY2tncm91bmQtY29sb3IiLCBjb2xvci5iZ0hhc0RhdGEsICJpbXBvcnRhbnQiKTsKICAgICAgICAgICAgICAgIC8vIEFkZCBib3JkZXIgd2hlbiBzZWxlY3RlZAogICAgICAgICAgICAgICAgZGl2LnN0eWxlLnNldFByb3BlcnR5KCJib3JkZXItY29sb3IiLCBjb2xvci5ib3JkZXIsICJpbXBvcnRhbnQiKTsKICAgICAgICAgICAgICAgIGRpdi5zdHlsZS5zZXRQcm9wZXJ0eSgiYm9yZGVyLXdpZHRoIiwgIjJweCIsICJpbXBvcnRhbnQiKTsKICAgICAgICAgICAgICAgIGRpdi5zdHlsZS5zZXRQcm9wZXJ0eSgiYm9yZGVyLXN0eWxlIiwgInNvbGlkIiwgImltcG9ydGFudCIpOwogICAgICAgICAgICAgICAgZGl2LnN0eWxlLnNldFByb3BlcnR5KCJvdXRsaW5lIiwgYDJweCBzb2xpZCAke2NvbG9yLmJvcmRlcn1gLCAiaW1wb3J0YW50Iik7CiAgICAgICAgICAgICAgICBkaXYuc3R5bGUuc2V0UHJvcGVydHkoIm91dGxpbmUtb2Zmc2V0IiwgIi0ycHgiLCAiaW1wb3J0YW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRpdi5zdHlsZS5jdXJzb3IgPSAiZGVmYXVsdCI7CiAgICAgICAgICBkaXYuc3R5bGUuYmFja2dyb3VuZCA9ICIjZjJmMmYyIjsKICAgICAgICB9CiAgICAgICAgZ3JpZC5hcHBlbmRDaGlsZChkaXYpOwogICAgICB9CiAgICB9KTsKICB9KTsKICAKICAvLyBDcmVhdGUgdmlzdWFsIGluZGljYXRvcnMgYmVsb3cgdGhlIHBsYXRlIGdyaWRzCiAgY3JlYXRlUGxhdGVJbmRpY2F0b3JzKGNvbnRhaW5lciwgcGxhdGVDb250YWluZXJzLCBzb3J0ZWRTY2llbnRpc3RzKTsKICAKICAvLyBVcGRhdGUgY29sdW1uIGxlZ2VuZCB3aXRoIGRhdGFzZXQgbWFwcGluZyAodXNlIGFsbCBkYXRhc2V0cyBpbiBncm91cCkKICB1cGRhdGVDb2x1bW5MZWdlbmQoY29sdW1uSW5mb01hcCwgYWxsR3JvdXBEYXRhc2V0cyk7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVBsYXRlSW5kaWNhdG9ycyhjb250YWluZXIsIHBsYXRlQ29udGFpbmVycywgc2NpZW50aXN0cykgewogIGlmIChwbGF0ZUNvbnRhaW5lcnMubGVuZ3RoID09PSAwKSByZXR1cm47CiAgCiAgLy8gUmVtb3ZlIG9sZCBldmVudCBsaXN0ZW5lcnMgaWYgdGhleSBleGlzdAogIGlmIChwbGF0ZUluZGljYXRvckNsZWFudXApIHsKICAgIHBsYXRlSW5kaWNhdG9yQ2xlYW51cCgpOwogICAgcGxhdGVJbmRpY2F0b3JDbGVhbnVwID0gbnVsbDsKICB9CiAgCiAgLy8gUmVtb3ZlIGV4aXN0aW5nIGluZGljYXRvciBpZiBwcmVzZW50CiAgY29uc3QgZXhpc3RpbmdJbmRpY2F0b3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicGxhdGUtaW5kaWNhdG9ycyIpOwogIGlmIChleGlzdGluZ0luZGljYXRvcikgewogICAgZXhpc3RpbmdJbmRpY2F0b3IucmVtb3ZlKCk7CiAgfQogIAogIC8vIENyZWF0ZSBpbmRpY2F0b3IgY29udGFpbmVyIC0gYXBwZW5kIHRvIG1haW4gZWxlbWVudCAocGFyZW50IG9mIGNvbnRhaW5lcikKICBjb25zdCBtYWluRWxlbWVudCA9IGNvbnRhaW5lci5wYXJlbnRFbGVtZW50OwogIGlmICghbWFpbkVsZW1lbnQpIHJldHVybjsKICAKICBjb25zdCBpbmRpY2F0b3JDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICBpbmRpY2F0b3JDb250YWluZXIuaWQgPSAicGxhdGUtaW5kaWNhdG9ycyI7CiAgaW5kaWNhdG9yQ29udGFpbmVyLnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKICBpbmRpY2F0b3JDb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsKICBpbmRpY2F0b3JDb250YWluZXIuc3R5bGUuZ2FwID0gIjZweCI7CiAgaW5kaWNhdG9yQ29udGFpbmVyLnN0eWxlLmp1c3RpZnlDb250ZW50ID0gImNlbnRlciI7CiAgaW5kaWNhdG9yQ29udGFpbmVyLnN0eWxlLmFsaWduSXRlbXMgPSAiY2VudGVyIjsKICBpbmRpY2F0b3JDb250YWluZXIuc3R5bGUuekluZGV4ID0gIjEwIjsKICBpbmRpY2F0b3JDb250YWluZXIuc3R5bGUucGFkZGluZyA9ICI2cHggMTJweCI7CiAgaW5kaWNhdG9yQ29udGFpbmVyLnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICJyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuOTUpIjsKICBpbmRpY2F0b3JDb250YWluZXIuc3R5bGUuYm9yZGVyUmFkaXVzID0gIjE2cHgiOwogIGluZGljYXRvckNvbnRhaW5lci5zdHlsZS5ib3hTaGFkb3cgPSAiMCAycHggOHB4IHJnYmEoMCwgMCwgMCwgMC4xMikiOwogIGluZGljYXRvckNvbnRhaW5lci5zdHlsZS53aWR0aCA9ICJmaXQtY29udGVudCI7CiAgaW5kaWNhdG9yQ29udGFpbmVyLnN0eWxlLm1hcmdpbiA9ICIwIGF1dG8iOwogIGluZGljYXRvckNvbnRhaW5lci5zdHlsZS5tYXJnaW5Ub3AgPSAiLTM1cHgiOwogIGluZGljYXRvckNvbnRhaW5lci5zdHlsZS5tYXJnaW5Cb3R0b20gPSAiOHB4IjsKICAKICAvLyBDcmVhdGUgaW5kaWNhdG9yIGRvdHMgZm9yIGVhY2ggcGxhdGUKICBjb25zdCBpbmRpY2F0b3JzID0gW107CiAgc2NpZW50aXN0cy5mb3JFYWNoKChzY2llbnRpc3QsIGluZGV4KSA9PiB7CiAgICBjb25zdCBpbmRpY2F0b3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGluZGljYXRvci5jbGFzc05hbWUgPSAicGxhdGUtaW5kaWNhdG9yIjsKICAgIGluZGljYXRvci5kYXRhc2V0LmluZGV4ID0gaW5kZXg7CiAgICBpbmRpY2F0b3Iuc3R5bGUud2lkdGggPSAiOHB4IjsKICAgIGluZGljYXRvci5zdHlsZS5oZWlnaHQgPSAiOHB4IjsKICAgIGluZGljYXRvci5zdHlsZS5ib3JkZXJSYWRpdXMgPSAiNTAlJSI7CiAgICBpbmRpY2F0b3Iuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gaW5kZXggPT09IDAgPyAiIzJhNmNmZiIgOiAiI2NjYyI7CiAgICBpbmRpY2F0b3Iuc3R5bGUuY3Vyc29yID0gInBvaW50ZXIiOwogICAgaW5kaWNhdG9yLnN0eWxlLnRyYW5zaXRpb24gPSAiYWxsIDAuM3MgZWFzZSI7CiAgICBpbmRpY2F0b3Iuc3R5bGUuYm9yZGVyID0gIjFweCBzb2xpZCB0cmFuc3BhcmVudCI7CiAgICAKICAgIC8vIEFkZCBob3ZlciBlZmZlY3QKICAgIGluZGljYXRvci5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWVudGVyIiwgKCkgPT4gewogICAgICBpZiAoaW5kaWNhdG9yLnN0eWxlLmJhY2tncm91bmRDb2xvciAhPT0gIiMyYTZjZmYiKSB7CiAgICAgICAgaW5kaWNhdG9yLnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICIjOTk5IjsKICAgICAgICBpbmRpY2F0b3Iuc3R5bGUudHJhbnNmb3JtID0gInNjYWxlKDEuMykiOwogICAgICB9CiAgICB9KTsKICAgIGluZGljYXRvci5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWxlYXZlIiwgKCkgPT4gewogICAgICBpZiAoaW5kaWNhdG9yLnN0eWxlLmJhY2tncm91bmRDb2xvciAhPT0gIiMyYTZjZmYiKSB7CiAgICAgICAgaW5kaWNhdG9yLnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICIjY2NjIjsKICAgICAgICBpbmRpY2F0b3Iuc3R5bGUudHJhbnNmb3JtID0gInNjYWxlKDEpIjsKICAgICAgfQogICAgfSk7CiAgICAKICAgIC8vIENsaWNrIHRvIHNjcm9sbCB0byBwbGF0ZQogICAgaW5kaWNhdG9yLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgKCkgPT4gewogICAgICBpZiAocGxhdGVDb250YWluZXJzW2luZGV4XSkgewogICAgICAgIHBsYXRlQ29udGFpbmVyc1tpbmRleF0uc2Nyb2xsSW50b1ZpZXcoeyBiZWhhdmlvcjogInNtb290aCIsIGJsb2NrOiAibmVhcmVzdCIsIGlubGluZTogInN0YXJ0IiB9KTsKICAgICAgfQogICAgfSk7CiAgICAKICAgIC8vIEFkZCB0b29sdGlwIHdpdGggc2NpZW50aXN0IG5hbWUKICAgIGluZGljYXRvci50aXRsZSA9IHNjaWVudGlzdCB8fCAiTm8gU2NpZW50aXN0IjsKICAgIAogICAgaW5kaWNhdG9yQ29udGFpbmVyLmFwcGVuZENoaWxkKGluZGljYXRvcik7CiAgICBpbmRpY2F0b3JzLnB1c2goaW5kaWNhdG9yKTsKICB9KTsKICAKICAvLyBJbnNlcnQgaW5kaWNhdG9yIGNvbnRhaW5lciBhZnRlciB0aGUgcGxhdGUtZ3JpZHMtY29udGFpbmVyCiAgaWYgKG1haW5FbGVtZW50KSB7CiAgICBtYWluRWxlbWVudC5pbnNlcnRCZWZvcmUoaW5kaWNhdG9yQ29udGFpbmVyLCBjb250YWluZXIubmV4dFNpYmxpbmcpOwogIH0KICAKICAvLyBVcGRhdGUgaW5kaWNhdG9ycyBvbiBzY3JvbGwKICBsZXQgc2Nyb2xsVGltZW91dDsKICBjb25zdCB1cGRhdGVBY3RpdmVJbmRpY2F0b3IgPSAoKSA9PiB7CiAgICBjb25zdCBjb250YWluZXJSZWN0ID0gY29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgY29uc3QgY29udGFpbmVyQ2VudGVyID0gY29udGFpbmVyUmVjdC5sZWZ0ICsgY29udGFpbmVyUmVjdC53aWR0aCAvIDI7CiAgICAKICAgIGxldCBhY3RpdmVJbmRleCA9IDA7CiAgICBsZXQgbWluRGlzdGFuY2UgPSBJbmZpbml0eTsKICAgIAogICAgcGxhdGVDb250YWluZXJzLmZvckVhY2goKHBsYXRlQ29udGFpbmVyLCBpbmRleCkgPT4gewogICAgICBjb25zdCBwbGF0ZVJlY3QgPSBwbGF0ZUNvbnRhaW5lci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgY29uc3QgcGxhdGVDZW50ZXIgPSBwbGF0ZVJlY3QubGVmdCArIHBsYXRlUmVjdC53aWR0aCAvIDI7CiAgICAgIGNvbnN0IGRpc3RhbmNlID0gTWF0aC5hYnMoY29udGFpbmVyQ2VudGVyIC0gcGxhdGVDZW50ZXIpOwogICAgICAKICAgICAgaWYgKGRpc3RhbmNlIDwgbWluRGlzdGFuY2UpIHsKICAgICAgICBtaW5EaXN0YW5jZSA9IGRpc3RhbmNlOwogICAgICAgIGFjdGl2ZUluZGV4ID0gaW5kZXg7CiAgICAgIH0KICAgIH0pOwogICAgCiAgICAvLyBVcGRhdGUgaW5kaWNhdG9yIHN0eWxlcwogICAgaW5kaWNhdG9ycy5mb3JFYWNoKChpbmRpY2F0b3IsIGluZGV4KSA9PiB7CiAgICAgIGlmIChpbmRleCA9PT0gYWN0aXZlSW5kZXgpIHsKICAgICAgICBpbmRpY2F0b3Iuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gIiMyYTZjZmYiOwogICAgICAgIGluZGljYXRvci5zdHlsZS53aWR0aCA9ICIxMHB4IjsKICAgICAgICBpbmRpY2F0b3Iuc3R5bGUuaGVpZ2h0ID0gIjEwcHgiOwogICAgICAgIGluZGljYXRvci5zdHlsZS5ib3JkZXIgPSAiMXB4IHNvbGlkICMxYTVjZTYiOwogICAgICB9IGVsc2UgewogICAgICAgIGluZGljYXRvci5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAiI2NjYyI7CiAgICAgICAgaW5kaWNhdG9yLnN0eWxlLndpZHRoID0gIjhweCI7CiAgICAgICAgaW5kaWNhdG9yLnN0eWxlLmhlaWdodCA9ICI4cHgiOwogICAgICAgIGluZGljYXRvci5zdHlsZS5ib3JkZXIgPSAiMXB4IHNvbGlkIHRyYW5zcGFyZW50IjsKICAgICAgfQogICAgfSk7CiAgfTsKICAKICAvLyBDcmVhdGUgbmFtZWQgaGFuZGxlciBmdW5jdGlvbnMgc28gdGhleSBjYW4gYmUgcmVtb3ZlZCBsYXRlcgogIGNvbnN0IHNjcm9sbEhhbmRsZXIgPSAoKSA9PiB7CiAgICBjbGVhclRpbWVvdXQoc2Nyb2xsVGltZW91dCk7CiAgICBzY3JvbGxUaW1lb3V0ID0gc2V0VGltZW91dCh1cGRhdGVBY3RpdmVJbmRpY2F0b3IsIDUwKTsKICB9OwogIAogIGNvbnN0IHJlc2l6ZUhhbmRsZXIgPSB1cGRhdGVBY3RpdmVJbmRpY2F0b3I7CiAgCiAgLy8gQWRkIGV2ZW50IGxpc3RlbmVycwogIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCJzY3JvbGwiLCBzY3JvbGxIYW5kbGVyKTsKICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicmVzaXplIiwgcmVzaXplSGFuZGxlcik7CiAgCiAgLy8gU3RvcmUgY2xlYW51cCBmdW5jdGlvbgogIHBsYXRlSW5kaWNhdG9yQ2xlYW51cCA9ICgpID0+IHsKICAgIGNvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCJzY3JvbGwiLCBzY3JvbGxIYW5kbGVyKTsKICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJyZXNpemUiLCByZXNpemVIYW5kbGVyKTsKICAgIGlmIChzY3JvbGxUaW1lb3V0KSB7CiAgICAgIGNsZWFyVGltZW91dChzY3JvbGxUaW1lb3V0KTsKICAgIH0KICB9OwogIAogIC8vIEluaXRpYWwgdXBkYXRlCiAgdXBkYXRlQWN0aXZlSW5kaWNhdG9yKCk7Cn0KCmZ1bmN0aW9uIHVwZGF0ZUNvbHVtbkxlZ2VuZChjb2x1bW5JbmZvTWFwLCBhbGxEYXRhc2V0cykgewogIGNvbnN0IGxlZ2VuZERpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjb2x1bW4tbGVnZW5kLWNvbnRlbnQiKTsKICBpZiAoIWxlZ2VuZERpdikgcmV0dXJuOwogIAogIC8vIEJ1aWxkIG1hcDogY29sdW1uIC0+IHsgZGF0YXNldHM6IFNldCwgaW5mbzogeyBnZW5vdHlwZSwgYnVmZmVyLCBzY2llbnRpc3QgfSB9CiAgY29uc3QgY29sdW1uRGF0YSA9IHt9OyAvLyBjb2x1bW4gLT4geyBkYXRhc2V0czogU2V0LCBpbmZvOiB7fSB9CiAgCiAgLy8gRmluZCB3aGljaCBkYXRhc2V0cyBoYXZlIGRhdGEgaW4gZWFjaCBjb2x1bW4KICBmb3IgKGxldCBjb2wgPSAxOyBjb2wgPD0gUExBVEVfQ09MUzsgY29sKyspIHsKICAgIGNvbnN0IGluZm8gPSBjb2x1bW5JbmZvTWFwW2NvbF07CiAgICBpZiAoIWluZm8pIGNvbnRpbnVlOwogICAgCiAgICBjb2x1bW5EYXRhW2NvbF0gPSB7CiAgICAgIGRhdGFzZXRzOiBuZXcgU2V0KCksCiAgICAgIGluZm86IHsKICAgICAgICBnZW5vdHlwZTogaW5mby5nZW5vdHlwZSB8fCAiIiwKICAgICAgICBidWZmZXI6IGluZm8uYnVmZmVyIHx8ICIiLAogICAgICAgIHNjaWVudGlzdDogaW5mby5zY2llbnRpc3QgfHwgIiIKICAgICAgfQogICAgfTsKICAgIAogICAgLy8gRmluZCBhbGwgZGF0YXNldHMgdGhhdCBoYXZlIGRhdGEgaW4gdGhpcyBjb2x1bW4KICAgIGFsbERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICBjb25zdCBoYXNEYXRhSW5Db2x1bW4gPSBPYmplY3Qua2V5cyh3ZWxscykuc29tZSh3ZWxsSWQgPT4gewogICAgICAgIGNvbnN0IHdlbGxDb2wgPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAgICAgcmV0dXJuIHdlbGxDb2wgPT09IGNvbDsKICAgICAgfSk7CiAgICAgIAogICAgICBpZiAoaGFzRGF0YUluQ29sdW1uKSB7CiAgICAgICAgY29sdW1uRGF0YVtjb2xdLmRhdGFzZXRzLmFkZChwbGF0ZUlkKTsKICAgICAgfQogICAgfSk7CiAgfQogIAogIGlmIChPYmplY3Qua2V5cyhjb2x1bW5EYXRhKS5sZW5ndGggPT09IDApIHsKICAgIGxlZ2VuZERpdi5pbm5lckhUTUwgPSAiPGRpdiBzdHlsZT0nY29sb3I6ICM2NjY7IGZvbnQtc2l6ZTogMC44cmVtOyc+Tm8gY29sdW1uIGluZm9ybWF0aW9uIGF2YWlsYWJsZS48L2Rpdj4iOwogICAgcmV0dXJuOwogIH0KICAKICAvLyBCdWlsZCBIVE1MIHdpdGggaW5kaXZpZHVhbCBjb2x1bW4gY2hlY2tib3hlcwogIGxlZ2VuZERpdi5pbm5lckhUTUwgPSAiIjsKICAKICAvLyBTb3J0IGNvbHVtbnMgbnVtZXJpY2FsbHkKICBjb25zdCBzb3J0ZWRDb2x1bW5zID0gT2JqZWN0LmtleXMoY29sdW1uRGF0YSkubWFwKE51bWJlcikuc29ydCgoYSwgYikgPT4gYSAtIGIpOwogIAogIHNvcnRlZENvbHVtbnMuZm9yRWFjaChjb2wgPT4gewogICAgY29uc3QgY29sRGF0YSA9IGNvbHVtbkRhdGFbY29sXTsKICAgIGNvbnN0IGNvbERhdGFzZXRzID0gQXJyYXkuZnJvbShjb2xEYXRhLmRhdGFzZXRzKTsKICAgIAogICAgaWYgKGNvbERhdGFzZXRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOyAvLyBTa2lwIGNvbHVtbnMgd2l0aCBubyBkYXRhCiAgICAKICAgIC8vIENyZWF0ZSBjb250YWluZXIgZm9yIHRoaXMgY29sdW1uCiAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGRpdi5zdHlsZS5tYXJnaW5Cb3R0b20gPSAiOHB4IjsKICAgIGRpdi5zdHlsZS5wYWRkaW5nID0gIjhweCI7CiAgICBkaXYuc3R5bGUuYmFja2dyb3VuZCA9ICIjZjlmOWY5IjsKICAgIGRpdi5zdHlsZS5ib3JkZXJSYWRpdXMgPSAiM3B4IjsKICAgIAogICAgLy8gQ29sdW1uIGhlYWRlciB3aXRoIGluZm8KICAgIGNvbnN0IGNvbHVtbkhlYWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgY29sdW1uSGVhZGVyLnN0eWxlLmZvbnRXZWlnaHQgPSAiNjAwIjsKICAgIGNvbHVtbkhlYWRlci5zdHlsZS5tYXJnaW5Cb3R0b20gPSAiNnB4IjsKICAgIGNvbHVtbkhlYWRlci50ZXh0Q29udGVudCA9IGBDb2x1bW4gJHtjb2x9YDsKICAgIGRpdi5hcHBlbmRDaGlsZChjb2x1bW5IZWFkZXIpOwogICAgCiAgICAvLyBDb2x1bW4gaW5mbyAoZ2Vub3R5cGUsIGJ1ZmZlciwgc2NpZW50aXN0KQogICAgY29uc3QgZGV0YWlscyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgZGV0YWlscy5zdHlsZS5mb250U2l6ZSA9ICIwLjc1cmVtIjsKICAgIGRldGFpbHMuc3R5bGUubWFyZ2luQm90dG9tID0gIjZweCI7CiAgICBkZXRhaWxzLnN0eWxlLm1hcmdpbkxlZnQgPSAiNHB4IjsKICAgIAogICAgaWYgKGNvbERhdGEuaW5mby5nZW5vdHlwZSkgewogICAgICBjb25zdCBnZW5EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgZ2VuRGl2LnN0eWxlLm1hcmdpbkJvdHRvbSA9ICIycHgiOwogICAgICBnZW5EaXYuaW5uZXJIVE1MID0gYDxzdHJvbmc+R2Vub3R5cGU6PC9zdHJvbmc+ICR7Y29sRGF0YS5pbmZvLmdlbm90eXBlfWA7CiAgICAgIGRldGFpbHMuYXBwZW5kQ2hpbGQoZ2VuRGl2KTsKICAgIH0KICAgIGlmIChjb2xEYXRhLmluZm8uYnVmZmVyKSB7CiAgICAgIGNvbnN0IGJ1ZkRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBidWZEaXYuc3R5bGUubWFyZ2luQm90dG9tID0gIjJweCI7CiAgICAgIGJ1ZkRpdi5pbm5lckhUTUwgPSBgPHN0cm9uZz5CdWZmZXI6PC9zdHJvbmc+ICR7Y29sRGF0YS5pbmZvLmJ1ZmZlcn1gOwogICAgICBkZXRhaWxzLmFwcGVuZENoaWxkKGJ1ZkRpdik7CiAgICB9CiAgICBpZiAoY29sRGF0YS5pbmZvLnNjaWVudGlzdCkgewogICAgICBjb25zdCBzY2lEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgc2NpRGl2LmlubmVySFRNTCA9IGA8c3Ryb25nPlNjaWVudGlzdDo8L3N0cm9uZz4gJHtjb2xEYXRhLmluZm8uc2NpZW50aXN0fWA7CiAgICAgIGRldGFpbHMuYXBwZW5kQ2hpbGQoc2NpRGl2KTsKICAgIH0KICAgIAogICAgZGl2LmFwcGVuZENoaWxkKGRldGFpbHMpOwogICAgCiAgICAvLyBDcmVhdGUgc2VwYXJhdGUgY2hlY2tib3ggZm9yIGVhY2ggZGF0YXNldAogICAgY29sRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgY29uc3QgcGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gcGxhdGVJZCk7CiAgICAgIGNvbnN0IGZpbGVuYW1lID0gcGxhdGUgPyAocGxhdGUuZmlsZSB8fCBwbGF0ZS5pZCkgOiBwbGF0ZUlkOwogICAgICBjb25zdCBzY2llbnRpc3QgPSBwbGF0ZSAmJiBwbGF0ZS5jb2x1bW5faW5mbyA/IChwbGF0ZS5jb2x1bW5faW5mby5zY2llbnRpc3QgfHwgIiIpIDogIiI7CiAgICAgIAogICAgICAvLyBDaGVjayBpZiB0aGlzIGNvbHVtbiBpcyBlbmFibGVkIGZvciB0aGlzIHNjaWVudGlzdCdzIGRhdGFzZXRzCiAgICAgIGNvbnN0IGVuYWJsZWRDb2x1bW5zID0gZ2V0RW5hYmxlZENvbHVtbnNGb3JTY2llbnRpc3Qoc2NpZW50aXN0KTsKICAgICAgY29uc3QgY29sdW1uRW5hYmxlZCA9IGVuYWJsZWRDb2x1bW5zLnNpemUgPT09IDAgfHwgZW5hYmxlZENvbHVtbnMuaGFzKGNvbCk7CiAgICAgIAogICAgICBjb25zdCBkYXRhc2V0RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGRhdGFzZXREaXYuc3R5bGUubWFyZ2luTGVmdCA9ICI4cHgiOwogICAgICBkYXRhc2V0RGl2LnN0eWxlLm1hcmdpblRvcCA9ICI0cHgiOwogICAgICBkYXRhc2V0RGl2LnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgICAgIGRhdGFzZXREaXYuc3R5bGUuYWxpZ25JdGVtcyA9ICJjZW50ZXIiOwogICAgICAKICAgICAgY29uc3QgY2hlY2tib3ggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICBjaGVja2JveC50eXBlID0gImNoZWNrYm94IjsKICAgICAgY2hlY2tib3guaWQgPSBgY29sdW1uLSR7Y29sfS1kYXRhc2V0LSR7cGxhdGVJZH1gOwogICAgICBjaGVja2JveC5jaGVja2VkID0gY29sdW1uRW5hYmxlZDsKICAgICAgY2hlY2tib3guc3R5bGUubWFyZ2luUmlnaHQgPSAiOHB4IjsKICAgICAgY2hlY2tib3guc3R5bGUuY3Vyc29yID0gInBvaW50ZXIiOwogICAgICBjaGVja2JveC5kYXRhc2V0LmNvbHVtbiA9IGNvbDsKICAgICAgY2hlY2tib3guZGF0YXNldC5wbGF0ZUlkID0gcGxhdGVJZDsKICAgICAgY2hlY2tib3guZGF0YXNldC5zY2llbnRpc3QgPSBzY2llbnRpc3Q7CiAgICAgIAogICAgICBjaGVja2JveC5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCAoZSkgPT4gewogICAgICAgIGNvbnN0IGNvbHVtbiA9IHBhcnNlSW50KGUudGFyZ2V0LmRhdGFzZXQuY29sdW1uKTsKICAgICAgICBjb25zdCBzY2llbnRpc3QgPSBlLnRhcmdldC5kYXRhc2V0LnNjaWVudGlzdCB8fCAiIjsKICAgICAgICAKICAgICAgICAvLyBHZXQgZW5hYmxlZCBjb2x1bW5zIGZvciB0aGlzIHNjaWVudGlzdAogICAgICAgIGNvbnN0IGVuYWJsZWRDb2x1bW5zID0gZ2V0RW5hYmxlZENvbHVtbnNGb3JTY2llbnRpc3Qoc2NpZW50aXN0KTsKICAgICAgICAKICAgICAgICAvLyBHZXQgYWxsIGNvbHVtbnMgdGhhdCBoYXZlIGRhdGEgZm9yIHRoaXMgc2NpZW50aXN0J3MgZGF0YXNldHMKICAgICAgICBjb25zdCBhbGxDb2x1bW5zV2l0aERhdGEgPSBuZXcgU2V0KCk7CiAgICAgICAgYWxsRGF0YXNldHMuZm9yRWFjaChwSWQgPT4gewogICAgICAgICAgY29uc3QgcCA9IHZpZXdlckRhdGEucGxhdGVzLmZpbmQocGwgPT4gcGwuaWQgPT09IHBJZCk7CiAgICAgICAgICBjb25zdCBwU2NpZW50aXN0ID0gcCAmJiBwLmNvbHVtbl9pbmZvID8gKHAuY29sdW1uX2luZm8uc2NpZW50aXN0IHx8ICIiKSA6ICIiOwogICAgICAgICAgaWYgKHBTY2llbnRpc3QgPT09IHNjaWVudGlzdCkgewogICAgICAgICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwSWRdIHx8IHt9OwogICAgICAgICAgICBPYmplY3Qua2V5cyh3ZWxscykuZm9yRWFjaCh3ZWxsSWQgPT4gewogICAgICAgICAgICAgIGNvbnN0IGNvbCA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgICAgICAgICAgICBhbGxDb2x1bW5zV2l0aERhdGEuYWRkKGNvbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIGlmIChlLnRhcmdldC5jaGVja2VkKSB7CiAgICAgICAgICAvLyBFbmFibGluZzogYWRkIGNvbHVtbiB0byBlbmFibGVkIHNldCBmb3IgdGhpcyBzY2llbnRpc3QKICAgICAgICAgIGVuYWJsZWRDb2x1bW5zLmFkZChjb2x1bW4pOwogICAgICAgICAgCiAgICAgICAgICAvLyBJZiBhbGwgY29sdW1ucyB0aGF0IGhhdmUgZGF0YSBhcmUgbm93IGVuYWJsZWQsIGNsZWFyIHRoZSBzZXQgKG1lYW5pbmcgYWxsIGVuYWJsZWQpCiAgICAgICAgICAvLyBUaGlzIG9wdGltaXplcyBzdG9yYWdlOiBlbXB0eSBzZXQgPSBhbGwgZW5hYmxlZCwgbm9uLWVtcHR5IHNldCA9IG9ubHkgdGhlc2UgZW5hYmxlZAogICAgICAgICAgY29uc3QgYWxsQ29sdW1uc0VuYWJsZWQgPSBBcnJheS5mcm9tKGFsbENvbHVtbnNXaXRoRGF0YSkuZXZlcnkoY29sID0+IGVuYWJsZWRDb2x1bW5zLmhhcyhjb2wpKTsKICAgICAgICAgIGlmIChhbGxDb2x1bW5zRW5hYmxlZCAmJiBlbmFibGVkQ29sdW1ucy5zaXplID09PSBhbGxDb2x1bW5zV2l0aERhdGEuc2l6ZSkgewogICAgICAgICAgICBlbmFibGVkQ29sdW1ucy5jbGVhcigpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBEaXNhYmxpbmc6IGlmIHNldCBpcyBlbXB0eSAoYWxsIGVuYWJsZWQpLCBwb3B1bGF0ZSBpdCB3aXRoIGFsbCBjb2x1bW5zIGV4Y2VwdCB0aGUgb25lIGJlaW5nIHVuY2hlY2tlZAogICAgICAgICAgaWYgKGVuYWJsZWRDb2x1bW5zLnNpemUgPT09IDApIHsKICAgICAgICAgICAgLy8gQ3VycmVudGx5IGFsbCBhcmUgZW5hYmxlZCwgc28gcG9wdWxhdGUgc2V0IHdpdGggYWxsIGNvbHVtbnMgZXhjZXB0IHRoZSBvbmUgYmVpbmcgdW5jaGVja2VkCiAgICAgICAgICAgIGFsbENvbHVtbnNXaXRoRGF0YS5mb3JFYWNoKGNvbCA9PiB7CiAgICAgICAgICAgICAgaWYgKGNvbCAhPT0gY29sdW1uKSB7CiAgICAgICAgICAgICAgICBlbmFibGVkQ29sdW1ucy5hZGQoY29sKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gU29tZSBjb2x1bW5zIGFyZSBhbHJlYWR5IGRpc2FibGVkLCByZW1vdmUgdGhpcyBvbmUgZnJvbSBlbmFibGVkIHNldAogICAgICAgICAgICBjb25zdCBoYWRDb2x1bW4gPSBlbmFibGVkQ29sdW1ucy5oYXMoY29sdW1uKTsKICAgICAgICAgICAgZW5hYmxlZENvbHVtbnMuZGVsZXRlKGNvbHVtbik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBPbmx5IHJlLWVuYWJsZSBpZiB3ZSBqdXN0IGRlbGV0ZWQgdGhlIGxhc3QgZW5hYmxlZCBjb2x1bW4gKHByZXZlbnQgZGlzYWJsaW5nIGV2ZXJ5dGhpbmcpCiAgICAgICAgICAgIC8vIEJ1dCBvbmx5IGlmIHRoZXJlIGFyZSBvdGhlciBjb2x1bW5zIGF2YWlsYWJsZQogICAgICAgICAgICBpZiAoZW5hYmxlZENvbHVtbnMuc2l6ZSA9PT0gMCAmJiBhbGxDb2x1bW5zV2l0aERhdGEuc2l6ZSA+IDEgJiYgaGFkQ29sdW1uKSB7CiAgICAgICAgICAgICAgLy8gUmUtZW5hYmxlIGFsbCBjb2x1bW5zIGV4Y2VwdCB0aGUgb25lIGJlaW5nIHVuY2hlY2tlZAogICAgICAgICAgICAgIGFsbENvbHVtbnNXaXRoRGF0YS5mb3JFYWNoKGNvbCA9PiB7CiAgICAgICAgICAgICAgICBpZiAoY29sICE9PSBjb2x1bW4pIHsKICAgICAgICAgICAgICAgICAgZW5hYmxlZENvbHVtbnMuYWRkKGNvbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gVXBkYXRlIGFsbCBjaGVja2JveGVzIGZvciBhbGwgY29sdW1ucyBmb3IgdGhpcyBzY2llbnRpc3QgdG8gcmVmbGVjdCB0aGUgbmV3IHN0YXRlCiAgICAgICAgLy8gV2UgbmVlZCB0byB1cGRhdGUgY2hlY2tib3hlcyBmb3IgYWxsIGNvbHVtbnMsIG5vdCBqdXN0IHRoZSBvbmUgdGhhdCB3YXMgdG9nZ2xlZAogICAgICAgIGNvbnN0IGFsbEdyb3VwRGF0YXNldHMgPSBnZXRBbGxEYXRhc2V0c0luR3JvdXAoKTsKICAgICAgICBmb3IgKGxldCBjID0gMTsgYyA8PSBQTEFURV9DT0xTOyBjKyspIHsKICAgICAgICAgIC8vIEZpbmQgYWxsIGRhdGFzZXRzIGZvciB0aGlzIGNvbHVtbiBhbmQgc2NpZW50aXN0CiAgICAgICAgICBjb25zdCBkYXRhc2V0c0ZvckNvbCA9IFtdOwogICAgICAgICAgYWxsR3JvdXBEYXRhc2V0cy5mb3JFYWNoKHBJZCA9PiB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHBsID0+IHBsLmlkID09PSBwSWQpOwogICAgICAgICAgICBjb25zdCBwU2NpZW50aXN0ID0gcCAmJiBwLmNvbHVtbl9pbmZvID8gKHAuY29sdW1uX2luZm8uc2NpZW50aXN0IHx8ICIiKSA6ICIiOwogICAgICAgICAgICBpZiAocFNjaWVudGlzdCA9PT0gc2NpZW50aXN0KSB7CiAgICAgICAgICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcElkXSB8fCB7fTsKICAgICAgICAgICAgICBjb25zdCBoYXNEYXRhSW5Db2x1bW4gPSBPYmplY3Qua2V5cyh3ZWxscykuc29tZSh3ZWxsSWQgPT4gewogICAgICAgICAgICAgICAgY29uc3Qgd2VsbENvbCA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgICAgICAgICAgICAgIHJldHVybiB3ZWxsQ29sID09PSBjOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmIChoYXNEYXRhSW5Db2x1bW4pIHsKICAgICAgICAgICAgICAgIGRhdGFzZXRzRm9yQ29sLnB1c2gocElkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgCiAgICAgICAgICAvLyBVcGRhdGUgYWxsIGNoZWNrYm94ZXMgZm9yIHRoaXMgY29sdW1uCiAgICAgICAgICBkYXRhc2V0c0ZvckNvbC5mb3JFYWNoKHBJZCA9PiB7CiAgICAgICAgICAgIGNvbnN0IGNiID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYGNvbHVtbi0ke2N9LWRhdGFzZXQtJHtwSWR9YCk7CiAgICAgICAgICAgIGlmIChjYikgewogICAgICAgICAgICAgIGNvbnN0IGlzRW5hYmxlZCA9IGVuYWJsZWRDb2x1bW5zLnNpemUgPT09IDAgfHwgZW5hYmxlZENvbHVtbnMuaGFzKGMpOwogICAgICAgICAgICAgIGNiLmNoZWNrZWQgPSBpc0VuYWJsZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBSZS1yZW5kZXIgdGhlIGdyaWQgYW5kIHVwZGF0ZSBjaGFydAogICAgICAgIHJlbmRlclBsYXRlR3JpZCgpOwogICAgICAgIHVwZGF0ZVdlbGxJbmZvKCk7CiAgICAgICAgdXBkYXRlQ2hhcnQoKTsKICAgICAgfSk7CiAgICAgIAogICAgICBjb25zdCBsYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxhYmVsIik7CiAgICAgIGxhYmVsLmh0bWxGb3IgPSBgY29sdW1uLSR7Y29sfS1kYXRhc2V0LSR7cGxhdGVJZH1gOwogICAgICBsYWJlbC5zdHlsZS5jdXJzb3IgPSAicG9pbnRlciI7CiAgICAgIGxhYmVsLnN0eWxlLmZvbnRTaXplID0gIjAuOHJlbSI7CiAgICAgIGxhYmVsLnRleHRDb250ZW50ID0gZmlsZW5hbWU7CiAgICAgIAogICAgICBkYXRhc2V0RGl2LmFwcGVuZENoaWxkKGNoZWNrYm94KTsKICAgICAgZGF0YXNldERpdi5hcHBlbmRDaGlsZChsYWJlbCk7CiAgICAgIGRpdi5hcHBlbmRDaGlsZChkYXRhc2V0RGl2KTsKICAgIH0pOwogICAgCiAgICBsZWdlbmREaXYuYXBwZW5kQ2hpbGQoZGl2KTsKICB9KTsKfQoKZnVuY3Rpb24gdG9nZ2xlV2VsbFNlbGVjdGlvbih3ZWxsSWQsIHBsYXRlSWRzKSB7CiAgLy8gVG9nZ2xlIHNlbGVjdGlvbiBvbmx5IGZvciB0aGUgcGxhdGVJZHMgcGFzc2VkIGluICh3aGljaCBhcmUgYWxyZWFkeSBmaWx0ZXJlZCB0byBjdXJyZW50IHNjaWVudGlzdCkKICAvLyBwbGF0ZUlkcyBzaG91bGQgb25seSBjb250YWluIGRhdGFzZXRzIGZyb20gdGhlIGN1cnJlbnQgc2NpZW50aXN0J3MgZ3JpZAogIGlmIChwbGF0ZUlkcy5sZW5ndGggPT09IDApIHJldHVybjsKICAKICBjb25zdCBjb2x1bW4gPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgY29uc3QgaXNDb250cm9sID0gaXNDb250cm9sV2VsbCh3ZWxsSWQpOwogIAogIC8vIENvbnRyb2wgd2VsbHM6IGFsbG93IGluZGl2aWR1YWwgc2VsZWN0aW9uIChjYW4gc2VsZWN0IGVhY2ggd2VsbCBzZXBhcmF0ZWx5KQogIGlmIChpc0NvbnRyb2wpIHsKICAgIGNvbnN0IG5vcm1hbGl6ZWRXZWxsSWQgPSBub3JtYWxpemVXZWxsSWQod2VsbElkKTsKICAgIC8vIENoZWNrIGlmIHRoaXMgc3BlY2lmaWMgY29udHJvbCB3ZWxsIGlzIGFscmVhZHkgc2VsZWN0ZWQgKG9ubHkgaW4gdGhlIHBhc3NlZCBwbGF0ZUlkcykKICAgIGxldCBpc1NlbGVjdGVkID0gZmFsc2U7CiAgICBwbGF0ZUlkcy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke25vcm1hbGl6ZWRXZWxsSWR9YDsKICAgICAgaWYgKHNlbGVjdGVkV2VsbHMuaGFzKGtleSkpIHsKICAgICAgICBpc1NlbGVjdGVkID0gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgICAKICAgIC8vIFRvZ2dsZSBqdXN0IHRoaXMgaW5kaXZpZHVhbCBjb250cm9sIHdlbGwgYWNyb3NzIHRoZSBwYXNzZWQgcGxhdGVJZHMgb25seQogICAgbGV0IGFueUNoYW5nZWQgPSBmYWxzZTsKICAgIHBsYXRlSWRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICBjb25zdCBoYXNEYXRhID0gd2VsbHNbbm9ybWFsaXplZFdlbGxJZF0gfHwgd2VsbHNbd2VsbElkXTsKICAgICAgaWYgKCFoYXNEYXRhKSB7CiAgICAgICAgcmV0dXJuOyAvLyBTa2lwIGlmIG5vIGRhdGEKICAgICAgfQogICAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZFdlbGxzIGlmIGFueSBhcmUgc2V0CiAgICAgIGlmIChlbmFibGVkV2VsbHMuc2l6ZSA+IDAgJiYgIWVuYWJsZWRXZWxscy5oYXMod2VsbElkKSAmJiAhZW5hYmxlZFdlbGxzLmhhcyhub3JtYWxpemVkV2VsbElkKSkgewogICAgICAgIHJldHVybjsgLy8gU2tpcCBleGNsdWRlZCB3ZWxscwogICAgICB9CiAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7bm9ybWFsaXplZFdlbGxJZH1gOwogICAgICBpZiAoaXNTZWxlY3RlZCkgewogICAgICAgIHNlbGVjdGVkV2VsbHMuZGVsZXRlKGtleSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VsZWN0ZWRXZWxscy5hZGQoa2V5KTsKICAgICAgfQogICAgICBhbnlDaGFuZ2VkID0gdHJ1ZTsKICAgIH0pOwogICAgCiAgICBpZiAoYW55Q2hhbmdlZCkgewogICAgICByZW5kZXJQbGF0ZUdyaWQoKTsKICAgICAgdXBkYXRlV2VsbEluZm8oKTsKICAgICAgdXBkYXRlQ2hhcnQoKTsKICAgIH0KICAgIHJldHVybjsKICB9CiAgCiAgLy8gRm9yIGR1cGxpY2F0ZSB3ZWxscywgYXV0b21hdGljYWxseSBzZWxlY3QgYWxsIGRhdGFzZXRzIGZvciBjb21wYXJpc29uIChvbmx5IGluIGN1cnJlbnQgc2NpZW50aXN0J3MgZ3JpZCkKICBpZiAoaXNEdXBsaWNhdGVXZWxsKHdlbGxJZCkpIHsKICAgIC8vIE9ubHkgdXNlIGRhdGFzZXRzIGZyb20gdGhlIHBhc3NlZCBwbGF0ZUlkcyAoY3VycmVudCBzY2llbnRpc3QncyBncmlkKQogICAgY29uc3Qgbm9ybWFsaXplZFdlbGxJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpOwogICAgY29uc3QgZGF0YXNldHNXaXRoV2VsbCA9IHBsYXRlSWRzLmZpbHRlcihwbGF0ZUlkID0+IHsKICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICAgIHJldHVybiB3ZWxsc1tub3JtYWxpemVkV2VsbElkXSB8fCB3ZWxsc1t3ZWxsSWRdOwogICAgfSk7CiAgICAKICAgIC8vIENoZWNrIGlmIGFueSBkYXRhc2V0IGZvciB0aGlzIHdlbGwgaXMgYWxyZWFkeSBzZWxlY3RlZCAob25seSBpbiBjdXJyZW50IHNjaWVudGlzdCdzIGdyaWQpCiAgICBsZXQgaXNBbnlTZWxlY3RlZCA9IGRhdGFzZXRzV2l0aFdlbGwuc29tZShwbGF0ZUlkID0+IHsKICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHtub3JtYWxpemVkV2VsbElkfWA7CiAgICAgIHJldHVybiBzZWxlY3RlZFdlbGxzLmhhcyhrZXkpOwogICAgfSk7CiAgICAKICAgIC8vIFRvZ2dsZSBhbGwgZGF0YXNldHMgZm9yIHRoaXMgZHVwbGljYXRlIHdlbGwgKG9ubHkgaW4gY3VycmVudCBzY2llbnRpc3QncyBncmlkKQogICAgbGV0IGFueUNoYW5nZWQgPSBmYWxzZTsKICAgIGRhdGFzZXRzV2l0aFdlbGwuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHtub3JtYWxpemVkV2VsbElkfWA7CiAgICAgIGlmIChpc0FueVNlbGVjdGVkKSB7CiAgICAgICAgc2VsZWN0ZWRXZWxscy5kZWxldGUoa2V5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZWxlY3RlZFdlbGxzLmFkZChrZXkpOwogICAgICB9CiAgICAgIGFueUNoYW5nZWQgPSB0cnVlOwogICAgfSk7CiAgICAKICAgIGlmIChhbnlDaGFuZ2VkKSB7CiAgICAgIHJlbmRlclBsYXRlR3JpZCgpOwogICAgICB1cGRhdGVXZWxsSW5mbygpOwogICAgICB1cGRhdGVDaGFydCgpOwogICAgfQogICAgcmV0dXJuOwogIH0KICAKICAvLyBGb3Igbm9uLWNvbnRyb2wgd2VsbHMsIGNoZWNrIHRyaXBsaWNhdGUgZ3JvdXBzCiAgY29uc3QgdHJpcGxpY2F0ZUdyb3VwID0gZ2V0VHJpcGxpY2F0ZUdyb3VwKHdlbGxJZCwgY29sdW1uKTsKICAKICBsZXQgYW55Q2hhbmdlZCA9IGZhbHNlOwogIAogIC8vIENoZWNrIGlmIHRyaXBsaWNhdGUgZ3JvdXAgaXMgc2VsZWN0ZWQgKGNoZWNrIGlmIEFMTCB3ZWxscyBpbiB0aGUgZ3JvdXAgYXJlIHNlbGVjdGVkKQogIC8vIE9ubHkgY2hlY2sgd2l0aGluIHRoZSBwYXNzZWQgcGxhdGVJZHMgKGN1cnJlbnQgc2NpZW50aXN0J3MgZ3JpZCkKICBsZXQgaXNHcm91cFNlbGVjdGVkID0gZmFsc2U7CiAgaWYgKHRyaXBsaWNhdGVHcm91cCkgewogICAgY29uc3QgZ3JvdXBSb3dMZXR0ZXJzID0gZ2V0Um93TGV0dGVyc0Zyb21XZWxscyh0cmlwbGljYXRlR3JvdXAud2VsbHMpOwogICAgLy8gQ291bnQgaG93IG1hbnkgd2VsbHMgaW4gdGhlIGdyb3VwIGFyZSBzZWxlY3RlZCAob25seSBpbiBjdXJyZW50IHNjaWVudGlzdCdzIGdyaWQpCiAgICBsZXQgc2VsZWN0ZWRDb3VudCA9IDA7CiAgICBsZXQgdG90YWxDb3VudCA9IDA7CiAgICAKICAgIHBsYXRlSWRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICBncm91cFJvd0xldHRlcnMuZm9yRWFjaChyb3dMZXR0ZXIgPT4gewogICAgICAgIGNvbnN0IHdJZCA9IHJvd0xldHRlciArIGNvbHVtbjsKICAgICAgICBjb25zdCBub3JtYWxpemVkV0lkID0gbm9ybWFsaXplV2VsbElkKHdJZCk7CiAgICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHtub3JtYWxpemVkV0lkfWA7CiAgICAgICAgY29uc3QgaGFzRGF0YSA9IHdlbGxzW25vcm1hbGl6ZWRXSWRdIHx8IHdlbGxzW3dJZF07CiAgICAgICAgaWYgKGhhc0RhdGEpIHsKICAgICAgICAgIHRvdGFsQ291bnQrKzsKICAgICAgICAgIGlmIChzZWxlY3RlZFdlbGxzLmhhcyhrZXkpKSB7CiAgICAgICAgICAgIHNlbGVjdGVkQ291bnQrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgICAKICAgIC8vIENvbnNpZGVyIGdyb3VwIHNlbGVjdGVkIGlmIGF0IGxlYXN0IG9uZSB3ZWxsIGlzIHNlbGVjdGVkIChmb3IgdG9nZ2xlIGJlaGF2aW9yKQogICAgLy8gVGhpcyBhbGxvd3MgY2xpY2tpbmcgdG8gdG9nZ2xlIHRoZSB3aG9sZSBncm91cAogICAgaXNHcm91cFNlbGVjdGVkID0gc2VsZWN0ZWRDb3VudCA+IDA7CiAgfSBlbHNlIHsKICAgIC8vIEZvciBub24tdHJpcGxpY2F0ZSB3ZWxscywgY2hlY2sgaWYgdGhpcyBzcGVjaWZpYyB3ZWxsIGlzIHNlbGVjdGVkIChvbmx5IGluIGN1cnJlbnQgc2NpZW50aXN0J3MgZ3JpZCkKICAgIGNvbnN0IG5vcm1hbGl6ZWRXZWxsSWQgPSBub3JtYWxpemVXZWxsSWQod2VsbElkKTsKICAgIHBsYXRlSWRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7bm9ybWFsaXplZFdlbGxJZH1gOwogICAgICBpZiAoc2VsZWN0ZWRXZWxscy5oYXMoa2V5KSkgewogICAgICAgIGlzR3JvdXBTZWxlY3RlZCA9IHRydWU7CiAgICAgIH0KICAgIH0pOwogIH0KICAKICAvLyBUb2dnbGUgc2VsZWN0aW9uOiBpZiBncm91cC93ZWxsIGlzIHNlbGVjdGVkLCByZW1vdmUgYWxsOyBvdGhlcndpc2UgYWRkIGFsbAogIC8vIE9ubHkgb3BlcmF0ZSBvbiBwbGF0ZUlkcyAoY3VycmVudCBzY2llbnRpc3QncyBncmlkKQogIGlmICh0cmlwbGljYXRlR3JvdXApIHsKICAgIC8vIEdldCByb3cgbGV0dGVycyBmcm9tIHRoZSB0cmlwbGljYXRlIGdyb3VwIHBhdHRlcm4KICAgIGNvbnN0IGdyb3VwUm93TGV0dGVycyA9IGdldFJvd0xldHRlcnNGcm9tV2VsbHModHJpcGxpY2F0ZUdyb3VwLndlbGxzKTsKICAgIAogICAgLy8gVG9nZ2xlIGFsbCB3ZWxscyBpbiB0aGUgdHJpcGxpY2F0ZSBncm91cCAoc2FtZSByb3cgcGF0dGVybiwgc2FtZSBjb2x1bW4pIGFjcm9zcyBwbGF0ZUlkcyBvbmx5CiAgICBwbGF0ZUlkcy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgICAgZ3JvdXBSb3dMZXR0ZXJzLmZvckVhY2gocm93TGV0dGVyID0+IHsKICAgICAgICBjb25zdCB3SWQgPSByb3dMZXR0ZXIgKyBjb2x1bW47CiAgICAgICAgY29uc3Qgbm9ybWFsaXplZFdJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3SWQpOwogICAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7bm9ybWFsaXplZFdJZH1gOwogICAgICAgIGNvbnN0IGhhc0RhdGEgPSB3ZWxsc1tub3JtYWxpemVkV0lkXSB8fCB3ZWxsc1t3SWRdOwogICAgICAgIGlmIChoYXNEYXRhKSB7CiAgICAgICAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZFdlbGxzIGlmIGFueSBhcmUgc2V0CiAgICAgICAgICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdJZCkgJiYgIWVuYWJsZWRXZWxscy5oYXMobm9ybWFsaXplZFdJZCkpIHsKICAgICAgICAgICAgcmV0dXJuOyAvLyBTa2lwIGV4Y2x1ZGVkIHdlbGxzCiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNHcm91cFNlbGVjdGVkKSB7CiAgICAgICAgICAgIHNlbGVjdGVkV2VsbHMuZGVsZXRlKGtleSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxlY3RlZFdlbGxzLmFkZChrZXkpOwogICAgICAgICAgfQogICAgICAgICAgYW55Q2hhbmdlZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH0gZWxzZSB7CiAgICAvLyBUb2dnbGUgaW5kaXZpZHVhbCB3ZWxsIGFjcm9zcyBwbGF0ZUlkcyBvbmx5IChjdXJyZW50IHNjaWVudGlzdCdzIGdyaWQpCiAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgICBwbGF0ZUlkcy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgICAgY29uc3QgaGFzRGF0YSA9IHdlbGxzW25vcm1hbGl6ZWRXZWxsSWRdIHx8IHdlbGxzW3dlbGxJZF07CiAgICAgIGlmICghaGFzRGF0YSkgewogICAgICAgIHJldHVybjsgLy8gU2tpcCBpZiBubyBkYXRhCiAgICAgIH0KICAgICAgLy8gRmlsdGVyIGJ5IGVuYWJsZWRXZWxscyBpZiBhbnkgYXJlIHNldAogICAgICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCkgJiYgIWVuYWJsZWRXZWxscy5oYXMobm9ybWFsaXplZFdlbGxJZCkpIHsKICAgICAgICByZXR1cm47IC8vIFNraXAgZXhjbHVkZWQgd2VsbHMKICAgICAgfQogICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke25vcm1hbGl6ZWRXZWxsSWR9YDsKICAgICAgaWYgKGlzR3JvdXBTZWxlY3RlZCkgewogICAgICAgIHNlbGVjdGVkV2VsbHMuZGVsZXRlKGtleSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VsZWN0ZWRXZWxscy5hZGQoa2V5KTsKICAgICAgfQogICAgICBhbnlDaGFuZ2VkID0gdHJ1ZTsKICAgIH0pOwogIH0KICAKICBpZiAoYW55Q2hhbmdlZCkgewogICAgcmVuZGVyUGxhdGVHcmlkKCk7CiAgICB1cGRhdGVXZWxsSW5mbygpOwogIH0KfQoKZnVuY3Rpb24gY2xlYXJTZWxlY3Rpb24oKSB7CiAgc2VsZWN0ZWRXZWxscy5jbGVhcigpOwogIHJlbmRlclBsYXRlR3JpZCgpOwogIHVwZGF0ZUNoYXJ0KCk7Cn0KCmZ1bmN0aW9uIGdldENoYXJ0Q2FudmFzKCkgewogIHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgid2VsbC1jaGFydCIpOwp9CgpmdW5jdGlvbiBkYXRhVVJMdG9CbG9iKGRhdGFVUkwpIHsKICB2YXIgcGFydHMgPSBkYXRhVVJMLnNwbGl0KCIsIik7CiAgdmFyIG1pbWUgPSAocGFydHNbMF0ubWF0Y2goLzooLio/KTsvKSB8fCBbXSlbMV0gfHwgImltYWdlL3BuZyI7CiAgdmFyIGJzdHIgPSBhdG9iKHBhcnRzWzFdKTsKICB2YXIgbiA9IGJzdHIubGVuZ3RoOwogIHZhciB1OCA9IG5ldyBVaW50OEFycmF5KG4pOwogIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgaSsrKSB1OFtpXSA9IGJzdHIuY2hhckNvZGVBdChpKTsKICByZXR1cm4gbmV3IEJsb2IoW3U4XSwgeyB0eXBlOiBtaW1lIH0pOwp9CgpmdW5jdGlvbiBkb0Rvd25sb2FkQ2hhcnRBc0ltYWdlKCkgewogIHZhciBjYW52YXMgPSBnZXRDaGFydENhbnZhcygpOwogIGlmICghY2FudmFzIHx8ICFjaGFydCkgcmV0dXJuIGZhbHNlOwogIHZhciBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwogIHZhciBub3cgPSBuZXcgRGF0ZSgpOwogIHZhciBwYWQgPSBmdW5jdGlvbihuKSB7IHJldHVybiBTdHJpbmcobikucGFkU3RhcnQoMiwgIjAiKTsgfTsKICB2YXIgc3RhbXAgPSBub3cuZ2V0RnVsbFllYXIoKSArICItIiArIHBhZChub3cuZ2V0TW9udGgoKSArIDEpICsgIi0iICsgcGFkKG5vdy5nZXREYXRlKCkpICsgIi0iICsgcGFkKG5vdy5nZXRIb3VycygpKSArIHBhZChub3cuZ2V0TWludXRlcygpKSArIHBhZChub3cuZ2V0U2Vjb25kcygpKTsKICBhLmRvd25sb2FkID0gInBsYXRlLXZpZXdlci1jaGFydC0iICsgc3RhbXAgKyAiLnBuZyI7CiAgYS5ocmVmID0gY2FudmFzLnRvRGF0YVVSTCgiaW1hZ2UvcG5nIik7CiAgYS5jbGljaygpOwogIHJldHVybiB0cnVlOwp9CgpmdW5jdGlvbiBjb3B5Q2hhcnRBc0ltYWdlKCkgewogIHZhciBjYW52YXMgPSBnZXRDaGFydENhbnZhcygpOwogIGlmICghY2FudmFzIHx8ICFjaGFydCkgcmV0dXJuOwogIHZhciBibG9iID0gZGF0YVVSTHRvQmxvYihjYW52YXMudG9EYXRhVVJMKCJpbWFnZS9wbmciKSk7CiAgaWYgKG5hdmlnYXRvci5jbGlwYm9hcmQgJiYgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZSkgewogICAgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZShbbmV3IENsaXBib2FyZEl0ZW0oeyAiaW1hZ2UvcG5nIjogYmxvYiB9KV0pCiAgICAgIC5jYXRjaChmdW5jdGlvbigpIHsgY29weUNoYXJ0RmFsbGJhY2soYmxvYik7IH0pOwogICAgcmV0dXJuOwogIH0KICBjb3B5Q2hhcnRGYWxsYmFjayhibG9iKTsKfQoKZnVuY3Rpb24gY29weUNoYXJ0RmFsbGJhY2soYmxvYikgewogIHZhciBmaWxlID0gbmV3IEZpbGUoW2Jsb2JdLCAiY2hhcnQucG5nIiwgeyB0eXBlOiAiaW1hZ2UvcG5nIiB9KTsKICB2YXIgb25Db3B5ID0gZnVuY3Rpb24oZSkgewogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgZS5jbGlwYm9hcmREYXRhLml0ZW1zLmFkZChmaWxlLCAiaW1hZ2UvcG5nIik7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJjb3B5Iiwgb25Db3B5KTsKICB9OwogIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNvcHkiLCBvbkNvcHkpOwogIHZhciBzZWwgPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7CiAgdmFyIHJhbmdlID0gZG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgZGl2LnN0eWxlLnNldFByb3BlcnR5KCJwb3NpdGlvbiIsICJhYnNvbHV0ZSIpOwogIGRpdi5zdHlsZS5zZXRQcm9wZXJ0eSgibGVmdCIsICItOTk5OXB4Iik7CiAgZGl2LnRleHRDb250ZW50ID0gIiAiOwogIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZGl2KTsKICByYW5nZS5zZWxlY3ROb2RlQ29udGVudHMoZGl2KTsKICBzZWwucmVtb3ZlQWxsUmFuZ2VzKCk7CiAgc2VsLmFkZFJhbmdlKHJhbmdlKTsKICB2YXIgb2sgPSBmYWxzZTsKICB0cnkgewogICAgb2sgPSBkb2N1bWVudC5leGVjQ29tbWFuZCgiY29weSIpOwogIH0gY2F0Y2ggKGVycikgewogICAgY29uc29sZS5lcnJvcihlcnIpOwogIH0KICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGRpdik7CiAgc2VsLnJlbW92ZUFsbFJhbmdlcygpOwogIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoImNvcHkiLCBvbkNvcHkpOwogIGlmICghb2spIGRvRG93bmxvYWRDaGFydEFzSW1hZ2UoKTsKfQoKZnVuY3Rpb24gZG93bmxvYWRDaGFydEFzSW1hZ2UoKSB7CiAgZG9Eb3dubG9hZENoYXJ0QXNJbWFnZSgpOwp9CgpmdW5jdGlvbiB1cGRhdGVXZWxsSW5mbygpIHsKICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ3ZWxsLWluZm8iKTsKICBpZiAoc2VsZWN0ZWRXZWxscy5zaXplID09PSAwKSB7CiAgICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogICAgY29uc3QgZGF0YXNldENvdW50ID0gc2VsZWN0ZWREYXRhc2V0cy5sZW5ndGg7CiAgICBpZiAoZGF0YXNldENvdW50ID4gMSkgewogICAgICBlbC50ZXh0Q29udGVudCA9IGBTZWxlY3RlZCBncm91cCB3aXRoICR7ZGF0YXNldENvdW50fSBkYXRhc2V0cy4gQ2xpY2sgd2VsbHMgb24gdGhlIHBsYXRlIHRvIGFkZCB0aGVtIHRvIHRoZSBjaGFydC5gOwogICAgfSBlbHNlIHsKICAgICAgZWwudGV4dENvbnRlbnQgPSAiQ2xpY2sgd2VsbHMgb24gdGhlIHBsYXRlIHRvIGFkZCB0aGVtIHRvIHRoZSBjaGFydC4iOwogICAgfQogICAgcmV0dXJuOwogIH0KICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogIGNvbnN0IGRhdGFzZXRDb3VudCA9IHNlbGVjdGVkRGF0YXNldHMubGVuZ3RoOwogIGNvbnN0IHVuaXF1ZVdlbGxzID0gbmV3IFNldChBcnJheS5mcm9tKHNlbGVjdGVkV2VsbHMpLm1hcChrZXkgPT4ga2V5LnNwbGl0KCI6IilbMV0pKTsKICBjb25zdCB3ZWxsQ291bnQgPSB1bmlxdWVXZWxscy5zaXplOwogIGlmIChkYXRhc2V0Q291bnQgPiAxKSB7CiAgICBlbC50ZXh0Q29udGVudCA9IGAke3dlbGxDb3VudH0gd2VsbChzKSBzZWxlY3RlZCBhY3Jvc3MgJHtkYXRhc2V0Q291bnR9IGRhdGFzZXRzLiBDbGljayAiVXBkYXRlIENoYXJ0IiB0byBkaXNwbGF5LmA7CiAgfSBlbHNlIHsKICAgIGVsLnRleHRDb250ZW50ID0gYCR7d2VsbENvdW50fSB3ZWxsKHMpIHNlbGVjdGVkLiBDbGljayAiVXBkYXRlIENoYXJ0IiB0byBkaXNwbGF5LmA7CiAgfQp9CgpmdW5jdGlvbiBpc0NvbnRyb2xXZWxsKHdlbGxJZCkgewogIC8vIENvbnRyb2wgd2VsbHMgYXJlIGNvbmZpZ3VyYWJsZSB2aWEgY29udHJvbF9yb3dzIGluIGNvbmZpZyAoZGVmYXVsdDogWyJOIiwgIk8iXSkKICBjb25zdCBjb25maWcgPSB2aWV3ZXJEYXRhLmNvbmZpZyB8fCB7fTsKICBjb25zdCBjb250cm9sUm93cyA9IGNvbmZpZy5jb250cm9sX3Jvd3MgfHwgWyJOIiwgIk8iXTsKICBjb25zdCByb3dMZXR0ZXIgPSB3ZWxsSWQucmVwbGFjZSgvWzAtOV0vZywgJycpOwogIHJldHVybiBjb250cm9sUm93cy5pbmNsdWRlcyhyb3dMZXR0ZXIpOwp9CgpmdW5jdGlvbiBmb3JtYXRMYWJlbChsYWJlbCkgewogIC8vIEZvcm1hdCBsYWJlbHM6IHJlbW92ZSAidU0iIGFuZCBjb252ZXJ0IHRvICJudW1iZXItbnVtYmVyLW51bWJlciIgZm9ybWF0CiAgLy8gRXhhbXBsZXM6ICIyNTAgdU0gMTAtMiIgLT4gIjI1MC0xMC0yIiwgIjUwMCB1TSA1LTIiIC0+ICI1MDAtNS0yIgogIGlmICghbGFiZWwpIHJldHVybiBsYWJlbDsKICAKICAvLyBSZW1vdmUgInVNIiAoY2FzZSBpbnNlbnNpdGl2ZSkgYW5kIGV4dHJhIHNwYWNlcwogIGxldCBmb3JtYXR0ZWQgPSBsYWJlbC5yZXBsYWNlKC9ccyp1TVxzKi9naSwgJyAnKS5yZXBsYWNlKC9ccysvZywgJyAnKS50cmltKCk7CiAgCiAgLy8gRXh0cmFjdCBudW1iZXJzIGFuZCBoeXBoZW5zLCByZXBsYWNlIHNwYWNlcyB3aXRoIGh5cGhlbnMKICAvLyBNYXRjaCBwYXR0ZXJuOiBudW1iZXIocykgZm9sbG93ZWQgYnkgb3B0aW9uYWwgc3BhY2UvaHlwaGVuIGFuZCBtb3JlIG51bWJlcnMKICBmb3JtYXR0ZWQgPSBmb3JtYXR0ZWQucmVwbGFjZSgvKFxkKylccyotXHMqKFxkKykvZywgJyQxLSQyJyk7IC8vIEhhbmRsZSBleGlzdGluZyBoeXBoZW5zCiAgZm9ybWF0dGVkID0gZm9ybWF0dGVkLnJlcGxhY2UoLyhcZCspXHMrKFxkKykvZywgJyQxLSQyJyk7IC8vIFJlcGxhY2Ugc3BhY2VzIGJldHdlZW4gbnVtYmVycyB3aXRoIGh5cGhlbnMKICAKICByZXR1cm4gZm9ybWF0dGVkOwp9CgpmdW5jdGlvbiBnZXRSb3dMZXR0ZXIod2VsbElkKSB7CiAgLy8gRXh0cmFjdCByb3cgbGV0dGVyIGZyb20gd2VsbCBJRCAoZS5nLiwgIkIxMyIgLT4gIkIiKQogIHJldHVybiB3ZWxsSWQucmVwbGFjZSgvWzAtOV0vZywgJycpOwp9CgpmdW5jdGlvbiBnZXRUcmlwbGljYXRlR3JvdXAod2VsbElkLCBjb2x1bW4pIHsKICAvLyBDb250cm9sIHdlbGxzIHNob3VsZCBuZXZlciBiZSBwYXJ0IG9mIGdyb3VwcwogIGlmIChpc0NvbnRyb2xXZWxsKHdlbGxJZCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICAKICBjb25zdCBjb25maWcgPSB2aWV3ZXJEYXRhLmNvbmZpZyB8fCB7fTsKICBjb25zdCBncm91cHMgPSBjb25maWcuZ3JvdXBzIHx8IFtdOwogIGNvbnN0IHJvd0xldHRlciA9IGdldFJvd0xldHRlcih3ZWxsSWQpOwogIAogIC8vIEZpbmQgZ3JvdXAgdGhhdCBtYXRjaGVzIHRoZSByb3cgcGF0dGVybiAoQkNELCBFRkcsIGV0Yy4pIC0gYXBwbGllcyB0byBhbGwgY29sdW1ucwogIHJldHVybiBncm91cHMuZmluZChncm91cCA9PiB7CiAgICBpZiAoIWdyb3VwLndlbGxzIHx8IGdyb3VwLndlbGxzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAKICAgIC8vIEV4dHJhY3Qgcm93IGxldHRlcnMgZnJvbSB0aGUgZ3JvdXAncyB3ZWxscwogICAgY29uc3QgZ3JvdXBSb3dMZXR0ZXJzID0gZ2V0Um93TGV0dGVyc0Zyb21XZWxscyhncm91cC53ZWxscyk7CiAgICAKICAgIC8vIENoZWNrIGlmIHRoaXMgd2VsbCdzIHJvdyBsZXR0ZXIgbWF0Y2hlcyBhbnkgcm93IGluIHRoZSBncm91cCBwYXR0ZXJuCiAgICAvLyBHcm91cHMgYXBwbHkgdG8gYWxsIGNvbHVtbnMsIHNvIG5vIGNvbHVtbiBjaGVjayBuZWVkZWQKICAgIHJldHVybiBncm91cFJvd0xldHRlcnMuaW5jbHVkZXMocm93TGV0dGVyKTsKICB9KTsKfQoKZnVuY3Rpb24gbm9ybWFsaXplV2VsbElkKHdlbGxJZCkgewogIC8vIE5vcm1hbGl6ZSB3ZWxsIElEIHRvIGNvbnNpc3RlbnQgZm9ybWF0OiB1cHBlcmNhc2Ugd2l0aCB6ZXJvLXBhZGRlZCBjb2x1bW4gKGUuZy4sICJCNSIgLT4gIkIwNSIsICJCMTMiIC0+ICJCMTMiKQogIGNvbnN0IG1hdGNoID0gU3RyaW5nKHdlbGxJZCkudHJpbSgpLnRvVXBwZXJDYXNlKCkubWF0Y2goL14oW0EtWl0pKFxkKykkLyk7CiAgaWYgKG1hdGNoKSB7CiAgICBjb25zdCByb3cgPSBtYXRjaFsxXTsKICAgIGNvbnN0IGNvbCA9IHBhcnNlSW50KG1hdGNoWzJdKTsKICAgIHJldHVybiByb3cgKyBTdHJpbmcoY29sKS5wYWRTdGFydCgyLCAnMCcpOwogIH0KICByZXR1cm4gU3RyaW5nKHdlbGxJZCkudHJpbSgpLnRvVXBwZXJDYXNlKCk7Cn0KCmZ1bmN0aW9uIGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKSB7CiAgLy8gRXh0cmFjdCBjb2x1bW4gbnVtYmVyIGZyb20gd2VsbCBJRCAoZS5nLiwgIkIxMyIgLT4gMTMpCiAgcmV0dXJuIHBhcnNlSW50KHdlbGxJZC5yZXBsYWNlKC9bQS1aXS9nLCAnJykpOwp9CgpmdW5jdGlvbiBnZXRSb3dMZXR0ZXJzRnJvbVdlbGxzKHdlbGxzKSB7CiAgLy8gRXh0cmFjdCByb3cgbGV0dGVycyBmcm9tIHdlbGxzIGFycmF5CiAgLy8gV2VsbHMgY2FuIGJlIGVpdGhlciByb3cgbGV0dGVycyAoZS5nLiwgWyJCIiwgIkMiLCAiRCJdKSBvciBmdWxsIHdlbGwgSURzIChlLmcuLCBbIkIxMyIsICJDMTMiLCAiRDEzIl0pCiAgcmV0dXJuIHdlbGxzLm1hcCh3ID0+IHsKICAgIC8vIElmIGl0J3MgYSBmdWxsIHdlbGwgSUQsIGV4dHJhY3Qgcm93IGxldHRlcjsgb3RoZXJ3aXNlIGFzc3VtZSBpdCdzIGFscmVhZHkgYSByb3cgbGV0dGVyCiAgICBpZiAody5sZW5ndGggPiAxICYmIC9eW0EtWl0vLnRlc3QodykgJiYgL1swLTldLy50ZXN0KHcpKSB7CiAgICAgIHJldHVybiBnZXRSb3dMZXR0ZXIodyk7CiAgICB9CiAgICByZXR1cm4gdzsgLy8gQWxyZWFkeSBhIHJvdyBsZXR0ZXIKICB9KTsKfQoKLy8gQ29sb3IgcGFsZXR0ZSBmb3IgdHJpcGxpY2F0ZSBncm91cHMgLSBlYWNoIGdyb3VwIGdldHMgYSBkaXN0aW5jdCBjb2xvcgpjb25zdCBUUklQTElDQVRFX0NPTE9SUyA9IFsKICB7IGJvcmRlcjogIiNmZjZiNmIiLCBiZzogIiNmZmUwZTAiLCBiZ1NlbGVjdGVkOiAiI2ZmY2NjYyIsIGJnSGFzRGF0YTogIiNmZmU4ZTgiIH0sIC8vIFJlZAogIHsgYm9yZGVyOiAiIzRlY2RjNCIsIGJnOiAiI2UwZjdmNSIsIGJnU2VsZWN0ZWQ6ICIjY2NmMGVkIiwgYmdIYXNEYXRhOiAiI2U4ZjlmNyIgfSwgLy8gVGVhbAogIHsgYm9yZGVyOiAiIzQ1YjdkMSIsIGJnOiAiI2UwZjJmNyIsIGJnU2VsZWN0ZWQ6ICIjY2NlOGYwIiwgYmdIYXNEYXRhOiAiI2U4ZjVmYSIgfSwgLy8gQmx1ZQogIHsgYm9yZGVyOiAiI2Y5Y2EyNCIsIGJnOiAiI2ZmZjllMCIsIGJnU2VsZWN0ZWQ6ICIjZmZmM2NjIiwgYmdIYXNEYXRhOiAiI2ZmZmJlOCIgfSwgLy8gWWVsbG93CiAgeyBib3JkZXI6ICIjNmM1Y2U3IiwgYmc6ICIjZWRlYWY3IiwgYmdTZWxlY3RlZDogIiNkZGQ0ZjAiLCBiZ0hhc0RhdGE6ICIjZjBlY2Y5IiB9LCAvLyBQdXJwbGUKICB7IGJvcmRlcjogIiNhMjliZmUiLCBiZzogIiNlZGVhZjciLCBiZ1NlbGVjdGVkOiAiI2RkZDRmMCIsIGJnSGFzRGF0YTogIiNmMGVjZjkiIH0sIC8vIExpZ2h0IFB1cnBsZQogIHsgYm9yZGVyOiAiI2ZkNzlhOCIsIGJnOiAiI2ZmZTBlZCIsIGJnU2VsZWN0ZWQ6ICIjZmZjY2UwIiwgYmdIYXNEYXRhOiAiI2ZmZThmMCIgfSwgLy8gUGluawogIHsgYm9yZGVyOiAiIzAwYjg5NCIsIGJnOiAiI2UwZjVmMCIsIGJnU2VsZWN0ZWQ6ICIjY2NlZGU1IiwgYmdIYXNEYXRhOiAiI2U4ZjdmMiIgfSwgLy8gR3JlZW4KICB7IGJvcmRlcjogIiNlMTcwNTUiLCBiZzogIiNmZmUwZDkiLCBiZ1NlbGVjdGVkOiAiI2ZmY2NiYiIsIGJnSGFzRGF0YTogIiNmZmU4ZTAiIH0sIC8vIE9yYW5nZQogIHsgYm9yZGVyOiAiIzc0YjlmZiIsIGJnOiAiI2UwZjBmZiIsIGJnU2VsZWN0ZWQ6ICIjY2NlMGZmIiwgYmdIYXNEYXRhOiAiI2U4ZjVmZiIgfSwgLy8gTGlnaHQgQmx1ZQogIHsgYm9yZGVyOiAiIzU1ZWZjNCIsIGJnOiAiI2UwZmFmNSIsIGJnU2VsZWN0ZWQ6ICIjY2NmNWViIiwgYmdIYXNEYXRhOiAiI2U4ZmJmNyIgfSwgLy8gTWludAogIHsgYm9yZGVyOiAiI2ZkY2I2ZSIsIGJnOiAiI2ZmZjVlMCIsIGJnU2VsZWN0ZWQ6ICIjZmZlYmNjIiwgYmdIYXNEYXRhOiAiI2ZmZjhlOCIgfSAgLy8gTGlnaHQgT3JhbmdlCl07CgovLyBNYXAgdHJpcGxpY2F0ZSBncm91cCBuYW1lcyB0byBjb2xvcnMgKGNvbnNpc3RlbnQgYWNyb3NzIHRoZSBhcHApCmxldCB0cmlwbGljYXRlR3JvdXBDb2xvck1hcCA9IHt9OwoKZnVuY3Rpb24gZ2V0VHJpcGxpY2F0ZUdyb3VwQ29sb3IoZ3JvdXBOYW1lKSB7CiAgaWYgKCFncm91cE5hbWUpIHJldHVybiBudWxsOwogIAogIC8vIEVuc3VyZSBjb2xvciBtYXAgaXMgaW5pdGlhbGl6ZWQKICBpbml0aWFsaXplVHJpcGxpY2F0ZUdyb3VwQ29sb3JzKCk7CiAgCiAgLy8gTm9ybWFsaXplIGdyb3VwIG5hbWUgdG8gZW5zdXJlIGNvbnNpc3RlbnQgbG9va3VwCiAgY29uc3Qgbm9ybWFsaXplZE5hbWUgPSBTdHJpbmcoZ3JvdXBOYW1lKS50cmltKCk7CiAgCiAgLy8gUmV0dXJuIHRoZSBjb2xvciBmb3IgdGhpcyBncm91cCBuYW1lIChzYW1lIGNvbG9yIGZvciBhbGwgd2VsbHMgaW4gdGhlIGdyb3VwKQogIC8vIEFsbCB3ZWxscyB3aXRoIHRoZSBzYW1lIGdyb3VwIG5hbWUgd2lsbCBnZXQgdGhlIHNhbWUgY29sb3IKICAvLyBGb3IgZXhhbXBsZSwgYWxsIHdlbGxzIGluIHJvd3MgQiwgQywgRCB3aXRoIGdyb3VwICIyNTAtMTAtMiIgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgcmV0dXJuIHRyaXBsaWNhdGVHcm91cENvbG9yTWFwW25vcm1hbGl6ZWROYW1lXSB8fCBUUklQTElDQVRFX0NPTE9SU1swXTsKfQoKZnVuY3Rpb24gaXNEdXBsaWNhdGVXZWxsKHdlbGxJZCkgewogIC8vIENoZWNrIGlmIHRoaXMgd2VsbCdzIGNvbHVtbiBpcyBpbiB0aGUgZHVwbGljYXRlIHdhcm5pbmdzCiAgaWYgKCF2aWV3ZXJEYXRhIHx8ICF2aWV3ZXJEYXRhLmNvbmZpZyB8fCAhdmlld2VyRGF0YS5jb25maWcud2FybmluZ3MpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogIGNvbnN0IHdhcm5pbmdzID0gdmlld2VyRGF0YS5jb25maWcud2FybmluZ3MuZHVwbGljYXRlX2NvbHVtbnMgfHwgW107CiAgcmV0dXJuIHdhcm5pbmdzLnNvbWUod2FybmluZyA9PiB7CiAgICBjb25zdCBjb2x1bW5zID0gd2FybmluZy5jb2x1bW5zIHx8IFtdOwogICAgcmV0dXJuIGNvbHVtbnMuaW5jbHVkZXMoY29sdW1uKTsKICB9KTsKfQoKZnVuY3Rpb24gZ2V0RHVwbGljYXRlRmlsZXMod2VsbElkKSB7CiAgLy8gR2V0IHRoZSBsaXN0IG9mIGZpbGVzIHRoYXQgaGF2ZSB0aGlzIGR1cGxpY2F0ZSB3ZWxsJ3MgY29sdW1uCiAgaWYgKCF2aWV3ZXJEYXRhIHx8ICF2aWV3ZXJEYXRhLmNvbmZpZyB8fCAhdmlld2VyRGF0YS5jb25maWcud2FybmluZ3MpIHsKICAgIHJldHVybiBbXTsKICB9CiAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogIGNvbnN0IHdhcm5pbmdzID0gdmlld2VyRGF0YS5jb25maWcud2FybmluZ3MuZHVwbGljYXRlX2NvbHVtbnMgfHwgW107CiAgZm9yIChjb25zdCB3YXJuaW5nIG9mIHdhcm5pbmdzKSB7CiAgICBjb25zdCBjb2x1bW5zID0gd2FybmluZy5jb2x1bW5zIHx8IFtdOwogICAgaWYgKGNvbHVtbnMuaW5jbHVkZXMoY29sdW1uKSkgewogICAgICByZXR1cm4gd2FybmluZy5maWxlcyB8fCBbXTsKICAgIH0KICB9CiAgcmV0dXJuIFtdOwp9CgpmdW5jdGlvbiBnZXRBbGxVbmlxdWVUaW1lUG9pbnRzKHdlbGxzKSB7CiAgLy8gQ29sbGVjdCBhbGwgdW5pcXVlIHRpbWUgcG9pbnRzIGZyb20gYWxsIHdlbGxzCiAgY29uc3QgYWxsVGltZVBvaW50cyA9IG5ldyBTZXQoKTsKICB3ZWxscy5mb3JFYWNoKHdlbGwgPT4gewogICAgaWYgKHdlbGwudGltZV9zKSB7CiAgICAgIHdlbGwudGltZV9zLmZvckVhY2godCA9PiB7CiAgICAgICAgaWYgKHQgIT09IG51bGwgJiYgdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBhbGxUaW1lUG9pbnRzLmFkZCh0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0pOwogIHJldHVybiBBcnJheS5mcm9tKGFsbFRpbWVQb2ludHMpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKfQoKZnVuY3Rpb24gY2FsY3VsYXRlTWVhbkFuZEVycm9yKHdlbGxzLCB0aW1lUG9pbnRzKSB7CiAgLy8gQ2FsY3VsYXRlIG1lYW4gYW5kIHN0YW5kYXJkIGVycm9yIGZvciB0cmlwbGljYXRlcyBhdCBlYWNoIHRpbWUgcG9pbnQKICBjb25zdCBtZWFucyA9IFtdOwogIGNvbnN0IGVycm9ycyA9IFtdOwogIAogIHRpbWVQb2ludHMuZm9yRWFjaCgodGltZSwgaWR4KSA9PiB7CiAgICBjb25zdCB2YWx1ZXMgPSB3ZWxscy5tYXAodyA9PiB7CiAgICAgIGNvbnN0IHRpbWVJZHggPSB3LnRpbWVfcy5pbmRleE9mKHRpbWUpOwogICAgICByZXR1cm4gdGltZUlkeCA+PSAwID8gdy52YWx1ZXNbdGltZUlkeF0gOiBudWxsOwogICAgfSkuZmlsdGVyKHYgPT4gdiAhPT0gbnVsbCk7CiAgICAKICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIG1lYW5zLnB1c2gobnVsbCk7CiAgICAgIGVycm9ycy5wdXNoKG51bGwpOwogICAgICByZXR1cm47CiAgICB9CiAgICAKICAgIGNvbnN0IG1lYW4gPSB2YWx1ZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyB2YWx1ZXMubGVuZ3RoOwogICAgLy8gVXNlIHNhbXBsZSB2YXJpYW5jZSAoZGl2aWRlIGJ5IG4tMSkgZm9yIHByb3BlciBTRU0gY2FsY3VsYXRpb24KICAgIGNvbnN0IG4gPSB2YWx1ZXMubGVuZ3RoOwogICAgY29uc3QgdmFyaWFuY2UgPSBuID4gMSAKICAgICAgPyB2YWx1ZXMucmVkdWNlKChzdW0sIHZhbCkgPT4gc3VtICsgTWF0aC5wb3codmFsIC0gbWVhbiwgMiksIDApIC8gKG4gLSAxKQogICAgICA6IDA7CiAgICBjb25zdCBzdGREZXYgPSBNYXRoLnNxcnQodmFyaWFuY2UpOwogICAgY29uc3Qgc3RkRXJyb3IgPSBzdGREZXYgLyBNYXRoLnNxcnQobik7CiAgICAKICAgIG1lYW5zLnB1c2gobWVhbik7CiAgICBlcnJvcnMucHVzaChzdGRFcnJvcik7CiAgfSk7CiAgCiAgcmV0dXJuIHsgbWVhbnMsIGVycm9ycyB9Owp9CgpmdW5jdGlvbiBwcm9jZXNzV2VsbHNBbmRDYWxjdWxhdGVNZWFuKHdlbGxzLCBpc05vcm1hbGl6ZWQgPSBmYWxzZSwgYmFzZWxpbmVFbmRUaW1lID0gMjQsIGN1dG9mZlRpbWUgPSAzNjApIHsKICAvLyBXT1JLRkxPVzogQWx3YXlzIHByb2Nlc3MgZWFjaCB3ZWxsIGluZGl2aWR1YWxseSBmaXJzdCwgdGhlbiBhdmVyYWdlCiAgLy8gSWYgbm9ybWFsaXplZDogbm9ybWFsaXplIGVhY2ggd2VsbCB0byBpdHMgT1dOIGJhc2VsaW5lIGZpcnN0LCB0aGVuIGNhbGN1bGF0ZSBtZWFuIGFuZCBlcnJvcgogIC8vIElmIG5vdCBub3JtYWxpemVkOiBwcm9jZXNzIGVhY2ggd2VsbCBpbmRpdmlkdWFsbHkgKG5vIG5vcm1hbGl6YXRpb24pLCB0aGVuIGNhbGN1bGF0ZSBtZWFuIGFuZCBlcnJvcgogIC8vIFRoaXMgZW5zdXJlcyBjb3JyZWN0IG5vcm1hbGl6YXRpb24gZXZlbiB3aGVuIGNvbWJpbmluZyB3ZWxscyBmcm9tIGRpZmZlcmVudCBjb2x1bW5zIHdpdGggZGlmZmVyZW50IGJhc2VsaW5lcwogIC8vIFJldHVybnMgeyBmaWx0ZXJlZFRpbWVQb2ludHMsIG1lYW5zLCBlcnJvcnMsIG9yaWdpbmFsTWVhbnMgfQogIAogIC8vIFN0ZXAgMTogUHJvY2VzcyBlYWNoIHdlbGwgaW5kaXZpZHVhbGx5IChub3JtYWxpemUgaWYgZW5hYmxlZCwgb3RoZXJ3aXNlIHVzZSByYXcgZGF0YSkKICBjb25zdCBwcm9jZXNzZWRXZWxscyA9IHdlbGxzLm1hcCh3ZWxsID0+IHsKICAgIGNvbnN0IGZpbHRlcmVkVGltZVBvaW50cyA9IFtdOwogICAgY29uc3QgcHJvY2Vzc2VkVmFsdWVzID0gW107CiAgICBjb25zdCBvcmlnaW5hbFZhbHVlcyA9IFtdOwogICAgCiAgICBpZiAoIXdlbGwudGltZV9zIHx8ICF3ZWxsLnZhbHVlcykgewogICAgICByZXR1cm4geyB0aW1lUG9pbnRzOiBbXSwgdmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgICB9CiAgICAKICAgIGlmIChpc05vcm1hbGl6ZWQpIHsKICAgICAgLy8gTm9ybWFsaXplIHRoaXMgd2VsbCBieSBpdHMgb3duIGJhc2VsaW5lCiAgICAgIGNvbnN0IGJhc2VsaW5lVmFsdWVzID0gW107CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbC50aW1lX3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB0aW1lID0gd2VsbC50aW1lX3NbaV07CiAgICAgICAgY29uc3QgdmFsID0gd2VsbC52YWx1ZXNbaV07CiAgICAgICAgaWYgKHRpbWUgIT09IG51bGwgJiYgdmFsICE9PSBudWxsICYmIHRpbWUgPD0gYmFzZWxpbmVFbmRUaW1lKSB7CiAgICAgICAgICBiYXNlbGluZVZhbHVlcy5wdXNoKHZhbCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIAogICAgICBpZiAoYmFzZWxpbmVWYWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgLy8gTm8gYmFzZWxpbmUgZGF0YSBmb3IgdGhpcyB3ZWxsLCBza2lwIGl0CiAgICAgICAgcmV0dXJuIHsgdGltZVBvaW50czogW10sIHZhbHVlczogW10sIG9yaWdpbmFsVmFsdWVzOiBbXSB9OwogICAgICB9CiAgICAgIAogICAgICBjb25zdCB3ZWxsQmFzZWxpbmUgPSBiYXNlbGluZVZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIGJhc2VsaW5lVmFsdWVzLmxlbmd0aDsKICAgICAgCiAgICAgIGlmICh3ZWxsQmFzZWxpbmUgPT09IDAgfHwgIWlzRmluaXRlKHdlbGxCYXNlbGluZSkpIHsKICAgICAgICAvLyBJbnZhbGlkIGJhc2VsaW5lIGZvciB0aGlzIHdlbGwsIHNraXAgaXQKICAgICAgICByZXR1cm4geyB0aW1lUG9pbnRzOiBbXSwgdmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgICAgIH0KICAgICAgCiAgICAgIC8vIE5vcm1hbGl6ZSBhbmQgZmlsdGVyOiBvbmx5IGluY2x1ZGUgcG9pbnRzIGFmdGVyIGJhc2VsaW5lRW5kVGltZSBhbmQgdXAgdG8gY3V0b2ZmVGltZQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdlbGwudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgdGltZSA9IHdlbGwudGltZV9zW2ldOwogICAgICAgIGNvbnN0IHZhbCA9IHdlbGwudmFsdWVzW2ldOwogICAgICAgIAogICAgICAgIGlmICh0aW1lID09PSBudWxsIHx8IHZhbCA9PT0gbnVsbCkgY29udGludWU7CiAgICAgICAgCiAgICAgICAgLy8gT25seSBpbmNsdWRlIHBvaW50cyBhZnRlciBiYXNlbGluZUVuZFRpbWUgYW5kIHVwIHRvIGN1dG9mZlRpbWUKICAgICAgICBpZiAodGltZSA+IGJhc2VsaW5lRW5kVGltZSAmJiB0aW1lIDw9IGN1dG9mZlRpbWUpIHsKICAgICAgICAgIC8vIFN1YnRyYWN0IGJhc2VsaW5lRW5kVGltZSB0byBicmluZyBmaXJzdCBwb2ludCB0byB4PTAgKHRpbWUgYWZ0ZXIgaW5qZWN0aW9uKQogICAgICAgICAgZmlsdGVyZWRUaW1lUG9pbnRzLnB1c2godGltZSAtIGJhc2VsaW5lRW5kVGltZSk7CiAgICAgICAgICAvLyBEaXZpZGUgYnkgdGhpcyB3ZWxsJ3Mgb3duIGJhc2VsaW5lCiAgICAgICAgICBwcm9jZXNzZWRWYWx1ZXMucHVzaCh2YWwgLyB3ZWxsQmFzZWxpbmUpOwogICAgICAgICAgb3JpZ2luYWxWYWx1ZXMucHVzaCh2YWwpOyAvLyBTdG9yZSBvcmlnaW5hbCB2YWx1ZQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gTm90IG5vcm1hbGl6ZWQ6IHVzZSBhbGwgcmF3IGRhdGEgcG9pbnRzCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbC50aW1lX3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB0aW1lID0gd2VsbC50aW1lX3NbaV07CiAgICAgICAgY29uc3QgdmFsID0gd2VsbC52YWx1ZXNbaV07CiAgICAgICAgCiAgICAgICAgaWYgKHRpbWUgPT09IG51bGwgfHwgdmFsID09PSBudWxsKSBjb250aW51ZTsKICAgICAgICAKICAgICAgICBmaWx0ZXJlZFRpbWVQb2ludHMucHVzaCh0aW1lKTsKICAgICAgICBwcm9jZXNzZWRWYWx1ZXMucHVzaCh2YWwpOwogICAgICAgIG9yaWdpbmFsVmFsdWVzLnB1c2godmFsKTsgLy8gU3RvcmUgb3JpZ2luYWwgdmFsdWUgKHNhbWUgYXMgcHJvY2Vzc2VkIHdoZW4gbm90IG5vcm1hbGl6ZWQpCiAgICAgIH0KICAgIH0KICAgIAogICAgcmV0dXJuIHsgdGltZVBvaW50czogZmlsdGVyZWRUaW1lUG9pbnRzLCB2YWx1ZXM6IHByb2Nlc3NlZFZhbHVlcywgb3JpZ2luYWxWYWx1ZXM6IG9yaWdpbmFsVmFsdWVzIH07CiAgfSkuZmlsdGVyKHdlbGwgPT4gd2VsbC50aW1lUG9pbnRzLmxlbmd0aCA+IDApOyAvLyBGaWx0ZXIgb3V0IHdlbGxzIHdpdGggbm8gZGF0YQogIAogIC8vIFN0ZXAgMjogRmluZCBhbGwgdW5pcXVlIHRpbWUgcG9pbnRzIGFjcm9zcyBhbGwgcHJvY2Vzc2VkIHdlbGxzCiAgY29uc3QgYWxsVGltZVBvaW50cyA9IG5ldyBTZXQoKTsKICBwcm9jZXNzZWRXZWxscy5mb3JFYWNoKHdlbGwgPT4gewogICAgd2VsbC50aW1lUG9pbnRzLmZvckVhY2godCA9PiB7CiAgICAgIGlmICh0ICE9PSBudWxsKSBhbGxUaW1lUG9pbnRzLmFkZCh0KTsKICAgIH0pOwogIH0pOwogIAogIGNvbnN0IHNvcnRlZFRpbWVQb2ludHMgPSBBcnJheS5mcm9tKGFsbFRpbWVQb2ludHMpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKICAKICAvLyBTdGVwIDM6IENhbGN1bGF0ZSBtZWFuIGFuZCBlcnJvciBhdCBlYWNoIHRpbWUgcG9pbnQgZnJvbSBwcm9jZXNzZWQgdmFsdWVzCiAgLy8gQWxzbyB0cmFjayBvcmlnaW5hbCB2YWx1ZXMgZm9yIHRvb2x0aXAgZGlzcGxheQogIGNvbnN0IG1lYW5zID0gW107CiAgY29uc3QgZXJyb3JzID0gW107CiAgY29uc3Qgb3JpZ2luYWxNZWFucyA9IFtdOwogIAogIHNvcnRlZFRpbWVQb2ludHMuZm9yRWFjaCh0aW1lID0+IHsKICAgIGNvbnN0IHZhbHVlcyA9IFtdOwogICAgY29uc3Qgb3JpZ1ZhbHVlcyA9IFtdOwogICAgcHJvY2Vzc2VkV2VsbHMuZm9yRWFjaCh3ZWxsID0+IHsKICAgICAgY29uc3QgdGltZUlkeCA9IHdlbGwudGltZVBvaW50cy5pbmRleE9mKHRpbWUpOwogICAgICBpZiAodGltZUlkeCA+PSAwICYmIHdlbGwudmFsdWVzW3RpbWVJZHhdICE9PSBudWxsKSB7CiAgICAgICAgdmFsdWVzLnB1c2god2VsbC52YWx1ZXNbdGltZUlkeF0pOwogICAgICAgIGlmICh3ZWxsLm9yaWdpbmFsVmFsdWVzICYmIHdlbGwub3JpZ2luYWxWYWx1ZXNbdGltZUlkeF0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgb3JpZ1ZhbHVlcy5wdXNoKHdlbGwub3JpZ2luYWxWYWx1ZXNbdGltZUlkeF0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICAKICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIG1lYW5zLnB1c2gobnVsbCk7CiAgICAgIGVycm9ycy5wdXNoKG51bGwpOwogICAgICBvcmlnaW5hbE1lYW5zLnB1c2gobnVsbCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIAogICAgY29uc3QgbWVhbiA9IHZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIHZhbHVlcy5sZW5ndGg7CiAgICAvLyBVc2Ugc2FtcGxlIHZhcmlhbmNlIChkaXZpZGUgYnkgbi0xKSBmb3IgcHJvcGVyIFNFTSBjYWxjdWxhdGlvbgogICAgY29uc3QgbiA9IHZhbHVlcy5sZW5ndGg7CiAgICBjb25zdCB2YXJpYW5jZSA9IG4gPiAxIAogICAgICA/IHZhbHVlcy5yZWR1Y2UoKHN1bSwgdmFsKSA9PiBzdW0gKyBNYXRoLnBvdyh2YWwgLSBtZWFuLCAyKSwgMCkgLyAobiAtIDEpCiAgICAgIDogMDsKICAgIGNvbnN0IHN0ZERldiA9IE1hdGguc3FydCh2YXJpYW5jZSk7CiAgICBjb25zdCBzdGRFcnJvciA9IHN0ZERldiAvIE1hdGguc3FydChuKTsKICAgIAogICAgbWVhbnMucHVzaChtZWFuKTsKICAgIGVycm9ycy5wdXNoKHN0ZEVycm9yKTsKICAgIAogICAgLy8gQ2FsY3VsYXRlIG1lYW4gb2Ygb3JpZ2luYWwgdmFsdWVzCiAgICBpZiAob3JpZ1ZhbHVlcy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG9yaWdNZWFuID0gb3JpZ1ZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIG9yaWdWYWx1ZXMubGVuZ3RoOwogICAgICBvcmlnaW5hbE1lYW5zLnB1c2gob3JpZ01lYW4pOwogICAgfSBlbHNlIHsKICAgICAgb3JpZ2luYWxNZWFucy5wdXNoKG51bGwpOwogICAgfQogIH0pOwogIAogIHJldHVybiB7IGZpbHRlcmVkVGltZVBvaW50czogc29ydGVkVGltZVBvaW50cywgbm9ybWFsaXplZE1lYW5zOiBtZWFucywgbm9ybWFsaXplZEVycm9yczogZXJyb3JzLCBvcmlnaW5hbE1lYW5zOiBvcmlnaW5hbE1lYW5zIH07Cn0KCi8vIEtlZXAgb2xkIGZ1bmN0aW9uIG5hbWUgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCBidXQgaXQgbm93IHVzZXMgdGhlIHVuaWZpZWQgd29ya2Zsb3cKZnVuY3Rpb24gY2FsY3VsYXRlTWVhbkFuZEVycm9yRnJvbU5vcm1hbGl6ZWQod2VsbHMsIGJhc2VsaW5lRW5kVGltZSA9IDI0LCBjdXRvZmZUaW1lID0gMzYwKSB7CiAgcmV0dXJuIHByb2Nlc3NXZWxsc0FuZENhbGN1bGF0ZU1lYW4od2VsbHMsIHRydWUsIGJhc2VsaW5lRW5kVGltZSwgY3V0b2ZmVGltZSk7Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZURhdGEodGltZVBvaW50cywgdmFsdWVzLCBiYXNlbGluZUVuZFRpbWUgPSAyNCwgY3V0b2ZmVGltZSA9IDM2MCkgewogIC8vIE5vcm1hbGl6ZSBkYXRhOiBjYWxjdWxhdGUgYmFzZWxpbmUgZnJvbSAwLWJhc2VsaW5lRW5kVGltZSwgdGhlbiBwbG90IG9ubHkgcG9pbnRzIGFmdGVyIGJhc2VsaW5lRW5kVGltZQogIC8vIGRpdmlkZWQgYnkgYmFzZWxpbmUsIHVwIHRvIGN1dG9mZlRpbWUuIEJhc2VsaW5lIHBlcmlvZCBpcyBOT1QgaW5jbHVkZWQgaW4gdGhlIHBsb3QuCiAgLy8gUmV0dXJucyB7IGZpbHRlcmVkVGltZVBvaW50cywgbm9ybWFsaXplZFZhbHVlcywgb3JpZ2luYWxWYWx1ZXMgfSAtIGZpbHRlcmVkIGFycmF5cwogIGlmICghdGltZVBvaW50cyB8fCAhdmFsdWVzIHx8IHRpbWVQb2ludHMubGVuZ3RoICE9PSB2YWx1ZXMubGVuZ3RoKSB7CiAgICAvLyBJZiBpbnZhbGlkIGlucHV0LCByZXR1cm4gZW1wdHkgZmlsdGVyZWQgYXJyYXlzCiAgICByZXR1cm4geyBmaWx0ZXJlZFRpbWVQb2ludHM6IFtdLCBub3JtYWxpemVkVmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgfQogIAogIC8vIEZpbmQgYmFzZWxpbmU6IGF2ZXJhZ2Ugb2YgYWxsIHZhbHVlcyB3aGVyZSB0aW1lIDw9IGJhc2VsaW5lRW5kVGltZQogIGNvbnN0IGJhc2VsaW5lVmFsdWVzID0gW107CiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aW1lUG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAodGltZVBvaW50c1tpXSAhPT0gbnVsbCAmJiB2YWx1ZXNbaV0gIT09IG51bGwgJiYgdGltZVBvaW50c1tpXSA8PSBiYXNlbGluZUVuZFRpbWUpIHsKICAgICAgYmFzZWxpbmVWYWx1ZXMucHVzaCh2YWx1ZXNbaV0pOwogICAgfQogIH0KICAKICBpZiAoYmFzZWxpbmVWYWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAvLyBObyBiYXNlbGluZSBkYXRhIGZvdW5kLCByZXR1cm4gZW1wdHkgZmlsdGVyZWQgYXJyYXlzIChjYW4ndCBub3JtYWxpemUgd2l0aG91dCBiYXNlbGluZSkKICAgIHJldHVybiB7IGZpbHRlcmVkVGltZVBvaW50czogW10sIG5vcm1hbGl6ZWRWYWx1ZXM6IFtdLCBvcmlnaW5hbFZhbHVlczogW10gfTsKICB9CiAgCiAgY29uc3QgYmFzZWxpbmUgPSBiYXNlbGluZVZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIGJhc2VsaW5lVmFsdWVzLmxlbmd0aDsKICAKICBpZiAoYmFzZWxpbmUgPT09IDAgfHwgIWlzRmluaXRlKGJhc2VsaW5lKSkgewogICAgLy8gQXZvaWQgZGl2aXNpb24gYnkgemVybyBvciBpbnZhbGlkIGJhc2VsaW5lCiAgICByZXR1cm4geyBmaWx0ZXJlZFRpbWVQb2ludHM6IFtdLCBub3JtYWxpemVkVmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgfQogIAogIC8vIEZpbHRlciBhbmQgbm9ybWFsaXplOiBvbmx5IGluY2x1ZGUgcG9pbnRzIHdoZXJlIGJhc2VsaW5lRW5kVGltZSA8IHRpbWUgPD0gY3V0b2ZmVGltZQogIC8vIEVWRVJZIHBvaW50IGFmdGVyIGJhc2VsaW5lRW5kVGltZSBpcyBkaXZpZGVkIGJ5IHRoZSBTQU1FIGJhc2VsaW5lIGF2ZXJhZ2UKICBjb25zdCBmaWx0ZXJlZFRpbWVQb2ludHMgPSBbXTsKICBjb25zdCBub3JtYWxpemVkVmFsdWVzID0gW107CiAgY29uc3Qgb3JpZ2luYWxWYWx1ZXMgPSBbXTsKICAKICBmb3IgKGxldCBpID0gMDsgaSA8IHRpbWVQb2ludHMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHRpbWUgPSB0aW1lUG9pbnRzW2ldOwogICAgY29uc3QgdmFsID0gdmFsdWVzW2ldOwogICAgCiAgICBpZiAodGltZSA9PT0gbnVsbCB8fCB2YWwgPT09IG51bGwpIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICAKICAgIC8vIE9ubHkgaW5jbHVkZSBwb2ludHMgYWZ0ZXIgYmFzZWxpbmVFbmRUaW1lIGFuZCB1cCB0byBjdXRvZmZUaW1lIChiYXNlbGluZSBOT1QgaW5jbHVkZWQpCiAgICBpZiAodGltZSA+IGJhc2VsaW5lRW5kVGltZSAmJiB0aW1lIDw9IGN1dG9mZlRpbWUpIHsKICAgICAgLy8gU3VidHJhY3QgYmFzZWxpbmVFbmRUaW1lIHRvIGJyaW5nIGZpcnN0IHBvaW50IHRvIHg9MCAodGltZSBhZnRlciBpbmplY3Rpb24pCiAgICAgIGZpbHRlcmVkVGltZVBvaW50cy5wdXNoKHRpbWUgLSBiYXNlbGluZUVuZFRpbWUpOwogICAgICAvLyBEaXZpZGUgRVZFUlkgdGltZSBwb2ludCBieSB0aGUgU0FNRSBiYXNlbGluZSBhdmVyYWdlCiAgICAgIG5vcm1hbGl6ZWRWYWx1ZXMucHVzaCh2YWwgLyBiYXNlbGluZSk7CiAgICAgIG9yaWdpbmFsVmFsdWVzLnB1c2godmFsKTsgLy8gU3RvcmUgb3JpZ2luYWwgdmFsdWUgZm9yIHRvb2x0aXAKICAgIH0KICB9CiAgCiAgcmV0dXJuIHsgZmlsdGVyZWRUaW1lUG9pbnRzLCBub3JtYWxpemVkVmFsdWVzLCBvcmlnaW5hbFZhbHVlcyB9Owp9CgovLyBGaXQgYmFzZWxpbmUgZnVuY3Rpb24gdXNpbmcgc3BlY2lmaWVkIG1ldGhvZApmdW5jdGlvbiBmaXRCYXNlbGluZUZ1bmN0aW9uKHRpbWVQb2ludHMsIHZhbHVlcywgbWV0aG9kID0gJ2xvd2VzcycsIGZyYWMgPSAwLjUsIHBvbHlPcmRlciA9IDEpIHsKICAvLyBFeHRyYWN0IGJhc2VsaW5lIHdpbmRvdyAodGltZSA8PSBiYXNlbGluZUVuZFRpbWUgd2lsbCBiZSBoYW5kbGVkIGJ5IGNhbGxlcikKICAvLyBUaGlzIGZ1bmN0aW9uIGZpdHMgb24gdGhlIHByb3ZpZGVkIHBvaW50cyBhbmQgcmV0dXJucyBhIGZ1bmN0aW9uIGcodCkgdGhhdCBjYW4gYmUgZXZhbHVhdGVkIGF0IGFueSB0aW1lCiAgCiAgaWYgKCF0aW1lUG9pbnRzIHx8ICF2YWx1ZXMgfHwgdGltZVBvaW50cy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBudWxsOwogIH0KICAKICAvLyBGaWx0ZXIgb3V0IE5hTiB2YWx1ZXMKICBjb25zdCB2YWxpZERhdGEgPSBbXTsKICBmb3IgKGxldCBpID0gMDsgaSA8IHRpbWVQb2ludHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICh0aW1lUG9pbnRzW2ldICE9PSBudWxsICYmIHZhbHVlc1tpXSAhPT0gbnVsbCAmJiAhaXNOYU4odGltZVBvaW50c1tpXSkgJiYgIWlzTmFOKHZhbHVlc1tpXSkpIHsKICAgICAgdmFsaWREYXRhLnB1c2goeyB0OiB0aW1lUG9pbnRzW2ldLCB2OiB2YWx1ZXNbaV0gfSk7CiAgICB9CiAgfQogIAogIGlmICh2YWxpZERhdGEubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgdmFsaWREYXRhLnNvcnQoKGEsIGIpID0+IGEudCAtIGIudCk7CiAgY29uc3QgdGltZXMgPSB2YWxpZERhdGEubWFwKGQgPT4gZC50KTsKICBjb25zdCB2YWxzID0gdmFsaWREYXRhLm1hcChkID0+IGQudik7CiAgCiAgaWYgKG1ldGhvZCA9PT0gJ2NvbnN0YW50JykgewogICAgLy8gQ29uc3RhbnQgYmFzZWxpbmU6IGcodCkgPSBtZWFuKEZfYmFzZWxpbmUpCiAgICBjb25zdCBiYXNlbGluZVZhbHVlID0gdmFscy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIHZhbHMubGVuZ3RoOwogICAgcmV0dXJuICh0KSA9PiBiYXNlbGluZVZhbHVlOwogIH0gZWxzZSBpZiAobWV0aG9kID09PSAncG9seW5vbWlhbCcpIHsKICAgIC8vIFBvbHlub21pYWwgZml0OiBnKHQpID0gY+KCgCArIGPigoF0ICsgY+KCgnTCsiArIC4uLgogICAgLy8gU2ltcGxlIHBvbHlub21pYWwgcmVncmVzc2lvbgogICAgY29uc3QgbiA9IHRpbWVzLmxlbmd0aDsKICAgIGNvbnN0IFggPSBbXTsKICAgIGNvbnN0IHkgPSB2YWxzOwogICAgCiAgICAvLyBCdWlsZCBkZXNpZ24gbWF0cml4CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCByb3cgPSBbXTsKICAgICAgZm9yIChsZXQgcCA9IHBvbHlPcmRlcjsgcCA+PSAwOyBwLS0pIHsKICAgICAgICByb3cucHVzaChNYXRoLnBvdyh0aW1lc1tpXSwgcCkpOwogICAgICB9CiAgICAgIFgucHVzaChyb3cpOwogICAgfQogICAgCiAgICAvLyBTb2x2ZSB1c2luZyBub3JtYWwgZXF1YXRpb25zOiAoWCdYKV4oLTEpWCd5CiAgICAvLyBTaW1wbGlmaWVkIGZvciBzbWFsbCBvcmRlcnMKICAgIGxldCBjb2VmZnM7CiAgICBpZiAocG9seU9yZGVyID09PSAxKSB7CiAgICAgIC8vIExpbmVhcjogeSA9IGEgKyBiKnQKICAgICAgY29uc3Qgc3VtVCA9IHRpbWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgICBjb25zdCBzdW1UMiA9IHRpbWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIgKiBiLCAwKTsKICAgICAgY29uc3Qgc3VtWSA9IHkucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICAgIGNvbnN0IHN1bVRZID0gdGltZXMucmVkdWNlKChzdW0sIHQsIGkpID0+IHN1bSArIHQgKiB5W2ldLCAwKTsKICAgICAgY29uc3QgbiA9IHRpbWVzLmxlbmd0aDsKICAgICAgCiAgICAgIGNvbnN0IGRldCA9IG4gKiBzdW1UMiAtIHN1bVQgKiBzdW1UOwogICAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgICAgLy8gRmFsbGJhY2sgdG8gY29uc3RhbnQKICAgICAgICBjb25zdCBtZWFuID0gc3VtWSAvIG47CiAgICAgICAgcmV0dXJuICh0KSA9PiBtZWFuOwogICAgICB9CiAgICAgIAogICAgICBjb25zdCBhID0gKHN1bVkgKiBzdW1UMiAtIHN1bVQgKiBzdW1UWSkgLyBkZXQ7CiAgICAgIGNvbnN0IGIgPSAobiAqIHN1bVRZIC0gc3VtVCAqIHN1bVkpIC8gZGV0OwogICAgICBjb2VmZnMgPSBbYiwgYV07IC8vIFtjMSwgYzBdIGZvciBwb2x5MWQgZm9ybWF0CiAgICB9IGVsc2UgewogICAgICAvLyBIaWdoZXIgb3JkZXIgLSB1c2Ugc2ltcGxlIGxlYXN0IHNxdWFyZXMKICAgICAgLy8gRm9yIHNpbXBsaWNpdHksIHVzZSBhIGJhc2ljIGltcGxlbWVudGF0aW9uCiAgICAgIGNvbnN0IG1lYW5UID0gc3VtVCAvIG47CiAgICAgIGNvbnN0IG1lYW5ZID0gc3VtWSAvIG47CiAgICAgIC8vIEZhbGxiYWNrIHRvIGNvbnN0YW50IGZvciBub3cgaWYgb3JkZXIgPiAxCiAgICAgIGNvbnN0IG1lYW4gPSBtZWFuWTsKICAgICAgcmV0dXJuICh0KSA9PiBtZWFuOwogICAgfQogICAgCiAgICByZXR1cm4gKHQpID0+IHsKICAgICAgbGV0IHJlc3VsdCA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29lZmZzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVzdWx0ICs9IGNvZWZmc1tpXSAqIE1hdGgucG93KHQsIGNvZWZmcy5sZW5ndGggLSAxIC0gaSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfSBlbHNlIGlmIChtZXRob2QgPT09ICdsb3dlc3MnKSB7CiAgICAvLyBMT1dFU1Mgc21vb3RoaW5nIC0gc2ltcGxpZmllZCBpbXBsZW1lbnRhdGlvbgogICAgLy8gRm9yIGEgcHJvcGVyIExPV0VTUywgd2UnZCBuZWVkIGEgbGlicmFyeSwgYnV0IHdlIGNhbiBhcHByb3hpbWF0ZSB3aXRoIG1vdmluZyBhdmVyYWdlCiAgICAvLyBUaGlzIGlzIGEgc2ltcGxpZmllZCB2ZXJzaW9uIC0gZm9yIHByb2R1Y3Rpb24sIGNvbnNpZGVyIHVzaW5nIGEgbGlicmFyeSBsaWtlIHJlZ3Jlc3Npb24uanMKICAgIAogICAgLy8gVXNlIGEgc2ltcGxlIG1vdmluZyBhdmVyYWdlIHdpdGggd2VpZ2h0ZWQgd2luZG93IGFzIGFwcHJveGltYXRpb24KICAgIGNvbnN0IHdpbmRvd1NpemUgPSBNYXRoLm1heCgxLCBNYXRoLmZsb29yKGZyYWMgKiB0aW1lcy5sZW5ndGgpKTsKICAgIGNvbnN0IHNtb290aGVkID0gW107CiAgICAKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZXMubGVuZ3RoOyBpKyspIHsKICAgICAgbGV0IHN1bSA9IDA7CiAgICAgIGxldCB3ZWlnaHRTdW0gPSAwOwogICAgICBjb25zdCBjZW50ZXIgPSB0aW1lc1tpXTsKICAgICAgCiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGltZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5hYnModGltZXNbal0gLSBjZW50ZXIpOwogICAgICAgIGNvbnN0IG1heERpc3QgPSBNYXRoLm1heCguLi50aW1lcy5tYXAodCA9PiBNYXRoLmFicyh0IC0gY2VudGVyKSkpOwogICAgICAgIGNvbnN0IHdlaWdodCA9IGRpc3QgPCBtYXhEaXN0ICogZnJhYyA/IE1hdGgucG93KDEgLSAoZGlzdCAvIChtYXhEaXN0ICogZnJhYykpLCAzKSA6IDA7IC8vIFRyaWN1YmUgd2VpZ2h0CiAgICAgICAgCiAgICAgICAgc3VtICs9IHZhbHNbal0gKiB3ZWlnaHQ7CiAgICAgICAgd2VpZ2h0U3VtICs9IHdlaWdodDsKICAgICAgfQogICAgICAKICAgICAgc21vb3RoZWQucHVzaCh3ZWlnaHRTdW0gPiAwID8gc3VtIC8gd2VpZ2h0U3VtIDogdmFsc1tpXSk7CiAgICB9CiAgICAKICAgIC8vIFJldHVybiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uCiAgICByZXR1cm4gKHQpID0+IHsKICAgICAgaWYgKHQgPD0gdGltZXNbMF0pIHJldHVybiBzbW9vdGhlZFswXTsKICAgICAgaWYgKHQgPj0gdGltZXNbdGltZXMubGVuZ3RoIC0gMV0pIHJldHVybiBzbW9vdGhlZFtzbW9vdGhlZC5sZW5ndGggLSAxXTsKICAgICAgCiAgICAgIC8vIExpbmVhciBpbnRlcnBvbGF0aW9uCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZXMubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgaWYgKHQgPj0gdGltZXNbaV0gJiYgdCA8PSB0aW1lc1tpICsgMV0pIHsKICAgICAgICAgIGNvbnN0IHJhdGlvID0gKHQgLSB0aW1lc1tpXSkgLyAodGltZXNbaSArIDFdIC0gdGltZXNbaV0pOwogICAgICAgICAgcmV0dXJuIHNtb290aGVkW2ldICogKDEgLSByYXRpbykgKyBzbW9vdGhlZFtpICsgMV0gKiByYXRpbzsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHNtb290aGVkW3Ntb290aGVkLmxlbmd0aCAtIDFdOwogICAgfTsKICB9CiAgCiAgcmV0dXJuIG51bGw7Cn0KCi8vIFN0ZXAgMDogQmFzZWxpbmUgc3VidHJhY3Rpb24g4oCUIHN1YnRyYWN0IGFsbCBwb2ludHMgZnJvbSByZWYgKGxvd2VzdCBvciBmaXJzdC1hZnRlci1iYXNlbGluZSkuIE5vIGRpdmlzaW9uLgpmdW5jdGlvbiBiYXNlbGluZVN1YnRyYWN0V2VsbERhdGEod2VsbERhdGEsIGJhc2VsaW5lRW5kVGltZSwgbW9kZSkgewogIGlmICghd2VsbERhdGEgfHwgIXdlbGxEYXRhLnRpbWVfcyB8fCAhd2VsbERhdGEudmFsdWVzKSB7CiAgICByZXR1cm4gd2VsbERhdGE7CiAgfQogIGNvbnN0IGJhc2VsaW5lVmFsdWVzID0gW107CiAgZm9yIChsZXQgaSA9IDA7IGkgPCB3ZWxsRGF0YS50aW1lX3MubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHRpbWUgPSB3ZWxsRGF0YS50aW1lX3NbaV07CiAgICBjb25zdCB2YWwgPSB3ZWxsRGF0YS52YWx1ZXNbaV07CiAgICBpZiAodGltZSAhPT0gbnVsbCAmJiB2YWwgIT09IG51bGwgJiYgdGltZSA8PSBiYXNlbGluZUVuZFRpbWUpIHsKICAgICAgYmFzZWxpbmVWYWx1ZXMucHVzaCh2YWwpOwogICAgfQogIH0KICBpZiAoYmFzZWxpbmVWYWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gd2VsbERhdGE7CiAgfQogIGxldCByZWY7CiAgaWYgKG1vZGUgPT09ICdsb3dlc3RfcG9pbnQnKSB7CiAgICByZWYgPSBNYXRoLm1pbiguLi5iYXNlbGluZVZhbHVlcyk7CiAgfSBlbHNlIHsKICAgIGNvbnN0IGFmdGVyQmFzZWxpbmVQb2ludHMgPSBbXTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbERhdGEudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHRpbWUgPSB3ZWxsRGF0YS50aW1lX3NbaV07CiAgICAgIGNvbnN0IHZhbHVlID0gd2VsbERhdGEudmFsdWVzW2ldOwogICAgICBpZiAodGltZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0aW1lID4gYmFzZWxpbmVFbmRUaW1lKSB7CiAgICAgICAgYWZ0ZXJCYXNlbGluZVBvaW50cy5wdXNoKHsgdGltZTogdGltZSwgdmFsdWU6IHZhbHVlIH0pOwogICAgICB9CiAgICB9CiAgICBhZnRlckJhc2VsaW5lUG9pbnRzLnNvcnQoKGEsIGIpID0+IGEudGltZSAtIGIudGltZSk7CiAgICBpZiAoYWZ0ZXJCYXNlbGluZVBvaW50cy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHdlbGxEYXRhOwogICAgfQogICAgcmVmID0gYWZ0ZXJCYXNlbGluZVBvaW50c1swXS52YWx1ZTsKICB9CiAgaWYgKCFpc0Zpbml0ZShyZWYpKSB7CiAgICByZXR1cm4gd2VsbERhdGE7CiAgfQogIGNvbnN0IHN1YnRyYWN0ZWRUaW1lcyA9IFtdOwogIGNvbnN0IHN1YnRyYWN0ZWRWYWx1ZXMgPSBbXTsKICBjb25zdCBvcmlnaW5hbFZhbHVlcyA9IHdlbGxEYXRhLnZhbHVlcy5zbGljZSA/IHdlbGxEYXRhLnZhbHVlcy5zbGljZSgpIDogWy4uLndlbGxEYXRhLnZhbHVlc107CiAgZm9yIChsZXQgaSA9IDA7IGkgPCB3ZWxsRGF0YS50aW1lX3MubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHRpbWUgPSB3ZWxsRGF0YS50aW1lX3NbaV07CiAgICBjb25zdCB2YWx1ZSA9IHdlbGxEYXRhLnZhbHVlc1tpXTsKICAgIGlmICh0aW1lID09PSBudWxsIHx8IHZhbHVlID09PSBudWxsKSBjb250aW51ZTsKICAgIHN1YnRyYWN0ZWRUaW1lcy5wdXNoKHRpbWUpOwogICAgc3VidHJhY3RlZFZhbHVlcy5wdXNoKHZhbHVlIC0gcmVmKTsKICB9CiAgaWYgKHN1YnRyYWN0ZWRUaW1lcy5sZW5ndGggPT09IDApIHJldHVybiBudWxsOwogIHJldHVybiB7CiAgICB0aW1lX3M6IHN1YnRyYWN0ZWRUaW1lcywKICAgIHZhbHVlczogc3VidHJhY3RlZFZhbHVlcywKICAgIG9yaWdpbmFsVmFsdWVzOiBvcmlnaW5hbFZhbHVlcywKICAgIGxhYmVsOiB3ZWxsRGF0YS5sYWJlbCwKICAgIGNvbnRlbnQ6IHdlbGxEYXRhLmNvbnRlbnQKICB9Owp9CgovLyBTdGVwIDAgKyBTdGVwIDEgY29tYmluZWQ6IChGIC0gcmVmKSAvIHJlZiA9IM6URi9GLCB1c2luZyBTdGVwIDAgcmVmIChsb3dlc3Qgb3IgZmlyc3QtYWZ0ZXItYmFzZWxpbmUpLgpmdW5jdGlvbiBiYXNlbGluZVN1YnRyYWN0QW5kTm9ybWFsaXplV2VsbERhdGEod2VsbERhdGEsIGJhc2VsaW5lRW5kVGltZSwgbW9kZSkgewogIGlmICghd2VsbERhdGEgfHwgIXdlbGxEYXRhLnRpbWVfcyB8fCAhd2VsbERhdGEudmFsdWVzKSB7CiAgICByZXR1cm4gd2VsbERhdGE7CiAgfQogIGNvbnN0IGJhc2VsaW5lVmFsdWVzID0gW107CiAgZm9yIChsZXQgaSA9IDA7IGkgPCB3ZWxsRGF0YS50aW1lX3MubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHRpbWUgPSB3ZWxsRGF0YS50aW1lX3NbaV07CiAgICBjb25zdCB2YWwgPSB3ZWxsRGF0YS52YWx1ZXNbaV07CiAgICBpZiAodGltZSAhPT0gbnVsbCAmJiB2YWwgIT09IG51bGwgJiYgdGltZSA8PSBiYXNlbGluZUVuZFRpbWUpIHsKICAgICAgYmFzZWxpbmVWYWx1ZXMucHVzaCh2YWwpOwogICAgfQogIH0KICBpZiAoYmFzZWxpbmVWYWx1ZXMubGVuZ3RoID09PSAwKSByZXR1cm4gd2VsbERhdGE7CiAgbGV0IHJlZjsKICBpZiAobW9kZSA9PT0gJ2xvd2VzdF9wb2ludCcpIHsKICAgIHJlZiA9IE1hdGgubWluKC4uLmJhc2VsaW5lVmFsdWVzKTsKICB9IGVsc2UgewogICAgY29uc3QgYWZ0ZXJCYXNlbGluZVBvaW50cyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB3ZWxsRGF0YS50aW1lX3MubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgdGltZSA9IHdlbGxEYXRhLnRpbWVfc1tpXTsKICAgICAgY29uc3QgdmFsdWUgPSB3ZWxsRGF0YS52YWx1ZXNbaV07CiAgICAgIGlmICh0aW1lICE9PSBudWxsICYmIHZhbHVlICE9PSBudWxsICYmIHRpbWUgPiBiYXNlbGluZUVuZFRpbWUpIHsKICAgICAgICBhZnRlckJhc2VsaW5lUG9pbnRzLnB1c2goeyB0aW1lOiB0aW1lLCB2YWx1ZTogdmFsdWUgfSk7CiAgICAgIH0KICAgIH0KICAgIGFmdGVyQmFzZWxpbmVQb2ludHMuc29ydCgoYSwgYikgPT4gYS50aW1lIC0gYi50aW1lKTsKICAgIGlmIChhZnRlckJhc2VsaW5lUG9pbnRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHdlbGxEYXRhOwogICAgcmVmID0gYWZ0ZXJCYXNlbGluZVBvaW50c1swXS52YWx1ZTsKICB9CiAgaWYgKCFpc0Zpbml0ZShyZWYpIHx8IHJlZiA9PT0gMCkgcmV0dXJuIHdlbGxEYXRhOwogIGNvbnN0IG91dFRpbWVzID0gW107CiAgY29uc3Qgb3V0VmFsdWVzID0gW107CiAgY29uc3Qgb3JpZ2luYWxWYWx1ZXMgPSB3ZWxsRGF0YS52YWx1ZXMuc2xpY2UgPyB3ZWxsRGF0YS52YWx1ZXMuc2xpY2UoKSA6IFsuLi53ZWxsRGF0YS52YWx1ZXNdOwogIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbERhdGEudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCB0aW1lID0gd2VsbERhdGEudGltZV9zW2ldOwogICAgY29uc3QgdmFsdWUgPSB3ZWxsRGF0YS52YWx1ZXNbaV07CiAgICBpZiAodGltZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gbnVsbCkgY29udGludWU7CiAgICBvdXRUaW1lcy5wdXNoKHRpbWUpOwogICAgb3V0VmFsdWVzLnB1c2goKHZhbHVlIC0gcmVmKSAvIHJlZik7CiAgfQogIGlmIChvdXRUaW1lcy5sZW5ndGggPT09IDApIHJldHVybiBudWxsOwogIHJldHVybiB7CiAgICB0aW1lX3M6IG91dFRpbWVzLAogICAgdmFsdWVzOiBvdXRWYWx1ZXMsCiAgICBvcmlnaW5hbFZhbHVlczogb3JpZ2luYWxWYWx1ZXMsCiAgICBsYWJlbDogd2VsbERhdGEubGFiZWwsCiAgICBjb250ZW50OiB3ZWxsRGF0YS5jb250ZW50CiAgfTsKfQoKLy8gTm9ybWFsaXplIHdlbGwgZGF0YSB1c2luZyBmaXR0ZWQgYmFzZWxpbmUgKFN0ZXAgMSkKZnVuY3Rpb24gbm9ybWFsaXplV2l0aEZpdHRlZEJhc2VsaW5lKHdlbGxEYXRhLCBiYXNlbGluZUVuZFRpbWUsIG1ldGhvZCwgZnJhYywgcG9seU9yZGVyLCBub3JtYWxpemF0aW9uTW9kZSkgewogIGlmICghd2VsbERhdGEgfHwgIXdlbGxEYXRhLnRpbWVfcyB8fCAhd2VsbERhdGEudmFsdWVzKSB7CiAgICByZXR1cm4gd2VsbERhdGE7CiAgfQogIGlmIChub3JtYWxpemF0aW9uTW9kZSA9PT0gJ25vbmUnKSB7CiAgICByZXR1cm4gd2VsbERhdGE7CiAgfQogIAogIC8vIEV4dHJhY3QgYmFzZWxpbmUgd2luZG93CiAgY29uc3QgYmFzZWxpbmVUaW1lcyA9IFtdOwogIGNvbnN0IGJhc2VsaW5lVmFsdWVzID0gW107CiAgZm9yIChsZXQgaSA9IDA7IGkgPCB3ZWxsRGF0YS50aW1lX3MubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHRpbWUgPSB3ZWxsRGF0YS50aW1lX3NbaV07CiAgICBjb25zdCB2YWwgPSB3ZWxsRGF0YS52YWx1ZXNbaV07CiAgICBpZiAodGltZSAhPT0gbnVsbCAmJiB2YWwgIT09IG51bGwgJiYgdGltZSA8PSBiYXNlbGluZUVuZFRpbWUpIHsKICAgICAgYmFzZWxpbmVUaW1lcy5wdXNoKHRpbWUpOwogICAgICBiYXNlbGluZVZhbHVlcy5wdXNoKHZhbCk7CiAgICB9CiAgfQogIAogIGlmIChiYXNlbGluZVRpbWVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHdlbGxEYXRhOyAvLyBObyBiYXNlbGluZSBkYXRhCiAgfQogIAogIC8vIEhhbmRsZSBsb3dlc3RfcG9pbnQgYW5kIGZpcnN0X3BvaW50IG1vZGVzIChkb24ndCBuZWVkIGZpdHRlZCBiYXNlbGluZSkKICBpZiAobm9ybWFsaXphdGlvbk1vZGUgPT09ICdsb3dlc3RfcG9pbnQnIHx8IG5vcm1hbGl6YXRpb25Nb2RlID09PSAnZmlyc3RfcG9pbnQnKSB7CiAgICBsZXQgYmFzZWxpbmVWYWx1ZTsKICAgIGlmIChub3JtYWxpemF0aW9uTW9kZSA9PT0gJ2xvd2VzdF9wb2ludCcpIHsKICAgICAgYmFzZWxpbmVWYWx1ZSA9IE1hdGgubWluKC4uLmJhc2VsaW5lVmFsdWVzKTsKICAgIH0gZWxzZSB7IC8vIGZpcnN0X3BvaW50CiAgICAgIC8vIEZpbmQgdGhlIGZpcnN0IHBvaW50IGFmdGVyIHRoZSBiYXNlbGluZSByYW5nZSBlbmRzICh0aW1lID4gYmFzZWxpbmVFbmRUaW1lKQogICAgICBjb25zdCBhZnRlckJhc2VsaW5lUG9pbnRzID0gW107CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbERhdGEudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgdGltZSA9IHdlbGxEYXRhLnRpbWVfc1tpXTsKICAgICAgICBjb25zdCB2YWx1ZSA9IHdlbGxEYXRhLnZhbHVlc1tpXTsKICAgICAgICBpZiAodGltZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0aW1lID4gYmFzZWxpbmVFbmRUaW1lKSB7CiAgICAgICAgICBhZnRlckJhc2VsaW5lUG9pbnRzLnB1c2goeyB0aW1lOiB0aW1lLCB2YWx1ZTogdmFsdWUgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGFmdGVyQmFzZWxpbmVQb2ludHMuc29ydCgoYSwgYikgPT4gYS50aW1lIC0gYi50aW1lKTsKICAgICAgaWYgKGFmdGVyQmFzZWxpbmVQb2ludHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHdlbGxEYXRhOyAvLyBObyBwb2ludCBhZnRlciBiYXNlbGluZQogICAgICB9CiAgICAgIGJhc2VsaW5lVmFsdWUgPSBhZnRlckJhc2VsaW5lUG9pbnRzWzBdLnZhbHVlOwogICAgfQogICAgCiAgICBpZiAoYmFzZWxpbmVWYWx1ZSA9PT0gMCB8fCAhaXNGaW5pdGUoYmFzZWxpbmVWYWx1ZSkpIHsKICAgICAgcmV0dXJuIHdlbGxEYXRhOwogICAgfQogICAgCiAgICAvLyBOb3JtYWxpemUgYWxsIHRpbWVwb2ludHMgdXNpbmcgY29uc3RhbnQgYmFzZWxpbmUgdmFsdWUKICAgIGNvbnN0IG5vcm1hbGl6ZWRUaW1lcyA9IFtdOwogICAgY29uc3Qgbm9ybWFsaXplZFZhbHVlcyA9IFtdOwogICAgY29uc3Qgb3JpZ2luYWxWYWx1ZXMgPSBbXTsKICAgIAogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB3ZWxsRGF0YS50aW1lX3MubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgdGltZSA9IHdlbGxEYXRhLnRpbWVfc1tpXTsKICAgICAgY29uc3QgdmFsdWUgPSB3ZWxsRGF0YS52YWx1ZXNbaV07CiAgICAgIAogICAgICBpZiAodGltZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gbnVsbCkgY29udGludWU7CiAgICAgIAogICAgICBjb25zdCBub3JtVmFsdWUgPSB2YWx1ZSAvIGJhc2VsaW5lVmFsdWU7CiAgICAgIG5vcm1hbGl6ZWRUaW1lcy5wdXNoKHRpbWUpOwogICAgICBub3JtYWxpemVkVmFsdWVzLnB1c2gobm9ybVZhbHVlKTsKICAgICAgb3JpZ2luYWxWYWx1ZXMucHVzaCh2YWx1ZSk7CiAgICB9CiAgICAKICAgIGlmIChub3JtYWxpemVkVGltZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgCiAgICByZXR1cm4gewogICAgICB0aW1lX3M6IG5vcm1hbGl6ZWRUaW1lcywKICAgICAgdmFsdWVzOiBub3JtYWxpemVkVmFsdWVzLAogICAgICBvcmlnaW5hbFZhbHVlczogb3JpZ2luYWxWYWx1ZXMsCiAgICAgIGxhYmVsOiB3ZWxsRGF0YS5sYWJlbCwKICAgICAgY29udGVudDogd2VsbERhdGEuY29udGVudAogICAgfTsKICB9CiAgCiAgLy8gRm9yIG90aGVyIG1vZGVzLCBmaXQgYmFzZWxpbmUgZnVuY3Rpb24KICBjb25zdCBiYXNlbGluZUZ1bmMgPSBmaXRCYXNlbGluZUZ1bmN0aW9uKGJhc2VsaW5lVGltZXMsIGJhc2VsaW5lVmFsdWVzLCBtZXRob2QsIGZyYWMsIHBvbHlPcmRlcik7CiAgaWYgKCFiYXNlbGluZUZ1bmMpIHsKICAgIHJldHVybiB3ZWxsRGF0YTsKICB9CiAgCiAgLy8gTm9ybWFsaXplIGFsbCB0aW1lcG9pbnRzIHVzaW5nIGZpdHRlZCBiYXNlbGluZQogIGNvbnN0IG5vcm1hbGl6ZWRUaW1lcyA9IFtdOwogIGNvbnN0IG5vcm1hbGl6ZWRWYWx1ZXMgPSBbXTsKICBjb25zdCBvcmlnaW5hbFZhbHVlcyA9IFtdOwogIAogIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbERhdGEudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCB0aW1lID0gd2VsbERhdGEudGltZV9zW2ldOwogICAgY29uc3QgdmFsdWUgPSB3ZWxsRGF0YS52YWx1ZXNbaV07CiAgICAKICAgIGlmICh0aW1lID09PSBudWxsIHx8IHZhbHVlID09PSBudWxsKSBjb250aW51ZTsKICAgIAogICAgY29uc3QgYmFzZWxpbmVWYWx1ZSA9IGJhc2VsaW5lRnVuYyh0aW1lKTsKICAgIGlmIChiYXNlbGluZVZhbHVlID09PSAwIHx8ICFpc0Zpbml0ZShiYXNlbGluZVZhbHVlKSkgY29udGludWU7CiAgICAKICAgIGxldCBub3JtVmFsdWU7CiAgICBpZiAobm9ybWFsaXphdGlvbk1vZGUgPT09ICdkZWx0YV9mX292ZXJfZicpIHsKICAgICAgLy8gzpRGL0YgPSAoRih0KSAtIGcodCkpIC8gZyh0KQogICAgICBub3JtVmFsdWUgPSAodmFsdWUgLSBiYXNlbGluZVZhbHVlKSAvIGJhc2VsaW5lVmFsdWU7CiAgICB9IGVsc2UgewogICAgICAvLyBNdWx0aXBsaWNhdGl2ZTogRl9ub3JtKHQpID0gRih0KSAvIGcodCkKICAgICAgbm9ybVZhbHVlID0gdmFsdWUgLyBiYXNlbGluZVZhbHVlOwogICAgfQogICAgCiAgICBub3JtYWxpemVkVGltZXMucHVzaCh0aW1lKTsKICAgIG5vcm1hbGl6ZWRWYWx1ZXMucHVzaChub3JtVmFsdWUpOwogICAgb3JpZ2luYWxWYWx1ZXMucHVzaCh2YWx1ZSk7CiAgfQogIAogIGlmIChub3JtYWxpemVkVGltZXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgcmV0dXJuIHsKICAgIHRpbWVfczogbm9ybWFsaXplZFRpbWVzLAogICAgdmFsdWVzOiBub3JtYWxpemVkVmFsdWVzLAogICAgb3JpZ2luYWxWYWx1ZXM6IG9yaWdpbmFsVmFsdWVzLAogICAgbGFiZWw6IHdlbGxEYXRhLmxhYmVsLAogICAgY29udGVudDogd2VsbERhdGEuY29udGVudAogIH07Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZVdlbGxEYXRhKHdlbGxEYXRhLCBpc05vcm1hbGl6ZWQsIGJhc2VsaW5lRW5kVGltZSA9IDI0LCBjdXRvZmZUaW1lID0gMzYwKSB7CiAgLy8gU1RFUCAzOiBOb3JtYWxpemUgYSBzaW5nbGUgd2VsbCdzIGRhdGEgb2JqZWN0IChpZiBub3JtYWxpemF0aW9uIGlzIGVuYWJsZWQpCiAgLy8gVGhpcyBoYXBwZW5zIEFGVEVSIGJhc2VsaW5lIGFsaWdubWVudCBhbmQgZ3JvdXBpbmcgaW50byB0cmlwbGljYXRlcwogIC8vIFJldHVybnMgYSBuZXcgd2VsbCBkYXRhIG9iamVjdCB3aXRoIG5vcm1hbGl6ZWQgdGltZV9zIGFuZCB2YWx1ZXMgKG9yIG9yaWdpbmFsIGlmIG5vdCBub3JtYWxpemVkKQogIGlmICghd2VsbERhdGEgfHwgIXdlbGxEYXRhLnRpbWVfcyB8fCAhd2VsbERhdGEudmFsdWVzKSB7CiAgICByZXR1cm4gd2VsbERhdGE7IC8vIFJldHVybiBhcy1pcyBpZiBpbnZhbGlkCiAgfQogIAogIGlmICghaXNOb3JtYWxpemVkKSB7CiAgICAvLyBOb3Qgbm9ybWFsaXppbmcgLSByZXR1cm4gb3JpZ2luYWwgZGF0YQogICAgcmV0dXJuIHsKICAgICAgdGltZV9zOiB3ZWxsRGF0YS50aW1lX3MsCiAgICAgIHZhbHVlczogd2VsbERhdGEudmFsdWVzLAogICAgICBsYWJlbDogd2VsbERhdGEubGFiZWwsCiAgICAgIGNvbnRlbnQ6IHdlbGxEYXRhLmNvbnRlbnQsCiAgICAgIG9yaWdpbmFsVmFsdWVzOiB3ZWxsRGF0YS5vcmlnaW5hbFZhbHVlcyB8fCB3ZWxsRGF0YS52YWx1ZXMKICAgIH07CiAgfQogIAogIC8vIE5vcm1hbGl6ZSB0aGlzIHdlbGwKICBjb25zdCBub3JtYWxpemVkID0gbm9ybWFsaXplRGF0YSh3ZWxsRGF0YS50aW1lX3MsIHdlbGxEYXRhLnZhbHVlcywgYmFzZWxpbmVFbmRUaW1lLCBjdXRvZmZUaW1lKTsKICAKICBpZiAobm9ybWFsaXplZC5maWx0ZXJlZFRpbWVQb2ludHMubGVuZ3RoID09PSAwKSB7CiAgICAvLyBObyBkYXRhIGFmdGVyIG5vcm1hbGl6YXRpb24gLSByZXR1cm4gbnVsbCB0byBpbmRpY2F0ZSB0aGlzIHdlbGwgc2hvdWxkIGJlIHNraXBwZWQKICAgIHJldHVybiBudWxsOwogIH0KICAKICAvLyBSZXR1cm4gbm9ybWFsaXplZCB3ZWxsIGRhdGEKICByZXR1cm4gewogICAgdGltZV9zOiBub3JtYWxpemVkLmZpbHRlcmVkVGltZVBvaW50cywKICAgIHZhbHVlczogbm9ybWFsaXplZC5ub3JtYWxpemVkVmFsdWVzLAogICAgb3JpZ2luYWxWYWx1ZXM6IG5vcm1hbGl6ZWQub3JpZ2luYWxWYWx1ZXMsIC8vIFN0b3JlIGZvciB0b29sdGlwIGRpc3BsYXkKICAgIGxhYmVsOiB3ZWxsRGF0YS5sYWJlbCwKICAgIGNvbnRlbnQ6IHdlbGxEYXRhLmNvbnRlbnQKICB9Owp9CgoKLy8gRml0IHJlZ3Jlc3Npb24gY3VydmUgdG8gZGF0YSBwb2ludHMgKFN0ZXAgNCkKZnVuY3Rpb24gZml0UmVncmVzc2lvbkN1cnZlKGRhdGFQb2ludHMsIHJlZ3Jlc3Npb25UeXBlID0gJ21vbm8tZXhwb25lbnRpYWwnLCBwb2x5bm9taWFsT3JkZXIgPSAyKSB7CiAgLy8gZGF0YVBvaW50cyBpcyBhbiBhcnJheSBvZiB7eCwgeX0gb2JqZWN0cwogIGlmICghZGF0YVBvaW50cyB8fCBkYXRhUG9pbnRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIAogIC8vIEZpbHRlciB2YWxpZCBwb2ludHMKICBjb25zdCB2YWxpZFBvaW50cyA9IGRhdGFQb2ludHMuZmlsdGVyKHAgPT4gcC54ICE9PSBudWxsICYmIHAueSAhPT0gbnVsbCAmJiBpc0Zpbml0ZShwLngpICYmIGlzRmluaXRlKHAueSkpOwogIGlmICh2YWxpZFBvaW50cy5sZW5ndGggPCAyKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgLy8gU29ydCBieSB4CiAgdmFsaWRQb2ludHMuc29ydCgoYSwgYikgPT4gYS54IC0gYi54KTsKICBjb25zdCB4ID0gdmFsaWRQb2ludHMubWFwKHAgPT4gcC54KTsKICBjb25zdCB5ID0gdmFsaWRQb2ludHMubWFwKHAgPT4gcC55KTsKICAKICBsZXQgZml0RnVuY3Rpb247CiAgCiAgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAnbGluZWFyJykgewogICAgLy8gTGluZWFyOiB5ID0gYSArIGIqeAogICAgY29uc3QgbiA9IHgubGVuZ3RoOwogICAgY29uc3Qgc3VtWCA9IHgucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICBjb25zdCBzdW1ZID0geS5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTsKICAgIGNvbnN0IHN1bVhZID0geC5yZWR1Y2UoKHN1bSwgeGksIGkpID0+IHN1bSArIHhpICogeVtpXSwgMCk7CiAgICBjb25zdCBzdW1YMiA9IHgucmVkdWNlKChzdW0sIHhpKSA9PiBzdW0gKyB4aSAqIHhpLCAwKTsKICAgIAogICAgY29uc3QgZGV0ID0gbiAqIHN1bVgyIC0gc3VtWCAqIHN1bVg7CiAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgIC8vIEZhbGxiYWNrIHRvIGNvbnN0YW50CiAgICAgIGNvbnN0IG1lYW4gPSBzdW1ZIC8gbjsKICAgICAgZml0RnVuY3Rpb24gPSAodCkgPT4gbWVhbjsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGEgPSAoc3VtWSAqIHN1bVgyIC0gc3VtWCAqIHN1bVhZKSAvIGRldDsKICAgICAgY29uc3QgYiA9IChuICogc3VtWFkgLSBzdW1YICogc3VtWSkgLyBkZXQ7CiAgICAgIGZpdEZ1bmN0aW9uID0gKHQpID0+IGEgKyBiICogdDsKICAgIH0KICB9IGVsc2UgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAncG9seW5vbWlhbCcpIHsKICAgIC8vIFBvbHlub21pYWw6IHkgPSBjMCArIGMxKnggKyBjMip4XjIgKyAuLi4gKyBjbip4Xm4KICAgIGNvbnN0IG4gPSB4Lmxlbmd0aDsKICAgIGNvbnN0IG9yZGVyID0gTWF0aC5taW4ocG9seW5vbWlhbE9yZGVyLCBuIC0gMSk7IC8vIENhbid0IGZpdCBvcmRlciA+PSBuIHBvaW50cwogICAgCiAgICAvLyBCdWlsZCBkZXNpZ24gbWF0cml4CiAgICBjb25zdCBYID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCByb3cgPSBbXTsKICAgICAgZm9yIChsZXQgcCA9IG9yZGVyOyBwID49IDA7IHAtLSkgewogICAgICAgIHJvdy5wdXNoKE1hdGgucG93KHhbaV0sIHApKTsKICAgICAgfQogICAgICBYLnB1c2gocm93KTsKICAgIH0KICAgIAogICAgLy8gU29sdmUgdXNpbmcgbm9ybWFsIGVxdWF0aW9uczogKFgnWCleKC0xKVgneQogICAgLy8gU2ltcGxpZmllZCBmb3Igc21hbGwgb3JkZXJzCiAgICBsZXQgY29lZmZzOwogICAgaWYgKG9yZGVyID09PSAxKSB7CiAgICAgIC8vIExpbmVhciBjYXNlCiAgICAgIGNvbnN0IHN1bVggPSB4LnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgICBjb25zdCBzdW1YMiA9IHgucmVkdWNlKChzdW0sIHhpKSA9PiBzdW0gKyB4aSAqIHhpLCAwKTsKICAgICAgY29uc3Qgc3VtWSA9IHkucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICAgIGNvbnN0IHN1bVhZID0geC5yZWR1Y2UoKHN1bSwgeGksIGkpID0+IHN1bSArIHhpICogeVtpXSwgMCk7CiAgICAgIGNvbnN0IGRldCA9IG4gKiBzdW1YMiAtIHN1bVggKiBzdW1YOwogICAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgICAgY29lZmZzID0gW3N1bVkgLyBuLCAwXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBhID0gKHN1bVkgKiBzdW1YMiAtIHN1bVggKiBzdW1YWSkgLyBkZXQ7CiAgICAgICAgY29uc3QgYiA9IChuICogc3VtWFkgLSBzdW1YICogc3VtWSkgLyBkZXQ7CiAgICAgICAgY29lZmZzID0gW2EsIGJdOyAvLyBbYzAsIGMxXQogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBIaWdoZXIgb3JkZXIgLSB1c2Ugc2ltcGxlIGxlYXN0IHNxdWFyZXMgYXBwcm94aW1hdGlvbgogICAgICAvLyBGb3Igc2ltcGxpY2l0eSwgdXNlIGEgYmFzaWMgaW1wbGVtZW50YXRpb24KICAgICAgY29uc3QgbWVhblkgPSB5LnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gbjsKICAgICAgY29lZmZzID0gW21lYW5ZXTsKICAgICAgZm9yIChsZXQgcCA9IDE7IHAgPD0gb3JkZXI7IHArKykgewogICAgICAgIGNvZWZmcy5wdXNoKDApOwogICAgICB9CiAgICB9CiAgICAKICAgIGZpdEZ1bmN0aW9uID0gKHQpID0+IHsKICAgICAgbGV0IHJlc3VsdCA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29lZmZzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVzdWx0ICs9IGNvZWZmc1tpXSAqIE1hdGgucG93KHQsIGNvZWZmcy5sZW5ndGggLSAxIC0gaSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfSBlbHNlIGlmIChyZWdyZXNzaW9uVHlwZSA9PT0gJ2V4cG9uZW50aWFsJykgewogICAgLy8gRXhwb25lbnRpYWw6IHkgPSBhICogZV4oYip4KSBvciB5ID0gYSAqIGJeeAogICAgLy8gVHJhbnNmb3JtIHRvIGxpbmVhcjogbG4oeSkgPSBsbihhKSArIGIqeAogICAgY29uc3QgbG9nWSA9IHkubWFwKHlpID0+IHlpID4gMCA/IE1hdGgubG9nKHlpKSA6IG51bGwpLmZpbHRlcihseSA9PiBseSAhPT0gbnVsbCk7CiAgICBpZiAobG9nWS5sZW5ndGggPCAyKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgCiAgICBjb25zdCBuID0geC5sZW5ndGg7CiAgICBjb25zdCBzdW1YID0geC5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTsKICAgIGNvbnN0IHN1bUxvZ1kgPSBsb2dZLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgY29uc3Qgc3VtWExvZ1kgPSB4LnNsaWNlKDAsIGxvZ1kubGVuZ3RoKS5yZWR1Y2UoKHN1bSwgeGksIGkpID0+IHN1bSArIHhpICogbG9nWVtpXSwgMCk7CiAgICBjb25zdCBzdW1YMiA9IHguc2xpY2UoMCwgbG9nWS5sZW5ndGgpLnJlZHVjZSgoc3VtLCB4aSkgPT4gc3VtICsgeGkgKiB4aSwgMCk7CiAgICAKICAgIGNvbnN0IGRldCA9IGxvZ1kubGVuZ3RoICogc3VtWDIgLSBzdW1YICogc3VtWDsKICAgIGlmIChNYXRoLmFicyhkZXQpIDwgMWUtMTApIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICAKICAgIGNvbnN0IGxuQSA9IChzdW1Mb2dZICogc3VtWDIgLSBzdW1YICogc3VtWExvZ1kpIC8gZGV0OwogICAgY29uc3QgYiA9IChsb2dZLmxlbmd0aCAqIHN1bVhMb2dZIC0gc3VtWCAqIHN1bUxvZ1kpIC8gZGV0OwogICAgY29uc3QgYSA9IE1hdGguZXhwKGxuQSk7CiAgICAKICAgIGZpdEZ1bmN0aW9uID0gKHQpID0+IGEgKiBNYXRoLmV4cChiICogdCk7CiAgfSBlbHNlIGlmIChyZWdyZXNzaW9uVHlwZSA9PT0gJ2xvZ2FyaXRobWljJykgewogICAgLy8gTG9nYXJpdGhtaWM6IHkgPSBhICsgYipsbih4KQogICAgLy8gRmlsdGVyIG91dCBub24tcG9zaXRpdmUgeCB2YWx1ZXMKICAgIGNvbnN0IHZhbGlkSW5kaWNlcyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB4Lmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh4W2ldID4gMCkgewogICAgICAgIHZhbGlkSW5kaWNlcy5wdXNoKGkpOwogICAgICB9CiAgICB9CiAgICAKICAgIGlmICh2YWxpZEluZGljZXMubGVuZ3RoIDwgMikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIAogICAgY29uc3QgbG9nWCA9IHZhbGlkSW5kaWNlcy5tYXAoaSA9PiBNYXRoLmxvZyh4W2ldKSk7CiAgICBjb25zdCB2YWxpZFkgPSB2YWxpZEluZGljZXMubWFwKGkgPT4geVtpXSk7CiAgICBjb25zdCBuID0gdmFsaWRJbmRpY2VzLmxlbmd0aDsKICAgIAogICAgY29uc3Qgc3VtTG9nWCA9IGxvZ1gucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICBjb25zdCBzdW1ZID0gdmFsaWRZLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgY29uc3Qgc3VtTG9nWFkgPSBsb2dYLnJlZHVjZSgoc3VtLCBseGksIGkpID0+IHN1bSArIGx4aSAqIHZhbGlkWVtpXSwgMCk7CiAgICBjb25zdCBzdW1Mb2dYMiA9IGxvZ1gucmVkdWNlKChzdW0sIGx4aSkgPT4gc3VtICsgbHhpICogbHhpLCAwKTsKICAgIAogICAgY29uc3QgZGV0ID0gbiAqIHN1bUxvZ1gyIC0gc3VtTG9nWCAqIHN1bUxvZ1g7CiAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgCiAgICBjb25zdCBhID0gKHN1bVkgKiBzdW1Mb2dYMiAtIHN1bUxvZ1ggKiBzdW1Mb2dYWSkgLyBkZXQ7CiAgICBjb25zdCBiID0gKG4gKiBzdW1Mb2dYWSAtIHN1bUxvZ1ggKiBzdW1ZKSAvIGRldDsKICAgIAogICAgZml0RnVuY3Rpb24gPSAodCkgPT4gdCA+IDAgPyBhICsgYiAqIE1hdGgubG9nKHQpIDogbnVsbDsKICB9IGVsc2UgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAnbW9uby1leHBvbmVudGlhbCcpIHsKICAgIC8vIE1vbm8tZXhwb25lbnRpYWwgcmlzZSB0byBwbGF0ZWF1OiB5KHQpID0gMSArIEEoMSAtIGVeKC1rKHQgLSB04oKAKSkpCiAgICAvLyBGb3Igbm9ybWFsaXplZCBkYXRhLCBiYXNlbGluZSDiiYggMSwgc28gd2UgZml4IHTigoAgPSAwIChvciBmaXJzdCB0aW1lcG9pbnQpCiAgICAvLyB5KHQpID0gMSArIEEoMSAtIGVeKC1rKnQpKQogICAgCiAgICAvLyBGaW5kIHTigoAgYXMgdGhlIGZpcnN0IHRpbWVwb2ludCAob3IgMCBpZiBkYXRhIHN0YXJ0cyBhdCAwKQogICAgY29uc3QgdDAgPSBNYXRoLm1pbiguLi54KTsKICAgIGNvbnN0IHhTaGlmdGVkID0geC5tYXAoeGkgPT4geGkgLSB0MCk7CiAgICAKICAgIC8vIEluaXRpYWwgcGFyYW1ldGVyIGVzdGltYXRlcwogICAgLy8gQTogYW1wbGl0dWRlID0gbWF4KHkpIC0gMSAoc2luY2UgYmFzZWxpbmUgaXMgbm9ybWFsaXplZCB0byAxKQogICAgY29uc3QgeU1heCA9IE1hdGgubWF4KC4uLnkpOwogICAgY29uc3QgeU1pbiA9IE1hdGgubWluKC4uLnkpOwogICAgbGV0IEEgPSBNYXRoLm1heCgwLCB5TWF4IC0gMSk7IC8vIEFtcGxpdHVkZSBzaG91bGQgYmUgcG9zaXRpdmUKICAgIAogICAgLy8gazogcmF0ZSBjb25zdGFudCAtIGVzdGltYXRlIGZyb20gcmlzZSB0aW1lCiAgICAvLyBGaW5kIHRpbWVwb2ludCB3aGVyZSBzaWduYWwgcmVhY2hlcyB+NjMlJSBvZiBhbXBsaXR1ZGUgKDEgLSAxL2Ug4omIIDAuNjMyKQogICAgY29uc3QgdGltZVNwYW4gPSBNYXRoLm1heCguLi54U2hpZnRlZCkgLSBNYXRoLm1pbiguLi54U2hpZnRlZCk7CiAgICBjb25zdCB0YXJnZXRZID0gMSArIEEgKiAwLjYzMjsKICAgIGxldCBrID0gMC4wMTsgLy8gRGVmYXVsdCBpbml0aWFsIGd1ZXNzCiAgICBpZiAoQSA+IDAuMDEgJiYgdGltZVNwYW4gPiAwKSB7CiAgICAgIC8vIEZpbmQgY2xvc2VzdCBwb2ludCB0byB0YXJnZXQKICAgICAgbGV0IGNsb3Nlc3RJZHggPSAwOwogICAgICBsZXQgbWluRGlmZiA9IE1hdGguYWJzKHlbMF0gLSB0YXJnZXRZKTsKICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCB5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgZGlmZiA9IE1hdGguYWJzKHlbaV0gLSB0YXJnZXRZKTsKICAgICAgICBpZiAoZGlmZiA8IG1pbkRpZmYpIHsKICAgICAgICAgIG1pbkRpZmYgPSBkaWZmOwogICAgICAgICAgY2xvc2VzdElkeCA9IGk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEVzdGltYXRlIGsgZnJvbTogMSAtIGVeKC1rKnQpID0gMC42MzIgPT4gayDiiYggMS90CiAgICAgIGlmICh4U2hpZnRlZFtjbG9zZXN0SWR4XSA+IDApIHsKICAgICAgICBrID0gMSAvIHhTaGlmdGVkW2Nsb3Nlc3RJZHhdOwogICAgICAgIGsgPSBNYXRoLm1heCgxZS02LCBNYXRoLm1pbigxMCwgaykpOyAvLyBCb3VuZCBiZXR3ZWVuIDFlLTYgYW5kIDEwCiAgICAgIH0KICAgIH0KICAgIAogICAgLy8gVXNlIHNpbXBsZSBpdGVyYXRpdmUgbm9ubGluZWFyIGxlYXN0IHNxdWFyZXMgKEdhdXNzLU5ld3RvbikKICAgIC8vIE1pbmltaXplIHN1bSBvZiBzcXVhcmVkIHJlc2lkdWFsczogzqMoeSAtICgxICsgQSgxIC0gZV4oLWsqdCkpKSnCsgogICAgY29uc3QgbWF4SXRlcmF0aW9ucyA9IDEwMDsKICAgIGNvbnN0IHRvbGVyYW5jZSA9IDFlLTY7CiAgICAKICAgIGZvciAobGV0IGl0ZXIgPSAwOyBpdGVyIDwgbWF4SXRlcmF0aW9uczsgaXRlcisrKSB7CiAgICAgIC8vIENhbGN1bGF0ZSByZXNpZHVhbHMgYW5kIEphY29iaWFuCiAgICAgIGxldCBzdW1SZXNpZHVhbCA9IDA7CiAgICAgIGxldCBzdW1SZXNpZHVhbEEgPSAwOwogICAgICBsZXQgc3VtUmVzaWR1YWxLID0gMDsKICAgICAgbGV0IHN1bUpBQSA9IDA7CiAgICAgIGxldCBzdW1KQUsgPSAwOwogICAgICBsZXQgc3VtSktLID0gMDsKICAgICAgCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgeFNoaWZ0ZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB0ID0geFNoaWZ0ZWRbaV07CiAgICAgICAgY29uc3QgeU9icyA9IHlbaV07CiAgICAgICAgY29uc3QgeVByZWQgPSAxICsgQSAqICgxIC0gTWF0aC5leHAoLWsgKiB0KSk7CiAgICAgICAgY29uc3QgcmVzaWR1YWwgPSB5T2JzIC0geVByZWQ7CiAgICAgICAgCiAgICAgICAgLy8gUGFydGlhbCBkZXJpdmF0aXZlcwogICAgICAgIGNvbnN0IGRBID0gMSAtIE1hdGguZXhwKC1rICogdCk7CiAgICAgICAgY29uc3QgZEsgPSBBICogdCAqIE1hdGguZXhwKC1rICogdCk7CiAgICAgICAgCiAgICAgICAgc3VtUmVzaWR1YWwgKz0gcmVzaWR1YWw7CiAgICAgICAgc3VtUmVzaWR1YWxBICs9IHJlc2lkdWFsICogZEE7CiAgICAgICAgc3VtUmVzaWR1YWxLICs9IHJlc2lkdWFsICogZEs7CiAgICAgICAgc3VtSkFBICs9IGRBICogZEE7CiAgICAgICAgc3VtSkFLICs9IGRBICogZEs7CiAgICAgICAgc3VtSktLICs9IGRLICogZEs7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIFNvbHZlIG5vcm1hbCBlcXVhdGlvbnM6IEpeVCAqIEogKiBkZWx0YSA9IEpeVCAqIHJlc2lkdWFsCiAgICAgIGNvbnN0IGRldCA9IHN1bUpBQSAqIHN1bUpLSyAtIHN1bUpBSyAqIHN1bUpBSzsKICAgICAgaWYgKE1hdGguYWJzKGRldCkgPCAxZS0xMCkgYnJlYWs7CiAgICAgIAogICAgICBjb25zdCBkZWx0YUEgPSAoc3VtUmVzaWR1YWxBICogc3VtSktLIC0gc3VtUmVzaWR1YWxLICogc3VtSkFLKSAvIGRldDsKICAgICAgY29uc3QgZGVsdGFLID0gKHN1bVJlc2lkdWFsSyAqIHN1bUpBQSAtIHN1bVJlc2lkdWFsQSAqIHN1bUpBSykgLyBkZXQ7CiAgICAgIAogICAgICAvLyBVcGRhdGUgcGFyYW1ldGVycyB3aXRoIGRhbXBpbmcKICAgICAgY29uc3QgZGFtcGluZyA9IDAuNTsKICAgICAgQSA9IE1hdGgubWF4KDAsIEEgKyBkYW1waW5nICogZGVsdGFBKTsKICAgICAgayA9IE1hdGgubWF4KDFlLTYsIE1hdGgubWluKDEwLCBrICsgZGFtcGluZyAqIGRlbHRhSykpOwogICAgICAKICAgICAgLy8gSWYgcGFyYW1ldGVycyBkaWRuJ3QgY2hhbmdlIG11Y2gsIHdlJ3JlIGRvbmUKICAgICAgaWYgKE1hdGguYWJzKGRlbHRhQSkgPCB0b2xlcmFuY2UgJiYgTWF0aC5hYnMoZGVsdGFLKSA8IHRvbGVyYW5jZSkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICAKICAgIC8vIFN0b3JlIHBhcmFtZXRlcnMgZm9yIGluZm8gcGFuZWwKICAgIGNvbnN0IHRhdSA9IDEgLyBrOyAvLyB0aW1lIGNvbnN0YW50CiAgICBjb25zdCB0SGFsZiA9IE1hdGgubG9nKDIpIC8gazsgLy8gaGFsZi10aW1lCiAgICBjb25zdCBwbGF0ZWF1ID0gMSArIEE7IC8vIHBsYXRlYXUgdmFsdWUKICAgIAogICAgLy8gQ3JlYXRlIGZpdCBmdW5jdGlvbgogICAgZml0RnVuY3Rpb24gPSAodCkgPT4gewogICAgICBjb25zdCB0U2hpZnRlZCA9IHQgLSB0MDsKICAgICAgaWYgKHRTaGlmdGVkIDwgMCkgcmV0dXJuIDE7IC8vIEJlZm9yZSBhY3RpdmF0aW9uCiAgICAgIHJldHVybiAxICsgQSAqICgxIC0gTWF0aC5leHAoLWsgKiB0U2hpZnRlZCkpOwogICAgfTsKICAgIAogICAgLy8gQXR0YWNoIHBhcmFtZXRlcnMgdG8gZnVuY3Rpb24gZm9yIGluZm8gcGFuZWwKICAgIGZpdEZ1bmN0aW9uLnBhcmFtcyA9IHsKICAgICAgQTogQSwKICAgICAgazogaywKICAgICAgdDA6IHQwLAogICAgICB0YXU6IHRhdSwKICAgICAgdEhhbGY6IHRIYWxmLAogICAgICBwbGF0ZWF1OiBwbGF0ZWF1CiAgICB9OwogIH0gZWxzZSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgcmV0dXJuIGZpdEZ1bmN0aW9uOwp9CgpmdW5jdGlvbiBub3JtYWxpemVNZWFuQW5kRXJyb3IodGltZVBvaW50cywgbWVhbnMsIGVycm9ycywgYmFzZWxpbmVFbmRUaW1lID0gMjQsIGN1dG9mZlRpbWUgPSAzNjApIHsKICAvLyBOb3JtYWxpemUgbWVhbiBhbmQgZXJyb3IgZGF0YTogY2FsY3VsYXRlIGJhc2VsaW5lIGZyb20gMC1iYXNlbGluZUVuZFRpbWUsIHRoZW4gcGxvdCBvbmx5IHBvaW50cyBhZnRlciBiYXNlbGluZUVuZFRpbWUKICAvLyBkaXZpZGVkIGJ5IGJhc2VsaW5lLCB1cCB0byBjdXRvZmZUaW1lLiBCYXNlbGluZSBwZXJpb2QgaXMgTk9UIGluY2x1ZGVkIGluIHRoZSBwbG90LgogIC8vIFJldHVybnMgeyBmaWx0ZXJlZFRpbWVQb2ludHMsIG5vcm1hbGl6ZWRNZWFucywgbm9ybWFsaXplZEVycm9ycyB9IC0gZmlsdGVyZWQgYXJyYXlzCiAgLy8gRmlyc3QgY2FsY3VsYXRlIGJhc2VsaW5lIGZyb20gbWVhbnMKICBjb25zdCBiYXNlbGluZVZhbHVlcyA9IFtdOwogIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZVBvaW50cy5sZW5ndGg7IGkrKykgewogICAgaWYgKHRpbWVQb2ludHNbaV0gIT09IG51bGwgJiYgbWVhbnNbaV0gIT09IG51bGwgJiYgdGltZVBvaW50c1tpXSA8PSBiYXNlbGluZUVuZFRpbWUpIHsKICAgICAgYmFzZWxpbmVWYWx1ZXMucHVzaChtZWFuc1tpXSk7CiAgICB9CiAgfQogIAogIGlmIChiYXNlbGluZVZhbHVlcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB7IGZpbHRlcmVkVGltZVBvaW50czogdGltZVBvaW50cywgbm9ybWFsaXplZE1lYW5zOiBtZWFucywgbm9ybWFsaXplZEVycm9yczogZXJyb3JzIH07CiAgfQogIAogIGNvbnN0IGJhc2VsaW5lID0gYmFzZWxpbmVWYWx1ZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyBiYXNlbGluZVZhbHVlcy5sZW5ndGg7CiAgCiAgaWYgKGJhc2VsaW5lID09PSAwKSB7CiAgICByZXR1cm4geyBmaWx0ZXJlZFRpbWVQb2ludHM6IHRpbWVQb2ludHMsIG5vcm1hbGl6ZWRNZWFuczogbWVhbnMsIG5vcm1hbGl6ZWRFcnJvcnM6IGVycm9ycyB9OwogIH0KICAKICAvLyBGaWx0ZXIgYW5kIG5vcm1hbGl6ZTogb25seSBpbmNsdWRlIHBvaW50cyB3aGVyZSBiYXNlbGluZUVuZFRpbWUgPCB0aW1lIDw9IGN1dG9mZlRpbWUKICBjb25zdCBmaWx0ZXJlZFRpbWVQb2ludHMgPSBbXTsKICBjb25zdCBub3JtYWxpemVkTWVhbnMgPSBbXTsKICBjb25zdCBub3JtYWxpemVkRXJyb3JzID0gW107CiAgCiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aW1lUG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCB0aW1lID0gdGltZVBvaW50c1tpXTsKICAgIGNvbnN0IG1lYW4gPSBtZWFuc1tpXTsKICAgIGNvbnN0IGVycm9yID0gZXJyb3JzW2ldOwogICAgCiAgICBpZiAodGltZSA9PT0gbnVsbCB8fCBtZWFuID09PSBudWxsKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQogICAgCiAgICAvLyBPbmx5IGluY2x1ZGUgcG9pbnRzIGFmdGVyIGJhc2VsaW5lRW5kVGltZSBhbmQgdXAgdG8gY3V0b2ZmVGltZSAoYmFzZWxpbmUgTk9UIGluY2x1ZGVkKQogICAgaWYgKHRpbWUgPiBiYXNlbGluZUVuZFRpbWUgJiYgdGltZSA8PSBjdXRvZmZUaW1lKSB7CiAgICAgIC8vIFN1YnRyYWN0IGJhc2VsaW5lRW5kVGltZSB0byBicmluZyBmaXJzdCBwb2ludCB0byB4PTAgKHRpbWUgYWZ0ZXIgaW5qZWN0aW9uKQogICAgICBmaWx0ZXJlZFRpbWVQb2ludHMucHVzaCh0aW1lIC0gYmFzZWxpbmVFbmRUaW1lKTsKICAgICAgbm9ybWFsaXplZE1lYW5zLnB1c2gobWVhbiAvIGJhc2VsaW5lKTsKICAgICAgLy8gRXJyb3JzIHNjYWxlIHByb3BvcnRpb25hbGx5CiAgICAgIG5vcm1hbGl6ZWRFcnJvcnMucHVzaChlcnJvciAhPT0gbnVsbCA/IGVycm9yIC8gYmFzZWxpbmUgOiBudWxsKTsKICAgIH0KICB9CiAgCiAgcmV0dXJuIHsgZmlsdGVyZWRUaW1lUG9pbnRzLCBub3JtYWxpemVkTWVhbnMsIG5vcm1hbGl6ZWRFcnJvcnMgfTsKfQoKZnVuY3Rpb24gdXBkYXRlQ2hhcnQoKSB7CiAgLy8gR3VhcmQ6IGVuc3VyZSB2aWV3ZXJEYXRhIGlzIGxvYWRlZAogIGlmICghdmlld2VyRGF0YSB8fCAhYWxsV2VsbHNEYXRhIHx8IE9iamVjdC5rZXlzKGFsbFdlbGxzRGF0YSkubGVuZ3RoID09PSAwKSB7CiAgICBjb25zb2xlLndhcm4oInZpZXdlckRhdGEgbm90IGxvYWRlZCB5ZXQsIHNraXBwaW5nIGNoYXJ0IHVwZGF0ZSIpOwogICAgcmV0dXJuOwogIH0KICAKICBjb25zdCBjdHggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgid2VsbC1jaGFydCIpLmdldENvbnRleHQoIjJkIik7CgogIC8vIFNURVAgMDogQmFzZWxpbmUgc3VidHJhY3Rpb24KICBjb25zdCBiYXNlbGluZVN1YnRyYWN0VG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJhc2VsaW5lLXN1YnRyYWN0LXRvZ2dsZSIpOwogIGNvbnN0IGJhc2VsaW5lU3VidHJhY3QgPSBiYXNlbGluZVN1YnRyYWN0VG9nZ2xlID8gYmFzZWxpbmVTdWJ0cmFjdFRvZ2dsZS5jaGVja2VkIDogZmFsc2U7CiAgY29uc3QgYmFzZWxpbmVTdWJ0cmFjdE1vZGVTZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtc3VidHJhY3QtbW9kZSIpOwogIGNvbnN0IGJhc2VsaW5lU3VidHJhY3RNb2RlID0gYmFzZWxpbmVTdWJ0cmFjdE1vZGVTZWxlY3QgPyBiYXNlbGluZVN1YnRyYWN0TW9kZVNlbGVjdC52YWx1ZSA6ICJsb3dlc3RfcG9pbnQiOwogIGNvbnN0IGJhc2VsaW5lU3VidHJhY3RFbmRJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJiYXNlbGluZS1zdWJ0cmFjdC1lbmQtdGltZSIpOwogIGNvbnN0IGJhc2VsaW5lU3VidHJhY3RFbmRUaW1lID0gYmFzZWxpbmVTdWJ0cmFjdEVuZElucHV0ID8gcGFyc2VGbG9hdChiYXNlbGluZVN1YnRyYWN0RW5kSW5wdXQudmFsdWUpIHx8IDI0IDogMjQ7CiAgCiAgLy8gU1RFUCAxOiBOb3JtYWxpemF0aW9uIHVzaW5nIGZpdHRlZCBiYXNlbGluZQogIGNvbnN0IG5vcm1hbGl6ZUJhc2VsaW5lVG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm5vcm1hbGl6ZS1iYXNlbGluZS10b2dnbGUiKTsKICBjb25zdCBub3JtYWxpemVCYXNlbGluZSA9IG5vcm1hbGl6ZUJhc2VsaW5lVG9nZ2xlID8gbm9ybWFsaXplQmFzZWxpbmVUb2dnbGUuY2hlY2tlZCA6IGZhbHNlOwogIAogIC8vIFNURVAgMjogVHJpcGxpY2F0ZSBncm91cGluZyAocmVxdWlyZXMgU3RlcCAwIE9SIFN0ZXAgMSkKICBjb25zdCBncm91cFRyaXBsaWNhdGVzVG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImdyb3VwLXRyaXBsaWNhdGVzLXRvZ2dsZSIpOwogIGNvbnN0IGdyb3VwVHJpcGxpY2F0ZXMgPSBncm91cFRyaXBsaWNhdGVzVG9nZ2xlID8gZ3JvdXBUcmlwbGljYXRlc1RvZ2dsZS5jaGVja2VkIDogZmFsc2U7CiAgY29uc3Qgc3RlcDBPclN0ZXAxRW5hYmxlZCA9IGJhc2VsaW5lU3VidHJhY3QgfHwgbm9ybWFsaXplQmFzZWxpbmU7CiAgaWYgKGdyb3VwVHJpcGxpY2F0ZXMgJiYgIXN0ZXAwT3JTdGVwMUVuYWJsZWQpIHsKICAgIGlmIChncm91cFRyaXBsaWNhdGVzVG9nZ2xlKSB7CiAgICAgIGdyb3VwVHJpcGxpY2F0ZXNUb2dnbGUuY2hlY2tlZCA9IGZhbHNlOwogICAgfQogICAgZ3JvdXBUcmlwbGljYXRlcyA9IGZhbHNlOwogIH0KICAKICAvLyBTaG93L2hpZGUgU3RlcCAwIChiYXNlbGluZSBzdWJ0cmFjdGlvbikgcGFyYW1ldGVycwogIGNvbnN0IGJhc2VsaW5lU3VidHJhY3RQYXJhbXNEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtc3VidHJhY3QtcGFyYW1ldGVycyIpOwogIGlmIChiYXNlbGluZVN1YnRyYWN0UGFyYW1zRGl2ICYmIGJhc2VsaW5lU3VidHJhY3RUb2dnbGUpIHsKICAgIGJhc2VsaW5lU3VidHJhY3RQYXJhbXNEaXYuc3R5bGUuZGlzcGxheSA9IGJhc2VsaW5lU3VidHJhY3QgPyAiYmxvY2siIDogIm5vbmUiOwogIH0KICAKICAvLyBMZWdhY3kgIlN0ZXAgMCI6IHNob3cgaW5kaXZpZHVhbCB3ZWxscyB3aGVuIE5PIG90aGVyIHByb2Nlc3NpbmcgKDEtMikgZW5hYmxlZAogIGNvbnN0IHNob3dJbmRpdmlkdWFsV2VsbHNUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic2hvdy1pbmRpdmlkdWFsLXdlbGxzLXRvZ2dsZSIpOwogIGNvbnN0IHN0ZXAwUmVxdWVzdGVkID0gc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZSA/IHNob3dJbmRpdmlkdWFsV2VsbHNUb2dnbGUuY2hlY2tlZCA6IHRydWU7CiAgY29uc3QgYW55UHJvY2Vzc2luZ1N0ZXBFbmFibGVkID0gYmFzZWxpbmVTdWJ0cmFjdCB8fCBub3JtYWxpemVCYXNlbGluZSB8fCBncm91cFRyaXBsaWNhdGVzOwogIC8vIFNob3cgU3RlcCAwIGlmIHJlcXVlc3RlZCBBTkQgbm8gb3RoZXIgc3RlcHMgZW5hYmxlZAogIC8vIElmIG5vIHN0ZXBzIGFyZSBlbmFibGVkIGF0IGFsbCwgZGVmYXVsdCB0byBzaG93aW5nIFN0ZXAgMCAocmF3IGRhdGEpIGFzIGZhbGxiYWNrCiAgY29uc3Qgc2hvd0luZGl2aWR1YWxXZWxscyA9IChzdGVwMFJlcXVlc3RlZCAmJiAhYW55UHJvY2Vzc2luZ1N0ZXBFbmFibGVkKSB8fCAoIWFueVByb2Nlc3NpbmdTdGVwRW5hYmxlZCk7CiAgCiAgLy8gU2hvdy9oaWRlIFN0ZXAgMCB3YXJuaW5nCiAgY29uc3Qgc3RlcDBXYXJuaW5nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInN0ZXAwLXdhcm5pbmciKTsKICBpZiAoc3RlcDBXYXJuaW5nKSB7CiAgICBzdGVwMFdhcm5pbmcuc3R5bGUuZGlzcGxheSA9IChzdGVwMFJlcXVlc3RlZCAmJiBhbnlQcm9jZXNzaW5nU3RlcEVuYWJsZWQpID8gImJsb2NrIiA6ICJub25lIjsKICB9CiAgCiAgLy8gRGlzYWJsZSBTdGVwIDAgY2hlY2tib3ggaWYgb3RoZXIgc3RlcHMgKDEtMikgYXJlIGVuYWJsZWQgKHZpc3VhbCBmZWVkYmFjaykKICBpZiAoc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZSkgewogICAgc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZS5kaXNhYmxlZCA9IGFueVByb2Nlc3NpbmdTdGVwRW5hYmxlZDsKICB9CiAgCiAgLy8gR2V0IG5vcm1hbGl6YXRpb24gYmFzZWxpbmUgcGFyYW1ldGVycwogIGNvbnN0IG5vcm1hbGl6ZUJhc2VsaW5lRW5kSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibm9ybWFsaXplLWJhc2VsaW5lLWVuZC10aW1lIik7CiAgY29uc3Qgbm9ybWFsaXplQmFzZWxpbmVFbmRUaW1lID0gbm9ybWFsaXplQmFzZWxpbmVFbmRJbnB1dCA/IHBhcnNlRmxvYXQobm9ybWFsaXplQmFzZWxpbmVFbmRJbnB1dC52YWx1ZSkgfHwgMjQgOiAyNDsKICAvLyBCYXNlbGluZSBlbmQgdXNlZCBmb3IgU3RlcCAwIGFuZCBmb3IgY3V0b2ZmOiBwcmVmZXIgU3RlcCAxJ3Mgd2hlbiBib3RoIGVuYWJsZWQKICBjb25zdCBwcm9jZXNzaW5nQmFzZWxpbmVFbmQgPSBub3JtYWxpemVCYXNlbGluZSA/IG5vcm1hbGl6ZUJhc2VsaW5lRW5kVGltZSA6IChiYXNlbGluZVN1YnRyYWN0ID8gYmFzZWxpbmVTdWJ0cmFjdEVuZFRpbWUgOiAyNCk7CiAgCiAgLy8gR2V0IGJhc2VsaW5lIGZpdHRpbmcgbWV0aG9kIGFuZCBwYXJhbWV0ZXJzCiAgY29uc3QgYmFzZWxpbmVNZXRob2RTZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtbWV0aG9kLXNlbGVjdCIpOwogIGNvbnN0IGJhc2VsaW5lTWV0aG9kID0gYmFzZWxpbmVNZXRob2RTZWxlY3QgPyBiYXNlbGluZU1ldGhvZFNlbGVjdC52YWx1ZSA6ICJsb3dlc3MiOwogIGNvbnN0IGJhc2VsaW5lRnJhY0lucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJhc2VsaW5lLWZyYWMtaW5wdXQiKTsKICBjb25zdCBiYXNlbGluZUZyYWMgPSBiYXNlbGluZUZyYWNJbnB1dCA/IHBhcnNlRmxvYXQoYmFzZWxpbmVGcmFjSW5wdXQudmFsdWUpIHx8IDAuNSA6IDAuNTsKICBjb25zdCBiYXNlbGluZVBvbHlPcmRlcklucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJhc2VsaW5lLXBvbHktb3JkZXItaW5wdXQiKTsKICBjb25zdCBiYXNlbGluZVBvbHlPcmRlciA9IGJhc2VsaW5lUG9seU9yZGVySW5wdXQgPyBwYXJzZUludChiYXNlbGluZVBvbHlPcmRlcklucHV0LnZhbHVlKSB8fCAxIDogMTsKICAKICAvLyBHZXQgbm9ybWFsaXphdGlvbiBtb2RlCiAgY29uc3Qgbm9ybWFsaXphdGlvbk1vZGVTZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibm9ybWFsaXphdGlvbi1tb2RlLXNlbGVjdCIpOwogIGNvbnN0IG5vcm1hbGl6YXRpb25Nb2RlID0gbm9ybWFsaXphdGlvbk1vZGVTZWxlY3QgPyBub3JtYWxpemF0aW9uTW9kZVNlbGVjdC52YWx1ZSA6ICJkZWx0YV9mX292ZXJfZiI7CiAgCiAgLy8gU2hvdy9oaWRlIG5vcm1hbGl6YXRpb24gYmFzZWxpbmUgcGFyYW1ldGVycwogIGNvbnN0IG5vcm1hbGl6ZUJhc2VsaW5lUGFyYW1ldGVyc0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJub3JtYWxpemUtYmFzZWxpbmUtcGFyYW1ldGVycyIpOwogIGlmIChub3JtYWxpemVCYXNlbGluZVBhcmFtZXRlcnNEaXYgJiYgbm9ybWFsaXplQmFzZWxpbmVUb2dnbGUpIHsKICAgIG5vcm1hbGl6ZUJhc2VsaW5lUGFyYW1ldGVyc0Rpdi5zdHlsZS5kaXNwbGF5ID0gbm9ybWFsaXplQmFzZWxpbmUgPyAiYmxvY2siIDogIm5vbmUiOwogIH0KICAKICAvLyBTVEVQIDM6IENoZWNrIGlmIGN1dG9mZiBpcyBlbmFibGVkCiAgY29uc3QgY3V0b2ZmQmFzZWxpbmVUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3V0b2ZmLWJhc2VsaW5lLXRvZ2dsZSIpOwogIGNvbnN0IGN1dG9mZkJhc2VsaW5lID0gY3V0b2ZmQmFzZWxpbmVUb2dnbGUgPyBjdXRvZmZCYXNlbGluZVRvZ2dsZS5jaGVja2VkIDogZmFsc2U7CiAgY29uc3QgY3V0b2ZmQmFzZWxpbmVUaW1lSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3V0b2ZmLWJhc2VsaW5lLXRpbWUiKTsKICBjb25zdCBjdXRvZmZCYXNlbGluZVRpbWUgPSBjdXRvZmZCYXNlbGluZVRpbWVJbnB1dCA/IHBhcnNlRmxvYXQoY3V0b2ZmQmFzZWxpbmVUaW1lSW5wdXQudmFsdWUpIHx8IDM2MCA6IDM2MDsKICAKICAvLyBTaG93L2hpZGUgY3V0b2ZmIHBhcmFtZXRlcnMKICBjb25zdCBjdXRvZmZCYXNlbGluZVBhcmFtZXRlcnNEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3V0b2ZmLWJhc2VsaW5lLXBhcmFtZXRlcnMiKTsKICBpZiAoY3V0b2ZmQmFzZWxpbmVQYXJhbWV0ZXJzRGl2ICYmIGN1dG9mZkJhc2VsaW5lVG9nZ2xlKSB7CiAgICBjdXRvZmZCYXNlbGluZVBhcmFtZXRlcnNEaXYuc3R5bGUuZGlzcGxheSA9IGN1dG9mZkJhc2VsaW5lID8gImJsb2NrIiA6ICJub25lIjsKICB9CiAgCiAgLy8gU1RFUCA0OiBDaGVjayBpZiByZWdyZXNzaW9uIGlzIGVuYWJsZWQKICBjb25zdCBmaXRSZWdyZXNzaW9uVG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZpdC1yZWdyZXNzaW9uLXRvZ2dsZSIpOwogIGNvbnN0IGZpdFJlZ3Jlc3Npb24gPSBmaXRSZWdyZXNzaW9uVG9nZ2xlID8gZml0UmVncmVzc2lvblRvZ2dsZS5jaGVja2VkIDogZmFsc2U7CiAgY29uc3QgcmVncmVzc2lvblR5cGVTZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi10eXBlLXNlbGVjdCIpOwogIGNvbnN0IHJlZ3Jlc3Npb25UeXBlID0gcmVncmVzc2lvblR5cGVTZWxlY3QgPyByZWdyZXNzaW9uVHlwZVNlbGVjdC52YWx1ZSA6ICJtb25vLWV4cG9uZW50aWFsIjsKICBjb25zdCBwb2x5bm9taWFsT3JkZXJJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwb2x5bm9taWFsLW9yZGVyLWlucHV0Iik7CiAgY29uc3QgcG9seW5vbWlhbE9yZGVyID0gcG9seW5vbWlhbE9yZGVySW5wdXQgPyBwYXJzZUludChwb2x5bm9taWFsT3JkZXJJbnB1dC52YWx1ZSkgfHwgMiA6IDI7CiAgCiAgLy8gU2hvdy9oaWRlIHJlZ3Jlc3Npb24gcGFyYW1ldGVycwogIGNvbnN0IGZpdFJlZ3Jlc3Npb25QYXJhbWV0ZXJzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZpdC1yZWdyZXNzaW9uLXBhcmFtZXRlcnMiKTsKICBpZiAoZml0UmVncmVzc2lvblBhcmFtZXRlcnNEaXYgJiYgZml0UmVncmVzc2lvblRvZ2dsZSkgewogICAgZml0UmVncmVzc2lvblBhcmFtZXRlcnNEaXYuc3R5bGUuZGlzcGxheSA9IGZpdFJlZ3Jlc3Npb24gPyAiYmxvY2siIDogIm5vbmUiOwogIH0KICAKICAvLyBVcGRhdGUgcmVncmVzc2lvbiB0eXBlIHBhcmFtcyB0byBzaG93L2hpZGUgaW5mbyBwYW5lbCB3aGVuIHJlZ3Jlc3Npb24gaXMgdG9nZ2xlZAogIGlmIChmaXRSZWdyZXNzaW9uKSB7CiAgICB1cGRhdGVSZWdyZXNzaW9uVHlwZVBhcmFtcyh0cnVlKTsgLy8gU2tpcCBjaGFydCB1cGRhdGUgc2luY2Ugd2UncmUgYWxyZWFkeSB1cGRhdGluZwogIH0gZWxzZSB7CiAgICAvLyBIaWRlIGluZm8gcGFuZWwgd2hlbiByZWdyZXNzaW9uIGlzIGRpc2FibGVkCiAgICBjb25zdCBpbmZvUGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi1pbmZvLXBhbmVsIik7CiAgICBpZiAoaW5mb1BhbmVsKSB7CiAgICAgIGluZm9QYW5lbC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgfQogIH0KCiAgaWYgKHNlbGVjdGVkV2VsbHMuc2l6ZSA9PT0gMCkgewogICAgLy8gQ2xlYXIgdGhlIGNoYXJ0IGlmIG5vIHdlbGxzIHNlbGVjdGVkCiAgICAvLyBEZXRlcm1pbmUgeS1heGlzIGxhYmVsIGJhc2VkIG9uIHByb2Nlc3Npbmcgc3RlcHMKICAgIGxldCB5QXhpc0xhYmVsID0gIkZsdW9yZXNjZW5jZSAoRkkpIjsKICAgIGlmIChiYXNlbGluZVN1YnRyYWN0ICYmIG5vcm1hbGl6ZUJhc2VsaW5lKSB7CiAgICAgIHlBeGlzTGFiZWwgPSAizpRGL0YgKE5vcm1hbGl6ZWQpIjsKICAgIH0gZWxzZSBpZiAobm9ybWFsaXplQmFzZWxpbmUpIHsKICAgICAgaWYgKG5vcm1hbGl6YXRpb25Nb2RlID09PSAnbm9uZScpIHsKICAgICAgICB5QXhpc0xhYmVsID0gIkZsdW9yZXNjZW5jZSAoRkkpIjsKICAgICAgfSBlbHNlIGlmIChub3JtYWxpemF0aW9uTW9kZSA9PT0gJ2RlbHRhX2Zfb3Zlcl9mJykgewogICAgICAgIHlBeGlzTGFiZWwgPSAizpRGL0YgKE5vcm1hbGl6ZWQpIjsKICAgICAgfSBlbHNlIGlmIChub3JtYWxpemF0aW9uTW9kZSA9PT0gJ2xvd2VzdF9wb2ludCcpIHsKICAgICAgICB5QXhpc0xhYmVsID0gIkYvRl9taW4gKE5vcm1hbGl6ZWQpIjsKICAgICAgfSBlbHNlIGlmIChub3JtYWxpemF0aW9uTW9kZSA9PT0gJ2ZpcnN0X3BvaW50JykgewogICAgICAgIHlBeGlzTGFiZWwgPSAiRi9GX2ZpcnN0IChOb3JtYWxpemVkKSI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgeUF4aXNMYWJlbCA9ICJGL0bigoAgKE5vcm1hbGl6ZWQpIjsKICAgICAgfQogICAgfSBlbHNlIGlmIChiYXNlbGluZVN1YnRyYWN0KSB7CiAgICAgIHlBeGlzTGFiZWwgPSAizpRGIChGSSkiOwogICAgfQogICAgaWYgKGNoYXJ0KSB7CiAgICAgIC8vIFRyYW5zZm9ybSBleGlzdGluZyBjaGFydAogICAgICBjaGFydC5kYXRhLmRhdGFzZXRzID0gW107CiAgICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLngudGl0bGUudGV4dCA9ICJUaW1lIChzKSI7CiAgICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLnkudGl0bGUudGV4dCA9IHlBeGlzTGFiZWw7CiAgICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLnkubWluID0gdW5kZWZpbmVkOwogICAgICBjaGFydC5vcHRpb25zLnBsdWdpbnMudGl0bGUudGV4dCA9ICJTZWxlY3Qgd2VsbHMgdG8gZGlzcGxheSBkYXRhIjsKICAgICAgY2hhcnQudXBkYXRlKCdub25lJyk7IC8vIFVwZGF0ZSB3aXRob3V0IGFuaW1hdGlvbgogICAgfSBlbHNlIHsKICAgICAgLy8gQ3JlYXRlIG5ldyBjaGFydCBvbmx5IGlmIGl0IGRvZXNuJ3QgZXhpc3QKICAgICAgY2hhcnQgPSBuZXcgQ2hhcnQoY3R4LCB7CiAgICAgICAgdHlwZTogImxpbmUiLAogICAgICAgIGRhdGE6IHsgZGF0YXNldHM6IFtdIH0sCiAgICAgICAgb3B0aW9uczogewogICAgICAgICAgcmVzcG9uc2l2ZTogdHJ1ZSwKICAgICAgICAgIG1haW50YWluQXNwZWN0UmF0aW86IGZhbHNlLAogICAgICAgICAgc2NhbGVzOiB7CiAgICAgICAgICAgIHg6IHsgCiAgICAgICAgICAgICAgdHlwZTogImxpbmVhciIsIAogICAgICAgICAgICAgIHRpdGxlOiB7IGRpc3BsYXk6IHRydWUsIHRleHQ6ICJUaW1lIChzKSIgfSAKICAgICAgICAgICAgfSwKICAgICAgICAgICAgeTogeyAKICAgICAgICAgICAgICB0aXRsZTogeyBkaXNwbGF5OiB0cnVlLCB0ZXh0OiB5QXhpc0xhYmVsIH0sCiAgICAgICAgICAgICAgbWluOiB1bmRlZmluZWQKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIHBsdWdpbnM6IHsKICAgICAgICAgICAgbGVnZW5kOiB7IGRpc3BsYXk6IGZhbHNlIH0sCiAgICAgICAgICAgIHRpdGxlOiB7IGRpc3BsYXk6IHRydWUsIHRleHQ6ICJTZWxlY3Qgd2VsbHMgdG8gZGlzcGxheSBkYXRhIiB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIHJldHVybjsKICB9CgogIGNvbnN0IGRhdGFzZXRzID0gW107CiAgY29uc3QgY29sb3JzID0gWwogICAgInJnYmEoNTQsIDE2MiwgMjM1LCAxLjApIiwKICAgICJyZ2JhKDI1NSwgOTksIDEzMiwgMS4wKSIsCiAgICAicmdiYSgyNTUsIDIwNiwgODYsIDEuMCkiLAogICAgInJnYmEoNzUsIDE5MiwgMTkyLCAxLjApIiwKICAgICJyZ2JhKDE1MywgMTAyLCAyNTUsIDEuMCkiLAogICAgInJnYmEoMjU1LCAxNTksIDY0LCAxLjApIiwKICAgICJyZ2JhKDE5OSwgMTk5LCAxOTksIDEuMCkiLAogICAgInJnYmEoODMsIDEwMiwgMjU1LCAxLjApIgogIF07CiAgCiAgbGV0IGNvbG9ySWR4ID0gMDsKICAKICAvLyBTVEVQIDA6IEFkZCBpbmRpdmlkdWFsIHdlbGxzIChyYXcgZGF0YSwgYmVmb3JlIGFueSBwcm9jZXNzaW5nKSBpZiBlbmFibGVkCiAgaWYgKHNob3dJbmRpdmlkdWFsV2VsbHMpIHsKICAgIEFycmF5LmZyb20oc2VsZWN0ZWRXZWxscykuZm9yRWFjaChrZXkgPT4gewogICAgICBjb25zdCBbcGxhdGVJZCwgd2VsbElkXSA9IGtleS5zcGxpdCgiOiIpOwogICAgICBjb25zdCBjb2x1bW4gPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAgIAogICAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZENvbHVtbnMgaWYgYW55IGFyZSBzZXQgKHNjaWVudGlzdC1zcGVjaWZpYykKICAgICAgY29uc3QgcGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gcGxhdGVJZCk7CiAgICAgIGNvbnN0IHNjaWVudGlzdCA9IHBsYXRlICYmIHBsYXRlLmNvbHVtbl9pbmZvID8gKHBsYXRlLmNvbHVtbl9pbmZvLnNjaWVudGlzdCB8fCAiIikgOiAiIjsKICAgICAgY29uc3QgZW5hYmxlZENvbHVtbnMgPSBnZXRFbmFibGVkQ29sdW1uc0ZvclNjaWVudGlzdChzY2llbnRpc3QpOwogICAgICBpZiAoZW5hYmxlZENvbHVtbnMuc2l6ZSA+IDAgJiYgIWVuYWJsZWRDb2x1bW5zLmhhcyhjb2x1bW4pKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIAogICAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZFdlbGxzIGlmIGFueSBhcmUgc2V0CiAgICAgIGNvbnN0IG5vcm1hbGl6ZWRXZWxsSWQgPSBub3JtYWxpemVXZWxsSWQod2VsbElkKTsKICAgICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3ZWxsSWQpICYmICFlbmFibGVkV2VsbHMuaGFzKG5vcm1hbGl6ZWRXZWxsSWQpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIAogICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgICAgY29uc3Qgd2VsbERhdGEgPSB3ZWxsc1tub3JtYWxpemVkV2VsbElkXSB8fCB3ZWxsc1t3ZWxsSWRdOwogICAgICBpZiAod2VsbERhdGEpIHsKICAgICAgICBjb25zdCBmaWxlbmFtZSA9IHBsYXRlID8gKHBsYXRlLmZpbGUgfHwgcGxhdGUuaWQpIDogcGxhdGVJZDsKICAgICAgICBjb25zdCBjb25maWcgPSB2aWV3ZXJEYXRhLmNvbmZpZyB8fCB7fTsKICAgICAgICBjb25zdCB3ZWxsTGFiZWxzID0gY29uZmlnLndlbGxfbGFiZWxzIHx8IHt9OwogICAgICAgIGNvbnN0IHJvd0xldHRlciA9IGdldFJvd0xldHRlcih3ZWxsSWQpOwogICAgICAgIGNvbnN0IGlzQ29udHJvbCA9IGlzQ29udHJvbFdlbGwod2VsbElkKTsKICAgICAgICBjb25zdCBsYWJlbCA9IHdlbGxMYWJlbHNbcm93TGV0dGVyXSB8fCB3ZWxsRGF0YS5sYWJlbCB8fCB3ZWxsRGF0YS5jb250ZW50IHx8IGBXZWxsICR7d2VsbElkfWA7CiAgICAgICAgY29uc3QgZm9ybWF0dGVkTGFiZWwgPSBmb3JtYXRMYWJlbChsYWJlbCk7CiAgICAgICAgCiAgICAgICAgLy8gVXNlIHJhdyBkYXRhIChub3QgcHJvY2Vzc2VkKSBmb3IgU3RlcCAwCiAgICAgICAgY29uc3QgY29sb3IgPSBjb2xvcnNbY29sb3JJZHggJSUgY29sb3JzLmxlbmd0aF07CiAgICAgICAgY29sb3JJZHgrKzsKICAgICAgICAKICAgICAgICAvLyBBZGQgIkNvbnRyb2wiIHN1ZmZpeCBmb3IgY29udHJvbCB3ZWxscwogICAgICAgIGNvbnN0IGRpc3BsYXlMYWJlbCA9IGlzQ29udHJvbCAKICAgICAgICAgID8gYCR7d2VsbElkfSAtICR7Zm9ybWF0dGVkTGFiZWx9IENvbnRyb2wgQ29sICR7Y29sdW1ufWAKICAgICAgICAgIDogYCR7d2VsbElkfSAtICR7Zm9ybWF0dGVkTGFiZWx9IENvbCAke2NvbHVtbn1gOwogICAgICAgIAogICAgICAgIGRhdGFzZXRzLnB1c2goewogICAgICAgICAgbGFiZWw6IGRpc3BsYXlMYWJlbCwKICAgICAgICAgIGRhdGE6IHdlbGxEYXRhLnRpbWVfcy5tYXAoKHQsIGkpID0+ICh7IHg6IHQsIHk6IHdlbGxEYXRhLnZhbHVlc1tpXSB9KSkuZmlsdGVyKGQgPT4gZC55ICE9PSBudWxsICYmIGQueCAhPT0gbnVsbCksCiAgICAgICAgICBib3JkZXJDb2xvcjogY29sb3IucmVwbGFjZSgiMS4wIiwgIjAuNSIpLCAvLyBMaWdodGVyIGNvbG9yIGZvciByYXcgZGF0YQogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgdGVuc2lvbjogMC4xNSwKICAgICAgICAgIHBvaW50UmFkaXVzOiAxLjUsCiAgICAgICAgICBib3JkZXJXaWR0aDogMSwKICAgICAgICAgIGJvcmRlckRhc2g6IFszLCAzXSwgLy8gRGFzaGVkIGxpbmUgZm9yIHJhdyBkYXRhCiAgICAgICAgICBmaWxsOiBmYWxzZQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9CiAgCgogIC8vIEdyb3VwIHNlbGVjdGVkIHdlbGxzIGJ5IHRyaXBsaWNhdGUgZ3JvdXAgb3IgaW5kaXZpZHVhbCB3ZWxsCiAgY29uc3QgZ3JvdXBlZFNlbGVjdGlvbnMgPSB7fTsKICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogIAogIC8vIGdyb3VwVHJpcGxpY2F0ZXMgYWxyZWFkeSBkZWZpbmVkIGFib3ZlCiAgCiAgLy8gRmlyc3QgcGFzczogaWRlbnRpZnkgYWxsIHRyaXBsaWNhdGUgZ3JvdXBzIGZyb20gc2VsZWN0ZWQgd2VsbHMKICAvLyBPbmx5IGdyb3VwIGludG8gdHJpcGxpY2F0ZXMgaWYgU3RlcCAyIGlzIGVuYWJsZWQKICBjb25zdCB0cmlwbGljYXRlR3JvdXBzRm91bmQgPSBuZXcgTWFwKCk7IC8vIGdyb3VwS2V5IC0+IHsgbmFtZSwgY29sdW1uLCB3ZWxsczogU2V0IG9mIHdlbGxJZHMgfQogIAogIEFycmF5LmZyb20oc2VsZWN0ZWRXZWxscykuZm9yRWFjaChrZXkgPT4gewogICAgY29uc3QgW3BsYXRlSWQsIHdlbGxJZF0gPSBrZXkuc3BsaXQoIjoiKTsKICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgIAogICAgLy8gRmlsdGVyIGJ5IGVuYWJsZWRDb2x1bW5zIGlmIGFueSBhcmUgc2V0IChzY2llbnRpc3Qtc3BlY2lmaWMpCiAgICBjb25zdCBwbGF0ZSA9IHZpZXdlckRhdGEucGxhdGVzLmZpbmQocCA9PiBwLmlkID09PSBwbGF0ZUlkKTsKICAgIGNvbnN0IHNjaWVudGlzdCA9IHBsYXRlICYmIHBsYXRlLmNvbHVtbl9pbmZvID8gKHBsYXRlLmNvbHVtbl9pbmZvLnNjaWVudGlzdCB8fCAiIikgOiAiIjsKICAgIGNvbnN0IGVuYWJsZWRDb2x1bW5zID0gZ2V0RW5hYmxlZENvbHVtbnNGb3JTY2llbnRpc3Qoc2NpZW50aXN0KTsKICAgIGlmIChlbmFibGVkQ29sdW1ucy5zaXplID4gMCAmJiAhZW5hYmxlZENvbHVtbnMuaGFzKGNvbHVtbikpIHsKICAgICAgcmV0dXJuOyAvLyBTa2lwIHdlbGxzIGZyb20gZGlzYWJsZWQgY29sdW1ucwogICAgfQogICAgCiAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZFdlbGxzIGlmIGFueSBhcmUgc2V0IChleGNsdWRlIHdlbGxzKQogICAgY29uc3Qgbm9ybWFsaXplZFdlbGxJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpOwogICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3ZWxsSWQpICYmICFlbmFibGVkV2VsbHMuaGFzKG5vcm1hbGl6ZWRXZWxsSWQpKSB7CiAgICAgIHJldHVybjsgLy8gU2tpcCBleGNsdWRlZCB3ZWxscwogICAgfQogICAgCiAgICBjb25zdCBpc0NvbnRyb2wgPSBpc0NvbnRyb2xXZWxsKHdlbGxJZCk7CiAgICAKICAgIC8vIENvbnRyb2xzIGFyZSBhbHdheXMgaGFuZGxlZCBhcyBpbmRpdmlkdWFsIHdlbGxzIChubyBncm91cGluZykKICAgIGlmIChpc0NvbnRyb2wpIHsKICAgICAgcmV0dXJuOyAvLyBTa2lwIGNvbnRyb2xzIC0gdGhleSdsbCBiZSBoYW5kbGVkIGFzIGluZGl2aWR1YWwgd2VsbHMgaW4gdGhlIHRoaXJkIHBhc3MKICAgIH0KICAgIAogICAgLy8gU1RFUCAyOiBPbmx5IGdyb3VwIGludG8gdHJpcGxpY2F0ZXMgaWYgZ3JvdXBpbmcgaXMgZW5hYmxlZAogICAgaWYgKGdyb3VwVHJpcGxpY2F0ZXMpIHsKICAgICAgY29uc3QgdHJpcGxpY2F0ZUdyb3VwID0gZ2V0VHJpcGxpY2F0ZUdyb3VwKHdlbGxJZCwgY29sdW1uKTsKICAgICAgaWYgKHRyaXBsaWNhdGVHcm91cCkgewogICAgICAgIC8vIENyZWF0ZSBncm91cCBrZXkgdGhhdCBpbmNsdWRlcyBjb2x1bW4gdG8gc2VwYXJhdGUgc2FtZSBwYXR0ZXJuIGFjcm9zcyBjb2x1bW5zCiAgICAgICAgY29uc3QgZ3JvdXBLZXkgPSBgJHt0cmlwbGljYXRlR3JvdXAubmFtZX1fY29sJHtjb2x1bW59YDsKICAgICAgICBpZiAoIXRyaXBsaWNhdGVHcm91cHNGb3VuZC5oYXMoZ3JvdXBLZXkpKSB7CiAgICAgICAgICAvLyBHZXQgcm93IGxldHRlcnMgZnJvbSB0aGUgdHJpcGxpY2F0ZSBncm91cCBwYXR0ZXJuCiAgICAgICAgICBjb25zdCBncm91cFJvd0xldHRlcnMgPSBnZXRSb3dMZXR0ZXJzRnJvbVdlbGxzKHRyaXBsaWNhdGVHcm91cC53ZWxscyk7CiAgICAgICAgICAvLyBDcmVhdGUgd2VsbCBJRHMgZm9yIHRoaXMgY29sdW1uIHVzaW5nIHRoZSByb3cgcGF0dGVybgogICAgICAgICAgY29uc3Qgd2VsbElkc0ZvckNvbHVtbiA9IGdyb3VwUm93TGV0dGVycy5tYXAocm93ID0+IHJvdyArIGNvbHVtbik7CiAgICAgICAgICAKICAgICAgICAgIHRyaXBsaWNhdGVHcm91cHNGb3VuZC5zZXQoZ3JvdXBLZXksIHsKICAgICAgICAgICAgbmFtZTogdHJpcGxpY2F0ZUdyb3VwLm5hbWUsCiAgICAgICAgICAgIGNvbHVtbjogY29sdW1uLAogICAgICAgICAgICB3ZWxsSWRzOiBuZXcgU2V0KHdlbGxJZHNGb3JDb2x1bW4pCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8vIElmIGdyb3VwaW5nIGlzIGRpc2FibGVkLCB3ZWxscyB3aWxsIGJlIGhhbmRsZWQgYXMgaW5kaXZpZHVhbCB3ZWxscyBpbiB0aGUgdGhpcmQgcGFzcwogIH0pOwogIAogIC8vIFNlY29uZCBwYXNzOiBidWlsZCBncm91cGVkIHNlbGVjdGlvbnMgZm9yIHRyaXBsaWNhdGUgZ3JvdXBzCiAgdHJpcGxpY2F0ZUdyb3Vwc0ZvdW5kLmZvckVhY2goKGdyb3VwSW5mbywgZ3JvdXBLZXkpID0+IHsKICAgIGdyb3VwZWRTZWxlY3Rpb25zW2dyb3VwS2V5XSA9IHsKICAgICAgdHlwZTogInRyaXBsaWNhdGUiLAogICAgICB3ZWxsczogW10sCiAgICAgIG5hbWU6IGdyb3VwSW5mby5uYW1lCiAgICB9OwogICAgCiAgICAvLyBDb2xsZWN0IHdlbGxzIGZyb20gZGF0YXNldHMgdGhhdCBoYXZlIHNlbGVjdGVkIHdlbGxzIGluIHRoaXMgdHJpcGxpY2F0ZSBncm91cAogICAgQXJyYXkuZnJvbShzZWxlY3RlZFdlbGxzKS5mb3JFYWNoKGtleSA9PiB7CiAgICAgIGNvbnN0IFtwbGF0ZUlkLCB3ZWxsSWRdID0ga2V5LnNwbGl0KCI6Iik7CiAgICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgICAgY29uc3Qgbm9ybWFsaXplZFdlbGxJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpOwogICAgICAvLyBDaGVjayBpZiB0aGlzIHdlbGwgaXMgaW4gdGhlIGdyb3VwICh1c2luZyBub3JtYWxpemVkIElEKQogICAgICBjb25zdCBub3JtYWxpemVkV2VsbElkc0ZvckNvbHVtbiA9IEFycmF5LmZyb20oZ3JvdXBJbmZvLndlbGxJZHMpLm1hcCh3ID0+IG5vcm1hbGl6ZVdlbGxJZCh3KSk7CiAgICAgIGlmIChub3JtYWxpemVkV2VsbElkc0ZvckNvbHVtbi5pbmNsdWRlcyhub3JtYWxpemVkV2VsbElkKSAmJiBjb2x1bW4gPT09IGdyb3VwSW5mby5jb2x1bW4pIHsKICAgICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgICAgICBjb25zdCB3ZWxsRGF0YSA9IHdlbGxzW25vcm1hbGl6ZWRXZWxsSWRdIHx8IHdlbGxzW3dlbGxJZF07CiAgICAgICAgaWYgKHdlbGxEYXRhKSB7CiAgICAgICAgICAvLyBDaGVjayBpZiBhbHJlYWR5IGFkZGVkCiAgICAgICAgICBjb25zdCBleGlzdHMgPSBncm91cGVkU2VsZWN0aW9uc1tncm91cEtleV0ud2VsbHMuc29tZSgKICAgICAgICAgICAgdyA9PiB3LndlbGxJZCA9PT0gd2VsbElkICYmIHcucGxhdGVJZCA9PT0gcGxhdGVJZAogICAgICAgICAgKTsKICAgICAgICAgIGlmICghZXhpc3RzKSB7CiAgICAgICAgICAgIGxldCBwcm9jZXNzZWRXZWxsRGF0YSA9IHdlbGxEYXRhOwogICAgICAgICAgICBjb25zdCBic0Jhc2VsaW5lRW5kID0gbm9ybWFsaXplQmFzZWxpbmUgPyBub3JtYWxpemVCYXNlbGluZUVuZFRpbWUgOiBiYXNlbGluZVN1YnRyYWN0RW5kVGltZTsKICAgICAgICAgICAgaWYgKGJhc2VsaW5lU3VidHJhY3QgJiYgbm9ybWFsaXplQmFzZWxpbmUpIHsKICAgICAgICAgICAgICBwcm9jZXNzZWRXZWxsRGF0YSA9IGJhc2VsaW5lU3VidHJhY3RBbmROb3JtYWxpemVXZWxsRGF0YShwcm9jZXNzZWRXZWxsRGF0YSwgYnNCYXNlbGluZUVuZCwgYmFzZWxpbmVTdWJ0cmFjdE1vZGUpOwogICAgICAgICAgICAgIGlmICghcHJvY2Vzc2VkV2VsbERhdGEpIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIGlmIChiYXNlbGluZVN1YnRyYWN0KSB7CiAgICAgICAgICAgICAgcHJvY2Vzc2VkV2VsbERhdGEgPSBiYXNlbGluZVN1YnRyYWN0V2VsbERhdGEocHJvY2Vzc2VkV2VsbERhdGEsIGJzQmFzZWxpbmVFbmQsIGJhc2VsaW5lU3VidHJhY3RNb2RlKTsKICAgICAgICAgICAgICBpZiAoIXByb2Nlc3NlZFdlbGxEYXRhKSByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9ybWFsaXplQmFzZWxpbmUpIHsKICAgICAgICAgICAgICBwcm9jZXNzZWRXZWxsRGF0YSA9IG5vcm1hbGl6ZVdpdGhGaXR0ZWRCYXNlbGluZSgKICAgICAgICAgICAgICAgIHByb2Nlc3NlZFdlbGxEYXRhLAogICAgICAgICAgICAgICAgbm9ybWFsaXplQmFzZWxpbmVFbmRUaW1lLAogICAgICAgICAgICAgICAgYmFzZWxpbmVNZXRob2QsCiAgICAgICAgICAgICAgICBiYXNlbGluZUZyYWMsCiAgICAgICAgICAgICAgICBiYXNlbGluZVBvbHlPcmRlciwKICAgICAgICAgICAgICAgIG5vcm1hbGl6YXRpb25Nb2RlCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoIXByb2Nlc3NlZFdlbGxEYXRhKSByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldLndlbGxzLnB1c2goewogICAgICAgICAgICAgIHdlbGxJZDogd2VsbElkLAogICAgICAgICAgICAgIHBsYXRlSWQ6IHBsYXRlSWQsCiAgICAgICAgICAgICAgZGF0YTogcHJvY2Vzc2VkV2VsbERhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9KTsKICAKICAvLyBUaGlyZCBwYXNzOiBoYW5kbGUgaW5kaXZpZHVhbCB3ZWxscyAoc2tpcCBpZiBhbHJlYWR5IGluIHRyaXBsaWNhdGUgZ3JvdXApCiAgQXJyYXkuZnJvbShzZWxlY3RlZFdlbGxzKS5mb3JFYWNoKGtleSA9PiB7CiAgICAvLyBWZXJpZnkgdGhpcyB3ZWxsIGlzIHN0aWxsIHNlbGVjdGVkIChtYXkgaGF2ZSBiZWVuIGRlc2VsZWN0ZWQpCiAgICBpZiAoIXNlbGVjdGVkV2VsbHMuaGFzKGtleSkpIHsKICAgICAgcmV0dXJuOyAvLyBTa2lwIHdlbGxzIHRoYXQgYXJlIG5vIGxvbmdlciBzZWxlY3RlZAogICAgfQogICAgCiAgICBjb25zdCBbcGxhdGVJZCwgd2VsbElkXSA9IGtleS5zcGxpdCgiOiIpOwogICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgY29uc3QgaXNDb250cm9sID0gaXNDb250cm9sV2VsbCh3ZWxsSWQpOwogICAgCiAgICAvLyBDb250cm9scyBhcmUgYWx3YXlzIGhhbmRsZWQgYXMgaW5kaXZpZHVhbCB3ZWxscyAobm8gZ3JvdXBpbmcpCiAgICBpZiAoaXNDb250cm9sKSB7CiAgICAgIC8vIENvbnRpbnVlIHRvIHByb2Nlc3MgYXMgaW5kaXZpZHVhbCB3ZWxsCiAgICB9IGVsc2UgewogICAgICAvLyBTVEVQIDI6IENoZWNrIGlmIHRoaXMgd2VsbCBpcyBwYXJ0IG9mIGEgdHJpcGxpY2F0ZSBncm91cCB3ZSd2ZSBhbHJlYWR5IHByb2Nlc3NlZAogICAgICAvLyBPbmx5IHNraXAgaWYgZ3JvdXBpbmcgaXMgZW5hYmxlZCBhbmQgdGhpcyB3ZWxsIHdhcyBncm91cGVkCiAgICAgIGlmIChncm91cFRyaXBsaWNhdGVzKSB7CiAgICAgICAgY29uc3QgdHJpcGxpY2F0ZUdyb3VwID0gZ2V0VHJpcGxpY2F0ZUdyb3VwKHdlbGxJZCwgY29sdW1uKTsKICAgICAgICBpZiAodHJpcGxpY2F0ZUdyb3VwKSB7CiAgICAgICAgICAvLyBBbHJlYWR5IGhhbmRsZWQgaW4gdHJpcGxpY2F0ZUdyb3Vwc0ZvdW5kIC0gc2tpcAogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgCiAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZFdlbGxzIGlmIGFueSBhcmUgc2V0CiAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCkgJiYgIWVuYWJsZWRXZWxscy5oYXMobm9ybWFsaXplZFdlbGxJZCkpIHsKICAgICAgcmV0dXJuOyAvLyBTa2lwIGV4Y2x1ZGVkIHdlbGxzCiAgICB9CiAgICAKICAgIC8vIEluZGl2aWR1YWwgd2VsbCAobm90IHBhcnQgb2YgYSB0cmlwbGljYXRlIGdyb3VwKQogICAgY29uc3QgZ3JvdXBLZXkgPSBgd2VsbF8ke3dlbGxJZH1gOwogICAgaWYgKCFncm91cGVkU2VsZWN0aW9uc1tncm91cEtleV0pIHsKICAgICAgY29uc3QgY29uZmlnID0gdmlld2VyRGF0YS5jb25maWcgfHwge307CiAgICAgIGNvbnN0IHdlbGxMYWJlbHMgPSBjb25maWcud2VsbF9sYWJlbHMgfHwge307CiAgICAgIC8vIEdldCBsYWJlbCBmcm9tIHJvdy1iYXNlZCBjb25maWcgb3Igd2VsbCBkYXRhCiAgICAgIGNvbnN0IHJvd0xldHRlciA9IGdldFJvd0xldHRlcih3ZWxsSWQpOwogICAgICBsZXQgbGFiZWwgPSB3ZWxsTGFiZWxzW3Jvd0xldHRlcl07CiAgICAgIGlmICghbGFiZWwpIHsKICAgICAgICBmb3IgKGNvbnN0IHBJZCBvZiBzZWxlY3RlZERhdGFzZXRzKSB7CiAgICAgICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwSWRdIHx8IHt9OwogICAgICAgICAgY29uc3Qgd2VsbERhdGEgPSB3ZWxsc1tub3JtYWxpemVkV2VsbElkXSB8fCB3ZWxsc1t3ZWxsSWRdOwogICAgICAgICAgaWYgKHdlbGxEYXRhKSB7CiAgICAgICAgICAgIGxhYmVsID0gd2VsbERhdGEubGFiZWwgfHwgd2VsbERhdGEuY29udGVudCB8fCBgV2VsbCAke3dlbGxJZH1gOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldID0gewogICAgICAgIHR5cGU6ICJzaW5nbGUiLAogICAgICAgIHdlbGxzOiBbXSwKICAgICAgICBsYWJlbDogZm9ybWF0TGFiZWwobGFiZWwpIHx8IGBXZWxsICR7d2VsbElkfWAKICAgICAgfTsKICAgIH0KICAgIAogICAgLy8gQWRkIHRoaXMgd2VsbCdzIGRhdGEgaWYgaXQgZXhpc3RzCiAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgIGNvbnN0IHdlbGxEYXRhID0gd2VsbHNbbm9ybWFsaXplZFdlbGxJZF0gfHwgd2VsbHNbd2VsbElkXTsKICAgIGlmICh3ZWxsRGF0YSkgewogICAgICBjb25zdCBleGlzdGluZyA9IGdyb3VwZWRTZWxlY3Rpb25zW2dyb3VwS2V5XS53ZWxscy5maW5kKHcgPT4gdy53ZWxsSWQgPT09IHdlbGxJZCAmJiB3LnBsYXRlSWQgPT09IHBsYXRlSWQpOwogICAgICBpZiAoIWV4aXN0aW5nKSB7CiAgICAgICAgICBsZXQgcHJvY2Vzc2VkV2VsbERhdGEgPSB3ZWxsRGF0YTsKICAgICAgICAgIGNvbnN0IGJzQmFzZWxpbmVFbmQgPSBub3JtYWxpemVCYXNlbGluZSA/IG5vcm1hbGl6ZUJhc2VsaW5lRW5kVGltZSA6IGJhc2VsaW5lU3VidHJhY3RFbmRUaW1lOwogICAgICAgICAgaWYgKGJhc2VsaW5lU3VidHJhY3QgJiYgbm9ybWFsaXplQmFzZWxpbmUpIHsKICAgICAgICAgICAgcHJvY2Vzc2VkV2VsbERhdGEgPSBiYXNlbGluZVN1YnRyYWN0QW5kTm9ybWFsaXplV2VsbERhdGEocHJvY2Vzc2VkV2VsbERhdGEsIGJzQmFzZWxpbmVFbmQsIGJhc2VsaW5lU3VidHJhY3RNb2RlKTsKICAgICAgICAgICAgaWYgKCFwcm9jZXNzZWRXZWxsRGF0YSkgcmV0dXJuOwogICAgICAgICAgfSBlbHNlIGlmIChiYXNlbGluZVN1YnRyYWN0KSB7CiAgICAgICAgICAgIHByb2Nlc3NlZFdlbGxEYXRhID0gYmFzZWxpbmVTdWJ0cmFjdFdlbGxEYXRhKHByb2Nlc3NlZFdlbGxEYXRhLCBic0Jhc2VsaW5lRW5kLCBiYXNlbGluZVN1YnRyYWN0TW9kZSk7CiAgICAgICAgICAgIGlmICghcHJvY2Vzc2VkV2VsbERhdGEpIHJldHVybjsKICAgICAgICAgIH0gZWxzZSBpZiAobm9ybWFsaXplQmFzZWxpbmUpIHsKICAgICAgICAgICAgcHJvY2Vzc2VkV2VsbERhdGEgPSBub3JtYWxpemVXaXRoRml0dGVkQmFzZWxpbmUoCiAgICAgICAgICAgICAgcHJvY2Vzc2VkV2VsbERhdGEsCiAgICAgICAgICAgICAgbm9ybWFsaXplQmFzZWxpbmVFbmRUaW1lLAogICAgICAgICAgICAgIGJhc2VsaW5lTWV0aG9kLAogICAgICAgICAgICAgIGJhc2VsaW5lRnJhYywKICAgICAgICAgICAgICBiYXNlbGluZVBvbHlPcmRlciwKICAgICAgICAgICAgICBub3JtYWxpemF0aW9uTW9kZQogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoIXByb2Nlc3NlZFdlbGxEYXRhKSByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBncm91cGVkU2VsZWN0aW9uc1tncm91cEtleV0ud2VsbHMucHVzaCh7CiAgICAgICAgICAgIHdlbGxJZDogd2VsbElkLAogICAgICAgICAgICBwbGF0ZUlkOiBwbGF0ZUlkLAogICAgICAgICAgICBkYXRhOiBwcm9jZXNzZWRXZWxsRGF0YQogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9KTsKICAKICAvLyBDb250aW51ZSB3aXRoIGdyb3VwZWQgc2VsZWN0aW9ucyAoY29sb3JJZHggYWxyZWFkeSBpbml0aWFsaXplZCBmb3IgU3RlcCAwKQogIC8vIFByb2Nlc3MgZ3JvdXBlZCBzZWxlY3Rpb25zIHdoZW46CiAgLy8gMS4gU3RlcCAwIGlzIG5vdCBzaG93aW5nIChiZWNhdXNlIG90aGVyIHN0ZXBzIGFyZSBlbmFibGVkKSwgT1IKICAvLyAyLiBQcm9jZXNzaW5nIHN0ZXBzIGFyZSBlbmFibGVkICh3aGljaCBhdXRvbWF0aWNhbGx5IGRpc2FibGVzIFN0ZXAgMCkKICAvLyBUaGlzIGVuc3VyZXMgZGF0YSBhbHdheXMgc2hvd3MgLSBlaXRoZXIgU3RlcCAwIGluZGl2aWR1YWwgd2VsbHMgT1IgZ3JvdXBlZCBzZWxlY3Rpb25zCiAgaWYgKCFzaG93SW5kaXZpZHVhbFdlbGxzKSB7CiAgICBPYmplY3Qua2V5cyhncm91cGVkU2VsZWN0aW9ucykuZm9yRWFjaChncm91cEtleSA9PiB7CiAgICAgIGNvbnN0IGdyb3VwID0gZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldOwogICAgICAKICAgICAgLy8gRmlsdGVyIG91dCBhbnkgd2VsbHMgdGhhdCBhcmUgbm8gbG9uZ2VyIHNlbGVjdGVkIG9yIGFyZSBleGNsdWRlZAogICAgICBncm91cC53ZWxscyA9IGdyb3VwLndlbGxzLmZpbHRlcih3ID0+IHsKICAgICAgICBjb25zdCBrZXkgPSBgJHt3LnBsYXRlSWR9OiR7dy53ZWxsSWR9YDsKICAgICAgICAvLyBDaGVjayBpZiBzdGlsbCBzZWxlY3RlZAogICAgICAgIGlmICghc2VsZWN0ZWRXZWxscy5oYXMoa2V5KSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICAvLyBDaGVjayBpZiBleGNsdWRlZCB2aWEgZW5hYmxlZFdlbGxzCiAgICAgICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3LndlbGxJZCkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgICAKICAgICAgLy8gU2tpcCBncm91cHMgd2l0aCBubyB3ZWxscyBhZnRlciBmaWx0ZXJpbmcKICAgICAgaWYgKGdyb3VwLndlbGxzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybjsgLy8gU2tpcCB0byBuZXh0IGdyb3VwCiAgICAgIH0KICAgICAgCiAgICAgIGNvbnN0IGNvbG9yID0gY29sb3JzW2NvbG9ySWR4ICUlIGNvbG9ycy5sZW5ndGhdOwogICAgICBjb2xvcklkeCsrOwoKICAgIGlmIChncm91cC50eXBlID09PSAidHJpcGxpY2F0ZSIgJiYgZ3JvdXAud2VsbHMubGVuZ3RoID4gMCkgewogICAgICAvLyBTVEVQIDM6IEF2ZXJhZ2Ugd2l0aGluIHRyaXBsaWNhdGUgZ3JvdXAKICAgICAgY29uc3QgcmVzdWx0ID0gcHJvY2Vzc1dlbGxzQW5kQ2FsY3VsYXRlTWVhbigKICAgICAgICBncm91cC53ZWxscy5tYXAodyA9PiB3LmRhdGEpLAogICAgICAgIGZhbHNlLCAvLyBObyBub3JtYWxpemF0aW9uCiAgICAgICAgMCwgLy8gYmFzZWxpbmVFbmRUaW1lIG5vdCB1c2VkCiAgICAgICAgOTk5OTk5IC8vIGN1dG9mZlRpbWUgbm90IHVzZWQKICAgICAgKTsKICAgICAgY29uc3QgdGltZVBvaW50cyA9IHJlc3VsdC5maWx0ZXJlZFRpbWVQb2ludHM7CiAgICAgIGNvbnN0IG1lYW5zID0gcmVzdWx0Lm5vcm1hbGl6ZWRNZWFuczsKICAgICAgY29uc3QgZXJyb3JzID0gcmVzdWx0Lm5vcm1hbGl6ZWRFcnJvcnM7CiAgICAgIAogICAgICAvLyBDcmVhdGUgZGF0YXNldCB3aXRoIG1lYW4gYW5kIGVycm9yIGluZm9ybWF0aW9uCiAgICAgIGNvbnN0IGxpbmVEYXRhID0gdGltZVBvaW50cy5tYXAoKHQsIGkpID0+IHsKICAgICAgICBjb25zdCBwb2ludCA9IHsKICAgICAgICAgIHg6IHQsCiAgICAgICAgICB5OiBtZWFuc1tpXSwKICAgICAgICAgIGVycm9yOiBlcnJvcnNbaV0KICAgICAgICB9OwogICAgICAgIHJldHVybiBwb2ludDsKICAgICAgfSkuZmlsdGVyKGQgPT4gZC55ICE9PSBudWxsKTsKICAgICAgCiAgICAgIC8vIEdldCBncm91cCBuYW1lIGZyb20gZmlyc3Qgd2VsbCdzIHBsYXRlCiAgICAgIGNvbnN0IGZpcnN0UGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gZ3JvdXAud2VsbHNbMF0ucGxhdGVJZCk7CiAgICAgIGNvbnN0IGNvbHVtbkdyb3VwTmFtZSA9IGZpcnN0UGxhdGUgPyBmaXJzdFBsYXRlLmNvbHVtbl9ncm91cCA6ICIiOwogICAgICBjb25zdCBkYXRhc2V0Q291bnQgPSBuZXcgU2V0KGdyb3VwLndlbGxzLm1hcCh3ID0+IHcucGxhdGVJZCkpLnNpemU7CiAgICAgIGNvbnN0IHdlbGxDb3VudCA9IGdyb3VwLndlbGxzLmxlbmd0aDsKICAgICAgCiAgICAgIC8vIENyZWF0ZSBhcHByb3ByaWF0ZSBsYWJlbCBiYXNlZCBvbiBudW1iZXIgb2YgcmVwbGljYXRlcwogICAgICBsZXQgcmVwbGljYXRlTGFiZWwgPSAiIjsKICAgICAgaWYgKHdlbGxDb3VudCA9PT0gMykgewogICAgICAgIHJlcGxpY2F0ZUxhYmVsID0gInRyaXBsaWNhdGUiOwogICAgICB9IGVsc2UgaWYgKHdlbGxDb3VudCA9PT0gNikgewogICAgICAgIHJlcGxpY2F0ZUxhYmVsID0gImhleHBsaWNhdGUiOwogICAgICB9IGVsc2UgaWYgKHdlbGxDb3VudCA9PT0gOSkgewogICAgICAgIHJlcGxpY2F0ZUxhYmVsID0gIm5vbnVwbGljYXRlIjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXBsaWNhdGVMYWJlbCA9IGAke3dlbGxDb3VudH0tcGxpY2F0ZWA7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIEdldCBjb2x1bW4gbnVtYmVyIGZyb20gZmlyc3Qgd2VsbAogICAgICBjb25zdCBmaXJzdFdlbGxJZCA9IGdyb3VwLndlbGxzWzBdLndlbGxJZDsKICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZChmaXJzdFdlbGxJZCk7CiAgICAgIAogICAgICAvLyBBZGQgd2VsbCBJRHMgd2hlbiBTdGVwIDAgb3IgU3RlcCAxIGlzIGVuYWJsZWQKICAgICAgbGV0IHdlbGxJZHNQcmVmaXggPSAiIjsKICAgICAgaWYgKHN0ZXAwT3JTdGVwMUVuYWJsZWQgJiYgZ3JvdXAud2VsbHMubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnN0IHdlbGxJZHMgPSBncm91cC53ZWxscy5tYXAodyA9PiB3LndlbGxJZCkuam9pbigiLCAiKTsKICAgICAgICB3ZWxsSWRzUHJlZml4ID0gYCR7d2VsbElkc30gLSBgOwogICAgICB9CiAgICAgIAogICAgICBjb25zdCBsYWJlbFN1ZmZpeCA9IGRhdGFzZXRDb3VudCA+IDEgCiAgICAgICAgPyBgICgke3JlcGxpY2F0ZUxhYmVsfSwgJHtkYXRhc2V0Q291bnR9IGRhdGFzZXRzLCBtZWFuIMKxIFNFKWAgCiAgICAgICAgOiBgICgke3JlcGxpY2F0ZUxhYmVsfSwgbWVhbiDCsSBTRSlgOwogICAgICBjb25zdCBmb3JtYXR0ZWROYW1lID0gZm9ybWF0TGFiZWwoZ3JvdXAubmFtZSk7CiAgICAgIGNvbnN0IGxhYmVsID0gY29sdW1uR3JvdXBOYW1lIAogICAgICAgID8gYCR7d2VsbElkc1ByZWZpeH0ke2Zvcm1hdHRlZE5hbWV9ICgke2NvbHVtbkdyb3VwTmFtZX0pIENvbCAke2NvbHVtbn0ke2xhYmVsU3VmZml4fWAKICAgICAgICA6IGAke3dlbGxJZHNQcmVmaXh9JHtmb3JtYXR0ZWROYW1lfSBDb2wgJHtjb2x1bW59JHtsYWJlbFN1ZmZpeH1gOwogICAgICAKICAgICAgZGF0YXNldHMucHVzaCh7CiAgICAgICAgbGFiZWw6IGxhYmVsLAogICAgICAgIGRhdGE6IGxpbmVEYXRhLAogICAgICAgIGJvcmRlckNvbG9yOiBjb2xvciwKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGNvbG9yLnJlcGxhY2UoIjEuMCIsICIwLjIiKSwKICAgICAgICB0ZW5zaW9uOiAwLjE1LAogICAgICAgIHBvaW50UmFkaXVzOiAzLAogICAgICAgIGJvcmRlcldpZHRoOiAyLAogICAgICAgIGZpbGw6IGZhbHNlCiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChncm91cC50eXBlID09PSAic2luZ2xlIikgewogICAgICAvLyBTaW5nbGUgd2VsbCAtIGNoZWNrIGlmIGl0J3MgYSBkdXBsaWNhdGUKICAgICAgY29uc3Qgd2VsbElkID0gZ3JvdXAud2VsbHNbMF0ud2VsbElkOwogICAgICBjb25zdCBpc0R1cGxpY2F0ZSA9IGlzRHVwbGljYXRlV2VsbCh3ZWxsSWQpOwogICAgICAKICAgICAgaWYgKGdyb3VwLndlbGxzLmxlbmd0aCA+IDEgJiYgaXNEdXBsaWNhdGUpIHsKICAgICAgICAvLyBEdXBsaWNhdGUgd2VsbCAtIHNob3cgZWFjaCBkYXRhc2V0IHNlcGFyYXRlbHkgZm9yIGNvbXBhcmlzb24KICAgICAgICBjb25zdCBsaW5lU3R5bGVzID0gWyJzb2xpZCIsICJkYXNoZWQiLCAiZG90dGVkIl07CiAgICAgICAgY29uc3QgZm9ybWF0dGVkTGFiZWwgPSBmb3JtYXRMYWJlbChncm91cC5sYWJlbCk7CiAgICAgICAgCiAgICAgICAgZ3JvdXAud2VsbHMuZm9yRWFjaCgod2VsbCwgaWR4KSA9PiB7CiAgICAgICAgICBjb25zdCBwbGF0ZSA9IHZpZXdlckRhdGEucGxhdGVzLmZpbmQocCA9PiBwLmlkID09PSB3ZWxsLnBsYXRlSWQpOwogICAgICAgICAgY29uc3QgZmlsZW5hbWUgPSBwbGF0ZSA/IChwbGF0ZS5maWxlIHx8IHBsYXRlLmlkKSA6IHdlbGwucGxhdGVJZDsKICAgICAgICAgIGNvbnN0IGxpbmVTdHlsZSA9IGxpbmVTdHlsZXNbaWR4ICUlIGxpbmVTdHlsZXMubGVuZ3RoXTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXNlIHNsaWdodGx5IGRpZmZlcmVudCBzaGFkZXMgb2YgdGhlIHNhbWUgY29sb3IgZm9yIGR1cGxpY2F0ZXMKICAgICAgICAgIGNvbnN0IGJhc2VDb2xvciA9IGNvbG9yOwogICAgICAgICAgY29uc3QgYWxwaGEgPSAxLjAgLSAoaWR4ICogMC4xNSk7IC8vIFNsaWdodGx5IGZhZGUgZWFjaCBzdWJzZXF1ZW50IGxpbmUKICAgICAgICAgIGNvbnN0IGFkanVzdGVkQ29sb3IgPSBiYXNlQ29sb3IucmVwbGFjZSgiMS4wIiwgYWxwaGEudG9GaXhlZCgxKSk7CiAgICAgICAgICAKICAgICAgICAgIGxldCB0aW1lUG9pbnRzID0gd2VsbC5kYXRhLnRpbWVfczsKICAgICAgICAgIGxldCB2YWx1ZXMgPSB3ZWxsLmRhdGEudmFsdWVzOwogICAgICAgICAgCiAgICAgICAgICBjb25zdCBjb2x1bW4gPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGwud2VsbElkKTsKICAgICAgICAgIC8vIEFkZCB3ZWxsIElEIHdoZW4gU3RlcCAwIG9yIFN0ZXAgMSBpcyBlbmFibGVkCiAgICAgICAgICBjb25zdCB3ZWxsSWRQcmVmaXggPSBzdGVwME9yU3RlcDFFbmFibGVkID8gYCR7d2VsbC53ZWxsSWR9IC0gYCA6ICIiOwogICAgICAgICAgZGF0YXNldHMucHVzaCh7CiAgICAgICAgICAgIGxhYmVsOiBgJHt3ZWxsSWRQcmVmaXh9JHtmb3JtYXR0ZWRMYWJlbH0gQ29sICR7Y29sdW1ufSAoJHtmaWxlbmFtZX0pYCwKICAgICAgICAgICAgZGF0YTogdGltZVBvaW50cy5tYXAoKHQsIGkpID0+IHsKICAgICAgICAgICAgICBjb25zdCBwb2ludCA9IHsgeDogdCwgeTogdmFsdWVzW2ldIH07CiAgICAgICAgICAgICAgcmV0dXJuIHBvaW50OwogICAgICAgICAgICB9KS5maWx0ZXIoZCA9PiBkLnkgIT09IG51bGwpLAogICAgICAgICAgICBib3JkZXJDb2xvcjogYWRqdXN0ZWRDb2xvciwKICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICBib3JkZXJEYXNoOiBsaW5lU3R5bGUgPT09ICJkYXNoZWQiID8gWzUsIDVdIDogbGluZVN0eWxlID09PSAiZG90dGVkIiA/IFsyLCAyXSA6IFtdLAogICAgICAgICAgICB0ZW5zaW9uOiAwLjE1LAogICAgICAgICAgICBwb2ludFJhZGl1czogMiwKICAgICAgICAgICAgYm9yZGVyV2lkdGg6IDEuNSwKICAgICAgICAgICAgZmlsbDogZmFsc2UsCiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChncm91cC53ZWxscy5sZW5ndGggPiAxKSB7CiAgICAgICAgLy8gU1RFUCAzOiBBdmVyYWdlIG11bHRpcGxlIGRhdGFzZXRzIGZvciBzYW1lIHdlbGwgKG5vdCBkdXBsaWNhdGUpIC0gY2FsY3VsYXRlIG1lYW4gYW5kIGVycm9yCiAgICAgICAgY29uc3QgcmVzdWx0ID0gcHJvY2Vzc1dlbGxzQW5kQ2FsY3VsYXRlTWVhbigKICAgICAgICAgIGdyb3VwLndlbGxzLm1hcCh3ID0+IHcuZGF0YSksCiAgICAgICAgICBmYWxzZSwgLy8gTm8gbm9ybWFsaXphdGlvbgogICAgICAgICAgMCwgLy8gYmFzZWxpbmVFbmRUaW1lIG5vdCB1c2VkCiAgICAgICAgICA5OTk5OTkgLy8gY3V0b2ZmVGltZSBub3QgdXNlZAogICAgICAgICk7CiAgICAgICAgY29uc3QgdGltZVBvaW50cyA9IHJlc3VsdC5maWx0ZXJlZFRpbWVQb2ludHM7CiAgICAgICAgY29uc3QgbWVhbnMgPSByZXN1bHQubm9ybWFsaXplZE1lYW5zOwogICAgICAgIGNvbnN0IGVycm9ycyA9IHJlc3VsdC5ub3JtYWxpemVkRXJyb3JzOwogICAgICAgIAogICAgICAgIGNvbnN0IGxpbmVEYXRhID0gdGltZVBvaW50cy5tYXAoKHQsIGkpID0+IHsKICAgICAgICAgIGNvbnN0IHBvaW50ID0gewogICAgICAgICAgICB4OiB0LAogICAgICAgICAgICB5OiBtZWFuc1tpXSwKICAgICAgICAgICAgZXJyb3I6IGVycm9yc1tpXQogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiBwb2ludDsKICAgICAgICB9KS5maWx0ZXIoZCA9PiBkLnkgIT09IG51bGwpOwogICAgICAgIAogICAgICAgIGNvbnN0IGRhdGFzZXRDb3VudCA9IGdyb3VwLndlbGxzLmxlbmd0aDsKICAgICAgICBjb25zdCBjb2x1bW4gPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAgICAgY29uc3QgZm9ybWF0dGVkTGFiZWwgPSBmb3JtYXRMYWJlbChncm91cC5sYWJlbCk7CiAgICAgICAgLy8gQWRkIHdlbGwgSUQgd2hlbiBTdGVwIDAgb3IgU3RlcCAxIGlzIGVuYWJsZWQKICAgICAgICBjb25zdCB3ZWxsSWRQcmVmaXggPSBzdGVwME9yU3RlcDFFbmFibGVkID8gYCR7d2VsbElkfSAtIGAgOiAiIjsKICAgICAgICBjb25zdCBsYWJlbCA9IGAke3dlbGxJZFByZWZpeH0ke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59ICgke2RhdGFzZXRDb3VudH0gZGF0YXNldHMsIG1lYW4gwrEgU0UpYDsKICAgICAgICAKICAgICAgICBkYXRhc2V0cy5wdXNoKHsKICAgICAgICAgIGxhYmVsOiBsYWJlbCwKICAgICAgICAgIGRhdGE6IGxpbmVEYXRhLAogICAgICAgICAgYm9yZGVyQ29sb3I6IGNvbG9yLAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBjb2xvci5yZXBsYWNlKCIxLjAiLCAiMC4yIiksCiAgICAgICAgICB0ZW5zaW9uOiAwLjE1LAogICAgICAgICAgcG9pbnRSYWRpdXM6IDMsCiAgICAgICAgICBib3JkZXJXaWR0aDogMiwKICAgICAgICAgIGZpbGw6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU2luZ2xlIGRhdGFzZXQgZm9yIHRoaXMgd2VsbAogICAgICAgIC8vIFNraXAgc2hvd2luZyBwcm9jZXNzZWQgaW5kaXZpZHVhbCB3ZWxscyBpZiBTdGVwIDAgaXMgYWxyZWFkeSBzaG93aW5nIHRoZSByYXcgZGF0YQogICAgICAgIC8vIEJ1dCBvbmx5IHNraXAgaWYgU3RlcCAwIGlzIGFjdHVhbGx5IGVuYWJsZWQgKG5vdCBqdXN0IHJlcXVlc3RlZCkKICAgICAgICBpZiAoc2hvd0luZGl2aWR1YWxXZWxscyAmJiAhYW55UHJvY2Vzc2luZ1N0ZXBFbmFibGVkKSB7CiAgICAgICAgICAvLyBTdGVwIDAgYWxyZWFkeSBzaG93cyB0aGlzIHdlbGwsIHNraXAgdGhlIHByb2Nlc3NlZCB2ZXJzaW9uIHRvIGF2b2lkIGR1cGxpY2F0ZXMKICAgICAgICAgIHJldHVybjsgLy8gU2tpcCB0byBuZXh0IGdyb3VwIGluIGZvckVhY2gKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgY29uc3Qgd2VsbCA9IGdyb3VwLndlbGxzWzBdOwogICAgICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbC53ZWxsSWQpOwogICAgICAgIGNvbnN0IGZvcm1hdHRlZExhYmVsID0gZm9ybWF0TGFiZWwoZ3JvdXAubGFiZWwpOwogICAgICAgIAogICAgICAgIGxldCB0aW1lUG9pbnRzID0gd2VsbC5kYXRhLnRpbWVfczsKICAgICAgICBsZXQgdmFsdWVzID0gd2VsbC5kYXRhLnZhbHVlczsKICAgICAgICAKICAgICAgICAvLyBBZGQgd2VsbCBJRCB3aGVuIFN0ZXAgMCBvciBTdGVwIDEgaXMgZW5hYmxlZAogICAgICAgIGNvbnN0IHdlbGxJZFByZWZpeCA9IHN0ZXAwT3JTdGVwMUVuYWJsZWQgPyBgJHt3ZWxsLndlbGxJZH0gLSBgIDogIiI7CiAgICAgICAgY29uc3QgbGFiZWwgPSBmb3JtYXR0ZWRMYWJlbCAKICAgICAgICAgID8gYCR7d2VsbElkUHJlZml4fSR7Zm9ybWF0dGVkTGFiZWx9IENvbCAke2NvbHVtbn1gIAogICAgICAgICAgOiBgJHt3ZWxsSWRQcmVmaXh9V2VsbCAke3dlbGwud2VsbElkfSBDb2wgJHtjb2x1bW59YDsKICAgICAgICAKICAgICAgICBkYXRhc2V0cy5wdXNoKHsKICAgICAgICAgIGxhYmVsOiBsYWJlbCwKICAgICAgICAgIGRhdGE6IHRpbWVQb2ludHMubWFwKCh0LCBpKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHBvaW50ID0geyB4OiB0LCB5OiB2YWx1ZXNbaV0gfTsKICAgICAgICAgICAgcmV0dXJuIHBvaW50OwogICAgICAgICAgfSkuZmlsdGVyKGQgPT4gZC55ICE9PSBudWxsKSwKICAgICAgICAgIGJvcmRlckNvbG9yOiBjb2xvciwKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogInRyYW5zcGFyZW50IiwKICAgICAgICAgIHRlbnNpb246IDAuMTUsCiAgICAgICAgICBwb2ludFJhZGl1czogMiwKICAgICAgICAgIGJvcmRlcldpZHRoOiAxLjUsCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIH0pOwogIH0KCiAgLy8gU1RFUCAzOiBBcHBseSBjdXRvZmYgZmlsdGVyaW5nIHRvIGFsbCBkYXRhc2V0cwogIGxldCB4QXhpc01pbiA9IHVuZGVmaW5lZDsKICBsZXQgeEF4aXNNYXggPSB1bmRlZmluZWQ7CiAgCiAgaWYgKGN1dG9mZkJhc2VsaW5lKSB7CiAgICBkYXRhc2V0cy5mb3JFYWNoKGRhdGFzZXQgPT4gewogICAgICBpZiAoZGF0YXNldC5kYXRhICYmIGRhdGFzZXQuZGF0YS5sZW5ndGggPiAwKSB7CiAgICAgICAgLy8gRmluZCBmaXJzdCByZWFsIHRpbWVwb2ludCAoZmlyc3Qgbm9uLW51bGwgdGltZSkKICAgICAgICBsZXQgZmlyc3RUaW1lcG9pbnQgPSBudWxsOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YXNldC5kYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoZGF0YXNldC5kYXRhW2ldLnggIT09IG51bGwgJiYgaXNGaW5pdGUoZGF0YXNldC5kYXRhW2ldLngpKSB7CiAgICAgICAgICAgIGZpcnN0VGltZXBvaW50ID0gZGF0YXNldC5kYXRhW2ldLng7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBEZXRlcm1pbmUgbWluaW11bSB0aW1lIHRvIGluY2x1ZGUKICAgICAgICAvLyBJZiBTdGVwIDAgb3IgU3RlcCAxIGVuYWJsZWQsIGV4Y2x1ZGUgYmFzZWxpbmUgcGVyaW9kIChwb2ludHMgYmVmb3JlIHByb2Nlc3NpbmdCYXNlbGluZUVuZCkKICAgICAgICAvLyBPdGhlcndpc2UsIGV4Y2x1ZGUgcG9pbnRzIGJlZm9yZSBmaXJzdCByZWFsIHRpbWVwb2ludAogICAgICAgIGNvbnN0IG1pblRpbWUgPSBzdGVwME9yU3RlcDFFbmFibGVkID8gcHJvY2Vzc2luZ0Jhc2VsaW5lRW5kIDogKGZpcnN0VGltZXBvaW50ICE9PSBudWxsID8gZmlyc3RUaW1lcG9pbnQgOiAtSW5maW5pdHkpOwogICAgICAgIAogICAgICAgIC8vIEZpbHRlciBkYXRhIHBvaW50czogZXhjbHVkZSBiZWZvcmUgbWluVGltZSBhbmQgYWZ0ZXIgY3V0b2ZmIHRpbWUKICAgICAgICBkYXRhc2V0LmRhdGEgPSBkYXRhc2V0LmRhdGEuZmlsdGVyKHBvaW50ID0+IHsKICAgICAgICAgIGlmIChwb2ludC54ID09PSBudWxsIHx8ICFpc0Zpbml0ZShwb2ludC54KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgaWYgKHBvaW50LnggPCBtaW5UaW1lKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICBpZiAocG9pbnQueCA+IGN1dG9mZkJhc2VsaW5lVGltZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgLy8gVHJhY2sgbWluL21heCB4IHZhbHVlcyBmb3IgYXhpcyBhZGp1c3RtZW50CiAgICAgICAgaWYgKGRhdGFzZXQuZGF0YS5sZW5ndGggPiAwKSB7CiAgICAgICAgICBjb25zdCB0aW1lcyA9IGRhdGFzZXQuZGF0YS5tYXAocCA9PiBwLngpLmZpbHRlcih0ID0+IHQgIT09IG51bGwgJiYgaXNGaW5pdGUodCkpOwogICAgICAgICAgaWYgKHRpbWVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgY29uc3QgZGF0YXNldE1pbiA9IE1hdGgubWluKC4uLnRpbWVzKTsKICAgICAgICAgICAgY29uc3QgZGF0YXNldE1heCA9IE1hdGgubWF4KC4uLnRpbWVzKTsKICAgICAgICAgICAgaWYgKHhBeGlzTWluID09PSB1bmRlZmluZWQgfHwgZGF0YXNldE1pbiA8IHhBeGlzTWluKSB7CiAgICAgICAgICAgICAgeEF4aXNNaW4gPSBkYXRhc2V0TWluOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh4QXhpc01heCA9PT0gdW5kZWZpbmVkIHx8IGRhdGFzZXRNYXggPiB4QXhpc01heCkgewogICAgICAgICAgICAgIHhBeGlzTWF4ID0gZGF0YXNldE1heDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSBlbHNlIHsKICAgIC8vIEV2ZW4gaWYgY3V0b2ZmIGlzIGRpc2FibGVkLCBjYWxjdWxhdGUgeC1heGlzIHJhbmdlIGZyb20gYWxsIGRhdGFzZXRzIGZvciBwcm9wZXIgZGlzcGxheQogICAgZGF0YXNldHMuZm9yRWFjaChkYXRhc2V0ID0+IHsKICAgICAgaWYgKGRhdGFzZXQuZGF0YSAmJiBkYXRhc2V0LmRhdGEubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnN0IHRpbWVzID0gZGF0YXNldC5kYXRhLm1hcChwID0+IHAueCkuZmlsdGVyKHQgPT4gdCAhPT0gbnVsbCAmJiBpc0Zpbml0ZSh0KSk7CiAgICAgICAgaWYgKHRpbWVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IGRhdGFzZXRNaW4gPSBNYXRoLm1pbiguLi50aW1lcyk7CiAgICAgICAgICBjb25zdCBkYXRhc2V0TWF4ID0gTWF0aC5tYXgoLi4udGltZXMpOwogICAgICAgICAgaWYgKHhBeGlzTWluID09PSB1bmRlZmluZWQgfHwgZGF0YXNldE1pbiA8IHhBeGlzTWluKSB7CiAgICAgICAgICAgIHhBeGlzTWluID0gZGF0YXNldE1pbjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh4QXhpc01heCA9PT0gdW5kZWZpbmVkIHx8IGRhdGFzZXRNYXggPiB4QXhpc01heCkgewogICAgICAgICAgICB4QXhpc01heCA9IGRhdGFzZXRNYXg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CiAgCiAgLy8gU1RFUCA0OiBBZGQgcmVncmVzc2lvbiBjdXJ2ZXMgdG8gZGF0YXNldHMKICBpZiAoZml0UmVncmVzc2lvbikgewogICAgY29uc3QgcmVncmVzc2lvbkRhdGFzZXRzID0gW107CiAgICBjb25zdCBtb25vRXhwUGFyYW1zID0gW107IC8vIFN0b3JlIHBhcmFtZXRlcnMgZm9yIG1vbm8tZXhwb25lbnRpYWwgZml0cwogICAgCiAgICBkYXRhc2V0cy5mb3JFYWNoKGRhdGFzZXQgPT4gewogICAgICBpZiAoZGF0YXNldC5kYXRhICYmIGRhdGFzZXQuZGF0YS5sZW5ndGggPj0gMikgewogICAgICAgIC8vIENoZWNrIGlmIHRoaXMgZGF0YXNldCByZXByZXNlbnRzIGEgY29udHJvbCB3ZWxsCiAgICAgICAgLy8gRXh0cmFjdCB3ZWxsSWQgZnJvbSBsYWJlbCAoZm9ybWF0OiAiTjEgLSBMYWJlbCIgb3IgIk4xIC0gTGFiZWwgQ29udHJvbCBDb2wgMSIpCiAgICAgICAgbGV0IGlzQ29udHJvbCA9IGZhbHNlOwogICAgICAgIGNvbnN0IGxhYmVsID0gZGF0YXNldC5sYWJlbCB8fCAiIjsKICAgICAgICAKICAgICAgICAvLyBNZXRob2QgMTogQ2hlY2sgaWYgbGFiZWwgY29udGFpbnMgIkNvbnRyb2wiIChjYXNlLWluc2Vuc2l0aXZlKQogICAgICAgIGlmIChsYWJlbC50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCJjb250cm9sIikpIHsKICAgICAgICAgIGlzQ29udHJvbCA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIE1ldGhvZCAyOiBUcnkgdG8gZXh0cmFjdCB3ZWxsSWQgZnJvbSBsYWJlbCBhbmQgY2hlY2sKICAgICAgICAgIC8vIExhYmVsIGZvcm1hdCBpcyB0eXBpY2FsbHk6ICJOMSAtIExhYmVsIENvbCAxIiBvciAiTjEgLSBMYWJlbCIKICAgICAgICAgIGNvbnN0IHdlbGxJZE1hdGNoID0gbGFiZWwubWF0Y2goL14oW0EtWl1cZCspXHMqLS8pOwogICAgICAgICAgaWYgKHdlbGxJZE1hdGNoKSB7CiAgICAgICAgICAgIGNvbnN0IHdlbGxJZCA9IHdlbGxJZE1hdGNoWzFdOwogICAgICAgICAgICBpc0NvbnRyb2wgPSBpc0NvbnRyb2xXZWxsKHdlbGxJZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFVzZSBsaW5lYXIgcmVncmVzc2lvbiBmb3IgY29udHJvbHMsIG90aGVyd2lzZSB1c2Ugc2VsZWN0ZWQgcmVncmVzc2lvbiB0eXBlCiAgICAgICAgY29uc3QgcmVncmVzc2lvblR5cGVUb1VzZSA9IGlzQ29udHJvbCA/ICdsaW5lYXInIDogcmVncmVzc2lvblR5cGU7CiAgICAgICAgCiAgICAgICAgLy8gRml0IHJlZ3Jlc3Npb24gY3VydmUKICAgICAgICBjb25zdCBmaXRGdW5jdGlvbiA9IGZpdFJlZ3Jlc3Npb25DdXJ2ZShkYXRhc2V0LmRhdGEsIHJlZ3Jlc3Npb25UeXBlVG9Vc2UsIHBvbHlub21pYWxPcmRlcik7CiAgICAgICAgaWYgKGZpdEZ1bmN0aW9uKSB7CiAgICAgICAgICAvLyBHZXQgdGltZSByYW5nZSBmcm9tIGRhdGEKICAgICAgICAgIGNvbnN0IHRpbWVzID0gZGF0YXNldC5kYXRhLm1hcChwID0+IHAueCkuZmlsdGVyKHQgPT4gdCAhPT0gbnVsbCAmJiBpc0Zpbml0ZSh0KSk7CiAgICAgICAgICBpZiAodGltZXMubGVuZ3RoID09PSAwKSByZXR1cm47CiAgICAgICAgICAKICAgICAgICAgIGNvbnN0IG1pblRpbWUgPSBNYXRoLm1pbiguLi50aW1lcyk7CiAgICAgICAgICBjb25zdCBtYXhUaW1lID0gTWF0aC5tYXgoLi4udGltZXMpOwogICAgICAgICAgCiAgICAgICAgICAvLyBHZW5lcmF0ZSByZWdyZXNzaW9uIGN1cnZlIHBvaW50cwogICAgICAgICAgY29uc3QgbnVtUG9pbnRzID0gMTAwOwogICAgICAgICAgY29uc3QgcmVncmVzc2lvbkRhdGEgPSBbXTsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IG51bVBvaW50czsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHQgPSBtaW5UaW1lICsgKG1heFRpbWUgLSBtaW5UaW1lKSAqIChpIC8gbnVtUG9pbnRzKTsKICAgICAgICAgICAgY29uc3QgeSA9IGZpdEZ1bmN0aW9uKHQpOwogICAgICAgICAgICBpZiAoeSAhPT0gbnVsbCAmJiBpc0Zpbml0ZSh5KSkgewogICAgICAgICAgICAgIHJlZ3Jlc3Npb25EYXRhLnB1c2goeyB4OiB0LCB5OiB5IH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAKICAgICAgICAgIGlmIChyZWdyZXNzaW9uRGF0YS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSByZWdyZXNzaW9uIGRhdGFzZXQgd2l0aCBzYW1lIGNvbG9yIGJ1dCBkaWZmZXJlbnQgc3R5bGUKICAgICAgICAgICAgY29uc3QgcmVncmVzc2lvbkNvbG9yID0gZGF0YXNldC5ib3JkZXJDb2xvciB8fCBkYXRhc2V0LmJhY2tncm91bmRDb2xvciB8fCAicmdiYSgxMjgsIDEyOCwgMTI4LCAxLjApIjsKICAgICAgICAgICAgcmVncmVzc2lvbkRhdGFzZXRzLnB1c2goewogICAgICAgICAgICAgIGxhYmVsOiBgJHtkYXRhc2V0LmxhYmVsfSAoJHtyZWdyZXNzaW9uVHlwZVRvVXNlfSBmaXQpYCwKICAgICAgICAgICAgICBkYXRhOiByZWdyZXNzaW9uRGF0YSwKICAgICAgICAgICAgICBib3JkZXJDb2xvcjogcmVncmVzc2lvbkNvbG9yLAogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogInRyYW5zcGFyZW50IiwKICAgICAgICAgICAgICBib3JkZXJXaWR0aDogMiwKICAgICAgICAgICAgICBib3JkZXJEYXNoOiBbNSwgNV0sIC8vIERhc2hlZCBsaW5lIGZvciByZWdyZXNzaW9uCiAgICAgICAgICAgICAgcG9pbnRSYWRpdXM6IDAsIC8vIE5vIHBvaW50cyBvbiByZWdyZXNzaW9uIGxpbmUKICAgICAgICAgICAgICB0ZW5zaW9uOiAwLAogICAgICAgICAgICAgIGZpbGw6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU3RvcmUgbW9uby1leHBvbmVudGlhbCBwYXJhbWV0ZXJzIGZvciBpbmZvIHBhbmVsCiAgICAgICAgICAgIC8vIE9ubHkgc3RvcmUgaWYgdXNpbmcgbW9uby1leHBvbmVudGlhbCAobm90IGZvciBjb250cm9scyB3aGljaCB1c2UgbGluZWFyKQogICAgICAgICAgICBpZiAocmVncmVzc2lvblR5cGVUb1VzZSA9PT0gJ21vbm8tZXhwb25lbnRpYWwnICYmIGZpdEZ1bmN0aW9uLnBhcmFtcykgewogICAgICAgICAgICAgIC8vIFJlbW92ZSByZXBsaWNhdGUgYW5kIGRhdGFzZXQgaW5mbyBmcm9tIGxhYmVsIGZvciByZWdyZXNzaW9uIGxpbmVzCiAgICAgICAgICAgICAgLy8gUGF0dGVybjogcmVtb3ZlICIoWC1wbGljYXRlLCBZIGRhdGFzZXRzLCBtZWFuIMKxIFNFKSIgb3Igc2ltaWxhciBwYXR0ZXJucwogICAgICAgICAgICAgIGxldCBjbGVhbkxhYmVsID0gZGF0YXNldC5sYWJlbDsKICAgICAgICAgICAgICAvLyBSZW1vdmUgcGF0dGVybnMgY29udGFpbmluZyBwbGljYXRlLCBkYXRhc2V0cywgb3IgbWVhbiDCsSBTRSBpbiBwYXJlbnRoZXNlcwogICAgICAgICAgICAgIGNsZWFuTGFiZWwgPSBjbGVhbkxhYmVsLnJlcGxhY2UoL1xzKlwoW14pXSooPzpwbGljYXRlfGRhdGFzZXRzfG1lYW5ccyrCsVxzKlNFKVteKV0qXCkvZ2ksICcnKTsKICAgICAgICAgICAgICAvLyBDbGVhbiB1cCBhbnkgZG91YmxlIHNwYWNlcyBvciB0cmFpbGluZy9sZWFkaW5nIHNwYWNlcwogICAgICAgICAgICAgIGNsZWFuTGFiZWwgPSBjbGVhbkxhYmVsLnJlcGxhY2UoL1xzKy9nLCAnICcpLnRyaW0oKTsKICAgICAgICAgICAgICAKICAgICAgICAgICAgICBtb25vRXhwUGFyYW1zLnB1c2goewogICAgICAgICAgICAgICAgbGFiZWw6IGNsZWFuTGFiZWwsCiAgICAgICAgICAgICAgICBwYXJhbXM6IGZpdEZ1bmN0aW9uLnBhcmFtcywKICAgICAgICAgICAgICAgIGNvbG9yOiByZWdyZXNzaW9uQ29sb3IgLy8gVXNlIHRoZSBzYW1lIGNvbG9yIGFzIHRoZSByZWdyZXNzaW9uIGN1cnZlCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgCiAgICAvLyBBZGQgcmVncmVzc2lvbiBkYXRhc2V0cyB0byB0aGUgbWFpbiBkYXRhc2V0cyBhcnJheQogICAgZGF0YXNldHMucHVzaCguLi5yZWdyZXNzaW9uRGF0YXNldHMpOwogICAgCiAgICAvLyBVcGRhdGUgaW5mbyBwYW5lbCBmb3IgbW9uby1leHBvbmVudGlhbAogICAgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAnbW9uby1leHBvbmVudGlhbCcpIHsKICAgICAgdXBkYXRlTW9ub0V4cG9uZW50aWFsSW5mb1BhbmVsKG1vbm9FeHBQYXJhbXMpOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgaW5mb1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlZ3Jlc3Npb24taW5mby1wYW5lbCIpOwogICAgICBpZiAoaW5mb1BhbmVsKSB7CiAgICAgICAgaW5mb1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgIH0KICAgIH0KICAgIAogICAgLy8gUmVjYWxjdWxhdGUgeC1heGlzIHJhbmdlIHRvIGluY2x1ZGUgcmVncmVzc2lvbiBjdXJ2ZXMKICAgIGlmIChjdXRvZmZCYXNlbGluZSkgewogICAgICBkYXRhc2V0cy5mb3JFYWNoKGRhdGFzZXQgPT4gewogICAgICAgIGlmIChkYXRhc2V0LmRhdGEgJiYgZGF0YXNldC5kYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IHRpbWVzID0gZGF0YXNldC5kYXRhLm1hcChwID0+IHAueCkuZmlsdGVyKHQgPT4gdCAhPT0gbnVsbCAmJiBpc0Zpbml0ZSh0KSk7CiAgICAgICAgICBpZiAodGltZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBkYXRhc2V0TWluID0gTWF0aC5taW4oLi4udGltZXMpOwogICAgICAgICAgICBjb25zdCBkYXRhc2V0TWF4ID0gTWF0aC5tYXgoLi4udGltZXMpOwogICAgICAgICAgICBpZiAoeEF4aXNNaW4gPT09IHVuZGVmaW5lZCB8fCBkYXRhc2V0TWluIDwgeEF4aXNNaW4pIHsKICAgICAgICAgICAgICB4QXhpc01pbiA9IGRhdGFzZXRNaW47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHhBeGlzTWF4ID09PSB1bmRlZmluZWQgfHwgZGF0YXNldE1heCA+IHhBeGlzTWF4KSB7CiAgICAgICAgICAgICAgeEF4aXNNYXggPSBkYXRhc2V0TWF4OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CgogIC8vIERldGVybWluZSB5LWF4aXMgbGFiZWwgYmFzZWQgb24gcHJvY2Vzc2luZyBzdGVwcwogIGxldCB5QXhpc0xhYmVsID0gIkZsdW9yZXNjZW5jZSAoRkkpIjsKICBpZiAoYmFzZWxpbmVTdWJ0cmFjdCAmJiBub3JtYWxpemVCYXNlbGluZSkgewogICAgeUF4aXNMYWJlbCA9ICLOlEYvRiAoTm9ybWFsaXplZCkiOwogIH0gZWxzZSBpZiAobm9ybWFsaXplQmFzZWxpbmUpIHsKICAgIGlmIChub3JtYWxpemF0aW9uTW9kZSA9PT0gJ25vbmUnKSB7CiAgICAgIHlBeGlzTGFiZWwgPSAiRmx1b3Jlc2NlbmNlIChGSSkiOwogICAgfSBlbHNlIGlmIChub3JtYWxpemF0aW9uTW9kZSA9PT0gJ2RlbHRhX2Zfb3Zlcl9mJykgewogICAgICB5QXhpc0xhYmVsID0gIs6URi9GIChOb3JtYWxpemVkKSI7CiAgICB9IGVsc2UgaWYgKG5vcm1hbGl6YXRpb25Nb2RlID09PSAnbG93ZXN0X3BvaW50JykgewogICAgICB5QXhpc0xhYmVsID0gIkYvRl9taW4gKE5vcm1hbGl6ZWQpIjsKICAgIH0gZWxzZSBpZiAobm9ybWFsaXphdGlvbk1vZGUgPT09ICdmaXJzdF9wb2ludCcpIHsKICAgICAgeUF4aXNMYWJlbCA9ICJGL0ZfZmlyc3QgKE5vcm1hbGl6ZWQpIjsKICAgIH0gZWxzZSB7CiAgICAgIHlBeGlzTGFiZWwgPSAiRi9G4oKAIChOb3JtYWxpemVkKSI7CiAgICB9CiAgfSBlbHNlIGlmIChiYXNlbGluZVN1YnRyYWN0KSB7CiAgICB5QXhpc0xhYmVsID0gIs6URiAoRkkpIjsKICB9CgogIC8vIFRyYW5zZm9ybSBleGlzdGluZyBjaGFydCBpbnN0ZWFkIG9mIHJlY3JlYXRpbmcKICBpZiAoY2hhcnQpIHsKICAgIC8vIENsZWFyIGV4aXN0aW5nIGRhdGFzZXRzCiAgICB3aGlsZSAoY2hhcnQuZGF0YS5kYXRhc2V0cy5sZW5ndGggPiAwKSB7CiAgICAgIGNoYXJ0LmRhdGEuZGF0YXNldHMucG9wKCk7CiAgICB9CiAgICAKICAgIC8vIEFkZCBuZXcgZGF0YXNldHMKICAgIGRhdGFzZXRzLmZvckVhY2goZGF0YXNldCA9PiB7CiAgICAgIGNoYXJ0LmRhdGEuZGF0YXNldHMucHVzaChkYXRhc2V0KTsKICAgIH0pOwogICAgCiAgICAvLyBVcGRhdGUgY2hhcnQgb3B0aW9ucwogICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueC50aXRsZS50ZXh0ID0gIlRpbWUgKHMpIjsKICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLnkudGl0bGUudGV4dCA9IHlBeGlzTGFiZWw7CiAgICBjaGFydC5vcHRpb25zLnNjYWxlcy55Lm1pbiA9IHVuZGVmaW5lZDsKICAgIAogICAgLy8gQWRqdXN0IHgtYXhpcyByYW5nZSBiYXNlZCBvbiBmaWx0ZXJlZCBkYXRhIChTdGVwIDMpCiAgICBpZiAoY3V0b2ZmQmFzZWxpbmUgJiYgeEF4aXNNaW4gIT09IHVuZGVmaW5lZCAmJiB4QXhpc01heCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIC8vIEFkZCBzbWFsbCBwYWRkaW5nICgyJSUgb2YgcmFuZ2UpIGZvciBiZXR0ZXIgdmlzdWFsaXphdGlvbgogICAgICBjb25zdCBwYWRkaW5nID0gKHhBeGlzTWF4IC0geEF4aXNNaW4pICogMC4wMjsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueC5taW4gPSBNYXRoLm1heCgwLCB4QXhpc01pbiAtIHBhZGRpbmcpOwogICAgICBjaGFydC5vcHRpb25zLnNjYWxlcy54Lm1heCA9IHhBeGlzTWF4ICsgcGFkZGluZzsKICAgIH0gZWxzZSB7CiAgICAgIC8vIFJlc2V0IHRvIGF1dG8gaWYgY3V0b2ZmIGlzIGRpc2FibGVkCiAgICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLngubWluID0gdW5kZWZpbmVkOwogICAgICBjaGFydC5vcHRpb25zLnNjYWxlcy54Lm1heCA9IHVuZGVmaW5lZDsKICAgIH0KICAgIAogICAgLy8gQ291bnQgb25seSB3ZWxscyB0aGF0IGFyZSBhY3R1YWxseSBkaXNwbGF5ZWQgKGFjY291bnRpbmcgZm9yIGV4Y2x1c2lvbnMpCiAgICAvLyBDb3VudCB1bmlxdWUgd2VsbCBncm91cHMvZGF0YXNldHMgdGhhdCBhcmUgYWN0dWFsbHkgZGlzcGxheWVkCiAgICBjb25zdCBkaXNwbGF5ZWRXZWxsQ291bnQgPSBkYXRhc2V0cy5sZW5ndGg7CiAgICBjaGFydC5vcHRpb25zLnBsdWdpbnMudGl0bGUudGV4dCA9IGBUaW1lIENvdXJzZSAtICR7ZGlzcGxheWVkV2VsbENvdW50fSB3ZWxsKHMpIHNlbGVjdGVkYDsKICAgIGNoYXJ0Lm9wdGlvbnMucGx1Z2lucy5sZWdlbmQuZGlzcGxheSA9IGRhdGFzZXRzLmxlbmd0aCA+IDA7CiAgICAKICAgIC8vIEZvcmNlIENoYXJ0LmpzIHRvIHVwZGF0ZSAtIHVzZSB1cGRhdGUoKSB3aXRob3V0IG1vZGUgdG8gZW5zdXJlIHByb3BlciByZWRyYXcKICAgIGNoYXJ0LnVwZGF0ZSgpOwogIH0gZWxzZSB7CiAgICAvLyBDcmVhdGUgbmV3IGNoYXJ0IG9ubHkgaWYgaXQgZG9lc24ndCBleGlzdAogICAgY2hhcnQgPSBuZXcgQ2hhcnQoY3R4LCB7CiAgICAgIHR5cGU6ICJsaW5lIiwKICAgICAgZGF0YTogewogICAgICAgIGRhdGFzZXRzOiBkYXRhc2V0cwogICAgICB9LAogICAgICBvcHRpb25zOiB7CiAgICAgICAgcmVzcG9uc2l2ZTogdHJ1ZSwKICAgICAgICBtYWludGFpbkFzcGVjdFJhdGlvOiBmYWxzZSwKICAgICAgICBwYXJzaW5nOiBmYWxzZSwKICAgICAgICBzY2FsZXM6IHsKICAgICAgICAgICAgeDogeyAKICAgICAgICAgICAgICB0eXBlOiAibGluZWFyIiwgCiAgICAgICAgICAgICAgdGl0bGU6IHsgCiAgICAgICAgICAgICAgICBkaXNwbGF5OiB0cnVlLAogICAgICAgICAgICAgICAgdGV4dDogIlRpbWUgKHMpIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgbWluOiBjdXRvZmZCYXNlbGluZSAmJiB4QXhpc01pbiAhPT0gdW5kZWZpbmVkID8gTWF0aC5tYXgoMCwgeEF4aXNNaW4gLSAoeEF4aXNNYXggLSB4QXhpc01pbikgKiAwLjAyKSA6IHVuZGVmaW5lZCwKICAgICAgICAgICAgICBtYXg6IGN1dG9mZkJhc2VsaW5lICYmIHhBeGlzTWF4ICE9PSB1bmRlZmluZWQgPyB4QXhpc01heCArICh4QXhpc01heCAtIHhBeGlzTWluKSAqIDAuMDIgOiB1bmRlZmluZWQKICAgICAgICAgICAgfSwKICAgICAgICAgICAgeTogeyAKICAgICAgICAgICAgICB0aXRsZTogeyAKICAgICAgICAgICAgICAgIGRpc3BsYXk6IHRydWUsCiAgICAgICAgICAgICAgICB0ZXh0OiB5QXhpc0xhYmVsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG1pbjogdW5kZWZpbmVkCiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBwbHVnaW5zOiB7CiAgICAgICAgICBsZWdlbmQ6IHsKICAgICAgICAgICAgZGlzcGxheTogZGF0YXNldHMubGVuZ3RoID4gMCwgLy8gU2hvdyBsZWdlbmQgd2hlbiB0aGVyZSBhcmUgZGF0YXNldHMKICAgICAgICAgICAgcG9zaXRpb246ICJ0b3AiLAogICAgICAgICAgICBvbkNsaWNrOiBudWxsLAogICAgICAgICAgICBsYWJlbHM6IHsKICAgICAgICAgICAgICB1c2VQb2ludFN0eWxlOiB0cnVlLAogICAgICAgICAgICAgIHBhZGRpbmc6IDE1LAogICAgICAgICAgICAgIGZvbnQ6IHsKICAgICAgICAgICAgICAgIHNpemU6IDExCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBnZW5lcmF0ZUxhYmVsczogZnVuY3Rpb24oY2hhcnQpIHsKICAgICAgICAgICAgICAgIC8vIEN1c3RvbSBsYWJlbCBnZW5lcmF0aW9uIHRvIHNob3cgY29sb3IgYW5kIHdlbGwgbmFtZSBjbGVhcmx5CiAgICAgICAgICAgICAgICBjb25zdCBvcmlnaW5hbCA9IENoYXJ0LmRlZmF1bHRzLnBsdWdpbnMubGVnZW5kLmxhYmVscy5nZW5lcmF0ZUxhYmVsczsKICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVscyA9IG9yaWdpbmFsLmNhbGwodGhpcywgY2hhcnQpOwogICAgICAgICAgICAgICAgLy8gTGFiZWxzIGFscmVhZHkgaGF2ZSB0aGUgY29ycmVjdCB0ZXh0IGZyb20gZGF0YXNldC5sYWJlbAogICAgICAgICAgICAgICAgcmV0dXJuIGxhYmVsczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICB0aXRsZTogewogICAgICAgICAgICBkaXNwbGF5OiB0cnVlLAogICAgICAgICAgICB0ZXh0OiBgVGltZSBDb3Vyc2UgLSAke2RhdGFzZXRzLmxlbmd0aH0gd2VsbChzKSBzZWxlY3RlZGAKICAgICAgICAgIH0sCiAgICAgICAgICB0b29sdGlwOiB7CiAgICAgICAgICAgIGNhbGxiYWNrczogewogICAgICAgICAgICAgIGxhYmVsOiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgICBsZXQgbGFiZWwgPSBjb250ZXh0LmRhdGFzZXQubGFiZWwgfHwgIiI7CiAgICAgICAgICAgICAgICBpZiAobGFiZWwpIHsKICAgICAgICAgICAgICAgICAgbGFiZWwgKz0gIjogIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjb250ZXh0LnBhcnNlZC55ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxhYmVsICs9IGNvbnRleHQucGFyc2VkLnkudG9GaXhlZCgyKTsKICAgICAgICAgICAgICAgICAgLy8gU2hvdyBlcnJvciBpZiBhdmFpbGFibGUKICAgICAgICAgICAgICAgICAgaWYgKGNvbnRleHQucmF3ICYmIGNvbnRleHQucmF3LmVycm9yICE9PSB1bmRlZmluZWQgJiYgY29udGV4dC5yYXcuZXJyb3IgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBsYWJlbCArPSAiIMKxICIgKyBjb250ZXh0LnJhdy5lcnJvci50b0ZpeGVkKDIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbGFiZWw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9Cn0KCi8vIEluaXRpYWxpemUgc2V0dGluZ3MgZGlzcGxheSBvbiBwYWdlIGxvYWQKdXBkYXRlQ3VycmVudFNldHRpbmdzRGlzcGxheSgpOwovLyBJbml0aWFsaXplIGJhc2VsaW5lIG1ldGhvZCBwYXJhbXMgdG8gc2hvdy9oaWRlIExPV0VTUy9wb2x5bm9taWFsIHBhcmFtZXRlcnMgYmFzZWQgb24gZGVmYXVsdCBzZWxlY3Rpb24KdXBkYXRlQmFzZWxpbmVNZXRob2RQYXJhbXMoKTsKLy8gSW5pdGlhbGl6ZSByZWdyZXNzaW9uIHR5cGUgcGFyYW1zIHRvIHNob3cvaGlkZSBpbmZvIHBhbmVsIGJhc2VkIG9uIGRlZmF1bHQgc2VsZWN0aW9uCi8vIFNraXAgY2hhcnQgdXBkYXRlIGR1cmluZyBpbml0aWFsaXphdGlvbgp1cGRhdGVSZWdyZXNzaW9uVHlwZVBhcmFtcyh0cnVlKTsKCmxvYWREYXRhKCkuY2F0Y2goZXJyID0+IHsKICBjb25zb2xlLmVycm9yKCJGYWlsZWQgdG8gbG9hZCB2aWV3ZXJfZGF0YS5qc29uOiIsIGVycik7CiAgYWxlcnQoIkNvdWxkIG5vdCBsb2FkIHZpZXdlcl9kYXRhLmpzb24uIERpZCB5b3UgcnVuIHRoZSBQeXRob24gc2NyaXB0IGluIHRoZSBzYW1lIGZvbGRlcj8iKTsKfSk7Cjwvc2NyaXB0Pgo8L2JvZHk+CjwvaHRtbD4KIiIiCgoKZGVmIHdyaXRlX2h0bWwoaHRtbF9wYXRoOiBzdHIpOgogICAgaHRtbCA9IEhUTUxfVEVNUExBVEUgJSB7CiAgICAgICAgInJvd3MiOiBQTEFURV9ST1dTLAogICAgICAgICJjb2xzIjogUExBVEVfQ09MUywKICAgIH0KICAgIHdpdGggb3BlbihodG1sX3BhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICBmLndyaXRlKGh0bWwpCgoKZGVmIHdyaXRlX3dlYl9jb21tYW5kKHNjcmlwdF9kaXI6IHN0ciwgd2ViX2Rpcjogc3RyKToKICAgICIiIgogICAgQ3JlYXRlIGRvdWJsZS1jbGlja2FibGUgbGF1bmNoZXIgZmlsZXMgZm9yIHdlYiBzZXJ2ZXI6CiAgICAtICd3ZWIuY29tbWFuZCcgZm9yIG1hY09TL0xpbnV4IChkb3VibGUtY2xpY2thYmxlIGluIEZpbmRlcikKICAgIC0gJ3dlYi5iYXQnIGZvciBXaW5kb3dzIChkb3VibGUtY2xpY2thYmxlIGluIEV4cGxvcmVyKQogICAgLSAnd2ViX3NlcnZlci5wczEnIGZvciBXaW5kb3dzIFBvd2VyU2hlbGwgSFRUUCBzZXJ2ZXIgKGZhbGxiYWNrIHdoZW4gUHl0aG9uIG5vdCBhdmFpbGFibGUpCiAgICAiIiIKICAgIHdlYl9jb21tYW5kX3BhdGggPSBvcy5wYXRoLmpvaW4oc2NyaXB0X2RpciwgIndlYi5jb21tYW5kIikKICAgIAogICAgd2ViX2NvbW1hbmRfY29udGVudCA9IGYiIiIjIS9iaW4vYmFzaAojIERvdWJsZS1jbGlja2FibGUgd2ViIHNlcnZlciBsYXVuY2hlciBmb3IgUGxhdGUgVmlld2VyCiMgVGhpcyBmaWxlIGlzIGF1dG8tZ2VuZXJhdGVkIGJ5IHBsYXRlX3ZpZXdlci5weQoKUE9SVD04MDAwCiMgR2V0IHRoZSBkaXJlY3Rvcnkgd2hlcmUgdGhpcyBzY3JpcHQgaXMgbG9jYXRlZApTQ1JJUFRfRElSPSIkKGNkICIkKGRpcm5hbWUgIiQwIikiICYmIHB3ZCkiCldFQl9ESVI9IiRTQ1JJUFRfRElSL3dlYiIKCiMgQ2hhbmdlIHRvIHdlYiBkaXJlY3RvcnkKY2QgIiRXRUJfRElSIiB8fCB7ewogICAgZWNobyAiRXJyb3I6IENvdWxkIG5vdCBmaW5kIHdlYiBkaXJlY3Rvcnk6ICRXRUJfRElSIgogICAgZWNobyAiUGxlYXNlIHJ1biBwbGF0ZV92aWV3ZXIucHkgZmlyc3QgdG8gZ2VuZXJhdGUgdGhlIHdlYiBmaWxlcy4iCiAgICByZWFkIC1wICJQcmVzcyBFbnRlciB0byBleGl0Li4uIgogICAgZXhpdCAxCn19CgojIENoZWNrIGlmIHZpZXdlcl9kYXRhLmpzb24gZXhpc3RzCmlmIFsgISAtZiAidmlld2VyX2RhdGEuanNvbiIgXTsgdGhlbgogICAgZWNobyAiV2FybmluZzogdmlld2VyX2RhdGEuanNvbiBub3QgZm91bmQhIgogICAgZWNobyAiUGxlYXNlIHJ1biBwbGF0ZV92aWV3ZXIucHkgZmlyc3QgdG8gZ2VuZXJhdGUgdGhlIGRhdGEgZmlsZXMuIgogICAgZWNobyAiIgpmaQoKVVJMPSJodHRwOi8vbG9jYWxob3N0OiR7e1BPUlR9fS9pbmRleC5odG1sIgoKZWNobyAiPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IgplY2hvICJQbGF0ZSBWaWV3ZXIgV2ViIFNlcnZlciIKZWNobyAiPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IgplY2hvICJTZXJ2ZXIgcnVubmluZyBhdDogJFVSTCIKZWNobyAiU2VydmluZyBkaXJlY3Rvcnk6ICRXRUJfRElSIgplY2hvICIiCmVjaG8gIlByZXNzIEN0cmwrQyB0byBzdG9wIHRoZSBzZXJ2ZXIiCmVjaG8gIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKZWNobyAiIgoKIyBUcnkgdG8gb3BlbiBicm93c2VyIGF1dG9tYXRpY2FsbHkgYWZ0ZXIgYSBzaG9ydCBkZWxheQooc2xlZXAgMiAmJiBpZiBjb21tYW5kIC12IG9wZW4gJj4gL2Rldi9udWxsOyB0aGVuCiAgICBvcGVuICIkVVJMIiAyPi9kZXYvbnVsbCAmJiBlY2hvICJPcGVuZWQgJFVSTCBpbiB5b3VyIGRlZmF1bHQgYnJvd3NlciIgfHwgZWNobyAiUGxlYXNlIG9wZW4gJFVSTCBtYW51YWxseSBpbiB5b3VyIGJyb3dzZXIiCmVsaWYgY29tbWFuZCAtdiB4ZGctb3BlbiAmPiAvZGV2L251bGw7IHRoZW4KICAgIHhkZy1vcGVuICIkVVJMIiAyPi9kZXYvbnVsbCAmJiBlY2hvICJPcGVuZWQgJFVSTCBpbiB5b3VyIGRlZmF1bHQgYnJvd3NlciIgfHwgZWNobyAiUGxlYXNlIG9wZW4gJFVSTCBtYW51YWxseSBpbiB5b3VyIGJyb3dzZXIiCmVsc2UKICAgIGVjaG8gIlBsZWFzZSBvcGVuICRVUkwgbWFudWFsbHkgaW4geW91ciBicm93c2VyIgpmaSkgJgoKIyBUcnkgUHl0aG9uIDMgZmlyc3QsIHRoZW4gUHl0aG9uIDIsIHRoZW4gZXhpdCB3aXRoIGVycm9yCmlmIGNvbW1hbmQgLXYgcHl0aG9uMyAmPiAvZGV2L251bGw7IHRoZW4KICAgIHB5dGhvbjMgLW0gaHR0cC5zZXJ2ZXIgIiRQT1JUIgplbGlmIGNvbW1hbmQgLXYgcHl0aG9uICY+IC9kZXYvbnVsbDsgdGhlbgogICAgcHl0aG9uIC1tIFNpbXBsZUhUVFBTZXJ2ZXIgIiRQT1JUIgplbHNlCiAgICBlY2hvICJFcnJvcjogUHl0aG9uIG5vdCBmb3VuZC4gUGxlYXNlIGluc3RhbGwgUHl0aG9uIHRvIHJ1biBhIGxvY2FsIHNlcnZlci4iCiAgICByZWFkIC1wICJQcmVzcyBFbnRlciB0byBleGl0Li4uIgogICAgZXhpdCAxCmZpCiIiIgogICAgCiAgICB3aXRoIG9wZW4od2ViX2NvbW1hbmRfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgIGYud3JpdGUod2ViX2NvbW1hbmRfY29udGVudCkKICAgIAogICAgIyBNYWtlIGl0IGV4ZWN1dGFibGUKICAgIG9zLmNobW9kKHdlYl9jb21tYW5kX3BhdGgsIDBvNzU1KQogICAgCiAgICAjIENyZWF0ZSBXaW5kb3dzIFBvd2VyU2hlbGwgSFRUUCBzZXJ2ZXIgc2NyaXB0CiAgICB3ZWJfc2VydmVyX3BzMV9wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJ3ZWJfc2VydmVyLnBzMSIpCiAgICAKICAgIHdlYl9zZXJ2ZXJfcHMxX2NvbnRlbnQgPSBmIiIiIyBQb3dlclNoZWxsIEhUVFAgU2VydmVyIGZvciBQbGF0ZSBWaWV3ZXIKIyBUaGlzIHNjcmlwdCBzZXJ2ZXMgdGhlIHdlYiBkaXJlY3Rvcnkgd2l0aG91dCByZXF1aXJpbmcgUHl0aG9uCgpwYXJhbSgKICAgIFtpbnRdJFBvcnQgPSA4MDAwLAogICAgW3N0cmluZ10kV2ViRGlyID0gJFBTU2NyaXB0Um9vdCArICJcXHdlYiIKKQoKIyBDcmVhdGUgSFRUUCBsaXN0ZW5lcgokbGlzdGVuZXIgPSBOZXctT2JqZWN0IFN5c3RlbS5OZXQuSHR0cExpc3RlbmVyCiRsaXN0ZW5lci5QcmVmaXhlcy5BZGQoImh0dHA6Ly9sb2NhbGhvc3Q6JFBvcnQvIikKCnRyeSB7ewogICAgJGxpc3RlbmVyLlN0YXJ0KCkKICAgIFdyaXRlLUhvc3QgIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKICAgIFdyaXRlLUhvc3QgIlBsYXRlIFZpZXdlciBXZWIgU2VydmVyIChQb3dlclNoZWxsKSIKICAgIFdyaXRlLUhvc3QgIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKICAgIFdyaXRlLUhvc3QgIlNlcnZlciBydW5uaW5nIGF0OiBodHRwOi8vbG9jYWxob3N0OiRQb3J0L2luZGV4Lmh0bWwiCiAgICBXcml0ZS1Ib3N0ICJTZXJ2aW5nIGRpcmVjdG9yeTogJFdlYkRpciIKICAgIFdyaXRlLUhvc3QgIiIKICAgIFdyaXRlLUhvc3QgIlByZXNzIEN0cmwrQyB0byBzdG9wIHRoZSBzZXJ2ZXIiCiAgICBXcml0ZS1Ib3N0ICI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iCiAgICBXcml0ZS1Ib3N0ICIiCgogICAgIyBPcGVuIGJyb3dzZXIKICAgIFN0YXJ0LVNsZWVwIC1TZWNvbmRzIDIKICAgIFN0YXJ0LVByb2Nlc3MgImh0dHA6Ly9sb2NhbGhvc3Q6JFBvcnQvaW5kZXguaHRtbCIKCiAgICAjIE1haW4gc2VydmVyIGxvb3AKICAgIHdoaWxlICgkbGlzdGVuZXIuSXNMaXN0ZW5pbmcpIHt7CiAgICAgICAgJGNvbnRleHQgPSAkbGlzdGVuZXIuR2V0Q29udGV4dCgpCiAgICAgICAgJHJlcXVlc3QgPSAkY29udGV4dC5SZXF1ZXN0CiAgICAgICAgJHJlc3BvbnNlID0gJGNvbnRleHQuUmVzcG9uc2UKCiAgICAgICAgIyBHZXQgdGhlIHJlcXVlc3RlZCBmaWxlIHBhdGgKICAgICAgICAkbG9jYWxQYXRoID0gJHJlcXVlc3QuVXJsLkxvY2FsUGF0aAogICAgICAgIGlmICgkbG9jYWxQYXRoIC1lcSAnLycgLW9yICRsb2NhbFBhdGggLWVxICcnKSB7ewogICAgICAgICAgICAkbG9jYWxQYXRoID0gJy9pbmRleC5odG1sJwogICAgICAgIH19CgogICAgICAgICMgQnVpbGQgZnVsbCBmaWxlIHBhdGgKICAgICAgICAkZmlsZVBhdGggPSBKb2luLVBhdGggJFdlYkRpciAkbG9jYWxQYXRoLlRyaW1TdGFydCgnLycpCgogICAgICAgICMgQ2hlY2sgaWYgZmlsZSBleGlzdHMKICAgICAgICBpZiAoVGVzdC1QYXRoICRmaWxlUGF0aCAtUGF0aFR5cGUgTGVhZikge3sKICAgICAgICAgICAgdHJ5IHt7CiAgICAgICAgICAgICAgICAjIFJlYWQgZmlsZSBjb250ZW50CiAgICAgICAgICAgICAgICAkY29udGVudCA9IFtTeXN0ZW0uSU8uRmlsZV06OlJlYWRBbGxCeXRlcygkZmlsZVBhdGgpCiAgICAgICAgICAgICAgICAkcmVzcG9uc2UuQ29udGVudExlbmd0aDY0ID0gJGNvbnRlbnQuTGVuZ3RoCiAgICAgICAgICAgICAgICAkcmVzcG9uc2UuU3RhdHVzQ29kZSA9IDIwMAoKICAgICAgICAgICAgICAgICMgU2V0IGNvbnRlbnQgdHlwZSBiYXNlZCBvbiBmaWxlIGV4dGVuc2lvbgogICAgICAgICAgICAgICAgJGV4dGVuc2lvbiA9IFtTeXN0ZW0uSU8uUGF0aF06OkdldEV4dGVuc2lvbigkZmlsZVBhdGgpLlRvTG93ZXIoKQogICAgICAgICAgICAgICAgc3dpdGNoICgkZXh0ZW5zaW9uKSB7ewogICAgICAgICAgICAgICAgICAgICcuaHRtbCcge3sgJHJlc3BvbnNlLkNvbnRlbnRUeXBlID0gJ3RleHQvaHRtbDsgY2hhcnNldD11dGYtOCcgfX0KICAgICAgICAgICAgICAgICAgICAnLmpzb24nIHt7ICRyZXNwb25zZS5Db250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJyB9fQogICAgICAgICAgICAgICAgICAgICcuY3NzJyAge3sgJHJlc3BvbnNlLkNvbnRlbnRUeXBlID0gJ3RleHQvY3NzJyB9fQogICAgICAgICAgICAgICAgICAgICcuanMnICAge3sgJHJlc3BvbnNlLkNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2phdmFzY3JpcHQnIH19CiAgICAgICAgICAgICAgICAgICAgJy5wbmcnICB7eyAkcmVzcG9uc2UuQ29udGVudFR5cGUgPSAnaW1hZ2UvcG5nJyB9fQogICAgICAgICAgICAgICAgICAgICcuanBnJyAge3sgJHJlc3BvbnNlLkNvbnRlbnRUeXBlID0gJ2ltYWdlL2pwZWcnIH19CiAgICAgICAgICAgICAgICAgICAgJy5qcGVnJyB7eyAkcmVzcG9uc2UuQ29udGVudFR5cGUgPSAnaW1hZ2UvanBlZycgfX0KICAgICAgICAgICAgICAgICAgICAnLmdpZicgIHt7ICRyZXNwb25zZS5Db250ZW50VHlwZSA9ICdpbWFnZS9naWYnIH19CiAgICAgICAgICAgICAgICAgICAgJy5zdmcnICB7eyAkcmVzcG9uc2UuQ29udGVudFR5cGUgPSAnaW1hZ2Uvc3ZnK3htbCcgfX0KICAgICAgICAgICAgICAgICAgICBkZWZhdWx0IHt7ICRyZXNwb25zZS5Db250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nIH19CiAgICAgICAgICAgICAgICB9fQoKICAgICAgICAgICAgICAgICMgV3JpdGUgY29udGVudCB0byByZXNwb25zZQogICAgICAgICAgICAgICAgJHJlc3BvbnNlLk91dHB1dFN0cmVhbS5Xcml0ZSgkY29udGVudCwgMCwgJGNvbnRlbnQuTGVuZ3RoKQogICAgICAgICAgICB9fQogICAgICAgICAgICBjYXRjaCB7ewogICAgICAgICAgICAgICAgJHJlc3BvbnNlLlN0YXR1c0NvZGUgPSA1MDAKICAgICAgICAgICAgICAgICRlcnJvck1zZyA9IFtTeXN0ZW0uVGV4dC5FbmNvZGluZ106OlVURjguR2V0Qnl0ZXMoIjUwMCBJbnRlcm5hbCBTZXJ2ZXIgRXJyb3I6ICRfIikKICAgICAgICAgICAgICAgICRyZXNwb25zZS5Db250ZW50TGVuZ3RoNjQgPSAkZXJyb3JNc2cuTGVuZ3RoCiAgICAgICAgICAgICAgICAkcmVzcG9uc2UuT3V0cHV0U3RyZWFtLldyaXRlKCRlcnJvck1zZywgMCwgJGVycm9yTXNnLkxlbmd0aCkKICAgICAgICAgICAgfX0KICAgICAgICB9fQogICAgICAgIGVsc2Uge3sKICAgICAgICAgICAgIyBGaWxlIG5vdCBmb3VuZAogICAgICAgICAgICAkcmVzcG9uc2UuU3RhdHVzQ29kZSA9IDQwNAogICAgICAgICAgICAkbm90Rm91bmQgPSBbU3lzdGVtLlRleHQuRW5jb2RpbmddOjpVVEY4LkdldEJ5dGVzKCI0MDQgTm90IEZvdW5kOiAkbG9jYWxQYXRoIikKICAgICAgICAgICAgJHJlc3BvbnNlLkNvbnRlbnRMZW5ndGg2NCA9ICRub3RGb3VuZC5MZW5ndGgKICAgICAgICAgICAgJHJlc3BvbnNlLkNvbnRlbnRUeXBlID0gJ3RleHQvcGxhaW4nCiAgICAgICAgICAgICRyZXNwb25zZS5PdXRwdXRTdHJlYW0uV3JpdGUoJG5vdEZvdW5kLCAwLCAkbm90Rm91bmQuTGVuZ3RoKQogICAgICAgIH19CgogICAgICAgICMgQ2xvc2UgcmVzcG9uc2UKICAgICAgICAkcmVzcG9uc2UuQ2xvc2UoKQogICAgfX0KfX0KY2F0Y2gge3sKICAgIFdyaXRlLUhvc3QgIkVycm9yOiAkXyIgLUZvcmVncm91bmRDb2xvciBSZWQKICAgIFdyaXRlLUhvc3QgIlByZXNzIGFueSBrZXkgdG8gZXhpdC4uLiIKICAgICRudWxsID0gJEhvc3QuVUkuUmF3VUkuUmVhZEtleSgiTm9FY2hvLEluY2x1ZGVLZXlEb3duIikKfX0KZmluYWxseSB7ewogICAgaWYgKCRsaXN0ZW5lci5Jc0xpc3RlbmluZykge3sKICAgICAgICAkbGlzdGVuZXIuU3RvcCgpCiAgICB9fQogICAgJGxpc3RlbmVyLkNsb3NlKCkKfX0KIiIiCiAgICAKICAgIHdpdGggb3Blbih3ZWJfc2VydmVyX3BzMV9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZi53cml0ZSh3ZWJfc2VydmVyX3BzMV9jb250ZW50KQogICAgCiAgICAjIENyZWF0ZSBXaW5kb3dzIC5iYXQgZmlsZQogICAgd2ViX2JhdF9wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJ3ZWIuYmF0IikKICAgIAogICAgd2ViX2JhdF9jb250ZW50ID0gZiIiIkBlY2hvIG9mZgpSRU0gRG91YmxlLWNsaWNrYWJsZSB3ZWIgc2VydmVyIGxhdW5jaGVyIGZvciBQbGF0ZSBWaWV3ZXIgKFdpbmRvd3MpClJFTSBUaGlzIGZpbGUgaXMgYXV0by1nZW5lcmF0ZWQgYnkgcGxhdGVfdmlld2VyLnB5CgpzZXQgUE9SVD04MDAwClJFTSBHZXQgdGhlIGRpcmVjdG9yeSB3aGVyZSB0aGlzIHNjcmlwdCBpcyBsb2NhdGVkCnNldCAiU0NSSVBUX0RJUj0lfmRwMCIKc2V0ICJXRUJfRElSPSVTQ1JJUFRfRElSJXdlYiIKClJFTSBDaGFuZ2UgdG8gd2ViIGRpcmVjdG9yeQpjZCAvZCAiJVdFQl9ESVIlIiAyPm51bCB8fCAoCiAgICBlY2hvIEVycm9yOiBDb3VsZCBub3QgZmluZCB3ZWIgZGlyZWN0b3J5OiAlV0VCX0RJUiUKICAgIGVjaG8gUGxlYXNlIHJ1biBwbGF0ZV92aWV3ZXIucHkgZmlyc3QgdG8gZ2VuZXJhdGUgdGhlIHdlYiBmaWxlcy4KICAgIHBhdXNlCiAgICBleGl0IC9iIDEKKQoKUkVNIENoZWNrIGlmIHZpZXdlcl9kYXRhLmpzb24gZXhpc3RzCmlmIG5vdCBleGlzdCAidmlld2VyX2RhdGEuanNvbiIgKAogICAgZWNobyBXYXJuaW5nOiB2aWV3ZXJfZGF0YS5qc29uIG5vdCBmb3VuZCEKICAgIGVjaG8gUGxlYXNlIHJ1biBwbGF0ZV92aWV3ZXIucHkgZmlyc3QgdG8gZ2VuZXJhdGUgdGhlIGRhdGEgZmlsZXMuCiAgICBlY2hvLgopCgpzZXQgIlVSTD1odHRwOi8vbG9jYWxob3N0OiVQT1JUJS9pbmRleC5odG1sIgoKZWNobyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KZWNobyBQbGF0ZSBWaWV3ZXIgV2ViIFNlcnZlcgplY2hvID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQplY2hvIFNlcnZlciBydW5uaW5nIGF0OiAlVVJMJQplY2hvIFNlcnZpbmcgZGlyZWN0b3J5OiAlV0VCX0RJUiUKZWNoby4KZWNobyBQcmVzcyBDdHJsK0MgdG8gc3RvcCB0aGUgc2VydmVyCmVjaG8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CmVjaG8uCgpSRU0gVHJ5IFB5dGhvbiAzIGZpcnN0LCB0aGVuIFB5dGhvbiAyLCB0aGVuIFBvd2VyU2hlbGwgSFRUUCBzZXJ2ZXIKd2hlcmUgcHl0aG9uMyA+bnVsIDI+JjEKaWYgJUVSUk9STEVWRUwlID09IDAgKAogICAgUkVNIFRyeSB0byBvcGVuIGJyb3dzZXIgYXV0b21hdGljYWxseSBhZnRlciBhIHNob3J0IGRlbGF5CiAgICBzdGFydCAiIiBjbWQgL2MgInRpbWVvdXQgL3QgMiAvbm9icmVhayA+bnVsICYmIHN0YXJ0ICVVUkwlIgogICAgcHl0aG9uMyAtbSBodHRwLnNlcnZlciAlUE9SVCUKKSBlbHNlICgKICAgIHdoZXJlIHB5dGhvbiA+bnVsIDI+JjEKICAgIGlmICVFUlJPUkxFVkVMJSA9PSAwICgKICAgICAgICBSRU0gVHJ5IHRvIG9wZW4gYnJvd3NlciBhdXRvbWF0aWNhbGx5IGFmdGVyIGEgc2hvcnQgZGVsYXkKICAgICAgICBzdGFydCAiIiBjbWQgL2MgInRpbWVvdXQgL3QgMiAvbm9icmVhayA+bnVsICYmIHN0YXJ0ICVVUkwlIgogICAgICAgIHB5dGhvbiAtbSBodHRwLnNlcnZlciAlUE9SVCUKICAgICkgZWxzZSAoCiAgICAgICAgZWNobyBVc2luZyBQb3dlclNoZWxsIEhUVFAgc2VydmVyIChubyBQeXRob24gcmVxdWlyZWQpLi4uCiAgICAgICAgZWNoby4KICAgICAgICBSRU0gVXNlIFBvd2VyU2hlbGwgc2NyaXB0IHRvIHNlcnZlIGZpbGVzCiAgICAgICAgcG93ZXJzaGVsbC5leGUgLUV4ZWN1dGlvblBvbGljeSBCeXBhc3MgLUZpbGUgIiVTQ1JJUFRfRElSJXdlYl9zZXJ2ZXIucHMxIiAtUG9ydCAlUE9SVCUgLVdlYkRpciAiJVdFQl9ESVIlIgogICAgKQopCiIiIgogICAgCiAgICB3aXRoIG9wZW4od2ViX2JhdF9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZi53cml0ZSh3ZWJfYmF0X2NvbnRlbnQpCiAgICAKICAgIHJldHVybiB3ZWJfY29tbWFuZF9wYXRoLCB3ZWJfYmF0X3BhdGgKCgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBCYXNlbGluZSBJZGVudGlmaWNhdGlvbiBhbmQgTm9ybWFsaXphdGlvbiBGdW5jdGlvbnMKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgpkZWYgaWRlbnRpZnlfYmFzZWxpbmVfd2luZG93KGRmOiBwZC5EYXRhRnJhbWUsIGJhc2VsaW5lX3N0YXJ0X3RpbWU6IGZsb2F0ID0gMC4wLCBiYXNlbGluZV9lbmRfdGltZTogZmxvYXQgPSAyNC4wKSAtPiBEaWN0W3N0ciwgcGQuRGF0YUZyYW1lXToKICAgICIiIgogICAgRm9yIGVhY2ggd2VsbCBjb2x1bW4sIGRlZmluZSB0aGUgYmFzZWxpbmUgd2luZG93IGFzIGFsbCByb3dzIHdpdGggYmFzZWxpbmVfc3RhcnRfdGltZSA8PSB0aW1lX3MgPD0gYmFzZWxpbmVfZW5kX3RpbWUuCiAgICAKICAgIFBhcmFtZXRlcnM6CiAgICAtLS0tLS0tLS0tLQogICAgZGYgOiBwZC5EYXRhRnJhbWUKICAgICAgICBMb25nLWZvcm1hdCBEYXRhRnJhbWUgd2l0aCBjb2x1bW5zIFsncGxhdGVfaWQnLCAnd2VsbCcsICdjb250ZW50JywgJ3RpbWVfcycsICd2YWx1ZSddCiAgICBiYXNlbGluZV9zdGFydF90aW1lIDogZmxvYXQKICAgICAgICBNaW5pbXVtIHRpbWUgKGluIHNlY29uZHMpIGZvciBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQ6IDAuMCkKICAgIGJhc2VsaW5lX2VuZF90aW1lIDogZmxvYXQKICAgICAgICBNYXhpbXVtIHRpbWUgKGluIHNlY29uZHMpIGZvciBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQ6IDI0LjApCiAgICAKICAgIFJldHVybnM6CiAgICAtLS0tLS0tLQogICAgRGljdFtzdHIsIHBkLkRhdGFGcmFtZV0KICAgICAgICBEaWN0aW9uYXJ5IG1hcHBpbmcgd2VsbF9pZCB0byBEYXRhRnJhbWUgY29udGFpbmluZyBvbmx5IGJhc2VsaW5lIHBvaW50cyBmb3IgdGhhdCB3ZWxsCiAgICAiIiIKICAgIGJhc2VsaW5lX2RhdGEgPSB7fQogICAgCiAgICBmb3Igd2VsbF9pZCwgd2VsbF9kZiBpbiBkZi5ncm91cGJ5KCd3ZWxsJyk6CiAgICAgICAgYmFzZWxpbmVfbWFzayA9ICh3ZWxsX2RmWyd0aW1lX3MnXSA+PSBiYXNlbGluZV9zdGFydF90aW1lKSAmICh3ZWxsX2RmWyd0aW1lX3MnXSA8PSBiYXNlbGluZV9lbmRfdGltZSkKICAgICAgICBiYXNlbGluZV9kYXRhW3dlbGxfaWRdID0gd2VsbF9kZltiYXNlbGluZV9tYXNrXS5jb3B5KCkKICAgIAogICAgcmV0dXJuIGJhc2VsaW5lX2RhdGEKCgpkZWYgZml0X2Jhc2VsaW5lKAogICAgdGltZTogcGQuU2VyaWVzLAogICAgZmx1b3Jlc2NlbmNlOiBwZC5TZXJpZXMsCiAgICBtZXRob2Q6IHN0ciA9ICdsb3dlc3MnLAogICAgZnJhYzogZmxvYXQgPSAwLjUsCiAgICBwb2x5X29yZGVyOiBpbnQgPSAxLAogICAgd2VsbF9pZDogc3RyID0gTm9uZQopIC0+IHBkLlNlcmllczoKICAgICIiIgogICAgRml0IGEgc21vb3RoIGJhc2VsaW5lIGZ1bmN0aW9uIG9uIHRoZSBiYXNlbGluZSB3aW5kb3cgYW5kIGV4dHJhcG9sYXRlIHRvIGZ1bGwgdGltZWNvdXJzZS4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICB0aW1lIDogcGQuU2VyaWVzCiAgICAgICAgVGltZSB2YWx1ZXMgZm9yIGJhc2VsaW5lIHdpbmRvdwogICAgZmx1b3Jlc2NlbmNlIDogcGQuU2VyaWVzCiAgICAgICAgRmx1b3Jlc2NlbmNlIHZhbHVlcyBmb3IgYmFzZWxpbmUgd2luZG93CiAgICBtZXRob2QgOiBzdHIKICAgICAgICBCYXNlbGluZSBmaXR0aW5nIG1ldGhvZDogJ2xvd2VzcycsICdjb25zdGFudCcsIG9yICdwb2x5bm9taWFsJyAoZGVmYXVsdDogJ2NvbnN0YW50JykKICAgICAgICAtICdsb3dlc3MnOiBMb2NhbGx5IFdlaWdodGVkIFNjYXR0ZXJwbG90IFNtb290aGluZy4gVXNlIHdoZW4gYmFzZWxpbmUgaGFzIGdyYWR1YWwgZHJpZnQuCiAgICAgICAgICBCZXN0IGZvciBub24tbGluZWFyIGJhc2VsaW5lcyB3aXRoIHNtb290aCB0cmVuZHMuIEZvcm11bGE6IGcodCkgPSBMT1dFU1MoRl9iYXNlbGluZSwgdF9iYXNlbGluZSwgZnJhYykKICAgICAgICAtICdjb25zdGFudCc6IENvbnN0YW50IG1lYW4gYmFzZWxpbmUuIFVzZSB3aGVuIGJhc2VsaW5lIGlzIHN0YWJsZS9mbGF0LgogICAgICAgICAgQmVzdCBmb3Igc3RhYmxlIGJhc2VsaW5lcyB3aXRoIG1pbmltYWwgZHJpZnQuIEZvcm11bGE6IGcodCkgPSBtZWFuKEZfYmFzZWxpbmUpCiAgICAgICAgLSAncG9seW5vbWlhbCc6IFBvbHlub21pYWwgZml0LiBVc2Ugd2hlbiBiYXNlbGluZSBoYXMgbGluZWFyIG9yIHBvbHlub21pYWwgZHJpZnQuCiAgICAgICAgICBCZXN0IGZvciBiYXNlbGluZXMgd2l0aCBrbm93biBwb2x5bm9taWFsIHRyZW5kcy4gRm9ybXVsYTogZyh0KSA9IGPigoAgKyBj4oKBdCArIGPigoJ0wrIgKyAuLi4KICAgIGZyYWMgOiBmbG9hdAogICAgICAgIEZyYWN0aW9uIG9mIGRhdGEgdXNlZCBmb3IgTE9XRVNTIHNtb290aGluZyAoZGVmYXVsdDogMC41KS4gSGlnaGVyID0gc21vb3RoZXIsIGxvd2VyID0gbW9yZSBsb2NhbC4KICAgIHBvbHlfb3JkZXIgOiBpbnQKICAgICAgICBQb2x5bm9taWFsIG9yZGVyIGZvciBwb2x5bm9taWFsIGZpdCAoZGVmYXVsdDogMSkuIDEgPSBsaW5lYXIsIDIgPSBxdWFkcmF0aWMsIGV0Yy4KICAgIHdlbGxfaWQgOiBzdHIsIG9wdGlvbmFsCiAgICAgICAgV2VsbCBpZGVudGlmaWVyIGZvciBvdXRwdXQKICAgIAogICAgUmV0dXJuczoKICAgIC0tLS0tLS0tCiAgICBwZC5TZXJpZXMKICAgICAgICBGaXR0ZWQgYmFzZWxpbmUgdmFsdWVzIGZvciBhbGwgdGltZXBvaW50cyAoc2FtZSBpbmRleCBhcyBpbnB1dCB0aW1lKQogICAgIiIiCiAgICBpbXBvcnQgbnVtcHkgYXMgbnAKICAgIAogICAgIyBSZW1vdmUgTmFOIHZhbHVlcwogICAgdmFsaWRfbWFzayA9IH4ocGQuaXNuYSh0aW1lKSB8IHBkLmlzbmEoZmx1b3Jlc2NlbmNlKSkKICAgIHRpbWVfY2xlYW4gPSB0aW1lW3ZhbGlkX21hc2tdLnZhbHVlcwogICAgZmx1b19jbGVhbiA9IGZsdW9yZXNjZW5jZVt2YWxpZF9tYXNrXS52YWx1ZXMKICAgIAogICAgaWYgbGVuKHRpbWVfY2xlYW4pID09IDA6CiAgICAgICAgIyBObyB2YWxpZCBkYXRhLCByZXR1cm4gTmFOIHNlcmllcwogICAgICAgIHJldHVybiBwZC5TZXJpZXMoaW5kZXg9dGltZS5pbmRleCwgZHR5cGU9ZmxvYXQpCiAgICAKICAgIGlmIG1ldGhvZCA9PSAnY29uc3RhbnQnOgogICAgICAgICMgMHRoLW9yZGVyIChjb25zdGFudCBtZWFuIGJhc2VsaW5lKQogICAgICAgICMgRm9ybXVsYTogZyh0KSA9IG1lYW4oRl9iYXNlbGluZSkgZm9yIGFsbCB0CiAgICAgICAgYmFzZWxpbmVfdmFsdWUgPSBucC5tZWFuKGZsdW9fY2xlYW4pCiAgICAgICAgYmFzZWxpbmVfZml0ID0gcGQuU2VyaWVzKGJhc2VsaW5lX3ZhbHVlLCBpbmRleD10aW1lLmluZGV4KQogICAgCiAgICBlbGlmIG1ldGhvZCA9PSAncG9seW5vbWlhbCc6CiAgICAgICAgIyBQb2x5bm9taWFsIGZpdCB1c2luZyBucC5wb2x5Zml0CiAgICAgICAgIyBGb3JtdWxhOiBnKHQpID0gY+KCgCArIGPigoF0ICsgY+KCgnTCsiArIC4uLiAoZGVwZW5kaW5nIG9uIG9yZGVyKQogICAgICAgIGNvZWZmcyA9IG5wLnBvbHlmaXQodGltZV9jbGVhbiwgZmx1b19jbGVhbiwgcG9seV9vcmRlcikKICAgICAgICBwb2x5X2Z1bmMgPSBucC5wb2x5MWQoY29lZmZzKQogICAgICAgIGJhc2VsaW5lX2ZpdCA9IHBkLlNlcmllcyhwb2x5X2Z1bmModGltZS52YWx1ZXMpLCBpbmRleD10aW1lLmluZGV4KQogICAgCiAgICBlbGlmIG1ldGhvZCA9PSAnbG93ZXNzJzoKICAgICAgICAjIExPV0VTUyBzbW9vdGhpbmcKICAgICAgICAjIEZvcm11bGE6IGcodCkgPSBMT1dFU1MoRl9iYXNlbGluZSwgdF9iYXNlbGluZSwgZnJhYykgaW50ZXJwb2xhdGVkL2V4dHJhcG9sYXRlZAogICAgICAgIHRyeToKICAgICAgICAgICAgZnJvbSBzdGF0c21vZGVscy5ub25wYXJhbWV0cmljLnNtb290aGVyc19sb3dlc3MgaW1wb3J0IGxvd2VzcwogICAgICAgICAgICAjIExPV0VTUyByZXR1cm5zIGFycmF5IG9mIFt4LCB5XSBwYWlycwogICAgICAgICAgICBzbW9vdGhlZCA9IGxvd2VzcyhmbHVvX2NsZWFuLCB0aW1lX2NsZWFuLCBmcmFjPWZyYWMsIHJldHVybl9zb3J0ZWQ9RmFsc2UpCiAgICAgICAgICAgICMgSW50ZXJwb2xhdGUvZXh0cmFwb2xhdGUgdG8gZnVsbCB0aW1lY291cnNlCiAgICAgICAgICAgIGZyb20gc2NpcHkuaW50ZXJwb2xhdGUgaW1wb3J0IGludGVycDFkCiAgICAgICAgICAgIGludGVycF9mdW5jID0gaW50ZXJwMWQoCiAgICAgICAgICAgICAgICB0aW1lX2NsZWFuLCBzbW9vdGhlZCwgCiAgICAgICAgICAgICAgICBraW5kPSdsaW5lYXInLCAKICAgICAgICAgICAgICAgIGJvdW5kc19lcnJvcj1GYWxzZSwgCiAgICAgICAgICAgICAgICBmaWxsX3ZhbHVlPSdleHRyYXBvbGF0ZScKICAgICAgICAgICAgKQogICAgICAgICAgICBiYXNlbGluZV9maXQgPSBwZC5TZXJpZXMoaW50ZXJwX2Z1bmModGltZS52YWx1ZXMpLCBpbmRleD10aW1lLmluZGV4KQogICAgICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IoCiAgICAgICAgICAgICAgICAic3RhdHNtb2RlbHMgaXMgcmVxdWlyZWQgZm9yIExPV0VTUyBmaXR0aW5nLiAiCiAgICAgICAgICAgICAgICAiSW5zdGFsbCB3aXRoOiBwaXAgaW5zdGFsbCBzdGF0c21vZGVscyIKICAgICAgICAgICAgKQogICAgCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZiJVbmtub3duIGJhc2VsaW5lIG1ldGhvZDoge21ldGhvZH0uIENob29zZSBmcm9tICdsb3dlc3MnLCAnY29uc3RhbnQnLCBvciAncG9seW5vbWlhbCciKQogICAgCiAgICByZXR1cm4gYmFzZWxpbmVfZml0CgoKZGVmIGZpdF93ZWxsX2Jhc2VsaW5lcygKICAgIGRmOiBwZC5EYXRhRnJhbWUsCiAgICBiYXNlbGluZV9zdGFydF90aW1lOiBmbG9hdCA9IDAuMCwKICAgIGJhc2VsaW5lX2VuZF90aW1lOiBmbG9hdCA9IDI0LjAsCiAgICBtZXRob2Q6IHN0ciA9ICdsb3dlc3MnLAogICAgZnJhYzogZmxvYXQgPSAwLjUsCiAgICBwb2x5X29yZGVyOiBpbnQgPSAxLAogICAgY29uZmlnOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUKKSAtPiBEaWN0W3N0ciwgcGQuU2VyaWVzXToKICAgICIiIgogICAgRm9yIGVhY2ggd2VsbCwgZml0IGEgc21vb3RoIGJhc2VsaW5lIGZ1bmN0aW9uIG9uIHRoZSBiYXNlbGluZSB3aW5kb3cgT05MWSwKICAgIHRoZW4gZXh0cmFwb2xhdGUgb3ZlciB0aGUgZnVsbCB0aW1lY291cnNlLgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIGRmIDogcGQuRGF0YUZyYW1lCiAgICAgICAgTG9uZy1mb3JtYXQgRGF0YUZyYW1lIHdpdGggY29sdW1ucyBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgYmFzZWxpbmVfc3RhcnRfdGltZSA6IGZsb2F0CiAgICAgICAgTWluaW11bSB0aW1lIChpbiBzZWNvbmRzKSBmb3IgYmFzZWxpbmUgd2luZG93IChkZWZhdWx0OiAwLjApCiAgICBiYXNlbGluZV9lbmRfdGltZSA6IGZsb2F0CiAgICAgICAgTWF4aW11bSB0aW1lIChpbiBzZWNvbmRzKSBmb3IgYmFzZWxpbmUgd2luZG93IChkZWZhdWx0OiAyNC4wKQogICAgbWV0aG9kIDogc3RyCiAgICAgICAgQmFzZWxpbmUgZml0dGluZyBtZXRob2Q6ICdsb3dlc3MnLCAnY29uc3RhbnQnLCBvciAncG9seW5vbWlhbCcgKGRlZmF1bHQ6ICdjb25zdGFudCcpCiAgICBmcmFjIDogZmxvYXQKICAgICAgICBGcmFjdGlvbiBvZiBkYXRhIHVzZWQgZm9yIExPV0VTUyBzbW9vdGhpbmcgKGRlZmF1bHQ6IDAuNSkKICAgIHBvbHlfb3JkZXIgOiBpbnQKICAgICAgICBQb2x5bm9taWFsIG9yZGVyIGZvciBwb2x5bm9taWFsIGZpdCAoZGVmYXVsdDogMSkKICAgIAogICAgUmV0dXJuczoKICAgIC0tLS0tLS0tCiAgICBEaWN0W3N0ciwgcGQuU2VyaWVzXQogICAgICAgIERpY3Rpb25hcnkgbWFwcGluZyB3ZWxsX2lkIHRvIFNlcmllcyBvZiBmaXR0ZWQgYmFzZWxpbmUgdmFsdWVzIChpbmRleGVkIGJ5IHRpbWVfcykKICAgICIiIgogICAgYmFzZWxpbmVfZml0cyA9IHt9CiAgICAKICAgICMgRmlsdGVyIG91dCBiYWQgd2VsbHMgaWYgY29uZmlnIGlzIHByb3ZpZGVkCiAgICBpZiBjb25maWcgaXMgbm90IE5vbmU6CiAgICAgICAgYmFkX3dlbGxzX2xpc3QgPSBjb25maWcuZ2V0KCJiYWRfd2VsbHMiLCBbXSkKICAgICAgICBpZiBiYWRfd2VsbHNfbGlzdDoKICAgICAgICAgICAgZGYgPSBkZlt+ZGZbIndlbGwiXS5hcHBseShsYW1iZGEgdzogaXNfYmFkX3dlbGwodywgY29uZmlnKSldCiAgICAKICAgICMgR2V0IGJhc2VsaW5lIHdpbmRvd3MgZm9yIGVhY2ggd2VsbAogICAgYmFzZWxpbmVfd2luZG93cyA9IGlkZW50aWZ5X2Jhc2VsaW5lX3dpbmRvdyhkZiwgYmFzZWxpbmVfc3RhcnRfdGltZSwgYmFzZWxpbmVfZW5kX3RpbWUpCiAgICAKICAgICMgRml0IGJhc2VsaW5lIGZvciBlYWNoIHdlbGwKICAgIGZvciB3ZWxsX2lkLCB3ZWxsX2RmIGluIGRmLmdyb3VwYnkoJ3dlbGwnKToKICAgICAgICAjIEdldCBmdWxsIHRpbWVjb3Vyc2UgZm9yIHRoaXMgd2VsbAogICAgICAgIGZ1bGxfdGltZWNvdXJzZSA9IHdlbGxfZGYuc29ydF92YWx1ZXMoJ3RpbWVfcycpCiAgICAgICAgCiAgICAgICAgIyBHZXQgYmFzZWxpbmUgd2luZG93CiAgICAgICAgYmFzZWxpbmVfd2luZG93ID0gYmFzZWxpbmVfd2luZG93cy5nZXQod2VsbF9pZCkKICAgICAgICAKICAgICAgICBpZiBiYXNlbGluZV93aW5kb3cgaXMgTm9uZSBvciBsZW4oYmFzZWxpbmVfd2luZG93KSA9PSAwOgogICAgICAgICAgICAjIE5vIGJhc2VsaW5lIGRhdGEsIGNyZWF0ZSBOYU4gc2VyaWVzCiAgICAgICAgICAgIGJhc2VsaW5lX2ZpdHNbd2VsbF9pZF0gPSBwZC5TZXJpZXMoCiAgICAgICAgICAgICAgICBpbmRleD1mdWxsX3RpbWVjb3Vyc2VbJ3RpbWVfcyddLAogICAgICAgICAgICAgICAgZHR5cGU9ZmxvYXQKICAgICAgICAgICAgKQogICAgICAgICAgICBjb250aW51ZQogICAgICAgIAogICAgICAgICMgU29ydCBiYXNlbGluZSB3aW5kb3cgYnkgdGltZQogICAgICAgIGJhc2VsaW5lX3dpbmRvdyA9IGJhc2VsaW5lX3dpbmRvdy5zb3J0X3ZhbHVlcygndGltZV9zJykKICAgICAgICAKICAgICAgICAjIEZpdCBiYXNlbGluZSBvbiBiYXNlbGluZSB3aW5kb3cgb25seQogICAgICAgIGJhc2VsaW5lX2ZpdCA9IGZpdF9iYXNlbGluZSgKICAgICAgICAgICAgYmFzZWxpbmVfd2luZG93Wyd0aW1lX3MnXSwKICAgICAgICAgICAgYmFzZWxpbmVfd2luZG93Wyd2YWx1ZSddLAogICAgICAgICAgICBtZXRob2Q9bWV0aG9kLAogICAgICAgICAgICBmcmFjPWZyYWMsCiAgICAgICAgICAgIHBvbHlfb3JkZXI9cG9seV9vcmRlciwKICAgICAgICAgICAgd2VsbF9pZD13ZWxsX2lkCiAgICAgICAgKQogICAgICAgIAogICAgICAgICMgRXh0cmFwb2xhdGUgdG8gZnVsbCB0aW1lY291cnNlCiAgICAgICAgZnVsbF90aW1lcyA9IGZ1bGxfdGltZWNvdXJzZVsndGltZV9zJ10udmFsdWVzCiAgICAgICAgCiAgICAgICAgIyBGb3IgY29uc3RhbnQgbWV0aG9kLCB3ZSBjYW4gY3JlYXRlIHRoZSBTZXJpZXMgZGlyZWN0bHkgd2l0aG91dCBzY2lweQogICAgICAgIGlmIG1ldGhvZCA9PSAnY29uc3RhbnQnOgogICAgICAgICAgICAjIGJhc2VsaW5lX2ZpdCBhbHJlYWR5IGNvbnRhaW5zIHRoZSBjb25zdGFudCB2YWx1ZQogICAgICAgICAgICBjb25zdGFudF92YWx1ZSA9IGJhc2VsaW5lX2ZpdC5pbG9jWzBdIGlmIGxlbihiYXNlbGluZV9maXQpID4gMCBlbHNlIG5wLm5hbgogICAgICAgICAgICBleHRyYXBvbGF0ZWRfYmFzZWxpbmUgPSBwZC5TZXJpZXMoCiAgICAgICAgICAgICAgICBjb25zdGFudF92YWx1ZSwKICAgICAgICAgICAgICAgIGluZGV4PWZ1bGxfdGltZWNvdXJzZVsndGltZV9zJ10KICAgICAgICAgICAgKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgRm9yIHBvbHlub21pYWwgYW5kIGxvd2VzcyBtZXRob2RzLCBuZWVkIGludGVycG9sYXRpb24KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZnJvbSBzY2lweS5pbnRlcnBvbGF0ZSBpbXBvcnQgaW50ZXJwMWQKICAgICAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgICAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IoCiAgICAgICAgICAgICAgICAgICAgInNjaXB5IGlzIHJlcXVpcmVkIGZvciBiYXNlbGluZSBtZXRob2RzICdwb2x5bm9taWFsJyBhbmQgJ2xvd2VzcycuICIKICAgICAgICAgICAgICAgICAgICAiSW5zdGFsbCB3aXRoOiBwaXAgaW5zdGFsbCBzY2lweVxuIgogICAgICAgICAgICAgICAgICAgICJPciB1c2UgbWV0aG9kPSdjb25zdGFudCcgd2hpY2ggZG9lcyBub3QgcmVxdWlyZSBzY2lweS4iCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdldCB1bmlxdWUgdGltZXBvaW50cyBmcm9tIGJhc2VsaW5lIGZpdAogICAgICAgICAgICBiYXNlbGluZV90aW1lcyA9IGJhc2VsaW5lX2ZpdC5pbmRleC52YWx1ZXMKICAgICAgICAgICAgYmFzZWxpbmVfdmFsdWVzID0gYmFzZWxpbmVfZml0LnZhbHVlcwogICAgICAgICAgICAKICAgICAgICAgICAgIyBDcmVhdGUgaW50ZXJwb2xhdGlvbiBmdW5jdGlvbgogICAgICAgICAgICBpbnRlcnBfZnVuYyA9IGludGVycDFkKAogICAgICAgICAgICAgICAgYmFzZWxpbmVfdGltZXMsCiAgICAgICAgICAgICAgICBiYXNlbGluZV92YWx1ZXMsCiAgICAgICAgICAgICAgICBraW5kPSdsaW5lYXInLAogICAgICAgICAgICAgICAgYm91bmRzX2Vycm9yPUZhbHNlLAogICAgICAgICAgICAgICAgZmlsbF92YWx1ZT0nZXh0cmFwb2xhdGUnCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgSW50ZXJwb2xhdGUgdG8gZnVsbCB0aW1lY291cnNlIHRpbWVwb2ludHMKICAgICAgICAgICAgZXh0cmFwb2xhdGVkX2Jhc2VsaW5lID0gcGQuU2VyaWVzKAogICAgICAgICAgICAgICAgaW50ZXJwX2Z1bmMoZnVsbF90aW1lcyksCiAgICAgICAgICAgICAgICBpbmRleD1mdWxsX3RpbWVjb3Vyc2VbJ3RpbWVfcyddCiAgICAgICAgICAgICkKICAgICAgICAKICAgICAgICBiYXNlbGluZV9maXRzW3dlbGxfaWRdID0gZXh0cmFwb2xhdGVkX2Jhc2VsaW5lCiAgICAKICAgIHJldHVybiBiYXNlbGluZV9maXRzCgoKZGVmIG5vcm1hbGl6ZV93ZWxscygKICAgIGRmOiBwZC5EYXRhRnJhbWUsCiAgICBiYXNlbGluZV9maXRzOiBEaWN0W3N0ciwgcGQuU2VyaWVzXSwKICAgIG5vcm1hbGl6YXRpb25fbW9kZTogc3RyID0gJ211bHRpcGxpY2F0aXZlJywKICAgIGJhc2VsaW5lX3dpbmRvd3M6IERpY3Rbc3RyLCBwZC5EYXRhRnJhbWVdID0gTm9uZSwKICAgIGJhc2VsaW5lX3N0YXJ0X3RpbWU6IGZsb2F0ID0gMC4wLAogICAgYmFzZWxpbmVfZW5kX3RpbWU6IGZsb2F0ID0gMjQuMAopIC0+IHBkLkRhdGFGcmFtZToKICAgICIiIgogICAgRm9yIGVhY2ggd2VsbCBhbmQgZWFjaCB0aW1lcG9pbnQsIGNvbXB1dGUgbm9ybWFsaXplZCBmbHVvcmVzY2VuY2UgdXNpbmcgdGhlIGZpdHRlZCBiYXNlbGluZS4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBkZiA6IHBkLkRhdGFGcmFtZQogICAgICAgIExvbmctZm9ybWF0IERhdGFGcmFtZSB3aXRoIGNvbHVtbnMgWydwbGF0ZV9pZCcsICd3ZWxsJywgJ2NvbnRlbnQnLCAndGltZV9zJywgJ3ZhbHVlJ10KICAgIGJhc2VsaW5lX2ZpdHMgOiBEaWN0W3N0ciwgcGQuU2VyaWVzXQogICAgICAgIERpY3Rpb25hcnkgbWFwcGluZyB3ZWxsX2lkIHRvIFNlcmllcyBvZiBmaXR0ZWQgYmFzZWxpbmUgdmFsdWVzCiAgICBub3JtYWxpemF0aW9uX21vZGUgOiBzdHIKICAgICAgICBOb3JtYWxpemF0aW9uIG1vZGUgKGRlZmF1bHQ6ICdtdWx0aXBsaWNhdGl2ZScpCiAgICAgICAgLSAnZGVsdGFfZl9vdmVyX2YnOiDOlEYvRiBub3JtYWxpemF0aW9uLiBGb3JtdWxhOiBGJyh0KSA9IChGKHQpIC0gZyh0KSkgLyBnKHQpCiAgICAgICAgICBVc2Ugd2hlbiB5b3Ugd2FudCB0byBtZWFzdXJlIHJlbGF0aXZlIGNoYW5nZSBmcm9tIGJhc2VsaW5lLiBCZXN0IGZvciBkZXRlY3RpbmcKICAgICAgICAgIGluY3JlYXNlcy9kZWNyZWFzZXMgcmVsYXRpdmUgdG8gYmFzZWxpbmUuIFZhbHVlcyBjYW4gYmUgbmVnYXRpdmUgKGJlbG93IGJhc2VsaW5lKQogICAgICAgICAgb3IgcG9zaXRpdmUgKGFib3ZlIGJhc2VsaW5lKS4KICAgICAgICAtICdtdWx0aXBsaWNhdGl2ZSc6IE11bHRpcGxpY2F0aXZlIG5vcm1hbGl6YXRpb24uIEZvcm11bGE6IEZfbm9ybSh0KSA9IEYodCkgLyBnKHQpCiAgICAgICAgICBVc2Ugd2hlbiB5b3Ugd2FudCB0byBub3JtYWxpemUgYnkgYmFzZWxpbmUgd2l0aG91dCBzdWJ0cmFjdGluZy4gQmVzdCBmb3IgZm9sZC1jaGFuZ2UKICAgICAgICAgIGFuYWx5c2lzLiBWYWx1ZXMgYXJlIGFsd2F5cyBwb3NpdGl2ZSAocmF0aW8gdG8gYmFzZWxpbmUpLgogICAgICAgIC0gJ2xvd2VzdF9wb2ludCc6IFVzZSB0aGUgbG93ZXN0IHZhbHVlIGluIHRoZSBiYXNlbGluZSByYW5nZS4gRm9ybXVsYTogRl9ub3JtKHQpID0gRih0KSAvIG1pbihGX2Jhc2VsaW5lKQogICAgICAgIC0gJ2ZpcnN0X3BvaW50JzogVXNlIHRoZSBmaXJzdCB2YWx1ZSBhZnRlciB0aGUgYmFzZWxpbmUgcmFuZ2UgZW5kcy4gRm9ybXVsYTogRl9ub3JtKHQpID0gRih0KSAvIEZfZmlyc3RfYWZ0ZXJfYmFzZWxpbmUKICAgIGJhc2VsaW5lX3dpbmRvd3MgOiBEaWN0W3N0ciwgcGQuRGF0YUZyYW1lXSwgb3B0aW9uYWwKICAgICAgICBEaWN0aW9uYXJ5IG1hcHBpbmcgd2VsbF9pZCB0byBEYXRhRnJhbWUgY29udGFpbmluZyBiYXNlbGluZSB3aW5kb3cgZGF0YS4KICAgICAgICBSZXF1aXJlZCBmb3IgJ2xvd2VzdF9wb2ludCcgYW5kICdmaXJzdF9wb2ludCcgbW9kZXMuCiAgICBiYXNlbGluZV9zdGFydF90aW1lIDogZmxvYXQKICAgICAgICBNaW5pbXVtIHRpbWUgKGluIHNlY29uZHMpIGZvciBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQ6IDAuMCkKICAgIGJhc2VsaW5lX2VuZF90aW1lIDogZmxvYXQKICAgICAgICBNYXhpbXVtIHRpbWUgKGluIHNlY29uZHMpIGZvciBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQ6IDI0LjApCiAgICAKICAgIFJldHVybnM6CiAgICAtLS0tLS0tLQogICAgcGQuRGF0YUZyYW1lCiAgICAgICAgRGF0YUZyYW1lIHdpdGggc2FtZSBzaGFwZSBhcyBpbnB1dCBidXQgd2l0aCBub3JtYWxpemVkICd2YWx1ZScgY29sdW1uCiAgICAiIiIKICAgIGlmIG5vcm1hbGl6YXRpb25fbW9kZSA9PSAnbm9uZSc6CiAgICAgICAgcmV0dXJuIGRmLmNvcHkoKQogICAgCiAgICBub3JtX2RmID0gZGYuY29weSgpCiAgICBub3JtX3ZhbHVlcyA9IFtdCiAgICAKICAgICMgUHJlLWNvbXB1dGUgYmFzZWxpbmUgdmFsdWVzIGZvciBsb3dlc3RfcG9pbnQgYW5kIGZpcnN0X3BvaW50IG1vZGVzCiAgICBiYXNlbGluZV9jb25zdGFudHMgPSB7fQogICAgaWYgbm9ybWFsaXphdGlvbl9tb2RlIGluIFsnbG93ZXN0X3BvaW50JywgJ2ZpcnN0X3BvaW50J106CiAgICAgICAgaWYgbm9ybWFsaXphdGlvbl9tb2RlID09ICdsb3dlc3RfcG9pbnQnOgogICAgICAgICAgICBpZiBiYXNlbGluZV93aW5kb3dzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAgICAgICAgIGYiYmFzZWxpbmVfd2luZG93cyBpcyByZXF1aXJlZCBmb3Igbm9ybWFsaXphdGlvbl9tb2RlICd7bm9ybWFsaXphdGlvbl9tb2RlfSciCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGZvciB3ZWxsX2lkLCBiYXNlbGluZV93aW5kb3cgaW4gYmFzZWxpbmVfd2luZG93cy5pdGVtcygpOgogICAgICAgICAgICAgICAgaWYgYmFzZWxpbmVfd2luZG93IGlzIE5vbmUgb3IgbGVuKGJhc2VsaW5lX3dpbmRvdykgPT0gMDoKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9jb25zdGFudHNbd2VsbF9pZF0gPSBucC5uYW4KICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFNvcnQgYnkgdGltZSB0byBlbnN1cmUgY29ycmVjdCBvcmRlcmluZwogICAgICAgICAgICAgICAgYmFzZWxpbmVfd2luZG93X3NvcnRlZCA9IGJhc2VsaW5lX3dpbmRvdy5zb3J0X3ZhbHVlcygndGltZV9zJykKICAgICAgICAgICAgICAgIHZhbGlkX3ZhbHVlcyA9IGJhc2VsaW5lX3dpbmRvd19zb3J0ZWRbJ3ZhbHVlJ10uZHJvcG5hKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgbGVuKHZhbGlkX3ZhbHVlcykgPT0gMDoKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9jb25zdGFudHNbd2VsbF9pZF0gPSBucC5uYW4KICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBiYXNlbGluZV9jb25zdGFudHNbd2VsbF9pZF0gPSB2YWxpZF92YWx1ZXMubWluKCkKICAgICAgICAKICAgICAgICBlbGlmIG5vcm1hbGl6YXRpb25fbW9kZSA9PSAnZmlyc3RfcG9pbnQnOgogICAgICAgICAgICAjIEZvciBmaXJzdF9wb2ludCwgZmluZCB0aGUgZmlyc3QgcG9pbnQgYWZ0ZXIgYmFzZWxpbmVfZW5kX3RpbWUgZm9yIGVhY2ggd2VsbAogICAgICAgICAgICBmb3Igd2VsbF9pZCwgd2VsbF9kZiBpbiBkZi5ncm91cGJ5KCd3ZWxsJyk6CiAgICAgICAgICAgICAgICAjIEdldCBhbGwgcG9pbnRzIGZvciB0aGlzIHdlbGwsIHNvcnRlZCBieSB0aW1lCiAgICAgICAgICAgICAgICB3ZWxsX2RmX3NvcnRlZCA9IHdlbGxfZGYuc29ydF92YWx1ZXMoJ3RpbWVfcycpCiAgICAgICAgICAgICAgICAjIEZpbmQgZmlyc3QgcG9pbnQgYWZ0ZXIgYmFzZWxpbmVfZW5kX3RpbWUKICAgICAgICAgICAgICAgIGFmdGVyX2Jhc2VsaW5lID0gd2VsbF9kZl9zb3J0ZWRbd2VsbF9kZl9zb3J0ZWRbJ3RpbWVfcyddID4gYmFzZWxpbmVfZW5kX3RpbWVdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIGxlbihhZnRlcl9iYXNlbGluZSkgPT0gMDoKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9jb25zdGFudHNbd2VsbF9pZF0gPSBucC5uYW4KICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEdldCB0aGUgZmlyc3QgcG9pbnQgYWZ0ZXIgYmFzZWxpbmUgKHNvcnRlZCBieSB0aW1lLCBzbyBmaXJzdCByb3cpCiAgICAgICAgICAgICAgICBmaXJzdF9hZnRlciA9IGFmdGVyX2Jhc2VsaW5lLmlsb2NbMF0KICAgICAgICAgICAgICAgIGlmIHBkLmlzbmEoZmlyc3RfYWZ0ZXJbJ3ZhbHVlJ10pIG9yIGZpcnN0X2FmdGVyWyd2YWx1ZSddID09IDA6CiAgICAgICAgICAgICAgICAgICAgYmFzZWxpbmVfY29uc3RhbnRzW3dlbGxfaWRdID0gbnAubmFuCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGJhc2VsaW5lX2NvbnN0YW50c1t3ZWxsX2lkXSA9IGZpcnN0X2FmdGVyWyd2YWx1ZSddCiAgICAKICAgIGZvciBpZHgsIHJvdyBpbiBkZi5pdGVycm93cygpOgogICAgICAgIHdlbGxfaWQgPSByb3dbJ3dlbGwnXQogICAgICAgIHRpbWVfcyA9IHJvd1sndGltZV9zJ10KICAgICAgICB2YWx1ZSA9IHJvd1sndmFsdWUnXQogICAgICAgIAogICAgICAgICMgSGFuZGxlIGxvd2VzdF9wb2ludCBhbmQgZmlyc3RfcG9pbnQgbW9kZXMKICAgICAgICBpZiBub3JtYWxpemF0aW9uX21vZGUgaW4gWydsb3dlc3RfcG9pbnQnLCAnZmlyc3RfcG9pbnQnXToKICAgICAgICAgICAgYmFzZWxpbmVfdmFsdWUgPSBiYXNlbGluZV9jb25zdGFudHMuZ2V0KHdlbGxfaWQpCiAgICAgICAgICAgIGlmIHBkLmlzbmEoYmFzZWxpbmVfdmFsdWUpIG9yIGJhc2VsaW5lX3ZhbHVlID09IDA6CiAgICAgICAgICAgICAgICBub3JtX3ZhbHVlcy5hcHBlbmQobnAubmFuKQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgRm9yIHRoZXNlIG1vZGVzLCBhbHdheXMgdXNlIG11bHRpcGxpY2F0aXZlIG5vcm1hbGl6YXRpb24KICAgICAgICAgICAgbm9ybV92YWx1ZSA9IHZhbHVlIC8gYmFzZWxpbmVfdmFsdWUKICAgICAgICAgICAgbm9ybV92YWx1ZXMuYXBwZW5kKG5vcm1fdmFsdWUpCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgCiAgICAgICAgIyBGb3Igb3RoZXIgbW9kZXMsIHVzZSBmaXR0ZWQgYmFzZWxpbmUKICAgICAgICBiYXNlbGluZV9zZXJpZXMgPSBiYXNlbGluZV9maXRzLmdldCh3ZWxsX2lkKQogICAgICAgIAogICAgICAgIGlmIGJhc2VsaW5lX3NlcmllcyBpcyBOb25lIG9yIGxlbihiYXNlbGluZV9zZXJpZXMpID09IDA6CiAgICAgICAgICAgIG5vcm1fdmFsdWVzLmFwcGVuZChucC5uYW4pCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgCiAgICAgICAgIyBGaW5kIGNsb3Nlc3QgdGltZXBvaW50IGluIGJhc2VsaW5lIHNlcmllcwogICAgICAgIGJhc2VsaW5lX3RpbWVzID0gYmFzZWxpbmVfc2VyaWVzLmluZGV4LnZhbHVlcwogICAgICAgIGNsb3Nlc3RfaWR4ID0gbnAuYXJnbWluKG5wLmFicyhiYXNlbGluZV90aW1lcyAtIHRpbWVfcykpCiAgICAgICAgYmFzZWxpbmVfdmFsdWUgPSBiYXNlbGluZV9zZXJpZXMuaWxvY1tjbG9zZXN0X2lkeF0KICAgICAgICAKICAgICAgICBpZiBwZC5pc25hKGJhc2VsaW5lX3ZhbHVlKSBvciBiYXNlbGluZV92YWx1ZSA9PSAwOgogICAgICAgICAgICBub3JtX3ZhbHVlcy5hcHBlbmQobnAubmFuKQogICAgICAgICAgICBjb250aW51ZQogICAgICAgIAogICAgICAgICMgQXBwbHkgbm9ybWFsaXphdGlvbgogICAgICAgIGlmIG5vcm1hbGl6YXRpb25fbW9kZSA9PSAnZGVsdGFfZl9vdmVyX2YnOgogICAgICAgICAgICAjIM6URi9GID0gKEYodCkgLSBnKHQpKSAvIGcodCkKICAgICAgICAgICAgbm9ybV92YWx1ZSA9ICh2YWx1ZSAtIGJhc2VsaW5lX3ZhbHVlKSAvIGJhc2VsaW5lX3ZhbHVlCiAgICAgICAgZWxpZiBub3JtYWxpemF0aW9uX21vZGUgPT0gJ211bHRpcGxpY2F0aXZlJzoKICAgICAgICAgICAgIyBGX25vcm0odCkgPSBGKHQpIC8gZyh0KQogICAgICAgICAgICBub3JtX3ZhbHVlID0gdmFsdWUgLyBiYXNlbGluZV92YWx1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgICAgICBmIlVua25vd24gbm9ybWFsaXphdGlvbl9tb2RlOiB7bm9ybWFsaXphdGlvbl9tb2RlfS4gIgogICAgICAgICAgICAgICAgIkNob29zZSBmcm9tICdkZWx0YV9mX292ZXJfZicsICdtdWx0aXBsaWNhdGl2ZScsICdsb3dlc3RfcG9pbnQnLCBvciAnZmlyc3RfcG9pbnQnIgogICAgICAgICAgICApCiAgICAgICAgCiAgICAgICAgbm9ybV92YWx1ZXMuYXBwZW5kKG5vcm1fdmFsdWUpCiAgICAKICAgIG5vcm1fZGZbJ3ZhbHVlJ10gPSBub3JtX3ZhbHVlcwogICAgcmV0dXJuIG5vcm1fZGYKCgpkZWYgZ2V0X3RyaXBsaWNhdGVfZ3JvdXBfY29sb3IoCiAgICBncm91cF9uYW1lOiBzdHIsCiAgICBjb25maWc6IERpY3Rbc3RyLCBBbnldID0gTm9uZQopIC0+IHN0cjoKICAgICIiIgogICAgR2V0IHRoZSBjb2xvciBmb3IgYSBncm91cCBuYW1lLgogICAgTWF0Y2hlcyB0aGUgY29sb3IgYXNzaWdubWVudCBmcm9tIHRoZSB3ZWIgaW50ZXJmYWNlLgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIGdyb3VwX25hbWUgOiBzdHIKICAgICAgICBOYW1lIG9mIHRoZSBncm91cAogICAgY29uZmlnIDogRGljdFtzdHIsIEFueV0sIG9wdGlvbmFsCiAgICAgICAgQ29uZmlndXJhdGlvbiBkaWN0aW9uYXJ5IHdpdGggJ2dyb3Vwcycga2V5IChhdXRvLWdlbmVyYXRlZCBmcm9tIHdlbGxfbGFiZWxzKQogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIHN0cgogICAgICAgIEhleCBjb2xvciBjb2RlIGZvciB0aGUgZ3JvdXAKICAgICIiIgogICAgaWYgY29uZmlnIGlzIE5vbmU6CiAgICAgICAgc2NyaXB0X2RpciA9IG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmFic3BhdGgoX19maWxlX18pKQogICAgICAgIGNvbmZpZ19wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJwbGF0ZV9jb25maWcuanNvbiIpCiAgICAgICAgY29uZmlnID0gbG9hZF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAKICAgICMgVXNlIGF1dG8tZ2VuZXJhdGVkIGdyb3VwcyBmcm9tIGNvbmZpZyAoZ2VuZXJhdGVkIGZyb20gd2VsbF9sYWJlbHMpCiAgICBncm91cHMgPSBjb25maWcuZ2V0KCJncm91cHMiLCBbXSkKICAgIAogICAgIyBCdWlsZCBjb2xvciBtYXA6IGdyb3VwIG5hbWUgLT4gY29sb3IgaW5kZXgKICAgIGNvbG9yX21hcCA9IHt9CiAgICBmb3IgaWR4LCBncm91cCBpbiBlbnVtZXJhdGUoZ3JvdXBzKToKICAgICAgICBuYW1lID0gZ3JvdXAuZ2V0KCJuYW1lIiwgIiIpLnN0cmlwKCkKICAgICAgICBpZiBuYW1lIGFuZCBuYW1lIG5vdCBpbiBjb2xvcl9tYXA6CiAgICAgICAgICAgIGNvbG9yX21hcFtuYW1lXSA9IGlkeAogICAgCiAgICAjIEdldCBjb2xvciBpbmRleCBmb3IgdGhpcyBncm91cAogICAgbm9ybWFsaXplZF9uYW1lID0gZ3JvdXBfbmFtZS5zdHJpcCgpIGlmIGdyb3VwX25hbWUgZWxzZSAiIgogICAgY29sb3JfaWR4ID0gY29sb3JfbWFwLmdldChub3JtYWxpemVkX25hbWUsIDApCiAgICAKICAgICMgUmV0dXJuIGNvbG9yIGZyb20gcGFsZXR0ZSAoY3ljbGUgaWYgbmVlZGVkKQogICAgcmV0dXJuIFRSSVBMSUNBVEVfQ09MT1JTW2NvbG9yX2lkeCAlIGxlbihUUklQTElDQVRFX0NPTE9SUyldCgoKZGVmIGJ1aWxkX2NvbmRpdGlvbl9tYXAoCiAgICBkZjogcGQuRGF0YUZyYW1lLAogICAgY29uZmlnOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUKKSAtPiBEaWN0W3N0ciwgc3RyXToKICAgICIiIgogICAgQnVpbGQgYSBtYXBwaW5nIGZyb20gd2VsbF9pZCB0byBjb25kaXRpb24gbmFtZS4KICAgIAogICAgVXNlcyBncm91cCBuYW1lcyBmcm9tIGNvbmZpZyB0byBhc3NpZ24gY29uZGl0aW9ucy4KICAgIFdlbGxzIGluIHRoZSBzYW1lIGdyb3VwIChzYW1lIHJvdyBwYXR0ZXJuKSBnZXQgdGhlIHNhbWUgY29uZGl0aW9uLgogICAgR3JvdXBzIGFyZSBhdXRvLWdlbmVyYXRlZCBmcm9tIHdlbGxfbGFiZWxzLgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIGRmIDogcGQuRGF0YUZyYW1lCiAgICAgICAgTG9uZy1mb3JtYXQgRGF0YUZyYW1lIHdpdGggY29sdW1ucyBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgY29uZmlnIDogRGljdFtzdHIsIEFueV0KICAgICAgICBDb25maWd1cmF0aW9uIGRpY3Rpb25hcnkgd2l0aCAnZ3JvdXBzJyBrZXkgKGF1dG8tZ2VuZXJhdGVkIGZyb20gd2VsbF9sYWJlbHMpCiAgICAKICAgIFJldHVybnM6CiAgICAtLS0tLS0tLQogICAgRGljdFtzdHIsIHN0cl0KICAgICAgICBEaWN0aW9uYXJ5IG1hcHBpbmcgd2VsbF9pZCB0byBjb25kaXRpb24gbmFtZQogICAgIiIiCiAgICBpZiBjb25maWcgaXMgTm9uZToKICAgICAgICBzY3JpcHRfZGlyID0gb3MucGF0aC5kaXJuYW1lKG9zLnBhdGguYWJzcGF0aChfX2ZpbGVfXykpCiAgICAgICAgY29uZmlnX3BhdGggPSBvcy5wYXRoLmpvaW4oc2NyaXB0X2RpciwgInBsYXRlX2NvbmZpZy5qc29uIikKICAgICAgICBjb25maWcgPSBsb2FkX2NvbmZpZyhjb25maWdfcGF0aCkKICAgIAogICAgY29uZGl0aW9uX21hcCA9IHt9CiAgICAjIFVzZSBhdXRvLWdlbmVyYXRlZCBncm91cHMgZnJvbSBjb25maWcgKGdlbmVyYXRlZCBmcm9tIHdlbGxfbGFiZWxzKQogICAgZ3JvdXBzID0gY29uZmlnLmdldCgiZ3JvdXBzIiwgW10pCiAgICAKICAgICMgQnVpbGQgbWFwcGluZzogcm93X2xldHRlciAtPiBjb25kaXRpb24gbmFtZQogICAgcm93X3RvX2NvbmRpdGlvbiA9IHt9CiAgICBmb3IgZ3JvdXAgaW4gZ3JvdXBzOgogICAgICAgIGdyb3VwX25hbWUgPSBncm91cC5nZXQoIm5hbWUiLCAiIikKICAgICAgICBncm91cF93ZWxscyA9IGdyb3VwLmdldCgid2VsbHMiLCBbXSkKICAgICAgICBmb3Igd2VsbF9wYXR0ZXJuIGluIGdyb3VwX3dlbGxzOgogICAgICAgICAgICAjIEV4dHJhY3Qgcm93IGxldHRlciBmcm9tIHdlbGwgcGF0dGVybiAoZS5nLiwgIkIiIGZyb20gIkIiIG9yICJCMTMiKQogICAgICAgICAgICByb3dfbGV0dGVyID0gd2VsbF9wYXR0ZXJuWzBdIGlmIHdlbGxfcGF0dGVybiBhbmQgd2VsbF9wYXR0ZXJuWzBdLmlzYWxwaGEoKSBlbHNlICIiCiAgICAgICAgICAgIGlmIHJvd19sZXR0ZXI6CiAgICAgICAgICAgICAgICByb3dfdG9fY29uZGl0aW9uW3Jvd19sZXR0ZXJdID0gZ3JvdXBfbmFtZQogICAgCiAgICAjIE1hcCBlYWNoIHdlbGwgdG8gaXRzIGNvbmRpdGlvbiBiYXNlZCBvbiByb3cgbGV0dGVyCiAgICBmb3Igd2VsbF9pZCBpbiBkZlsnd2VsbCddLnVuaXF1ZSgpOgogICAgICAgIGlmIHdlbGxfaWQgYW5kIGxlbih3ZWxsX2lkKSA+IDA6CiAgICAgICAgICAgIHJvd19sZXR0ZXIgPSB3ZWxsX2lkWzBdIGlmIHdlbGxfaWRbMF0uaXNhbHBoYSgpIGVsc2UgIiIKICAgICAgICAgICAgY29uZGl0aW9uID0gcm93X3RvX2NvbmRpdGlvbi5nZXQocm93X2xldHRlciwgd2VsbF9pZCkgICMgRGVmYXVsdCB0byB3ZWxsX2lkIGlmIG5vdCBmb3VuZAogICAgICAgICAgICBjb25kaXRpb25fbWFwW3dlbGxfaWRdID0gY29uZGl0aW9uCiAgICAKICAgIHJldHVybiBjb25kaXRpb25fbWFwCgoKZGVmIGNvbXB1dGVfY29uZGl0aW9uX3N0YXRpc3RpY3MoCiAgICBub3JtX2RmOiBwZC5EYXRhRnJhbWUsCiAgICBjb25kaXRpb25fbWFwOiBEaWN0W3N0ciwgc3RyXQopIC0+IHBkLkRhdGFGcmFtZToKICAgICIiIgogICAgR3JvdXAgd2VsbHMgYnkgY29uZGl0aW9uIGFuZCBjb21wdXRlIG1lYW4gwrEgU0VNIGZvciBlYWNoIGNvbmRpdGlvbiBhbmQgdGltZXBvaW50LgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIG5vcm1fZGYgOiBwZC5EYXRhRnJhbWUKICAgICAgICBOb3JtYWxpemVkIERhdGFGcmFtZSB3aXRoIGNvbHVtbnMgWydwbGF0ZV9pZCcsICd3ZWxsJywgJ2NvbnRlbnQnLCAndGltZV9zJywgJ3ZhbHVlJ10KICAgIGNvbmRpdGlvbl9tYXAgOiBEaWN0W3N0ciwgc3RyXQogICAgICAgIERpY3Rpb25hcnkgbWFwcGluZyB3ZWxsX2lkIHRvIGNvbmRpdGlvbiBuYW1lCiAgICAKICAgIFJldHVybnM6CiAgICAtLS0tLS0tLQogICAgcGQuRGF0YUZyYW1lCiAgICAgICAgVGlkeSBEYXRhRnJhbWUgd2l0aCBjb2x1bW5zOiBbJ1RpbWVfcycsICdjb25kaXRpb24nLCAnbWVhbicsICdzZCcsICdzZW0nLCAnbiddCiAgICAiIiIKICAgIGltcG9ydCBudW1weSBhcyBucAogICAgCiAgICAjIEFkZCBjb25kaXRpb24gY29sdW1uCiAgICBub3JtX2RmID0gbm9ybV9kZi5jb3B5KCkKICAgIG5vcm1fZGZbJ2NvbmRpdGlvbiddID0gbm9ybV9kZlsnd2VsbCddLm1hcChjb25kaXRpb25fbWFwKQogICAgCiAgICAjIEdyb3VwIGJ5IGNvbmRpdGlvbiBhbmQgdGltZQogICAgcmVzdWx0cyA9IFtdCiAgICAKICAgIGZvciAoY29uZGl0aW9uLCB0aW1lX3MpLCBncm91cCBpbiBub3JtX2RmLmdyb3VwYnkoWydjb25kaXRpb24nLCAndGltZV9zJ10pOgogICAgICAgIHZhbHVlcyA9IGdyb3VwWyd2YWx1ZSddLmRyb3BuYSgpLnZhbHVlcwogICAgICAgIAogICAgICAgIGlmIGxlbih2YWx1ZXMpID09IDA6CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgCiAgICAgICAgbiA9IGxlbih2YWx1ZXMpCiAgICAgICAgbWVhbiA9IG5wLm1lYW4odmFsdWVzKQogICAgICAgIHNkID0gbnAuc3RkKHZhbHVlcywgZGRvZj0xKSAgIyBTYW1wbGUgc3RhbmRhcmQgZGV2aWF0aW9uCiAgICAgICAgc2VtID0gc2QgLyBucC5zcXJ0KG4pIGlmIG4gPiAwIGVsc2UgbnAubmFuCiAgICAgICAgCiAgICAgICAgcmVzdWx0cy5hcHBlbmQoewogICAgICAgICAgICAnVGltZV9zJzogdGltZV9zLAogICAgICAgICAgICAnY29uZGl0aW9uJzogY29uZGl0aW9uLAogICAgICAgICAgICAnbWVhbic6IG1lYW4sCiAgICAgICAgICAgICdzZCc6IHNkLAogICAgICAgICAgICAnc2VtJzogc2VtLAogICAgICAgICAgICAnbic6IG4KICAgICAgICB9KQogICAgCiAgICBzdGF0c19kZiA9IHBkLkRhdGFGcmFtZShyZXN1bHRzKQogICAgcmV0dXJuIHN0YXRzX2RmLnNvcnRfdmFsdWVzKFsnY29uZGl0aW9uJywgJ1RpbWVfcyddKS5yZXNldF9pbmRleChkcm9wPVRydWUpCgoKZGVmIHBsb3RfdGltZWNvdXJzZSgKICAgIHN0YXRzX2RmOiBwZC5EYXRhRnJhbWUsCiAgICBjb25kaXRpb25zOiBMaXN0W3N0cl0gPSBOb25lLAogICAgZmlnc2l6ZTogdHVwbGUgPSAoMTAsIDYpLAogICAgc2F2ZV9wYXRoOiBzdHIgPSBOb25lLAogICAgY29uZmlnOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUKKToKICAgICIiIgogICAgR2VuZXJhdGUgdGltZS1jb3Vyc2UgcGxvdHMgd2l0aCBtZWFuIMKxIFNFTSBmb3IgZWFjaCBjb25kaXRpb24uCiAgICBVc2VzIHRyaXBsaWNhdGUgZ3JvdXAgY29sb3JzIHRvIG1hdGNoIHRoZSB3ZWIgaW50ZXJmYWNlLgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIHN0YXRzX2RmIDogcGQuRGF0YUZyYW1lCiAgICAgICAgU3RhdGlzdGljcyBEYXRhRnJhbWUgd2l0aCBjb2x1bW5zIFsnVGltZV9zJywgJ2NvbmRpdGlvbicsICdtZWFuJywgJ3NlbSddCiAgICBjb25kaXRpb25zIDogTGlzdFtzdHJdLCBvcHRpb25hbAogICAgICAgIFN1YnNldCBvZiBjb25kaXRpb25zIHRvIHBsb3QuIElmIE5vbmUsIHBsb3RzIGFsbCBjb25kaXRpb25zLgogICAgZmlnc2l6ZSA6IHR1cGxlCiAgICAgICAgRmlndXJlIHNpemUgKHdpZHRoLCBoZWlnaHQpIGluIGluY2hlcyAoZGVmYXVsdDogKDEwLCA2KSkKICAgIHNhdmVfcGF0aCA6IHN0ciwgb3B0aW9uYWwKICAgICAgICBQYXRoIHRvIHNhdmUgdGhlIGZpZ3VyZS4gSWYgTm9uZSwgZGlzcGxheXMgdGhlIHBsb3QuCiAgICBjb25maWcgOiBEaWN0W3N0ciwgQW55XSwgb3B0aW9uYWwKICAgICAgICBDb25maWd1cmF0aW9uIGRpY3Rpb25hcnkgd2l0aCAnZ3JvdXBzJyBrZXkgKGF1dG8tZ2VuZXJhdGVkIGZyb20gd2VsbF9sYWJlbHMpCiAgICAiIiIKICAgIGltcG9ydCBtYXRwbG90bGliLnB5cGxvdCBhcyBwbHQKICAgIAogICAgaWYgY29uZmlnIGlzIE5vbmU6CiAgICAgICAgc2NyaXB0X2RpciA9IG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmFic3BhdGgoX19maWxlX18pKQogICAgICAgIGNvbmZpZ19wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJwbGF0ZV9jb25maWcuanNvbiIpCiAgICAgICAgY29uZmlnID0gbG9hZF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAKICAgIGlmIGNvbmRpdGlvbnMgaXMgTm9uZToKICAgICAgICBjb25kaXRpb25zID0gc3RhdHNfZGZbJ2NvbmRpdGlvbiddLnVuaXF1ZSgpCiAgICAKICAgIGZpZywgYXggPSBwbHQuc3VicGxvdHMoZmlnc2l6ZT1maWdzaXplKQogICAgCiAgICBmb3IgaWR4LCBjb25kaXRpb24gaW4gZW51bWVyYXRlKGNvbmRpdGlvbnMpOgogICAgICAgIGNvbmRfZGF0YSA9IHN0YXRzX2RmW3N0YXRzX2RmWydjb25kaXRpb24nXSA9PSBjb25kaXRpb25dLnNvcnRfdmFsdWVzKCdUaW1lX3MnKQogICAgICAgIAogICAgICAgIGlmIGxlbihjb25kX2RhdGEpID09IDA6CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgCiAgICAgICAgdGltZXMgPSBjb25kX2RhdGFbJ1RpbWVfcyddLnZhbHVlcwogICAgICAgIG1lYW5zID0gY29uZF9kYXRhWydtZWFuJ10udmFsdWVzCiAgICAgICAgc2VtcyA9IGNvbmRfZGF0YVsnc2VtJ10udmFsdWVzCiAgICAgICAgCiAgICAgICAgIyBHZXQgY29sb3IgZm9yIHRoaXMgY29uZGl0aW9uICh0cmlwbGljYXRlIGdyb3VwIG5hbWUpCiAgICAgICAgIyBVc2UgdHJpcGxpY2F0ZSBncm91cCBjb2xvciBpZiBjb25kaXRpb24gbWF0Y2hlcyBhIGdyb3VwIG5hbWUsIG90aGVyd2lzZSB1c2UgZGVmYXVsdCBwYWxldHRlCiAgICAgICAgY29sb3IgPSBnZXRfdHJpcGxpY2F0ZV9ncm91cF9jb2xvcihjb25kaXRpb24sIGNvbmZpZykKICAgICAgICAKICAgICAgICAjIFBsb3QgbGluZQogICAgICAgIGF4LnBsb3QodGltZXMsIG1lYW5zLCBsYWJlbD1jb25kaXRpb24sIGNvbG9yPWNvbG9yLCBsaW5ld2lkdGg9MikKICAgICAgICAKICAgICAgICAjIFBsb3QgZXJyb3IgYmFycwogICAgICAgIGF4LmVycm9yYmFyKAogICAgICAgICAgICB0aW1lcywgbWVhbnMsIHllcnI9c2VtcywKICAgICAgICAgICAgY29sb3I9Y29sb3IsCiAgICAgICAgICAgIGFscGhhPTAuNSwKICAgICAgICAgICAgY2Fwc2l6ZT0zLAogICAgICAgICAgICBjYXB0aGljaz0xLAogICAgICAgICAgICBlbGluZXdpZHRoPTEKICAgICAgICApCiAgICAKICAgIGF4LnNldF94bGFiZWwoJ1RpbWUgKHMpJywgZm9udHNpemU9MTIpCiAgICBheC5zZXRfeWxhYmVsKCfOlEYvRicsIGZvbnRzaXplPTEyKQogICAgYXguc2V0X3RpdGxlKCdUaW1lIENvdXJzZSBieSBDb25kaXRpb24nLCBmb250c2l6ZT0xNCkKICAgIGF4LmxlZ2VuZChsb2M9J2Jlc3QnLCBmb250c2l6ZT0xMCkKICAgIGF4LmdyaWQoVHJ1ZSwgYWxwaGE9MC4zKQogICAgCiAgICBwbHQudGlnaHRfbGF5b3V0KCkKICAgIAogICAgaWYgc2F2ZV9wYXRoOgogICAgICAgIHBsdC5zYXZlZmlnKHNhdmVfcGF0aCwgZHBpPTMwMCwgYmJveF9pbmNoZXM9J3RpZ2h0JykKICAgICAgICBwcmludChmIlBsb3Qgc2F2ZWQgdG8ge3NhdmVfcGF0aH0iKQogICAgZWxzZToKICAgICAgICBwbHQuc2hvdygpCiAgICAKICAgIHBsdC5jbG9zZSgpCgoKZGVmIHByaW50X2Jhc2VsaW5lX29wdGlvbnMoKToKICAgICIiIgogICAgUHJpbnQgZGVzY3JpcHRpb25zIG9mIGJhc2VsaW5lIGZpdHRpbmcgYW5kIG5vcm1hbGl6YXRpb24gb3B0aW9ucy4KICAgICIiIgogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgiQkFTRUxJTkUgRklUVElORyBPUFRJT05TIikKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoIlxuMS4gTE9XRVNTIChMb2NhbGx5IFdlaWdodGVkIFNjYXR0ZXJwbG90IFNtb290aGluZykiKQogICAgcHJpbnQoIiAgIEZvcm11bGE6IGcodCkgPSBMT1dFU1MoRl9iYXNlbGluZSwgdF9iYXNlbGluZSwgZnJhYykiKQogICAgcHJpbnQoIiAgIFdoZW4gdG8gdXNlOiBCYXNlbGluZSBoYXMgZ3JhZHVhbCBkcmlmdCBvciBub24tbGluZWFyIHRyZW5kcyIpCiAgICBwcmludCgiICAgQmVzdCBmb3I6IE5vbi1saW5lYXIgYmFzZWxpbmVzIHdpdGggc21vb3RoIHRyZW5kcyIpCiAgICBwcmludCgiICAgUGFyYW1ldGVyczoiKQogICAgcHJpbnQoIiAgICAgLSBmcmFjOiBGcmFjdGlvbiBvZiBkYXRhIHVzZWQgZm9yIHNtb290aGluZyAoZGVmYXVsdDogMC41KSIpCiAgICBwcmludCgiICAgICAgICogSGlnaGVyIGZyYWMgKDAuNy0wLjkpID0gc21vb3RoZXIsIG1vcmUgZ2xvYmFsIGZpdCIpCiAgICBwcmludCgiICAgICAgICogTG93ZXIgZnJhYyAoMC4yLTAuNCkgPSBtb3JlIGxvY2FsLCBmb2xsb3dzIGRhdGEgY2xvc2VseSIpCiAgICBwcmludCgpCiAgICBwcmludCgiMi4gQ09OU1RBTlQgKDB0aC1vcmRlciBwb2x5bm9taWFsKSIpCiAgICBwcmludCgiICAgRm9ybXVsYTogZyh0KSA9IG1lYW4oRl9iYXNlbGluZSkgZm9yIGFsbCB0IikKICAgIHByaW50KCIgICBXaGVuIHRvIHVzZTogQmFzZWxpbmUgaXMgc3RhYmxlL2ZsYXQgd2l0aCBtaW5pbWFsIGRyaWZ0IikKICAgIHByaW50KCIgICBCZXN0IGZvcjogU3RhYmxlIGJhc2VsaW5lcyB3aXRoIG5vIHRpbWUtZGVwZW5kZW50IHRyZW5kcyIpCiAgICBwcmludCgiICAgUGFyYW1ldGVyczogTm9uZSIpCiAgICBwcmludCgpCiAgICBwcmludCgiMy4gUE9MWU5PTUlBTCAoMXN0LW9yZGVyIG9yIGhpZ2hlcikiKQogICAgcHJpbnQoIiAgIEZvcm11bGE6IGcodCkgPSBj4oKAICsgY+KCgXQgKyBj4oKCdMKyICsgLi4uIikKICAgIHByaW50KCIgICBXaGVuIHRvIHVzZTogQmFzZWxpbmUgaGFzIGxpbmVhciBvciBwb2x5bm9taWFsIGRyaWZ0IikKICAgIHByaW50KCIgICBCZXN0IGZvcjogQmFzZWxpbmVzIHdpdGgga25vd24gcG9seW5vbWlhbCB0cmVuZHMiKQogICAgcHJpbnQoIiAgIFBhcmFtZXRlcnM6IikKICAgIHByaW50KCIgICAgIC0gcG9seV9vcmRlcjogUG9seW5vbWlhbCBvcmRlciAoZGVmYXVsdDogMSA9IGxpbmVhcikiKQogICAgcHJpbnQoIiAgICAgICAqIE9yZGVyIDE6IExpbmVhciBkcmlmdCAoZyh0KSA9IGPigoAgKyBj4oKBdCkiKQogICAgcHJpbnQoIiAgICAgICAqIE9yZGVyIDI6IFF1YWRyYXRpYyBkcmlmdCAoZyh0KSA9IGPigoAgKyBj4oKBdCArIGPigoJ0wrIpIikKICAgIHByaW50KCIgICAgICAgKiBIaWdoZXIgb3JkZXJzOiBNb3JlIGNvbXBsZXggdHJlbmRzIikKICAgIHByaW50KCkKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoIk5PUk1BTElaQVRJT04gT1BUSU9OUyIpCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KCJcbjEuIERFTFRBX0ZfT1ZFUl9GICjOlEYvRikiKQogICAgcHJpbnQoIiAgIEZvcm11bGE6IEYnKHQpID0gKEYodCkgLSBnKHQpKSAvIGcodCkiKQogICAgcHJpbnQoIiAgIFdoZW4gdG8gdXNlOiBNZWFzdXJlIHJlbGF0aXZlIGNoYW5nZSBmcm9tIGJhc2VsaW5lIikKICAgIHByaW50KCIgICBCZXN0IGZvcjogRGV0ZWN0aW5nIGluY3JlYXNlcy9kZWNyZWFzZXMgcmVsYXRpdmUgdG8gYmFzZWxpbmUiKQogICAgcHJpbnQoIiAgIEludGVycHJldGF0aW9uOiIpCiAgICBwcmludCgiICAgICAqIEYnKHQpID0gMDogTm8gY2hhbmdlIGZyb20gYmFzZWxpbmUiKQogICAgcHJpbnQoIiAgICAgKiBGJyh0KSA+IDA6IEluY3JlYXNlIGFib3ZlIGJhc2VsaW5lIChlLmcuLCAwLjUgPSA1MCUgaW5jcmVhc2UpIikKICAgIHByaW50KCIgICAgICogRicodCkgPCAwOiBEZWNyZWFzZSBiZWxvdyBiYXNlbGluZSAoZS5nLiwgLTAuMyA9IDMwJSBkZWNyZWFzZSkiKQogICAgcHJpbnQoIiAgIFZhbHVlcyBjYW4gYmUgbmVnYXRpdmUgKGJlbG93IGJhc2VsaW5lKSBvciBwb3NpdGl2ZSAoYWJvdmUgYmFzZWxpbmUpIikKICAgIHByaW50KCkKICAgIHByaW50KCIyLiBNVUxUSVBMSUNBVElWRSIpCiAgICBwcmludCgiICAgRm9ybXVsYTogRl9ub3JtKHQpID0gRih0KSAvIGcodCkiKQogICAgcHJpbnQoIiAgIFdoZW4gdG8gdXNlOiBOb3JtYWxpemUgYnkgYmFzZWxpbmUgd2l0aG91dCBzdWJ0cmFjdGluZyIpCiAgICBwcmludCgiICAgQmVzdCBmb3I6IEZvbGQtY2hhbmdlIGFuYWx5c2lzIikKICAgIHByaW50KCIgICBJbnRlcnByZXRhdGlvbjoiKQogICAgcHJpbnQoIiAgICAgKiBGX25vcm0odCkgPSAxLjA6IE5vIGNoYW5nZSBmcm9tIGJhc2VsaW5lIikKICAgIHByaW50KCIgICAgICogRl9ub3JtKHQpID0gMi4wOiAyLWZvbGQgaW5jcmVhc2UgKDEwMCUgaW5jcmVhc2UpIikKICAgIHByaW50KCIgICAgICogRl9ub3JtKHQpID0gMC41OiAyLWZvbGQgZGVjcmVhc2UgKDUwJSBvZiBiYXNlbGluZSkiKQogICAgcHJpbnQoIiAgIFZhbHVlcyBhcmUgYWx3YXlzIHBvc2l0aXZlIChyYXRpbyB0byBiYXNlbGluZSkiKQogICAgcHJpbnQoKQogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgiU1RBVElTVElDUyBDT01QVVRBVElPTiIpCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KCJcbkZvciBlYWNoIGNvbmRpdGlvbiBhbmQgdGltZXBvaW50LCB0aGUgZm9sbG93aW5nIHN0YXRpc3RpY3MgYXJlIGNvbXB1dGVkOiIpCiAgICBwcmludCgiICBNZWFuOiDOvCh0KSA9ICgxL24pICogzqMgRicodCkiKQogICAgcHJpbnQoIiAgICBBdmVyYWdlIG5vcm1hbGl6ZWQgdmFsdWUgYWNyb3NzIGFsbCB3ZWxscyBpbiB0aGUgY29uZGl0aW9uIikKICAgIHByaW50KCkKICAgIHByaW50KCIgIFNEOiDPgyh0KSA9IHNxcnQozqMoRicodCkgLSDOvCh0KSnCsiAvIChuLTEpKSIpCiAgICBwcmludCgiICAgIFNhbXBsZSBzdGFuZGFyZCBkZXZpYXRpb24gKGRkb2Y9MSkgYWNyb3NzIHdlbGxzIikKICAgIHByaW50KCkKICAgIHByaW50KCIgIFNFTTogU0VNKHQpID0gz4ModCkgLyBzcXJ0KG4pIikKICAgIHByaW50KCIgICAgU3RhbmRhcmQgZXJyb3Igb2YgdGhlIG1lYW4gPSBTRCAvIHNxcnQobl93ZWxscykiKQogICAgcHJpbnQoIiAgICBOb3RlOiBTRU0gaXMgY29tcHV0ZWQgYWNyb3NzIHdlbGxzLCBub3QgcHJvcGFnYXRlZCBmcm9tIGJhc2VsaW5lIGVycm9yIikKICAgIHByaW50KCkKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoKQoKCmRlZiBwcm9jZXNzX2Jhc2VsaW5lX25vcm1hbGl6YXRpb24oCiAgICBkZjogcGQuRGF0YUZyYW1lLAogICAgYmFzZWxpbmVfc3RhcnRfdGltZTogZmxvYXQgPSAwLjAsCiAgICBiYXNlbGluZV9lbmRfdGltZTogZmxvYXQgPSAyNC4wLAogICAgYmFzZWxpbmVfbWV0aG9kOiBzdHIgPSAnY29uc3RhbnQnLAogICAgYmFzZWxpbmVfZnJhYzogZmxvYXQgPSAwLjUsCiAgICBiYXNlbGluZV9wb2x5X29yZGVyOiBpbnQgPSAxLAogICAgbm9ybWFsaXphdGlvbl9tb2RlOiBzdHIgPSAnbXVsdGlwbGljYXRpdmUnLAogICAgY29uZmlnOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUsCiAgICBvdXRwdXRfZGlyOiBzdHIgPSBOb25lCikgLT4gdHVwbGU6CiAgICAiIiIKICAgIENvbXBsZXRlIHBpcGVsaW5lOiBiYXNlbGluZSBpZGVudGlmaWNhdGlvbiwgZml0dGluZywgbm9ybWFsaXphdGlvbiwgYW5kIHN0YXRpc3RpY3MuCiAgICAKICAgIFBhcmFtZXRlcnM6CiAgICAtLS0tLS0tLS0tLQogICAgZGYgOiBwZC5EYXRhRnJhbWUKICAgICAgICBMb25nLWZvcm1hdCBEYXRhRnJhbWUgd2l0aCBjb2x1bW5zIFsncGxhdGVfaWQnLCAnd2VsbCcsICdjb250ZW50JywgJ3RpbWVfcycsICd2YWx1ZSddCiAgICBiYXNlbGluZV9zdGFydF90aW1lIDogZmxvYXQKICAgICAgICBNaW5pbXVtIHRpbWUgKGluIHNlY29uZHMpIGZvciBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQ6IDAuMCkKICAgIGJhc2VsaW5lX2VuZF90aW1lIDogZmxvYXQKICAgICAgICBNYXhpbXVtIHRpbWUgKGluIHNlY29uZHMpIGZvciBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQ6IDI0LjApCiAgICBiYXNlbGluZV9tZXRob2QgOiBzdHIKICAgICAgICBCYXNlbGluZSBmaXR0aW5nIG1ldGhvZDogJ2xvd2VzcycsICdjb25zdGFudCcsIG9yICdwb2x5bm9taWFsJyAoZGVmYXVsdDogJ2NvbnN0YW50JykKICAgIGJhc2VsaW5lX2ZyYWMgOiBmbG9hdAogICAgICAgIEZyYWN0aW9uIG9mIGRhdGEgdXNlZCBmb3IgTE9XRVNTIHNtb290aGluZyAoZGVmYXVsdDogMC41KQogICAgYmFzZWxpbmVfcG9seV9vcmRlciA6IGludAogICAgICAgIFBvbHlub21pYWwgb3JkZXIgZm9yIHBvbHlub21pYWwgZml0IChkZWZhdWx0OiAxKQogICAgbm9ybWFsaXphdGlvbl9tb2RlIDogc3RyCiAgICAgICAgTW9kZTogJ2RlbHRhX2Zfb3Zlcl9mJywgJ211bHRpcGxpY2F0aXZlJywgJ2xvd2VzdF9wb2ludCcsICdmaXJzdF9wb2ludCcsICdub25lJywgJ2Jhc2VsaW5lX3N1YnRyYWN0X2xvd2VzdCcsIG9yICdiYXNlbGluZV9zdWJ0cmFjdF9maXJzdCcgKGRlZmF1bHQ6ICdtdWx0aXBsaWNhdGl2ZScpCiAgICBjb25maWcgOiBEaWN0W3N0ciwgQW55XSwgb3B0aW9uYWwKICAgICAgICBDb25maWd1cmF0aW9uIGRpY3Rpb25hcnkuIElmIE5vbmUsIGxvYWRzIGZyb20gcGxhdGVfY29uZmlnLmpzb24KICAgIG91dHB1dF9kaXIgOiBzdHIsIG9wdGlvbmFsCiAgICAgICAgRGlyZWN0b3J5IHRvIHNhdmUgb3V0cHV0cy4gSWYgTm9uZSwgdXNlcyBjdXJyZW50IGRpcmVjdG9yeS4KICAgIAogICAgUmV0dXJuczoKICAgIC0tLS0tLS0tCiAgICB0dXBsZQogICAgICAgIChub3JtX2RmLCBzdGF0c19kZiwgYmFzZWxpbmVfZml0cykKICAgICAgICAtIG5vcm1fZGY6IE5vcm1hbGl6ZWQgRGF0YUZyYW1lCiAgICAgICAgLSBzdGF0c19kZjogQ29uZGl0aW9uIHN0YXRpc3RpY3MgRGF0YUZyYW1lCiAgICAgICAgLSBiYXNlbGluZV9maXRzOiBEaWN0aW9uYXJ5IG9mIGJhc2VsaW5lIGZpdHMgcGVyIHdlbGwKICAgICIiIgogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgiQkFTRUxJTkUgSURFTlRJRklDQVRJT04gQU5EIE5PUk1BTElaQVRJT04gUElQRUxJTkUiKQogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludChmIlxuQ3VycmVudCBTZXR0aW5nczoiKQogICAgcHJpbnQoZiIgIEJhc2VsaW5lIHdpbmRvdzoge2Jhc2VsaW5lX3N0YXJ0X3RpbWV9IHMgPD0gVGltZV9zIDw9IHtiYXNlbGluZV9lbmRfdGltZX0gcyIpCiAgICBwcmludChmIiAgQmFzZWxpbmUgbWV0aG9kOiB7YmFzZWxpbmVfbWV0aG9kfSIpCiAgICBpZiBiYXNlbGluZV9tZXRob2QgPT0gJ2xvd2Vzcyc6CiAgICAgICAgcHJpbnQoZiIgICAgTE9XRVNTIHNtb290aGluZyBmcmFjdGlvbiAoZnJhYyk6IHtiYXNlbGluZV9mcmFjfSIpCiAgICBlbGlmIGJhc2VsaW5lX21ldGhvZCA9PSAncG9seW5vbWlhbCc6CiAgICAgICAgcHJpbnQoZiIgICAgUG9seW5vbWlhbCBvcmRlcjoge2Jhc2VsaW5lX3BvbHlfb3JkZXJ9IikKICAgIHByaW50KGYiICBOb3JtYWxpemF0aW9uIG1vZGU6IHtub3JtYWxpemF0aW9uX21vZGV9IikKICAgIHByaW50KCkKICAgIHByaW50KCJGb3IgZGV0YWlsZWQgb3B0aW9uIGRlc2NyaXB0aW9ucywgY2FsbDogcHJpbnRfYmFzZWxpbmVfb3B0aW9ucygpIikKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoKQogICAgCiAgICAjIExvYWQgY29uZmlnIGlmIG5vdCBwcm92aWRlZAogICAgaWYgY29uZmlnIGlzIE5vbmU6CiAgICAgICAgc2NyaXB0X2RpciA9IG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmFic3BhdGgoX19maWxlX18pKQogICAgICAgIGNvbmZpZ19wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJwbGF0ZV9jb25maWcuanNvbiIpCiAgICAgICAgY29uZmlnID0gbG9hZF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAKICAgICMgRmlsdGVyIG91dCBiYWQgd2VsbHMgYmVmb3JlIHByb2Nlc3NpbmcKICAgIGJhZF93ZWxsc19saXN0ID0gY29uZmlnLmdldCgiYmFkX3dlbGxzIiwgW10pCiAgICBpZiBiYWRfd2VsbHNfbGlzdDoKICAgICAgICBvcmlnaW5hbF9jb3VudCA9IGxlbihkZikKICAgICAgICBkZiA9IGRmW35kZlsid2VsbCJdLmFwcGx5KGxhbWJkYSB3OiBpc19iYWRfd2VsbCh3LCBjb25maWcpKV0KICAgICAgICBmaWx0ZXJlZF9jb3VudCA9IGxlbihkZikKICAgICAgICBpZiBvcmlnaW5hbF9jb3VudCAhPSBmaWx0ZXJlZF9jb3VudDoKICAgICAgICAgICAgcHJpbnQoZiJFeGNsdWRpbmcge29yaWdpbmFsX2NvdW50IC0gZmlsdGVyZWRfY291bnR9IGRhdGEgcG9pbnRzIGZyb20gYmFkIHdlbGxzIiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgcHJpbnQoIlN0ZXAgMTogSWRlbnRpZnlpbmcgYmFzZWxpbmUgd2luZG93cy4uLiIsIGZsdXNoPVRydWUpCiAgICBiYXNlbGluZV93aW5kb3dzID0gaWRlbnRpZnlfYmFzZWxpbmVfd2luZG93KGRmLCBiYXNlbGluZV9zdGFydF90aW1lLCBiYXNlbGluZV9lbmRfdGltZSkKICAgIHByaW50KGYiICBJZGVudGlmaWVkIGJhc2VsaW5lIHdpbmRvd3MgZm9yIHtsZW4oYmFzZWxpbmVfd2luZG93cyl9IHdlbGxzIiwgZmx1c2g9VHJ1ZSkKICAgIHRvdGFsX2Jhc2VsaW5lX3BvaW50cyA9IHN1bShsZW4oYncpIGZvciBidyBpbiBiYXNlbGluZV93aW5kb3dzLnZhbHVlcygpKQogICAgcHJpbnQoZiIgIFRvdGFsIGJhc2VsaW5lIHBvaW50czoge3RvdGFsX2Jhc2VsaW5lX3BvaW50c30iLCBmbHVzaD1UcnVlKQogICAgCiAgICBwcmludCgiU3RlcCAyOiBGaXR0aW5nIGJhc2VsaW5lcy4uLiIsIGZsdXNoPVRydWUpCiAgICBiYXNlbGluZV9maXRzID0gZml0X3dlbGxfYmFzZWxpbmVzKAogICAgICAgIGRmLAogICAgICAgIGJhc2VsaW5lX3N0YXJ0X3RpbWU9YmFzZWxpbmVfc3RhcnRfdGltZSwKICAgICAgICBiYXNlbGluZV9lbmRfdGltZT1iYXNlbGluZV9lbmRfdGltZSwKICAgICAgICBtZXRob2Q9YmFzZWxpbmVfbWV0aG9kLAogICAgICAgIGZyYWM9YmFzZWxpbmVfZnJhYywKICAgICAgICBwb2x5X29yZGVyPWJhc2VsaW5lX3BvbHlfb3JkZXIsCiAgICAgICAgY29uZmlnPWNvbmZpZwogICAgKQogICAgcHJpbnQoZiIgIEZpdHRlZCBiYXNlbGluZXMgZm9yIHtsZW4oYmFzZWxpbmVfZml0cyl9IHdlbGxzIiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgcHJpbnQoIlN0ZXAgMzogTm9ybWFsaXppbmcgd2VsbHMuLi4iLCBmbHVzaD1UcnVlKQogICAgbm9ybV9kZiA9IG5vcm1hbGl6ZV93ZWxscyhkZiwgYmFzZWxpbmVfZml0cywgbm9ybWFsaXphdGlvbl9tb2RlPW5vcm1hbGl6YXRpb25fbW9kZSwgYmFzZWxpbmVfd2luZG93cz1iYXNlbGluZV93aW5kb3dzLCBiYXNlbGluZV9zdGFydF90aW1lPWJhc2VsaW5lX3N0YXJ0X3RpbWUsIGJhc2VsaW5lX2VuZF90aW1lPWJhc2VsaW5lX2VuZF90aW1lKQogICAgcHJpbnQoZiIgIE5vcm1hbGl6ZWQge2xlbihub3JtX2RmKX0gZGF0YSBwb2ludHMiLCBmbHVzaD1UcnVlKQogICAgCiAgICBwcmludCgiU3RlcCA0OiBCdWlsZGluZyBjb25kaXRpb24gbWFwLi4uIiwgZmx1c2g9VHJ1ZSkKICAgIGNvbmRpdGlvbl9tYXAgPSBidWlsZF9jb25kaXRpb25fbWFwKGRmLCBjb25maWc9Y29uZmlnKQogICAgcHJpbnQoZiIgIE1hcHBlZCB7bGVuKGNvbmRpdGlvbl9tYXApfSB3ZWxscyB0byBjb25kaXRpb25zIiwgZmx1c2g9VHJ1ZSkKICAgIGNvbmRpdGlvbl9jb3VudHMgPSB7fQogICAgZm9yIHdlbGxfaWQsIGNvbmRpdGlvbiBpbiBjb25kaXRpb25fbWFwLml0ZW1zKCk6CiAgICAgICAgY29uZGl0aW9uX2NvdW50c1tjb25kaXRpb25dID0gY29uZGl0aW9uX2NvdW50cy5nZXQoY29uZGl0aW9uLCAwKSArIDEKICAgIHByaW50KGYiICBDb25kaXRpb24gZGlzdHJpYnV0aW9uOiIsIGZsdXNoPVRydWUpCiAgICBmb3IgY29uZGl0aW9uLCBjb3VudCBpbiBzb3J0ZWQoY29uZGl0aW9uX2NvdW50cy5pdGVtcygpKToKICAgICAgICBwcmludChmIiAgICB7Y29uZGl0aW9ufToge2NvdW50fSB3ZWxscyIsIGZsdXNoPVRydWUpCiAgICAKICAgIHByaW50KCJTdGVwIDU6IENvbXB1dGluZyBjb25kaXRpb24gc3RhdGlzdGljcy4uLiIsIGZsdXNoPVRydWUpCiAgICBzdGF0c19kZiA9IGNvbXB1dGVfY29uZGl0aW9uX3N0YXRpc3RpY3Mobm9ybV9kZiwgY29uZGl0aW9uX21hcCkKICAgIHByaW50KGYiICBDb21wdXRlZCBzdGF0aXN0aWNzIGZvciB7bGVuKHN0YXRzX2RmKX0gY29uZGl0aW9uLXRpbWVwb2ludCBjb21iaW5hdGlvbnMiLCBmbHVzaD1UcnVlKQogICAgCiAgICAjIFNhdmUgb3V0cHV0cyBpZiBvdXRwdXRfZGlyIGlzIHByb3ZpZGVkCiAgICBpZiBvdXRwdXRfZGlyOgogICAgICAgIGVuc3VyZV9kaXIob3V0cHV0X2RpcikKICAgICAgICAKICAgICAgICBwcmludCgiU3RlcCA2OiBTYXZpbmcgb3V0cHV0cy4uLiIsIGZsdXNoPVRydWUpCiAgICAgICAgCiAgICAgICAgIyBTYXZlIG5vcm1hbGl6ZWQgZGF0YQogICAgICAgIG5vcm1fY3N2X3BhdGggPSBvcy5wYXRoLmpvaW4ob3V0cHV0X2RpciwgIm5vcm1hbGl6ZWRfZGF0YS5jc3YiKQogICAgICAgIG5vcm1fZGYudG9fY3N2KG5vcm1fY3N2X3BhdGgsIGluZGV4PUZhbHNlKQogICAgICAgIHByaW50KGYiICBTYXZlZCBub3JtYWxpemVkIGRhdGEgdG8ge25vcm1fY3N2X3BhdGh9IiwgZmx1c2g9VHJ1ZSkKICAgICAgICAKICAgICAgICAjIFNhdmUgY29uZGl0aW9uIHN0YXRpc3RpY3MKICAgICAgICBzdGF0c19jc3ZfcGF0aCA9IG9zLnBhdGguam9pbihvdXRwdXRfZGlyLCAiY29uZGl0aW9uX3N0YXRpc3RpY3MuY3N2IikKICAgICAgICBzdGF0c19kZi50b19jc3Yoc3RhdHNfY3N2X3BhdGgsIGluZGV4PUZhbHNlKQogICAgICAgIHByaW50KGYiICBTYXZlZCBjb25kaXRpb24gc3RhdGlzdGljcyB0byB7c3RhdHNfY3N2X3BhdGh9IiwgZmx1c2g9VHJ1ZSkKICAgICAgICAKICAgICAgICAjIFNhdmUgcGxvdAogICAgICAgIHBsb3RfcGF0aCA9IG9zLnBhdGguam9pbihvdXRwdXRfZGlyLCAidGltZWNvdXJzZV9wbG90LnBuZyIpCiAgICAgICAgcGxvdF90aW1lY291cnNlKHN0YXRzX2RmLCBzYXZlX3BhdGg9cGxvdF9wYXRoLCBjb25maWc9Y29uZmlnKQogICAgICAgIHByaW50KGYiICBTYXZlZCBwbG90IHRvIHtwbG90X3BhdGh9IiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgcmV0dXJuIG5vcm1fZGYsIHN0YXRzX2RmLCBiYXNlbGluZV9maXRzCgoKZGVmIHByb21wdF9iYXNlbGluZV9zZXR0aW5ncygpOgogICAgIiIiCiAgICBQcm9tcHQgdXNlciBmb3IgYmFzZWxpbmUgYW5kIG5vcm1hbGl6YXRpb24gc2V0dGluZ3MuCiAgICBSZXR1cm5zIGEgdHVwbGUgb2YgKGJhc2VsaW5lX3N0YXJ0X3RpbWUsIGJhc2VsaW5lX2VuZF90aW1lLCBiYXNlbGluZV9tZXRob2QsIGJhc2VsaW5lX2ZyYWMsIGJhc2VsaW5lX3BvbHlfb3JkZXIsIG5vcm1hbGl6YXRpb25fbW9kZSkKICAgIAogICAgSWYgc3RkaW4gaXMgbm90IGF2YWlsYWJsZSAobm9uLWludGVyYWN0aXZlIG1vZGUpIG9yIGNvbW1hbmQtbGluZSBhcmd1bWVudHMgYXJlIHByb3ZpZGVkLAogICAgcmV0dXJucyBkZWZhdWx0IHZhbHVlcyBvciB2YWx1ZXMgZnJvbSBjb21tYW5kLWxpbmUgYXJndW1lbnRzLgogICAgCiAgICBDb21tYW5kLWxpbmUgYXJndW1lbnRzIChvcHRpb25hbCk6CiAgICAgICAgLS1iYXNlbGluZS1zdGFydC10aW1lIEZMT0FUCiAgICAgICAgLS1iYXNlbGluZS1lbmQtdGltZSBGTE9BVAogICAgICAgIC0tYmFzZWxpbmUtbWV0aG9kIHtjb25zdGFudHxsb3dlc3N8cG9seW5vbWlhbH0KICAgICAgICAtLWJhc2VsaW5lLWZyYWMgRkxPQVQgKGZvciBMT1dFU1MpCiAgICAgICAgLS1iYXNlbGluZS1wb2x5LW9yZGVyIElOVCAoZm9yIHBvbHlub21pYWwpCiAgICAgICAgLS1ub3JtYWxpemF0aW9uLW1vZGUge211bHRpcGxpY2F0aXZlfGRlbHRhX2Zfb3Zlcl9mfGxvd2VzdF9wb2ludHxmaXJzdF9wb2ludHxub25lfGJhc2VsaW5lX3N1YnRyYWN0X2xvd2VzdHxiYXNlbGluZV9zdWJ0cmFjdF9maXJzdH0KICAgICIiIgogICAgaW1wb3J0IGFyZ3BhcnNlCiAgICAKICAgICMgUGFyc2UgY29tbWFuZC1saW5lIGFyZ3VtZW50cyBmaXJzdAogICAgcGFyc2VyID0gYXJncGFyc2UuQXJndW1lbnRQYXJzZXIoYWRkX2hlbHA9RmFsc2UpICAjIERvbid0IHNob3cgaGVscCwgd2UnbGwgaGFuZGxlIHByb21wdHMKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoJy0tYmFzZWxpbmUtc3RhcnQtdGltZScsIHR5cGU9ZmxvYXQsIGRlZmF1bHQ9Tm9uZSkKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoJy0tYmFzZWxpbmUtZW5kLXRpbWUnLCB0eXBlPWZsb2F0LCBkZWZhdWx0PU5vbmUpCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCctLWJhc2VsaW5lLW1ldGhvZCcsIHR5cGU9c3RyLCBjaG9pY2VzPVsnY29uc3RhbnQnLCAnbG93ZXNzJywgJ3BvbHlub21pYWwnXSwgZGVmYXVsdD1Ob25lKQogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgnLS1iYXNlbGluZS1mcmFjJywgdHlwZT1mbG9hdCwgZGVmYXVsdD1Ob25lKQogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgnLS1iYXNlbGluZS1wb2x5LW9yZGVyJywgdHlwZT1pbnQsIGRlZmF1bHQ9Tm9uZSkKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoJy0tbm9ybWFsaXphdGlvbi1tb2RlJywgdHlwZT1zdHIsIGNob2ljZXM9WydtdWx0aXBsaWNhdGl2ZScsICdkZWx0YV9mX292ZXJfZicsICdsb3dlc3RfcG9pbnQnLCAnZmlyc3RfcG9pbnQnLCAnbm9uZScsICdiYXNlbGluZV9zdWJ0cmFjdF9sb3dlc3QnLCAnYmFzZWxpbmVfc3VidHJhY3RfZmlyc3QnXSwgZGVmYXVsdD1Ob25lKQogICAgCiAgICAjIFBhcnNlIGtub3duIGFyZ3Mgb25seSAoaWdub3JlIHVua25vd24gYXJncyB0aGF0IG1pZ2h0IGJlIHVzZWQgZWxzZXdoZXJlKQogICAgYXJncywgXyA9IHBhcnNlci5wYXJzZV9rbm93bl9hcmdzKCkKICAgIAogICAgIyBJZiBhbGwgc2V0dGluZ3MgcHJvdmlkZWQgdmlhIGNvbW1hbmQtbGluZSwgdXNlIHRoZW0gKG5vbi1pbnRlcmFjdGl2ZSkKICAgIGlmIGFsbChbYXJncy5iYXNlbGluZV9zdGFydF90aW1lIGlzIG5vdCBOb25lLCBhcmdzLmJhc2VsaW5lX2VuZF90aW1lIGlzIG5vdCBOb25lLCBhcmdzLmJhc2VsaW5lX21ldGhvZCBpcyBub3QgTm9uZSwgCiAgICAgICAgICAgIGFyZ3Mubm9ybWFsaXphdGlvbl9tb2RlIGlzIG5vdCBOb25lXSk6CiAgICAgICAgYmFzZWxpbmVfc3RhcnRfdGltZSA9IGFyZ3MuYmFzZWxpbmVfc3RhcnRfdGltZQogICAgICAgIGJhc2VsaW5lX2VuZF90aW1lID0gYXJncy5iYXNlbGluZV9lbmRfdGltZQogICAgICAgIGJhc2VsaW5lX21ldGhvZCA9IGFyZ3MuYmFzZWxpbmVfbWV0aG9kCiAgICAgICAgYmFzZWxpbmVfZnJhYyA9IGFyZ3MuYmFzZWxpbmVfZnJhYyBpZiBhcmdzLmJhc2VsaW5lX2ZyYWMgaXMgbm90IE5vbmUgZWxzZSAwLjUKICAgICAgICBiYXNlbGluZV9wb2x5X29yZGVyID0gYXJncy5iYXNlbGluZV9wb2x5X29yZGVyIGlmIGFyZ3MuYmFzZWxpbmVfcG9seV9vcmRlciBpcyBub3QgTm9uZSBlbHNlIDEKICAgICAgICAKICAgICAgICBwcmludCgiXG7inJMgVXNpbmcgY29tbWFuZC1saW5lIHNldHRpbmdzOiIpCiAgICAgICAgcHJpbnQoZiIgIEJhc2VsaW5lIHdpbmRvdzoge2Jhc2VsaW5lX3N0YXJ0X3RpbWV9IHMgdG8ge2Jhc2VsaW5lX2VuZF90aW1lfSBzIikKICAgICAgICBwcmludChmIiAgQmFzZWxpbmUgbWV0aG9kOiB7YmFzZWxpbmVfbWV0aG9kfSIpCiAgICAgICAgaWYgYmFzZWxpbmVfbWV0aG9kID09ICdsb3dlc3MnOgogICAgICAgICAgICBwcmludChmIiAgTE9XRVNTIHNtb290aGluZyBmcmFjdGlvbjoge2Jhc2VsaW5lX2ZyYWN9IikKICAgICAgICBlbGlmIGJhc2VsaW5lX21ldGhvZCA9PSAncG9seW5vbWlhbCc6CiAgICAgICAgICAgIHByaW50KGYiICBQb2x5bm9taWFsIG9yZGVyOiB7YmFzZWxpbmVfcG9seV9vcmRlcn0iKQogICAgICAgIHByaW50KGYiICBOb3JtYWxpemF0aW9uIG1vZGU6IHthcmdzLm5vcm1hbGl6YXRpb25fbW9kZX1cbiIpCiAgICAgICAgcmV0dXJuIGJhc2VsaW5lX3N0YXJ0X3RpbWUsIGJhc2VsaW5lX2VuZF90aW1lLCBiYXNlbGluZV9tZXRob2QsIGJhc2VsaW5lX2ZyYWMsIGJhc2VsaW5lX3BvbHlfb3JkZXIsIGFyZ3Mubm9ybWFsaXphdGlvbl9tb2RlCiAgICAKICAgICMgQ2hlY2sgaWYgc3RkaW4gaXMgYXZhaWxhYmxlIChpbnRlcmFjdGl2ZSBtb2RlKQogICAgaWYgbm90IHN5cy5zdGRpbi5pc2F0dHkoKToKICAgICAgICBwcmludCgiXG7imqDvuI8gIFJ1bm5pbmcgaW4gbm9uLWludGVyYWN0aXZlIG1vZGUuIFVzaW5nIGRlZmF1bHQgc2V0dGluZ3M6IikKICAgICAgICBwcmludCgiICBCYXNlbGluZSB3aW5kb3c6IDAuMCBzIHRvIDI0LjAgcyIpCiAgICAgICAgcHJpbnQoIiAgQmFzZWxpbmUgbWV0aG9kOiBjb25zdGFudCIpCiAgICAgICAgcHJpbnQoIiAgTm9ybWFsaXphdGlvbiBtb2RlOiBtdWx0aXBsaWNhdGl2ZVxuIikKICAgICAgICByZXR1cm4gMC4wLCAyNC4wLCAnY29uc3RhbnQnLCAwLjUsIDEsICdtdWx0aXBsaWNhdGl2ZScKICAgIAogICAgcHJpbnQoIlxuIiArICI9IiAqIDcwKQogICAgcHJpbnQoIkJBU0VMSU5FIEFORCBOT1JNQUxJWkFUSU9OIFNFVFRJTkdTIikKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoIlxuVGhlc2Ugc2V0dGluZ3Mgd2lsbCBiZSB1c2VkIGZvciBDU1YgZ2VuZXJhdGlvbiBhbmQgbm9ybWFsaXphdGlvbi4iKQogICAgcHJpbnQoIkluIHRoZSB3ZWIgdmlld2VyOiBTdGVwIDAgKGJhc2VsaW5lIHN1YnRyYWN0aW9uKSBhbmQgU3RlcCAxIChub3JtYWxpemF0aW9uKSBjYW4gYmUiKQogICAgcHJpbnQoImVuYWJsZWQgc2VwYXJhdGVseTsgU3RlcCAyIChncm91cCB0cmlwbGljYXRlcykgcmVxdWlyZXMgU3RlcCAwIG9yIFN0ZXAgMS4iKQogICAgcHJpbnQoIllvdSBjYW4gY2hhbmdlIGFsbCBvZiB0aGVzZSBsYXRlciBpbiB0aGUgd2ViIGludGVyZmFjZS4iKQogICAgcHJpbnQoIihQcmVzcyBFbnRlciB0byBhY2NlcHQgZGVmYXVsdHMpXG4iKQogICAgCiAgICAjIFByb21wdCBmb3IgYmFzZWxpbmUgc3RhcnQgdGltZSAodXNlIGNvbW1hbmQtbGluZSBhcmcgaWYgcHJvdmlkZWQpCiAgICBiYXNlbGluZV9zdGFydF90aW1lID0gTm9uZQogICAgaWYgYXJncy5iYXNlbGluZV9zdGFydF90aW1lIGlzIG5vdCBOb25lOgogICAgICAgIGJhc2VsaW5lX3N0YXJ0X3RpbWUgPSBhcmdzLmJhc2VsaW5lX3N0YXJ0X3RpbWUKICAgICAgICBwcmludChmIkJhc2VsaW5lIHdpbmRvdyBzdGFydCB0aW1lOiB7YmFzZWxpbmVfc3RhcnRfdGltZX0gcyAoZnJvbSBjb21tYW5kLWxpbmUpIikKICAgIGVsc2U6CiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYmFzZWxpbmVfc3RhcnRfaW5wdXQgPSBpbnB1dCgiQmFzZWxpbmUgd2luZG93IHN0YXJ0IHRpbWUgKHNlY29uZHMpIFtkZWZhdWx0OiAwLjBdOiAiKS5zdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBub3QgYmFzZWxpbmVfc3RhcnRfaW5wdXQ6CiAgICAgICAgICAgICAgICAgICAgYmFzZWxpbmVfc3RhcnRfdGltZSA9IDAuMAogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9zdGFydF90aW1lID0gZmxvYXQoYmFzZWxpbmVfc3RhcnRfaW5wdXQpCiAgICAgICAgICAgICAgICAgICAgaWYgYmFzZWxpbmVfc3RhcnRfdGltZSA8IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KCIgIOKaoO+4jyAgUGxlYXNlIGVudGVyIGEgbm9uLW5lZ2F0aXZlIG51bWJlci4iKQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZXhjZXB0IChWYWx1ZUVycm9yLCBFT0ZFcnJvciwgS2V5Ym9hcmRJbnRlcnJ1cHQpOgogICAgICAgICAgICAgICAgcHJpbnQoIlxuICDimqDvuI8gIFVzaW5nIGRlZmF1bHQgdmFsdWU6IDAuMCIpCiAgICAgICAgICAgICAgICBiYXNlbGluZV9zdGFydF90aW1lID0gMC4wCiAgICAgICAgICAgICAgICBicmVhawogICAgCiAgICAjIFByb21wdCBmb3IgYmFzZWxpbmUgZW5kIHRpbWUgKHVzZSBjb21tYW5kLWxpbmUgYXJnIGlmIHByb3ZpZGVkKQogICAgYmFzZWxpbmVfZW5kX3RpbWUgPSBOb25lCiAgICBpZiBhcmdzLmJhc2VsaW5lX2VuZF90aW1lIGlzIG5vdCBOb25lOgogICAgICAgIGJhc2VsaW5lX2VuZF90aW1lID0gYXJncy5iYXNlbGluZV9lbmRfdGltZQogICAgICAgIHByaW50KGYiQmFzZWxpbmUgd2luZG93IGVuZCB0aW1lOiB7YmFzZWxpbmVfZW5kX3RpbWV9IHMgKGZyb20gY29tbWFuZC1saW5lKSIpCiAgICBlbHNlOgogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGJhc2VsaW5lX2lucHV0ID0gaW5wdXQoIkJhc2VsaW5lIHdpbmRvdyBlbmQgdGltZSAoc2Vjb25kcykgW2RlZmF1bHQ6IDI0LjBdOiAiKS5zdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBub3QgYmFzZWxpbmVfaW5wdXQ6CiAgICAgICAgICAgICAgICAgICAgYmFzZWxpbmVfZW5kX3RpbWUgPSAyNC4wCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGJhc2VsaW5lX2VuZF90aW1lID0gZmxvYXQoYmFzZWxpbmVfaW5wdXQpCiAgICAgICAgICAgICAgICAgICAgaWYgYmFzZWxpbmVfZW5kX3RpbWUgPD0gYmFzZWxpbmVfc3RhcnRfdGltZToKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiIgIOKaoO+4jyAgUGxlYXNlIGVudGVyIGEgbnVtYmVyIGdyZWF0ZXIgdGhhbiBzdGFydCB0aW1lICh7YmFzZWxpbmVfc3RhcnRfdGltZX0gcykuIikKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGV4Y2VwdCAoVmFsdWVFcnJvciwgRU9GRXJyb3IsIEtleWJvYXJkSW50ZXJydXB0KToKICAgICAgICAgICAgICAgIHByaW50KCJcbiAg4pqg77iPICBVc2luZyBkZWZhdWx0IHZhbHVlOiAyNC4wIikKICAgICAgICAgICAgICAgIGJhc2VsaW5lX2VuZF90aW1lID0gMjQuMAogICAgICAgICAgICAgICAgYnJlYWsKICAgIAogICAgIyBQcm9tcHQgZm9yIGJhc2VsaW5lIG1ldGhvZCAodXNlIGNvbW1hbmQtbGluZSBhcmcgaWYgcHJvdmlkZWQpCiAgICBpZiBhcmdzLmJhc2VsaW5lX21ldGhvZCBpcyBub3QgTm9uZToKICAgICAgICBiYXNlbGluZV9tZXRob2QgPSBhcmdzLmJhc2VsaW5lX21ldGhvZAogICAgICAgIHByaW50KGYiXG5CYXNlbGluZSBtZXRob2Q6IHtiYXNlbGluZV9tZXRob2R9IChmcm9tIGNvbW1hbmQtbGluZSkiKQogICAgZWxzZToKICAgICAgICBwcmludCgiXG5CYXNlbGluZSBmaXR0aW5nIG1ldGhvZDoiKQogICAgICAgIHByaW50KCIgIDEuIGNvbnN0YW50IC0gTWVhbiBvZiBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQpIikKICAgICAgICBwcmludCgiICAyLiBsb3dlc3MgLSBMb2NhbGx5IFdlaWdodGVkIFNjYXR0ZXJwbG90IFNtb290aGluZyIpCiAgICAgICAgcHJpbnQoIiAgMy4gcG9seW5vbWlhbCAtIFBvbHlub21pYWwgZml0IikKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBtZXRob2RfaW5wdXQgPSBpbnB1dCgiU2VsZWN0IG1ldGhvZCBbMS0zLCBkZWZhdWx0OiAxXTogIikuc3RyaXAoKQogICAgICAgICAgICAgICAgaWYgbm90IG1ldGhvZF9pbnB1dDoKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9tZXRob2QgPSAnY29uc3RhbnQnCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsaWYgbWV0aG9kX2lucHV0ID09ICcxJzoKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9tZXRob2QgPSAnY29uc3RhbnQnCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsaWYgbWV0aG9kX2lucHV0ID09ICcyJzoKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9tZXRob2QgPSAnbG93ZXNzJwogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBlbGlmIG1ldGhvZF9pbnB1dCA9PSAnMyc6CiAgICAgICAgICAgICAgICAgICAgYmFzZWxpbmVfbWV0aG9kID0gJ3BvbHlub21pYWwnCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoIiAg4pqg77iPICBQbGVhc2UgZW50ZXIgMSwgMiwgb3IgMy4iKQogICAgICAgICAgICBleGNlcHQgKEVPRkVycm9yLCBLZXlib2FyZEludGVycnVwdCk6CiAgICAgICAgICAgICAgICBwcmludCgiXG4gIOKaoO+4jyAgVXNpbmcgZGVmYXVsdCBtZXRob2Q6IGNvbnN0YW50IikKICAgICAgICAgICAgICAgIGJhc2VsaW5lX21ldGhvZCA9ICdjb25zdGFudCcKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAKICAgICMgUHJvbXB0IGZvciBMT1dFU1MgZnJhYyAoaWYgTE9XRVNTIHNlbGVjdGVkKQogICAgaWYgYXJncy5iYXNlbGluZV9mcmFjIGlzIG5vdCBOb25lOgogICAgICAgIGJhc2VsaW5lX2ZyYWMgPSBhcmdzLmJhc2VsaW5lX2ZyYWMKICAgICAgICBpZiBiYXNlbGluZV9tZXRob2QgPT0gJ2xvd2Vzcyc6CiAgICAgICAgICAgIHByaW50KGYiTE9XRVNTIHNtb290aGluZyBmcmFjdGlvbjoge2Jhc2VsaW5lX2ZyYWN9IChmcm9tIGNvbW1hbmQtbGluZSkiKQogICAgZWxzZToKICAgICAgICBiYXNlbGluZV9mcmFjID0gMC41CiAgICAgICAgaWYgYmFzZWxpbmVfbWV0aG9kID09ICdsb3dlc3MnOgogICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGZyYWNfaW5wdXQgPSBpbnB1dCgiTE9XRVNTIHNtb290aGluZyBmcmFjdGlvbiAoMC4xLTEuMCkgW2RlZmF1bHQ6IDAuNV06ICIpLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgZnJhY19pbnB1dDoKICAgICAgICAgICAgICAgICAgICAgICAgYmFzZWxpbmVfZnJhYyA9IDAuNQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2VsaW5lX2ZyYWMgPSBmbG9hdChmcmFjX2lucHV0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiBiYXNlbGluZV9mcmFjIDwgMC4xIG9yIGJhc2VsaW5lX2ZyYWMgPiAxLjA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludCgiICDimqDvuI8gIFBsZWFzZSBlbnRlciBhIHZhbHVlIGJldHdlZW4gMC4xIGFuZCAxLjAuIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGV4Y2VwdCAoVmFsdWVFcnJvciwgRU9GRXJyb3IsIEtleWJvYXJkSW50ZXJydXB0KToKICAgICAgICAgICAgICAgICAgICBwcmludCgiXG4gIOKaoO+4jyAgVXNpbmcgZGVmYXVsdCB2YWx1ZTogMC41IikKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9mcmFjID0gMC41CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgIAogICAgIyBQcm9tcHQgZm9yIHBvbHlub21pYWwgb3JkZXIgKGlmIHBvbHlub21pYWwgc2VsZWN0ZWQpCiAgICBpZiBhcmdzLmJhc2VsaW5lX3BvbHlfb3JkZXIgaXMgbm90IE5vbmU6CiAgICAgICAgYmFzZWxpbmVfcG9seV9vcmRlciA9IGFyZ3MuYmFzZWxpbmVfcG9seV9vcmRlcgogICAgICAgIGlmIGJhc2VsaW5lX21ldGhvZCA9PSAncG9seW5vbWlhbCc6CiAgICAgICAgICAgIHByaW50KGYiUG9seW5vbWlhbCBvcmRlcjoge2Jhc2VsaW5lX3BvbHlfb3JkZXJ9IChmcm9tIGNvbW1hbmQtbGluZSkiKQogICAgZWxzZToKICAgICAgICBiYXNlbGluZV9wb2x5X29yZGVyID0gMQogICAgICAgIGlmIGJhc2VsaW5lX21ldGhvZCA9PSAncG9seW5vbWlhbCc6CiAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgb3JkZXJfaW5wdXQgPSBpbnB1dCgiUG9seW5vbWlhbCBvcmRlciAoMS01KSBbZGVmYXVsdDogMV06ICIpLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgb3JkZXJfaW5wdXQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2VsaW5lX3BvbHlfb3JkZXIgPSAxCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgYmFzZWxpbmVfcG9seV9vcmRlciA9IGludChvcmRlcl9pbnB1dCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYmFzZWxpbmVfcG9seV9vcmRlciA8IDEgb3IgYmFzZWxpbmVfcG9seV9vcmRlciA+IDU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludCgiICDimqDvuI8gIFBsZWFzZSBlbnRlciBhIHZhbHVlIGJldHdlZW4gMSBhbmQgNS4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgZXhjZXB0IChWYWx1ZUVycm9yLCBFT0ZFcnJvciwgS2V5Ym9hcmRJbnRlcnJ1cHQpOgogICAgICAgICAgICAgICAgICAgIHByaW50KCJcbiAg4pqg77iPICBVc2luZyBkZWZhdWx0IHZhbHVlOiAxIikKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9wb2x5X29yZGVyID0gMQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAKICAgICMgUHJvbXB0IGZvciBub3JtYWxpemF0aW9uIG1vZGUgKHVzZSBjb21tYW5kLWxpbmUgYXJnIGlmIHByb3ZpZGVkKQogICAgaWYgYXJncy5ub3JtYWxpemF0aW9uX21vZGUgaXMgbm90IE5vbmU6CiAgICAgICAgbm9ybWFsaXphdGlvbl9tb2RlID0gYXJncy5ub3JtYWxpemF0aW9uX21vZGUKICAgICAgICBwcmludChmIlxuTm9ybWFsaXphdGlvbiBtb2RlOiB7bm9ybWFsaXphdGlvbl9tb2RlfSAoZnJvbSBjb21tYW5kLWxpbmUpIikKICAgIGVsc2U6CiAgICAgICAgcHJpbnQoIlxuTm9ybWFsaXphdGlvbiAvIHByb2Nlc3NpbmcgbW9kZToiKQogICAgICAgIHByaW50KCIgIDEuIG11bHRpcGxpY2F0aXZlIC0gRih0KSAvIGcodCkgKGRlZmF1bHQpIikKICAgICAgICBwcmludCgiICAyLiBkZWx0YV9mX292ZXJfZiAtIChGKHQpIC0gZyh0KSkgLyBnKHQpIikKICAgICAgICBwcmludCgiICAzLiBsb3dlc3RfcG9pbnQgLSBGKHQpIC8gbWluKEZfYmFzZWxpbmVfcmFuZ2UpIikKICAgICAgICBwcmludCgiICA0LiBmaXJzdF9wb2ludCAtIEYodCkgLyBGX2ZpcnN0X2FmdGVyX2Jhc2VsaW5lX3JhbmdlIikKICAgICAgICBwcmludCgiICA1LiBub25lIC0gbm8gbm9ybWFsaXphdGlvbiAodXNlIHJhdyB2YWx1ZXMpIikKICAgICAgICBwcmludCgiICA2LiBiYXNlbGluZV9zdWJ0cmFjdF9sb3dlc3QgLSBzdWJ0cmFjdCBtaW4oYmFzZWxpbmUpIGZyb20gYWxsIHBvaW50cyAoU3RlcCAwIHN0eWxlKSIpCiAgICAgICAgcHJpbnQoIiAgNy4gYmFzZWxpbmVfc3VidHJhY3RfZmlyc3QgLSBzdWJ0cmFjdCBmaXJzdCBwb2ludCBhZnRlciBiYXNlbGluZSBmcm9tIGFsbCBwb2ludHMgKFN0ZXAgMCBzdHlsZSkiKQogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG5vcm1faW5wdXQgPSBpbnB1dCgiU2VsZWN0IG1vZGUgWzEtNywgZGVmYXVsdDogMV06ICIpLnN0cmlwKCkKICAgICAgICAgICAgICAgIGlmIG5vdCBub3JtX2lucHV0OgogICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6YXRpb25fbW9kZSA9ICdtdWx0aXBsaWNhdGl2ZScKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgZWxpZiBub3JtX2lucHV0ID09ICcxJzoKICAgICAgICAgICAgICAgICAgICBub3JtYWxpemF0aW9uX21vZGUgPSAnbXVsdGlwbGljYXRpdmUnCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsaWYgbm9ybV9pbnB1dCA9PSAnMic6CiAgICAgICAgICAgICAgICAgICAgbm9ybWFsaXphdGlvbl9tb2RlID0gJ2RlbHRhX2Zfb3Zlcl9mJwogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBlbGlmIG5vcm1faW5wdXQgPT0gJzMnOgogICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6YXRpb25fbW9kZSA9ICdsb3dlc3RfcG9pbnQnCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsaWYgbm9ybV9pbnB1dCA9PSAnNCc6CiAgICAgICAgICAgICAgICAgICAgbm9ybWFsaXphdGlvbl9tb2RlID0gJ2ZpcnN0X3BvaW50JwogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBlbGlmIG5vcm1faW5wdXQgPT0gJzUnOgogICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6YXRpb25fbW9kZSA9ICdub25lJwogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBlbGlmIG5vcm1faW5wdXQgPT0gJzYnOgogICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6YXRpb25fbW9kZSA9ICdiYXNlbGluZV9zdWJ0cmFjdF9sb3dlc3QnCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsaWYgbm9ybV9pbnB1dCA9PSAnNyc6CiAgICAgICAgICAgICAgICAgICAgbm9ybWFsaXphdGlvbl9tb2RlID0gJ2Jhc2VsaW5lX3N1YnRyYWN0X2ZpcnN0JwogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHByaW50KCIgIOKaoO+4jyAgUGxlYXNlIGVudGVyIDEsIDIsIDMsIDQsIDUsIDYsIG9yIDcuIikKICAgICAgICAgICAgZXhjZXB0IChFT0ZFcnJvciwgS2V5Ym9hcmRJbnRlcnJ1cHQpOgogICAgICAgICAgICAgICAgcHJpbnQoIlxuICDimqDvuI8gIFVzaW5nIGRlZmF1bHQgbW9kZTogbXVsdGlwbGljYXRpdmUiKQogICAgICAgICAgICAgICAgbm9ybWFsaXphdGlvbl9tb2RlID0gJ211bHRpcGxpY2F0aXZlJwogICAgICAgICAgICAgICAgYnJlYWsKICAgIAogICAgIyBPbmx5IHByaW50IHN1bW1hcnkgaWYgd2UgcHJvbXB0ZWQgKG5vdCBpZiBhbGwgc2V0dGluZ3MgY2FtZSBmcm9tIGNvbW1hbmQtbGluZSkKICAgIGlmIG5vdCBhbGwoW2FyZ3MuYmFzZWxpbmVfc3RhcnRfdGltZSBpcyBub3QgTm9uZSwgYXJncy5iYXNlbGluZV9lbmRfdGltZSBpcyBub3QgTm9uZSwgYXJncy5iYXNlbGluZV9tZXRob2QgaXMgbm90IE5vbmUsIAogICAgICAgICAgICAgICAgYXJncy5ub3JtYWxpemF0aW9uX21vZGUgaXMgbm90IE5vbmVdKToKICAgICAgICBwcmludCgiXG4iICsgIj0iICogNzApCiAgICAgICAgcHJpbnQoIlNFTEVDVEVEIFNFVFRJTkdTOiIpCiAgICAgICAgcHJpbnQoZiIgIEJhc2VsaW5lIHdpbmRvdzoge2Jhc2VsaW5lX3N0YXJ0X3RpbWV9IHMgdG8ge2Jhc2VsaW5lX2VuZF90aW1lfSBzIikKICAgICAgICBwcmludChmIiAgQmFzZWxpbmUgbWV0aG9kOiB7YmFzZWxpbmVfbWV0aG9kfSIpCiAgICAgICAgaWYgYmFzZWxpbmVfbWV0aG9kID09ICdsb3dlc3MnOgogICAgICAgICAgICBwcmludChmIiAgTE9XRVNTIHNtb290aGluZyBmcmFjdGlvbjoge2Jhc2VsaW5lX2ZyYWN9IikKICAgICAgICBlbGlmIGJhc2VsaW5lX21ldGhvZCA9PSAncG9seW5vbWlhbCc6CiAgICAgICAgICAgIHByaW50KGYiICBQb2x5bm9taWFsIG9yZGVyOiB7YmFzZWxpbmVfcG9seV9vcmRlcn0iKQogICAgICAgIHByaW50KGYiICBOb3JtYWxpemF0aW9uIG1vZGU6IHtub3JtYWxpemF0aW9uX21vZGV9IikKICAgICAgICBwcmludCgiPSIgKiA3MCArICJcbiIpCiAgICAKICAgIHJldHVybiBiYXNlbGluZV9zdGFydF90aW1lLCBiYXNlbGluZV9lbmRfdGltZSwgYmFzZWxpbmVfbWV0aG9kLCBiYXNlbGluZV9mcmFjLCBiYXNlbGluZV9wb2x5X29yZGVyLCBub3JtYWxpemF0aW9uX21vZGUKCgpkZWYgbWFpbigpOgogICAgIyBVc2UgdGhlIGRpcmVjdG9yeSB3aGVyZSB0aGlzIHNjcmlwdCBsaXZlcyBhcyB0aGUgd29ya2luZyBkaXJlY3RvcnkKICAgIHNjcmlwdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgIG9zLmNoZGlyKHNjcmlwdF9kaXIpCiAgICAKICAgICMgUHJvbXB0IGZvciBiYXNlbGluZSBhbmQgbm9ybWFsaXphdGlvbiBzZXR0aW5ncwogICAgYmFzZWxpbmVfc3RhcnRfdGltZSwgYmFzZWxpbmVfZW5kX3RpbWUsIGJhc2VsaW5lX21ldGhvZCwgYmFzZWxpbmVfZnJhYywgYmFzZWxpbmVfcG9seV9vcmRlciwgbm9ybWFsaXphdGlvbl9tb2RlID0gcHJvbXB0X2Jhc2VsaW5lX3NldHRpbmdzKCkKCiAgICAjIEZpbmQgRXhjZWwgZmlsZXMgaW4gdGhpcyBkaXJlY3RvcnkKICAgIGV4Y2VsX2ZpbGVzID0gWwogICAgICAgIGYgZm9yIGYgaW4gb3MubGlzdGRpcigiLiIpCiAgICAgICAgaWYgZi5sb3dlcigpLmVuZHN3aXRoKCIueGxzeCIpIGFuZCBub3QgZi5zdGFydHN3aXRoKCJ+JCIpCiAgICBdCgogICAgaWYgbm90IGV4Y2VsX2ZpbGVzOgogICAgICAgIHByaW50KCJObyAueGxzeCBmaWxlcyBmb3VuZCBpbiB0aGlzIGZvbGRlci4iLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAgICAgc3lzLmV4aXQoMSkKICAgIAogICAgIyBWYWxpZGF0ZSBmaWxlbmFtZSBmb3JtYXRzIGJlZm9yZSBwcm9jZXNzaW5nCiAgICBwcmludCgiU3RhcnRpbmcgcGxhdGUgdmlld2VyIHNjcmlwdC4uLiIsIGZsdXNoPVRydWUpCiAgICBwcmludCgiVmFsaWRhdGluZyBmaWxlbmFtZSBmb3JtYXRzLi4uIiwgZmx1c2g9VHJ1ZSkKICAgIGludmFsaWRfZmlsZXMgPSBbXQogICAgZm9yIGZuYW1lIGluIGV4Y2VsX2ZpbGVzOgogICAgICAgIHRyeToKICAgICAgICAgICAgdmFsaWRhdGVfZmlsZW5hbWVfZm9ybWF0KGZuYW1lKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yIGFzIGU6CiAgICAgICAgICAgIGludmFsaWRfZmlsZXMuYXBwZW5kKChmbmFtZSwgc3RyKGUpKSkKICAgIAogICAgaWYgaW52YWxpZF9maWxlczoKICAgICAgICBwcmludCgiXG7inYwgRVJST1I6IEludmFsaWQgZmlsZW5hbWUgZm9ybWF0KHMpIGRldGVjdGVkOiIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBmb3IgZm5hbWUsIGVycm9yX21zZyBpbiBpbnZhbGlkX2ZpbGVzOgogICAgICAgICAgICBwcmludChmIlxuRmlsZToge2ZuYW1lfSIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICAgICAgcHJpbnQoZXJyb3JfbXNnLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAgICAgcHJpbnQoIlxuUGxlYXNlIHJlbmFtZSB0aGUgZmlsZShzKSB0byBtYXRjaCB0aGUgZXhwZWN0ZWQgZm9ybWF0IGFuZCByZXJ1biB0aGUgc2NyaXB0LiIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBzeXMuZXhpdCgxKQogICAgCiAgICBwcmludChmIuKckyBBbGwge2xlbihleGNlbF9maWxlcyl9IGZpbGUocykgaGF2ZSB2YWxpZCBmaWxlbmFtZSBmb3JtYXRzIiwgZmx1c2g9VHJ1ZSkKCiAgICBhbGxfcGxhdGVzOiBEaWN0W3N0ciwgcGQuRGF0YUZyYW1lXSA9IHt9CiAgICBjc3Zfcm9vdCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAiY3N2IikKICAgIAogICAgIyBEZWxldGUgb2xkIENTViBmb2xkZXIgaWYgaXQgZXhpc3RzCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhjc3Zfcm9vdCk6CiAgICAgICAgcHJpbnQoZiJEZWxldGluZyBleGlzdGluZyBDU1YgZm9sZGVyOiB7Y3N2X3Jvb3R9IiwgZmx1c2g9VHJ1ZSkKICAgICAgICBzaHV0aWwucm10cmVlKGNzdl9yb290KQogICAgCiAgICAjIExvYWQgY29uZmlndXJhdGlvbiBmaWxlIGVhcmx5IHNvIGl0IGNhbiBiZSB1c2VkIGZvciBDU1YgZ2VuZXJhdGlvbgogICAgY29uZmlnX3BhdGggPSBvcy5wYXRoLmpvaW4oc2NyaXB0X2RpciwgInBsYXRlX2NvbmZpZy5qc29uIikKICAgIGNvbmZpZyA9IGxvYWRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgCiAgICAjIFRyYWNrIHBsYXRlX2lkcyBhbmQgdGhlaXIgc291cmNlIGZpbGVzIHRvIGRldGVjdCBkdXBsaWNhdGVzCiAgICBwbGF0ZV9pZF90b19maWxlczogRGljdFtzdHIsIExpc3Rbc3RyXV0gPSB7fQogICAgIyBUcmFjayBwbGF0ZV9pZCB0byBvcmlnaW5hbCBmaWxlbmFtZSBtYXBwaW5nCiAgICBwbGF0ZV9pZF90b19maWxlbmFtZTogRGljdFtzdHIsIHN0cl0gPSB7fQoKICAgIGZvciBpZHgsIGZuYW1lIGluIGVudW1lcmF0ZShleGNlbF9maWxlcywgMSk6CiAgICAgICAgcHJpbnQoZiJcblt7aWR4fS97bGVuKGV4Y2VsX2ZpbGVzKX1dIFByb2Nlc3Npbmcge2ZuYW1lfS4uLiIsIGZsdXNoPVRydWUpCiAgICAgICAgcGF0aCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCBmbmFtZSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvbmdfZGYgPSBwYXJzZV9wbGF0ZV9maWxlKHBhdGgpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkVycm9yIHBhcnNpbmcge2ZuYW1lfToge2V9IiwgZmlsZT1zeXMuc3RkZXJyLCBmbHVzaD1UcnVlKQogICAgICAgICAgICBjb250aW51ZQoKICAgICAgICBwbGF0ZV9pZCA9IGxvbmdfZGZbInBsYXRlX2lkIl0uaWxvY1swXQogICAgICAgIAogICAgICAgICMgVHJhY2sgd2hpY2ggZmlsZXMgcHJvZHVjZSB3aGljaCBwbGF0ZV9pZAogICAgICAgIGlmIHBsYXRlX2lkIG5vdCBpbiBwbGF0ZV9pZF90b19maWxlczoKICAgICAgICAgICAgcGxhdGVfaWRfdG9fZmlsZXNbcGxhdGVfaWRdID0gW10KICAgICAgICBwbGF0ZV9pZF90b19maWxlc1twbGF0ZV9pZF0uYXBwZW5kKGZuYW1lKQogICAgICAgIAogICAgICAgICMgVHJhY2sgZmlsZW5hbWUgZm9yIHRoaXMgcGxhdGVfaWQgKHVzZSBmaXJzdCBvY2N1cnJlbmNlKQogICAgICAgIGlmIHBsYXRlX2lkIG5vdCBpbiBwbGF0ZV9pZF90b19maWxlbmFtZToKICAgICAgICAgICAgcGxhdGVfaWRfdG9fZmlsZW5hbWVbcGxhdGVfaWRdID0gZm5hbWUKICAgICAgICAKICAgICAgICAjIElmIHRoaXMgcGxhdGVfaWQgYWxyZWFkeSBleGlzdHMsIG1ha2UgaXQgdW5pcXVlIGJ5IGFwcGVuZGluZyBmaWxlbmFtZQogICAgICAgIGlmIHBsYXRlX2lkIGluIGFsbF9wbGF0ZXM6CiAgICAgICAgICAgICMgVGhpcyBpcyBhIGR1cGxpY2F0ZSAtIHdlJ2xsIGhhbmRsZSBpdCBiZWxvdwogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYWxsX3BsYXRlc1twbGF0ZV9pZF0gPSBsb25nX2RmCiAgICAgICAgICAgIHdyaXRlX2NzdnNfZm9yX3BsYXRlKAogICAgICAgICAgICAgICAgbG9uZ19kZiwgCiAgICAgICAgICAgICAgICBjc3Zfcm9vdCwgCiAgICAgICAgICAgICAgICBjb25maWcsIAogICAgICAgICAgICAgICAgZm5hbWUsCiAgICAgICAgICAgICAgICBiYXNlbGluZV9zdGFydF90aW1lPWJhc2VsaW5lX3N0YXJ0X3RpbWUsCiAgICAgICAgICAgICAgICBiYXNlbGluZV9lbmRfdGltZT1iYXNlbGluZV9lbmRfdGltZSwKICAgICAgICAgICAgICAgIGJhc2VsaW5lX21ldGhvZD1iYXNlbGluZV9tZXRob2QsCiAgICAgICAgICAgICAgICBiYXNlbGluZV9mcmFjPWJhc2VsaW5lX2ZyYWMsCiAgICAgICAgICAgICAgICBiYXNlbGluZV9wb2x5X29yZGVyPWJhc2VsaW5lX3BvbHlfb3JkZXIsCiAgICAgICAgICAgICAgICBub3JtYWxpemF0aW9uX21vZGU9bm9ybWFsaXphdGlvbl9tb2RlCiAgICAgICAgICAgICkKCiAgICAjIENoZWNrIGZvciBkdXBsaWNhdGVzIGFuZCB3YXJuCiAgICBkdXBsaWNhdGVzX2ZvdW5kID0gRmFsc2UKICAgIGZvciBwbGF0ZV9pZCwgZmlsZXMgaW4gcGxhdGVfaWRfdG9fZmlsZXMuaXRlbXMoKToKICAgICAgICBpZiBsZW4oZmlsZXMpID4gMToKICAgICAgICAgICAgZHVwbGljYXRlc19mb3VuZCA9IFRydWUKICAgICAgICAgICAgcHJpbnQoZiJcbuKaoO+4jyAgV0FSTklORzogRHVwbGljYXRlIGRhdGFzZXQgZGV0ZWN0ZWQhIiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgICAgICBwcmludChmIiAgIFBsYXRlIElEICd7cGxhdGVfaWR9JyBpcyBwcm9kdWNlZCBieSBtdWx0aXBsZSBmaWxlczoiLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAgICAgICAgIGZvciBmIGluIGZpbGVzOgogICAgICAgICAgICAgICAgcHJpbnQoZiIgICAgIC0ge2Z9IiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgICAgICBwcmludChmIiAgIFBsZWFzZSBkZWxldGUgdGhlIGR1cGxpY2F0ZSBmaWxlKHMpIGFuZCByZXJ1biB0aGUgc2NyaXB0LiIsIGZpbGU9c3lzLnN0ZGVycikKICAgIAogICAgaWYgZHVwbGljYXRlc19mb3VuZDoKICAgICAgICBwcmludCgiXG7imqDvuI8gIEVSUk9SOiBEdXBsaWNhdGUgZGF0YXNldHMgZm91bmQuIFBsZWFzZSBkZWxldGUgZHVwbGljYXRlcyBhbmQgcmVydW4uIiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgIHByaW50KCIgICBPbmx5IHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGVhY2ggZHVwbGljYXRlIHdpbGwgYmUgaW5jbHVkZWQuIiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgIHN5cy5leGl0KDEpCgogICAgaWYgbm90IGFsbF9wbGF0ZXM6CiAgICAgICAgcHJpbnQoIk5vIHBsYXRlcyB3ZXJlIHN1Y2Nlc3NmdWxseSBwYXJzZWQuIiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgIHN5cy5leGl0KDEpCiAgICAKICAgIHByaW50KGYiXG7inJMgU3VjY2Vzc2Z1bGx5IGxvYWRlZCB7bGVuKGFsbF9wbGF0ZXMpfSBkYXRhc2V0KHMpOiIsIGZsdXNoPVRydWUpCiAgICBmb3IgcGxhdGVfaWQgaW4gc29ydGVkKGFsbF9wbGF0ZXMua2V5cygpKToKICAgICAgICBwcmludChmIiAgIC0ge3BsYXRlX2lkfSIsIGZsdXNoPVRydWUpCgogICAgIyBDb25maWcgYWxyZWFkeSBsb2FkZWQgYWJvdmUKCiAgICAjIEJ1aWxkIEpTT04gZm9yIHZpZXdlcgogICAgd2ViX2RpciA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAid2ViIikKICAgIGVuc3VyZV9kaXIod2ViX2RpcikKICAgIGpzb25fcGF0aCA9IG9zLnBhdGguam9pbih3ZWJfZGlyLCAidmlld2VyX2RhdGEuanNvbiIpCiAgICBidWlsZF92aWV3ZXJfanNvbihhbGxfcGxhdGVzLCBqc29uX3BhdGgsIGNvbmZpZywgcGxhdGVfaWRfdG9fZmlsZW5hbWUpCgogICAgIyBXcml0ZSBIVE1MCiAgICBodG1sX3BhdGggPSBvcy5wYXRoLmpvaW4od2ViX2RpciwgImluZGV4Lmh0bWwiKQogICAgd3JpdGVfaHRtbChodG1sX3BhdGgpCgogICAgIyBDcmVhdGUgZG91YmxlLWNsaWNrYWJsZSBsYXVuY2hlciBmaWxlcwogICAgd2ViX2NvbW1hbmRfcGF0aCwgd2ViX2JhdF9wYXRoID0gd3JpdGVfd2ViX2NvbW1hbmQoc2NyaXB0X2Rpciwgd2ViX2RpcikKCiAgICBwcmludCgiRG9uZS4iLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoIkdlbmVyYXRlZDoiLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoZiIgIENTVnMgaW46IHtjc3Zfcm9vdH0iLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoZiIgIFdlYiB2aWV3ZXI6IHtodG1sX3BhdGh9IiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KGYiICBXZWIgbGF1bmNoZXIgKG1hY09TL0xpbnV4KToge3dlYl9jb21tYW5kX3BhdGh9IiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KGYiICBXZWIgbGF1bmNoZXIgKFdpbmRvd3MpOiB7d2ViX2JhdF9wYXRofSIsIGZsdXNoPVRydWUpCiAgICBwcmludCgiXG5UbyB2aWV3IHRoZSBwbGF0ZXM6IiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KGYiICBtYWNPUy9MaW51eDogRG91YmxlLWNsaWNrICd3ZWIuY29tbWFuZCcgaW4gRmluZGVyLCBvciBydW46IC4vd2ViLmNvbW1hbmQiLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoZiIgIFdpbmRvd3M6IERvdWJsZS1jbGljayAnd2ViLmJhdCcgaW4gRXhwbG9yZXIiLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoIlRoZSBicm93c2VyIHdpbGwgb3BlbiBhdXRvbWF0aWNhbGx5LiIsIGZsdXNoPVRydWUpCgoKaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoKICAgIG1haW4oKQ=="
		
		-- Prompt user for baseline and normalization settings
		display dialog "Baseline and normalization settings for CSV generation. In the web viewer: Step 0 = baseline subtraction; Step 2 = group triplicates (requires Step 0 or Step 1)." with title "Plate Viewer" buttons {"OK"} default button "OK"
		set baselineStartTime to "0.0"
		set baselineEndTime to "24.0"
		set baselineMethod to "constant"
		set baselineFrac to "0.5"
		set baselinePolyOrder to "1"
		set normalizationMode to "multiplicative"
		
		-- Prompt for baseline window start time
		try
			set baselineStartTimeInput to text returned of (display dialog "Baseline window start time (seconds):" default answer baselineStartTime with title "Baseline Settings" buttons {"Cancel", "OK"} default button "OK")
			if baselineStartTimeInput is not "" then
				set baselineStartTime to baselineStartTimeInput
			end if
		on error
			-- User cancelled, use default
		end try
		
		-- Prompt for baseline window end time
		try
			set baselineEndTimeInput to text returned of (display dialog "Baseline window end time (seconds):" default answer baselineEndTime with title "Baseline Settings" buttons {"Cancel", "OK"} default button "OK")
			if baselineEndTimeInput is not "" then
				set baselineEndTime to baselineEndTimeInput
			end if
		on error
			-- User cancelled, use default
		end try
		
		-- Prompt for baseline method (used for normalization modes only; ignored for baseline_subtract_* or none)
		try
			set methodLabels to {"Constant (mean of baseline)", "LOWESS (smoothing)", "Polynomial"}
			set methodValues to {"constant", "lowess", "polynomial"}
			set defaultMethodLabel to "Constant (mean of baseline)"
			if baselineMethod is "lowess" then set defaultMethodLabel to "LOWESS (smoothing)"
			if baselineMethod is "polynomial" then set defaultMethodLabel to "Polynomial"
			set baselineMethodChoice to choose from list methodLabels with title "Baseline Fitting Method" with prompt "Select baseline fitting method (used when normalizing; ignored for baseline subtract or none):" default items {defaultMethodLabel} without multiple selections allowed and empty selection allowed
			if baselineMethodChoice is not false then
				set chosenMethodLabel to item 1 of baselineMethodChoice
				set methodIndex to 1
				repeat with lab in methodLabels
					if lab is chosenMethodLabel then
						set baselineMethod to item methodIndex of methodValues
						exit repeat
					end if
					set methodIndex to methodIndex + 1
				end repeat
			end if
		on error
			-- User cancelled, use default
		end try
		
		-- Prompt for LOWESS frac if LOWESS selected
		if baselineMethod is "lowess" then
			try
				set baselineFracInput to text returned of (display dialog "LOWESS smoothing fraction (0.1-1.0):" default answer baselineFrac with title "LOWESS Settings" buttons {"Cancel", "OK"} default button "OK")
				if baselineFracInput is not "" then
					set baselineFrac to baselineFracInput
				end if
			on error
				-- User cancelled, use default
			end try
		end if
		
		-- Prompt for polynomial order if polynomial selected
		if baselineMethod is "polynomial" then
			try
				set baselinePolyOrderInput to text returned of (display dialog "Polynomial order (1-5):" default answer baselinePolyOrder with title "Polynomial Settings" buttons {"Cancel", "OK"} default button "OK")
				if baselinePolyOrderInput is not "" then
					set baselinePolyOrder to baselinePolyOrderInput
				end if
			on error
				-- User cancelled, use default
			end try
		end if
		
		-- Prompt for normalization / processing mode (show descriptive labels, map to internal value)
		try
			set modeLabels to {"Multiplicative (F/g)", "F/F (delta F over F)", "Lowest point in baseline (F/min)", "First point after baseline (F/F_first)", "None (raw values)", "Baseline subtract: lowest point (Step 0)", "Baseline subtract: first point after baseline (Step 0)"}
			set modeValues to {"multiplicative", "delta_f_over_f", "lowest_point", "first_point", "none", "baseline_subtract_lowest", "baseline_subtract_first"}
			set defaultLabel to "Multiplicative (F/g)"
			if normalizationMode is "delta_f_over_f" then set defaultLabel to "F/F (delta F over F)"
			if normalizationMode is "lowest_point" then set defaultLabel to "Lowest point in baseline (F/min)"
			if normalizationMode is "first_point" then set defaultLabel to "First point after baseline (F/F_first)"
			if normalizationMode is "none" then set defaultLabel to "None (raw values)"
			if normalizationMode is "baseline_subtract_lowest" then set defaultLabel to "Baseline subtract: lowest point (Step 0)"
			if normalizationMode is "baseline_subtract_first" then set defaultLabel to "Baseline subtract: first point after baseline (Step 0)"
			set normalizationModeChoice to choose from list modeLabels with title "Normalization / Processing Mode" with prompt "Select how to process values for CSV generation:" default items {defaultLabel} without multiple selections allowed and empty selection allowed
			if normalizationModeChoice is not false then
				set chosenLabel to item 1 of normalizationModeChoice
				set labelIndex to 1
				repeat with lab in modeLabels
					if lab is chosenLabel then
						set normalizationMode to item labelIndex of modeValues
						exit repeat
					end if
					set labelIndex to labelIndex + 1
				end repeat
			end if
		on error
			-- User cancelled, use default
		end try
		
		-- Build command-line arguments (properly quoted)
		set pythonArgs to "--baseline-start-time " & quoted form of baselineStartTime & " --baseline-end-time " & quoted form of baselineEndTime & " --baseline-method " & quoted form of baselineMethod & " --normalization-mode " & quoted form of normalizationMode
		if baselineMethod is "lowess" then
			set pythonArgs to pythonArgs & " --baseline-frac " & quoted form of baselineFrac
		end if
		if baselineMethod is "polynomial" then
			set pythonArgs to pythonArgs & " --baseline-poly-order " & quoted form of baselinePolyOrder
		end if
		
		-- Decode and execute the Python code with command-line arguments
		do shell script "cd " & quoted form of folderPath & " && echo " & quoted form of pythonCodeBase64 & " | base64 -d | python3 - " & pythonArgs
		
		display notification "Plate viewer script completed successfully!" with title "Plate Viewer"
		
	on error errMsg
		display alert "Error" message errMsg
	end try
	
	return input
end run
