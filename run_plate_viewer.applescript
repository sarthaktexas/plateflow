-- AppleScript to run plate_viewer.py
-- The Python code is embedded directly in this script (base64 encoded)
-- Required packages will be installed automatically if needed

on run {input, parameters}
	try
		-- Get the selected folder from Finder or Automator
		if input is {} or input is missing value or (count of input) = 0 then
			set selectedFolder to choose folder with prompt "Select a folder containing .xlsx files:"
			if selectedFolder is {} then
				return
			end if
		else
			set selectedFolder to item 1 of input
		end if
		
		-- Get the folder path
		set folderPath to POSIX path of selectedFolder
		
		-- Remove trailing slash if present
		if folderPath ends with "/" then
			set folderPath to text 1 thru -2 of folderPath
		end if
		
		-- Install required Python packages if needed
		set requiredPackages to "pandas numpy scipy matplotlib openpyxl"
		
		-- Try installation with different methods (in order of preference)
		set installSuccess to false
		set lastError to ""
		
		-- Method 1: Try with --user flag (works on most systems, safest)
		try
			do shell script "python3 -m pip install --user " & requiredPackages & " 2>&1"
			set installSuccess to true
		on error installError1
			set lastError to installError1
			-- Method 2: Check Python version and try with --break-system-packages if supported
			try
				set pythonVersion to (do shell script "python3 --version 2>&1 | awk '{print $2}'")
				set pythonMajor to (do shell script "echo " & quoted form of pythonVersion & " | cut -d. -f1")
				set pythonMinor to (do shell script "echo " & quoted form of pythonVersion & " | cut -d. -f2")
				
				if (pythonMajor as integer) >= 3 and (pythonMinor as integer) >= 11 then
					-- Python 3.11+, try with --break-system-packages --user
					try
						do shell script "python3 -m pip install --break-system-packages --user " & requiredPackages & " 2>&1"
						set installSuccess to true
					on error installError2
						set lastError to installError2
						-- Try with --break-system-packages without --user
						try
							do shell script "python3 -m pip install --break-system-packages " & requiredPackages & " 2>&1"
							set installSuccess to true
						on error installError3
							set lastError to installError3
						end try
					end try
				end if
			on error
				-- Version check failed, continue to next method
			end try
			
			-- Method 3: If still not successful, try without any flags (may work if pip is configured)
			if not installSuccess then
				try
					do shell script "python3 -m pip install " & requiredPackages & " 2>&1"
					set installSuccess to true
				on error installError4
					set lastError to installError4
				end try
			end if
			
			-- If all methods failed, show warning but continue
			if not installSuccess then
				display alert "Warning" message "Could not install required packages automatically.\n\nLast error: " & lastError & "\n\nPlease install manually: " & requiredPackages & "\n\nRun: python3 -m pip install --user " & requiredPackages buttons {"Continue", "Cancel"} default button "Continue" as warning
				if button returned of result is "Cancel" then
					return
				end if
			end if
		end try
		
		-- Embedded Python code (base64 encoded)
		set pythonCodeBase64 to "IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwppbXBvcnQgb3MKaW1wb3J0IHN5cwppbXBvcnQganNvbgpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0CgppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCBudW1weSBhcyBucAoKIyAtLS0tLSBDT05GSUcgLS0tLS0KIyAzODQtd2VsbCBwbGF0ZTogMTYgcm93cyAoQS1QKSB4IDI0IGNvbHVtbnM7IGNoYW5nZSBpZiBuZWVkZWQuClBMQVRFX1JPV1MgPSAiQUJDREVGR0hJSktMTU5PUCIgICMgMTYgcm93cwpQTEFURV9DT0xTID0gMjQKClNIRUVUX05BTUVfUFJFRkVSUkVEID0gIlRhYmxlIEFsbCBEYXRhIHBvaW50cyIgICMgZnJvbSB5b3VyIGV4YW1wbGUKCiMgRGVmYXVsdCB3ZWxsIGxhYmVscyBhbmQgdHJpcGxpY2F0ZSBncm91cHMKREVGQVVMVF9XRUxMX0xBQkVMUyA9IHsKICAgICJCMTMiOiAiMjUwLTEwLTIiLAogICAgIkMxMyI6ICIyNTAtMTAtMiIsCiAgICAiRDEzIjogIjI1MC0xMC0yIiwKICAgICJFMTMiOiAiNTAwLTEwLTIiLAogICAgIkYxMyI6ICI1MDAtMTAtMiIsCiAgICAiRzEzIjogIjUwMC0xMC0yIiwKICAgICJIMTMiOiAiMjUwLTUtMiIsCiAgICAiSTEzIjogIjI1MC01LTIiLAogICAgIkoxMyI6ICIyNTAtNS0yIiwKICAgICJLMTMiOiAiNTAwLTUtMiIsCiAgICAiTDEzIjogIjUwMC01LTIiLAogICAgIk0xMyI6ICI1MDAtNS0yIiwKICAgICJOMTMiOiAiNTAwLTEwLTIiLAogICAgIk8xMyI6ICI1MDAtNS0yIgp9CgpERUZBVUxUX1RSSVBMSUNBVEVfR1JPVVBTID0gWwogICAgewogICAgICAgICJuYW1lIjogIjI1MC0xMC0yIiwKICAgICAgICAid2VsbHMiOiBbIkIiLCAiQyIsICJEIl0KICAgIH0sCiAgICB7CiAgICAgICAgIm5hbWUiOiAiNTAwLTEwLTIiLAogICAgICAgICJ3ZWxscyI6IFsiRSIsICJGIiwgIkciXQogICAgfSwKICAgIHsKICAgICAgICAibmFtZSI6ICIyNTAtNS0yIiwKICAgICAgICAid2VsbHMiOiBbIkgiLCAiSSIsICJKIl0KICAgIH0sCiAgICB7CiAgICAgICAgIm5hbWUiOiAiNTAwLTUtMiIsCiAgICAgICAgIndlbGxzIjogWyJLIiwgIkwiLCAiTSJdCiAgICB9Cl0KCiMgQ29sb3IgcGFsZXR0ZSBmb3IgdHJpcGxpY2F0ZSBncm91cHMgLSBtYXRjaGVzIHdlYiBpbnRlcmZhY2UKIyBFYWNoIGdyb3VwIGdldHMgYSBkaXN0aW5jdCBjb2xvciAodXNpbmcgYm9yZGVyIGNvbG9yIGZvciBwbG90cykKVFJJUExJQ0FURV9DT0xPUlMgPSBbCiAgICAiI2ZmNmI2YiIsICAjIFJlZAogICAgIiM0ZWNkYzQiLCAgIyBUZWFsCiAgICAiIzQ1YjdkMSIsICAjIEJsdWUKICAgICIjZjljYTI0IiwgICMgWWVsbG93CiAgICAiIzZjNWNlNyIsICAjIFB1cnBsZQogICAgIiNhMjliZmUiLCAgIyBMaWdodCBQdXJwbGUKICAgICIjZmQ3OWE4IiwgICMgUGluawogICAgIiMwMGI4OTQiLCAgIyBHcmVlbgogICAgIiNlMTcwNTUiLCAgIyBPcmFuZ2UKICAgICIjNzRiOWZmIiwgICMgTGlnaHQgQmx1ZQogICAgIiM1NWVmYzQiLCAgIyBNaW50CiAgICAiI2ZkY2I2ZSIgICAjIExpZ2h0IE9yYW5nZQpdCgpkZWYgaXNfY29udHJvbF93ZWxsKHdlbGxfaWQ6IHN0ciwgY29udHJvbF9yb3dzOiBMaXN0W3N0cl0gPSBOb25lKSAtPiBib29sOgogICAgIiIiCiAgICBDaGVjayBpZiBhIHdlbGwgaXMgYSBjb250cm9sIHdlbGwuCiAgICBEZWZhdWx0IGNvbnRyb2wgcm93cyBhcmUgTiBhbmQgTywgYnV0IHRoaXMgY2FuIGJlIGNvbmZpZ3VyZWQgdmlhIGNvbnRyb2xfcm93cyBwYXJhbWV0ZXIuCiAgICBDb250cm9sIHdlbGxzIHNob3VsZCBiZSBpbmRlcGVuZGVudGx5IHNlbGVjdGFibGUgYW5kIG5vdCBncm91cGVkIGFzIHRyaXBsaWNhdGVzLgogICAgIiIiCiAgICBpZiBub3Qgd2VsbF9pZDoKICAgICAgICByZXR1cm4gRmFsc2UKICAgIGlmIGNvbnRyb2xfcm93cyBpcyBOb25lOgogICAgICAgIGNvbnRyb2xfcm93cyA9IFsiTiIsICJPIl0gICMgRGVmYXVsdCBjb250cm9sIHJvd3MKICAgIHJvd19sZXR0ZXIgPSB3ZWxsX2lkWzBdIGlmIHdlbGxfaWRbMF0uaXNhbHBoYSgpIGVsc2UgIiIKICAgIHJldHVybiByb3dfbGV0dGVyIGluIGNvbnRyb2xfcm93cwoKCmRlZiB2YWxpZGF0ZV9maWxlbmFtZV9mb3JtYXQoZmlsZW5hbWU6IHN0cik6CiAgICAiIiIKICAgIFZhbGlkYXRlIHRoYXQgZmlsZW5hbWUgbWF0Y2hlcyB0aGUgZXhwZWN0ZWQgZm9ybWF0OgogICAgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJbX3NjaWVudGlzdF1bX251bWJlcl0ueGxzeAogICAgCiAgICBFeHBlY3RlZCBmb3JtYXQ6IEF0IGxlYXN0IDMgdW5kZXJzY29yZS1zZXBhcmF0ZWQgcGFydHMgYmVmb3JlIHRoZSAueGxzeCBleHRlbnNpb24uCiAgICBFeGFtcGxlczoKICAgIC0gUExDYl9XVF9DYV9NQy54bHN4ICg0IHBhcnRzKQogICAgLSBQTENiX1dUX0NhX01DXzEzLnhsc3ggKDUgcGFydHMpCiAgICAtIFBMQ2JfSDMzMkFfQ2FfU01fMTIueGxzeCAoNSBwYXJ0cykKICAgIAogICAgUmFpc2VzIFZhbHVlRXJyb3IgaWYgZm9ybWF0IGlzIGludmFsaWQuCiAgICAiIiIKICAgIGlmIG5vdCBmaWxlbmFtZS5sb3dlcigpLmVuZHN3aXRoKCcueGxzeCcpOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiSW52YWxpZCBmaWxlbmFtZSBmb3JtYXQ6ICd7ZmlsZW5hbWV9J1xuIgogICAgICAgICAgICBmIkV4cGVjdGVkIGZvcm1hdDogcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJbX3NjaWVudGlzdF1bX251bWJlcl0ueGxzeFxuIgogICAgICAgICAgICBmIkZpbGVuYW1lIG11c3QgZW5kIHdpdGggLnhsc3ggZXh0ZW5zaW9uLiIKICAgICAgICApCiAgICAKICAgICMgUmVtb3ZlIC54bHN4IGV4dGVuc2lvbgogICAgYmFzZV9uYW1lID0gb3MucGF0aC5zcGxpdGV4dChmaWxlbmFtZSlbMF0KICAgIAogICAgIyBTcGxpdCBieSB1bmRlcnNjb3JlCiAgICBwYXJ0cyA9IGJhc2VfbmFtZS5zcGxpdCgiXyIpCiAgICAKICAgIGlmIGxlbihwYXJ0cykgPCAzOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiSW52YWxpZCBmaWxlbmFtZSBmb3JtYXQ6ICd7ZmlsZW5hbWV9J1xuIgogICAgICAgICAgICBmIkV4cGVjdGVkIGZvcm1hdDogcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJbX3NjaWVudGlzdF1bX251bWJlcl0ueGxzeFxuIgogICAgICAgICAgICBmIlRoZSBmaWxlbmFtZSBtdXN0IGhhdmUgYXQgbGVhc3QgMyB1bmRlcnNjb3JlLXNlcGFyYXRlZCBwYXJ0cyBiZWZvcmUgdGhlIC54bHN4IGV4dGVuc2lvbi5cbiIKICAgICAgICAgICAgZiJGb3VuZCB7bGVuKHBhcnRzKX0gcGFydChzKToge3BhcnRzfVxuIgogICAgICAgICAgICBmIkV4YW1wbGUgdmFsaWQgZm9ybWF0czpcbiIKICAgICAgICAgICAgZiIgIC0gUExDYl9XVF9DYV9NQy54bHN4XG4iCiAgICAgICAgICAgIGYiICAtIFBMQ2JfV1RfQ2FfTUNfMTMueGxzeFxuIgogICAgICAgICAgICBmIiAgLSBQTENiX0gzMzJBX0NhX1NNXzEyLnhsc3giCiAgICAgICAgKQoKCmRlZiBwYXJzZV9jb2x1bW5fZ3JvdXBfZnJvbV9maWxlbmFtZShmaWxlbmFtZTogc3RyKSAtPiBEaWN0W3N0ciwgc3RyXToKICAgICIiIgogICAgUGFyc2UgY29sdW1uIGdyb3VwIGluZm9ybWF0aW9uIGZyb20gZmlsZW5hbWUgZm9ybWF0OgogICAgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXJfaW5pdGlhbHMtb2Ytc2NpZW50aXN0X2FyYml0cmFyeS1udW1iZXIueGxzeAogICAgCiAgICBSZXR1cm5zIGEgZGljdGlvbmFyeSB3aXRoOgogICAgLSAiY29sdW1uX2dyb3VwIjogInByb3RlaW5fZ2Vub3R5cGVfYnVmZmVyIiAodXNlZCBmb3IgZ3JvdXBpbmcpCiAgICAtICJwcm90ZWluIjogcHJvdGVpbiBuYW1lCiAgICAtICJnZW5vdHlwZSI6IGdlbm90eXBlCiAgICAtICJidWZmZXIiOiBidWZmZXIKICAgIC0gInNjaWVudGlzdCI6IGluaXRpYWxzLW9mLXNjaWVudGlzdAogICAgLSAibnVtYmVyIjogYXJiaXRyYXJ5LW51bWJlcgogICAgIiIiCiAgICAjIFZhbGlkYXRlIGZpbGVuYW1lIGZvcm1hdCBmaXJzdAogICAgdmFsaWRhdGVfZmlsZW5hbWVfZm9ybWF0KGZpbGVuYW1lKQogICAgCiAgICAjIFJlbW92ZSAueGxzeCBleHRlbnNpb24KICAgIGJhc2VfbmFtZSA9IG9zLnBhdGguc3BsaXRleHQoZmlsZW5hbWUpWzBdCiAgICAKICAgICMgU3BsaXQgYnkgdW5kZXJzY29yZQogICAgcGFydHMgPSBiYXNlX25hbWUuc3BsaXQoIl8iKQogICAgCiAgICAjIEF0IHRoaXMgcG9pbnQgd2Uga25vdyB3ZSBoYXZlIGF0IGxlYXN0IDMgcGFydHMgZHVlIHRvIHZhbGlkYXRpb24KICAgICMgSWYgd2UgaGF2ZSBhdCBsZWFzdCAzIHBhcnRzLCB1c2UgZmlyc3QgMyBmb3IgY29sdW1uX2dyb3VwIChwcm90ZWluX2dlbm90eXBlX2J1ZmZlcikKICAgICMgVGhpcyBoYW5kbGVzIGNhc2VzIGxpa2UgIlBMQ2JfV1RfRUdUQV9NQyIgKDQgcGFydHMpIG9yICJQTENiX1dUX0VHVEFfTUNfMTMiICg1IHBhcnRzKQogICAgcHJvdGVpbiA9IHBhcnRzWzBdCiAgICBnZW5vdHlwZSA9IHBhcnRzWzFdCiAgICBidWZmZXIgPSBwYXJ0c1syXQogICAgc2NpZW50aXN0ID0gcGFydHNbM10gaWYgbGVuKHBhcnRzKSA+IDMgZWxzZSAiIgogICAgbnVtYmVyID0gcGFydHNbNF0gaWYgbGVuKHBhcnRzKSA+IDQgZWxzZSAiIgogICAgCiAgICAjIENvbHVtbiBncm91cCBpcyBhbHdheXMgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXIgKGZpcnN0IDMgcGFydHMpCiAgICBjb2x1bW5fZ3JvdXAgPSBmIntwcm90ZWlufV97Z2Vub3R5cGV9X3tidWZmZXJ9IgogICAgCiAgICByZXR1cm4gewogICAgICAgICJjb2x1bW5fZ3JvdXAiOiBjb2x1bW5fZ3JvdXAsCiAgICAgICAgInByb3RlaW4iOiBwcm90ZWluLAogICAgICAgICJnZW5vdHlwZSI6IGdlbm90eXBlLAogICAgICAgICJidWZmZXIiOiBidWZmZXIsCiAgICAgICAgInNjaWVudGlzdCI6IHNjaWVudGlzdCwKICAgICAgICAibnVtYmVyIjogbnVtYmVyCiAgICB9CiAgICAKICAgICMgSWYgd2UgaGF2ZSBhdCBsZWFzdCAzIHBhcnRzLCB1c2UgZmlyc3QgMyBmb3IgY29sdW1uX2dyb3VwIChwcm90ZWluX2dlbm90eXBlX2J1ZmZlcikKICAgICMgVGhpcyBoYW5kbGVzIGNhc2VzIGxpa2UgIlBMQ2JfV1RfRUdUQV9NQyIgKDQgcGFydHMpIG9yICJQTENiX1dUX0VHVEFfTUNfMTMiICg1IHBhcnRzKQogICAgcHJvdGVpbiA9IHBhcnRzWzBdCiAgICBnZW5vdHlwZSA9IHBhcnRzWzFdCiAgICBidWZmZXIgPSBwYXJ0c1syXQogICAgc2NpZW50aXN0ID0gcGFydHNbM10gaWYgbGVuKHBhcnRzKSA+IDMgZWxzZSAiIgogICAgbnVtYmVyID0gcGFydHNbNF0gaWYgbGVuKHBhcnRzKSA+IDQgZWxzZSAiIgogICAgCiAgICAjIENvbHVtbiBncm91cCBpcyBhbHdheXMgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXIgKGZpcnN0IDMgcGFydHMpCiAgICBjb2x1bW5fZ3JvdXAgPSBmIntwcm90ZWlufV97Z2Vub3R5cGV9X3tidWZmZXJ9IgogICAgCiAgICByZXR1cm4gewogICAgICAgICJjb2x1bW5fZ3JvdXAiOiBjb2x1bW5fZ3JvdXAsCiAgICAgICAgInByb3RlaW4iOiBwcm90ZWluLAogICAgICAgICJnZW5vdHlwZSI6IGdlbm90eXBlLAogICAgICAgICJidWZmZXIiOiBidWZmZXIsCiAgICAgICAgInNjaWVudGlzdCI6IHNjaWVudGlzdCwKICAgICAgICAibnVtYmVyIjogbnVtYmVyCiAgICB9CiAgICAKCgpkZWYgZmluZF9oZWFkZXJfYW5kX3RpbWVfcm93cyhkZjogcGQuRGF0YUZyYW1lKSAtPiAoaW50LCBpbnQpOgogICAgIiIiCiAgICBGaW5kIHRoZSAnV2VsbCcgaGVhZGVyIHJvdyBhbmQgdGhlICdUaW1lIFtzXScgcm93LgogICAgUmV0dXJucyAoaGVhZGVyX3Jvd19pbmRleCwgdGltZV9yb3dfaW5kZXgpLgogICAgIiIiCiAgICBoZWFkZXJfcm93X2lkeCA9IE5vbmUKICAgIHRpbWVfcm93X2lkeCA9IE5vbmUKCiAgICBmb3IgaSBpbiByYW5nZShsZW4oZGYpKToKICAgICAgICBjZWxsMCA9IHN0cihkZi5pYXRbaSwgMF0pIGlmIG5vdCBwZC5pc25hKGRmLmlhdFtpLCAwXSkgZWxzZSAiIgogICAgICAgIGNlbGwxID0gc3RyKGRmLmlhdFtpLCAxXSkgaWYgbm90IHBkLmlzbmEoZGYuaWF0W2ksIDFdKSBlbHNlICIiCiAgICAgICAgaWYgY2VsbDAuc3RyaXAoKSA9PSAiV2VsbCI6CiAgICAgICAgICAgIGhlYWRlcl9yb3dfaWR4ID0gaQogICAgICAgIGlmICJUaW1lIiBpbiBjZWxsMSBhbmQgIltzXSIgaW4gY2VsbDE6CiAgICAgICAgICAgIHRpbWVfcm93X2lkeCA9IGkKCiAgICBpZiBoZWFkZXJfcm93X2lkeCBpcyBOb25lIG9yIHRpbWVfcm93X2lkeCBpcyBOb25lOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIkNvdWxkIG5vdCBmaW5kICdXZWxsJyBoZWFkZXIgcm93IG9yICdUaW1lIFtzXScgcm93IGluIEV4Y2VsIHNoZWV0LiIpCgogICAgaWYgdGltZV9yb3dfaWR4ICE9IGhlYWRlcl9yb3dfaWR4ICsgMToKICAgICAgICAjIE5vdCBmYXRhbCwgYnV0IHdhcm4gaW4gY2FzZSBmb3JtYXQgZHJpZnRzCiAgICAgICAgcHJpbnQoZiJXYXJuaW5nOiBUaW1lIHJvdyAoaW5kZXgge3RpbWVfcm93X2lkeH0pIGlzIG5vdCBkaXJlY3RseSBhZnRlciBoZWFkZXIgcm93IChpbmRleCB7aGVhZGVyX3Jvd19pZHh9KS4iLAogICAgICAgICAgICAgIGZpbGU9c3lzLnN0ZGVycikKCiAgICByZXR1cm4gaGVhZGVyX3Jvd19pZHgsIHRpbWVfcm93X2lkeAoKCmRlZiBwYXJzZV9wbGF0ZV9maWxlKHhsc3hfcGF0aDogc3RyKSAtPiBwZC5EYXRhRnJhbWU6CiAgICAiIiIKICAgIFBhcnNlIGEgc2luZ2xlIEV4Y2VsIGZpbGUgaW50byBhIGxvbmctZm9ybWF0IERhdGFGcmFtZSB3aXRoIGNvbHVtbnM6CiAgICBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgIiIiCiAgICBwcmludChmIlBhcnNpbmcge29zLnBhdGguYmFzZW5hbWUoeGxzeF9wYXRoKX0uLi4iLCBmbHVzaD1UcnVlKQogICAgdHJ5OgogICAgICAgIHByaW50KGYiICBPcGVuaW5nIEV4Y2VsIGZpbGUuLi4iLCBmbHVzaD1UcnVlKQogICAgICAgICMgRXhwbGljaXRseSB1c2Ugb3BlbnB5eGwgZW5naW5lIGZvciAueGxzeCBmaWxlcyB0byBhdm9pZCBoYW5naW5nCiAgICAgICAgeGxzID0gcGQuRXhjZWxGaWxlKHhsc3hfcGF0aCwgZW5naW5lPSdvcGVucHl4bCcpCiAgICAgICAgaWYgU0hFRVRfTkFNRV9QUkVGRVJSRUQgaW4geGxzLnNoZWV0X25hbWVzOgogICAgICAgICAgICBzaGVldF9uYW1lID0gU0hFRVRfTkFNRV9QUkVGRVJSRUQKICAgICAgICBlbHNlOgogICAgICAgICAgICBzaGVldF9uYW1lID0geGxzLnNoZWV0X25hbWVzWzBdCiAgICAgICAgICAgIHByaW50KGYiICBTaGVldCAne1NIRUVUX05BTUVfUFJFRkVSUkVEfScgbm90IGZvdW5kOyB1c2luZyBmaXJzdCBzaGVldCAne3NoZWV0X25hbWV9JyBpbnN0ZWFkLiIsIGZsdXNoPVRydWUpCiAgICAgICAgcHJpbnQoZiIgIFJlYWRpbmcgc2hlZXQgJ3tzaGVldF9uYW1lfScuLi4iLCBmbHVzaD1UcnVlKQogICAgICAgICMgVXNlIHRoZSBzYW1lIGVuZ2luZSBmb3IgcmVhZF9leGNlbAogICAgICAgIGRmID0gcGQucmVhZF9leGNlbCh4bHN4X3BhdGgsIHNoZWV0X25hbWU9c2hlZXRfbmFtZSwgaGVhZGVyPU5vbmUsIGVuZ2luZT0nb3BlbnB5eGwnKQogICAgICAgIHByaW50KGYiICBTaGVldCBsb2FkZWQ6IHtsZW4oZGYpfSByb3dzLCB7bGVuKGRmLmNvbHVtbnMpfSBjb2x1bW5zIiwgZmx1c2g9VHJ1ZSkKICAgICAgICAjIENsb3NlIHRoZSBFeGNlbEZpbGUgdG8gZnJlZSByZXNvdXJjZXMKICAgICAgICB4bHMuY2xvc2UoKQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIkZpbGUgbm90IGZvdW5kOiB7eGxzeF9wYXRofSIpCiAgICBleGNlcHQgUGVybWlzc2lvbkVycm9yOgogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIlBlcm1pc3Npb24gZGVuaWVkOiB7eGxzeF9wYXRofSAoZmlsZSBtYXkgYmUgb3BlbiBpbiBhbm90aGVyIHByb2dyYW0pIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBlcnJvcl90eXBlID0gdHlwZShlKS5fX25hbWVfXwogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIkZhaWxlZCB0byByZWFkIHt4bHN4X3BhdGh9OiB7ZXJyb3JfdHlwZX06IHtlfSIpCgogICAgcHJpbnQoZiIgIEZpbmRpbmcgaGVhZGVyIGFuZCB0aW1lIHJvd3MuLi4iLCBmbHVzaD1UcnVlKQogICAgaGVhZGVyX3Jvd19pZHgsIHRpbWVfcm93X2lkeCA9IGZpbmRfaGVhZGVyX2FuZF90aW1lX3Jvd3MoZGYpCgogICAgIyBUaW1lIHJvdzogY29sdW1uIDEgaXMgIlRpbWUgW3NdIiwgbWVhc3VyZW1lbnQgdGltZXMgc3RhcnQgZnJvbSBjb2x1bW4gMiBvbndhcmQuCiAgICB0aW1lX3JvdyA9IGRmLmlsb2NbdGltZV9yb3dfaWR4XQogICAgdGltZV92YWx1ZXMgPSB0aW1lX3Jvdy5pbG9jWzI6XS50b2xpc3QoKQogICAgIyBDbGVhbiB1cCB0aW1lcwogICAgdGltZV92YWx1ZXNfY2xlYW4gPSBbXQogICAgZm9yIHQgaW4gdGltZV92YWx1ZXM6CiAgICAgICAgaWYgcGQuaXNuYSh0KToKICAgICAgICAgICAgYnJlYWsKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRpbWVfdmFsdWVzX2NsZWFuLmFwcGVuZChmbG9hdCh0KSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAjIFN0b3AgYXQgdGhlIGZpcnN0IG5vbi1udW1lcmljIC8gd2VpcmQgdGhpbmcKICAgICAgICAgICAgYnJlYWsKCiAgICBudW1fdGltZV9wb2ludHMgPSBsZW4odGltZV92YWx1ZXNfY2xlYW4pCiAgICBpZiBudW1fdGltZV9wb2ludHMgPT0gMDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiTm8gdGltZXBvaW50cyBwYXJzZWQgaW4ge3hsc3hfcGF0aH0uIikKCiAgICBwbGF0ZV9pZCA9IG9zLnBhdGguc3BsaXRleHQob3MucGF0aC5iYXNlbmFtZSh4bHN4X3BhdGgpKVswXQoKICAgIHJlY29yZHM6IExpc3RbRGljdFtzdHIsIEFueV1dID0gW10KCiAgICAjIERhdGEgcm93czogZnJvbSB0aW1lX3Jvd19pZHggKyAxIGRvd253YXJkcyB1bnRpbCB3ZSBoaXQgZW1wdHkgIldlbGwiIGNlbGwKICAgIHByaW50KGYiICBQcm9jZXNzaW5nIGRhdGEgcm93cyAoc3RhcnRpbmcgZnJvbSByb3cge3RpbWVfcm93X2lkeCArIDF9KS4uLiIsIGZsdXNoPVRydWUpCiAgICByb3dzX3Byb2Nlc3NlZCA9IDAKICAgIGZvciBpIGluIHJhbmdlKHRpbWVfcm93X2lkeCArIDEsIGxlbihkZikpOgogICAgICAgIHdlbGwgPSBkZi5pYXRbaSwgMF0KICAgICAgICBjb250ZW50ID0gZGYuaWF0W2ksIDFdCgogICAgICAgIGlmIHBkLmlzbmEod2VsbCkgb3Igc3RyKHdlbGwpLnN0cmlwKCkgPT0gIiI6CiAgICAgICAgICAgICMgQXNzdW1lIHdlJ3ZlIHJlYWNoZWQgdGhlIGVuZCBvZiBkYXRhCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHdlbGxfaWQgPSBzdHIod2VsbCkuc3RyaXAoKQogICAgICAgIGNvbnRlbnRfc3RyID0gIiIgaWYgcGQuaXNuYShjb250ZW50KSBlbHNlIHN0cihjb250ZW50KS5zdHJpcCgpCgogICAgICAgIHJvd192YWxzID0gZGYuaWxvY1tpLCAyOjIgKyBudW1fdGltZV9wb2ludHNdLnRvbGlzdCgpCiAgICAgICAgIyBFbnN1cmUgc2FtZSBsZW5ndGggYXMgdGltZSBsaXN0CiAgICAgICAgcm93X3ZhbHMgPSByb3dfdmFsc1s6bnVtX3RpbWVfcG9pbnRzXQoKICAgICAgICBmb3IgdCwgdiBpbiB6aXAodGltZV92YWx1ZXNfY2xlYW4sIHJvd192YWxzKToKICAgICAgICAgICAgaWYgcGQuaXNuYSh2KToKICAgICAgICAgICAgICAgICMgU2tpcCBtaXNzaW5nIHZhbHVlcywgYnV0IGtlZXAgdGltZXBvaW50IGluIG92ZXJhbGwgc2NoZW1lCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB2X2Zsb2F0ID0gZmxvYXQodikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICByZWNvcmRzLmFwcGVuZCgKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAicGxhdGVfaWQiOiBwbGF0ZV9pZCwKICAgICAgICAgICAgICAgICAgICAid2VsbCI6IHdlbGxfaWQsCiAgICAgICAgICAgICAgICAgICAgImNvbnRlbnQiOiBjb250ZW50X3N0ciwKICAgICAgICAgICAgICAgICAgICAidGltZV9zIjogZmxvYXQodCksCiAgICAgICAgICAgICAgICAgICAgInZhbHVlIjogdl9mbG9hdCwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgIAogICAgICAgIHJvd3NfcHJvY2Vzc2VkICs9IDEKICAgICAgICBpZiByb3dzX3Byb2Nlc3NlZCAlIDEwMCA9PSAwOgogICAgICAgICAgICBwcmludChmIiAgICBQcm9jZXNzZWQge3Jvd3NfcHJvY2Vzc2VkfSByb3dzLi4uIiwgZmx1c2g9VHJ1ZSkKCiAgICBwcmludChmIiAgUHJvY2Vzc2VkIHtyb3dzX3Byb2Nlc3NlZH0gcm93cywgY3JlYXRlZCB7bGVuKHJlY29yZHMpfSBkYXRhIHBvaW50cyIsIGZsdXNoPVRydWUpCgogICAgaWYgbm90IHJlY29yZHM6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIk5vIGRhdGEgcm93cyBmb3VuZCBpbiB7eGxzeF9wYXRofSBhZnRlciBwYXJzaW5nLiIpCgogICAgcHJpbnQoZiIgIENyZWF0aW5nIERhdGFGcmFtZS4uLiIsIGZsdXNoPVRydWUpCiAgICBsb25nX2RmID0gcGQuRGF0YUZyYW1lLmZyb21fcmVjb3JkcyhyZWNvcmRzKQogICAgcHJpbnQoZiIgIOKckyBDb21wbGV0ZWQgcGFyc2luZyB7b3MucGF0aC5iYXNlbmFtZSh4bHN4X3BhdGgpfSIsIGZsdXNoPVRydWUpCiAgICByZXR1cm4gbG9uZ19kZgoKCmRlZiBlbnN1cmVfZGlyKHBhdGg6IHN0cik6CiAgICBvcy5tYWtlZGlycyhwYXRoLCBleGlzdF9vaz1UcnVlKQoKCmRlZiB3cml0ZV9jc3ZzX2Zvcl9wbGF0ZSgKICAgIGxvbmdfZGY6IHBkLkRhdGFGcmFtZSwgCiAgICBjc3Zfcm9vdDogc3RyLCAKICAgIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lLCAKICAgIGZpbGVuYW1lOiBzdHIgPSBOb25lLAogICAgYmFzZWxpbmVfZW5kX3RpbWU6IGZsb2F0ID0gMjAuMCwKICAgIGJhc2VsaW5lX21ldGhvZDogc3RyID0gJ2NvbnN0YW50JywKICAgIGJhc2VsaW5lX2ZyYWM6IGZsb2F0ID0gMC41LAogICAgYmFzZWxpbmVfcG9seV9vcmRlcjogaW50ID0gMSwKICAgIG5vcm1hbGl6YXRpb25fbW9kZTogc3RyID0gJ211bHRpcGxpY2F0aXZlJwopOgogICAgIiIiCiAgICBXcml0ZSBDU1YgZmlsZXM6CiAgICAgIC0gY3N2X3Jvb3QvPHBsYXRlX2lkPi88cGxhdGVfaWQ+Xzx3ZWxsPi5jc3YgKHBlciB3ZWxsLCBub3JtYWxpemVkIHZhbHVlcyB3aXRoIGJhc2VsaW5lKQogICAgICAtIGNzdl9yb290Lzxjb25kaXRpb24+Xzx0cmlwbGljYXRlX25hbWU+LmNzdiAocGVyIGNvbmRpdGlvbi10cmlwbGljYXRlIGNvbWJpbmF0aW9uLCB1c2luZyBub3JtYWxpemVkIHZhbHVlcyB3aXRoIG1lYW4gYW5kIFNFTSkKICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBsb25nX2RmIDogcGQuRGF0YUZyYW1lCiAgICAgICAgTG9uZy1mb3JtYXQgRGF0YUZyYW1lIHdpdGggY29sdW1ucyBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgY3N2X3Jvb3QgOiBzdHIKICAgICAgICBSb290IGRpcmVjdG9yeSBmb3IgQ1NWIG91dHB1dAogICAgY29uZmlnIDogRGljdFtzdHIsIEFueV0sIG9wdGlvbmFsCiAgICAgICAgQ29uZmlndXJhdGlvbiBkaWN0aW9uYXJ5CiAgICBmaWxlbmFtZSA6IHN0ciwgb3B0aW9uYWwKICAgICAgICBTb3VyY2UgZmlsZW5hbWUgZm9yIHBhcnNpbmcgY29sdW1uIGluZm8KICAgIGJhc2VsaW5lX2VuZF90aW1lIDogZmxvYXQKICAgICAgICBNYXhpbXVtIHRpbWUgKGluIHNlY29uZHMpIGZvciBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQ6IDI0LjApCiAgICBiYXNlbGluZV9tZXRob2QgOiBzdHIKICAgICAgICBCYXNlbGluZSBmaXR0aW5nIG1ldGhvZDogJ2xvd2VzcycsICdjb25zdGFudCcsIG9yICdwb2x5bm9taWFsJyAoZGVmYXVsdDogJ2NvbnN0YW50JykKICAgIGJhc2VsaW5lX2ZyYWMgOiBmbG9hdAogICAgICAgIEZyYWN0aW9uIG9mIGRhdGEgdXNlZCBmb3IgTE9XRVNTIHNtb290aGluZyAoZGVmYXVsdDogMC41KQogICAgYmFzZWxpbmVfcG9seV9vcmRlciA6IGludAogICAgICAgIFBvbHlub21pYWwgb3JkZXIgZm9yIHBvbHlub21pYWwgZml0IChkZWZhdWx0OiAxKQogICAgbm9ybWFsaXphdGlvbl9tb2RlIDogc3RyCiAgICAgICAgTm9ybWFsaXphdGlvbiBtb2RlOiAnZGVsdGFfZl9vdmVyX2YnIG9yICdtdWx0aXBsaWNhdGl2ZScgKGRlZmF1bHQ6ICdtdWx0aXBsaWNhdGl2ZScpCiAgICAiIiIKICAgIHBsYXRlX2lkID0gbG9uZ19kZlsicGxhdGVfaWQiXS5pbG9jWzBdCiAgICBwcmludChmIiAgV3JpdGluZyBDU1ZzIGZvciB7cGxhdGVfaWR9Li4uIiwgZmx1c2g9VHJ1ZSkKCiAgICAjIExvYWQgY29uZmlnIGlmIG5vdCBwcm92aWRlZAogICAgaWYgY29uZmlnIGlzIE5vbmU6CiAgICAgICAgc2NyaXB0X2RpciA9IG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmFic3BhdGgoX19maWxlX18pKQogICAgICAgIGNvbmZpZ19wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJwbGF0ZV9jb25maWcuanNvbiIpCiAgICAgICAgY29uZmlnID0gbG9hZF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAKICAgICMgRmlsdGVyIG91dCBiYWQgd2VsbHMgYmVmb3JlIHByb2Nlc3NpbmcKICAgIGJhZF93ZWxsc19saXN0ID0gY29uZmlnLmdldCgiYmFkX3dlbGxzIiwgW10pCiAgICBpZiBiYWRfd2VsbHNfbGlzdDoKICAgICAgICBvcmlnaW5hbF9jb3VudCA9IGxlbihsb25nX2RmKQogICAgICAgIGxvbmdfZGYgPSBsb25nX2RmW35sb25nX2RmWyJ3ZWxsIl0uYXBwbHkobGFtYmRhIHc6IGlzX2JhZF93ZWxsKHcsIGNvbmZpZykpXQogICAgICAgIGZpbHRlcmVkX2NvdW50ID0gbGVuKGxvbmdfZGYpCiAgICAgICAgaWYgb3JpZ2luYWxfY291bnQgIT0gZmlsdGVyZWRfY291bnQ6CiAgICAgICAgICAgIHByaW50KGYiICAgIEV4Y2x1ZGluZyB7b3JpZ2luYWxfY291bnQgLSBmaWx0ZXJlZF9jb3VudH0gZGF0YSBwb2ludHMgZnJvbSBiYWQgd2VsbHMiLCBmbHVzaD1UcnVlKQogICAgCiAgICAjIE5vcm1hbGl6ZSBkYXRhIHdpdGggYmFzZWxpbmUgYmVmb3JlIHdyaXRpbmcgQ1NWcwogICAgcHJpbnQoZiIgICAgTm9ybWFsaXppbmcgZGF0YSB3aXRoIGJhc2VsaW5lIChtZXRob2Q9e2Jhc2VsaW5lX21ldGhvZH0sIG1vZGU9e25vcm1hbGl6YXRpb25fbW9kZX0pLi4uIiwgZmx1c2g9VHJ1ZSkKICAgIGJhc2VsaW5lX2ZpdHMgPSBmaXRfd2VsbF9iYXNlbGluZXMoCiAgICAgICAgbG9uZ19kZiwKICAgICAgICBiYXNlbGluZV9lbmRfdGltZT1iYXNlbGluZV9lbmRfdGltZSwKICAgICAgICBtZXRob2Q9YmFzZWxpbmVfbWV0aG9kLAogICAgICAgIGZyYWM9YmFzZWxpbmVfZnJhYywKICAgICAgICBwb2x5X29yZGVyPWJhc2VsaW5lX3BvbHlfb3JkZXIsCiAgICAgICAgY29uZmlnPWNvbmZpZwogICAgKQogICAgbm9ybV9kZiA9IG5vcm1hbGl6ZV93ZWxscyhsb25nX2RmLCBiYXNlbGluZV9maXRzLCBub3JtYWxpemF0aW9uX21vZGU9bm9ybWFsaXphdGlvbl9tb2RlKQogICAgIyBBZGQgbm9ybWFsaXplZCB3ZWxsIElEIGNvbHVtbiBmb3IgY29uc2lzdGVudCBtYXRjaGluZwogICAgbm9ybV9kZiA9IG5vcm1fZGYuY29weSgpCiAgICBub3JtX2RmWyJ3ZWxsX25vcm1hbGl6ZWQiXSA9IG5vcm1fZGZbIndlbGwiXS5hcHBseShsYW1iZGEgdzogbm9ybWFsaXplX3dlbGxfaWQoc3RyKHcpLnN0cmlwKCkpKQogICAgcHJpbnQoZiIgICAg4pyTIE5vcm1hbGl6ZWQge2xlbihub3JtX2RmKX0gZGF0YSBwb2ludHMiLCBmbHVzaD1UcnVlKQogICAgCiAgICAjIFBhcnNlIGNvbHVtbiBpbmZvIGZyb20gZmlsZW5hbWUgaWYgcHJvdmlkZWQKICAgIGNvbHVtbl9pbmZvID0gTm9uZQogICAgaWYgZmlsZW5hbWU6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb2x1bW5faW5mbyA9IHBhcnNlX2NvbHVtbl9ncm91cF9mcm9tX2ZpbGVuYW1lKGZpbGVuYW1lKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgIAogICAgIyBHZXQgdHJpcGxpY2F0ZSBncm91cHMgZnJvbSBjb25maWcKICAgIHRyaXBsaWNhdGVfZ3JvdXBzID0gY29uZmlnLmdldCgidHJpcGxpY2F0ZV9ncm91cHMiLCBERUZBVUxUX1RSSVBMSUNBVEVfR1JPVVBTKQogICAgY29udHJvbF9yb3dzID0gY29uZmlnLmdldCgiY29udHJvbF9yb3dzIiwgWyJOIiwgIk8iXSkKICAgIAogICAgIyBCdWlsZCBtYXBwaW5nOiB3ZWxsX2lkIC0+IHRyaXBsaWNhdGUgZ3JvdXAgbmFtZQogICAgIyBVc2Ugbm9ybWFsaXplZCB3ZWxsIElEcyBmb3IgY29uc2lzdGVudCBtYXRjaGluZwogICAgd2VsbF90b19ncm91cCA9IHt9CiAgICBmb3IgZ3JvdXAgaW4gdHJpcGxpY2F0ZV9ncm91cHM6CiAgICAgICAgZ3JvdXBfbmFtZSA9IGdyb3VwLmdldCgibmFtZSIsICIiKQogICAgICAgIGdyb3VwX3dlbGxzID0gZ3JvdXAuZ2V0KCJ3ZWxscyIsIFtdKQogICAgICAgIGZvciB3ZWxsX3BhdHRlcm4gaW4gZ3JvdXBfd2VsbHM6CiAgICAgICAgICAgICMgRXh0cmFjdCByb3cgbGV0dGVyIGZyb20gd2VsbCBwYXR0ZXJuIChlLmcuLCAiQiIgZnJvbSAiQiIgb3IgIkIxMyIpCiAgICAgICAgICAgIHJvd19sZXR0ZXIgPSB3ZWxsX3BhdHRlcm5bMF0gaWYgd2VsbF9wYXR0ZXJuIGFuZCB3ZWxsX3BhdHRlcm5bMF0uaXNhbHBoYSgpIGVsc2UgIiIKICAgICAgICAgICAgaWYgcm93X2xldHRlcjoKICAgICAgICAgICAgICAgICMgRmluZCBhbGwgd2VsbHMgaW4gdGhpcyByb3cgYWNyb3NzIGFsbCBjb2x1bW5zCiAgICAgICAgICAgICAgICAjIFVzZSB3ZWxsX25vcm1hbGl6ZWQgY29sdW1uIGZvciBjb25zaXN0ZW50IG1hdGNoaW5nCiAgICAgICAgICAgICAgICBmb3Igbm9ybWFsaXplZF93ZWxsX2lkIGluIG5vcm1fZGZbIndlbGxfbm9ybWFsaXplZCJdLnVuaXF1ZSgpOgogICAgICAgICAgICAgICAgICAgIGlmIG5vcm1hbGl6ZWRfd2VsbF9pZDoKICAgICAgICAgICAgICAgICAgICAgICAgIyBDaGVjayBpZiBub3JtYWxpemVkIHdlbGwgSUQgc3RhcnRzIHdpdGggdGhlIHJvdyBsZXR0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm9ybWFsaXplZF93ZWxsX2lkIGFuZCBub3JtYWxpemVkX3dlbGxfaWRbMF0gPT0gcm93X2xldHRlcjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgU3RvcmUgbWFwcGluZyB1c2luZyBub3JtYWxpemVkIHdlbGwgSUQgKGNvbnNpc3RlbnQgZm9ybWF0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2VsbF90b19ncm91cFtub3JtYWxpemVkX3dlbGxfaWRdID0gZ3JvdXBfbmFtZQogICAgCiAgICAjIFBlci13ZWxsIENTVnMgKG5vcm1hbGl6ZWQgdmFsdWVzIHdpdGggYmFzZWxpbmUsIHdpdGhvdXQgU0VNIC0gU0VNIG9ubHkgYmVsb25ncyBpbiB0cmlwbGljYXRlIENTVnMpCiAgICBwbGF0ZV9mb2xkZXIgPSBvcy5wYXRoLmpvaW4oY3N2X3Jvb3QsIHBsYXRlX2lkKQogICAgZW5zdXJlX2RpcihwbGF0ZV9mb2xkZXIpCiAgICAKICAgIHdlbGxzID0gbm9ybV9kZi5ncm91cGJ5KCJ3ZWxsIikKICAgIHByaW50KGYiICAgIFdyaXRpbmcge2xlbih3ZWxscyl9IHBlci13ZWxsIENTVnMgKG5vcm1hbGl6ZWQgdmFsdWVzKS4uLiIsIGZsdXNoPVRydWUpCiAgICAKICAgICMgV3JpdGUgcGVyLXdlbGwgQ1NWcyB3aXRoIG5vcm1hbGl6ZWQgdmFsdWVzCiAgICBmb3IgaWR4LCAod2VsbF9pZCwgZykgaW4gZW51bWVyYXRlKHdlbGxzLCAxKToKICAgICAgICAjIE5vcm1hbGl6ZSB3ZWxsIElEIGZvciBjb25zaXN0ZW50IGZpbGUgbmFtaW5nCiAgICAgICAgbm9ybWFsaXplZF93ZWxsX2lkID0gbm9ybWFsaXplX3dlbGxfaWQoc3RyKHdlbGxfaWQpLnN0cmlwKCkpCiAgICAgICAgc2FmZV93ZWxsID0gbm9ybWFsaXplZF93ZWxsX2lkLnJlcGxhY2UoIiAiLCAiIikucmVwbGFjZSgiOiIsICItIikKICAgICAgICBvdXRfcGF0aCA9IG9zLnBhdGguam9pbihwbGF0ZV9mb2xkZXIsIGYie3BsYXRlX2lkfV97c2FmZV93ZWxsfS5jc3YiKQogICAgICAgIGdfc29ydGVkID0gZy5zb3J0X3ZhbHVlcygidGltZV9zIikKICAgICAgICAKICAgICAgICAjIENyZWF0ZSBvdXRwdXQgRGF0YUZyYW1lIHdpdGggdGltZSBhbmQgbm9ybWFsaXplZCB2YWx1ZSBvbmx5IChubyBTRU0pCiAgICAgICAgb3V0cHV0X2RmID0gcGQuRGF0YUZyYW1lKHsKICAgICAgICAgICAgInRpbWVfcyI6IGdfc29ydGVkWyJ0aW1lX3MiXS52YWx1ZXMsCiAgICAgICAgICAgICJ2YWx1ZSI6IGdfc29ydGVkWyJ2YWx1ZSJdLnZhbHVlcyAgIyBUaGlzIGlzIG5vdyBub3JtYWxpemVkCiAgICAgICAgfSkKICAgICAgICBvdXRwdXRfZGYudG9fY3N2KG91dF9wYXRoLCBpbmRleD1GYWxzZSkKICAgICAgICAKICAgICAgICBpZiBpZHggJSA1ID09IDA6CiAgICAgICAgICAgIHByaW50KGYiICAgICAgV3JpdHRlbiB7aWR4fS97bGVuKHdlbGxzKX0gd2VsbHMuLi4iLCBmbHVzaD1UcnVlKQogICAgCiAgICAjIFdyaXRlIGNvbmRpdGlvbi1zcGVjaWZpYyBDU1ZzIChnZW5vdHlwZS1idWZmZXItdHJpcGxpY2F0ZSkKICAgICMgT25lIENTViBwZXIgY29uZGl0aW9uLXRyaXBsaWNhdGUtY29sdW1uIGNvbWJpbmF0aW9uCiAgICAjIFVzaW5nIG5vcm1hbGl6ZWQgdmFsdWVzIGZyb20gbm9ybV9kZgogICAgaWYgY29sdW1uX2luZm86CiAgICAgICAgcHJpbnQoZiIgICAgV3JpdGluZyBjb25kaXRpb24tc3BlY2lmaWMgQ1NWcyAodXNpbmcgbm9ybWFsaXplZCB2YWx1ZXMpLi4uIiwgZmx1c2g9VHJ1ZSkKICAgICAgICBnZW5vdHlwZSA9IGNvbHVtbl9pbmZvLmdldCgiZ2Vub3R5cGUiLCAiIikKICAgICAgICBidWZmZXIgPSBjb2x1bW5faW5mby5nZXQoImJ1ZmZlciIsICIiKQogICAgICAgIAogICAgICAgICMgR3JvdXAgYnkgdHJpcGxpY2F0ZSBncm91cCBuYW1lIGFuZCBjb2x1bW4KICAgICAgICBmb3IgZ3JvdXAgaW4gdHJpcGxpY2F0ZV9ncm91cHM6CiAgICAgICAgICAgIGdyb3VwX25hbWUgPSBncm91cC5nZXQoIm5hbWUiLCAiIikKICAgICAgICAgICAgaWYgbm90IGdyb3VwX25hbWU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBHZXQgYWxsIHdlbGxzIGluIHRoaXMgdHJpcGxpY2F0ZSBncm91cCAoYWNyb3NzIGFsbCBjb2x1bW5zKQogICAgICAgICAgICAjIFVzZSBub3JtYWxpemVkIHdlbGwgSURzIGZvciBjb25zaXN0ZW50IG1hdGNoaW5nCiAgICAgICAgICAgIGdyb3VwX3dlbGxzID0gW10KICAgICAgICAgICAgZm9yIG5vcm1hbGl6ZWRfd2VsbF9pZCBpbiBub3JtX2RmWyJ3ZWxsX25vcm1hbGl6ZWQiXS51bmlxdWUoKToKICAgICAgICAgICAgICAgICMgQ2hlY2sgdXNpbmcgbm9ybWFsaXplZCB3ZWxsIElECiAgICAgICAgICAgICAgICBpZiBub3JtYWxpemVkX3dlbGxfaWQgaW4gd2VsbF90b19ncm91cCBhbmQgd2VsbF90b19ncm91cFtub3JtYWxpemVkX3dlbGxfaWRdID09IGdyb3VwX25hbWU6CiAgICAgICAgICAgICAgICAgICAgIyBTdG9yZSBub3JtYWxpemVkIHdlbGwgSUQgZm9yIGNvbnNpc3RlbmN5CiAgICAgICAgICAgICAgICAgICAgZ3JvdXBfd2VsbHMuYXBwZW5kKG5vcm1hbGl6ZWRfd2VsbF9pZCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBncm91cF93ZWxsczoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdyb3VwIHdlbGxzIGJ5IGNvbHVtbiBudW1iZXIKICAgICAgICAgICAgIyBOb3RlOiBncm91cF93ZWxscyBub3cgY29udGFpbnMgbm9ybWFsaXplZCB3ZWxsIElEcwogICAgICAgICAgICB3ZWxsc19ieV9jb2x1bW4gPSB7fQogICAgICAgICAgICBmb3Igbm9ybWFsaXplZF93ZWxsX2lkIGluIGdyb3VwX3dlbGxzOgogICAgICAgICAgICAgICAgIyBFeHRyYWN0IGNvbHVtbiBudW1iZXIgZnJvbSBub3JtYWxpemVkIHdlbGwgSUQgKGUuZy4sICJCMTMiIC0+IDEzLCAiQjA1IiAtPiA1KQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGNvbHVtbl9udW0gPSBpbnQoJycuam9pbihmaWx0ZXIoc3RyLmlzZGlnaXQsIHN0cihub3JtYWxpemVkX3dlbGxfaWQpKSkpCiAgICAgICAgICAgICAgICAgICAgaWYgY29sdW1uX251bSBub3QgaW4gd2VsbHNfYnlfY29sdW1uOgogICAgICAgICAgICAgICAgICAgICAgICB3ZWxsc19ieV9jb2x1bW5bY29sdW1uX251bV0gPSBbXQogICAgICAgICAgICAgICAgICAgIHdlbGxzX2J5X2NvbHVtbltjb2x1bW5fbnVtXS5hcHBlbmQobm9ybWFsaXplZF93ZWxsX2lkKQogICAgICAgICAgICAgICAgZXhjZXB0IChWYWx1ZUVycm9yLCBBdHRyaWJ1dGVFcnJvcik6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ3JlYXRlIG9uZSBDU1YgcGVyIGNvbHVtbiBmb3IgdGhpcyB0cmlwbGljYXRlIGdyb3VwCiAgICAgICAgICAgIGZvciBjb2x1bW5fbnVtIGluIHNvcnRlZCh3ZWxsc19ieV9jb2x1bW4ua2V5cygpKToKICAgICAgICAgICAgICAgIGNvbHVtbl93ZWxscyA9IHdlbGxzX2J5X2NvbHVtbltjb2x1bW5fbnVtXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEdldCBhbGwgdGltZSBwb2ludHMgZm9yIHRoaXMgY29sdW1uJ3Mgd2VsbHMgKHVzaW5nIG5vcm1hbGl6ZWQgZGF0YSkKICAgICAgICAgICAgICAgICMgY29sdW1uX3dlbGxzIGNvbnRhaW5zIG5vcm1hbGl6ZWQgd2VsbCBJRHMsIHVzZSB3ZWxsX25vcm1hbGl6ZWQgY29sdW1uIGZvciBtYXRjaGluZwogICAgICAgICAgICAgICAgIyBGaWx0ZXIgb3V0IGJhZCB3ZWxscyBmcm9tIGNvbHVtbl93ZWxscwogICAgICAgICAgICAgICAgY29sdW1uX3dlbGxzX2ZpbHRlcmVkID0gW3cgZm9yIHcgaW4gY29sdW1uX3dlbGxzIGlmIG5vdCBpc19iYWRfd2VsbCh3LCBjb25maWcpXQogICAgICAgICAgICAgICAgaWYgbm90IGNvbHVtbl93ZWxsc19maWx0ZXJlZDoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZSAgIyBTa2lwIHRoaXMgY29sdW1uIGlmIGFsbCB3ZWxscyBhcmUgYmFkCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGFsbF90aW1lcyA9IHNvcnRlZChub3JtX2RmW25vcm1fZGZbIndlbGxfbm9ybWFsaXplZCJdLmlzaW4oY29sdW1uX3dlbGxzX2ZpbHRlcmVkKV1bInRpbWVfcyJdLnVuaXF1ZSgpKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENhbGN1bGF0ZSBtZWFuIGFuZCBTRU0gZm9yIGVhY2ggdGltZSBwb2ludCBhY3Jvc3Mgd2VsbHMgaW4gdGhpcyB0cmlwbGljYXRlIGdyb3VwIGZvciB0aGlzIGNvbHVtbgogICAgICAgICAgICAgICAgIyBVc2luZyBub3JtYWxpemVkIHZhbHVlcwogICAgICAgICAgICAgICAgbWVhbl92YWx1ZXMgPSBbXQogICAgICAgICAgICAgICAgc2VtX3ZhbHVlcyA9IFtdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciB0aW1lIGluIGFsbF90aW1lczoKICAgICAgICAgICAgICAgICAgICB2YWx1ZXNfYXRfdGltZSA9IFtdCiAgICAgICAgICAgICAgICAgICAgZm9yIG5vcm1hbGl6ZWRfd2VsbF9pZCBpbiBjb2x1bW5fd2VsbHNfZmlsdGVyZWQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHdlbGxfZGF0YSA9IG5vcm1fZGZbKG5vcm1fZGZbIndlbGxfbm9ybWFsaXplZCJdID09IG5vcm1hbGl6ZWRfd2VsbF9pZCkgJiAobm9ybV9kZlsidGltZV9zIl0gPT0gdGltZSldCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCB3ZWxsX2RhdGEuZW1wdHk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXNfYXRfdGltZS5hcHBlbmQod2VsbF9kYXRhWyJ2YWx1ZSJdLmlsb2NbMF0pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHZhbHVlc19hdF90aW1lKSA+PSAyOgogICAgICAgICAgICAgICAgICAgICAgICBtZWFuID0gc3VtKHZhbHVlc19hdF90aW1lKSAvIGxlbih2YWx1ZXNfYXRfdGltZSkKICAgICAgICAgICAgICAgICAgICAgICAgdmFyaWFuY2UgPSBzdW0oKHYgLSBtZWFuKSAqKiAyIGZvciB2IGluIHZhbHVlc19hdF90aW1lKSAvIChsZW4odmFsdWVzX2F0X3RpbWUpIC0gMSkgIyBTYW1wbGUgdmFyaWFuY2UgdXNpbmcgQmVzc2VsJ3MgY29ycmVjdGlvbi9zYW1wbGUgc3RhbmRhcmQgZGV2aWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHN0ZF9kZXYgPSB2YXJpYW5jZSAqKiAwLjUKICAgICAgICAgICAgICAgICAgICAgICAgc2VtID0gc3RkX2RldiAvIChsZW4odmFsdWVzX2F0X3RpbWUpICoqIDAuNSkKICAgICAgICAgICAgICAgICAgICAgICAgbWVhbl92YWx1ZXMuYXBwZW5kKG1lYW4pCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbV92YWx1ZXMuYXBwZW5kKHNlbSkKICAgICAgICAgICAgICAgICAgICBlbGlmIGxlbih2YWx1ZXNfYXRfdGltZSkgPT0gMToKICAgICAgICAgICAgICAgICAgICAgICAgbWVhbl92YWx1ZXMuYXBwZW5kKHZhbHVlc19hdF90aW1lWzBdKQogICAgICAgICAgICAgICAgICAgICAgICBzZW1fdmFsdWVzLmFwcGVuZChOb25lKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIG1lYW5fdmFsdWVzLmFwcGVuZChOb25lKQogICAgICAgICAgICAgICAgICAgICAgICBzZW1fdmFsdWVzLmFwcGVuZChOb25lKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENyZWF0ZSBjb25kaXRpb24gQ1NWIGZpbGVuYW1lOiBwbGF0ZV9pZF90cmlwbGljYXRlX25hbWVfY29se2NvbHVtbn0KICAgICAgICAgICAgICAgICMgUGxhdGUgSUQgYWxyZWFkeSBjb250YWlucyBnZW5vdHlwZSBhbmQgYnVmZmVyLCBzbyBqdXN0IHVzZSB0cmlwbGljYXRlIG5hbWUKICAgICAgICAgICAgICAgICMgS2VlcCBoeXBoZW5zIGluIGdyb3VwIG5hbWUgKGUuZy4sICIyNTAtMTAtMiIpLCBqdXN0IHNhbml0aXplIHNwYWNlcyBhbmQgY29sb25zCiAgICAgICAgICAgICAgICBzYWZlX2dyb3VwX25hbWUgPSBncm91cF9uYW1lLnJlcGxhY2UoIiAiLCAiXyIpLnJlcGxhY2UoIjoiLCAiLSIpCiAgICAgICAgICAgICAgICBjb25kaXRpb25fcGF0aCA9IG9zLnBhdGguam9pbihjc3Zfcm9vdCwgZiJ7cGxhdGVfaWR9X3tzYWZlX2dyb3VwX25hbWV9X2NvbHtjb2x1bW5fbnVtfS5jc3YiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFdyaXRlIGNvbmRpdGlvbiBDU1Ygd2l0aCBub3JtYWxpemVkIHZhbHVlcwogICAgICAgICAgICAgICAgY29uZGl0aW9uX2RmID0gcGQuRGF0YUZyYW1lKHsKICAgICAgICAgICAgICAgICAgICAidGltZV9zIjogYWxsX3RpbWVzLAogICAgICAgICAgICAgICAgICAgICJtZWFuIjogbWVhbl92YWx1ZXMsCiAgICAgICAgICAgICAgICAgICAgInNlbSI6IHNlbV92YWx1ZXMKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBjb25kaXRpb25fZGYudG9fY3N2KGNvbmRpdGlvbl9wYXRoLCBpbmRleD1GYWxzZSkKICAgICAgICAKICAgICAgICBwcmludChmIiAgICAgIFdyaXR0ZW4gY29uZGl0aW9uLXNwZWNpZmljIENTVnMiLCBmbHVzaD1UcnVlKQogICAgCiAgICBwcmludChmIiAg4pyTIENvbXBsZXRlZCB3cml0aW5nIENTVnMgZm9yIHtwbGF0ZV9pZH0iLCBmbHVzaD1UcnVlKQoKCmRlZiB3cml0ZV9kZWZhdWx0X2NvbmZpZyhjb25maWdfcGF0aDogc3RyKToKICAgICIiIldyaXRlIGRlZmF1bHQgY29uZmlndXJhdGlvbiBmaWxlIGZyb20gZGVmYXVsdHMuIiIiCiAgICAjIENvbnZlcnQgREVGQVVMVF9XRUxMX0xBQkVMUyB0byByb3ctYmFzZWQgZm9ybWF0CiAgICB3ZWxsX2xhYmVscyA9IHt9CiAgICBmb3Igd2VsbF9pZCwgbGFiZWwgaW4gREVGQVVMVF9XRUxMX0xBQkVMUy5pdGVtcygpOgogICAgICAgIGlmIHdlbGxfaWQgYW5kIGxlbih3ZWxsX2lkKSA+IDAgYW5kIHdlbGxfaWRbMF0uaXNhbHBoYSgpOgogICAgICAgICAgICByb3dfbGV0dGVyID0gd2VsbF9pZFswXQogICAgICAgICAgICBpZiByb3dfbGV0dGVyIG5vdCBpbiB3ZWxsX2xhYmVsczoKICAgICAgICAgICAgICAgIHdlbGxfbGFiZWxzW3Jvd19sZXR0ZXJdID0gbGFiZWwKICAgIAogICAgZGVmYXVsdF9jb25maWcgPSB7CiAgICAgICAgIndlbGxfbGFiZWxzIjogd2VsbF9sYWJlbHMsCiAgICAgICAgInRyaXBsaWNhdGVfZ3JvdXBzIjogREVGQVVMVF9UUklQTElDQVRFX0dST1VQUywKICAgICAgICAiY29udHJvbF9yb3dzIjogWyJOIiwgIk8iXSwKICAgICAgICAiYmFkX3dlbGxzIjogW10KICAgIH0KICAgIAogICAgdHJ5OgogICAgICAgIHdpdGggb3Blbihjb25maWdfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBqc29uLmR1bXAoZGVmYXVsdF9jb25maWcsIGYsIGluZGVudD0yKQogICAgICAgIHByaW50KGYiICBHZW5lcmF0ZWQgZGVmYXVsdCBjb25maWd1cmF0aW9uIGZpbGU6IHtvcy5wYXRoLmJhc2VuYW1lKGNvbmZpZ19wYXRoKX0iLCBmbHVzaD1UcnVlKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiICBXYXJuaW5nOiBDb3VsZCBub3Qgd3JpdGUgZGVmYXVsdCBjb25maWcgZmlsZToge2V9IiwgZmx1c2g9VHJ1ZSkKCgpkZWYgbm9ybWFsaXplX3dlbGxfaWQod2VsbF9pZDogc3RyKSAtPiBzdHI6CiAgICAiIiIKICAgIE5vcm1hbGl6ZSB3ZWxsIElEIHRvIGNvbnNpc3RlbnQgZm9ybWF0OiB1cHBlcmNhc2Ugd2l0aCB6ZXJvLXBhZGRlZCBjb2x1bW4uCiAgICBFeGFtcGxlczogIkI1IiAtPiAiQjA1IiwgIkIxMyIgLT4gIkIxMyIsICJiNSIgLT4gIkIwNSIKICAgICIiIgogICAgaWYgbm90IHdlbGxfaWQ6CiAgICAgICAgcmV0dXJuICIiCiAgICAKICAgIHdlbGxfaWQgPSBzdHIod2VsbF9pZCkuc3RyaXAoKS51cHBlcigpCiAgICAKICAgICMgTWF0Y2ggcGF0dGVybjogbGV0dGVyIGZvbGxvd2VkIGJ5IGRpZ2l0cwogICAgaW1wb3J0IHJlCiAgICBtYXRjaCA9IHJlLm1hdGNoKHInXihbQS1aXSkoXGQrKSQnLCB3ZWxsX2lkKQogICAgaWYgbWF0Y2g6CiAgICAgICAgcm93ID0gbWF0Y2guZ3JvdXAoMSkKICAgICAgICBjb2wgPSBpbnQobWF0Y2guZ3JvdXAoMikpCiAgICAgICAgcmV0dXJuIGYie3Jvd317Y29sOjAyZH0iICAjIFplcm8tcGFkIHRvIDIgZGlnaXRzCiAgICAKICAgIHJldHVybiB3ZWxsX2lkCgoKZGVmIGlzX2JhZF93ZWxsKHdlbGxfaWQ6IHN0ciwgY29uZmlnOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUpIC0+IGJvb2w6CiAgICAiIiIKICAgIENoZWNrIGlmIGEgd2VsbCBpcyBpbiB0aGUgYmFkX3dlbGxzIGxpc3QgZnJvbSBjb25maWcuCiAgICAKICAgIFBhcmFtZXRlcnM6CiAgICAtLS0tLS0tLS0tLQogICAgd2VsbF9pZCA6IHN0cgogICAgICAgIFdlbGwgSUQgdG8gY2hlY2sgKGUuZy4sICJCMTMiLCAiQjA1IikKICAgIGNvbmZpZyA6IERpY3Rbc3RyLCBBbnldLCBvcHRpb25hbAogICAgICAgIENvbmZpZ3VyYXRpb24gZGljdGlvbmFyeS4gSWYgTm9uZSwgbG9hZHMgZnJvbSBwbGF0ZV9jb25maWcuanNvbgogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIGJvb2wKICAgICAgICBUcnVlIGlmIHRoZSB3ZWxsIGlzIGluIHRoZSBiYWRfd2VsbHMgbGlzdCwgRmFsc2Ugb3RoZXJ3aXNlCiAgICAiIiIKICAgIGlmIGNvbmZpZyBpcyBOb25lOgogICAgICAgIHNjcmlwdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgICAgICBjb25maWdfcGF0aCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAicGxhdGVfY29uZmlnLmpzb24iKQogICAgICAgIGNvbmZpZyA9IGxvYWRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgCiAgICBiYWRfd2VsbHMgPSBjb25maWcuZ2V0KCJiYWRfd2VsbHMiLCBbXSkKICAgIGlmIG5vdCBpc2luc3RhbmNlKGJhZF93ZWxscywgbGlzdCk6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgICMgTm9ybWFsaXplIHRoZSBpbnB1dCB3ZWxsIElEIGZvciBjb25zaXN0ZW50IG1hdGNoaW5nCiAgICBub3JtYWxpemVkX3dlbGxfaWQgPSBub3JtYWxpemVfd2VsbF9pZChzdHIod2VsbF9pZCkuc3RyaXAoKSkKICAgIAogICAgIyBDaGVjayBpZiBub3JtYWxpemVkIHdlbGwgSUQgbWF0Y2hlcyBhbnkgYmFkIHdlbGwgKG5vcm1hbGl6ZSBiYWQgd2VsbHMgdG9vKQogICAgZm9yIGJhZF93ZWxsIGluIGJhZF93ZWxsczoKICAgICAgICBub3JtYWxpemVkX2JhZF93ZWxsID0gbm9ybWFsaXplX3dlbGxfaWQoc3RyKGJhZF93ZWxsKS5zdHJpcCgpKQogICAgICAgIGlmIG5vcm1hbGl6ZWRfd2VsbF9pZCA9PSBub3JtYWxpemVkX2JhZF93ZWxsOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgbG9hZF9jb25maWcoY29uZmlnX3BhdGg6IHN0cikgLT4gRGljdFtzdHIsIEFueV06CiAgICAiIiJMb2FkIHBsYXRlIGNvbmZpZ3VyYXRpb24gZmlsZSBpZiBpdCBleGlzdHMsIG90aGVyd2lzZSBnZW5lcmF0ZSBmcm9tIGRlZmF1bHRzLiIiIgogICAgaWYgb3MucGF0aC5leGlzdHMoY29uZmlnX3BhdGgpOgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGNvbmZpZ19wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBjb25maWcgPSBqc29uLmxvYWQoZikKICAgICAgICAgICAgICAgIHByaW50KGYiICBMb2FkZWQgY29uZmlndXJhdGlvbiBmcm9tIHtvcy5wYXRoLmJhc2VuYW1lKGNvbmZpZ19wYXRoKX0iLCBmbHVzaD1UcnVlKQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbmZpZwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiIgIFdhcm5pbmc6IENvdWxkIG5vdCBsb2FkIGNvbmZpZyBmaWxlOiB7ZX0iLCBmbHVzaD1UcnVlKQogICAgICAgICAgICAjIEdlbmVyYXRlIGRlZmF1bHQgY29uZmlnIGlmIGxvYWRpbmcgZmFpbHMKICAgICAgICAgICAgd3JpdGVfZGVmYXVsdF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgZWxzZToKICAgICAgICAjIEdlbmVyYXRlIGRlZmF1bHQgY29uZmlnIGZpbGUgaWYgaXQgZG9lc24ndCBleGlzdAogICAgICAgIHdyaXRlX2RlZmF1bHRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgICAgIHJldHVybiB7fQoKCmRlZiBidWlsZF92aWV3ZXJfanNvbihhbGxfcGxhdGVzOiBEaWN0W3N0ciwgcGQuRGF0YUZyYW1lXSwganNvbl9wYXRoOiBzdHIsIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lLCBwbGF0ZV9pZF90b19maWxlbmFtZTogRGljdFtzdHIsIHN0cl0gPSBOb25lKToKICAgICIiIgogICAgQnVpbGQgdmlld2VyX2RhdGEuanNvbiB3aXRoIHN0cnVjdHVyZToKICAgIHsKICAgICAgImNvbmZpZyI6IHsKICAgICAgICAid2VsbF9sYWJlbHMiOiB7Li4ufSwKICAgICAgICAidHJpcGxpY2F0ZV9ncm91cHMiOiBbLi4uXSwgICMgcm93LWxldHRlciBncm91cHMgKGFwcGxpZXMgdG8gYWxsIGNvbHVtbnMpCiAgICAgICAgImNvbHVtbl9ncm91cHMiOiB7Li4ufSAgIyBtYXBwaW5nIG9mIGNvbHVtbl9ncm91cCB0byBsaXN0IG9mIHBsYXRlX2lkcwogICAgICB9LAogICAgICAicGxhdGVzIjogWwogICAgICAgIHsKICAgICAgICAgICJpZCI6ICI8cGxhdGVfaWQ+IiwKICAgICAgICAgICJmaWxlIjogIjxvcmlnaW5hbF9maWxlX25hbWU+IiwKICAgICAgICAgICJjb2x1bW5fZ3JvdXAiOiAiPHByb3RlaW5fZ2Vub3R5cGVfYnVmZmVyPiIsCiAgICAgICAgICAiY29sdW1uX2luZm8iOiB7CiAgICAgICAgICAgICJwcm90ZWluIjogIi4uLiIsCiAgICAgICAgICAgICJnZW5vdHlwZSI6ICIuLi4iLAogICAgICAgICAgICAiYnVmZmVyIjogIi4uLiIsCiAgICAgICAgICAgICJzY2llbnRpc3QiOiAiLi4uIiwKICAgICAgICAgICAgIm51bWJlciI6ICIuLi4iCiAgICAgICAgICB9LAogICAgICAgICAgIndlbGxzIjogewogICAgICAgICAgICAiQjE1IjogewogICAgICAgICAgICAgICJjb250ZW50IjogIlNhbXBsZSBYMSIsCiAgICAgICAgICAgICAgImxhYmVsIjogIlNhbXBsZSBYMSIsICAjIGZyb20gY29uZmlnIGlmIGF2YWlsYWJsZQogICAgICAgICAgICAgICJ0aW1lX3MiOiBbLi4uXSwKICAgICAgICAgICAgICAidmFsdWVzIjogWy4uLl0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgLi4uCiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAuLi4KICAgICAgXQogICAgfQogICAgIiIiCiAgICBpZiBjb25maWcgaXMgTm9uZToKICAgICAgICBjb25maWcgPSB7fQogICAgaWYgcGxhdGVfaWRfdG9fZmlsZW5hbWUgaXMgTm9uZToKICAgICAgICBwbGF0ZV9pZF90b19maWxlbmFtZSA9IHt9CiAgICAKICAgICMgR2V0IGNvbnRyb2wgcm93cyBmcm9tIGNvbmZpZyAoZGVmYXVsdDogWyJOIiwgIk8iXSkKICAgIGNvbnRyb2xfcm93cyA9IGNvbmZpZy5nZXQoImNvbnRyb2xfcm93cyIsIFsiTiIsICJPIl0pCiAgICBpZiBub3QgaXNpbnN0YW5jZShjb250cm9sX3Jvd3MsIGxpc3QpOgogICAgICAgIGNvbnRyb2xfcm93cyA9IFsiTiIsICJPIl0gICMgRmFsbGJhY2sgdG8gZGVmYXVsdCBpZiBpbnZhbGlkCiAgICAKICAgICMgTWVyZ2UgZGVmYXVsdCB3ZWxsIGxhYmVscyB3aXRoIGNvbmZpZyBsYWJlbHMgKGNvbmZpZyB0YWtlcyBwcmVjZWRlbmNlKQogICAgIyBXZWxsIGxhYmVscyBhcmUgbm93IHJvdy1iYXNlZCAoZS5nLiwgIkIiOiAibGFiZWwiKSBpbnN0ZWFkIG9mIHdlbGwtc3BlY2lmaWMgKGUuZy4sICJCMTMiOiAibGFiZWwiKQogICAgIyBDb252ZXJ0IG9sZCBmb3JtYXQgdG8gbmV3IGZvcm1hdCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eQogICAgY29uZmlnX3dlbGxfbGFiZWxzID0gY29uZmlnLmdldCgid2VsbF9sYWJlbHMiLCB7fSkKICAgIHdlbGxfbGFiZWxzID0ge30KICAgIAogICAgIyBQcm9jZXNzIGNvbmZpZyBsYWJlbHMgLSBjb252ZXJ0IHdlbGwtc3BlY2lmaWMgdG8gcm93LWJhc2VkIGlmIG5lZWRlZAogICAgZm9yIGtleSwgdmFsdWUgaW4gY29uZmlnX3dlbGxfbGFiZWxzLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGtleSkgPiAxIGFuZCBrZXlbMF0uaXNhbHBoYSgpIGFuZCBrZXlbMTpdLmlzZGlnaXQoKToKICAgICAgICAgICAgIyBPbGQgZm9ybWF0OiAiQjEzIiAtPiBleHRyYWN0IHJvdyAiQiIKICAgICAgICAgICAgcm93X2xldHRlciA9IGtleVswXQogICAgICAgICAgICAjIFVzZSB0aGUgbGFzdCBub24tZW1wdHkgdmFsdWUgZm9yIGVhY2ggcm93IChpbiBjYXNlIG9mIGR1cGxpY2F0ZXMpCiAgICAgICAgICAgIGlmIHJvd19sZXR0ZXIgbm90IGluIHdlbGxfbGFiZWxzOgogICAgICAgICAgICAgICAgd2VsbF9sYWJlbHNbcm93X2xldHRlcl0gPSB2YWx1ZQogICAgICAgICAgICBlbGlmIG5vdCB3ZWxsX2xhYmVsc1tyb3dfbGV0dGVyXSBvciBub3Qgd2VsbF9sYWJlbHNbcm93X2xldHRlcl0uc3RyaXAoKToKICAgICAgICAgICAgICAgIHdlbGxfbGFiZWxzW3Jvd19sZXR0ZXJdID0gdmFsdWUKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIE5ldyBmb3JtYXQ6ICJCIiAtPiB1c2UgYXMgaXMKICAgICAgICAgICAgd2VsbF9sYWJlbHNba2V5XSA9IHZhbHVlCiAgICAKICAgICMgQWxzbyBjb252ZXJ0IERFRkFVTFRfV0VMTF9MQUJFTFMgdG8gcm93LWJhc2VkIGZvcm1hdAogICAgZGVmYXVsdF9yb3dfbGFiZWxzID0ge30KICAgIGZvciBrZXksIHZhbHVlIGluIERFRkFVTFRfV0VMTF9MQUJFTFMuaXRlbXMoKToKICAgICAgICBpZiBsZW4oa2V5KSA+IDEgYW5kIGtleVswXS5pc2FscGhhKCk6CiAgICAgICAgICAgIHJvd19sZXR0ZXIgPSBrZXlbMF0KICAgICAgICAgICAgaWYgcm93X2xldHRlciBub3QgaW4gZGVmYXVsdF9yb3dfbGFiZWxzOgogICAgICAgICAgICAgICAgZGVmYXVsdF9yb3dfbGFiZWxzW3Jvd19sZXR0ZXJdID0gdmFsdWUKICAgIAogICAgIyBNZXJnZSBkZWZhdWx0cyB3aXRoIGNvbmZpZyAoY29uZmlnIHRha2VzIHByZWNlZGVuY2UpCiAgICB3ZWxsX2xhYmVscyA9IHsqKmRlZmF1bHRfcm93X2xhYmVscywgKip3ZWxsX2xhYmVsc30KICAgIAogICAgIyBQYXJzZSBjb2x1bW4gZ3JvdXBzIGZyb20gZmlsZW5hbWVzCiAgICBjb2x1bW5fZ3JvdXBzOiBEaWN0W3N0ciwgTGlzdFtzdHJdXSA9IHt9ICAjIGNvbHVtbl9ncm91cCAtPiBsaXN0IG9mIHBsYXRlX2lkcwogICAgcGxhdGVfY29sdW1uX2luZm86IERpY3Rbc3RyLCBEaWN0W3N0ciwgc3RyXV0gPSB7fSAgIyBwbGF0ZV9pZCAtPiBjb2x1bW5faW5mbwogICAgCiAgICBmb3IgcGxhdGVfaWQsIGRmIGluIGFsbF9wbGF0ZXMuaXRlbXMoKToKICAgICAgICBmaWxlbmFtZSA9IHBsYXRlX2lkX3RvX2ZpbGVuYW1lLmdldChwbGF0ZV9pZCwgcGxhdGVfaWQgKyAiLnhsc3giKQogICAgICAgIGNvbHVtbl9pbmZvID0gcGFyc2VfY29sdW1uX2dyb3VwX2Zyb21fZmlsZW5hbWUoZmlsZW5hbWUpCiAgICAgICAgY29sdW1uX2dyb3VwID0gY29sdW1uX2luZm9bImNvbHVtbl9ncm91cCJdCiAgICAgICAgCiAgICAgICAgcGxhdGVfY29sdW1uX2luZm9bcGxhdGVfaWRdID0gY29sdW1uX2luZm8KICAgICAgICAKICAgICAgICBpZiBjb2x1bW5fZ3JvdXAgbm90IGluIGNvbHVtbl9ncm91cHM6CiAgICAgICAgICAgIGNvbHVtbl9ncm91cHNbY29sdW1uX2dyb3VwXSA9IFtdCiAgICAgICAgaWYgcGxhdGVfaWQgbm90IGluIGNvbHVtbl9ncm91cHNbY29sdW1uX2dyb3VwXToKICAgICAgICAgICAgY29sdW1uX2dyb3Vwc1tjb2x1bW5fZ3JvdXBdLmFwcGVuZChwbGF0ZV9pZCkKICAgIAogICAgIyBQcm9jZXNzIHRyaXBsaWNhdGUgZ3JvdXBzIC0gcm93IGxldHRlcnMgb25seSwgYXBwbGllcyB0byBhbGwgY29sdW1ucwogICAgIyBDb25maWcgZm9ybWF0OiB7Im5hbWUiOiAiLi4uIiwgIndlbGxzIjogWyJCIiwgIkMiLCAiRCJdfQogICAgIyBDb2x1bW4gZmllbGQgaXMgaWdub3JlZCBpZiBwcmVzZW50IChmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSkKICAgIGNvbmZpZ190cmlwbGljYXRlX2dyb3VwcyA9IGNvbmZpZy5nZXQoInRyaXBsaWNhdGVfZ3JvdXBzIiwgW10pCiAgICAKICAgIGlmIGNvbmZpZ190cmlwbGljYXRlX2dyb3VwcyBhbmQgbGVuKGNvbmZpZ190cmlwbGljYXRlX2dyb3VwcykgPiAwOgogICAgICAgICMgUHJvY2VzcyB0cmlwbGljYXRlIGdyb3VwcyAtIGFjY2VwdCByb3cgbGV0dGVycyBvbmx5IChlLmcuLCBbIkIiLCAiQyIsICJEIl0pCiAgICAgICAgIyBBbHNvIHN1cHBvcnQgYmFja3dhcmQgY29tcGF0aWJpbGl0eSB3aXRoIGZ1bGwgd2VsbCBJRHMgKGUuZy4sIFsiQjEzIiwgIkMxMyIsICJEMTMiXSkKICAgICAgICB0cmlwbGljYXRlX2dyb3VwcyA9IFtdCiAgICAgICAgZm9yIGdyb3VwIGluIGNvbmZpZ190cmlwbGljYXRlX2dyb3VwczoKICAgICAgICAgICAgd2VsbHMgPSBncm91cC5nZXQoIndlbGxzIiwgW10pCiAgICAgICAgICAgICMgRXh0cmFjdCByb3cgbGV0dGVycyBmcm9tIHdlbGxzIChoYW5kbGUgYm90aCBmb3JtYXRzKQogICAgICAgICAgICByb3dfbGV0dGVycyA9IFtdCiAgICAgICAgICAgIGZvciB3IGluIHdlbGxzOgogICAgICAgICAgICAgICAgIyBJZiBpdCdzIGEgZnVsbCB3ZWxsIElEIChlLmcuLCAiQjEzIiksIGV4dHJhY3Qgcm93IGxldHRlcgogICAgICAgICAgICAgICAgaWYgbGVuKHcpID4gMSBhbmQgd1swXS5pc2FscGhhKCkgYW5kIHdbMTpdLmlzZGlnaXQoKToKICAgICAgICAgICAgICAgICAgICByb3dfbGV0dGVyID0gd1swXQogICAgICAgICAgICAgICAgIyBJZiBpdCdzIGp1c3QgYSByb3cgbGV0dGVyIChlLmcuLCAiQiIpLCB1c2UgYXMgaXMKICAgICAgICAgICAgICAgIGVsaWYgbGVuKHcpID09IDEgYW5kIHcuaXNhbHBoYSgpOgogICAgICAgICAgICAgICAgICAgIHJvd19sZXR0ZXIgPSB3CiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlICAjIFNraXAgaW52YWxpZCBlbnRyaWVzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgRmlsdGVyIG91dCBjb250cm9sIHdlbGxzCiAgICAgICAgICAgICAgICBpZiBub3QgaXNfY29udHJvbF93ZWxsKHJvd19sZXR0ZXIsIGNvbnRyb2xfcm93cyk6CiAgICAgICAgICAgICAgICAgICAgaWYgcm93X2xldHRlciBub3QgaW4gcm93X2xldHRlcnM6CiAgICAgICAgICAgICAgICAgICAgICAgIHJvd19sZXR0ZXJzLmFwcGVuZChyb3dfbGV0dGVyKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcm93X2xldHRlcnM6CiAgICAgICAgICAgICAgICAjIFN0b3JlIHJvdyBsZXR0ZXJzIG9ubHkgLSBhcHBsaWVzIHRvIGFsbCBjb2x1bW5zCiAgICAgICAgICAgICAgICB0cmlwbGljYXRlX2dyb3Vwcy5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICJuYW1lIjogZ3JvdXAuZ2V0KCJuYW1lIiwgIiIpLAogICAgICAgICAgICAgICAgICAgICJ3ZWxscyI6IHNvcnRlZChyb3dfbGV0dGVycykgICMgU3RvcmUganVzdCByb3cgbGV0dGVycwogICAgICAgICAgICAgICAgfSkKICAgICAgICAKICAgICAgICBpZiB0cmlwbGljYXRlX2dyb3VwczoKICAgICAgICAgICAgcHJpbnQoZiIgIFVzaW5nIHtsZW4odHJpcGxpY2F0ZV9ncm91cHMpfSB0cmlwbGljYXRlIGdyb3VwKHMpIGZyb20gY29uZmlnIChyb3cgbGV0dGVycyBvbmx5LCBhcHBsaWVzIHRvIGFsbCBjb2x1bW5zKSIsIGZsdXNoPVRydWUpCiAgICBlbHNlOgogICAgICAgICMgQXV0by1nZW5lcmF0ZSBvciB1c2UgZGVmYXVsdHMKICAgICAgICAjIENvbGxlY3QgYWxsIHdlbGxzIGZyb20gYWxsIHBsYXRlcyB0byBhdXRvLWdlbmVyYXRlIHRyaXBsaWNhdGUgZ3JvdXBzCiAgICAgICAgY29udGVudF90b193ZWxsczogRGljdFtzdHIsIExpc3Rbc3RyXV0gPSB7fQogICAgICAgIAogICAgICAgIGZvciBwbGF0ZV9pZCwgZGYgaW4gYWxsX3BsYXRlcy5pdGVtcygpOgogICAgICAgICAgICBmb3Igd2VsbF9pZCwgZyBpbiBkZi5ncm91cGJ5KCJ3ZWxsIik6CiAgICAgICAgICAgICAgICBnX3NvcnRlZCA9IGcuc29ydF92YWx1ZXMoInRpbWVfcyIpCiAgICAgICAgICAgICAgICBjb250ZW50ID0gZ19zb3J0ZWRbImNvbnRlbnQiXS5pbG9jWzBdCiAgICAgICAgICAgICAgICBpZiBjb250ZW50IGFuZCBzdHIoY29udGVudCkuc3RyaXAoKToKICAgICAgICAgICAgICAgICAgICBpZiBjb250ZW50IG5vdCBpbiBjb250ZW50X3RvX3dlbGxzOgogICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50X3RvX3dlbGxzW2NvbnRlbnRdID0gW10KICAgICAgICAgICAgICAgICAgICBpZiB3ZWxsX2lkIG5vdCBpbiBjb250ZW50X3RvX3dlbGxzW2NvbnRlbnRdOgogICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50X3RvX3dlbGxzW2NvbnRlbnRdLmFwcGVuZCh3ZWxsX2lkKQogICAgICAgIAogICAgICAgICMgQXV0by1nZW5lcmF0ZSB0cmlwbGljYXRlIGdyb3VwczogZ3JvdXAgd2VsbHMgd2l0aCB0aGUgc2FtZSBjb250ZW50CiAgICAgICAgIyBFeHRyYWN0IHJvdyBwYXR0ZXJuIChlLmcuLCBCQ0QsIEVGRykgYW5kIGFwcGx5IHRvIGFsbCBjb2x1bW5zCiAgICAgICAgIyBFeGNsdWRlIGNvbnRyb2wgd2VsbHMgZnJvbSB0cmlwbGljYXRlIGdyb3VwcwogICAgICAgIGF1dG9fdHJpcGxpY2F0ZV9ncm91cHMgPSBbXQogICAgICAgIGZvciBjb250ZW50LCB3ZWxscyBpbiBjb250ZW50X3RvX3dlbGxzLml0ZW1zKCk6CiAgICAgICAgICAgICMgRmlsdGVyIG91dCBjb250cm9sIHdlbGxzCiAgICAgICAgICAgIG5vbl9jb250cm9sX3dlbGxzID0gW3cgZm9yIHcgaW4gd2VsbHMgaWYgbm90IGlzX2NvbnRyb2xfd2VsbCh3LCBjb250cm9sX3Jvd3MpXQogICAgICAgICAgICBpZiBsZW4obm9uX2NvbnRyb2xfd2VsbHMpID49IDI6ICAjIEF0IGxlYXN0IDIgbm9uLWNvbnRyb2wgd2VsbHMgd2l0aCBzYW1lIGNvbnRlbnQKICAgICAgICAgICAgICAgICMgRXh0cmFjdCByb3cgbGV0dGVycyAoZS5nLiwgWyJCMTMiLCAiQzEzIiwgIkQxMyJdIC0+IFsiQiIsICJDIiwgIkQiXSkKICAgICAgICAgICAgICAgIHJvd19sZXR0ZXJzID0gc29ydGVkKHNldChbd1swXSBmb3IgdyBpbiBub25fY29udHJvbF93ZWxscyBpZiB3IGFuZCB3WzBdLmlzYWxwaGEoKV0pKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIElmIHdlIGhhdmUgYSBwYXR0ZXJuIG9mIDMgY29uc2VjdXRpdmUgcm93cywgY3JlYXRlIGEgdHJpcGxpY2F0ZSBncm91cAogICAgICAgICAgICAgICAgIyBDaGVjayBmb3IgcGF0dGVybnMgbGlrZSBCQ0QsIEVGRywgSElKLCBldGMuCiAgICAgICAgICAgICAgICBpZiBsZW4ocm93X2xldHRlcnMpID49IDM6CiAgICAgICAgICAgICAgICAgICAgIyBTb3J0IHJvdyBsZXR0ZXJzIGFuZCBjaGVjayBpZiB0aGV5IGZvcm0gYSBjb25zZWN1dGl2ZSBwYXR0ZXJuCiAgICAgICAgICAgICAgICAgICAgcm93X2xldHRlcnNfc29ydGVkID0gc29ydGVkKHJvd19sZXR0ZXJzKQogICAgICAgICAgICAgICAgICAgICMgQ3JlYXRlIGdyb3VwIHdpdGggcm93IHBhdHRlcm4gKGFwcGxpZXMgdG8gYWxsIGNvbHVtbnMpCiAgICAgICAgICAgICAgICAgICAgYXV0b190cmlwbGljYXRlX2dyb3Vwcy5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICAgICAibmFtZSI6IGNvbnRlbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICJ3ZWxscyI6IHJvd19sZXR0ZXJzX3NvcnRlZFs6M10gICMgU3RvcmUgcm93IGxldHRlcnMgb25seQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBlbGlmIGxlbihyb3dfbGV0dGVycykgPj0gMjoKICAgICAgICAgICAgICAgICAgICAjIEZvciAyIHdlbGxzLCBzdGlsbCBjcmVhdGUgYSBncm91cAogICAgICAgICAgICAgICAgICAgIGF1dG9fdHJpcGxpY2F0ZV9ncm91cHMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiBjb250ZW50LAogICAgICAgICAgICAgICAgICAgICAgICAid2VsbHMiOiBzb3J0ZWQocm93X2xldHRlcnMpWzoyXSAgIyBTdG9yZSByb3cgbGV0dGVycyBvbmx5CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAKICAgICAgICAjIFNvcnQgdHJpcGxpY2F0ZSBncm91cHMgYnkgbmFtZQogICAgICAgIGF1dG9fdHJpcGxpY2F0ZV9ncm91cHMuc29ydChrZXk9bGFtYmRhIHg6IHguZ2V0KCJuYW1lIiwgIiIpKQogICAgICAgIAogICAgICAgIGlmIGF1dG9fdHJpcGxpY2F0ZV9ncm91cHM6CiAgICAgICAgICAgIHRyaXBsaWNhdGVfZ3JvdXBzID0gYXV0b190cmlwbGljYXRlX2dyb3VwcwogICAgICAgICAgICBwcmludChmIiAgQXV0by1nZW5lcmF0ZWQge2xlbih0cmlwbGljYXRlX2dyb3Vwcyl9IHRyaXBsaWNhdGUgZ3JvdXAocykgZnJvbSBkYXRhIChhcHBsaWVzIHRvIGFsbCBjb2x1bW5zKSIsIGZsdXNoPVRydWUpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBGYWxsIGJhY2sgdG8gZGVmYXVsdHMgLSBhbHJlYWR5IGluIHJvdyBsZXR0ZXIgZm9ybWF0CiAgICAgICAgICAgICMgRXhjbHVkZSBjb250cm9sIHdlbGxzIGZyb20gZGVmYXVsdCBncm91cHMKICAgICAgICAgICAgdHJpcGxpY2F0ZV9ncm91cHMgPSBbXQogICAgICAgICAgICBmb3IgZ3JvdXAgaW4gREVGQVVMVF9UUklQTElDQVRFX0dST1VQUzoKICAgICAgICAgICAgICAgIHdlbGxzID0gZ3JvdXAuZ2V0KCJ3ZWxscyIsIFtdKQogICAgICAgICAgICAgICAgIyBGaWx0ZXIgb3V0IGNvbnRyb2wgd2VsbHMKICAgICAgICAgICAgICAgIHJvd19sZXR0ZXJzID0gW3cgZm9yIHcgaW4gd2VsbHMgaWYgbm90IGlzX2NvbnRyb2xfd2VsbCh3LCBjb250cm9sX3Jvd3MpXQogICAgICAgICAgICAgICAgaWYgcm93X2xldHRlcnM6CiAgICAgICAgICAgICAgICAgICAgdHJpcGxpY2F0ZV9ncm91cHMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiBncm91cC5nZXQoIm5hbWUiLCAiIiksCiAgICAgICAgICAgICAgICAgICAgICAgICJ3ZWxscyI6IHNvcnRlZChyb3dfbGV0dGVycykgICMgQWxyZWFkeSByb3cgbGV0dGVycwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIGlmIHRyaXBsaWNhdGVfZ3JvdXBzOgogICAgICAgICAgICAgICAgcHJpbnQoZiIgIFVzaW5nIHtsZW4odHJpcGxpY2F0ZV9ncm91cHMpfSBkZWZhdWx0IHRyaXBsaWNhdGUgZ3JvdXAocykgKGFwcGxpZXMgdG8gYWxsIGNvbHVtbnMsIGNvbnRyb2wgd2VsbHMgZXhjbHVkZWQpIiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgIyBEZXRlY3QgZHVwbGljYXRlIHdlbGwgSURzIChzYW1lIHdlbGwgSUQgYXBwZWFycyBpbiBtdWx0aXBsZSBmaWxlcykKICAgICMgVGhpcyBtZWFucyBkdXBsaWNhdGUgY29sdW1ucyBpbiB0aGUgcGxhdGUgZ3JpZAogICAgd2VsbF9pZF90b19maWxlczogRGljdFtzdHIsIExpc3Rbc3RyXV0gPSB7fSAgIyB3ZWxsX2lkIC0+IGxpc3Qgb2YgZmlsZW5hbWVzCiAgICAKICAgIGZvciBwbGF0ZV9pZCwgZGYgaW4gYWxsX3BsYXRlcy5pdGVtcygpOgogICAgICAgIGZpbGVuYW1lID0gcGxhdGVfaWRfdG9fZmlsZW5hbWUuZ2V0KHBsYXRlX2lkLCBwbGF0ZV9pZCArICIueGxzeCIpCiAgICAgICAgIyBHZXQgYWxsIHVuaXF1ZSB3ZWxsIElEcyBmcm9tIHRoaXMgcGxhdGUKICAgICAgICB1bmlxdWVfd2VsbHMgPSBkZlsid2VsbCJdLnVuaXF1ZSgpCiAgICAgICAgZm9yIHdlbGxfaWQgaW4gdW5pcXVlX3dlbGxzOgogICAgICAgICAgICAjIE5vcm1hbGl6ZSB3ZWxsIElEIGZvciBjb25zaXN0ZW50IGR1cGxpY2F0ZSBkZXRlY3Rpb24KICAgICAgICAgICAgd2VsbF9pZF9zdHIgPSBub3JtYWxpemVfd2VsbF9pZChzdHIod2VsbF9pZCkuc3RyaXAoKSkKICAgICAgICAgICAgaWYgd2VsbF9pZF9zdHIgbm90IGluIHdlbGxfaWRfdG9fZmlsZXM6CiAgICAgICAgICAgICAgICB3ZWxsX2lkX3RvX2ZpbGVzW3dlbGxfaWRfc3RyXSA9IFtdCiAgICAgICAgICAgIGlmIGZpbGVuYW1lIG5vdCBpbiB3ZWxsX2lkX3RvX2ZpbGVzW3dlbGxfaWRfc3RyXToKICAgICAgICAgICAgICAgIHdlbGxfaWRfdG9fZmlsZXNbd2VsbF9pZF9zdHJdLmFwcGVuZChmaWxlbmFtZSkKICAgIAogICAgIyBHcm91cCBkdXBsaWNhdGVzIGJ5IGZpbGUgcGFpcnMgZm9yIGNsZWFuZXIgbWVzc2FnaW5nCiAgICBkdXBsaWNhdGVfY29sdW1uX3dhcm5pbmdzID0gW10KICAgIGZpbGVfcGFpcnNfdG9fd2VsbHM6IERpY3Rbc3RyLCBMaXN0W3N0cl1dID0ge30gICMgImZpbGUxfGZpbGUyIiAtPiBbd2VsbF9pZHNdCiAgICAKICAgIGZvciB3ZWxsX2lkLCBmaWxlcyBpbiB3ZWxsX2lkX3RvX2ZpbGVzLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGZpbGVzKSA+IDE6CiAgICAgICAgICAgICMgU29ydCBmaWxlcyBhbHBoYWJldGljYWxseSBmb3IgY29uc2lzdGVudCBvcmRlcmluZwogICAgICAgICAgICBzb3J0ZWRfZmlsZXMgPSBzb3J0ZWQoZmlsZXMpCiAgICAgICAgICAgIGZpbGVfa2V5ID0gInwiLmpvaW4oc29ydGVkX2ZpbGVzKQogICAgICAgICAgICBpZiBmaWxlX2tleSBub3QgaW4gZmlsZV9wYWlyc190b193ZWxsczoKICAgICAgICAgICAgICAgIGZpbGVfcGFpcnNfdG9fd2VsbHNbZmlsZV9rZXldID0gW10KICAgICAgICAgICAgZmlsZV9wYWlyc190b193ZWxsc1tmaWxlX2tleV0uYXBwZW5kKHdlbGxfaWQpCiAgICAKICAgICMgQnVpbGQgd2FybmluZ3MgZ3JvdXBlZCBieSBmaWxlIHBhaXJzCiAgICBmb3IgZmlsZV9rZXksIHdlbGxfaWRzIGluIGZpbGVfcGFpcnNfdG9fd2VsbHMuaXRlbXMoKToKICAgICAgICBmaWxlcyA9IGZpbGVfa2V5LnNwbGl0KCJ8IikKICAgICAgICBzb3J0ZWRfd2VsbHMgPSBzb3J0ZWQod2VsbF9pZHMpCiAgICAgICAgZHVwbGljYXRlX2NvbHVtbl93YXJuaW5ncy5hcHBlbmQoewogICAgICAgICAgICAiZmlsZXMiOiBmaWxlcywKICAgICAgICAgICAgIndlbGxfaWRzIjogc29ydGVkX3dlbGxzCiAgICAgICAgfSkKICAgICAgICAKICAgICAgICAjIENvbnNvbGUgbWVzc2FnZSAtIHNob3J0ZXIgdmVyc2lvbgogICAgICAgIGZpbGVzX3N0ciA9ICIgYW5kICIuam9pbihmaWxlcykKICAgICAgICB3ZWxsc19zdHIgPSAiLCAiLmpvaW4oc29ydGVkX3dlbGxzWzo1XSkgICMgU2hvdyBmaXJzdCA1CiAgICAgICAgaWYgbGVuKHNvcnRlZF93ZWxscykgPiA1OgogICAgICAgICAgICB3ZWxsc19zdHIgKz0gZiIsIC4uLiAoe2xlbihzb3J0ZWRfd2VsbHMpfSB0b3RhbCkiCiAgICAgICAgcHJpbnQoZiIgIOKaoO+4jyAgV0FSTklORzoge2ZpbGVzX3N0cn0gaGF2ZSBkdXBsaWNhdGUgd2VsbHM6IHt3ZWxsc19zdHJ9IiwgZmx1c2g9VHJ1ZSkKICAgICAgICBwcmludChmIiAgICAgT25seSBkYXRhIGZyb20gJ3tmaWxlc1swXX0nIChmaXJzdCBhbHBoYWJldGljYWxseSkgaXMgdXNlZC4iLCBmbHVzaD1UcnVlKQogICAgCiAgICBkYXRhID0gewogICAgICAgICJjb25maWciOiB7CiAgICAgICAgICAgICJ3ZWxsX2xhYmVscyI6IHdlbGxfbGFiZWxzLAogICAgICAgICAgICAidHJpcGxpY2F0ZV9ncm91cHMiOiB0cmlwbGljYXRlX2dyb3VwcywKICAgICAgICAgICAgImNvbHVtbl9ncm91cHMiOiBjb2x1bW5fZ3JvdXBzLAogICAgICAgICAgICAiY29udHJvbF9yb3dzIjogY29udHJvbF9yb3dzLAogICAgICAgICAgICAid2FybmluZ3MiOiB7CiAgICAgICAgICAgICAgICAiZHVwbGljYXRlX2NvbHVtbnMiOiBkdXBsaWNhdGVfY29sdW1uX3dhcm5pbmdzCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJwbGF0ZXMiOiBbXQogICAgfQogICAgCiAgICBmb3IgcGxhdGVfaWQsIGRmIGluIGFsbF9wbGF0ZXMuaXRlbXMoKToKICAgICAgICB3ZWxsc19kaWN0OiBEaWN0W3N0ciwgQW55XSA9IHt9CiAgICAgICAgZm9yIHdlbGxfaWQsIGcgaW4gZGYuZ3JvdXBieSgid2VsbCIpOgogICAgICAgICAgICAjIE5vcm1hbGl6ZSB3ZWxsIElEIHRvIGNvbnNpc3RlbnQgZm9ybWF0ICh6ZXJvLXBhZGRlZCkKICAgICAgICAgICAgbm9ybWFsaXplZF93ZWxsX2lkID0gbm9ybWFsaXplX3dlbGxfaWQod2VsbF9pZCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU2tpcCBiYWQgd2VsbHMKICAgICAgICAgICAgaWYgaXNfYmFkX3dlbGwobm9ybWFsaXplZF93ZWxsX2lkLCBjb25maWcpOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgCiAgICAgICAgICAgIGdfc29ydGVkID0gZy5zb3J0X3ZhbHVlcygidGltZV9zIikKICAgICAgICAgICAgY29udGVudCA9IGdfc29ydGVkWyJjb250ZW50Il0uaWxvY1swXQogICAgICAgICAgICAjIFVzZSByb3ctYmFzZWQgbGFiZWwgZnJvbSBjb25maWcgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgdXNlIGNvbnRlbnQKICAgICAgICAgICAgIyBFeHRyYWN0IHJvdyBsZXR0ZXIgZnJvbSBub3JtYWxpemVkIHdlbGxfaWQgKGUuZy4sICJCMTMiIC0+ICJCIikKICAgICAgICAgICAgcm93X2xldHRlciA9IG5vcm1hbGl6ZWRfd2VsbF9pZFswXSBpZiBub3JtYWxpemVkX3dlbGxfaWQgYW5kIG5vcm1hbGl6ZWRfd2VsbF9pZFswXS5pc2FscGhhKCkgZWxzZSAiIgogICAgICAgICAgICBsYWJlbCA9IHdlbGxfbGFiZWxzLmdldChyb3dfbGV0dGVyLCBjb250ZW50KSBpZiByb3dfbGV0dGVyIGVsc2UgY29udGVudAogICAgICAgICAgICB3ZWxsc19kaWN0W25vcm1hbGl6ZWRfd2VsbF9pZF0gPSB7CiAgICAgICAgICAgICAgICAiY29udGVudCI6IGNvbnRlbnQsCiAgICAgICAgICAgICAgICAibGFiZWwiOiBsYWJlbCwKICAgICAgICAgICAgICAgICJ0aW1lX3MiOiBnX3NvcnRlZFsidGltZV9zIl0udG9saXN0KCksCiAgICAgICAgICAgICAgICAidmFsdWVzIjogZ19zb3J0ZWRbInZhbHVlIl0udG9saXN0KCksCiAgICAgICAgICAgIH0KICAgICAgICAKICAgICAgICBmaWxlbmFtZSA9IHBsYXRlX2lkX3RvX2ZpbGVuYW1lLmdldChwbGF0ZV9pZCwgcGxhdGVfaWQgKyAiLnhsc3giKQogICAgICAgIGNvbHVtbl9pbmZvID0gcGxhdGVfY29sdW1uX2luZm8uZ2V0KHBsYXRlX2lkLCBwYXJzZV9jb2x1bW5fZ3JvdXBfZnJvbV9maWxlbmFtZShmaWxlbmFtZSkpCiAgICAgICAgCiAgICAgICAgZGF0YVsicGxhdGVzIl0uYXBwZW5kKAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAiaWQiOiBwbGF0ZV9pZCwKICAgICAgICAgICAgICAgICJmaWxlIjogZmlsZW5hbWUsCiAgICAgICAgICAgICAgICAiY29sdW1uX2dyb3VwIjogY29sdW1uX2luZm9bImNvbHVtbl9ncm91cCJdLAogICAgICAgICAgICAgICAgImNvbHVtbl9pbmZvIjogewogICAgICAgICAgICAgICAgICAgICJwcm90ZWluIjogY29sdW1uX2luZm9bInByb3RlaW4iXSwKICAgICAgICAgICAgICAgICAgICAiZ2Vub3R5cGUiOiBjb2x1bW5faW5mb1siZ2Vub3R5cGUiXSwKICAgICAgICAgICAgICAgICAgICAiYnVmZmVyIjogY29sdW1uX2luZm9bImJ1ZmZlciJdLAogICAgICAgICAgICAgICAgICAgICJzY2llbnRpc3QiOiBjb2x1bW5faW5mb1sic2NpZW50aXN0Il0sCiAgICAgICAgICAgICAgICAgICAgIm51bWJlciI6IGNvbHVtbl9pbmZvWyJudW1iZXIiXQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJ3ZWxscyI6IHdlbGxzX2RpY3QsCiAgICAgICAgICAgIH0KICAgICAgICApCgogICAgd2l0aCBvcGVuKGpzb25fcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgIGpzb24uZHVtcChkYXRhLCBmLCBpbmRlbnQ9MikKCgpIVE1MX1RFTVBMQVRFID0gciIiIjwhRE9DVFlQRSBodG1sPgo8aHRtbCBsYW5nPSJlbiI+CjxoZWFkPgogIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICA8dGl0bGU+UGxhdGUgVmlld2VyPC90aXRsZT4KICA8c3R5bGU+CiAgICBib2R5IHsKICAgICAgZm9udC1mYW1pbHk6IHN5c3RlbS11aSwgLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCAiU2Vnb2UgVUkiLCBzYW5zLXNlcmlmOwogICAgICBtYXJnaW46IDA7CiAgICAgIHBhZGRpbmc6IDA7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgIGhlaWdodDogMTAwdmg7CiAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICB9CiAgICAjY29udGVudC13cmFwcGVyIHsKICAgICAgZGlzcGxheTogZ3JpZDsKICAgICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAzMjBweCAxZnI7CiAgICAgIGZsZXg6IDE7CiAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB9CiAgICBhc2lkZSB7CiAgICAgIGJvcmRlci1yaWdodDogMXB4IHNvbGlkICNjY2M7CiAgICAgIHBhZGRpbmc6IDE2cHg7CiAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICAgIGJhY2tncm91bmQ6ICNmN2Y3Zjc7CiAgICAgIG92ZXJmbG93LXk6IGF1dG87CiAgICB9CiAgICBtYWluIHsKICAgICAgcGFkZGluZzogMTZweDsKICAgICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgICAgb3ZlcmZsb3c6IGF1dG87CiAgICB9CiAgICBoMSB7CiAgICAgIGZvbnQtc2l6ZTogMS4ycmVtOwogICAgICBtYXJnaW4tdG9wOiAwOwogICAgfQogICAgbGFiZWwgewogICAgICBkaXNwbGF5OiBibG9jazsKICAgICAgbWFyZ2luLWJvdHRvbTogOHB4OwogICAgICBmb250LXdlaWdodDogNjAwOwogICAgfQogICAgc2VsZWN0IHsKICAgICAgd2lkdGg6IDEwMCUlOwogICAgICBwYWRkaW5nOiA4cHg7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7CiAgICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgIGZvbnQtc2l6ZTogMC45cmVtOwogICAgICBtYXJnaW4tYm90dG9tOiAxNnB4OwogICAgfQogICAgI3dlbGwtaW5mbyB7CiAgICAgIG1hcmdpbi10b3A6IDhweDsKICAgICAgZm9udC1zaXplOiAwLjlyZW07CiAgICAgIHBhZGRpbmc6IDhweDsKICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgICAgYm9yZGVyOiAxcHggc29saWQgI2RkZDsKICAgIH0KICAgICNwbGF0ZS1ncmlkIHsKICAgICAgZGlzcGxheTogZ3JpZDsKICAgICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiBhdXRvIHJlcGVhdCglKGNvbHMpZCwgMWZyKTsKICAgICAgZ3JpZC1hdXRvLXJvd3M6IDMycHg7CiAgICAgIGdhcDogMnB4OwogICAgICBmb250LXNpemU6IDExcHg7CiAgICAgIG1hcmdpbi1ib3R0b206IDE2cHg7CiAgICB9CiAgICAuZ3JpZC1oZWFkZXIgewogICAgICBmb250LXdlaWdodDogNzAwOwogICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICB9CiAgICAucm93LWxhYmVsLCAuY29sLWxhYmVsIHsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICB9CiAgICAud2VsbCB7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7CiAgICAgIGJvcmRlci1yYWRpdXM6IDNweDsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgYmFja2dyb3VuZDogI2ZmZjsKICAgICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgICBmb250LXNpemU6IDEwcHg7CiAgICAgIHBvaW50ZXItZXZlbnRzOiBhdXRvOwogICAgICB6LWluZGV4OiAxOwogICAgfQogICAgLndlbGxbZGF0YS1oYXMtZGF0YT0idHJ1ZSJdOm5vdCgudHJpcGxpY2F0ZS1ncm91cCk6bm90KC5jb250cm9sKSB7CiAgICAgIGJhY2tncm91bmQ6ICNlNGYwZmY7CiAgICAgIGJvcmRlci1jb2xvcjogIzZjOWNmZjsKICAgIH0KICAgIC53ZWxsLnNlbGVjdGVkIHsKICAgICAgb3V0bGluZTogMnB4IHNvbGlkICMyYTZjZmY7CiAgICAgIG91dGxpbmUtb2Zmc2V0OiAtMnB4OwogICAgICBiYWNrZ3JvdW5kOiAjZTRmMGZmOwogICAgfQogICAgLndlbGwucmVwbGljYXRlIHsKICAgICAgYm9yZGVyLXN0eWxlOiBkYXNoZWQ7CiAgICB9CiAgICAud2VsbC50cmlwbGljYXRlLWdyb3VwIHsKICAgICAgLyogQm9yZGVycyBhcmUgYWRkZWQgdmlhIGlubGluZSBzdHlsZXMgb25seSB3aGVuIHNlbGVjdGVkICovCiAgICB9CiAgICAvKiBJbmRpdmlkdWFsIGNvbG9ycyB3aWxsIGJlIGFwcGxpZWQgdmlhIGlubGluZSBzdHlsZXMgKi8KICAgIC53ZWxsLmNvbnRyb2wgewogICAgICBiYWNrZ3JvdW5kOiAjZThmNWU5OwogICAgICBib3JkZXI6IDFweCBzb2xpZCAjZGRkOwogICAgfQogICAgLndlbGwuY29udHJvbFtkYXRhLWhhcy1kYXRhPSJ0cnVlIl0gewogICAgICBiYWNrZ3JvdW5kOiAjYzhlNmM5OwogICAgICBib3JkZXItY29sb3I6ICM2YzljZmY7CiAgICB9CiAgICAud2VsbC5jb250cm9sLnNlbGVjdGVkIHsKICAgICAgYmFja2dyb3VuZDogI2M4ZTZjOTsKICAgICAgb3V0bGluZTogMnB4IHNvbGlkICMyYTZjZmY7CiAgICAgIG91dGxpbmUtb2Zmc2V0OiAtMnB4OwogICAgfQogICAgLndlbGwtbGFiZWwgewogICAgICBmb250LXNpemU6IDhweDsKICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICBib3R0b206IDFweDsKICAgICAgbGVmdDogMXB4OwogICAgICByaWdodDogMXB4OwogICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgIHRleHQtb3ZlcmZsb3c6IGVsbGlwc2lzOwogICAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwogICAgICBwb2ludGVyLWV2ZW50czogbm9uZTsKICAgICAgei1pbmRleDogMjsKICAgIH0KICAgICNjaGFydC1jb250YWluZXIgewogICAgICBtYXJnaW4tdG9wOiAxMnB4OwogICAgICBoZWlnaHQ6IDgwMHB4OwogICAgICBtaW4taGVpZ2h0OiA4MDBweDsKICAgICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgfQogICAgY2FudmFzIHsKICAgICAgbWF4LXdpZHRoOiAxMDAlJTsKICAgICAgaGVpZ2h0OiA4MDBweCAhaW1wb3J0YW50OwogICAgfQogICAgLmJ0biB7CiAgICAgIHBhZGRpbmc6IDZweCAxMnB4OwogICAgICBtYXJnaW46IDRweCAwOwogICAgICBib3JkZXI6IDFweCBzb2xpZCAjY2NjOwogICAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgIGZvbnQtc2l6ZTogMC45cmVtOwogICAgfQogICAgLmJ0bjpob3ZlciB7CiAgICAgIGJhY2tncm91bmQ6ICNmMGYwZjA7CiAgICB9CiAgICAuYnRuLXByaW1hcnkgewogICAgICBiYWNrZ3JvdW5kOiAjMmE2Y2ZmOwogICAgICBjb2xvcjogd2hpdGU7CiAgICAgIGJvcmRlci1jb2xvcjogIzJhNmNmZjsKICAgIH0KICAgIC5idG4tcHJpbWFyeTpob3ZlciB7CiAgICAgIGJhY2tncm91bmQ6ICMxYTVjZmY7CiAgICB9CiAgICAjd2FybmluZy1iYW5uZXIgewogICAgICBiYWNrZ3JvdW5kOiAjZmZmM2NkOwogICAgICBib3JkZXI6IDJweCBzb2xpZCAjZmZjMTA3OwogICAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICAgIHBhZGRpbmc6IDEycHggMTZweDsKICAgICAgbWFyZ2luOiAxNnB4OwogICAgICBtYXJnaW4tYm90dG9tOiAwOwogICAgICBmb250LXNpemU6IDAuOXJlbTsKICAgICAgY29sb3I6ICM4NTY0MDQ7CiAgICAgIGRpc3BsYXk6IG5vbmU7CiAgICB9CiAgICAjd2FybmluZy1iYW5uZXIuc2hvdyB7CiAgICAgIGRpc3BsYXk6IGJsb2NrOwogICAgfQogICAgI3dhcm5pbmctYmFubmVyIGgzIHsKICAgICAgbWFyZ2luOiAwIDAgOHB4IDA7CiAgICAgIGZvbnQtc2l6ZTogMXJlbTsKICAgICAgY29sb3I6ICM4NTY0MDQ7CiAgICB9CiAgICAjd2FybmluZy1iYW5uZXIgdWwgewogICAgICBtYXJnaW46IDhweCAwIDAgMDsKICAgICAgcGFkZGluZy1sZWZ0OiAyMHB4OwogICAgfQogICAgI3dhcm5pbmctYmFubmVyIGxpIHsKICAgICAgbWFyZ2luOiA0cHggMDsKICAgIH0KICAgIGlucHV0W3R5cGU9ImNoZWNrYm94Il06ZGlzYWJsZWQgewogICAgICBvcGFjaXR5OiAwLjU7CiAgICAgIGN1cnNvcjogbm90LWFsbG93ZWQgIWltcG9ydGFudDsKICAgIH0KICAgIGlucHV0W3R5cGU9ImNoZWNrYm94Il06ZGlzYWJsZWQgKyBzcGFuIHsKICAgICAgb3BhY2l0eTogMC42OwogICAgICBjb2xvcjogIzk5OTsKICAgIH0KICA8L3N0eWxlPgogIDwhLS0gQ2hhcnQuanMgdmlhIENETiAtLT4KICA8c2NyaXB0IHNyYz0iaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9jaGFydC5qcyI+PC9zY3JpcHQ+CjwvaGVhZD4KPGJvZHk+CiAgPGRpdiBpZD0id2FybmluZy1iYW5uZXIiPjwvZGl2PgogIDxkaXYgaWQ9ImNvbnRlbnQtd3JhcHBlciI+CiAgPGFzaWRlPgogICAgPGgxPlBsYXRlIFZpZXdlcjwvaDE+CiAgICA8bGFiZWw+U2VsZWN0IERhdGFzZXQgR3JvdXA6PC9sYWJlbD4KICAgIDxzZWxlY3QgaWQ9ImRhdGFzZXQtc2VsZWN0Ij48L3NlbGVjdD4KICAgIDxkaXYgaWQ9ImRhdGFzZXQtaW5mbyIgc3R5bGU9Im1hcmdpbi10b3A6IDE2cHg7IHBhZGRpbmc6IDEycHg7IGJhY2tncm91bmQ6IHdoaXRlOyBib3JkZXItcmFkaXVzOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGZvbnQtc2l6ZTogMC44NXJlbTsiPgogICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7Ij5EYXRhc2V0IEluZm9ybWF0aW9uPC9kaXY+CiAgICAgIDxkaXYgaWQ9ImRhdGFzZXQtZGV0YWlscyI+U2VsZWN0IGEgZGF0YXNldCB0byB2aWV3IGRldGFpbHMuPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgaWQ9ImNvbHVtbi1sZWdlbmQiIHN0eWxlPSJtYXJnaW4tdG9wOiAxNnB4OyBwYWRkaW5nOiAxMnB4OyBiYWNrZ3JvdW5kOiB3aGl0ZTsgYm9yZGVyLXJhZGl1czogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBmb250LXNpemU6IDAuODVyZW07Ij4KICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyI+U2VsZWN0IERhdGFzZXRzIGJ5IENvbHVtbjwvZGl2PgogICAgICA8ZGl2IGlkPSJjb2x1bW4tbGVnZW5kLWNvbnRlbnQiIHN0eWxlPSJmb250LXNpemU6IDAuOHJlbTsgY29sb3I6ICM2NjY7Ij5ObyBjb2x1bW4gaW5mb3JtYXRpb24gYXZhaWxhYmxlLjwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IGlkPSJ3ZWxsLXNlbGVjdG9yIiBzdHlsZT0ibWFyZ2luLXRvcDogMTZweDsgcGFkZGluZzogMTJweDsgYmFja2dyb3VuZDogd2hpdGU7IGJvcmRlci1yYWRpdXM6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsiPgogICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBjdXJzb3I6IHBvaW50ZXI7IGZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsiIG9uY2xpY2s9InRvZ2dsZVdlbGxTZWxlY3RvcigpIj4KICAgICAgICA8c3BhbiBpZD0id2VsbC1zZWxlY3Rvci1hcnJvdyIgc3R5bGU9Im1hcmdpbi1yaWdodDogOHB4OyI+4pa8PC9zcGFuPgogICAgICAgIDxzcGFuPlNlbGVjdCBXZWxscyAoY2xpY2sgdG8gZXhjbHVkZSk8L3NwYW4+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGlkPSJ3ZWxsLXNlbGVjdG9yLWdyaWQtY29udGFpbmVyIiBzdHlsZT0iZGlzcGxheTogbm9uZTsiPgogICAgICAgIDxkaXYgaWQ9IndlbGwtc2VsZWN0b3ItZ3JpZCIgc3R5bGU9ImRpc3BsYXk6IGdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczogYXV0byByZXBlYXQoMjQsIDFmcik7IGdyaWQtYXV0by1yb3dzOiAxOHB4OyBnYXA6IDFweDsgZm9udC1zaXplOiA4cHg7IG1hcmdpbi10b3A6IDhweDsiPjwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDE2cHg7IHRleHQtYWxpZ246IGNlbnRlcjsiPgogICAgICAgICAgQ2xpY2sgd2VsbHMgdG8gZXhjbHVkZSB0aGVtICjinJUgPSBleGNsdWRlZCkKICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgc3R5bGU9Im1hcmdpbi10b3A6IDE2cHg7IHBhZGRpbmc6IDEycHg7IGJhY2tncm91bmQ6IHdoaXRlOyBib3JkZXItcmFkaXVzOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7Ij4KICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyBmb250LXNpemU6IDAuOTVyZW07IGNvbG9yOiAjMzMzOyI+RGF0YSBQcm9jZXNzaW5nIFdvcmtmbG93PC9kaXY+CiAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi1ib3R0b206IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyI+CiAgICAgICAgPHN0cm9uZz5TdGVwIDE6PC9zdHJvbmc+IE5vcm1hbGl6ZSB1c2luZyBmaXR0ZWQgYmFzZWxpbmUgKGlmIGVuYWJsZWQpPGJyPgogICAgICAgIDxzdHJvbmc+U3RlcCAyOjwvc3Ryb25nPiBHcm91cCB3ZWxscyBpbnRvIHRyaXBsaWNhdGUgZ3JvdXBzIChpZiBlbmFibGVkKTxicj4KICAgICAgICA8c3Ryb25nPlN0ZXAgMzo8L3N0cm9uZz4gQ3V0b2ZmIGRhdGEgcG9pbnRzIGJlZm9yZSBmaXJzdCB0aW1lcG9pbnQgYW5kIGFmdGVyIHRpbWUgcG9pbnQgKGlmIGVuYWJsZWQpPGJyPgogICAgICAgIDxzdHJvbmc+U3RlcCA0Ojwvc3Ryb25nPiBGaXQgcmVncmVzc2lvbiBjdXJ2ZSB0byBkYXRhIHBvaW50cyAoaWYgZW5hYmxlZCkKICAgICAgPC9kaXY+CiAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgY3Vyc29yOiBwb2ludGVyOyBmb250LXNpemU6IDAuOXJlbTsiPgogICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgaWQ9Im5vcm1hbGl6ZS1iYXNlbGluZS10b2dnbGUiIHN0eWxlPSJtYXJnaW4tcmlnaHQ6IDhweDsgY3Vyc29yOiBwb2ludGVyOyIgb25jaGFuZ2U9InVwZGF0ZUNoYXJ0KCk7Ij4KICAgICAgICA8c3Bhbj48c3Ryb25nPlN0ZXAgMTo8L3N0cm9uZz4gTm9ybWFsaXplIHVzaW5nIGZpdHRlZCBiYXNlbGluZTwvc3Bhbj4KICAgICAgPC9sYWJlbD4KICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLXRvcDogNHB4OyBtYXJnaW4tYm90dG9tOiA4cHg7IG1hcmdpbi1sZWZ0OiAyNHB4OyI+CiAgICAgICAgRml0IGEgYmFzZWxpbmUgZnVuY3Rpb24gKExPV0VTUywgY29uc3RhbnQsIG9yIHBvbHlub21pYWwpIG9uIHRoZSBiYXNlbGluZSB3aW5kb3cgYW5kIG5vcm1hbGl6ZSBlYWNoIHdlbGwgdXNpbmcgdGhlIGZpdHRlZCBiYXNlbGluZS4gU2VsZWN0IG1ldGhvZCBhbmQgcGFyYW1ldGVycyBpbiB0aGUgIkJhc2VsaW5lIEZpdHRpbmcgJiBOb3JtYWxpemF0aW9uIE9wdGlvbnMiIHNlY3Rpb24gYmVsb3cuCiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGlkPSJub3JtYWxpemUtYmFzZWxpbmUtcGFyYW1ldGVycyIgc3R5bGU9ImZvbnQtc2l6ZTogMC44cmVtOyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsgZGlzcGxheTogbm9uZTsgbWFyZ2luLWxlZnQ6IDI0cHg7IG1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgPHNwYW4gc3R5bGU9Im1pbi13aWR0aDogMTIwcHg7Ij5CYXNlbGluZSB3aW5kb3cgZW5kIChzKTo8L3NwYW4+CiAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIGlkPSJub3JtYWxpemUtYmFzZWxpbmUtZW5kLXRpbWUiIHZhbHVlPSIyNCIgbWluPSIwIiBzdGVwPSIwLjEiIHN0eWxlPSJ3aWR0aDogODBweDsgcGFkZGluZzogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7IiBvbmNoYW5nZT0idXBkYXRlQ2hhcnQoKTsiPgogICAgICAgICAgPC9sYWJlbD4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiA0cHg7Ij4KICAgICAgICAgIEJhc2VsaW5lIGZpdHRpbmcgbWV0aG9kIGFuZCBub3JtYWxpemF0aW9uIG1vZGUgYXJlIHNlbGVjdGVkIGluIHRoZSAiQmFzZWxpbmUgRml0dGluZyAmIE5vcm1hbGl6YXRpb24gT3B0aW9ucyIgc2VjdGlvbiBiZWxvdy4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJjdXJyZW50LXNldHRpbmdzLWRpc3BsYXkiIHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjMzMzOyBtYXJnaW4tdG9wOiA4cHg7IHBhZGRpbmc6IDZweDsgYmFja2dyb3VuZDogI2YwZjBmMDsgYm9yZGVyLXJhZGl1czogM3B4OyBib3JkZXItbGVmdDogM3B4IHNvbGlkICMyYTZjZmY7Ij4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDRweDsgY29sb3I6ICMyYTZjZmY7Ij5DdXJyZW50IFNldHRpbmdzOjwvZGl2PgogICAgICAgICAgPGRpdiBpZD0iY3VycmVudC1zZXR0aW5ncy1jb250ZW50IiBzdHlsZT0iZm9udC1zaXplOiAwLjdyZW07IGNvbG9yOiAjNjY2OyI+CiAgICAgICAgICAgIEJhc2VsaW5lOiA8c3BhbiBpZD0iY3VycmVudC1iYXNlbGluZS1tZXRob2QiPkNvbnN0YW50PC9zcGFuPiB8IE5vcm1hbGl6YXRpb246IDxzcGFuIGlkPSJjdXJyZW50LW5vcm1hbGl6YXRpb24tbW9kZSI+TXVsdGlwbGljYXRpdmU8L3NwYW4+IHwgQ3VydmUgRml0OiA8c3BhbiBpZD0iY3VycmVudC1yZWdyZXNzaW9uLXR5cGUiPk1vbm8tZXhwb25lbnRpYWwgcGxhdGVhdTwvc3Bhbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBjdXJzb3I6IHBvaW50ZXI7IGZvbnQtc2l6ZTogMC45cmVtOyBtYXJnaW4tdG9wOiAxMnB4OyI+CiAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iZ3JvdXAtdHJpcGxpY2F0ZXMtdG9nZ2xlIiBzdHlsZT0ibWFyZ2luLXJpZ2h0OiA4cHg7IGN1cnNvcjogcG9pbnRlcjsiIG9uY2hhbmdlPSJ1cGRhdGVDaGFydCgpOyI+CiAgICAgICAgPHNwYW4+PHN0cm9uZz5TdGVwIDI6PC9zdHJvbmc+IEdyb3VwIHdlbGxzIGludG8gdHJpcGxpY2F0ZSBncm91cHM8L3NwYW4+CiAgICAgIDwvbGFiZWw+CiAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDRweDsgbWFyZ2luLWxlZnQ6IDI0cHg7Ij4KICAgICAgICBXaGVuIGVuYWJsZWQsIHdlbGxzIHRoYXQgYXJlIHBhcnQgb2YgdHJpcGxpY2F0ZSBncm91cHMgKGUuZy4sIHJvd3MgQiwgQywgRCkgYXJlIGdyb3VwZWQgdG9nZXRoZXIuIFdoZW4gZGlzYWJsZWQsIGVhY2ggd2VsbCBpcyBzaG93biBpbmRpdmlkdWFsbHkuIDxzdHJvbmc+Tm90ZTo8L3N0cm9uZz4gUmVxdWlyZXMgU3RlcCAxIChub3JtYWxpemF0aW9uKSB0byBiZSBlbmFibGVkLgogICAgICA8L2Rpdj4KICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBjdXJzb3I6IHBvaW50ZXI7IGZvbnQtc2l6ZTogMC45cmVtOyBtYXJnaW4tdG9wOiAxMnB4OyI+CiAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iY3V0b2ZmLWJhc2VsaW5lLXRvZ2dsZSIgc3R5bGU9Im1hcmdpbi1yaWdodDogOHB4OyBjdXJzb3I6IHBvaW50ZXI7IiBvbmNoYW5nZT0idXBkYXRlQ2hhcnQoKTsiPgogICAgICAgIDxzcGFuPjxzdHJvbmc+U3RlcCAzOjwvc3Ryb25nPiBDdXRvZmYgZGF0YSBwb2ludHMgYmVmb3JlIGZpcnN0IHRpbWVwb2ludCBhbmQgYWZ0ZXIgdGltZSBwb2ludDwvc3Bhbj4KICAgICAgPC9sYWJlbD4KICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLXRvcDogNHB4OyBtYXJnaW4tbGVmdDogMjRweDsiPgogICAgICAgIFdoZW4gZW5hYmxlZCwgZGF0YSBwb2ludHMgYmVmb3JlIHRoZSBmaXJzdCByZWFsIHRpbWVwb2ludCBhbmQgYWZ0ZXIgdGhlIGN1dG9mZiB0aW1lIHdpbGwgYmUgZXhjbHVkZWQgZnJvbSB0aGUgZ3JhcGggZGlzcGxheS4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgaWQ9ImN1dG9mZi1iYXNlbGluZS1wYXJhbWV0ZXJzIiBzdHlsZT0iZm9udC1zaXplOiAwLjhyZW07IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyBkaXNwbGF5OiBub25lOyBtYXJnaW4tbGVmdDogMjRweDsgbWFyZ2luLWJvdHRvbTogOHB4OyI+CiAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogOHB4OyI+CiAgICAgICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICA8c3BhbiBzdHlsZT0ibWluLXdpZHRoOiAxMjBweDsiPkN1dG9mZiB0aW1lIChzKTo8L3NwYW4+CiAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIGlkPSJjdXRvZmYtYmFzZWxpbmUtdGltZSIgdmFsdWU9IjM2MCIgbWluPSIwIiBzdGVwPSIxIiBzdHlsZT0id2lkdGg6IDgwcHg7IHBhZGRpbmc6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsgYm9yZGVyLXJhZGl1czogM3B4OyBmb250LWZhbWlseTogbW9ub3NwYWNlOyIgb25jaGFuZ2U9InVwZGF0ZUNoYXJ0KCk7Ij4KICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLXRvcDogNHB4OyI+CiAgICAgICAgICBEYXRhIHBvaW50cyBiZWZvcmUgdGhlIGZpcnN0IHJlYWwgdGltZXBvaW50IGFuZCBhZnRlciB0aGlzIHRpbWUgd2lsbCBiZSBleGNsdWRlZCAoZGVmYXVsdDogNiBtaW51dGVzID0gMzYwIHNlY29uZHMpLgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBjdXJzb3I6IHBvaW50ZXI7IGZvbnQtc2l6ZTogMC45cmVtOyBtYXJnaW4tdG9wOiAxMnB4OyI+CiAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iZml0LXJlZ3Jlc3Npb24tdG9nZ2xlIiBzdHlsZT0ibWFyZ2luLXJpZ2h0OiA4cHg7IGN1cnNvcjogcG9pbnRlcjsiIG9uY2hhbmdlPSJ1cGRhdGVSZWdyZXNzaW9uVHlwZVBhcmFtcyh0cnVlKTsgdXBkYXRlQ2hhcnQoKTsiPgogICAgICAgIDxzcGFuPjxzdHJvbmc+U3RlcCA0Ojwvc3Ryb25nPiBGaXQgcmVncmVzc2lvbiBjdXJ2ZSB0byBkYXRhIHBvaW50czwvc3Bhbj4KICAgICAgPC9sYWJlbD4KICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLXRvcDogNHB4OyBtYXJnaW4tbGVmdDogMjRweDsiPgogICAgICAgIFdoZW4gZW5hYmxlZCwgYSByZWdyZXNzaW9uIGN1cnZlIHdpbGwgYmUgZml0dGVkIHRvIHRoZSBkYXRhIHBvaW50cyBhbmQgZGlzcGxheWVkIG9uIHRoZSBncmFwaC4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgaWQ9ImZpdC1yZWdyZXNzaW9uLXBhcmFtZXRlcnMiIHN0eWxlPSJmb250LXNpemU6IDAuOHJlbTsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZjlmOWY5OyBib3JkZXItcmFkaXVzOiAzcHg7IGRpc3BsYXk6IG5vbmU7IG1hcmdpbi1sZWZ0OiAyNHB4OyBtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDE0MHB4OyI+UmVncmVzc2lvbiB0eXBlOjwvc3Bhbj4KICAgICAgICAgICAgPHNlbGVjdCBpZD0icmVncmVzc2lvbi10eXBlLXNlbGVjdCIgc3R5bGU9ImZsZXg6IDE7IHBhZGRpbmc6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsgYm9yZGVyLXJhZGl1czogM3B4OyBmb250LXNpemU6IDAuODVyZW07IiBvbmNoYW5nZT0idXBkYXRlUmVncmVzc2lvblR5cGVQYXJhbXMoKTsiPgogICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9ImxpbmVhciI+TGluZWFyPC9vcHRpb24+CiAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0icG9seW5vbWlhbCI+UG9seW5vbWlhbDwvb3B0aW9uPgogICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9ImV4cG9uZW50aWFsIj5FeHBvbmVudGlhbDwvb3B0aW9uPgogICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9ImxvZ2FyaXRobWljIj5Mb2dhcml0aG1pYzwvb3B0aW9uPgogICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9Im1vbm8tZXhwb25lbnRpYWwiIHNlbGVjdGVkPk1vbm8tZXhwb25lbnRpYWwgKHJpc2UgdG8gcGxhdGVhdSk8L29wdGlvbj4KICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICA8L2xhYmVsPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgaWQ9InJlZ3Jlc3Npb24tcG9seW5vbWlhbC1vcmRlciIgc3R5bGU9Im1hcmdpbi1ib3R0b206IDhweDsgZGlzcGxheTogbm9uZTsiPgogICAgICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgPHNwYW4gc3R5bGU9Im1pbi13aWR0aDogMTQwcHg7Ij5Qb2x5bm9taWFsIG9yZGVyOjwvc3Bhbj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9Im51bWJlciIgaWQ9InBvbHlub21pYWwtb3JkZXItaW5wdXQiIHZhbHVlPSIyIiBtaW49IjIiIG1heD0iNSIgc3RlcD0iMSIgc3R5bGU9IndpZHRoOiA4MHB4OyBwYWRkaW5nOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsiIG9uY2hhbmdlPSJ1cGRhdGVDaGFydCgpOyI+CiAgICAgICAgICA8L2xhYmVsPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDRweDsiPgogICAgICAgICAgVGhlIHJlZ3Jlc3Npb24gY3VydmUgd2lsbCBiZSBvdmVybGFpZCBvbiB0aGUgZGF0YSBwb2ludHMuCiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBpZD0icmVncmVzc2lvbi1pbmZvLXBhbmVsIiBzdHlsZT0ibWFyZ2luLXRvcDogMTJweDsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZThmNGZkOyBib3JkZXItcmFkaXVzOiAzcHg7IGJvcmRlcjogMXB4IHNvbGlkICMyYTZjZmY7IGRpc3BsYXk6IG5vbmU7Ij4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsgY29sb3I6ICMyYTZjZmY7Ij5Nb25vLWV4cG9uZW50aWFsIEZpdCBQYXJhbWV0ZXJzPC9kaXY+CiAgICAgICAgICA8ZGl2IGlkPSJyZWdyZXNzaW9uLWluZm8tY29udGVudCIgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsiPgogICAgICAgICAgICA8IS0tIFBhcmFtZXRlcnMgd2lsbCBiZSBwb3B1bGF0ZWQgaGVyZSAtLT4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBzdHlsZT0ibWFyZ2luLXRvcDogMTZweDsgcGFkZGluZzogMTJweDsgYmFja2dyb3VuZDogd2hpdGU7IGJvcmRlci1yYWRpdXM6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsiPgogICAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBjdXJzb3I6IHBvaW50ZXI7IGZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsgZm9udC1zaXplOiAwLjk1cmVtOyBjb2xvcjogIzMzMzsiIG9uY2xpY2s9InRvZ2dsZUJhc2VsaW5lT3B0aW9ucygpIj4KICAgICAgICA8c3BhbiBpZD0iYmFzZWxpbmUtb3B0aW9ucy1hcnJvdyIgc3R5bGU9Im1hcmdpbi1yaWdodDogOHB4OyI+4pa8PC9zcGFuPgogICAgICAgIDxzcGFuPkJhc2VsaW5lIEZpdHRpbmcgJiBOb3JtYWxpemF0aW9uIE9wdGlvbnM8L3NwYW4+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGlkPSJiYXNlbGluZS1vcHRpb25zLWNvbnRlbnQiIHN0eWxlPSJkaXNwbGF5OiBub25lOyBmb250LXNpemU6IDAuOHJlbTsiPgogICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE2cHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2U4ZjRmZDsgYm9yZGVyLXJhZGl1czogM3B4OyBib3JkZXI6IDFweCBzb2xpZCAjMmE2Y2ZmOyI+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7IGNvbG9yOiAjMmE2Y2ZmOyI+U2VsZWN0IEJhc2VsaW5lIEZpdHRpbmcgTWV0aG9kPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBtYXJnaW4tYm90dG9tOiA0cHg7IGZvbnQtc2l6ZTogMC44NXJlbTsiPgogICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDE0MHB4OyI+TWV0aG9kOjwvc3Bhbj4KICAgICAgICAgICAgICA8c2VsZWN0IGlkPSJiYXNlbGluZS1tZXRob2Qtc2VsZWN0IiBzdHlsZT0iZmxleDogMTsgcGFkZGluZzogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtc2l6ZTogMC44NXJlbTsiIG9uY2hhbmdlPSJ1cGRhdGVCYXNlbGluZU1ldGhvZFBhcmFtcygpOyI+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJsb3dlc3MiPkxPV0VTUzwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iY29uc3RhbnQiIHNlbGVjdGVkPkNvbnN0YW50PC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJwb2x5bm9taWFsIj5Qb2x5bm9taWFsPC9vcHRpb24+CiAgICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgaWQ9ImJhc2VsaW5lLWxvd2Vzcy1wYXJhbXMiIHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyBkaXNwbGF5OiBub25lOyI+CiAgICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNHB4OyBmb250LXNpemU6IDAuODVyZW07Ij4KICAgICAgICAgICAgICA8c3BhbiBzdHlsZT0ibWluLXdpZHRoOiAxNDBweDsiPlNtb290aGluZyBmcmFjdGlvbiAoZnJhYyk6PC9zcGFuPgogICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIGlkPSJiYXNlbGluZS1mcmFjLWlucHV0IiB2YWx1ZT0iMC41IiBtaW49IjAuMSIgbWF4PSIxLjAiIHN0ZXA9IjAuMSIgc3R5bGU9ImZsZXg6IDE7IHBhZGRpbmc6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsgYm9yZGVyLXJhZGl1czogM3B4OyBmb250LWZhbWlseTogbW9ub3NwYWNlOyBmb250LXNpemU6IDAuODVyZW07Ij4KICAgICAgICAgICAgPC9sYWJlbD4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLWxlZnQ6IDE0MHB4OyBtYXJnaW4tdG9wOiAycHg7Ij4KICAgICAgICAgICAgICBIaWdoZXIgPSBzbW9vdGhlciAoMC43LTAuOSksIExvd2VyID0gbW9yZSBsb2NhbCAoMC4yLTAuNCkKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgaWQ9ImJhc2VsaW5lLXBvbHlub21pYWwtcGFyYW1zIiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsgZGlzcGxheTogbm9uZTsiPgogICAgICAgICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDRweDsgZm9udC1zaXplOiAwLjg1cmVtOyI+CiAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9Im1pbi13aWR0aDogMTQwcHg7Ij5Qb2x5bm9taWFsIG9yZGVyOjwvc3Bhbj4KICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBpZD0iYmFzZWxpbmUtcG9seS1vcmRlci1pbnB1dCIgdmFsdWU9IjEiIG1pbj0iMSIgbWF4PSI1IiBzdGVwPSIxIiBzdHlsZT0iZmxleDogMTsgcGFkZGluZzogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7IGZvbnQtc2l6ZTogMC44NXJlbTsiPgogICAgICAgICAgICA8L2xhYmVsPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tbGVmdDogMTQwcHg7IG1hcmdpbi10b3A6IDJweDsiPgogICAgICAgICAgICAgIDEgPSBsaW5lYXIsIDIgPSBxdWFkcmF0aWMsIDMrID0gaGlnaGVyIG9yZGVyCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTZweDsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZThmNGZkOyBib3JkZXItcmFkaXVzOiAzcHg7IGJvcmRlcjogMXB4IHNvbGlkICMyYTZjZmY7Ij4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsgY29sb3I6ICMyYTZjZmY7Ij5TZWxlY3QgTm9ybWFsaXphdGlvbiBNZXRob2Q8L2Rpdj4KICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNHB4OyBmb250LXNpemU6IDAuODVyZW07Ij4KICAgICAgICAgICAgICA8c3BhbiBzdHlsZT0ibWluLXdpZHRoOiAxNDBweDsiPk5vcm1hbGl6YXRpb24gbW9kZTo8L3NwYW4+CiAgICAgICAgICAgICAgPHNlbGVjdCBpZD0ibm9ybWFsaXphdGlvbi1tb2RlLXNlbGVjdCIgc3R5bGU9ImZsZXg6IDE7IHBhZGRpbmc6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsgYm9yZGVyLXJhZGl1czogM3B4OyBmb250LXNpemU6IDAuODVyZW07IiBvbmNoYW5nZT0idXBkYXRlQ3VycmVudFNldHRpbmdzRGlzcGxheSgpOyI+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJkZWx0YV9mX292ZXJfZiI+zpRGL0YgKERlbHRhIEYgb3ZlciBGKTwvb3B0aW9uPgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibXVsdGlwbGljYXRpdmUiIHNlbGVjdGVkPk11bHRpcGxpY2F0aXZlPC9vcHRpb24+CiAgICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNnB4OyI+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7IGNvbG9yOiAjMmE2Y2ZmOyI+QmFzZWxpbmUgRml0dGluZyBNZXRob2RzPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxMnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4xLiBMT1dFU1MgKExvY2FsbHkgV2VpZ2h0ZWQgU2NhdHRlcnBsb3QgU21vb3RoaW5nKTwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5Gb3JtdWxhOjwvc3Ryb25nPiBnKHQpID0gTE9XRVNTKEZfYmFzZWxpbmUsIHRfYmFzZWxpbmUsIGZyYWMpCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5XaGVuIHRvIHVzZTo8L3N0cm9uZz4gQmFzZWxpbmUgaGFzIGdyYWR1YWwgZHJpZnQgb3Igbm9uLWxpbmVhciB0cmVuZHMKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkJlc3QgZm9yOjwvc3Ryb25nPiBOb24tbGluZWFyIGJhc2VsaW5lcyB3aXRoIHNtb290aCB0cmVuZHMKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPlBhcmFtZXRlcnM6PC9zdHJvbmc+CiAgICAgICAgICAgICAgPHVsIHN0eWxlPSJtYXJnaW46IDRweCAwIDAgMjBweDsgcGFkZGluZy1sZWZ0OiAwOyI+CiAgICAgICAgICAgICAgICA8bGk+PHN0cm9uZz5mcmFjOjwvc3Ryb25nPiBGcmFjdGlvbiBvZiBkYXRhIHVzZWQgZm9yIHNtb290aGluZyAoZGVmYXVsdDogMC41KQogICAgICAgICAgICAgICAgICA8dWwgc3R5bGU9Im1hcmdpbjogMnB4IDAgMCAyMHB4OyBwYWRkaW5nLWxlZnQ6IDA7Ij4KICAgICAgICAgICAgICAgICAgICA8bGk+SGlnaGVyIGZyYWMgKDAuNy0wLjkpID0gc21vb3RoZXIsIG1vcmUgZ2xvYmFsIGZpdDwvbGk+CiAgICAgICAgICAgICAgICAgICAgPGxpPkxvd2VyIGZyYWMgKDAuMi0wLjQpID0gbW9yZSBsb2NhbCwgZm9sbG93cyBkYXRhIGNsb3NlbHk8L2xpPgogICAgICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICAgICAgPC9saT4KICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTJweDsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZjlmOWY5OyBib3JkZXItcmFkaXVzOiAzcHg7Ij4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+Mi4gQ09OU1RBTlQgKDB0aC1vcmRlciBwb2x5bm9taWFsKTwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5Gb3JtdWxhOjwvc3Ryb25nPiBnKHQpID0gbWVhbihGX2Jhc2VsaW5lKSBmb3IgYWxsIHQKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPldoZW4gdG8gdXNlOjwvc3Ryb25nPiBCYXNlbGluZSBpcyBzdGFibGUvZmxhdCB3aXRoIG1pbmltYWwgZHJpZnQKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkJlc3QgZm9yOjwvc3Ryb25nPiBTdGFibGUgYmFzZWxpbmVzIHdpdGggbm8gdGltZS1kZXBlbmRlbnQgdHJlbmRzCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+UGFyYW1ldGVyczo8L3N0cm9uZz4gTm9uZQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTJweDsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZjlmOWY5OyBib3JkZXItcmFkaXVzOiAzcHg7Ij4KICAgICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+My4gUE9MWU5PTUlBTCAoMXN0LW9yZGVyIG9yIGhpZ2hlcik8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+Rm9ybXVsYTo8L3N0cm9uZz4gZyh0KSA9IGPigoAgKyBj4oKBdCArIGPigoJ0wrIgKyAuLi4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPldoZW4gdG8gdXNlOjwvc3Ryb25nPiBCYXNlbGluZSBoYXMgbGluZWFyIG9yIHBvbHlub21pYWwgZHJpZnQKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkJlc3QgZm9yOjwvc3Ryb25nPiBCYXNlbGluZXMgd2l0aCBrbm93biBwb2x5bm9taWFsIHRyZW5kcwogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+UGFyYW1ldGVyczo8L3N0cm9uZz4KICAgICAgICAgICAgICA8dWwgc3R5bGU9Im1hcmdpbjogNHB4IDAgMCAyMHB4OyBwYWRkaW5nLWxlZnQ6IDA7Ij4KICAgICAgICAgICAgICAgIDxsaT48c3Ryb25nPnBvbHlfb3JkZXI6PC9zdHJvbmc+IFBvbHlub21pYWwgb3JkZXIgKGRlZmF1bHQ6IDEgPSBsaW5lYXIpCiAgICAgICAgICAgICAgICAgIDx1bCBzdHlsZT0ibWFyZ2luOiAycHggMCAwIDIwcHg7IHBhZGRpbmctbGVmdDogMDsiPgogICAgICAgICAgICAgICAgICAgIDxsaT5PcmRlciAxOiBMaW5lYXIgZHJpZnQgKGcodCkgPSBj4oKAICsgY+KCgXQpPC9saT4KICAgICAgICAgICAgICAgICAgICA8bGk+T3JkZXIgMjogUXVhZHJhdGljIGRyaWZ0IChnKHQpID0gY+KCgCArIGPigoF0ICsgY+KCgnTCsik8L2xpPgogICAgICAgICAgICAgICAgICAgIDxsaT5IaWdoZXIgb3JkZXJzOiBNb3JlIGNvbXBsZXggdHJlbmRzPC9saT4KICAgICAgICAgICAgICAgICAgPC91bD4KICAgICAgICAgICAgICAgIDwvbGk+CiAgICAgICAgICAgICAgPC91bD4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNnB4OyI+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7IGNvbG9yOiAjMmE2Y2ZmOyI+Tm9ybWFsaXphdGlvbiBNZXRob2RzPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxMnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4xLiBERUxUQV9GX09WRVJfRiAozpRGL0YpPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkZvcm11bGE6PC9zdHJvbmc+IEYnKHQpID0gKEYodCkgLSBnKHQpKSAvIGcodCkKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPldoZW4gdG8gdXNlOjwvc3Ryb25nPiBNZWFzdXJlIHJlbGF0aXZlIGNoYW5nZSBmcm9tIGJhc2VsaW5lCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5CZXN0IGZvcjo8L3N0cm9uZz4gRGV0ZWN0aW5nIGluY3JlYXNlcy9kZWNyZWFzZXMgcmVsYXRpdmUgdG8gYmFzZWxpbmUKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkludGVycHJldGF0aW9uOjwvc3Ryb25nPgogICAgICAgICAgICAgIDx1bCBzdHlsZT0ibWFyZ2luOiA0cHggMCAwIDIwcHg7IHBhZGRpbmctbGVmdDogMDsiPgogICAgICAgICAgICAgICAgPGxpPkYnKHQpID0gMDogTm8gY2hhbmdlIGZyb20gYmFzZWxpbmU8L2xpPgogICAgICAgICAgICAgICAgPGxpPkYnKHQpID4gMDogSW5jcmVhc2UgYWJvdmUgYmFzZWxpbmUgKGUuZy4sIDAuNSA9IDUwJSUgaW5jcmVhc2UpPC9saT4KICAgICAgICAgICAgICAgIDxsaT5GJyh0KSA8IDA6IERlY3JlYXNlIGJlbG93IGJhc2VsaW5lIChlLmcuLCAtMC4zID0gMzAlJSBkZWNyZWFzZSk8L2xpPgogICAgICAgICAgICAgIDwvdWw+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsiPgogICAgICAgICAgICAgIFZhbHVlcyBjYW4gYmUgbmVnYXRpdmUgKGJlbG93IGJhc2VsaW5lKSBvciBwb3NpdGl2ZSAoYWJvdmUgYmFzZWxpbmUpCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxMnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4yLiBNVUxUSVBMSUNBVElWRTwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5Gb3JtdWxhOjwvc3Ryb25nPiBGX25vcm0odCkgPSBGKHQpIC8gZyh0KQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+V2hlbiB0byB1c2U6PC9zdHJvbmc+IE5vcm1hbGl6ZSBieSBiYXNlbGluZSB3aXRob3V0IHN1YnRyYWN0aW5nCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5CZXN0IGZvcjo8L3N0cm9uZz4gRm9sZC1jaGFuZ2UgYW5hbHlzaXMKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkludGVycHJldGF0aW9uOjwvc3Ryb25nPgogICAgICAgICAgICAgIDx1bCBzdHlsZT0ibWFyZ2luOiA0cHggMCAwIDIwcHg7IHBhZGRpbmctbGVmdDogMDsiPgogICAgICAgICAgICAgICAgPGxpPkZfbm9ybSh0KSA9IDEuMDogTm8gY2hhbmdlIGZyb20gYmFzZWxpbmU8L2xpPgogICAgICAgICAgICAgICAgPGxpPkZfbm9ybSh0KSA9IDIuMDogMi1mb2xkIGluY3JlYXNlICgxMDAlJSBpbmNyZWFzZSk8L2xpPgogICAgICAgICAgICAgICAgPGxpPkZfbm9ybSh0KSA9IDAuNTogMi1mb2xkIGRlY3JlYXNlICg1MCUlIG9mIGJhc2VsaW5lKTwvbGk+CiAgICAgICAgICAgICAgPC91bD4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyI+CiAgICAgICAgICAgICAgVmFsdWVzIGFyZSBhbHdheXMgcG9zaXRpdmUgKHJhdGlvIHRvIGJhc2VsaW5lKQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7IGNvbG9yOiAjMmE2Y2ZmOyI+U3RhdGlzdGljcyBDb21wdXRhdGlvbjwvZGl2PgogICAgICAgICAgPGRpdiBzdHlsZT0icGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZjlmOWY5OyBib3JkZXItcmFkaXVzOiAzcHg7Ij4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogOHB4OyI+CiAgICAgICAgICAgICAgRm9yIGVhY2ggY29uZGl0aW9uIGFuZCB0aW1lcG9pbnQsIHRoZSBmb2xsb3dpbmcgc3RhdGlzdGljcyBhcmUgY29tcHV0ZWQ6CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA2cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPk1lYW46PC9zdHJvbmc+IM68KHQpID0gKDEvbikgw5cgzqMgRicodCkKICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsiPgogICAgICAgICAgICAgICAgQXZlcmFnZSBub3JtYWxpemVkIHZhbHVlIGFjcm9zcyBhbGwgd2VsbHMgaW4gdGhlIGNvbmRpdGlvbgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogNnB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5TRDo8L3N0cm9uZz4gz4ModCkgPSBzcXJ0KM6jKEYnKHQpIC0gzrwodCkpwrIgLyAobi0xKSkKICAgICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsiPgogICAgICAgICAgICAgICAgU2FtcGxlIHN0YW5kYXJkIGRldmlhdGlvbiAoZGRvZj0xKSBhY3Jvc3Mgd2VsbHMKICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgPHN0cm9uZz5TRU06PC9zdHJvbmc+IFNFTSh0KSA9IM+DKHQpIC8gc3FydChuKQogICAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyI+CiAgICAgICAgICAgICAgICBTdGFuZGFyZCBlcnJvciBvZiB0aGUgbWVhbiA9IFNEIC8gc3FydChuX3dlbGxzKQogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiA0cHg7Ij4KICAgICAgICAgICAgICAgIDxzdHJvbmc+Tm90ZTo8L3N0cm9uZz4gU0VNIGlzIGNvbXB1dGVkIGFjcm9zcyB3ZWxscywgbm90IHByb3BhZ2F0ZWQgZnJvbSBiYXNlbGluZSBlcnJvcgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGJ0bi1wcmltYXJ5IiBvbmNsaWNrPSJ1cGRhdGVDaGFydCgpIiBzdHlsZT0ibWFyZ2luLXRvcDogMTZweDsiPlVwZGF0ZSBDaGFydDwvYnV0dG9uPgogICAgPGJ1dHRvbiBjbGFzcz0iYnRuIiBvbmNsaWNrPSJjbGVhclNlbGVjdGlvbigpIj5DbGVhciBTZWxlY3Rpb248L2J1dHRvbj4KICAgIDxkaXYgaWQ9IndlbGwtaW5mbyIgc3R5bGU9Im1hcmdpbi10b3A6IDE2cHg7Ij5DbGljayB3ZWxscyBvbiB0aGUgcGxhdGUgdG8gYWRkIHRoZW0gdG8gdGhlIGNoYXJ0LjwvZGl2PgogIDwvYXNpZGU+CiAgPG1haW4+CiAgICA8ZGl2IGlkPSJwbGF0ZS1ncmlkIj48L2Rpdj4KICAgIDxkaXYgaWQ9ImNoYXJ0LWNvbnRhaW5lciI+CiAgICAgIDxjYW52YXMgaWQ9IndlbGwtY2hhcnQiPjwvY2FudmFzPgogICAgPC9kaXY+CiAgPC9tYWluPgogIDwvZGl2PgoKPHNjcmlwdD4KY29uc3QgUExBVEVfUk9XUyA9ICIlKHJvd3MpcyIuc3BsaXQoIiIpOwpjb25zdCBQTEFURV9DT0xTID0gJShjb2xzKWQ7CgpsZXQgdmlld2VyRGF0YSA9IG51bGw7CmxldCBjaGFydCA9IG51bGw7CmxldCBzZWxlY3RlZFdlbGxzID0gbmV3IFNldCgpOyAvLyBTZXQgb2Yge3BsYXRlSWQ6d2VsbElkfSBzdHJpbmdzCmxldCBhbGxXZWxsc0RhdGEgPSB7fTsgLy8gQ29tYmluZWQgd2VsbHMgZnJvbSBhbGwgcGxhdGVzOiB7cGxhdGVJZDoge3dlbGxJZDogey4uLn19fQpsZXQgc2VsZWN0ZWREYXRhc2V0SWQgPSBudWxsOyAvLyBDdXJyZW50bHkgc2VsZWN0ZWQgZGF0YXNldCBJRApsZXQgZW5hYmxlZERhdGFzZXRzID0gbmV3IFNldCgpOyAvLyBTZXQgb2YgZW5hYmxlZCBkYXRhc2V0IElEcyAoZW1wdHkgPSBhbGwgZW5hYmxlZCkKbGV0IGVuYWJsZWRXZWxscyA9IG5ldyBTZXQoKTsgLy8gU2V0IG9mIGVuYWJsZWQgd2VsbCBJRHMgKGVtcHR5ID0gYWxsIGVuYWJsZWQpCmxldCBlbmFibGVkQ29sdW1ucyA9IG5ldyBTZXQoKTsgLy8gU2V0IG9mIGVuYWJsZWQgY29sdW1uIG51bWJlcnMgKGVtcHR5ID0gYWxsIGVuYWJsZWQpCgovLyBSZWdpc3RlciBlcnJvciBiYXIgcGx1Z2luIGdsb2JhbGx5CkNoYXJ0LnJlZ2lzdGVyKHsKICBpZDogImVycm9yQmFycyIsCiAgYWZ0ZXJEYXRhc2V0c0RyYXc6IChjaGFydCkgPT4gewogICAgY29uc3QgY3R4ID0gY2hhcnQuY3R4OwogICAgY2hhcnQuZGF0YS5kYXRhc2V0cy5mb3JFYWNoKChkYXRhc2V0LCBkYXRhc2V0SW5kZXgpID0+IHsKICAgICAgaWYgKCFkYXRhc2V0LmRhdGEgfHwgZGF0YXNldC5kYXRhLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwogICAgICAKICAgICAgLy8gQ2hlY2sgaWYgYW55IGRhdGEgcG9pbnQgaGFzIGVycm9yIGluZm9ybWF0aW9uCiAgICAgIGNvbnN0IGhhc0Vycm9ycyA9IGRhdGFzZXQuZGF0YS5zb21lKGQgPT4gZCAmJiBkLmVycm9yICE9PSB1bmRlZmluZWQgJiYgZC5lcnJvciAhPT0gbnVsbCk7CiAgICAgIGlmICghaGFzRXJyb3JzKSByZXR1cm47CiAgICAgIAogICAgICBjb25zdCBtZXRhID0gY2hhcnQuZ2V0RGF0YXNldE1ldGEoZGF0YXNldEluZGV4KTsKICAgICAgY3R4LnNhdmUoKTsKICAgICAgY3R4LnN0cm9rZVN0eWxlID0gZGF0YXNldC5ib3JkZXJDb2xvciB8fCAicmdiYSgwLDAsMCwwLjUpIjsKICAgICAgY3R4LmxpbmVXaWR0aCA9IDE7CiAgICAgIAogICAgICBtZXRhLmRhdGEuZm9yRWFjaCgocG9pbnQsIGluZGV4KSA9PiB7CiAgICAgICAgaWYgKCFwb2ludCB8fCAhZGF0YXNldC5kYXRhW2luZGV4XSB8fCBkYXRhc2V0LmRhdGFbaW5kZXhdLmVycm9yID09PSB1bmRlZmluZWQgfHwgZGF0YXNldC5kYXRhW2luZGV4XS5lcnJvciA9PT0gbnVsbCkgcmV0dXJuOwogICAgICAgIAogICAgICAgIGNvbnN0IHggPSBwb2ludC54OwogICAgICAgIGNvbnN0IHkgPSBwb2ludC55OwogICAgICAgIGNvbnN0IGVycm9yID0gZGF0YXNldC5kYXRhW2luZGV4XS5lcnJvcjsKICAgICAgICBjb25zdCB5U2NhbGUgPSBjaGFydC5zY2FsZXMueTsKICAgICAgICBjb25zdCBlcnJvclBpeGVscyA9IE1hdGguYWJzKHlTY2FsZS5nZXRQaXhlbEZvclZhbHVlKHkgKyBlcnJvcikgLSB5U2NhbGUuZ2V0UGl4ZWxGb3JWYWx1ZSh5KSk7CiAgICAgICAgCiAgICAgICAgLy8gRHJhdyB2ZXJ0aWNhbCBlcnJvciBiYXIKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyh4LCB5IC0gZXJyb3JQaXhlbHMpOwogICAgICAgIGN0eC5saW5lVG8oeCwgeSArIGVycm9yUGl4ZWxzKTsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgCiAgICAgICAgLy8gRHJhdyBob3Jpem9udGFsIGNhcHMKICAgICAgICBjb25zdCBjYXBXaWR0aCA9IDQ7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oeCAtIGNhcFdpZHRoLCB5IC0gZXJyb3JQaXhlbHMpOwogICAgICAgIGN0eC5saW5lVG8oeCArIGNhcFdpZHRoLCB5IC0gZXJyb3JQaXhlbHMpOwogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyh4IC0gY2FwV2lkdGgsIHkgKyBlcnJvclBpeGVscyk7CiAgICAgICAgY3R4LmxpbmVUbyh4ICsgY2FwV2lkdGgsIHkgKyBlcnJvclBpeGVscyk7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICB9KTsKICAgICAgCiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICB9KTsKICB9Cn0pOwoKLy8gUmVnaXN0ZXIgYmFzZWxpbmUgbGFiZWwgcGx1Z2luIHRvIGRpc3BsYXkgYmFzZWxpbmUgbnVtYmVycyBvbiB0aGUgY2hhcnQKQ2hhcnQucmVnaXN0ZXIoewogIGlkOiAiYmFzZWxpbmVMYWJlbHMiLAogIGFmdGVyRGF0YXNldHNEcmF3OiAoY2hhcnQpID0+IHsKICAgIGNvbnN0IGN0eCA9IGNoYXJ0LmN0eDsKICAgIGNvbnN0IHhTY2FsZSA9IGNoYXJ0LnNjYWxlcy54OwogICAgY29uc3QgeVNjYWxlID0gY2hhcnQuc2NhbGVzLnk7CiAgICAKICAgIGNoYXJ0LmRhdGEuZGF0YXNldHMuZm9yRWFjaCgoZGF0YXNldCwgZGF0YXNldEluZGV4KSA9PiB7CiAgICAgIC8vIE9ubHkgcHJvY2VzcyBiYXNlbGluZSBsaW5lcyAoaWRlbnRpZmllZCBieSBoYXZpbmcgZXhhY3RseSAyIHBvaW50cyBhbmQgb3JkZXIgPT09IDEwMDApCiAgICAgIGlmICghZGF0YXNldC5kYXRhIHx8IGRhdGFzZXQuZGF0YS5sZW5ndGggIT09IDIgfHwgZGF0YXNldC5vcmRlciAhPT0gMTAwMCkgcmV0dXJuOwogICAgICAKICAgICAgLy8gRXh0cmFjdCBiYXNlbGluZSB2YWx1ZSBmcm9tIGxhYmVsIChmb3JtYXQ6ICJsYWJlbCAoYmFzZWxpbmU6IHZhbHVlKSIpCiAgICAgIGNvbnN0IGJhc2VsaW5lTWF0Y2ggPSBkYXRhc2V0LmxhYmVsLm1hdGNoKC9cKGJhc2VsaW5lOlxzKihbXGQuXSspXCkvKTsKICAgICAgaWYgKCFiYXNlbGluZU1hdGNoKSByZXR1cm47CiAgICAgIAogICAgICBjb25zdCBiYXNlbGluZVZhbHVlID0gcGFyc2VGbG9hdChiYXNlbGluZU1hdGNoWzFdKTsKICAgICAgaWYgKGlzTmFOKGJhc2VsaW5lVmFsdWUpKSByZXR1cm47CiAgICAgIAogICAgICAvLyBHZXQgdGhlIHkgcG9zaXRpb24gb2YgdGhlIGJhc2VsaW5lCiAgICAgIGNvbnN0IGJhc2VsaW5lWSA9IGRhdGFzZXQuZGF0YVswXS55OwogICAgICBjb25zdCB5UGl4ZWwgPSB5U2NhbGUuZ2V0UGl4ZWxGb3JWYWx1ZShiYXNlbGluZVkpOwogICAgICAKICAgICAgLy8gUG9zaXRpb24gdGV4dCBhdCB0aGUgcmlnaHQgZWRnZSBvZiB0aGUgY2hhcnQsIHNsaWdodGx5IG9mZnNldCBmcm9tIHRoZSBsaW5lCiAgICAgIGNvbnN0IGNoYXJ0QXJlYSA9IGNoYXJ0LmNoYXJ0QXJlYTsKICAgICAgY29uc3QgdGV4dFggPSBjaGFydEFyZWEucmlnaHQgLSAxMDsgLy8gMTBweCBmcm9tIHJpZ2h0IGVkZ2UKICAgICAgY29uc3QgdGV4dFkgPSB5UGl4ZWwgLSA1OyAvLyA1cHggYWJvdmUgdGhlIGxpbmUKICAgICAgCiAgICAgIGN0eC5zYXZlKCk7CiAgICAgIGN0eC5mb250ID0gIjEycHggQXJpYWwiOwogICAgICBjdHguZmlsbFN0eWxlID0gZGF0YXNldC5ib3JkZXJDb2xvciB8fCAicmdiYSgxMjgsIDEyOCwgMTI4LCAwLjcpIjsKICAgICAgY3R4LnRleHRBbGlnbiA9ICJyaWdodCI7CiAgICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAiYm90dG9tIjsKICAgICAgCiAgICAgIC8vIERyYXcgYmFja2dyb3VuZCByZWN0YW5nbGUgZm9yIGJldHRlciByZWFkYWJpbGl0eQogICAgICBjb25zdCB0ZXh0ID0gYmFzZWxpbmVWYWx1ZS50b0ZpeGVkKDIpOwogICAgICBjb25zdCB0ZXh0TWV0cmljcyA9IGN0eC5tZWFzdXJlVGV4dCh0ZXh0KTsKICAgICAgY29uc3QgcGFkZGluZyA9IDQ7CiAgICAgIGN0eC5maWxsU3R5bGUgPSAicmdiYSgyNTUsIDI1NSwgMjU1LCAwLjgpIjsKICAgICAgY3R4LmZpbGxSZWN0KAogICAgICAgIHRleHRYIC0gdGV4dE1ldHJpY3Mud2lkdGggLSBwYWRkaW5nLAogICAgICAgIHRleHRZIC0gMTIgLSBwYWRkaW5nLAogICAgICAgIHRleHRNZXRyaWNzLndpZHRoICsgcGFkZGluZyAqIDIsCiAgICAgICAgMTIgKyBwYWRkaW5nICogMgogICAgICApOwogICAgICAKICAgICAgLy8gRHJhdyB0aGUgdGV4dAogICAgICBjdHguZmlsbFN0eWxlID0gZGF0YXNldC5ib3JkZXJDb2xvciB8fCAicmdiYSgxMjgsIDEyOCwgMTI4LCAwLjkpIjsKICAgICAgY3R4LmZpbGxUZXh0KHRleHQsIHRleHRYLCB0ZXh0WSk7CiAgICAgIAogICAgICBjdHgucmVzdG9yZSgpOwogICAgfSk7CiAgfQp9KTsKCmZ1bmN0aW9uIGRpc3BsYXlXYXJuaW5ncygpIHsKICBjb25zdCB3YXJuaW5nQmFubmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIndhcm5pbmctYmFubmVyIik7CiAgaWYgKCF3YXJuaW5nQmFubmVyIHx8ICF2aWV3ZXJEYXRhIHx8ICF2aWV3ZXJEYXRhLmNvbmZpZykgewogICAgcmV0dXJuOwogIH0KICAKICBjb25zdCB3YXJuaW5ncyA9IHZpZXdlckRhdGEuY29uZmlnLndhcm5pbmdzIHx8IHt9OwogIGNvbnN0IGR1cGxpY2F0ZUNvbHVtbnMgPSB3YXJuaW5ncy5kdXBsaWNhdGVfY29sdW1ucyB8fCBbXTsKICAKICBpZiAoZHVwbGljYXRlQ29sdW1ucy5sZW5ndGggPT09IDApIHsKICAgIHdhcm5pbmdCYW5uZXIuY2xhc3NMaXN0LnJlbW92ZSgic2hvdyIpOwogICAgcmV0dXJuOwogIH0KICAKICAvLyBCdWlsZCB3YXJuaW5nIG1lc3NhZ2UgLSBzaG9ydGVyIHZlcnNpb24KICBsZXQgaHRtbCA9ICc8aDM+4pqg77iPIFdhcm5pbmc6IER1cGxpY2F0ZSBXZWxscyBEZXRlY3RlZDwvaDM+JzsKICAKICBkdXBsaWNhdGVDb2x1bW5zLmZvckVhY2god2FybmluZyA9PiB7CiAgICBjb25zdCBmaWxlcyA9IHdhcm5pbmcuZmlsZXMgfHwgW107CiAgICBjb25zdCB3ZWxsSWRzID0gd2FybmluZy53ZWxsX2lkcyB8fCBbXTsKICAgIGNvbnN0IGZpbGVzU3RyID0gZmlsZXMuam9pbigiIGFuZCAiKTsKICAgIGNvbnN0IHdlbGxzU3RyID0gd2VsbElkcy5sZW5ndGggPD0gMTAgCiAgICAgID8gd2VsbElkcy5qb2luKCIsICIpCiAgICAgIDogd2VsbElkcy5zbGljZSgwLCAxMCkuam9pbigiLCAiKSArIGAsIC4uLiAoJHt3ZWxsSWRzLmxlbmd0aH0gdG90YWwpYDsKICAgIAogICAgaHRtbCArPSBgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogOHB4OyI+PHN0cm9uZz4ke2ZpbGVzU3RyfTwvc3Ryb25nPiBoYXZlIGR1cGxpY2F0ZSB3ZWxsczogJHt3ZWxsc1N0cn08L2Rpdj5gOwogICAgaHRtbCArPSBgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDE2cHg7IGZvbnQtc2l6ZTogMC44NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi1ib3R0b206IDEycHg7Ij5Pbmx5IGRhdGEgZnJvbSAnPHN0cm9uZz4ke2ZpbGVzWzBdfTwvc3Ryb25nPicgKGZpcnN0IGFscGhhYmV0aWNhbGx5KSBpcyB1c2VkLjwvZGl2PmA7CiAgfSk7CiAgCiAgd2FybmluZ0Jhbm5lci5pbm5lckhUTUwgPSBodG1sOwogIHdhcm5pbmdCYW5uZXIuY2xhc3NMaXN0LmFkZCgic2hvdyIpOwp9Cgphc3luYyBmdW5jdGlvbiBsb2FkRGF0YSgpIHsKICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaCgidmlld2VyX2RhdGEuanNvbiIpOwogIHZpZXdlckRhdGEgPSBhd2FpdCByZXMuanNvbigpOwogIGNvbWJpbmVBbGxXZWxscygpOwogIC8vIEluaXRpYWxpemUgdHJpcGxpY2F0ZSBncm91cCBjb2xvcnMgYmVmb3JlIHJlbmRlcmluZwogIGluaXRpYWxpemVUcmlwbGljYXRlR3JvdXBDb2xvcnMoKTsKICBkaXNwbGF5V2FybmluZ3MoKTsKICBpbml0RGF0YXNldFNlbGVjdCgpOwogIHJlbmRlclBsYXRlR3JpZCgpOwp9CgpmdW5jdGlvbiBjb21iaW5lQWxsV2VsbHMoKSB7CiAgLy8gQ29tYmluZSBhbGwgd2VsbHMgZnJvbSBhbGwgcGxhdGVzIGludG8gYSBzaW5nbGUgc3RydWN0dXJlCiAgYWxsV2VsbHNEYXRhID0ge307CiAgdmlld2VyRGF0YS5wbGF0ZXMuZm9yRWFjaChwbGF0ZSA9PiB7CiAgICBhbGxXZWxsc0RhdGFbcGxhdGUuaWRdID0gcGxhdGUud2VsbHM7CiAgfSk7Cn0KCmZ1bmN0aW9uIGluaXREYXRhc2V0U2VsZWN0KCkgewogIGNvbnN0IHNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJkYXRhc2V0LXNlbGVjdCIpOwogIHNlbGVjdC5pbm5lckhUTUwgPSAiIjsKICAKICAvLyBHcm91cCBwbGF0ZXMgYnkgY29sdW1uX2dyb3VwCiAgY29uc3QgcGxhdGVzQnlHcm91cCA9IHt9OwogIHZpZXdlckRhdGEucGxhdGVzLmZvckVhY2gocGxhdGUgPT4gewogICAgY29uc3QgZ3JvdXAgPSBwbGF0ZS5jb2x1bW5fZ3JvdXAgfHwgIk90aGVyIjsKICAgIGlmICghcGxhdGVzQnlHcm91cFtncm91cF0pIHsKICAgICAgcGxhdGVzQnlHcm91cFtncm91cF0gPSBbXTsKICAgIH0KICAgIHBsYXRlc0J5R3JvdXBbZ3JvdXBdLnB1c2gocGxhdGUpOwogIH0pOwogIAogIC8vIFNvcnQgZ3JvdXBzIGFscGhhYmV0aWNhbGx5CiAgY29uc3Qgc29ydGVkR3JvdXBzID0gT2JqZWN0LmtleXMocGxhdGVzQnlHcm91cCkuc29ydCgpOwogIAogIC8vIENyZWF0ZSBvcHRpb25zIGZvciBlYWNoIGdyb3VwICh0aGUgZ3JvdXAgaXRzZWxmIGlzIHNlbGVjdGFibGUpCiAgc29ydGVkR3JvdXBzLmZvckVhY2goZ3JvdXBOYW1lID0+IHsKICAgIGNvbnN0IHBsYXRlcyA9IHBsYXRlc0J5R3JvdXBbZ3JvdXBOYW1lXTsKICAgIAogICAgY29uc3Qgb3B0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0aW9uIik7CiAgICAvLyBVc2Ugc3BlY2lhbCBwcmVmaXggdG8gaWRlbnRpZnkgZ3JvdXAgc2VsZWN0aW9ucwogICAgb3B0aW9uLnZhbHVlID0gYGdyb3VwOiR7Z3JvdXBOYW1lfWA7CiAgICAKICAgIC8vIENyZWF0ZSBmcmllbmRseSBuYW1lIGZyb20gZmlyc3QgcGxhdGUncyBjb2x1bW4gaW5mbwogICAgY29uc3QgZmlyc3RQbGF0ZSA9IHBsYXRlc1swXTsKICAgIGNvbnN0IGNvbHVtbkluZm8gPSBmaXJzdFBsYXRlLmNvbHVtbl9pbmZvIHx8IHt9OwogICAgY29uc3QgcGFydHMgPSBbXTsKICAgIGlmIChjb2x1bW5JbmZvLnByb3RlaW4pIHBhcnRzLnB1c2goY29sdW1uSW5mby5wcm90ZWluKTsKICAgIGlmIChjb2x1bW5JbmZvLmdlbm90eXBlKSBwYXJ0cy5wdXNoKGNvbHVtbkluZm8uZ2Vub3R5cGUpOwogICAgaWYgKGNvbHVtbkluZm8uYnVmZmVyKSBwYXJ0cy5wdXNoKGNvbHVtbkluZm8uYnVmZmVyKTsKICAgIAogICAgLy8gQWRkIGNvdW50IGlmIG11bHRpcGxlIGRhdGFzZXRzCiAgICBpZiAocGxhdGVzLmxlbmd0aCA+IDEpIHsKICAgICAgb3B0aW9uLnRleHRDb250ZW50ID0gcGFydHMubGVuZ3RoID4gMCAKICAgICAgICA/IGAke3BhcnRzLmpvaW4oIiAtICIpfSAoJHtwbGF0ZXMubGVuZ3RofSBkYXRhc2V0cylgCiAgICAgICAgOiBgJHtncm91cE5hbWV9ICgke3BsYXRlcy5sZW5ndGh9IGRhdGFzZXRzKWA7CiAgICB9IGVsc2UgewogICAgICBvcHRpb24udGV4dENvbnRlbnQgPSBwYXJ0cy5sZW5ndGggPiAwIAogICAgICAgID8gcGFydHMuam9pbigiIC0gIikKICAgICAgICA6IGdyb3VwTmFtZTsKICAgIH0KICAgIAogICAgc2VsZWN0LmFwcGVuZENoaWxkKG9wdGlvbik7CiAgfSk7CiAgCiAgLy8gU2VsZWN0IGZpcnN0IGdyb3VwIGJ5IGRlZmF1bHQKICBpZiAoc29ydGVkR3JvdXBzLmxlbmd0aCA+IDApIHsKICAgIHNlbGVjdGVkRGF0YXNldElkID0gYGdyb3VwOiR7c29ydGVkR3JvdXBzWzBdfWA7CiAgICBzZWxlY3QudmFsdWUgPSBzZWxlY3RlZERhdGFzZXRJZDsKICB9CiAgCiAgc2VsZWN0LmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsICgpID0+IHsKICAgIHNlbGVjdGVkRGF0YXNldElkID0gc2VsZWN0LnZhbHVlOwogICAgLy8gQ2xlYW4gdXAgc2VsZWN0ZWQgd2VsbHMgLSBvbmx5IGtlZXAgd2VsbHMgZnJvbSBzZWxlY3RlZCBkYXRhc2V0cwogICAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICAgIGNvbnN0IG5ld1NlbGVjdGVkV2VsbHMgPSBuZXcgU2V0KCk7CiAgICBzZWxlY3RlZFdlbGxzLmZvckVhY2goa2V5ID0+IHsKICAgICAgY29uc3QgW3BsYXRlSWRdID0ga2V5LnNwbGl0KCI6Iik7CiAgICAgIGlmIChzZWxlY3RlZERhdGFzZXRzLmluY2x1ZGVzKHBsYXRlSWQpKSB7CiAgICAgICAgbmV3U2VsZWN0ZWRXZWxscy5hZGQoa2V5KTsKICAgICAgfQogICAgfSk7CiAgICBzZWxlY3RlZFdlbGxzID0gbmV3U2VsZWN0ZWRXZWxsczsKICAgIC8vIFJlc2V0IGVuYWJsZWQgZGF0YXNldHMvd2VsbHMvY29sdW1ucyB3aGVuIGNoYW5naW5nIGRhdGFzZXQgZ3JvdXAKICAgIGVuYWJsZWREYXRhc2V0cy5jbGVhcigpOwogICAgZW5hYmxlZFdlbGxzLmNsZWFyKCk7CiAgICBlbmFibGVkQ29sdW1ucy5jbGVhcigpOwogICAgCiAgICByZW5kZXJQbGF0ZUdyaWQoKTsKICAgIHVwZGF0ZVdlbGxJbmZvKCk7CiAgICB1cGRhdGVEYXRhc2V0SW5mbygpOwogICAgcmVuZGVyV2VsbFNlbGVjdG9yR3JpZCgpOwogIH0pOwogIAogIC8vIFVwZGF0ZSBpbmZvIG9uIGluaXRpYWwgbG9hZAogIHVwZGF0ZURhdGFzZXRJbmZvKCk7Cn0KCmZ1bmN0aW9uIHVwZGF0ZURhdGFzZXRJbmZvKCkgewogIGNvbnN0IGluZm9EaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZGF0YXNldC1kZXRhaWxzIik7CiAgaWYgKCFpbmZvRGl2IHx8ICFzZWxlY3RlZERhdGFzZXRJZCkgewogICAgaWYgKGluZm9EaXYpIHsKICAgICAgaW5mb0Rpdi50ZXh0Q29udGVudCA9ICJTZWxlY3QgYSBkYXRhc2V0IHRvIHZpZXcgZGV0YWlscy4iOwogICAgfQogICAgcmV0dXJuOwogIH0KICAKICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogIGlmIChzZWxlY3RlZERhdGFzZXRzLmxlbmd0aCA9PT0gMCkgewogICAgaW5mb0Rpdi50ZXh0Q29udGVudCA9ICJObyBkYXRhc2V0IHNlbGVjdGVkLiI7CiAgICByZXR1cm47CiAgfQogIAogIC8vIEdldCBtZXRhZGF0YSBmcm9tIGZpcnN0IGRhdGFzZXQKICBjb25zdCBmaXJzdFBsYXRlID0gdmlld2VyRGF0YS5wbGF0ZXMuZmluZChwID0+IHAuaWQgPT09IHNlbGVjdGVkRGF0YXNldHNbMF0pOwogIGlmICghZmlyc3RQbGF0ZSkgewogICAgaW5mb0Rpdi50ZXh0Q29udGVudCA9ICJEYXRhc2V0IGluZm9ybWF0aW9uIG5vdCBhdmFpbGFibGUuIjsKICAgIHJldHVybjsKICB9CiAgCiAgY29uc3QgY29sdW1uSW5mbyA9IGZpcnN0UGxhdGUuY29sdW1uX2luZm8gfHwge307CiAgY29uc3QgYWxsUGxhdGVzID0gdmlld2VyRGF0YS5wbGF0ZXMuZmlsdGVyKHAgPT4gc2VsZWN0ZWREYXRhc2V0cy5pbmNsdWRlcyhwLmlkKSk7CiAgCiAgLy8gQnVpbGQgaW5mbyBIVE1MCiAgbGV0IGh0bWwgPSAiIjsKICAKICBpZiAoY29sdW1uSW5mby5wcm90ZWluKSB7CiAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA0cHg7Ij48c3Ryb25nPlByb3RlaW46PC9zdHJvbmc+ICR7Y29sdW1uSW5mby5wcm90ZWlufTwvZGl2PmA7CiAgfQogIGlmIChjb2x1bW5JbmZvLmdlbm90eXBlKSB7CiAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA0cHg7Ij48c3Ryb25nPkdlbm90eXBlOjwvc3Ryb25nPiAke2NvbHVtbkluZm8uZ2Vub3R5cGV9PC9kaXY+YDsKICB9CiAgaWYgKGNvbHVtbkluZm8uYnVmZmVyKSB7CiAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA0cHg7Ij48c3Ryb25nPkJ1ZmZlcjo8L3N0cm9uZz4gJHtjb2x1bW5JbmZvLmJ1ZmZlcn08L2Rpdj5gOwogIH0KICBpZiAoY29sdW1uSW5mby5zY2llbnRpc3QpIHsKICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDRweDsiPjxzdHJvbmc+U2NpZW50aXN0Ojwvc3Ryb25nPiAke2NvbHVtbkluZm8uc2NpZW50aXN0fTwvZGl2PmA7CiAgfQogIAogIGh0bWwgKz0gYDxkaXYgc3R5bGU9Im1hcmdpbi10b3A6IDhweDsgcGFkZGluZy10b3A6IDhweDsgYm9yZGVyLXRvcDogMXB4IHNvbGlkICNkZGQ7Ij5gOwogIGh0bWwgKz0gYDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDRweDsiPjxzdHJvbmc+RGF0YXNldHM6PC9zdHJvbmc+ICR7YWxsUGxhdGVzLmxlbmd0aH08L2Rpdj5gOwogIGh0bWwgKz0gYDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC44cmVtOyBjb2xvcjogIzY2NjsiPmA7CiAgYWxsUGxhdGVzLmZvckVhY2goKHBsYXRlLCBpZHgpID0+IHsKICAgIGh0bWwgKz0gYCR7aWR4ICsgMX0uICR7cGxhdGUuZmlsZSB8fCBwbGF0ZS5pZH1gOwogICAgaWYgKHBsYXRlLmNvbHVtbl9pbmZvICYmIHBsYXRlLmNvbHVtbl9pbmZvLm51bWJlcikgewogICAgICBodG1sICs9IGAgKCR7cGxhdGUuY29sdW1uX2luZm8ubnVtYmVyfSlgOwogICAgfQogICAgaHRtbCArPSAiPGJyPiI7CiAgfSk7CiAgaHRtbCArPSBgPC9kaXY+PC9kaXY+YDsKICAKICBpbmZvRGl2LmlubmVySFRNTCA9IGh0bWw7Cn0KCmZ1bmN0aW9uIGdldFNlbGVjdGVkRGF0YXNldHMoKSB7CiAgLy8gUmV0dXJuIGFsbCBkYXRhc2V0cyBpbiB0aGUgc2VsZWN0ZWQgZ3JvdXAsIGZpbHRlcmVkIGJ5IGVuYWJsZWREYXRhc2V0cwogIGlmICghc2VsZWN0ZWREYXRhc2V0SWQpIHsKICAgIHJldHVybiBbXTsKICB9CiAgCiAgbGV0IGRhdGFzZXRzID0gW107CiAgCiAgLy8gQ2hlY2sgaWYgaXQncyBhIGdyb3VwIHNlbGVjdGlvbiAoZm9ybWF0OiAiZ3JvdXA6R1JPVVBfTkFNRSIpCiAgaWYgKHNlbGVjdGVkRGF0YXNldElkLnN0YXJ0c1dpdGgoImdyb3VwOiIpKSB7CiAgICBjb25zdCBncm91cE5hbWUgPSBzZWxlY3RlZERhdGFzZXRJZC5zdWJzdHJpbmcoNik7IC8vIFJlbW92ZSAiZ3JvdXA6IiBwcmVmaXgKICAgIGNvbnN0IHNlbGVjdGVkUGxhdGVzID0gdmlld2VyRGF0YS5wbGF0ZXMuZmlsdGVyKHAgPT4gcC5jb2x1bW5fZ3JvdXAgPT09IGdyb3VwTmFtZSk7CiAgICBkYXRhc2V0cyA9IHNlbGVjdGVkUGxhdGVzLm1hcChwID0+IHAuaWQpOwogIH0gZWxzZSB7CiAgICAvLyBPdGhlcndpc2UsIGl0J3MgYSBzaW5nbGUgZGF0YXNldCBzZWxlY3Rpb24gKGxlZ2FjeSBzdXBwb3J0KQogICAgY29uc3QgcGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gc2VsZWN0ZWREYXRhc2V0SWQpOwogICAgaWYgKHBsYXRlKSB7CiAgICAgIGRhdGFzZXRzID0gW3NlbGVjdGVkRGF0YXNldElkXTsKICAgIH0KICB9CiAgCiAgLy8gRmlsdGVyIGJ5IGVuYWJsZWREYXRhc2V0cyBpZiBhbnkgYXJlIHNldAogIGlmIChlbmFibGVkRGF0YXNldHMuc2l6ZSA+IDApIHsKICAgIHJldHVybiBkYXRhc2V0cy5maWx0ZXIoaWQgPT4gZW5hYmxlZERhdGFzZXRzLmhhcyhpZCkpOwogIH0KICAKICByZXR1cm4gZGF0YXNldHM7Cn0KCmZ1bmN0aW9uIHRvZ2dsZVdlbGxTZWxlY3RvcigpIHsKICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgid2VsbC1zZWxlY3Rvci1ncmlkLWNvbnRhaW5lciIpOwogIGNvbnN0IGFycm93ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIndlbGwtc2VsZWN0b3ItYXJyb3ciKTsKICBpZiAoY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPT09ICJub25lIikgewogICAgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgYXJyb3cudGV4dENvbnRlbnQgPSAi4payIjsKICAgIHJlbmRlcldlbGxTZWxlY3RvckdyaWQoKTsKICB9IGVsc2UgewogICAgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICBhcnJvdy50ZXh0Q29udGVudCA9ICLilrwiOwogIH0KfQoKZnVuY3Rpb24gdG9nZ2xlQmFzZWxpbmVPcHRpb25zKCkgewogIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJiYXNlbGluZS1vcHRpb25zLWNvbnRlbnQiKTsKICBjb25zdCBhcnJvdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJiYXNlbGluZS1vcHRpb25zLWFycm93Iik7CiAgaWYgKGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID09PSAibm9uZSIpIHsKICAgIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgIGFycm93LnRleHRDb250ZW50ID0gIuKWsiI7CiAgfSBlbHNlIHsKICAgIGNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgYXJyb3cudGV4dENvbnRlbnQgPSAi4pa8IjsKICB9Cn0KCmZ1bmN0aW9uIHVwZGF0ZUJhc2VsaW5lTWV0aG9kUGFyYW1zKCkgewogIGNvbnN0IG1ldGhvZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJiYXNlbGluZS1tZXRob2Qtc2VsZWN0IikudmFsdWU7CiAgY29uc3QgbG93ZXNzUGFyYW1zID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJhc2VsaW5lLWxvd2Vzcy1wYXJhbXMiKTsKICBjb25zdCBwb2x5bm9taWFsUGFyYW1zID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJhc2VsaW5lLXBvbHlub21pYWwtcGFyYW1zIik7CiAgCiAgaWYgKG1ldGhvZCA9PT0gImxvd2VzcyIpIHsKICAgIGxvd2Vzc1BhcmFtcy5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgIHBvbHlub21pYWxQYXJhbXMuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICB9IGVsc2UgaWYgKG1ldGhvZCA9PT0gInBvbHlub21pYWwiKSB7CiAgICBsb3dlc3NQYXJhbXMuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIHBvbHlub21pYWxQYXJhbXMuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgfSBlbHNlIHsKICAgIC8vIGNvbnN0YW50CiAgICBsb3dlc3NQYXJhbXMuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIHBvbHlub21pYWxQYXJhbXMuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICB9CiAgCiAgdXBkYXRlQ3VycmVudFNldHRpbmdzRGlzcGxheSgpOwp9CgpmdW5jdGlvbiB1cGRhdGVSZWdyZXNzaW9uVHlwZVBhcmFtcyhza2lwQ2hhcnRVcGRhdGUpIHsKICBjb25zdCByZWdyZXNzaW9uVHlwZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZWdyZXNzaW9uLXR5cGUtc2VsZWN0IikudmFsdWU7CiAgY29uc3QgcG9seW5vbWlhbE9yZGVyRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlZ3Jlc3Npb24tcG9seW5vbWlhbC1vcmRlciIpOwogIGNvbnN0IGluZm9QYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZWdyZXNzaW9uLWluZm8tcGFuZWwiKTsKICBjb25zdCBmaXRSZWdyZXNzaW9uVG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZpdC1yZWdyZXNzaW9uLXRvZ2dsZSIpOwogIAogIGlmIChyZWdyZXNzaW9uVHlwZSA9PT0gInBvbHlub21pYWwiICYmIHBvbHlub21pYWxPcmRlckRpdikgewogICAgcG9seW5vbWlhbE9yZGVyRGl2LnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogIH0gZWxzZSBpZiAocG9seW5vbWlhbE9yZGVyRGl2KSB7CiAgICBwb2x5bm9taWFsT3JkZXJEaXYuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICB9CiAgCiAgLy8gU2hvdy9oaWRlIGluZm8gcGFuZWwgZm9yIG1vbm8tZXhwb25lbnRpYWwgKG9ubHkgaWYgcmVncmVzc2lvbiB0b2dnbGUgaXMgY2hlY2tlZCkKICBpZiAoaW5mb1BhbmVsKSB7CiAgICBjb25zdCBpc1JlZ3Jlc3Npb25FbmFibGVkID0gZml0UmVncmVzc2lvblRvZ2dsZSAmJiBmaXRSZWdyZXNzaW9uVG9nZ2xlLmNoZWNrZWQ7CiAgICBpZiAocmVncmVzc2lvblR5cGUgPT09ICJtb25vLWV4cG9uZW50aWFsIiAmJiBpc1JlZ3Jlc3Npb25FbmFibGVkKSB7CiAgICAgIGluZm9QYW5lbC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgIH0gZWxzZSB7CiAgICAgIGluZm9QYW5lbC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgfQogIH0KICAKICB1cGRhdGVDdXJyZW50U2V0dGluZ3NEaXNwbGF5KCk7CiAgCiAgLy8gVXBkYXRlIGNoYXJ0IHdoZW4gcmVncmVzc2lvbiB0eXBlIGNoYW5nZXMgKHVubGVzcyBza2lwcGVkIGZvciBpbml0aWFsaXphdGlvbikKICBpZiAoIXNraXBDaGFydFVwZGF0ZSkgewogICAgdXBkYXRlQ2hhcnQoKTsKICB9Cn0KCmZ1bmN0aW9uIHVwZGF0ZUN1cnJlbnRTZXR0aW5nc0Rpc3BsYXkoKSB7CiAgY29uc3QgYmFzZWxpbmVNZXRob2RTZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtbWV0aG9kLXNlbGVjdCIpOwogIGNvbnN0IG5vcm1hbGl6YXRpb25Nb2RlU2VsZWN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm5vcm1hbGl6YXRpb24tbW9kZS1zZWxlY3QiKTsKICBjb25zdCByZWdyZXNzaW9uVHlwZVNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZWdyZXNzaW9uLXR5cGUtc2VsZWN0Iik7CiAgCiAgY29uc3QgYmFzZWxpbmVNZXRob2RFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXJyZW50LWJhc2VsaW5lLW1ldGhvZCIpOwogIGNvbnN0IG5vcm1hbGl6YXRpb25Nb2RlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3VycmVudC1ub3JtYWxpemF0aW9uLW1vZGUiKTsKICBjb25zdCByZWdyZXNzaW9uVHlwZUVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImN1cnJlbnQtcmVncmVzc2lvbi10eXBlIik7CiAgCiAgaWYgKGJhc2VsaW5lTWV0aG9kRWwgJiYgYmFzZWxpbmVNZXRob2RTZWxlY3QpIHsKICAgIGNvbnN0IG1ldGhvZCA9IGJhc2VsaW5lTWV0aG9kU2VsZWN0LnZhbHVlOwogICAgYmFzZWxpbmVNZXRob2RFbC50ZXh0Q29udGVudCA9IG1ldGhvZC5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG1ldGhvZC5zbGljZSgxKTsKICB9CiAgCiAgaWYgKG5vcm1hbGl6YXRpb25Nb2RlRWwgJiYgbm9ybWFsaXphdGlvbk1vZGVTZWxlY3QpIHsKICAgIGNvbnN0IG1vZGUgPSBub3JtYWxpemF0aW9uTW9kZVNlbGVjdC52YWx1ZTsKICAgIG5vcm1hbGl6YXRpb25Nb2RlRWwudGV4dENvbnRlbnQgPSBtb2RlID09PSAiZGVsdGFfZl9vdmVyX2YiID8gIs6URi9GIiA6ICJNdWx0aXBsaWNhdGl2ZSI7CiAgfQogIAogIGlmIChyZWdyZXNzaW9uVHlwZUVsICYmIHJlZ3Jlc3Npb25UeXBlU2VsZWN0KSB7CiAgICBjb25zdCB0eXBlID0gcmVncmVzc2lvblR5cGVTZWxlY3QudmFsdWU7CiAgICBjb25zdCB0eXBlTGFiZWxzID0gewogICAgICAibGluZWFyIjogIkxpbmVhciIsCiAgICAgICJwb2x5bm9taWFsIjogIlBvbHlub21pYWwiLAogICAgICAiZXhwb25lbnRpYWwiOiAiRXhwb25lbnRpYWwiLAogICAgICAibG9nYXJpdGhtaWMiOiAiTG9nYXJpdGhtaWMiLAogICAgICAibW9uby1leHBvbmVudGlhbCI6ICJNb25vLWV4cG9uZW50aWFsIHBsYXRlYXUiCiAgICB9OwogICAgcmVncmVzc2lvblR5cGVFbC50ZXh0Q29udGVudCA9IHR5cGVMYWJlbHNbdHlwZV0gfHwgdHlwZTsKICB9Cn0KCmZ1bmN0aW9uIHBhcnNlTGFiZWxGb3JMZWdlbmQobGFiZWwpIHsKICAvLyBQYXJzZSBsYWJlbCBmb3JtYXQ6ICJFMTcsIEYxNywgRzE3LCBFMTQsIEcxNCAtIDUwMC0xMC0yIChQTENlX1dUX0NhKSBDb2wgMTcgKDUtcGxpY2F0ZSwgMiBkYXRhc2V0cywgbWVhbiDCsSBTRSkiCiAgLy8gRXh0cmFjdCBtYWluIGhlYWRpbmcgKGUuZy4sICI1MDAtMTAtMiIpIGFuZCByZXR1cm4gcmVzdCBhcyBkZXRhaWxzCiAgCiAgaWYgKCFsYWJlbCkgcmV0dXJuIHsgbWFpbkhlYWRpbmc6IGxhYmVsLCBkZXRhaWxzOiAiIiB9OwogIAogIC8vIFBhdHRlcm4gdG8gbWF0Y2g6IG51bWJlci1udW1iZXItbnVtYmVyICh0aGUgbWFpbiBoZWFkaW5nIGxpa2UgIjUwMC0xMC0yIikKICBjb25zdCBtYWluSGVhZGluZ01hdGNoID0gbGFiZWwubWF0Y2goL1xiKFxkKy1cZCstXGQrKVxiLyk7CiAgCiAgaWYgKG1haW5IZWFkaW5nTWF0Y2gpIHsKICAgIGNvbnN0IG1haW5IZWFkaW5nID0gbWFpbkhlYWRpbmdNYXRjaFsxXTsKICAgIGNvbnN0IG1hdGNoSW5kZXggPSBtYWluSGVhZGluZ01hdGNoLmluZGV4OwogICAgCiAgICAvLyBHZXQgcGFydHMgYmVmb3JlIGFuZCBhZnRlciB0aGUgbWFpbiBoZWFkaW5nCiAgICBjb25zdCBiZWZvcmUgPSBsYWJlbC5zdWJzdHJpbmcoMCwgbWF0Y2hJbmRleCkudHJpbSgpOwogICAgY29uc3QgYWZ0ZXIgPSBsYWJlbC5zdWJzdHJpbmcobWF0Y2hJbmRleCArIG1haW5IZWFkaW5nLmxlbmd0aCkudHJpbSgpOwogICAgCiAgICAvLyBDb21iaW5lIGJlZm9yZSBhbmQgYWZ0ZXIKICAgIGxldCBkZXRhaWxzID0gKGJlZm9yZSArICIgIiArIGFmdGVyKS50cmltKCk7CiAgICAvLyBDbGVhbiB1cCBleHRyYSBzcGFjZXMgYW5kIGRhc2hlcwogICAgZGV0YWlscyA9IGRldGFpbHMucmVwbGFjZSgvXHMqLVxzKi9nLCAiIC0gIikucmVwbGFjZSgvXHMrL2csICIgIikudHJpbSgpOwogICAgLy8gUmVtb3ZlIGxlYWRpbmcvdHJhaWxpbmcgZGFzaGVzIGFuZCBjbGVhbiB1cAogICAgZGV0YWlscyA9IGRldGFpbHMucmVwbGFjZSgvXi1ccyovLCAiIikucmVwbGFjZSgvXHMqLSQvLCAiIikudHJpbSgpOwogICAgCiAgICByZXR1cm4geyBtYWluSGVhZGluZzogbWFpbkhlYWRpbmcsIGRldGFpbHM6IGRldGFpbHMgfTsKICB9CiAgCiAgLy8gSWYgbm8gcGF0dGVybiBtYXRjaCwgcmV0dXJuIG9yaWdpbmFsIGFzIG1haW4gaGVhZGluZwogIHJldHVybiB7IG1haW5IZWFkaW5nOiBsYWJlbCwgZGV0YWlsczogIiIgfTsKfQoKZnVuY3Rpb24gdXBkYXRlTW9ub0V4cG9uZW50aWFsSW5mb1BhbmVsKG1vbm9FeHBQYXJhbXMpIHsKICBjb25zdCBpbmZvUGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi1pbmZvLXBhbmVsIik7CiAgY29uc3QgaW5mb0NvbnRlbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi1pbmZvLWNvbnRlbnQiKTsKICAKICBpZiAoIWluZm9QYW5lbCB8fCAhaW5mb0NvbnRlbnQpIHsKICAgIHJldHVybjsKICB9CiAgCiAgaWYgKG1vbm9FeHBQYXJhbXMubGVuZ3RoID09PSAwKSB7CiAgICBpbmZvQ29udGVudC5pbm5lckhUTUwgPSAiPGRpdiBzdHlsZT0nY29sb3I6ICM2NjY7Jz5ObyBmaXRzIGF2YWlsYWJsZS4gU2VsZWN0IHdlbGxzIGFuZCBlbmFibGUgcmVncmVzc2lvbi48L2Rpdj4iOwogICAgcmV0dXJuOwogIH0KICAKICAvLyBCdWlsZCBIVE1MIGZvciBwYXJhbWV0ZXJzCiAgbGV0IGh0bWwgPSAiIjsKICAKICAvLyBNb2RlbCBlcXVhdGlvbgogIGh0bWwgKz0gIjxkaXYgc3R5bGU9J21hcmdpbi1ib3R0b206IDhweDsgcGFkZGluZzogNHB4OyBiYWNrZ3JvdW5kOiB3aGl0ZTsgYm9yZGVyLXJhZGl1czogMnB4Oyc+IjsKICBodG1sICs9ICI8c3Ryb25nPk1vZGVsOjwvc3Ryb25nPiB5KHQpID0gMSArIEEoMSAtIGU8c3VwPi1rKHQtdOKCgCk8L3N1cD4pIjsKICBodG1sICs9ICI8L2Rpdj4iOwogIAogIC8vIFBhcmFtZXRlcnMgZm9yIGVhY2ggZml0CiAgbW9ub0V4cFBhcmFtcy5mb3JFYWNoKChmaXQsIGlkeCkgPT4gewogICAgY29uc3QgcCA9IGZpdC5wYXJhbXM7CiAgICBjb25zdCBib3JkZXJDb2xvciA9IGZpdC5jb2xvciB8fCAnIzJhNmNmZic7IC8vIFVzZSBkYXRhc2V0IGNvbG9yIG9yIGRlZmF1bHQgYmx1ZQogICAgCiAgICAvLyBQYXJzZSBsYWJlbCB0byBleHRyYWN0IG1haW4gaGVhZGluZyBhbmQgZGV0YWlscwogICAgY29uc3QgcGFyc2VkID0gcGFyc2VMYWJlbEZvckxlZ2VuZChmaXQubGFiZWwpOwogICAgCiAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSdtYXJnaW4tYm90dG9tOiAxMnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6IHdoaXRlOyBib3JkZXItcmFkaXVzOiAycHg7IGJvcmRlci1sZWZ0OiAzcHggc29saWQgJHtib3JkZXJDb2xvcn07Jz5gOwogICAgCiAgICAvLyBNYWluIGhlYWRpbmcgaW4gY2FyZCBjb2xvcgogICAgaHRtbCArPSBgPGRpdiBzdHlsZT0nY29sb3I6ICR7Ym9yZGVyQ29sb3J9OyBmb250LXdlaWdodDogNjAwOyBmb250LXNpemU6IDAuOXJlbTsgbWFyZ2luLWJvdHRvbTogNHB4Oyc+JHtwYXJzZWQubWFpbkhlYWRpbmd9PC9kaXY+YDsKICAgIAogICAgLy8gRGV0YWlscyBpbiBncmF5IGJlbG93CiAgICBpZiAocGFyc2VkLmRldGFpbHMpIHsKICAgICAgaHRtbCArPSBgPGRpdiBzdHlsZT0nY29sb3I6ICM2NjY7IGZvbnQtc2l6ZTogMC43cmVtOyBtYXJnaW4tYm90dG9tOiA4cHg7IGxpbmUtaGVpZ2h0OiAxLjM7Jz4ke3BhcnNlZC5kZXRhaWxzfTwvZGl2PmA7CiAgICB9CiAgICAKICAgIC8vIFBhcmFtZXRlcnMgZ3JpZAogICAgaHRtbCArPSBgPGRpdiBzdHlsZT0nZGlzcGxheTogZ3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAxZnIgMWZyOyBnYXA6IDRweDsgZm9udC1zaXplOiAwLjdyZW07IG1hcmdpbi10b3A6IDhweDsnPmA7CiAgICAKICAgIC8vIExlZnQgY29sdW1uCiAgICBodG1sICs9IGA8ZGl2PjxzdHJvbmc+QSAoYW1wbGl0dWRlKTo8L3N0cm9uZz4gJHtwLkEudG9GaXhlZCg0KX08L2Rpdj5gOwogICAgaHRtbCArPSBgPGRpdj48c3Ryb25nPmsgKHJhdGUgY29uc3RhbnQpOjwvc3Ryb25nPiAke3Auay50b0ZpeGVkKDYpfSBz4oG7wrk8L2Rpdj5gOwogICAgaHRtbCArPSBgPGRpdj48c3Ryb25nPs+EICh0aW1lIGNvbnN0YW50KTo8L3N0cm9uZz4gJHtwLnRhdS50b0ZpeGVkKDIpfSBzPC9kaXY+YDsKICAgIAogICAgLy8gUmlnaHQgY29sdW1uCiAgICBodG1sICs9IGA8ZGl2PjxzdHJvbmc+dOKCgCAoc3RhcnQgdGltZSk6PC9zdHJvbmc+ICR7cC50MC50b0ZpeGVkKDIpfSBzPC9kaXY+YDsKICAgIGh0bWwgKz0gYDxkaXY+PHN0cm9uZz504oKBL+KCgiAoaGFsZi10aW1lKTo8L3N0cm9uZz4gJHtwLnRIYWxmLnRvRml4ZWQoMil9IHM8L2Rpdj5gOwogICAgaHRtbCArPSBgPGRpdj48c3Ryb25nPlBsYXRlYXU6PC9zdHJvbmc+ICR7cC5wbGF0ZWF1LnRvRml4ZWQoNCl9PC9kaXY+YDsKICAgIAogICAgaHRtbCArPSBgPC9kaXY+PC9kaXY+YDsKICB9KTsKICAKICBpbmZvQ29udGVudC5pbm5lckhUTUwgPSBodG1sOwp9CgpmdW5jdGlvbiByZW5kZXJXZWxsU2VsZWN0b3JHcmlkKCkgewogIGNvbnN0IGdyaWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgid2VsbC1zZWxlY3Rvci1ncmlkIik7CiAgaWYgKCFncmlkIHx8ICFzZWxlY3RlZERhdGFzZXRJZCkgewogICAgcmV0dXJuOwogIH0KICAKICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogIGlmIChzZWxlY3RlZERhdGFzZXRzLmxlbmd0aCA9PT0gMCkgewogICAgZ3JpZC5pbm5lckhUTUwgPSAiPGRpdiBzdHlsZT0nY29sb3I6ICM2NjY7IGZvbnQtc2l6ZTogMC44cmVtOyBwYWRkaW5nOiA4cHg7Jz5ObyBkYXRhc2V0cyBzZWxlY3RlZC48L2Rpdj4iOwogICAgcmV0dXJuOwogIH0KICAKICBncmlkLmlubmVySFRNTCA9ICIiOwogIAogIC8vIENvbGxlY3QgYWxsIHVuaXF1ZSB3ZWxsIElEcyBmcm9tIHNlbGVjdGVkIGRhdGFzZXRzCiAgY29uc3QgYWxsV2VsbHNTZXQgPSBuZXcgU2V0KCk7CiAgc2VsZWN0ZWREYXRhc2V0cy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICBPYmplY3Qua2V5cyh3ZWxscykuZm9yRWFjaCh3ZWxsSWQgPT4gewogICAgICBhbGxXZWxsc1NldC5hZGQod2VsbElkKTsKICAgIH0pOwogIH0pOwogIAogIC8vIFRvcC1sZWZ0IGNvcm5lcgogIGNvbnN0IGNvcm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogIGNvcm5lci5jbGFzc05hbWUgPSAid2VsbC1zZWxlY3Rvci1oZWFkZXIiOwogIGdyaWQuYXBwZW5kQ2hpbGQoY29ybmVyKTsKICAKICAvLyBDb2x1bW4gaGVhZGVycwogIGZvciAobGV0IGMgPSAxOyBjIDw9IFBMQVRFX0NPTFM7IGMrKykgewogICAgY29uc3QgaGVhZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBoZWFkZXIuY2xhc3NOYW1lID0gIndlbGwtc2VsZWN0b3ItaGVhZGVyIjsKICAgIGhlYWRlci50ZXh0Q29udGVudCA9IGM7CiAgICBncmlkLmFwcGVuZENoaWxkKGhlYWRlcik7CiAgfQogIAogIC8vIFJvd3MKICBQTEFURV9ST1dTLmZvckVhY2gocm93TGV0dGVyID0+IHsKICAgIC8vIFJvdyBsYWJlbAogICAgY29uc3Qgcm93TGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIHJvd0xhYmVsLmNsYXNzTmFtZSA9ICJ3ZWxsLXNlbGVjdG9yLWhlYWRlciI7CiAgICByb3dMYWJlbC50ZXh0Q29udGVudCA9IHJvd0xldHRlcjsKICAgIGdyaWQuYXBwZW5kQ2hpbGQocm93TGFiZWwpOwogICAgCiAgICAvLyBXZWxscwogICAgZm9yIChsZXQgY29sID0gMTsgY29sIDw9IFBMQVRFX0NPTFM7IGNvbCsrKSB7CiAgICAgIGNvbnN0IHdlbGxJZCA9IHJvd0xldHRlciArIFN0cmluZyhjb2wpOwogICAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgICAgIGNvbnN0IGNlbGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgY2VsbC5jbGFzc05hbWUgPSAid2VsbC1zZWxlY3Rvci1jZWxsIjsKICAgICAgCiAgICAgIC8vIENoZWNrIGZvciBkYXRhIHVzaW5nIG5vcm1hbGl6ZWQgSUQgKHNpbmNlIGFsbFdlbGxzRGF0YSBjb250YWlucyBub3JtYWxpemVkIElEcykKICAgICAgY29uc3QgaGFzRGF0YSA9IGFsbFdlbGxzU2V0Lmhhcyhub3JtYWxpemVkV2VsbElkKSB8fCBhbGxXZWxsc1NldC5oYXMod2VsbElkKTsKICAgICAgLy8gQ2hlY2sgZXhjbHVzaW9uIHVzaW5nIGJvdGggbm9ybWFsaXplZCBhbmQgbm9uLW5vcm1hbGl6ZWQgSURzCiAgICAgIGNvbnN0IGlzRXhjbHVkZWQgPSBlbmFibGVkV2VsbHMuc2l6ZSA+IDAgJiYgIWVuYWJsZWRXZWxscy5oYXMobm9ybWFsaXplZFdlbGxJZCkgJiYgIWVuYWJsZWRXZWxscy5oYXMod2VsbElkKTsKICAgICAgCiAgICAgIGlmIChoYXNEYXRhKSB7CiAgICAgICAgY2VsbC5jbGFzc0xpc3QuYWRkKCJoYXMtZGF0YSIpOwogICAgICAgIGlmIChpc0V4Y2x1ZGVkKSB7CiAgICAgICAgICAvLyBVc2UgaW5saW5lIHN0eWxlcyB3aXRoIHJnYiB0byBhdm9pZCBoZXggZXNjYXBpbmcgaXNzdWVzCiAgICAgICAgICBjZWxsLnN0eWxlLmJhY2tncm91bmQgPSAicmdiKDI1NSwgMjA0LCAyMDQpIjsKICAgICAgICAgIGNlbGwuc3R5bGUuYm9yZGVyQ29sb3IgPSAicmdiKDI1NSwgMTA3LCAxMDcpIjsKICAgICAgICAgIGNlbGwuc3R5bGUuY29sb3IgPSAicmdiKDIwNCwgMCwgMCkiOwogICAgICAgICAgY2VsbC5zdHlsZS5mb250V2VpZ2h0ID0gImJvbGQiOwogICAgICAgICAgY2VsbC50ZXh0Q29udGVudCA9ICLinJUiOwogICAgICAgICAgY2VsbC50aXRsZSA9IGBXZWxsICR7d2VsbElkfSAtIEVYQ0xVREVEIChjbGljayB0byBpbmNsdWRlKWA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNlbGwudGV4dENvbnRlbnQgPSBjb2w7CiAgICAgICAgICBjZWxsLnRpdGxlID0gYFdlbGwgJHt3ZWxsSWR9IC0gQ2xpY2sgdG8gZXhjbHVkZWA7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGNlbGwuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKSA9PiB7CiAgICAgICAgICB0b2dnbGVXZWxsRXhjbHVzaW9uKG5vcm1hbGl6ZWRXZWxsSWQpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGNlbGwuc3R5bGUuYmFja2dyb3VuZCA9ICIjZjJmMmYyIjsKICAgICAgICBjZWxsLnN0eWxlLmN1cnNvciA9ICJkZWZhdWx0IjsKICAgICAgICBjZWxsLnN0eWxlLm9wYWNpdHkgPSAiMC41IjsKICAgICAgfQogICAgICAKICAgICAgZ3JpZC5hcHBlbmRDaGlsZChjZWxsKTsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gdG9nZ2xlV2VsbEV4Y2x1c2lvbih3ZWxsSWQpIHsKICAvLyBOb3JtYWxpemUgdGhlIGluY29taW5nIHdlbGwgSUQgdG8gZW5zdXJlIGNvbnNpc3RlbnQgY29tcGFyaXNvbgogIC8vIHdlbGxJZCBtYXkgYWxyZWFkeSBiZSBub3JtYWxpemVkLCBidXQgbm9ybWFsaXplIGl0IHRvIGJlIHNhZmUKICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgCiAgaWYgKGVuYWJsZWRXZWxscy5zaXplID09PSAwKSB7CiAgICAvLyBJZiBubyBleGNsdXNpb25zIHlldCwgZmlyc3QgY29sbGVjdCBhbGwgYXZhaWxhYmxlIHdlbGxzCiAgICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogICAgY29uc3QgYWxsV2VsbHNTZXQgPSBuZXcgU2V0KCk7CiAgICBzZWxlY3RlZERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICBPYmplY3Qua2V5cyh3ZWxscykuZm9yRWFjaCh3SWQgPT4gewogICAgICAgIC8vIEFsbCB3ZWxsIElEcyBpbiBhbGxXZWxsc0RhdGEgYXJlIGFscmVhZHkgbm9ybWFsaXplZCwgYnV0IG5vcm1hbGl6ZSB0byBiZSBzYWZlCiAgICAgICAgY29uc3Qgbm9ybWFsaXplZFdJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3SWQpOwogICAgICAgIGFsbFdlbGxzU2V0LmFkZChub3JtYWxpemVkV0lkKTsKICAgICAgfSk7CiAgICB9KTsKICAgIC8vIEVuYWJsZSBhbGwgZXhjZXB0IHRoZSBvbmUgYmVpbmcgY2xpY2tlZCAodXNpbmcgbm9ybWFsaXplZCBJRCkKICAgIGFsbFdlbGxzU2V0LmZvckVhY2god0lkID0+IHsKICAgICAgaWYgKHdJZCAhPT0gbm9ybWFsaXplZFdlbGxJZCkgewogICAgICAgIGVuYWJsZWRXZWxscy5hZGQod0lkKTsKICAgICAgfQogICAgfSk7CiAgfSBlbHNlIHsKICAgIC8vIFRvZ2dsZSB0aGlzIHNwZWNpZmljIHdlbGwgKGNoZWNrIGJvdGggbm9ybWFsaXplZCBhbmQgbm9uLW5vcm1hbGl6ZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkpCiAgICBjb25zdCBoYXNOb3JtYWxpemVkID0gZW5hYmxlZFdlbGxzLmhhcyhub3JtYWxpemVkV2VsbElkKTsKICAgIGNvbnN0IGhhc09yaWdpbmFsID0gZW5hYmxlZFdlbGxzLmhhcyh3ZWxsSWQpOwogICAgCiAgICBpZiAoaGFzTm9ybWFsaXplZCB8fCBoYXNPcmlnaW5hbCkgewogICAgICAvLyBSZW1vdmUgYm90aCBub3JtYWxpemVkIGFuZCBub24tbm9ybWFsaXplZCB2ZXJzaW9ucyBpZiBwcmVzZW50CiAgICAgIGVuYWJsZWRXZWxscy5kZWxldGUobm9ybWFsaXplZFdlbGxJZCk7CiAgICAgIGVuYWJsZWRXZWxscy5kZWxldGUod2VsbElkKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIEFkZCBub3JtYWxpemVkIHZlcnNpb24KICAgICAgZW5hYmxlZFdlbGxzLmFkZChub3JtYWxpemVkV2VsbElkKTsKICAgIH0KICAgIAogICAgLy8gSWYgYWxsIHdlbGxzIGFyZSBlbmFibGVkLCBjbGVhciB0aGUgc2V0IChtZWFuaW5nIGFsbCBhcmUgZW5hYmxlZCkKICAgIGNvbnN0IHNlbGVjdGVkRGF0YXNldHMgPSBnZXRTZWxlY3RlZERhdGFzZXRzKCk7CiAgICBjb25zdCBhbGxXZWxsc1NldCA9IG5ldyBTZXQoKTsKICAgIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICAgIE9iamVjdC5rZXlzKHdlbGxzKS5mb3JFYWNoKHdJZCA9PiB7CiAgICAgICAgLy8gTm9ybWFsaXplIGFsbCB3ZWxsIElEcyBmb3IgY29uc2lzdGVudCBjb21wYXJpc29uCiAgICAgICAgY29uc3Qgbm9ybWFsaXplZFdJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3SWQpOwogICAgICAgIGFsbFdlbGxzU2V0LmFkZChub3JtYWxpemVkV0lkKTsKICAgICAgfSk7CiAgICB9KTsKICAgIAogICAgLy8gQ2hlY2sgaWYgYWxsIHdlbGxzIGFyZSBlbmFibGVkIChjaGVjayBib3RoIG5vcm1hbGl6ZWQgYW5kIG5vbi1ub3JtYWxpemVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5KQogICAgbGV0IGFsbEVuYWJsZWQgPSB0cnVlOwogICAgYWxsV2VsbHNTZXQuZm9yRWFjaChub3JtYWxpemVkV0lkID0+IHsKICAgICAgLy8gQ2hlY2sgYm90aCBub3JtYWxpemVkIGFuZCBvcmlnaW5hbCBmb3JtYXQKICAgICAgY29uc3Qgb3JpZ2luYWxXSWQgPSBub3JtYWxpemVkV0lkLnJlcGxhY2UoL14oW0EtWl0pKFxkezJ9KSQvLCAobWF0Y2gsIHJvdywgY29sKSA9PiB7CiAgICAgICAgY29uc3QgY29sTnVtID0gcGFyc2VJbnQoY29sKTsKICAgICAgICByZXR1cm4gcm93ICsgU3RyaW5nKGNvbE51bSk7CiAgICAgIH0pOwogICAgICBpZiAoIWVuYWJsZWRXZWxscy5oYXMobm9ybWFsaXplZFdJZCkgJiYgIWVuYWJsZWRXZWxscy5oYXMob3JpZ2luYWxXSWQpKSB7CiAgICAgICAgYWxsRW5hYmxlZCA9IGZhbHNlOwogICAgICB9CiAgICB9KTsKICAgIAogICAgaWYgKGFsbEVuYWJsZWQpIHsKICAgICAgZW5hYmxlZFdlbGxzLmNsZWFyKCk7IC8vIENsZWFyIG1lYW5zIGFsbCBlbmFibGVkCiAgICB9CiAgfQogIAogIHJlbmRlcldlbGxTZWxlY3RvckdyaWQoKTsKICByZW5kZXJQbGF0ZUdyaWQoKTsKICB1cGRhdGVXZWxsSW5mbygpOwp9CgpmdW5jdGlvbiBnZXRBbGxEYXRhc2V0c0luR3JvdXAoKSB7CiAgLy8gR2V0IGFsbCBkYXRhc2V0cyBpbiB0aGUgc2VsZWN0ZWQgZ3JvdXAgKGJlZm9yZSBmaWx0ZXJpbmcgYnkgZW5hYmxlZERhdGFzZXRzKQogIGlmICghc2VsZWN0ZWREYXRhc2V0SWQpIHsKICAgIHJldHVybiBbXTsKICB9CiAgCiAgaWYgKHNlbGVjdGVkRGF0YXNldElkLnN0YXJ0c1dpdGgoImdyb3VwOiIpKSB7CiAgICBjb25zdCBncm91cE5hbWUgPSBzZWxlY3RlZERhdGFzZXRJZC5zdWJzdHJpbmcoNik7CiAgICBjb25zdCBzZWxlY3RlZFBsYXRlcyA9IHZpZXdlckRhdGEucGxhdGVzLmZpbHRlcihwID0+IHAuY29sdW1uX2dyb3VwID09PSBncm91cE5hbWUpOwogICAgcmV0dXJuIHNlbGVjdGVkUGxhdGVzLm1hcChwID0+IHAuaWQpOwogIH0gZWxzZSB7CiAgICBjb25zdCBwbGF0ZSA9IHZpZXdlckRhdGEucGxhdGVzLmZpbmQocCA9PiBwLmlkID09PSBzZWxlY3RlZERhdGFzZXRJZCk7CiAgICByZXR1cm4gcGxhdGUgPyBbc2VsZWN0ZWREYXRhc2V0SWRdIDogW107CiAgfQp9CgpmdW5jdGlvbiBpbml0aWFsaXplVHJpcGxpY2F0ZUdyb3VwQ29sb3JzKCkgewogIC8vIEluaXRpYWxpemUgY29sb3IgbWFwIGlmIG5lZWRlZCAoZG9uJ3QgcmVzZXQgLSBrZWVwIGNvbnNpc3RlbnQgY29sb3JzKQogIC8vIFRoaXMgZW5zdXJlcyBhbGwgd2VsbHMgd2l0aCB0aGUgc2FtZSB0cmlwbGljYXRlIGdyb3VwIG5hbWUgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgLy8gRm9yIGV4YW1wbGUsIGFsbCB3ZWxscyBpbiByb3dzIEIsIEMsIEQgd2l0aCBncm91cCBuYW1lICIyNTAtMTAtMiIgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgaWYgKE9iamVjdC5rZXlzKHRyaXBsaWNhdGVHcm91cENvbG9yTWFwKS5sZW5ndGggPT09IDAgJiYgdmlld2VyRGF0YSAmJiB2aWV3ZXJEYXRhLmNvbmZpZykgewogICAgY29uc3QgdHJpcGxpY2F0ZUdyb3VwcyA9IHZpZXdlckRhdGEuY29uZmlnLnRyaXBsaWNhdGVfZ3JvdXBzIHx8IFtdOwogICAgbGV0IGNvbG9ySW5kZXggPSAwOwogICAgdHJpcGxpY2F0ZUdyb3Vwcy5mb3JFYWNoKGdyb3VwID0+IHsKICAgICAgY29uc3QgbmFtZSA9IFN0cmluZyhncm91cC5uYW1lIHx8ICIiKS50cmltKCk7CiAgICAgIGlmIChuYW1lICYmICF0cmlwbGljYXRlR3JvdXBDb2xvck1hcFtuYW1lXSkgewogICAgICAgIHRyaXBsaWNhdGVHcm91cENvbG9yTWFwW25hbWVdID0gVFJJUExJQ0FURV9DT0xPUlNbY29sb3JJbmRleCAlJSBUUklQTElDQVRFX0NPTE9SUy5sZW5ndGhdOwogICAgICAgIGNvbG9ySW5kZXgrKzsKICAgICAgfQogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiByZW5kZXJQbGF0ZUdyaWQoKSB7CiAgY29uc3QgZ3JpZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwbGF0ZS1ncmlkIik7CiAgZ3JpZC5pbm5lckhUTUwgPSAiIjsKICAKICAvLyBJbml0aWFsaXplIGNvbG9yIG1hcCBpZiBuZWVkZWQgKGRvbid0IHJlc2V0IC0ga2VlcCBjb25zaXN0ZW50IGNvbG9ycykKICAvLyBUaGlzIGVuc3VyZXMgYWxsIHdlbGxzIHdpdGggdGhlIHNhbWUgdHJpcGxpY2F0ZSBncm91cCBuYW1lIGdldCB0aGUgc2FtZSBjb2xvcgogIGlmIChPYmplY3Qua2V5cyh0cmlwbGljYXRlR3JvdXBDb2xvck1hcCkubGVuZ3RoID09PSAwKSB7CiAgICBpbml0aWFsaXplVHJpcGxpY2F0ZUdyb3VwQ29sb3JzKCk7CiAgfQoKICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogIGNvbnN0IGFsbEdyb3VwRGF0YXNldHMgPSBnZXRBbGxEYXRhc2V0c0luR3JvdXAoKTsKICAKICAvLyBCdWlsZCBjb2x1bW4gaW5mbyBtYXA6IGNvbHVtbiAtPiB7IGdlbm90eXBlLCBidWZmZXIsIHNjaWVudGlzdCB9CiAgLy8gVXNlIGFsbCBkYXRhc2V0cyBpbiBncm91cCB0byBzaG93IGFsbCBhdmFpbGFibGUgY29sdW1uIGdyb3VwcwogIGNvbnN0IGNvbHVtbkluZm9NYXAgPSB7fTsgLy8gY29sdW1uIC0+IHsgZ2Vub3R5cGUsIGJ1ZmZlciwgc2NpZW50aXN0IH0KICAKICBhbGxHcm91cERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICBjb25zdCBwbGF0ZSA9IHZpZXdlckRhdGEucGxhdGVzLmZpbmQocCA9PiBwLmlkID09PSBwbGF0ZUlkKTsKICAgIGlmICghcGxhdGUgfHwgIXBsYXRlLmNvbHVtbl9pbmZvKSByZXR1cm47CiAgICAKICAgIGNvbnN0IGNvbHVtbkluZm8gPSBwbGF0ZS5jb2x1bW5faW5mbzsKICAgIC8vIEZpbmQgd2hpY2ggY29sdW1ucyBoYXZlIGRhdGEgZm9yIHRoaXMgcGxhdGUKICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgT2JqZWN0LmtleXMod2VsbHMpLmZvckVhY2god2VsbElkID0+IHsKICAgICAgY29uc3QgY29sID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgICBpZiAoIWNvbHVtbkluZm9NYXBbY29sXSkgewogICAgICAgIGNvbHVtbkluZm9NYXBbY29sXSA9IHsKICAgICAgICAgIGdlbm90eXBlOiBjb2x1bW5JbmZvLmdlbm90eXBlIHx8ICIiLAogICAgICAgICAgYnVmZmVyOiBjb2x1bW5JbmZvLmJ1ZmZlciB8fCAiIiwKICAgICAgICAgIHNjaWVudGlzdDogY29sdW1uSW5mby5zY2llbnRpc3QgfHwgIiIKICAgICAgICB9OwogICAgICB9CiAgICB9KTsKICB9KTsKCiAgLy8gVG9wLWxlZnQgYmxhbmsKICBjb25zdCBjb3JuZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICBjb3JuZXIuY2xhc3NOYW1lID0gImdyaWQtaGVhZGVyIjsKICBncmlkLmFwcGVuZENoaWxkKGNvcm5lcik7CgogIC8vIENvbHVtbiBudW1iZXIgbGFiZWxzCiAgZm9yIChsZXQgYyA9IDE7IGMgPD0gUExBVEVfQ09MUzsgYysrKSB7CiAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGRpdi5jbGFzc05hbWUgPSAiZ3JpZC1oZWFkZXIgY29sLWxhYmVsIjsKICAgIGRpdi50ZXh0Q29udGVudCA9IGM7CiAgICBncmlkLmFwcGVuZENoaWxkKGRpdik7CiAgfQoKICBjb25zdCB3ZWxsQ291bnRzID0ge307IC8vIFRyYWNrIGhvdyBtYW55IGRhdGFzZXRzIGhhdmUgZGF0YSBmb3IgZWFjaCB3ZWxsCgogIC8vIENvdW50IGRhdGFzZXRzIHBlciB3ZWxsLCBmaWx0ZXJpbmcgYnkgZW5hYmxlZCB3ZWxscwogIC8vIE5vcm1hbGl6ZSB3ZWxsIElEcyB0byBlbnN1cmUgY29uc2lzdGVudCBtYXRjaGluZyAoemVyby1wYWRkZWQgZm9ybWF0KQogIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgT2JqZWN0LmtleXMod2VsbHMpLmZvckVhY2god2VsbElkID0+IHsKICAgICAgLy8gTm9ybWFsaXplIHdlbGwgSUQgdG8gemVyby1wYWRkZWQgZm9ybWF0IChlLmcuLCAiQjUiIC0+ICJCMDUiLCAiQjEzIiAtPiAiQjEzIikKICAgICAgY29uc3Qgbm9ybWFsaXplZFdlbGxJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpOwogICAgICAKICAgICAgLy8gRmlsdGVyIGJ5IGVuYWJsZWRXZWxscyBpZiBhbnkgYXJlIHNldCAoY2hlY2sgYm90aCBvcmlnaW5hbCBhbmQgbm9ybWFsaXplZCkKICAgICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3ZWxsSWQpICYmICFlbmFibGVkV2VsbHMuaGFzKG5vcm1hbGl6ZWRXZWxsSWQpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIAogICAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZENvbHVtbnMgaWYgYW55IGFyZSBzZXQKICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgICBpZiAoZW5hYmxlZENvbHVtbnMuc2l6ZSA+IDAgJiYgIWVuYWJsZWRDb2x1bW5zLmhhcyhjb2x1bW4pKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIAogICAgICBpZiAoIXdlbGxDb3VudHNbbm9ybWFsaXplZFdlbGxJZF0pIHsKICAgICAgICB3ZWxsQ291bnRzW25vcm1hbGl6ZWRXZWxsSWRdID0gbmV3IFNldCgpOyAvLyBVc2UgU2V0IHRvIGF2b2lkIGR1cGxpY2F0ZXMKICAgICAgfQogICAgICB3ZWxsQ291bnRzW25vcm1hbGl6ZWRXZWxsSWRdLmFkZChwbGF0ZUlkKTsKICAgIH0pOwogIH0pOwogIAogIC8vIENvbnZlcnQgU2V0cyB0byBhcnJheXMgZm9yIGVhc2llciB1c2UKICBPYmplY3Qua2V5cyh3ZWxsQ291bnRzKS5mb3JFYWNoKHdlbGxJZCA9PiB7CiAgICB3ZWxsQ291bnRzW3dlbGxJZF0gPSBBcnJheS5mcm9tKHdlbGxDb3VudHNbd2VsbElkXSk7CiAgfSk7CgogIC8vIFJvd3MKICBQTEFURV9ST1dTLmZvckVhY2gocm93TGV0dGVyID0+IHsKICAgIC8vIFJvdyBsYWJlbAogICAgY29uc3QgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGxhYmVsLmNsYXNzTmFtZSA9ICJncmlkLWhlYWRlciByb3ctbGFiZWwiOwogICAgbGFiZWwudGV4dENvbnRlbnQgPSByb3dMZXR0ZXI7CiAgICBncmlkLmFwcGVuZENoaWxkKGxhYmVsKTsKCiAgICAvLyBXZWxscwogICAgZm9yIChsZXQgY29sID0gMTsgY29sIDw9IFBMQVRFX0NPTFM7IGNvbCsrKSB7CiAgICAgIGNvbnN0IHdlbGxJZCA9IHJvd0xldHRlciArIFN0cmluZyhjb2wpOwogICAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7IC8vIE5vcm1hbGl6ZSB0byB6ZXJvLXBhZGRlZCBmb3JtYXQgZm9yIG1hdGNoaW5nCiAgICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBkaXYuY2xhc3NOYW1lID0gIndlbGwiOwogICAgICBjb25zdCBoYXNEYXRhID0gd2VsbENvdW50cy5oYXNPd25Qcm9wZXJ0eShub3JtYWxpemVkV2VsbElkKTsKICAgICAgZGl2LmRhdGFzZXQud2VsbElkID0gd2VsbElkOwogICAgICBkaXYuZGF0YXNldC5oYXNEYXRhID0gaGFzRGF0YSA/ICJ0cnVlIiA6ICJmYWxzZSI7CiAgICAgIAogICAgICBpZiAoaGFzRGF0YSkgewogICAgICAgIGNvbnN0IHBsYXRlcyA9IHdlbGxDb3VudHNbbm9ybWFsaXplZFdlbGxJZF07CiAgICAgICAgCiAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyB3ZWxsIGlzIGEgY29udHJvbCB3ZWxsIChjb25maWd1cmFibGUgdmlhIGNvbnRyb2xfcm93cykKICAgICAgICBjb25zdCBpc0NvbnRyb2wgPSBpc0NvbnRyb2xXZWxsKHdlbGxJZCk7CiAgICAgICAgCiAgICAgICAgLy8gR2V0IGxhYmVsIGZyb20gcm93LWJhc2VkIGNvbmZpZyBvciBjb250ZW50CiAgICAgICAgLy8gVHJ5IHRvIGZpbmQgdGhlIGFjdHVhbCB3ZWxsIElEIGluIHRoZSBkYXRhIHVzaW5nIG5vcm1hbGl6ZWQgZm9ybWF0CiAgICAgICAgY29uc3QgZmlyc3RQbGF0ZUlkID0gcGxhdGVzWzBdOwogICAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW2ZpcnN0UGxhdGVJZF0gfHwge307CiAgICAgICAgLy8gVHJ5IG5vcm1hbGl6ZWQgSUQgZmlyc3QsIHRoZW4gc2VhcmNoIGZvciBtYXRjaGluZyB3ZWxsIHVzaW5nIG5vcm1hbGl6ZWQgZm9ybWF0CiAgICAgICAgbGV0IGFjdHVhbFdlbGxJZCA9IG5vcm1hbGl6ZWRXZWxsSWQ7CiAgICAgICAgaWYgKCF3ZWxsc1thY3R1YWxXZWxsSWRdKSB7CiAgICAgICAgICAvLyBTZWFyY2ggZm9yIG1hdGNoaW5nIHdlbGwgSUQgdXNpbmcgbm9ybWFsaXplZCBmb3JtYXQKICAgICAgICAgIGNvbnN0IG1hdGNoaW5nS2V5ID0gT2JqZWN0LmtleXMod2VsbHMpLmZpbmQoa2V5ID0+IAogICAgICAgICAgICBub3JtYWxpemVXZWxsSWQoa2V5KSA9PT0gbm9ybWFsaXplZFdlbGxJZAogICAgICAgICAgKTsKICAgICAgICAgIGlmIChtYXRjaGluZ0tleSkgewogICAgICAgICAgICBhY3R1YWxXZWxsSWQgPSBtYXRjaGluZ0tleTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3Qgd2VsbERhdGEgPSB3ZWxsc1thY3R1YWxXZWxsSWRdOwogICAgICAgIGlmICghd2VsbERhdGEpIHsKICAgICAgICAgIC8vIFdlbGwgZGF0YSBub3QgZm91bmQsIHNraXAgdGhpcyB3ZWxsCiAgICAgICAgICBkaXYuc3R5bGUuY3Vyc29yID0gImRlZmF1bHQiOwogICAgICAgICAgZGl2LnN0eWxlLmJhY2tncm91bmQgPSAiI2YyZjJmMiI7CiAgICAgICAgICBncmlkLmFwcGVuZENoaWxkKGRpdik7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgY29uc3QgY29uZmlnID0gdmlld2VyRGF0YS5jb25maWcgfHwge307CiAgICAgICAgY29uc3Qgd2VsbExhYmVscyA9IGNvbmZpZy53ZWxsX2xhYmVscyB8fCB7fTsKICAgICAgICAvLyBFeHRyYWN0IHJvdyBsZXR0ZXIgZnJvbSB3ZWxsSWQgKGUuZy4sICJCMTMiIC0+ICJCIikKICAgICAgICBjb25zdCByb3dMZXR0ZXIgPSBnZXRSb3dMZXR0ZXIod2VsbElkKTsKICAgICAgICAKICAgICAgICAvLyBDb3VudCB1bmlxdWUgZGF0YXNldHMgdGhhdCBhY3R1YWxseSBoYXZlIGRhdGEgZm9yIHRoaXMgd2VsbAogICAgICAgIGNvbnN0IHVuaXF1ZVBsYXRlcyA9IHBsYXRlcy5maWx0ZXIocGxhdGVJZCA9PiB7CiAgICAgICAgICBjb25zdCBwbGF0ZVdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBwbGF0ZSBoYXMgZGF0YSBmb3IgdGhpcyB3ZWxsIHVzaW5nIG5vcm1hbGl6ZWQgZm9ybWF0CiAgICAgICAgICByZXR1cm4gcGxhdGVXZWxsc1thY3R1YWxXZWxsSWRdIHx8IAogICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKHBsYXRlV2VsbHMpLnNvbWUoa2V5ID0+IG5vcm1hbGl6ZVdlbGxJZChrZXkpID09PSBub3JtYWxpemVkV2VsbElkKTsKICAgICAgICB9KTsKICAgICAgICBjb25zdCBkYXRhc2V0Q291bnQgPSB1bmlxdWVQbGF0ZXMubGVuZ3RoOwogICAgICAgIAogICAgICAgIC8vIEZvciBjb250cm9sIHdlbGxzOiBtYWluIHRleHQgaXMgIkNvbnRyb2wiLCBsYWJlbCBiZWxvdyBpcyB0aGUgY29udHJvbCBsYWJlbAogICAgICAgIC8vIEZvciBub24tY29udHJvbCB3ZWxsczogbWFpbiB0ZXh0IGlzIHBsYXRlIGNvdW50IG9yIHdlbGwgSUQsIGxhYmVsIGJlbG93IGlzIHRoZSBjb25maWd1cmVkIGxhYmVsCiAgICAgICAgbGV0IG1haW5UZXh0LCBsYWJlbDsKICAgICAgICBpZiAoaXNDb250cm9sKSB7CiAgICAgICAgICBtYWluVGV4dCA9ICJDb250cm9sIjsKICAgICAgICAgIC8vIEdldCB0aGUgY29udHJvbCBsYWJlbCBmcm9tIGNvbmZpZyBvciB3ZWxsIGRhdGEgYW5kIGZvcm1hdCBpdAogICAgICAgICAgbGFiZWwgPSB3ZWxsTGFiZWxzW3Jvd0xldHRlcl0gfHwgd2VsbERhdGEubGFiZWwgfHwgd2VsbERhdGEuY29udGVudCB8fCAiIjsKICAgICAgICAgIGlmIChsYWJlbCkgewogICAgICAgICAgICBsYWJlbCA9IGZvcm1hdExhYmVsKGxhYmVsKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gU2hvdyBkYXRhc2V0IGNvdW50IGlmIG1vcmUgdGhhbiAxLCBvdGhlcndpc2Ugc2hvdyB3ZWxsIElECiAgICAgICAgICBtYWluVGV4dCA9IGRhdGFzZXRDb3VudCA+IDEgPyBgJHtkYXRhc2V0Q291bnR9YCA6IHdlbGxJZDsKICAgICAgICAgIC8vIFVzZSByb3ctYmFzZWQgbGFiZWwgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgdXNlIHdlbGwncyBsYWJlbCBvciBjb250ZW50CiAgICAgICAgICBsYWJlbCA9IHdlbGxMYWJlbHNbcm93TGV0dGVyXSB8fCB3ZWxsRGF0YS5sYWJlbCB8fCB3ZWxsRGF0YS5jb250ZW50IHx8ICIiOwogICAgICAgICAgLy8gRm9ybWF0IGxhYmVsIChyZW1vdmUgdU0sIGZvcm1hdCBhcyBudW1iZXItbnVtYmVyLW51bWJlcikKICAgICAgICAgIGlmIChsYWJlbCkgewogICAgICAgICAgICBsYWJlbCA9IGZvcm1hdExhYmVsKGxhYmVsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZGl2LnRleHRDb250ZW50ID0gbWFpblRleHQ7CiAgICAgICAgZGl2LnN0eWxlLmN1cnNvciA9ICJwb2ludGVyIjsKICAgICAgICBkaXYuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJhdXRvIjsKICAgICAgICBkaXYuc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogICAgICAgIGRpdi5zdHlsZS56SW5kZXggPSAiMSI7CiAgICAgICAgCiAgICAgICAgLy8gQWRkIHZpc3VhbCBpbmRpY2F0b3IgZm9yIGR1cGxpY2F0ZSB3ZWxscwogICAgICAgIGlmIChpc0R1cGxpY2F0ZVdlbGwod2VsbElkKSkgewogICAgICAgICAgZGl2LnN0eWxlLmJvcmRlcldpZHRoID0gIjJweCI7CiAgICAgICAgICBkaXYuc3R5bGUuYm9yZGVyU3R5bGUgPSAiZG91YmxlIjsKICAgICAgICAgIGRpdi50aXRsZSA9IChkaXYudGl0bGUgfHwgIiIpICsgIiDimqDvuI8gRHVwbGljYXRlIHdlbGwgLSBjbGljayB0byBjb21wYXJlIGRhdGFzZXRzIjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKGxhYmVsKSB7CiAgICAgICAgICBjb25zdCBsYWJlbERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgbGFiZWxEaXYuY2xhc3NOYW1lID0gIndlbGwtbGFiZWwiOwogICAgICAgICAgbGFiZWxEaXYudGV4dENvbnRlbnQgPSBsYWJlbDsKICAgICAgICAgIGxhYmVsRGl2LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAibm9uZSI7CiAgICAgICAgICBkaXYuYXBwZW5kQ2hpbGQobGFiZWxEaXYpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBkaXYuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoZSkgPT4gewogICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIHRvZ2dsZVdlbGxTZWxlY3Rpb24od2VsbElkLCBwbGF0ZXMpOwogICAgICAgIH0pOwogICAgICAgIGlmIChpc0NvbnRyb2wpIHsKICAgICAgICAgIGRpdi5jbGFzc0xpc3QuYWRkKCJjb250cm9sIik7CiAgICAgICAgICBkaXYudGl0bGUgPSAiQ29udHJvbCB3ZWxsIChpbmRlcGVuZGVudGx5IHNlbGVjdGFibGUpIjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyB3ZWxsIGlzIHBhcnQgb2YgYSB0cmlwbGljYXRlIGdyb3VwIChjb250cm9scyBhcmUgbmV2ZXIgaW4gdHJpcGxpY2F0ZSBncm91cHMpCiAgICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgICAgIGNvbnN0IHRyaXBsaWNhdGVHcm91cCA9IGdldFRyaXBsaWNhdGVHcm91cCh3ZWxsSWQsIGNvbHVtbik7CiAgICAgICAgCiAgICAgICAgLy8gQWRkIHZpc3VhbCBpbmRpY2F0b3IgZm9yIHRyaXBsaWNhdGUgZ3JvdXBzIHdpdGggZGlzdGluY3QgY29sb3JzCiAgICAgICAgLy8gQWxsIHdlbGxzIGluIHRoZSBzYW1lIHRyaXBsaWNhdGUgZ3JvdXAgKHNhbWUgbmFtZSkgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgICAgICAgLy8gRm9yIGV4YW1wbGUsIGFsbCB3ZWxscyBpbiByb3dzIEIsIEMsIEQgd2l0aCBncm91cCBuYW1lICIyNTAtMTAtMiIgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgICAgICAgLy8gQm9yZGVycy9zdHJva2VzIG9ubHkgYXBwZWFyIHdoZW4gc2VsZWN0ZWQKICAgICAgICBpZiAodHJpcGxpY2F0ZUdyb3VwICYmIHRyaXBsaWNhdGVHcm91cC5uYW1lKSB7CiAgICAgICAgICBkaXYuY2xhc3NMaXN0LmFkZCgidHJpcGxpY2F0ZS1ncm91cCIpOwogICAgICAgICAgZGl2LnRpdGxlID0gYFRyaXBsaWNhdGUgZ3JvdXA6ICR7dHJpcGxpY2F0ZUdyb3VwLm5hbWV9IChjbGljayB0byBzZWxlY3QgYWxsKWA7CiAgICAgICAgICAKICAgICAgICAgIC8vIEFwcGx5IGRpc3RpbmN0IGNvbG9yIGZvciB0aGlzIHRyaXBsaWNhdGUgZ3JvdXAgKGJhY2tncm91bmQgb25seSwgbm8gYm9yZGVyIHVubGVzcyBzZWxlY3RlZCkKICAgICAgICAgIC8vIEFsbCB3ZWxscyB3aXRoIHRoZSBzYW1lIGdyb3VwIG5hbWUgd2lsbCBnZXQgdGhlIHNhbWUgY29sb3IKICAgICAgICAgIC8vIFRoaXMgZW5zdXJlcyBCLCBDLCBEIHJvd3MgYWxsIGdldCB0aGUgc2FtZSBjb2xvciBmb3IgdGhlIHNhbWUgdHJpcGxpY2F0ZSBncm91cAogICAgICAgICAgY29uc3QgZ3JvdXBOYW1lID0gU3RyaW5nKHRyaXBsaWNhdGVHcm91cC5uYW1lIHx8ICIiKS50cmltKCk7IC8vIE5vcm1hbGl6ZSBncm91cCBuYW1lCiAgICAgICAgICBjb25zdCBjb2xvciA9IGdldFRyaXBsaWNhdGVHcm91cENvbG9yKGdyb3VwTmFtZSk7CiAgICAgICAgICBpZiAoY29sb3IgJiYgY29sb3IuYmdIYXNEYXRhKSB7CiAgICAgICAgICAgIC8vIFNldCBiYWNrZ3JvdW5kIGNvbG9yIG9ubHkgLSBib3JkZXJzIHdpbGwgYmUgYWRkZWQgd2hlbiBzZWxlY3RlZAogICAgICAgICAgICBjb25zdCBiZ0NvbG9yID0gaGFzRGF0YSA/IGNvbG9yLmJnSGFzRGF0YSA6IGNvbG9yLmJnOwogICAgICAgICAgICBkaXYuc3R5bGUuc2V0UHJvcGVydHkoImJhY2tncm91bmQtY29sb3IiLCBiZ0NvbG9yLCAiaW1wb3J0YW50Iik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIEhpZ2hsaWdodCBpZiBzZWxlY3RlZCAoY2hlY2sgaWYgYW55IHNlbGVjdGVkIGRhdGFzZXQgaGFzIHRoaXMgd2VsbCBzZWxlY3RlZCkKICAgICAgICAvLyBBbHNvIGNoZWNrIGlmIHRoaXMgd2VsbCBpcyBwYXJ0IG9mIGEgdHJpcGxpY2F0ZSBncm91cCB0aGF0J3Mgc2VsZWN0ZWQKICAgICAgICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogICAgICAgIGxldCBpc1NlbGVjdGVkID0gZmFsc2U7CiAgICAgICAgCiAgICAgICAgaWYgKHRyaXBsaWNhdGVHcm91cCkgewogICAgICAgICAgLy8gQ2hlY2sgaWYgYW55IHdlbGwgaW4gdGhpcyB0cmlwbGljYXRlIGdyb3VwIChzYW1lIHJvdyBwYXR0ZXJuLCBzYW1lIGNvbHVtbikgaXMgc2VsZWN0ZWQKICAgICAgICAgIGNvbnN0IGdyb3VwUm93TGV0dGVycyA9IGdldFJvd0xldHRlcnNGcm9tV2VsbHModHJpcGxpY2F0ZUdyb3VwLndlbGxzKTsKICAgICAgICAgIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgICAgICAgaWYgKCFwbGF0ZXMuaW5jbHVkZXMocGxhdGVJZCkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZ3JvdXBSb3dMZXR0ZXJzLmZvckVhY2gocm93TGV0dGVyID0+IHsKICAgICAgICAgICAgICBjb25zdCB3SWQgPSByb3dMZXR0ZXIgKyBjb2x1bW47CiAgICAgICAgICAgICAgY29uc3Qgbm9ybWFsaXplZFdJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3SWQpOwogICAgICAgICAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7bm9ybWFsaXplZFdJZH1gOwogICAgICAgICAgICAgIGlmIChzZWxlY3RlZFdlbGxzLmhhcyhrZXkpKSB7CiAgICAgICAgICAgICAgICBpc1NlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIENoZWNrIGlmIHRoaXMgc3BlY2lmaWMgd2VsbCBpcyBzZWxlY3RlZAogICAgICAgICAgY29uc3Qgbm9ybWFsaXplZFdlbGxJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpOwogICAgICAgICAgaXNTZWxlY3RlZCA9IHNlbGVjdGVkRGF0YXNldHMuc29tZShwbGF0ZUlkID0+IHsKICAgICAgICAgICAgaWYgKHBsYXRlcy5pbmNsdWRlcyhwbGF0ZUlkKSkgewogICAgICAgICAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7bm9ybWFsaXplZFdlbGxJZH1gOwogICAgICAgICAgICAgIHJldHVybiBzZWxlY3RlZFdlbGxzLmhhcyhrZXkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoaXNTZWxlY3RlZCkgewogICAgICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoInNlbGVjdGVkIik7CiAgICAgICAgICAvLyBVcGRhdGUgYmFja2dyb3VuZCBjb2xvciBhbmQgYWRkIGJvcmRlciBmb3Igc2VsZWN0ZWQgdHJpcGxpY2F0ZSBncm91cHMKICAgICAgICAgIGlmICh0cmlwbGljYXRlR3JvdXAgJiYgdHJpcGxpY2F0ZUdyb3VwLm5hbWUpIHsKICAgICAgICAgICAgY29uc3QgZ3JvdXBOYW1lID0gU3RyaW5nKHRyaXBsaWNhdGVHcm91cC5uYW1lIHx8ICIiKS50cmltKCk7IC8vIE5vcm1hbGl6ZSBncm91cCBuYW1lCiAgICAgICAgICAgIGNvbnN0IGNvbG9yID0gZ2V0VHJpcGxpY2F0ZUdyb3VwQ29sb3IoZ3JvdXBOYW1lKTsKICAgICAgICAgICAgaWYgKGNvbG9yKSB7CiAgICAgICAgICAgICAgZGl2LnN0eWxlLnNldFByb3BlcnR5KCJiYWNrZ3JvdW5kLWNvbG9yIiwgY29sb3IuYmdIYXNEYXRhLCAiaW1wb3J0YW50Iik7CiAgICAgICAgICAgICAgLy8gQWRkIGJvcmRlciB3aGVuIHNlbGVjdGVkCiAgICAgICAgICAgICAgZGl2LnN0eWxlLnNldFByb3BlcnR5KCJib3JkZXItY29sb3IiLCBjb2xvci5ib3JkZXIsICJpbXBvcnRhbnQiKTsKICAgICAgICAgICAgICBkaXYuc3R5bGUuc2V0UHJvcGVydHkoImJvcmRlci13aWR0aCIsICIycHgiLCAiaW1wb3J0YW50Iik7CiAgICAgICAgICAgICAgZGl2LnN0eWxlLnNldFByb3BlcnR5KCJib3JkZXItc3R5bGUiLCAic29saWQiLCAiaW1wb3J0YW50Iik7CiAgICAgICAgICAgICAgZGl2LnN0eWxlLnNldFByb3BlcnR5KCJvdXRsaW5lIiwgYDJweCBzb2xpZCAke2NvbG9yLmJvcmRlcn1gLCAiaW1wb3J0YW50Iik7CiAgICAgICAgICAgICAgZGl2LnN0eWxlLnNldFByb3BlcnR5KCJvdXRsaW5lLW9mZnNldCIsICItMnB4IiwgImltcG9ydGFudCIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGRpdi5zdHlsZS5jdXJzb3IgPSAiZGVmYXVsdCI7CiAgICAgICAgZGl2LnN0eWxlLmJhY2tncm91bmQgPSAiI2YyZjJmMiI7CiAgICAgIH0KICAgICAgZ3JpZC5hcHBlbmRDaGlsZChkaXYpOwogICAgfQogIH0pOwogIAogIC8vIFVwZGF0ZSBjb2x1bW4gbGVnZW5kIHdpdGggZGF0YXNldCBtYXBwaW5nICh1c2UgYWxsIGRhdGFzZXRzIGluIGdyb3VwKQogIHVwZGF0ZUNvbHVtbkxlZ2VuZChjb2x1bW5JbmZvTWFwLCBhbGxHcm91cERhdGFzZXRzKTsKfQoKZnVuY3Rpb24gdXBkYXRlQ29sdW1uTGVnZW5kKGNvbHVtbkluZm9NYXAsIGFsbERhdGFzZXRzKSB7CiAgY29uc3QgbGVnZW5kRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNvbHVtbi1sZWdlbmQtY29udGVudCIpOwogIGlmICghbGVnZW5kRGl2KSByZXR1cm47CiAgCiAgLy8gQnVpbGQgbWFwOiBjb2x1bW4gLT4geyBkYXRhc2V0czogU2V0LCBpbmZvOiB7IGdlbm90eXBlLCBidWZmZXIsIHNjaWVudGlzdCB9IH0KICBjb25zdCBjb2x1bW5EYXRhID0ge307IC8vIGNvbHVtbiAtPiB7IGRhdGFzZXRzOiBTZXQsIGluZm86IHt9IH0KICAKICAvLyBGaW5kIHdoaWNoIGRhdGFzZXRzIGhhdmUgZGF0YSBpbiBlYWNoIGNvbHVtbgogIGZvciAobGV0IGNvbCA9IDE7IGNvbCA8PSBQTEFURV9DT0xTOyBjb2wrKykgewogICAgY29uc3QgaW5mbyA9IGNvbHVtbkluZm9NYXBbY29sXTsKICAgIGlmICghaW5mbykgY29udGludWU7CiAgICAKICAgIGNvbHVtbkRhdGFbY29sXSA9IHsKICAgICAgZGF0YXNldHM6IG5ldyBTZXQoKSwKICAgICAgaW5mbzogewogICAgICAgIGdlbm90eXBlOiBpbmZvLmdlbm90eXBlIHx8ICIiLAogICAgICAgIGJ1ZmZlcjogaW5mby5idWZmZXIgfHwgIiIsCiAgICAgICAgc2NpZW50aXN0OiBpbmZvLnNjaWVudGlzdCB8fCAiIgogICAgICB9CiAgICB9OwogICAgCiAgICAvLyBGaW5kIGFsbCBkYXRhc2V0cyB0aGF0IGhhdmUgZGF0YSBpbiB0aGlzIGNvbHVtbgogICAgYWxsRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICAgIGNvbnN0IGhhc0RhdGFJbkNvbHVtbiA9IE9iamVjdC5rZXlzKHdlbGxzKS5zb21lKHdlbGxJZCA9PiB7CiAgICAgICAgY29uc3Qgd2VsbENvbCA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgICAgICByZXR1cm4gd2VsbENvbCA9PT0gY29sOwogICAgICB9KTsKICAgICAgCiAgICAgIGlmIChoYXNEYXRhSW5Db2x1bW4pIHsKICAgICAgICBjb2x1bW5EYXRhW2NvbF0uZGF0YXNldHMuYWRkKHBsYXRlSWQpOwogICAgICB9CiAgICB9KTsKICB9CiAgCiAgaWYgKE9iamVjdC5rZXlzKGNvbHVtbkRhdGEpLmxlbmd0aCA9PT0gMCkgewogICAgbGVnZW5kRGl2LmlubmVySFRNTCA9ICI8ZGl2IHN0eWxlPSdjb2xvcjogIzY2NjsgZm9udC1zaXplOiAwLjhyZW07Jz5ObyBjb2x1bW4gaW5mb3JtYXRpb24gYXZhaWxhYmxlLjwvZGl2PiI7CiAgICByZXR1cm47CiAgfQogIAogIC8vIEJ1aWxkIEhUTUwgd2l0aCBpbmRpdmlkdWFsIGNvbHVtbiBjaGVja2JveGVzCiAgbGVnZW5kRGl2LmlubmVySFRNTCA9ICIiOwogIAogIC8vIFNvcnQgY29sdW1ucyBudW1lcmljYWxseQogIGNvbnN0IHNvcnRlZENvbHVtbnMgPSBPYmplY3Qua2V5cyhjb2x1bW5EYXRhKS5tYXAoTnVtYmVyKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7CiAgCiAgc29ydGVkQ29sdW1ucy5mb3JFYWNoKGNvbCA9PiB7CiAgICBjb25zdCBjb2xEYXRhID0gY29sdW1uRGF0YVtjb2xdOwogICAgY29uc3QgY29sRGF0YXNldHMgPSBBcnJheS5mcm9tKGNvbERhdGEuZGF0YXNldHMpOwogICAgCiAgICBpZiAoY29sRGF0YXNldHMubGVuZ3RoID09PSAwKSByZXR1cm47IC8vIFNraXAgY29sdW1ucyB3aXRoIG5vIGRhdGEKICAgIAogICAgLy8gQ2hlY2sgaWYgdGhpcyBjb2x1bW4gaXMgZW5hYmxlZCAoZW1wdHkgc2V0ID0gYWxsIGVuYWJsZWQsIG9yIGNvbHVtbiBpcyBpbiB0aGUgc2V0KQogICAgY29uc3QgY29sdW1uRW5hYmxlZCA9IGVuYWJsZWRDb2x1bW5zLnNpemUgPT09IDAgfHwgZW5hYmxlZENvbHVtbnMuaGFzKGNvbCk7CiAgICAKICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgZGl2LnN0eWxlLm1hcmdpbkJvdHRvbSA9ICI2cHgiOwogICAgZGl2LnN0eWxlLnBhZGRpbmcgPSAiNnB4IjsKICAgIGRpdi5zdHlsZS5iYWNrZ3JvdW5kID0gIiNmOWY5ZjkiOwogICAgZGl2LnN0eWxlLmJvcmRlclJhZGl1cyA9ICIzcHgiOwogICAgCiAgICBjb25zdCBjaGVja2JveCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICBjaGVja2JveC50eXBlID0gImNoZWNrYm94IjsKICAgIGNoZWNrYm94LmlkID0gYGNvbHVtbi0ke2NvbH1gOwogICAgY2hlY2tib3guY2hlY2tlZCA9IGNvbHVtbkVuYWJsZWQ7CiAgICBjaGVja2JveC5zdHlsZS5tYXJnaW5SaWdodCA9ICI4cHgiOwogICAgY2hlY2tib3guc3R5bGUuY3Vyc29yID0gInBvaW50ZXIiOwogICAgY2hlY2tib3guZGF0YXNldC5jb2x1bW4gPSBjb2w7CiAgICBjaGVja2JveC5kYXRhc2V0LmRhdGFzZXRzID0gSlNPTi5zdHJpbmdpZnkoY29sRGF0YXNldHMpOwogICAgCiAgICBjaGVja2JveC5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCAoZSkgPT4gewogICAgICBjb25zdCBjb2x1bW4gPSBwYXJzZUludChlLnRhcmdldC5kYXRhc2V0LmNvbHVtbik7CiAgICAgIGNvbnN0IGFsbEdyb3VwRGF0YXNldHMgPSBnZXRBbGxEYXRhc2V0c0luR3JvdXAoKTsKICAgICAgCiAgICAgIC8vIEdldCBhbGwgY29sdW1ucyB0aGF0IGhhdmUgZGF0YQogICAgICBjb25zdCBhbGxDb2x1bW5zV2l0aERhdGEgPSBuZXcgU2V0KCk7CiAgICAgIGFsbEdyb3VwRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgICAgICBPYmplY3Qua2V5cyh3ZWxscykuZm9yRWFjaCh3ZWxsSWQgPT4gewogICAgICAgICAgY29uc3QgY29sID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgICAgICAgYWxsQ29sdW1uc1dpdGhEYXRhLmFkZChjb2wpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgCiAgICAgIGlmIChlLnRhcmdldC5jaGVja2VkKSB7CiAgICAgICAgLy8gRW5hYmxpbmc6IGFkZCBjb2x1bW4gdG8gZW5hYmxlZCBzZXQKICAgICAgICBlbmFibGVkQ29sdW1ucy5hZGQoY29sdW1uKTsKICAgICAgICAKICAgICAgICAvLyBJZiBhbGwgY29sdW1ucyBhcmUgbm93IGVuYWJsZWQsIGNsZWFyIHRoZSBzZXQgKG1lYW5pbmcgYWxsIGVuYWJsZWQpCiAgICAgICAgaWYgKEFycmF5LmZyb20oYWxsQ29sdW1uc1dpdGhEYXRhKS5ldmVyeShjb2wgPT4gZW5hYmxlZENvbHVtbnMuaGFzKGNvbCkpKSB7CiAgICAgICAgICBlbmFibGVkQ29sdW1ucy5jbGVhcigpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBEaXNhYmxpbmc6IGlmIHNldCBpcyBlbXB0eSAoYWxsIGVuYWJsZWQpLCBwb3B1bGF0ZSBpdCB3aXRoIGFsbCBjb2x1bW5zIGV4Y2VwdCB0aGUgb25lIGJlaW5nIHVuY2hlY2tlZAogICAgICAgIGlmIChlbmFibGVkQ29sdW1ucy5zaXplID09PSAwKSB7CiAgICAgICAgICAvLyBDdXJyZW50bHkgYWxsIGFyZSBlbmFibGVkLCBzbyBlbmFibGUgYWxsIGNvbHVtbnMgZXhjZXB0IHRoZSBvbmUgYmVpbmcgdW5jaGVja2VkCiAgICAgICAgICBhbGxDb2x1bW5zV2l0aERhdGEuZm9yRWFjaChjb2wgPT4gewogICAgICAgICAgICBpZiAoY29sICE9PSBjb2x1bW4pIHsKICAgICAgICAgICAgICBlbmFibGVkQ29sdW1ucy5hZGQoY29sKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFNvbWUgY29sdW1ucyBhcmUgYWxyZWFkeSBkaXNhYmxlZCwgcmVtb3ZlIHRoaXMgb25lIGZyb20gZW5hYmxlZCBzZXQKICAgICAgICAgIGVuYWJsZWRDb2x1bW5zLmRlbGV0ZShjb2x1bW4pOwogICAgICAgIH0KICAgICAgfQogICAgICAKICAgICAgcmVuZGVyUGxhdGVHcmlkKCk7CiAgICAgIHVwZGF0ZVdlbGxJbmZvKCk7CiAgICAgIHVwZGF0ZUNoYXJ0KCk7CiAgICB9KTsKICAgIAogICAgY29uc3QgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOwogICAgbGFiZWwuaHRtbEZvciA9IGBjb2x1bW4tJHtjb2x9YDsKICAgIGxhYmVsLnN0eWxlLmN1cnNvciA9ICJwb2ludGVyIjsKICAgIGxhYmVsLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgICBsYWJlbC5zdHlsZS5hbGlnbkl0ZW1zID0gImNlbnRlciI7CiAgICBsYWJlbC5zdHlsZS5mb250V2VpZ2h0ID0gIjYwMCI7CiAgICAKICAgIGxhYmVsLmFwcGVuZENoaWxkKGNoZWNrYm94KTsKICAgIGNvbnN0IGxhYmVsVGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgIGxhYmVsVGV4dC50ZXh0Q29udGVudCA9IGBDb2x1bW4gJHtjb2x9YDsKICAgIGxhYmVsLmFwcGVuZENoaWxkKGxhYmVsVGV4dCk7CiAgICAKICAgIGRpdi5hcHBlbmRDaGlsZChsYWJlbCk7CiAgICAKICAgIGNvbnN0IGRldGFpbHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGRldGFpbHMuc3R5bGUuZm9udFNpemUgPSAiMC43NXJlbSI7CiAgICBkZXRhaWxzLnN0eWxlLm1hcmdpbkxlZnQgPSAiMjRweCI7CiAgICBkZXRhaWxzLnN0eWxlLm1hcmdpblRvcCA9ICI0cHgiOwogICAgCiAgICBpZiAoY29sRGF0YS5pbmZvLmdlbm90eXBlKSB7CiAgICAgIGNvbnN0IGdlbkRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBnZW5EaXYuc3R5bGUubWFyZ2luQm90dG9tID0gIjJweCI7CiAgICAgIGdlbkRpdi5pbm5lckhUTUwgPSBgPHN0cm9uZz5HZW5vdHlwZTo8L3N0cm9uZz4gJHtjb2xEYXRhLmluZm8uZ2Vub3R5cGV9YDsKICAgICAgZGV0YWlscy5hcHBlbmRDaGlsZChnZW5EaXYpOwogICAgfQogICAgaWYgKGNvbERhdGEuaW5mby5idWZmZXIpIHsKICAgICAgY29uc3QgYnVmRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGJ1ZkRpdi5zdHlsZS5tYXJnaW5Cb3R0b20gPSAiMnB4IjsKICAgICAgYnVmRGl2LmlubmVySFRNTCA9IGA8c3Ryb25nPkJ1ZmZlcjo8L3N0cm9uZz4gJHtjb2xEYXRhLmluZm8uYnVmZmVyfWA7CiAgICAgIGRldGFpbHMuYXBwZW5kQ2hpbGQoYnVmRGl2KTsKICAgIH0KICAgIGlmIChjb2xEYXRhLmluZm8uc2NpZW50aXN0KSB7CiAgICAgIGNvbnN0IHNjaURpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBzY2lEaXYuaW5uZXJIVE1MID0gYDxzdHJvbmc+U2NpZW50aXN0Ojwvc3Ryb25nPiAke2NvbERhdGEuaW5mby5zY2llbnRpc3R9YDsKICAgICAgZGV0YWlscy5hcHBlbmRDaGlsZChzY2lEaXYpOwogICAgfQogICAgCiAgICBpZiAoY29sRGF0YXNldHMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBjb3VudERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBjb3VudERpdi5zdHlsZS5tYXJnaW5Ub3AgPSAiNHB4IjsKICAgICAgY291bnREaXYuc3R5bGUuZm9udFNpemUgPSAiMC43cmVtIjsKICAgICAgY291bnREaXYuc3R5bGUuY29sb3IgPSAiIzY2NiI7CiAgICAgIGNvdW50RGl2LnRleHRDb250ZW50ID0gYCR7Y29sRGF0YXNldHMubGVuZ3RofSBkYXRhc2V0JHtjb2xEYXRhc2V0cy5sZW5ndGggIT09IDEgPyAicyIgOiAiIn1gOwogICAgICBkZXRhaWxzLmFwcGVuZENoaWxkKGNvdW50RGl2KTsKICAgIH0KICAgIAogICAgZGl2LmFwcGVuZENoaWxkKGRldGFpbHMpOwogICAgbGVnZW5kRGl2LmFwcGVuZENoaWxkKGRpdik7CiAgfSk7Cn0KCmZ1bmN0aW9uIHRvZ2dsZVdlbGxTZWxlY3Rpb24od2VsbElkLCBwbGF0ZUlkcykgewogIC8vIFRvZ2dsZSBzZWxlY3Rpb24gZm9yIGFsbCBzZWxlY3RlZCBkYXRhc2V0cwogIGlmICghc2VsZWN0ZWREYXRhc2V0SWQpIHJldHVybjsKICAKICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICBjb25zdCBpc0NvbnRyb2wgPSBpc0NvbnRyb2xXZWxsKHdlbGxJZCk7CiAgCiAgLy8gQ29udHJvbCB3ZWxsczogYWxsb3cgaW5kaXZpZHVhbCBzZWxlY3Rpb24gKGNhbiBzZWxlY3QgZWFjaCB3ZWxsIHNlcGFyYXRlbHkpCiAgaWYgKGlzQ29udHJvbCkgewogICAgY29uc3Qgbm9ybWFsaXplZFdlbGxJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpOwogICAgLy8gQ2hlY2sgaWYgdGhpcyBzcGVjaWZpYyBjb250cm9sIHdlbGwgaXMgYWxyZWFkeSBzZWxlY3RlZAogICAgbGV0IGlzU2VsZWN0ZWQgPSBmYWxzZTsKICAgIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgaWYgKHBsYXRlSWRzLmluY2x1ZGVzKHBsYXRlSWQpKSB7CiAgICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHtub3JtYWxpemVkV2VsbElkfWA7CiAgICAgICAgaWYgKHNlbGVjdGVkV2VsbHMuaGFzKGtleSkpIHsKICAgICAgICAgIGlzU2VsZWN0ZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICAKICAgIC8vIFRvZ2dsZSBqdXN0IHRoaXMgaW5kaXZpZHVhbCBjb250cm9sIHdlbGwgYWNyb3NzIGFsbCBzZWxlY3RlZCBkYXRhc2V0cwogICAgbGV0IGFueUNoYW5nZWQgPSBmYWxzZTsKICAgIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgLy8gT25seSB0b2dnbGUgaWYgdGhpcyBwbGF0ZSBoYXMgZGF0YSBmb3IgdGhpcyB3ZWxsCiAgICAgIGlmIChwbGF0ZUlkcy5pbmNsdWRlcyhwbGF0ZUlkKSkgewogICAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICAgIGNvbnN0IGhhc0RhdGEgPSB3ZWxsc1tub3JtYWxpemVkV2VsbElkXSB8fCB3ZWxsc1t3ZWxsSWRdOwogICAgICAgIGlmICghaGFzRGF0YSkgewogICAgICAgICAgcmV0dXJuOyAvLyBTa2lwIGlmIG5vIGRhdGEKICAgICAgICB9CiAgICAgICAgLy8gRmlsdGVyIGJ5IGVuYWJsZWRXZWxscyBpZiBhbnkgYXJlIHNldAogICAgICAgIGlmIChlbmFibGVkV2VsbHMuc2l6ZSA+IDAgJiYgIWVuYWJsZWRXZWxscy5oYXMod2VsbElkKSAmJiAhZW5hYmxlZFdlbGxzLmhhcyhub3JtYWxpemVkV2VsbElkKSkgewogICAgICAgICAgcmV0dXJuOyAvLyBTa2lwIGV4Y2x1ZGVkIHdlbGxzCiAgICAgICAgfQogICAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7bm9ybWFsaXplZFdlbGxJZH1gOwogICAgICAgIGlmIChpc1NlbGVjdGVkKSB7CiAgICAgICAgICBzZWxlY3RlZFdlbGxzLmRlbGV0ZShrZXkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxlY3RlZFdlbGxzLmFkZChrZXkpOwogICAgICAgIH0KICAgICAgICBhbnlDaGFuZ2VkID0gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgICAKICAgIGlmIChhbnlDaGFuZ2VkKSB7CiAgICAgIHJlbmRlclBsYXRlR3JpZCgpOwogICAgICB1cGRhdGVXZWxsSW5mbygpOwogICAgICB1cGRhdGVDaGFydCgpOwogICAgfQogICAgcmV0dXJuOwogIH0KICAKICAvLyBGb3IgZHVwbGljYXRlIHdlbGxzLCBhdXRvbWF0aWNhbGx5IHNlbGVjdCBhbGwgZGF0YXNldHMgZm9yIGNvbXBhcmlzb24KICBpZiAoaXNEdXBsaWNhdGVXZWxsKHdlbGxJZCkpIHsKICAgIC8vIEZpbmQgYWxsIGRhdGFzZXRzIHRoYXQgaGF2ZSB0aGlzIHdlbGwKICAgIGNvbnN0IGFsbEdyb3VwRGF0YXNldHMgPSBnZXRBbGxEYXRhc2V0c0luR3JvdXAoKTsKICAgIGNvbnN0IG5vcm1hbGl6ZWRXZWxsSWQgPSBub3JtYWxpemVXZWxsSWQod2VsbElkKTsKICAgIGNvbnN0IGRhdGFzZXRzV2l0aFdlbGwgPSBhbGxHcm91cERhdGFzZXRzLmZpbHRlcihwbGF0ZUlkID0+IHsKICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICAgIHJldHVybiB3ZWxsc1tub3JtYWxpemVkV2VsbElkXSB8fCB3ZWxsc1t3ZWxsSWRdOwogICAgfSk7CiAgICAKICAgIC8vIENoZWNrIGlmIGFueSBkYXRhc2V0IGZvciB0aGlzIHdlbGwgaXMgYWxyZWFkeSBzZWxlY3RlZAogICAgbGV0IGlzQW55U2VsZWN0ZWQgPSBkYXRhc2V0c1dpdGhXZWxsLnNvbWUocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7bm9ybWFsaXplZFdlbGxJZH1gOwogICAgICByZXR1cm4gc2VsZWN0ZWRXZWxscy5oYXMoa2V5KTsKICAgIH0pOwogICAgCiAgICAvLyBUb2dnbGUgYWxsIGRhdGFzZXRzIGZvciB0aGlzIGR1cGxpY2F0ZSB3ZWxsCiAgICBsZXQgYW55Q2hhbmdlZCA9IGZhbHNlOwogICAgZGF0YXNldHNXaXRoV2VsbC5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke25vcm1hbGl6ZWRXZWxsSWR9YDsKICAgICAgaWYgKGlzQW55U2VsZWN0ZWQpIHsKICAgICAgICBzZWxlY3RlZFdlbGxzLmRlbGV0ZShrZXkpOwogICAgICB9IGVsc2UgewogICAgICAgIHNlbGVjdGVkV2VsbHMuYWRkKGtleSk7CiAgICAgIH0KICAgICAgYW55Q2hhbmdlZCA9IHRydWU7CiAgICB9KTsKICAgIAogICAgaWYgKGFueUNoYW5nZWQpIHsKICAgICAgcmVuZGVyUGxhdGVHcmlkKCk7CiAgICAgIHVwZGF0ZVdlbGxJbmZvKCk7CiAgICAgIHVwZGF0ZUNoYXJ0KCk7CiAgICB9CiAgICByZXR1cm47CiAgfQogIAogIC8vIEZvciBub24tY29udHJvbCB3ZWxscywgY2hlY2sgdHJpcGxpY2F0ZSBncm91cHMKICBjb25zdCB0cmlwbGljYXRlR3JvdXAgPSBnZXRUcmlwbGljYXRlR3JvdXAod2VsbElkLCBjb2x1bW4pOwogIAogIGxldCBhbnlDaGFuZ2VkID0gZmFsc2U7CiAgCiAgLy8gQ2hlY2sgaWYgdHJpcGxpY2F0ZSBncm91cCBpcyBzZWxlY3RlZCAoY2hlY2sgaWYgQUxMIHdlbGxzIGluIHRoZSBncm91cCBhcmUgc2VsZWN0ZWQpCiAgbGV0IGlzR3JvdXBTZWxlY3RlZCA9IGZhbHNlOwogIGlmICh0cmlwbGljYXRlR3JvdXApIHsKICAgIGNvbnN0IGdyb3VwUm93TGV0dGVycyA9IGdldFJvd0xldHRlcnNGcm9tV2VsbHModHJpcGxpY2F0ZUdyb3VwLndlbGxzKTsKICAgIC8vIENvdW50IGhvdyBtYW55IHdlbGxzIGluIHRoZSBncm91cCBhcmUgc2VsZWN0ZWQKICAgIGxldCBzZWxlY3RlZENvdW50ID0gMDsKICAgIGxldCB0b3RhbENvdW50ID0gMDsKICAgIAogICAgc2VsZWN0ZWREYXRhc2V0cy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgICAgZ3JvdXBSb3dMZXR0ZXJzLmZvckVhY2gocm93TGV0dGVyID0+IHsKICAgICAgICBjb25zdCB3SWQgPSByb3dMZXR0ZXIgKyBjb2x1bW47CiAgICAgICAgY29uc3Qgbm9ybWFsaXplZFdJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3SWQpOwogICAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7bm9ybWFsaXplZFdJZH1gOwogICAgICAgIGNvbnN0IGhhc0RhdGEgPSB3ZWxsc1tub3JtYWxpemVkV0lkXSB8fCB3ZWxsc1t3SWRdOwogICAgICAgIGlmIChoYXNEYXRhKSB7CiAgICAgICAgICB0b3RhbENvdW50Kys7CiAgICAgICAgICBpZiAoc2VsZWN0ZWRXZWxscy5oYXMoa2V5KSkgewogICAgICAgICAgICBzZWxlY3RlZENvdW50Kys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogICAgCiAgICAvLyBDb25zaWRlciBncm91cCBzZWxlY3RlZCBpZiBhdCBsZWFzdCBvbmUgd2VsbCBpcyBzZWxlY3RlZCAoZm9yIHRvZ2dsZSBiZWhhdmlvcikKICAgIC8vIFRoaXMgYWxsb3dzIGNsaWNraW5nIHRvIHRvZ2dsZSB0aGUgd2hvbGUgZ3JvdXAKICAgIGlzR3JvdXBTZWxlY3RlZCA9IHNlbGVjdGVkQ291bnQgPiAwOwogIH0gZWxzZSB7CiAgICAvLyBGb3Igbm9uLXRyaXBsaWNhdGUgd2VsbHMsIGNoZWNrIGlmIHRoaXMgc3BlY2lmaWMgd2VsbCBpcyBzZWxlY3RlZAogICAgY29uc3Qgbm9ybWFsaXplZFdlbGxJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpOwogICAgc2VsZWN0ZWREYXRhc2V0cy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBpZiAocGxhdGVJZHMuaW5jbHVkZXMocGxhdGVJZCkpIHsKICAgICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke25vcm1hbGl6ZWRXZWxsSWR9YDsKICAgICAgICBpZiAoc2VsZWN0ZWRXZWxscy5oYXMoa2V5KSkgewogICAgICAgICAgaXNHcm91cFNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICAKICAvLyBUb2dnbGUgc2VsZWN0aW9uOiBpZiBncm91cC93ZWxsIGlzIHNlbGVjdGVkLCByZW1vdmUgYWxsOyBvdGhlcndpc2UgYWRkIGFsbAogIGlmICh0cmlwbGljYXRlR3JvdXApIHsKICAgIC8vIEdldCByb3cgbGV0dGVycyBmcm9tIHRoZSB0cmlwbGljYXRlIGdyb3VwIHBhdHRlcm4KICAgIGNvbnN0IGdyb3VwUm93TGV0dGVycyA9IGdldFJvd0xldHRlcnNGcm9tV2VsbHModHJpcGxpY2F0ZUdyb3VwLndlbGxzKTsKICAgIAogICAgLy8gVG9nZ2xlIGFsbCB3ZWxscyBpbiB0aGUgdHJpcGxpY2F0ZSBncm91cCAoc2FtZSByb3cgcGF0dGVybiwgc2FtZSBjb2x1bW4pIGFjcm9zcyBhbGwgc2VsZWN0ZWQgZGF0YXNldHMKICAgIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICAgIGdyb3VwUm93TGV0dGVycy5mb3JFYWNoKHJvd0xldHRlciA9PiB7CiAgICAgICAgY29uc3Qgd0lkID0gcm93TGV0dGVyICsgY29sdW1uOwogICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRXSWQgPSBub3JtYWxpemVXZWxsSWQod0lkKTsKICAgICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke25vcm1hbGl6ZWRXSWR9YDsKICAgICAgICBjb25zdCBoYXNEYXRhID0gd2VsbHNbbm9ybWFsaXplZFdJZF0gfHwgd2VsbHNbd0lkXTsKICAgICAgICBpZiAoaGFzRGF0YSkgewogICAgICAgICAgLy8gRmlsdGVyIGJ5IGVuYWJsZWRXZWxscyBpZiBhbnkgYXJlIHNldAogICAgICAgICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3SWQpICYmICFlbmFibGVkV2VsbHMuaGFzKG5vcm1hbGl6ZWRXSWQpKSB7CiAgICAgICAgICAgIHJldHVybjsgLy8gU2tpcCBleGNsdWRlZCB3ZWxscwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzR3JvdXBTZWxlY3RlZCkgewogICAgICAgICAgICBzZWxlY3RlZFdlbGxzLmRlbGV0ZShrZXkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZWN0ZWRXZWxscy5hZGQoa2V5KTsKICAgICAgICAgIH0KICAgICAgICAgIGFueUNoYW5nZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9IGVsc2UgewogICAgLy8gVG9nZ2xlIGluZGl2aWR1YWwgd2VsbCBhY3Jvc3MgYWxsIHNlbGVjdGVkIGRhdGFzZXRzCiAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgICBzZWxlY3RlZERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIC8vIE9ubHkgdG9nZ2xlIGlmIHRoaXMgcGxhdGUgaGFzIGRhdGEgZm9yIHRoaXMgd2VsbAogICAgICBpZiAocGxhdGVJZHMuaW5jbHVkZXMocGxhdGVJZCkpIHsKICAgICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgICAgICBjb25zdCBoYXNEYXRhID0gd2VsbHNbbm9ybWFsaXplZFdlbGxJZF0gfHwgd2VsbHNbd2VsbElkXTsKICAgICAgICBpZiAoIWhhc0RhdGEpIHsKICAgICAgICAgIHJldHVybjsgLy8gU2tpcCBpZiBubyBkYXRhCiAgICAgICAgfQogICAgICAgIC8vIEZpbHRlciBieSBlbmFibGVkV2VsbHMgaWYgYW55IGFyZSBzZXQKICAgICAgICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCkgJiYgIWVuYWJsZWRXZWxscy5oYXMobm9ybWFsaXplZFdlbGxJZCkpIHsKICAgICAgICAgIHJldHVybjsgLy8gU2tpcCBleGNsdWRlZCB3ZWxscwogICAgICAgIH0KICAgICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke25vcm1hbGl6ZWRXZWxsSWR9YDsKICAgICAgICBpZiAoaXNHcm91cFNlbGVjdGVkKSB7CiAgICAgICAgICBzZWxlY3RlZFdlbGxzLmRlbGV0ZShrZXkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxlY3RlZFdlbGxzLmFkZChrZXkpOwogICAgICAgIH0KICAgICAgICBhbnlDaGFuZ2VkID0gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgfQogIAogIGlmIChhbnlDaGFuZ2VkKSB7CiAgICByZW5kZXJQbGF0ZUdyaWQoKTsKICAgIHVwZGF0ZVdlbGxJbmZvKCk7CiAgfQp9CgpmdW5jdGlvbiBjbGVhclNlbGVjdGlvbigpIHsKICBzZWxlY3RlZFdlbGxzLmNsZWFyKCk7CiAgcmVuZGVyUGxhdGVHcmlkKCk7CiAgdXBkYXRlQ2hhcnQoKTsKfQoKZnVuY3Rpb24gdXBkYXRlV2VsbEluZm8oKSB7CiAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgid2VsbC1pbmZvIik7CiAgaWYgKHNlbGVjdGVkV2VsbHMuc2l6ZSA9PT0gMCkgewogICAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICAgIGNvbnN0IGRhdGFzZXRDb3VudCA9IHNlbGVjdGVkRGF0YXNldHMubGVuZ3RoOwogICAgaWYgKGRhdGFzZXRDb3VudCA+IDEpIHsKICAgICAgZWwudGV4dENvbnRlbnQgPSBgU2VsZWN0ZWQgZ3JvdXAgd2l0aCAke2RhdGFzZXRDb3VudH0gZGF0YXNldHMuIENsaWNrIHdlbGxzIG9uIHRoZSBwbGF0ZSB0byBhZGQgdGhlbSB0byB0aGUgY2hhcnQuYDsKICAgIH0gZWxzZSB7CiAgICAgIGVsLnRleHRDb250ZW50ID0gIkNsaWNrIHdlbGxzIG9uIHRoZSBwbGF0ZSB0byBhZGQgdGhlbSB0byB0aGUgY2hhcnQuIjsKICAgIH0KICAgIHJldHVybjsKICB9CiAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICBjb25zdCBkYXRhc2V0Q291bnQgPSBzZWxlY3RlZERhdGFzZXRzLmxlbmd0aDsKICBjb25zdCB1bmlxdWVXZWxscyA9IG5ldyBTZXQoQXJyYXkuZnJvbShzZWxlY3RlZFdlbGxzKS5tYXAoa2V5ID0+IGtleS5zcGxpdCgiOiIpWzFdKSk7CiAgY29uc3Qgd2VsbENvdW50ID0gdW5pcXVlV2VsbHMuc2l6ZTsKICBpZiAoZGF0YXNldENvdW50ID4gMSkgewogICAgZWwudGV4dENvbnRlbnQgPSBgJHt3ZWxsQ291bnR9IHdlbGwocykgc2VsZWN0ZWQgYWNyb3NzICR7ZGF0YXNldENvdW50fSBkYXRhc2V0cy4gQ2xpY2sgIlVwZGF0ZSBDaGFydCIgdG8gZGlzcGxheS5gOwogIH0gZWxzZSB7CiAgICBlbC50ZXh0Q29udGVudCA9IGAke3dlbGxDb3VudH0gd2VsbChzKSBzZWxlY3RlZC4gQ2xpY2sgIlVwZGF0ZSBDaGFydCIgdG8gZGlzcGxheS5gOwogIH0KfQoKZnVuY3Rpb24gaXNDb250cm9sV2VsbCh3ZWxsSWQpIHsKICAvLyBDb250cm9sIHdlbGxzIGFyZSBjb25maWd1cmFibGUgdmlhIGNvbnRyb2xfcm93cyBpbiBjb25maWcgKGRlZmF1bHQ6IFsiTiIsICJPIl0pCiAgY29uc3QgY29uZmlnID0gdmlld2VyRGF0YS5jb25maWcgfHwge307CiAgY29uc3QgY29udHJvbFJvd3MgPSBjb25maWcuY29udHJvbF9yb3dzIHx8IFsiTiIsICJPIl07CiAgY29uc3Qgcm93TGV0dGVyID0gd2VsbElkLnJlcGxhY2UoL1swLTldL2csICcnKTsKICByZXR1cm4gY29udHJvbFJvd3MuaW5jbHVkZXMocm93TGV0dGVyKTsKfQoKZnVuY3Rpb24gZm9ybWF0TGFiZWwobGFiZWwpIHsKICAvLyBGb3JtYXQgbGFiZWxzOiByZW1vdmUgInVNIiBhbmQgY29udmVydCB0byAibnVtYmVyLW51bWJlci1udW1iZXIiIGZvcm1hdAogIC8vIEV4YW1wbGVzOiAiMjUwIHVNIDEwLTIiIC0+ICIyNTAtMTAtMiIsICI1MDAgdU0gNS0yIiAtPiAiNTAwLTUtMiIKICBpZiAoIWxhYmVsKSByZXR1cm4gbGFiZWw7CiAgCiAgLy8gUmVtb3ZlICJ1TSIgKGNhc2UgaW5zZW5zaXRpdmUpIGFuZCBleHRyYSBzcGFjZXMKICBsZXQgZm9ybWF0dGVkID0gbGFiZWwucmVwbGFjZSgvXHMqdU1ccyovZ2ksICcgJykucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwogIAogIC8vIEV4dHJhY3QgbnVtYmVycyBhbmQgaHlwaGVucywgcmVwbGFjZSBzcGFjZXMgd2l0aCBoeXBoZW5zCiAgLy8gTWF0Y2ggcGF0dGVybjogbnVtYmVyKHMpIGZvbGxvd2VkIGJ5IG9wdGlvbmFsIHNwYWNlL2h5cGhlbiBhbmQgbW9yZSBudW1iZXJzCiAgZm9ybWF0dGVkID0gZm9ybWF0dGVkLnJlcGxhY2UoLyhcZCspXHMqLVxzKihcZCspL2csICckMS0kMicpOyAvLyBIYW5kbGUgZXhpc3RpbmcgaHlwaGVucwogIGZvcm1hdHRlZCA9IGZvcm1hdHRlZC5yZXBsYWNlKC8oXGQrKVxzKyhcZCspL2csICckMS0kMicpOyAvLyBSZXBsYWNlIHNwYWNlcyBiZXR3ZWVuIG51bWJlcnMgd2l0aCBoeXBoZW5zCiAgCiAgcmV0dXJuIGZvcm1hdHRlZDsKfQoKZnVuY3Rpb24gZ2V0Um93TGV0dGVyKHdlbGxJZCkgewogIC8vIEV4dHJhY3Qgcm93IGxldHRlciBmcm9tIHdlbGwgSUQgKGUuZy4sICJCMTMiIC0+ICJCIikKICByZXR1cm4gd2VsbElkLnJlcGxhY2UoL1swLTldL2csICcnKTsKfQoKZnVuY3Rpb24gZ2V0VHJpcGxpY2F0ZUdyb3VwKHdlbGxJZCwgY29sdW1uKSB7CiAgLy8gQ29udHJvbCB3ZWxscyBzaG91bGQgbmV2ZXIgYmUgcGFydCBvZiB0cmlwbGljYXRlIGdyb3VwcwogIGlmIChpc0NvbnRyb2xXZWxsKHdlbGxJZCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICAKICBjb25zdCBjb25maWcgPSB2aWV3ZXJEYXRhLmNvbmZpZyB8fCB7fTsKICBjb25zdCB0cmlwbGljYXRlR3JvdXBzID0gY29uZmlnLnRyaXBsaWNhdGVfZ3JvdXBzIHx8IFtdOwogIGNvbnN0IHJvd0xldHRlciA9IGdldFJvd0xldHRlcih3ZWxsSWQpOwogIAogIC8vIEZpbmQgZ3JvdXAgdGhhdCBtYXRjaGVzIHRoZSByb3cgcGF0dGVybiAoQkNELCBFRkcsIGV0Yy4pIC0gYXBwbGllcyB0byBhbGwgY29sdW1ucwogIHJldHVybiB0cmlwbGljYXRlR3JvdXBzLmZpbmQoZ3JvdXAgPT4gewogICAgaWYgKCFncm91cC53ZWxscyB8fCBncm91cC53ZWxscy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgCiAgICAvLyBFeHRyYWN0IHJvdyBsZXR0ZXJzIGZyb20gdGhlIGdyb3VwJ3Mgd2VsbHMKICAgIGNvbnN0IGdyb3VwUm93TGV0dGVycyA9IGdldFJvd0xldHRlcnNGcm9tV2VsbHMoZ3JvdXAud2VsbHMpOwogICAgCiAgICAvLyBDaGVjayBpZiB0aGlzIHdlbGwncyByb3cgbGV0dGVyIG1hdGNoZXMgYW55IHJvdyBpbiB0aGUgZ3JvdXAgcGF0dGVybgogICAgLy8gR3JvdXBzIGFwcGx5IHRvIGFsbCBjb2x1bW5zLCBzbyBubyBjb2x1bW4gY2hlY2sgbmVlZGVkCiAgICByZXR1cm4gZ3JvdXBSb3dMZXR0ZXJzLmluY2x1ZGVzKHJvd0xldHRlcik7CiAgfSk7Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpIHsKICAvLyBOb3JtYWxpemUgd2VsbCBJRCB0byBjb25zaXN0ZW50IGZvcm1hdDogdXBwZXJjYXNlIHdpdGggemVyby1wYWRkZWQgY29sdW1uIChlLmcuLCAiQjUiIC0+ICJCMDUiLCAiQjEzIiAtPiAiQjEzIikKICBjb25zdCBtYXRjaCA9IFN0cmluZyh3ZWxsSWQpLnRyaW0oKS50b1VwcGVyQ2FzZSgpLm1hdGNoKC9eKFtBLVpdKShcZCspJC8pOwogIGlmIChtYXRjaCkgewogICAgY29uc3Qgcm93ID0gbWF0Y2hbMV07CiAgICBjb25zdCBjb2wgPSBwYXJzZUludChtYXRjaFsyXSk7CiAgICByZXR1cm4gcm93ICsgU3RyaW5nKGNvbCkucGFkU3RhcnQoMiwgJzAnKTsKICB9CiAgcmV0dXJuIFN0cmluZyh3ZWxsSWQpLnRyaW0oKS50b1VwcGVyQ2FzZSgpOwp9CgpmdW5jdGlvbiBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCkgewogIC8vIEV4dHJhY3QgY29sdW1uIG51bWJlciBmcm9tIHdlbGwgSUQgKGUuZy4sICJCMTMiIC0+IDEzKQogIHJldHVybiBwYXJzZUludCh3ZWxsSWQucmVwbGFjZSgvW0EtWl0vZywgJycpKTsKfQoKZnVuY3Rpb24gZ2V0Um93TGV0dGVyc0Zyb21XZWxscyh3ZWxscykgewogIC8vIEV4dHJhY3Qgcm93IGxldHRlcnMgZnJvbSB3ZWxscyBhcnJheQogIC8vIFdlbGxzIGNhbiBiZSBlaXRoZXIgcm93IGxldHRlcnMgKGUuZy4sIFsiQiIsICJDIiwgIkQiXSkgb3IgZnVsbCB3ZWxsIElEcyAoZS5nLiwgWyJCMTMiLCAiQzEzIiwgIkQxMyJdKQogIHJldHVybiB3ZWxscy5tYXAodyA9PiB7CiAgICAvLyBJZiBpdCdzIGEgZnVsbCB3ZWxsIElELCBleHRyYWN0IHJvdyBsZXR0ZXI7IG90aGVyd2lzZSBhc3N1bWUgaXQncyBhbHJlYWR5IGEgcm93IGxldHRlcgogICAgaWYgKHcubGVuZ3RoID4gMSAmJiAvXltBLVpdLy50ZXN0KHcpICYmIC9bMC05XS8udGVzdCh3KSkgewogICAgICByZXR1cm4gZ2V0Um93TGV0dGVyKHcpOwogICAgfQogICAgcmV0dXJuIHc7IC8vIEFscmVhZHkgYSByb3cgbGV0dGVyCiAgfSk7Cn0KCi8vIENvbG9yIHBhbGV0dGUgZm9yIHRyaXBsaWNhdGUgZ3JvdXBzIC0gZWFjaCBncm91cCBnZXRzIGEgZGlzdGluY3QgY29sb3IKY29uc3QgVFJJUExJQ0FURV9DT0xPUlMgPSBbCiAgeyBib3JkZXI6ICIjZmY2YjZiIiwgYmc6ICIjZmZlMGUwIiwgYmdTZWxlY3RlZDogIiNmZmNjY2MiLCBiZ0hhc0RhdGE6ICIjZmZlOGU4IiB9LCAvLyBSZWQKICB7IGJvcmRlcjogIiM0ZWNkYzQiLCBiZzogIiNlMGY3ZjUiLCBiZ1NlbGVjdGVkOiAiI2NjZjBlZCIsIGJnSGFzRGF0YTogIiNlOGY5ZjciIH0sIC8vIFRlYWwKICB7IGJvcmRlcjogIiM0NWI3ZDEiLCBiZzogIiNlMGYyZjciLCBiZ1NlbGVjdGVkOiAiI2NjZThmMCIsIGJnSGFzRGF0YTogIiNlOGY1ZmEiIH0sIC8vIEJsdWUKICB7IGJvcmRlcjogIiNmOWNhMjQiLCBiZzogIiNmZmY5ZTAiLCBiZ1NlbGVjdGVkOiAiI2ZmZjNjYyIsIGJnSGFzRGF0YTogIiNmZmZiZTgiIH0sIC8vIFllbGxvdwogIHsgYm9yZGVyOiAiIzZjNWNlNyIsIGJnOiAiI2VkZWFmNyIsIGJnU2VsZWN0ZWQ6ICIjZGRkNGYwIiwgYmdIYXNEYXRhOiAiI2YwZWNmOSIgfSwgLy8gUHVycGxlCiAgeyBib3JkZXI6ICIjYTI5YmZlIiwgYmc6ICIjZWRlYWY3IiwgYmdTZWxlY3RlZDogIiNkZGQ0ZjAiLCBiZ0hhc0RhdGE6ICIjZjBlY2Y5IiB9LCAvLyBMaWdodCBQdXJwbGUKICB7IGJvcmRlcjogIiNmZDc5YTgiLCBiZzogIiNmZmUwZWQiLCBiZ1NlbGVjdGVkOiAiI2ZmY2NlMCIsIGJnSGFzRGF0YTogIiNmZmU4ZjAiIH0sIC8vIFBpbmsKICB7IGJvcmRlcjogIiMwMGI4OTQiLCBiZzogIiNlMGY1ZjAiLCBiZ1NlbGVjdGVkOiAiI2NjZWRlNSIsIGJnSGFzRGF0YTogIiNlOGY3ZjIiIH0sIC8vIEdyZWVuCiAgeyBib3JkZXI6ICIjZTE3MDU1IiwgYmc6ICIjZmZlMGQ5IiwgYmdTZWxlY3RlZDogIiNmZmNjYmIiLCBiZ0hhc0RhdGE6ICIjZmZlOGUwIiB9LCAvLyBPcmFuZ2UKICB7IGJvcmRlcjogIiM3NGI5ZmYiLCBiZzogIiNlMGYwZmYiLCBiZ1NlbGVjdGVkOiAiI2NjZTBmZiIsIGJnSGFzRGF0YTogIiNlOGY1ZmYiIH0sIC8vIExpZ2h0IEJsdWUKICB7IGJvcmRlcjogIiM1NWVmYzQiLCBiZzogIiNlMGZhZjUiLCBiZ1NlbGVjdGVkOiAiI2NjZjVlYiIsIGJnSGFzRGF0YTogIiNlOGZiZjciIH0sIC8vIE1pbnQKICB7IGJvcmRlcjogIiNmZGNiNmUiLCBiZzogIiNmZmY1ZTAiLCBiZ1NlbGVjdGVkOiAiI2ZmZWJjYyIsIGJnSGFzRGF0YTogIiNmZmY4ZTgiIH0gIC8vIExpZ2h0IE9yYW5nZQpdOwoKLy8gTWFwIHRyaXBsaWNhdGUgZ3JvdXAgbmFtZXMgdG8gY29sb3JzIChjb25zaXN0ZW50IGFjcm9zcyB0aGUgYXBwKQpsZXQgdHJpcGxpY2F0ZUdyb3VwQ29sb3JNYXAgPSB7fTsKCmZ1bmN0aW9uIGdldFRyaXBsaWNhdGVHcm91cENvbG9yKGdyb3VwTmFtZSkgewogIGlmICghZ3JvdXBOYW1lKSByZXR1cm4gbnVsbDsKICAKICAvLyBFbnN1cmUgY29sb3IgbWFwIGlzIGluaXRpYWxpemVkCiAgaW5pdGlhbGl6ZVRyaXBsaWNhdGVHcm91cENvbG9ycygpOwogIAogIC8vIE5vcm1hbGl6ZSBncm91cCBuYW1lIHRvIGVuc3VyZSBjb25zaXN0ZW50IGxvb2t1cAogIGNvbnN0IG5vcm1hbGl6ZWROYW1lID0gU3RyaW5nKGdyb3VwTmFtZSkudHJpbSgpOwogIAogIC8vIFJldHVybiB0aGUgY29sb3IgZm9yIHRoaXMgZ3JvdXAgbmFtZSAoc2FtZSBjb2xvciBmb3IgYWxsIHdlbGxzIGluIHRoZSBncm91cCkKICAvLyBBbGwgd2VsbHMgd2l0aCB0aGUgc2FtZSBncm91cCBuYW1lIHdpbGwgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgLy8gRm9yIGV4YW1wbGUsIGFsbCB3ZWxscyBpbiByb3dzIEIsIEMsIEQgd2l0aCBncm91cCAiMjUwLTEwLTIiIGdldCB0aGUgc2FtZSBjb2xvcgogIHJldHVybiB0cmlwbGljYXRlR3JvdXBDb2xvck1hcFtub3JtYWxpemVkTmFtZV0gfHwgVFJJUExJQ0FURV9DT0xPUlNbMF07Cn0KCmZ1bmN0aW9uIGlzRHVwbGljYXRlV2VsbCh3ZWxsSWQpIHsKICAvLyBDaGVjayBpZiB0aGlzIHdlbGwgSUQgaXMgaW4gdGhlIGR1cGxpY2F0ZSB3YXJuaW5ncwogIGlmICghdmlld2VyRGF0YSB8fCAhdmlld2VyRGF0YS5jb25maWcgfHwgIXZpZXdlckRhdGEuY29uZmlnLndhcm5pbmdzKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGNvbnN0IHdhcm5pbmdzID0gdmlld2VyRGF0YS5jb25maWcud2FybmluZ3MuZHVwbGljYXRlX2NvbHVtbnMgfHwgW107CiAgcmV0dXJuIHdhcm5pbmdzLnNvbWUod2FybmluZyA9PiB7CiAgICBjb25zdCB3ZWxsSWRzID0gd2FybmluZy53ZWxsX2lkcyB8fCBbXTsKICAgIHJldHVybiB3ZWxsSWRzLmluY2x1ZGVzKHdlbGxJZCk7CiAgfSk7Cn0KCmZ1bmN0aW9uIGdldER1cGxpY2F0ZUZpbGVzKHdlbGxJZCkgewogIC8vIEdldCB0aGUgbGlzdCBvZiBmaWxlcyB0aGF0IGhhdmUgdGhpcyBkdXBsaWNhdGUgd2VsbAogIGlmICghdmlld2VyRGF0YSB8fCAhdmlld2VyRGF0YS5jb25maWcgfHwgIXZpZXdlckRhdGEuY29uZmlnLndhcm5pbmdzKSB7CiAgICByZXR1cm4gW107CiAgfQogIGNvbnN0IHdhcm5pbmdzID0gdmlld2VyRGF0YS5jb25maWcud2FybmluZ3MuZHVwbGljYXRlX2NvbHVtbnMgfHwgW107CiAgZm9yIChjb25zdCB3YXJuaW5nIG9mIHdhcm5pbmdzKSB7CiAgICBjb25zdCB3ZWxsSWRzID0gd2FybmluZy53ZWxsX2lkcyB8fCBbXTsKICAgIGlmICh3ZWxsSWRzLmluY2x1ZGVzKHdlbGxJZCkpIHsKICAgICAgcmV0dXJuIHdhcm5pbmcuZmlsZXMgfHwgW107CiAgICB9CiAgfQogIHJldHVybiBbXTsKfQoKZnVuY3Rpb24gZ2V0QWxsVW5pcXVlVGltZVBvaW50cyh3ZWxscykgewogIC8vIENvbGxlY3QgYWxsIHVuaXF1ZSB0aW1lIHBvaW50cyBmcm9tIGFsbCB3ZWxscwogIGNvbnN0IGFsbFRpbWVQb2ludHMgPSBuZXcgU2V0KCk7CiAgd2VsbHMuZm9yRWFjaCh3ZWxsID0+IHsKICAgIGlmICh3ZWxsLnRpbWVfcykgewogICAgICB3ZWxsLnRpbWVfcy5mb3JFYWNoKHQgPT4gewogICAgICAgIGlmICh0ICE9PSBudWxsICYmIHQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgYWxsVGltZVBvaW50cy5hZGQodCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9KTsKICByZXR1cm4gQXJyYXkuZnJvbShhbGxUaW1lUG9pbnRzKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7Cn0KCmZ1bmN0aW9uIGNhbGN1bGF0ZU1lYW5BbmRFcnJvcih3ZWxscywgdGltZVBvaW50cykgewogIC8vIENhbGN1bGF0ZSBtZWFuIGFuZCBzdGFuZGFyZCBlcnJvciBmb3IgdHJpcGxpY2F0ZXMgYXQgZWFjaCB0aW1lIHBvaW50CiAgY29uc3QgbWVhbnMgPSBbXTsKICBjb25zdCBlcnJvcnMgPSBbXTsKICAKICB0aW1lUG9pbnRzLmZvckVhY2goKHRpbWUsIGlkeCkgPT4gewogICAgY29uc3QgdmFsdWVzID0gd2VsbHMubWFwKHcgPT4gewogICAgICBjb25zdCB0aW1lSWR4ID0gdy50aW1lX3MuaW5kZXhPZih0aW1lKTsKICAgICAgcmV0dXJuIHRpbWVJZHggPj0gMCA/IHcudmFsdWVzW3RpbWVJZHhdIDogbnVsbDsKICAgIH0pLmZpbHRlcih2ID0+IHYgIT09IG51bGwpOwogICAgCiAgICBpZiAodmFsdWVzLmxlbmd0aCA9PT0gMCkgewogICAgICBtZWFucy5wdXNoKG51bGwpOwogICAgICBlcnJvcnMucHVzaChudWxsKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgCiAgICBjb25zdCBtZWFuID0gdmFsdWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gdmFsdWVzLmxlbmd0aDsKICAgIC8vIFVzZSBzYW1wbGUgdmFyaWFuY2UgKGRpdmlkZSBieSBuLTEpIGZvciBwcm9wZXIgU0VNIGNhbGN1bGF0aW9uCiAgICBjb25zdCBuID0gdmFsdWVzLmxlbmd0aDsKICAgIGNvbnN0IHZhcmlhbmNlID0gbiA+IDEgCiAgICAgID8gdmFsdWVzLnJlZHVjZSgoc3VtLCB2YWwpID0+IHN1bSArIE1hdGgucG93KHZhbCAtIG1lYW4sIDIpLCAwKSAvIChuIC0gMSkKICAgICAgOiAwOwogICAgY29uc3Qgc3RkRGV2ID0gTWF0aC5zcXJ0KHZhcmlhbmNlKTsKICAgIGNvbnN0IHN0ZEVycm9yID0gc3RkRGV2IC8gTWF0aC5zcXJ0KG4pOwogICAgCiAgICBtZWFucy5wdXNoKG1lYW4pOwogICAgZXJyb3JzLnB1c2goc3RkRXJyb3IpOwogIH0pOwogIAogIHJldHVybiB7IG1lYW5zLCBlcnJvcnMgfTsKfQoKZnVuY3Rpb24gcHJvY2Vzc1dlbGxzQW5kQ2FsY3VsYXRlTWVhbih3ZWxscywgaXNOb3JtYWxpemVkID0gZmFsc2UsIGJhc2VsaW5lRW5kVGltZSA9IDI0LCBjdXRvZmZUaW1lID0gMzYwKSB7CiAgLy8gV09SS0ZMT1c6IEFsd2F5cyBwcm9jZXNzIGVhY2ggd2VsbCBpbmRpdmlkdWFsbHkgZmlyc3QsIHRoZW4gYXZlcmFnZQogIC8vIElmIG5vcm1hbGl6ZWQ6IG5vcm1hbGl6ZSBlYWNoIHdlbGwgdG8gaXRzIE9XTiBiYXNlbGluZSBmaXJzdCwgdGhlbiBjYWxjdWxhdGUgbWVhbiBhbmQgZXJyb3IKICAvLyBJZiBub3Qgbm9ybWFsaXplZDogcHJvY2VzcyBlYWNoIHdlbGwgaW5kaXZpZHVhbGx5IChubyBub3JtYWxpemF0aW9uKSwgdGhlbiBjYWxjdWxhdGUgbWVhbiBhbmQgZXJyb3IKICAvLyBUaGlzIGVuc3VyZXMgY29ycmVjdCBub3JtYWxpemF0aW9uIGV2ZW4gd2hlbiBjb21iaW5pbmcgd2VsbHMgZnJvbSBkaWZmZXJlbnQgY29sdW1ucyB3aXRoIGRpZmZlcmVudCBiYXNlbGluZXMKICAvLyBSZXR1cm5zIHsgZmlsdGVyZWRUaW1lUG9pbnRzLCBtZWFucywgZXJyb3JzLCBvcmlnaW5hbE1lYW5zIH0KICAKICAvLyBTdGVwIDE6IFByb2Nlc3MgZWFjaCB3ZWxsIGluZGl2aWR1YWxseSAobm9ybWFsaXplIGlmIGVuYWJsZWQsIG90aGVyd2lzZSB1c2UgcmF3IGRhdGEpCiAgY29uc3QgcHJvY2Vzc2VkV2VsbHMgPSB3ZWxscy5tYXAod2VsbCA9PiB7CiAgICBjb25zdCBmaWx0ZXJlZFRpbWVQb2ludHMgPSBbXTsKICAgIGNvbnN0IHByb2Nlc3NlZFZhbHVlcyA9IFtdOwogICAgY29uc3Qgb3JpZ2luYWxWYWx1ZXMgPSBbXTsKICAgIAogICAgaWYgKCF3ZWxsLnRpbWVfcyB8fCAhd2VsbC52YWx1ZXMpIHsKICAgICAgcmV0dXJuIHsgdGltZVBvaW50czogW10sIHZhbHVlczogW10sIG9yaWdpbmFsVmFsdWVzOiBbXSB9OwogICAgfQogICAgCiAgICBpZiAoaXNOb3JtYWxpemVkKSB7CiAgICAgIC8vIE5vcm1hbGl6ZSB0aGlzIHdlbGwgYnkgaXRzIG93biBiYXNlbGluZQogICAgICBjb25zdCBiYXNlbGluZVZhbHVlcyA9IFtdOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdlbGwudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgdGltZSA9IHdlbGwudGltZV9zW2ldOwogICAgICAgIGNvbnN0IHZhbCA9IHdlbGwudmFsdWVzW2ldOwogICAgICAgIGlmICh0aW1lICE9PSBudWxsICYmIHZhbCAhPT0gbnVsbCAmJiB0aW1lIDw9IGJhc2VsaW5lRW5kVGltZSkgewogICAgICAgICAgYmFzZWxpbmVWYWx1ZXMucHVzaCh2YWwpOwogICAgICAgIH0KICAgICAgfQogICAgICAKICAgICAgaWYgKGJhc2VsaW5lVmFsdWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIC8vIE5vIGJhc2VsaW5lIGRhdGEgZm9yIHRoaXMgd2VsbCwgc2tpcCBpdAogICAgICAgIHJldHVybiB7IHRpbWVQb2ludHM6IFtdLCB2YWx1ZXM6IFtdLCBvcmlnaW5hbFZhbHVlczogW10gfTsKICAgICAgfQogICAgICAKICAgICAgY29uc3Qgd2VsbEJhc2VsaW5lID0gYmFzZWxpbmVWYWx1ZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyBiYXNlbGluZVZhbHVlcy5sZW5ndGg7CiAgICAgIAogICAgICBpZiAod2VsbEJhc2VsaW5lID09PSAwIHx8ICFpc0Zpbml0ZSh3ZWxsQmFzZWxpbmUpKSB7CiAgICAgICAgLy8gSW52YWxpZCBiYXNlbGluZSBmb3IgdGhpcyB3ZWxsLCBza2lwIGl0CiAgICAgICAgcmV0dXJuIHsgdGltZVBvaW50czogW10sIHZhbHVlczogW10sIG9yaWdpbmFsVmFsdWVzOiBbXSB9OwogICAgICB9CiAgICAgIAogICAgICAvLyBOb3JtYWxpemUgYW5kIGZpbHRlcjogb25seSBpbmNsdWRlIHBvaW50cyBhZnRlciBiYXNlbGluZUVuZFRpbWUgYW5kIHVwIHRvIGN1dG9mZlRpbWUKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB3ZWxsLnRpbWVfcy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHRpbWUgPSB3ZWxsLnRpbWVfc1tpXTsKICAgICAgICBjb25zdCB2YWwgPSB3ZWxsLnZhbHVlc1tpXTsKICAgICAgICAKICAgICAgICBpZiAodGltZSA9PT0gbnVsbCB8fCB2YWwgPT09IG51bGwpIGNvbnRpbnVlOwogICAgICAgIAogICAgICAgIC8vIE9ubHkgaW5jbHVkZSBwb2ludHMgYWZ0ZXIgYmFzZWxpbmVFbmRUaW1lIGFuZCB1cCB0byBjdXRvZmZUaW1lCiAgICAgICAgaWYgKHRpbWUgPiBiYXNlbGluZUVuZFRpbWUgJiYgdGltZSA8PSBjdXRvZmZUaW1lKSB7CiAgICAgICAgICAvLyBTdWJ0cmFjdCBiYXNlbGluZUVuZFRpbWUgdG8gYnJpbmcgZmlyc3QgcG9pbnQgdG8geD0wICh0aW1lIGFmdGVyIGluamVjdGlvbikKICAgICAgICAgIGZpbHRlcmVkVGltZVBvaW50cy5wdXNoKHRpbWUgLSBiYXNlbGluZUVuZFRpbWUpOwogICAgICAgICAgLy8gRGl2aWRlIGJ5IHRoaXMgd2VsbCdzIG93biBiYXNlbGluZQogICAgICAgICAgcHJvY2Vzc2VkVmFsdWVzLnB1c2godmFsIC8gd2VsbEJhc2VsaW5lKTsKICAgICAgICAgIG9yaWdpbmFsVmFsdWVzLnB1c2godmFsKTsgLy8gU3RvcmUgb3JpZ2luYWwgdmFsdWUKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIE5vdCBub3JtYWxpemVkOiB1c2UgYWxsIHJhdyBkYXRhIHBvaW50cwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdlbGwudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgdGltZSA9IHdlbGwudGltZV9zW2ldOwogICAgICAgIGNvbnN0IHZhbCA9IHdlbGwudmFsdWVzW2ldOwogICAgICAgIAogICAgICAgIGlmICh0aW1lID09PSBudWxsIHx8IHZhbCA9PT0gbnVsbCkgY29udGludWU7CiAgICAgICAgCiAgICAgICAgZmlsdGVyZWRUaW1lUG9pbnRzLnB1c2godGltZSk7CiAgICAgICAgcHJvY2Vzc2VkVmFsdWVzLnB1c2godmFsKTsKICAgICAgICBvcmlnaW5hbFZhbHVlcy5wdXNoKHZhbCk7IC8vIFN0b3JlIG9yaWdpbmFsIHZhbHVlIChzYW1lIGFzIHByb2Nlc3NlZCB3aGVuIG5vdCBub3JtYWxpemVkKQogICAgICB9CiAgICB9CiAgICAKICAgIHJldHVybiB7IHRpbWVQb2ludHM6IGZpbHRlcmVkVGltZVBvaW50cywgdmFsdWVzOiBwcm9jZXNzZWRWYWx1ZXMsIG9yaWdpbmFsVmFsdWVzOiBvcmlnaW5hbFZhbHVlcyB9OwogIH0pLmZpbHRlcih3ZWxsID0+IHdlbGwudGltZVBvaW50cy5sZW5ndGggPiAwKTsgLy8gRmlsdGVyIG91dCB3ZWxscyB3aXRoIG5vIGRhdGEKICAKICAvLyBTdGVwIDI6IEZpbmQgYWxsIHVuaXF1ZSB0aW1lIHBvaW50cyBhY3Jvc3MgYWxsIHByb2Nlc3NlZCB3ZWxscwogIGNvbnN0IGFsbFRpbWVQb2ludHMgPSBuZXcgU2V0KCk7CiAgcHJvY2Vzc2VkV2VsbHMuZm9yRWFjaCh3ZWxsID0+IHsKICAgIHdlbGwudGltZVBvaW50cy5mb3JFYWNoKHQgPT4gewogICAgICBpZiAodCAhPT0gbnVsbCkgYWxsVGltZVBvaW50cy5hZGQodCk7CiAgICB9KTsKICB9KTsKICAKICBjb25zdCBzb3J0ZWRUaW1lUG9pbnRzID0gQXJyYXkuZnJvbShhbGxUaW1lUG9pbnRzKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7CiAgCiAgLy8gU3RlcCAzOiBDYWxjdWxhdGUgbWVhbiBhbmQgZXJyb3IgYXQgZWFjaCB0aW1lIHBvaW50IGZyb20gcHJvY2Vzc2VkIHZhbHVlcwogIC8vIEFsc28gdHJhY2sgb3JpZ2luYWwgdmFsdWVzIGZvciB0b29sdGlwIGRpc3BsYXkKICBjb25zdCBtZWFucyA9IFtdOwogIGNvbnN0IGVycm9ycyA9IFtdOwogIGNvbnN0IG9yaWdpbmFsTWVhbnMgPSBbXTsKICAKICBzb3J0ZWRUaW1lUG9pbnRzLmZvckVhY2godGltZSA9PiB7CiAgICBjb25zdCB2YWx1ZXMgPSBbXTsKICAgIGNvbnN0IG9yaWdWYWx1ZXMgPSBbXTsKICAgIHByb2Nlc3NlZFdlbGxzLmZvckVhY2god2VsbCA9PiB7CiAgICAgIGNvbnN0IHRpbWVJZHggPSB3ZWxsLnRpbWVQb2ludHMuaW5kZXhPZih0aW1lKTsKICAgICAgaWYgKHRpbWVJZHggPj0gMCAmJiB3ZWxsLnZhbHVlc1t0aW1lSWR4XSAhPT0gbnVsbCkgewogICAgICAgIHZhbHVlcy5wdXNoKHdlbGwudmFsdWVzW3RpbWVJZHhdKTsKICAgICAgICBpZiAod2VsbC5vcmlnaW5hbFZhbHVlcyAmJiB3ZWxsLm9yaWdpbmFsVmFsdWVzW3RpbWVJZHhdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIG9yaWdWYWx1ZXMucHVzaCh3ZWxsLm9yaWdpbmFsVmFsdWVzW3RpbWVJZHhdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgCiAgICBpZiAodmFsdWVzLmxlbmd0aCA9PT0gMCkgewogICAgICBtZWFucy5wdXNoKG51bGwpOwogICAgICBlcnJvcnMucHVzaChudWxsKTsKICAgICAgb3JpZ2luYWxNZWFucy5wdXNoKG51bGwpOwogICAgICByZXR1cm47CiAgICB9CiAgICAKICAgIGNvbnN0IG1lYW4gPSB2YWx1ZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyB2YWx1ZXMubGVuZ3RoOwogICAgLy8gVXNlIHNhbXBsZSB2YXJpYW5jZSAoZGl2aWRlIGJ5IG4tMSkgZm9yIHByb3BlciBTRU0gY2FsY3VsYXRpb24KICAgIGNvbnN0IG4gPSB2YWx1ZXMubGVuZ3RoOwogICAgY29uc3QgdmFyaWFuY2UgPSBuID4gMSAKICAgICAgPyB2YWx1ZXMucmVkdWNlKChzdW0sIHZhbCkgPT4gc3VtICsgTWF0aC5wb3codmFsIC0gbWVhbiwgMiksIDApIC8gKG4gLSAxKQogICAgICA6IDA7CiAgICBjb25zdCBzdGREZXYgPSBNYXRoLnNxcnQodmFyaWFuY2UpOwogICAgY29uc3Qgc3RkRXJyb3IgPSBzdGREZXYgLyBNYXRoLnNxcnQobik7CiAgICAKICAgIG1lYW5zLnB1c2gobWVhbik7CiAgICBlcnJvcnMucHVzaChzdGRFcnJvcik7CiAgICAKICAgIC8vIENhbGN1bGF0ZSBtZWFuIG9mIG9yaWdpbmFsIHZhbHVlcwogICAgaWYgKG9yaWdWYWx1ZXMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBvcmlnTWVhbiA9IG9yaWdWYWx1ZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyBvcmlnVmFsdWVzLmxlbmd0aDsKICAgICAgb3JpZ2luYWxNZWFucy5wdXNoKG9yaWdNZWFuKTsKICAgIH0gZWxzZSB7CiAgICAgIG9yaWdpbmFsTWVhbnMucHVzaChudWxsKTsKICAgIH0KICB9KTsKICAKICByZXR1cm4geyBmaWx0ZXJlZFRpbWVQb2ludHM6IHNvcnRlZFRpbWVQb2ludHMsIG5vcm1hbGl6ZWRNZWFuczogbWVhbnMsIG5vcm1hbGl6ZWRFcnJvcnM6IGVycm9ycywgb3JpZ2luYWxNZWFuczogb3JpZ2luYWxNZWFucyB9Owp9CgovLyBLZWVwIG9sZCBmdW5jdGlvbiBuYW1lIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgYnV0IGl0IG5vdyB1c2VzIHRoZSB1bmlmaWVkIHdvcmtmbG93CmZ1bmN0aW9uIGNhbGN1bGF0ZU1lYW5BbmRFcnJvckZyb21Ob3JtYWxpemVkKHdlbGxzLCBiYXNlbGluZUVuZFRpbWUgPSAyNCwgY3V0b2ZmVGltZSA9IDM2MCkgewogIHJldHVybiBwcm9jZXNzV2VsbHNBbmRDYWxjdWxhdGVNZWFuKHdlbGxzLCB0cnVlLCBiYXNlbGluZUVuZFRpbWUsIGN1dG9mZlRpbWUpOwp9CgpmdW5jdGlvbiBub3JtYWxpemVEYXRhKHRpbWVQb2ludHMsIHZhbHVlcywgYmFzZWxpbmVFbmRUaW1lID0gMjQsIGN1dG9mZlRpbWUgPSAzNjApIHsKICAvLyBOb3JtYWxpemUgZGF0YTogY2FsY3VsYXRlIGJhc2VsaW5lIGZyb20gMC1iYXNlbGluZUVuZFRpbWUsIHRoZW4gcGxvdCBvbmx5IHBvaW50cyBhZnRlciBiYXNlbGluZUVuZFRpbWUKICAvLyBkaXZpZGVkIGJ5IGJhc2VsaW5lLCB1cCB0byBjdXRvZmZUaW1lLiBCYXNlbGluZSBwZXJpb2QgaXMgTk9UIGluY2x1ZGVkIGluIHRoZSBwbG90LgogIC8vIFJldHVybnMgeyBmaWx0ZXJlZFRpbWVQb2ludHMsIG5vcm1hbGl6ZWRWYWx1ZXMsIG9yaWdpbmFsVmFsdWVzIH0gLSBmaWx0ZXJlZCBhcnJheXMKICBpZiAoIXRpbWVQb2ludHMgfHwgIXZhbHVlcyB8fCB0aW1lUG9pbnRzLmxlbmd0aCAhPT0gdmFsdWVzLmxlbmd0aCkgewogICAgLy8gSWYgaW52YWxpZCBpbnB1dCwgcmV0dXJuIGVtcHR5IGZpbHRlcmVkIGFycmF5cwogICAgcmV0dXJuIHsgZmlsdGVyZWRUaW1lUG9pbnRzOiBbXSwgbm9ybWFsaXplZFZhbHVlczogW10sIG9yaWdpbmFsVmFsdWVzOiBbXSB9OwogIH0KICAKICAvLyBGaW5kIGJhc2VsaW5lOiBhdmVyYWdlIG9mIGFsbCB2YWx1ZXMgd2hlcmUgdGltZSA8PSBiYXNlbGluZUVuZFRpbWUKICBjb25zdCBiYXNlbGluZVZhbHVlcyA9IFtdOwogIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZVBvaW50cy5sZW5ndGg7IGkrKykgewogICAgaWYgKHRpbWVQb2ludHNbaV0gIT09IG51bGwgJiYgdmFsdWVzW2ldICE9PSBudWxsICYmIHRpbWVQb2ludHNbaV0gPD0gYmFzZWxpbmVFbmRUaW1lKSB7CiAgICAgIGJhc2VsaW5lVmFsdWVzLnB1c2godmFsdWVzW2ldKTsKICAgIH0KICB9CiAgCiAgaWYgKGJhc2VsaW5lVmFsdWVzLmxlbmd0aCA9PT0gMCkgewogICAgLy8gTm8gYmFzZWxpbmUgZGF0YSBmb3VuZCwgcmV0dXJuIGVtcHR5IGZpbHRlcmVkIGFycmF5cyAoY2FuJ3Qgbm9ybWFsaXplIHdpdGhvdXQgYmFzZWxpbmUpCiAgICByZXR1cm4geyBmaWx0ZXJlZFRpbWVQb2ludHM6IFtdLCBub3JtYWxpemVkVmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgfQogIAogIGNvbnN0IGJhc2VsaW5lID0gYmFzZWxpbmVWYWx1ZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyBiYXNlbGluZVZhbHVlcy5sZW5ndGg7CiAgCiAgaWYgKGJhc2VsaW5lID09PSAwIHx8ICFpc0Zpbml0ZShiYXNlbGluZSkpIHsKICAgIC8vIEF2b2lkIGRpdmlzaW9uIGJ5IHplcm8gb3IgaW52YWxpZCBiYXNlbGluZQogICAgcmV0dXJuIHsgZmlsdGVyZWRUaW1lUG9pbnRzOiBbXSwgbm9ybWFsaXplZFZhbHVlczogW10sIG9yaWdpbmFsVmFsdWVzOiBbXSB9OwogIH0KICAKICAvLyBGaWx0ZXIgYW5kIG5vcm1hbGl6ZTogb25seSBpbmNsdWRlIHBvaW50cyB3aGVyZSBiYXNlbGluZUVuZFRpbWUgPCB0aW1lIDw9IGN1dG9mZlRpbWUKICAvLyBFVkVSWSBwb2ludCBhZnRlciBiYXNlbGluZUVuZFRpbWUgaXMgZGl2aWRlZCBieSB0aGUgU0FNRSBiYXNlbGluZSBhdmVyYWdlCiAgY29uc3QgZmlsdGVyZWRUaW1lUG9pbnRzID0gW107CiAgY29uc3Qgbm9ybWFsaXplZFZhbHVlcyA9IFtdOwogIGNvbnN0IG9yaWdpbmFsVmFsdWVzID0gW107CiAgCiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aW1lUG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCB0aW1lID0gdGltZVBvaW50c1tpXTsKICAgIGNvbnN0IHZhbCA9IHZhbHVlc1tpXTsKICAgIAogICAgaWYgKHRpbWUgPT09IG51bGwgfHwgdmFsID09PSBudWxsKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQogICAgCiAgICAvLyBPbmx5IGluY2x1ZGUgcG9pbnRzIGFmdGVyIGJhc2VsaW5lRW5kVGltZSBhbmQgdXAgdG8gY3V0b2ZmVGltZSAoYmFzZWxpbmUgTk9UIGluY2x1ZGVkKQogICAgaWYgKHRpbWUgPiBiYXNlbGluZUVuZFRpbWUgJiYgdGltZSA8PSBjdXRvZmZUaW1lKSB7CiAgICAgIC8vIFN1YnRyYWN0IGJhc2VsaW5lRW5kVGltZSB0byBicmluZyBmaXJzdCBwb2ludCB0byB4PTAgKHRpbWUgYWZ0ZXIgaW5qZWN0aW9uKQogICAgICBmaWx0ZXJlZFRpbWVQb2ludHMucHVzaCh0aW1lIC0gYmFzZWxpbmVFbmRUaW1lKTsKICAgICAgLy8gRGl2aWRlIEVWRVJZIHRpbWUgcG9pbnQgYnkgdGhlIFNBTUUgYmFzZWxpbmUgYXZlcmFnZQogICAgICBub3JtYWxpemVkVmFsdWVzLnB1c2godmFsIC8gYmFzZWxpbmUpOwogICAgICBvcmlnaW5hbFZhbHVlcy5wdXNoKHZhbCk7IC8vIFN0b3JlIG9yaWdpbmFsIHZhbHVlIGZvciB0b29sdGlwCiAgICB9CiAgfQogIAogIHJldHVybiB7IGZpbHRlcmVkVGltZVBvaW50cywgbm9ybWFsaXplZFZhbHVlcywgb3JpZ2luYWxWYWx1ZXMgfTsKfQoKLy8gRml0IGJhc2VsaW5lIGZ1bmN0aW9uIHVzaW5nIHNwZWNpZmllZCBtZXRob2QKZnVuY3Rpb24gZml0QmFzZWxpbmVGdW5jdGlvbih0aW1lUG9pbnRzLCB2YWx1ZXMsIG1ldGhvZCA9ICdsb3dlc3MnLCBmcmFjID0gMC41LCBwb2x5T3JkZXIgPSAxKSB7CiAgLy8gRXh0cmFjdCBiYXNlbGluZSB3aW5kb3cgKHRpbWUgPD0gYmFzZWxpbmVFbmRUaW1lIHdpbGwgYmUgaGFuZGxlZCBieSBjYWxsZXIpCiAgLy8gVGhpcyBmdW5jdGlvbiBmaXRzIG9uIHRoZSBwcm92aWRlZCBwb2ludHMgYW5kIHJldHVybnMgYSBmdW5jdGlvbiBnKHQpIHRoYXQgY2FuIGJlIGV2YWx1YXRlZCBhdCBhbnkgdGltZQogIAogIGlmICghdGltZVBvaW50cyB8fCAhdmFsdWVzIHx8IHRpbWVQb2ludHMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgLy8gRmlsdGVyIG91dCBOYU4gdmFsdWVzCiAgY29uc3QgdmFsaWREYXRhID0gW107CiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aW1lUG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAodGltZVBvaW50c1tpXSAhPT0gbnVsbCAmJiB2YWx1ZXNbaV0gIT09IG51bGwgJiYgIWlzTmFOKHRpbWVQb2ludHNbaV0pICYmICFpc05hTih2YWx1ZXNbaV0pKSB7CiAgICAgIHZhbGlkRGF0YS5wdXNoKHsgdDogdGltZVBvaW50c1tpXSwgdjogdmFsdWVzW2ldIH0pOwogICAgfQogIH0KICAKICBpZiAodmFsaWREYXRhLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIAogIHZhbGlkRGF0YS5zb3J0KChhLCBiKSA9PiBhLnQgLSBiLnQpOwogIGNvbnN0IHRpbWVzID0gdmFsaWREYXRhLm1hcChkID0+IGQudCk7CiAgY29uc3QgdmFscyA9IHZhbGlkRGF0YS5tYXAoZCA9PiBkLnYpOwogIAogIGlmIChtZXRob2QgPT09ICdjb25zdGFudCcpIHsKICAgIC8vIENvbnN0YW50IGJhc2VsaW5lOiBnKHQpID0gbWVhbihGX2Jhc2VsaW5lKQogICAgY29uc3QgYmFzZWxpbmVWYWx1ZSA9IHZhbHMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyB2YWxzLmxlbmd0aDsKICAgIHJldHVybiAodCkgPT4gYmFzZWxpbmVWYWx1ZTsKICB9IGVsc2UgaWYgKG1ldGhvZCA9PT0gJ3BvbHlub21pYWwnKSB7CiAgICAvLyBQb2x5bm9taWFsIGZpdDogZyh0KSA9IGPigoAgKyBj4oKBdCArIGPigoJ0wrIgKyAuLi4KICAgIC8vIFNpbXBsZSBwb2x5bm9taWFsIHJlZ3Jlc3Npb24KICAgIGNvbnN0IG4gPSB0aW1lcy5sZW5ndGg7CiAgICBjb25zdCBYID0gW107CiAgICBjb25zdCB5ID0gdmFsczsKICAgIAogICAgLy8gQnVpbGQgZGVzaWduIG1hdHJpeAogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuOyBpKyspIHsKICAgICAgY29uc3Qgcm93ID0gW107CiAgICAgIGZvciAobGV0IHAgPSBwb2x5T3JkZXI7IHAgPj0gMDsgcC0tKSB7CiAgICAgICAgcm93LnB1c2goTWF0aC5wb3codGltZXNbaV0sIHApKTsKICAgICAgfQogICAgICBYLnB1c2gocm93KTsKICAgIH0KICAgIAogICAgLy8gU29sdmUgdXNpbmcgbm9ybWFsIGVxdWF0aW9uczogKFgnWCleKC0xKVgneQogICAgLy8gU2ltcGxpZmllZCBmb3Igc21hbGwgb3JkZXJzCiAgICBsZXQgY29lZmZzOwogICAgaWYgKHBvbHlPcmRlciA9PT0gMSkgewogICAgICAvLyBMaW5lYXI6IHkgPSBhICsgYip0CiAgICAgIGNvbnN0IHN1bVQgPSB0aW1lcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTsKICAgICAgY29uc3Qgc3VtVDIgPSB0aW1lcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiICogYiwgMCk7CiAgICAgIGNvbnN0IHN1bVkgPSB5LnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgICBjb25zdCBzdW1UWSA9IHRpbWVzLnJlZHVjZSgoc3VtLCB0LCBpKSA9PiBzdW0gKyB0ICogeVtpXSwgMCk7CiAgICAgIGNvbnN0IG4gPSB0aW1lcy5sZW5ndGg7CiAgICAgIAogICAgICBjb25zdCBkZXQgPSBuICogc3VtVDIgLSBzdW1UICogc3VtVDsKICAgICAgaWYgKE1hdGguYWJzKGRldCkgPCAxZS0xMCkgewogICAgICAgIC8vIEZhbGxiYWNrIHRvIGNvbnN0YW50CiAgICAgICAgY29uc3QgbWVhbiA9IHN1bVkgLyBuOwogICAgICAgIHJldHVybiAodCkgPT4gbWVhbjsKICAgICAgfQogICAgICAKICAgICAgY29uc3QgYSA9IChzdW1ZICogc3VtVDIgLSBzdW1UICogc3VtVFkpIC8gZGV0OwogICAgICBjb25zdCBiID0gKG4gKiBzdW1UWSAtIHN1bVQgKiBzdW1ZKSAvIGRldDsKICAgICAgY29lZmZzID0gW2IsIGFdOyAvLyBbYzEsIGMwXSBmb3IgcG9seTFkIGZvcm1hdAogICAgfSBlbHNlIHsKICAgICAgLy8gSGlnaGVyIG9yZGVyIC0gdXNlIHNpbXBsZSBsZWFzdCBzcXVhcmVzCiAgICAgIC8vIEZvciBzaW1wbGljaXR5LCB1c2UgYSBiYXNpYyBpbXBsZW1lbnRhdGlvbgogICAgICBjb25zdCBtZWFuVCA9IHN1bVQgLyBuOwogICAgICBjb25zdCBtZWFuWSA9IHN1bVkgLyBuOwogICAgICAvLyBGYWxsYmFjayB0byBjb25zdGFudCBmb3Igbm93IGlmIG9yZGVyID4gMQogICAgICBjb25zdCBtZWFuID0gbWVhblk7CiAgICAgIHJldHVybiAodCkgPT4gbWVhbjsKICAgIH0KICAgIAogICAgcmV0dXJuICh0KSA9PiB7CiAgICAgIGxldCByZXN1bHQgPSAwOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvZWZmcy5sZW5ndGg7IGkrKykgewogICAgICAgIHJlc3VsdCArPSBjb2VmZnNbaV0gKiBNYXRoLnBvdyh0LCBjb2VmZnMubGVuZ3RoIC0gMSAtIGkpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0gZWxzZSBpZiAobWV0aG9kID09PSAnbG93ZXNzJykgewogICAgLy8gTE9XRVNTIHNtb290aGluZyAtIHNpbXBsaWZpZWQgaW1wbGVtZW50YXRpb24KICAgIC8vIEZvciBhIHByb3BlciBMT1dFU1MsIHdlJ2QgbmVlZCBhIGxpYnJhcnksIGJ1dCB3ZSBjYW4gYXBwcm94aW1hdGUgd2l0aCBtb3ZpbmcgYXZlcmFnZQogICAgLy8gVGhpcyBpcyBhIHNpbXBsaWZpZWQgdmVyc2lvbiAtIGZvciBwcm9kdWN0aW9uLCBjb25zaWRlciB1c2luZyBhIGxpYnJhcnkgbGlrZSByZWdyZXNzaW9uLmpzCiAgICAKICAgIC8vIFVzZSBhIHNpbXBsZSBtb3ZpbmcgYXZlcmFnZSB3aXRoIHdlaWdodGVkIHdpbmRvdyBhcyBhcHByb3hpbWF0aW9uCiAgICBjb25zdCB3aW5kb3dTaXplID0gTWF0aC5tYXgoMSwgTWF0aC5mbG9vcihmcmFjICogdGltZXMubGVuZ3RoKSk7CiAgICBjb25zdCBzbW9vdGhlZCA9IFtdOwogICAgCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRpbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGxldCBzdW0gPSAwOwogICAgICBsZXQgd2VpZ2h0U3VtID0gMDsKICAgICAgY29uc3QgY2VudGVyID0gdGltZXNbaV07CiAgICAgIAogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRpbWVzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguYWJzKHRpbWVzW2pdIC0gY2VudGVyKTsKICAgICAgICBjb25zdCBtYXhEaXN0ID0gTWF0aC5tYXgoLi4udGltZXMubWFwKHQgPT4gTWF0aC5hYnModCAtIGNlbnRlcikpKTsKICAgICAgICBjb25zdCB3ZWlnaHQgPSBkaXN0IDwgbWF4RGlzdCAqIGZyYWMgPyBNYXRoLnBvdygxIC0gKGRpc3QgLyAobWF4RGlzdCAqIGZyYWMpKSwgMykgOiAwOyAvLyBUcmljdWJlIHdlaWdodAogICAgICAgIAogICAgICAgIHN1bSArPSB2YWxzW2pdICogd2VpZ2h0OwogICAgICAgIHdlaWdodFN1bSArPSB3ZWlnaHQ7CiAgICAgIH0KICAgICAgCiAgICAgIHNtb290aGVkLnB1c2god2VpZ2h0U3VtID4gMCA/IHN1bSAvIHdlaWdodFN1bSA6IHZhbHNbaV0pOwogICAgfQogICAgCiAgICAvLyBSZXR1cm4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbgogICAgcmV0dXJuICh0KSA9PiB7CiAgICAgIGlmICh0IDw9IHRpbWVzWzBdKSByZXR1cm4gc21vb3RoZWRbMF07CiAgICAgIGlmICh0ID49IHRpbWVzW3RpbWVzLmxlbmd0aCAtIDFdKSByZXR1cm4gc21vb3RoZWRbc21vb3RoZWQubGVuZ3RoIC0gMV07CiAgICAgIAogICAgICAvLyBMaW5lYXIgaW50ZXJwb2xhdGlvbgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRpbWVzLmxlbmd0aCAtIDE7IGkrKykgewogICAgICAgIGlmICh0ID49IHRpbWVzW2ldICYmIHQgPD0gdGltZXNbaSArIDFdKSB7CiAgICAgICAgICBjb25zdCByYXRpbyA9ICh0IC0gdGltZXNbaV0pIC8gKHRpbWVzW2kgKyAxXSAtIHRpbWVzW2ldKTsKICAgICAgICAgIHJldHVybiBzbW9vdGhlZFtpXSAqICgxIC0gcmF0aW8pICsgc21vb3RoZWRbaSArIDFdICogcmF0aW87CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzbW9vdGhlZFtzbW9vdGhlZC5sZW5ndGggLSAxXTsKICAgIH07CiAgfQogIAogIHJldHVybiBudWxsOwp9CgovLyBOb3JtYWxpemUgd2VsbCBkYXRhIHVzaW5nIGZpdHRlZCBiYXNlbGluZSAoU3RlcCA0KQpmdW5jdGlvbiBub3JtYWxpemVXaXRoRml0dGVkQmFzZWxpbmUod2VsbERhdGEsIGJhc2VsaW5lRW5kVGltZSwgbWV0aG9kLCBmcmFjLCBwb2x5T3JkZXIsIG5vcm1hbGl6YXRpb25Nb2RlKSB7CiAgaWYgKCF3ZWxsRGF0YSB8fCAhd2VsbERhdGEudGltZV9zIHx8ICF3ZWxsRGF0YS52YWx1ZXMpIHsKICAgIHJldHVybiB3ZWxsRGF0YTsKICB9CiAgCiAgLy8gRXh0cmFjdCBiYXNlbGluZSB3aW5kb3cKICBjb25zdCBiYXNlbGluZVRpbWVzID0gW107CiAgY29uc3QgYmFzZWxpbmVWYWx1ZXMgPSBbXTsKICBmb3IgKGxldCBpID0gMDsgaSA8IHdlbGxEYXRhLnRpbWVfcy5sZW5ndGg7IGkrKykgewogICAgY29uc3QgdGltZSA9IHdlbGxEYXRhLnRpbWVfc1tpXTsKICAgIGNvbnN0IHZhbCA9IHdlbGxEYXRhLnZhbHVlc1tpXTsKICAgIGlmICh0aW1lICE9PSBudWxsICYmIHZhbCAhPT0gbnVsbCAmJiB0aW1lIDw9IGJhc2VsaW5lRW5kVGltZSkgewogICAgICBiYXNlbGluZVRpbWVzLnB1c2godGltZSk7CiAgICAgIGJhc2VsaW5lVmFsdWVzLnB1c2godmFsKTsKICAgIH0KICB9CiAgCiAgaWYgKGJhc2VsaW5lVGltZXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gd2VsbERhdGE7IC8vIE5vIGJhc2VsaW5lIGRhdGEKICB9CiAgCiAgLy8gRml0IGJhc2VsaW5lIGZ1bmN0aW9uCiAgY29uc3QgYmFzZWxpbmVGdW5jID0gZml0QmFzZWxpbmVGdW5jdGlvbihiYXNlbGluZVRpbWVzLCBiYXNlbGluZVZhbHVlcywgbWV0aG9kLCBmcmFjLCBwb2x5T3JkZXIpOwogIGlmICghYmFzZWxpbmVGdW5jKSB7CiAgICByZXR1cm4gd2VsbERhdGE7CiAgfQogIAogIC8vIE5vcm1hbGl6ZSBhbGwgdGltZXBvaW50cyB1c2luZyBmaXR0ZWQgYmFzZWxpbmUKICBjb25zdCBub3JtYWxpemVkVGltZXMgPSBbXTsKICBjb25zdCBub3JtYWxpemVkVmFsdWVzID0gW107CiAgY29uc3Qgb3JpZ2luYWxWYWx1ZXMgPSBbXTsKICAKICBmb3IgKGxldCBpID0gMDsgaSA8IHdlbGxEYXRhLnRpbWVfcy5sZW5ndGg7IGkrKykgewogICAgY29uc3QgdGltZSA9IHdlbGxEYXRhLnRpbWVfc1tpXTsKICAgIGNvbnN0IHZhbHVlID0gd2VsbERhdGEudmFsdWVzW2ldOwogICAgCiAgICBpZiAodGltZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gbnVsbCkgY29udGludWU7CiAgICAKICAgIGNvbnN0IGJhc2VsaW5lVmFsdWUgPSBiYXNlbGluZUZ1bmModGltZSk7CiAgICBpZiAoYmFzZWxpbmVWYWx1ZSA9PT0gMCB8fCAhaXNGaW5pdGUoYmFzZWxpbmVWYWx1ZSkpIGNvbnRpbnVlOwogICAgCiAgICBsZXQgbm9ybVZhbHVlOwogICAgaWYgKG5vcm1hbGl6YXRpb25Nb2RlID09PSAnZGVsdGFfZl9vdmVyX2YnKSB7CiAgICAgIC8vIM6URi9GID0gKEYodCkgLSBnKHQpKSAvIGcodCkKICAgICAgbm9ybVZhbHVlID0gKHZhbHVlIC0gYmFzZWxpbmVWYWx1ZSkgLyBiYXNlbGluZVZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgLy8gTXVsdGlwbGljYXRpdmU6IEZfbm9ybSh0KSA9IEYodCkgLyBnKHQpCiAgICAgIG5vcm1WYWx1ZSA9IHZhbHVlIC8gYmFzZWxpbmVWYWx1ZTsKICAgIH0KICAgIAogICAgbm9ybWFsaXplZFRpbWVzLnB1c2godGltZSk7CiAgICBub3JtYWxpemVkVmFsdWVzLnB1c2gobm9ybVZhbHVlKTsKICAgIG9yaWdpbmFsVmFsdWVzLnB1c2godmFsdWUpOwogIH0KICAKICBpZiAobm9ybWFsaXplZFRpbWVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIAogIHJldHVybiB7CiAgICB0aW1lX3M6IG5vcm1hbGl6ZWRUaW1lcywKICAgIHZhbHVlczogbm9ybWFsaXplZFZhbHVlcywKICAgIG9yaWdpbmFsVmFsdWVzOiBvcmlnaW5hbFZhbHVlcywKICAgIGxhYmVsOiB3ZWxsRGF0YS5sYWJlbCwKICAgIGNvbnRlbnQ6IHdlbGxEYXRhLmNvbnRlbnQKICB9Owp9CgpmdW5jdGlvbiBub3JtYWxpemVXZWxsRGF0YSh3ZWxsRGF0YSwgaXNOb3JtYWxpemVkLCBiYXNlbGluZUVuZFRpbWUgPSAyNCwgY3V0b2ZmVGltZSA9IDM2MCkgewogIC8vIFNURVAgMzogTm9ybWFsaXplIGEgc2luZ2xlIHdlbGwncyBkYXRhIG9iamVjdCAoaWYgbm9ybWFsaXphdGlvbiBpcyBlbmFibGVkKQogIC8vIFRoaXMgaGFwcGVucyBBRlRFUiBiYXNlbGluZSBhbGlnbm1lbnQgYW5kIGdyb3VwaW5nIGludG8gdHJpcGxpY2F0ZXMKICAvLyBSZXR1cm5zIGEgbmV3IHdlbGwgZGF0YSBvYmplY3Qgd2l0aCBub3JtYWxpemVkIHRpbWVfcyBhbmQgdmFsdWVzIChvciBvcmlnaW5hbCBpZiBub3Qgbm9ybWFsaXplZCkKICBpZiAoIXdlbGxEYXRhIHx8ICF3ZWxsRGF0YS50aW1lX3MgfHwgIXdlbGxEYXRhLnZhbHVlcykgewogICAgcmV0dXJuIHdlbGxEYXRhOyAvLyBSZXR1cm4gYXMtaXMgaWYgaW52YWxpZAogIH0KICAKICBpZiAoIWlzTm9ybWFsaXplZCkgewogICAgLy8gTm90IG5vcm1hbGl6aW5nIC0gcmV0dXJuIG9yaWdpbmFsIGRhdGEKICAgIHJldHVybiB7CiAgICAgIHRpbWVfczogd2VsbERhdGEudGltZV9zLAogICAgICB2YWx1ZXM6IHdlbGxEYXRhLnZhbHVlcywKICAgICAgbGFiZWw6IHdlbGxEYXRhLmxhYmVsLAogICAgICBjb250ZW50OiB3ZWxsRGF0YS5jb250ZW50LAogICAgICBvcmlnaW5hbFZhbHVlczogd2VsbERhdGEub3JpZ2luYWxWYWx1ZXMgfHwgd2VsbERhdGEudmFsdWVzCiAgICB9OwogIH0KICAKICAvLyBOb3JtYWxpemUgdGhpcyB3ZWxsCiAgY29uc3Qgbm9ybWFsaXplZCA9IG5vcm1hbGl6ZURhdGEod2VsbERhdGEudGltZV9zLCB3ZWxsRGF0YS52YWx1ZXMsIGJhc2VsaW5lRW5kVGltZSwgY3V0b2ZmVGltZSk7CiAgCiAgaWYgKG5vcm1hbGl6ZWQuZmlsdGVyZWRUaW1lUG9pbnRzLmxlbmd0aCA9PT0gMCkgewogICAgLy8gTm8gZGF0YSBhZnRlciBub3JtYWxpemF0aW9uIC0gcmV0dXJuIG51bGwgdG8gaW5kaWNhdGUgdGhpcyB3ZWxsIHNob3VsZCBiZSBza2lwcGVkCiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgLy8gUmV0dXJuIG5vcm1hbGl6ZWQgd2VsbCBkYXRhCiAgcmV0dXJuIHsKICAgIHRpbWVfczogbm9ybWFsaXplZC5maWx0ZXJlZFRpbWVQb2ludHMsCiAgICB2YWx1ZXM6IG5vcm1hbGl6ZWQubm9ybWFsaXplZFZhbHVlcywKICAgIG9yaWdpbmFsVmFsdWVzOiBub3JtYWxpemVkLm9yaWdpbmFsVmFsdWVzLCAvLyBTdG9yZSBmb3IgdG9vbHRpcCBkaXNwbGF5CiAgICBsYWJlbDogd2VsbERhdGEubGFiZWwsCiAgICBjb250ZW50OiB3ZWxsRGF0YS5jb250ZW50CiAgfTsKfQoKCi8vIEZpdCByZWdyZXNzaW9uIGN1cnZlIHRvIGRhdGEgcG9pbnRzIChTdGVwIDQpCmZ1bmN0aW9uIGZpdFJlZ3Jlc3Npb25DdXJ2ZShkYXRhUG9pbnRzLCByZWdyZXNzaW9uVHlwZSA9ICdtb25vLWV4cG9uZW50aWFsJywgcG9seW5vbWlhbE9yZGVyID0gMikgewogIC8vIGRhdGFQb2ludHMgaXMgYW4gYXJyYXkgb2Yge3gsIHl9IG9iamVjdHMKICBpZiAoIWRhdGFQb2ludHMgfHwgZGF0YVBvaW50cy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBudWxsOwogIH0KICAKICAvLyBGaWx0ZXIgdmFsaWQgcG9pbnRzCiAgY29uc3QgdmFsaWRQb2ludHMgPSBkYXRhUG9pbnRzLmZpbHRlcihwID0+IHAueCAhPT0gbnVsbCAmJiBwLnkgIT09IG51bGwgJiYgaXNGaW5pdGUocC54KSAmJiBpc0Zpbml0ZShwLnkpKTsKICBpZiAodmFsaWRQb2ludHMubGVuZ3RoIDwgMikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIAogIC8vIFNvcnQgYnkgeAogIHZhbGlkUG9pbnRzLnNvcnQoKGEsIGIpID0+IGEueCAtIGIueCk7CiAgY29uc3QgeCA9IHZhbGlkUG9pbnRzLm1hcChwID0+IHAueCk7CiAgY29uc3QgeSA9IHZhbGlkUG9pbnRzLm1hcChwID0+IHAueSk7CiAgCiAgbGV0IGZpdEZ1bmN0aW9uOwogIAogIGlmIChyZWdyZXNzaW9uVHlwZSA9PT0gJ2xpbmVhcicpIHsKICAgIC8vIExpbmVhcjogeSA9IGEgKyBiKngKICAgIGNvbnN0IG4gPSB4Lmxlbmd0aDsKICAgIGNvbnN0IHN1bVggPSB4LnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgY29uc3Qgc3VtWSA9IHkucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICBjb25zdCBzdW1YWSA9IHgucmVkdWNlKChzdW0sIHhpLCBpKSA9PiBzdW0gKyB4aSAqIHlbaV0sIDApOwogICAgY29uc3Qgc3VtWDIgPSB4LnJlZHVjZSgoc3VtLCB4aSkgPT4gc3VtICsgeGkgKiB4aSwgMCk7CiAgICAKICAgIGNvbnN0IGRldCA9IG4gKiBzdW1YMiAtIHN1bVggKiBzdW1YOwogICAgaWYgKE1hdGguYWJzKGRldCkgPCAxZS0xMCkgewogICAgICAvLyBGYWxsYmFjayB0byBjb25zdGFudAogICAgICBjb25zdCBtZWFuID0gc3VtWSAvIG47CiAgICAgIGZpdEZ1bmN0aW9uID0gKHQpID0+IG1lYW47CiAgICB9IGVsc2UgewogICAgICBjb25zdCBhID0gKHN1bVkgKiBzdW1YMiAtIHN1bVggKiBzdW1YWSkgLyBkZXQ7CiAgICAgIGNvbnN0IGIgPSAobiAqIHN1bVhZIC0gc3VtWCAqIHN1bVkpIC8gZGV0OwogICAgICBmaXRGdW5jdGlvbiA9ICh0KSA9PiBhICsgYiAqIHQ7CiAgICB9CiAgfSBlbHNlIGlmIChyZWdyZXNzaW9uVHlwZSA9PT0gJ3BvbHlub21pYWwnKSB7CiAgICAvLyBQb2x5bm9taWFsOiB5ID0gYzAgKyBjMSp4ICsgYzIqeF4yICsgLi4uICsgY24qeF5uCiAgICBjb25zdCBuID0geC5sZW5ndGg7CiAgICBjb25zdCBvcmRlciA9IE1hdGgubWluKHBvbHlub21pYWxPcmRlciwgbiAtIDEpOyAvLyBDYW4ndCBmaXQgb3JkZXIgPj0gbiBwb2ludHMKICAgIAogICAgLy8gQnVpbGQgZGVzaWduIG1hdHJpeAogICAgY29uc3QgWCA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuOyBpKyspIHsKICAgICAgY29uc3Qgcm93ID0gW107CiAgICAgIGZvciAobGV0IHAgPSBvcmRlcjsgcCA+PSAwOyBwLS0pIHsKICAgICAgICByb3cucHVzaChNYXRoLnBvdyh4W2ldLCBwKSk7CiAgICAgIH0KICAgICAgWC5wdXNoKHJvdyk7CiAgICB9CiAgICAKICAgIC8vIFNvbHZlIHVzaW5nIG5vcm1hbCBlcXVhdGlvbnM6IChYJ1gpXigtMSlYJ3kKICAgIC8vIFNpbXBsaWZpZWQgZm9yIHNtYWxsIG9yZGVycwogICAgbGV0IGNvZWZmczsKICAgIGlmIChvcmRlciA9PT0gMSkgewogICAgICAvLyBMaW5lYXIgY2FzZQogICAgICBjb25zdCBzdW1YID0geC5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTsKICAgICAgY29uc3Qgc3VtWDIgPSB4LnJlZHVjZSgoc3VtLCB4aSkgPT4gc3VtICsgeGkgKiB4aSwgMCk7CiAgICAgIGNvbnN0IHN1bVkgPSB5LnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgICBjb25zdCBzdW1YWSA9IHgucmVkdWNlKChzdW0sIHhpLCBpKSA9PiBzdW0gKyB4aSAqIHlbaV0sIDApOwogICAgICBjb25zdCBkZXQgPSBuICogc3VtWDIgLSBzdW1YICogc3VtWDsKICAgICAgaWYgKE1hdGguYWJzKGRldCkgPCAxZS0xMCkgewogICAgICAgIGNvZWZmcyA9IFtzdW1ZIC8gbiwgMF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgYSA9IChzdW1ZICogc3VtWDIgLSBzdW1YICogc3VtWFkpIC8gZGV0OwogICAgICAgIGNvbnN0IGIgPSAobiAqIHN1bVhZIC0gc3VtWCAqIHN1bVkpIC8gZGV0OwogICAgICAgIGNvZWZmcyA9IFthLCBiXTsgLy8gW2MwLCBjMV0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gSGlnaGVyIG9yZGVyIC0gdXNlIHNpbXBsZSBsZWFzdCBzcXVhcmVzIGFwcHJveGltYXRpb24KICAgICAgLy8gRm9yIHNpbXBsaWNpdHksIHVzZSBhIGJhc2ljIGltcGxlbWVudGF0aW9uCiAgICAgIGNvbnN0IG1lYW5ZID0geS5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIG47CiAgICAgIGNvZWZmcyA9IFttZWFuWV07CiAgICAgIGZvciAobGV0IHAgPSAxOyBwIDw9IG9yZGVyOyBwKyspIHsKICAgICAgICBjb2VmZnMucHVzaCgwKTsKICAgICAgfQogICAgfQogICAgCiAgICBmaXRGdW5jdGlvbiA9ICh0KSA9PiB7CiAgICAgIGxldCByZXN1bHQgPSAwOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvZWZmcy5sZW5ndGg7IGkrKykgewogICAgICAgIHJlc3VsdCArPSBjb2VmZnNbaV0gKiBNYXRoLnBvdyh0LCBjb2VmZnMubGVuZ3RoIC0gMSAtIGkpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0gZWxzZSBpZiAocmVncmVzc2lvblR5cGUgPT09ICdleHBvbmVudGlhbCcpIHsKICAgIC8vIEV4cG9uZW50aWFsOiB5ID0gYSAqIGVeKGIqeCkgb3IgeSA9IGEgKiBiXngKICAgIC8vIFRyYW5zZm9ybSB0byBsaW5lYXI6IGxuKHkpID0gbG4oYSkgKyBiKngKICAgIGNvbnN0IGxvZ1kgPSB5Lm1hcCh5aSA9PiB5aSA+IDAgPyBNYXRoLmxvZyh5aSkgOiBudWxsKS5maWx0ZXIobHkgPT4gbHkgIT09IG51bGwpOwogICAgaWYgKGxvZ1kubGVuZ3RoIDwgMikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIAogICAgY29uc3QgbiA9IHgubGVuZ3RoOwogICAgY29uc3Qgc3VtWCA9IHgucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICBjb25zdCBzdW1Mb2dZID0gbG9nWS5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTsKICAgIGNvbnN0IHN1bVhMb2dZID0geC5zbGljZSgwLCBsb2dZLmxlbmd0aCkucmVkdWNlKChzdW0sIHhpLCBpKSA9PiBzdW0gKyB4aSAqIGxvZ1lbaV0sIDApOwogICAgY29uc3Qgc3VtWDIgPSB4LnNsaWNlKDAsIGxvZ1kubGVuZ3RoKS5yZWR1Y2UoKHN1bSwgeGkpID0+IHN1bSArIHhpICogeGksIDApOwogICAgCiAgICBjb25zdCBkZXQgPSBsb2dZLmxlbmd0aCAqIHN1bVgyIC0gc3VtWCAqIHN1bVg7CiAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgCiAgICBjb25zdCBsbkEgPSAoc3VtTG9nWSAqIHN1bVgyIC0gc3VtWCAqIHN1bVhMb2dZKSAvIGRldDsKICAgIGNvbnN0IGIgPSAobG9nWS5sZW5ndGggKiBzdW1YTG9nWSAtIHN1bVggKiBzdW1Mb2dZKSAvIGRldDsKICAgIGNvbnN0IGEgPSBNYXRoLmV4cChsbkEpOwogICAgCiAgICBmaXRGdW5jdGlvbiA9ICh0KSA9PiBhICogTWF0aC5leHAoYiAqIHQpOwogIH0gZWxzZSBpZiAocmVncmVzc2lvblR5cGUgPT09ICdsb2dhcml0aG1pYycpIHsKICAgIC8vIExvZ2FyaXRobWljOiB5ID0gYSArIGIqbG4oeCkKICAgIC8vIEZpbHRlciBvdXQgbm9uLXBvc2l0aXZlIHggdmFsdWVzCiAgICBjb25zdCB2YWxpZEluZGljZXMgPSBbXTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgeC5sZW5ndGg7IGkrKykgewogICAgICBpZiAoeFtpXSA+IDApIHsKICAgICAgICB2YWxpZEluZGljZXMucHVzaChpKTsKICAgICAgfQogICAgfQogICAgCiAgICBpZiAodmFsaWRJbmRpY2VzLmxlbmd0aCA8IDIpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICAKICAgIGNvbnN0IGxvZ1ggPSB2YWxpZEluZGljZXMubWFwKGkgPT4gTWF0aC5sb2coeFtpXSkpOwogICAgY29uc3QgdmFsaWRZID0gdmFsaWRJbmRpY2VzLm1hcChpID0+IHlbaV0pOwogICAgY29uc3QgbiA9IHZhbGlkSW5kaWNlcy5sZW5ndGg7CiAgICAKICAgIGNvbnN0IHN1bUxvZ1ggPSBsb2dYLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgY29uc3Qgc3VtWSA9IHZhbGlkWS5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTsKICAgIGNvbnN0IHN1bUxvZ1hZID0gbG9nWC5yZWR1Y2UoKHN1bSwgbHhpLCBpKSA9PiBzdW0gKyBseGkgKiB2YWxpZFlbaV0sIDApOwogICAgY29uc3Qgc3VtTG9nWDIgPSBsb2dYLnJlZHVjZSgoc3VtLCBseGkpID0+IHN1bSArIGx4aSAqIGx4aSwgMCk7CiAgICAKICAgIGNvbnN0IGRldCA9IG4gKiBzdW1Mb2dYMiAtIHN1bUxvZ1ggKiBzdW1Mb2dYOwogICAgaWYgKE1hdGguYWJzKGRldCkgPCAxZS0xMCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIAogICAgY29uc3QgYSA9IChzdW1ZICogc3VtTG9nWDIgLSBzdW1Mb2dYICogc3VtTG9nWFkpIC8gZGV0OwogICAgY29uc3QgYiA9IChuICogc3VtTG9nWFkgLSBzdW1Mb2dYICogc3VtWSkgLyBkZXQ7CiAgICAKICAgIGZpdEZ1bmN0aW9uID0gKHQpID0+IHQgPiAwID8gYSArIGIgKiBNYXRoLmxvZyh0KSA6IG51bGw7CiAgfSBlbHNlIGlmIChyZWdyZXNzaW9uVHlwZSA9PT0gJ21vbm8tZXhwb25lbnRpYWwnKSB7CiAgICAvLyBNb25vLWV4cG9uZW50aWFsIHJpc2UgdG8gcGxhdGVhdTogeSh0KSA9IDEgKyBBKDEgLSBlXigtayh0IC0gdOKCgCkpKQogICAgLy8gRm9yIG5vcm1hbGl6ZWQgZGF0YSwgYmFzZWxpbmUg4omIIDEsIHNvIHdlIGZpeCB04oKAID0gMCAob3IgZmlyc3QgdGltZXBvaW50KQogICAgLy8geSh0KSA9IDEgKyBBKDEgLSBlXigtayp0KSkKICAgIAogICAgLy8gRmluZCB04oKAIGFzIHRoZSBmaXJzdCB0aW1lcG9pbnQgKG9yIDAgaWYgZGF0YSBzdGFydHMgYXQgMCkKICAgIGNvbnN0IHQwID0gTWF0aC5taW4oLi4ueCk7CiAgICBjb25zdCB4U2hpZnRlZCA9IHgubWFwKHhpID0+IHhpIC0gdDApOwogICAgCiAgICAvLyBJbml0aWFsIHBhcmFtZXRlciBlc3RpbWF0ZXMKICAgIC8vIEE6IGFtcGxpdHVkZSA9IG1heCh5KSAtIDEgKHNpbmNlIGJhc2VsaW5lIGlzIG5vcm1hbGl6ZWQgdG8gMSkKICAgIGNvbnN0IHlNYXggPSBNYXRoLm1heCguLi55KTsKICAgIGNvbnN0IHlNaW4gPSBNYXRoLm1pbiguLi55KTsKICAgIGxldCBBID0gTWF0aC5tYXgoMCwgeU1heCAtIDEpOyAvLyBBbXBsaXR1ZGUgc2hvdWxkIGJlIHBvc2l0aXZlCiAgICAKICAgIC8vIGs6IHJhdGUgY29uc3RhbnQgLSBlc3RpbWF0ZSBmcm9tIHJpc2UgdGltZQogICAgLy8gRmluZCB0aW1lcG9pbnQgd2hlcmUgc2lnbmFsIHJlYWNoZXMgfjYzJSUgb2YgYW1wbGl0dWRlICgxIC0gMS9lIOKJiCAwLjYzMikKICAgIGNvbnN0IHRpbWVTcGFuID0gTWF0aC5tYXgoLi4ueFNoaWZ0ZWQpIC0gTWF0aC5taW4oLi4ueFNoaWZ0ZWQpOwogICAgY29uc3QgdGFyZ2V0WSA9IDEgKyBBICogMC42MzI7CiAgICBsZXQgayA9IDAuMDE7IC8vIERlZmF1bHQgaW5pdGlhbCBndWVzcwogICAgaWYgKEEgPiAwLjAxICYmIHRpbWVTcGFuID4gMCkgewogICAgICAvLyBGaW5kIGNsb3Nlc3QgcG9pbnQgdG8gdGFyZ2V0CiAgICAgIGxldCBjbG9zZXN0SWR4ID0gMDsKICAgICAgbGV0IG1pbkRpZmYgPSBNYXRoLmFicyh5WzBdIC0gdGFyZ2V0WSk7CiAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgeS5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGRpZmYgPSBNYXRoLmFicyh5W2ldIC0gdGFyZ2V0WSk7CiAgICAgICAgaWYgKGRpZmYgPCBtaW5EaWZmKSB7CiAgICAgICAgICBtaW5EaWZmID0gZGlmZjsKICAgICAgICAgIGNsb3Nlc3RJZHggPSBpOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBFc3RpbWF0ZSBrIGZyb206IDEgLSBlXigtayp0KSA9IDAuNjMyID0+IGsg4omIIDEvdAogICAgICBpZiAoeFNoaWZ0ZWRbY2xvc2VzdElkeF0gPiAwKSB7CiAgICAgICAgayA9IDEgLyB4U2hpZnRlZFtjbG9zZXN0SWR4XTsKICAgICAgICBrID0gTWF0aC5tYXgoMWUtNiwgTWF0aC5taW4oMTAsIGspKTsgLy8gQm91bmQgYmV0d2VlbiAxZS02IGFuZCAxMAogICAgICB9CiAgICB9CiAgICAKICAgIC8vIFVzZSBzaW1wbGUgaXRlcmF0aXZlIG5vbmxpbmVhciBsZWFzdCBzcXVhcmVzIChHYXVzcy1OZXd0b24pCiAgICAvLyBNaW5pbWl6ZSBzdW0gb2Ygc3F1YXJlZCByZXNpZHVhbHM6IM6jKHkgLSAoMSArIEEoMSAtIGVeKC1rKnQpKSkpwrIKICAgIGNvbnN0IG1heEl0ZXJhdGlvbnMgPSAxMDA7CiAgICBjb25zdCB0b2xlcmFuY2UgPSAxZS02OwogICAgCiAgICBmb3IgKGxldCBpdGVyID0gMDsgaXRlciA8IG1heEl0ZXJhdGlvbnM7IGl0ZXIrKykgewogICAgICAvLyBDYWxjdWxhdGUgcmVzaWR1YWxzIGFuZCBKYWNvYmlhbgogICAgICBsZXQgc3VtUmVzaWR1YWwgPSAwOwogICAgICBsZXQgc3VtUmVzaWR1YWxBID0gMDsKICAgICAgbGV0IHN1bVJlc2lkdWFsSyA9IDA7CiAgICAgIGxldCBzdW1KQUEgPSAwOwogICAgICBsZXQgc3VtSkFLID0gMDsKICAgICAgbGV0IHN1bUpLSyA9IDA7CiAgICAgIAogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHhTaGlmdGVkLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgdCA9IHhTaGlmdGVkW2ldOwogICAgICAgIGNvbnN0IHlPYnMgPSB5W2ldOwogICAgICAgIGNvbnN0IHlQcmVkID0gMSArIEEgKiAoMSAtIE1hdGguZXhwKC1rICogdCkpOwogICAgICAgIGNvbnN0IHJlc2lkdWFsID0geU9icyAtIHlQcmVkOwogICAgICAgIAogICAgICAgIC8vIFBhcnRpYWwgZGVyaXZhdGl2ZXMKICAgICAgICBjb25zdCBkQSA9IDEgLSBNYXRoLmV4cCgtayAqIHQpOwogICAgICAgIGNvbnN0IGRLID0gQSAqIHQgKiBNYXRoLmV4cCgtayAqIHQpOwogICAgICAgIAogICAgICAgIHN1bVJlc2lkdWFsICs9IHJlc2lkdWFsOwogICAgICAgIHN1bVJlc2lkdWFsQSArPSByZXNpZHVhbCAqIGRBOwogICAgICAgIHN1bVJlc2lkdWFsSyArPSByZXNpZHVhbCAqIGRLOwogICAgICAgIHN1bUpBQSArPSBkQSAqIGRBOwogICAgICAgIHN1bUpBSyArPSBkQSAqIGRLOwogICAgICAgIHN1bUpLSyArPSBkSyAqIGRLOwogICAgICB9CiAgICAgIAogICAgICAvLyBTb2x2ZSBub3JtYWwgZXF1YXRpb25zOiBKXlQgKiBKICogZGVsdGEgPSBKXlQgKiByZXNpZHVhbAogICAgICBjb25zdCBkZXQgPSBzdW1KQUEgKiBzdW1KS0sgLSBzdW1KQUsgKiBzdW1KQUs7CiAgICAgIGlmIChNYXRoLmFicyhkZXQpIDwgMWUtMTApIGJyZWFrOwogICAgICAKICAgICAgY29uc3QgZGVsdGFBID0gKHN1bVJlc2lkdWFsQSAqIHN1bUpLSyAtIHN1bVJlc2lkdWFsSyAqIHN1bUpBSykgLyBkZXQ7CiAgICAgIGNvbnN0IGRlbHRhSyA9IChzdW1SZXNpZHVhbEsgKiBzdW1KQUEgLSBzdW1SZXNpZHVhbEEgKiBzdW1KQUspIC8gZGV0OwogICAgICAKICAgICAgLy8gVXBkYXRlIHBhcmFtZXRlcnMgd2l0aCBkYW1waW5nCiAgICAgIGNvbnN0IGRhbXBpbmcgPSAwLjU7CiAgICAgIEEgPSBNYXRoLm1heCgwLCBBICsgZGFtcGluZyAqIGRlbHRhQSk7CiAgICAgIGsgPSBNYXRoLm1heCgxZS02LCBNYXRoLm1pbigxMCwgayArIGRhbXBpbmcgKiBkZWx0YUspKTsKICAgICAgCiAgICAgIC8vIElmIHBhcmFtZXRlcnMgZGlkbid0IGNoYW5nZSBtdWNoLCB3ZSdyZSBkb25lCiAgICAgIGlmIChNYXRoLmFicyhkZWx0YUEpIDwgdG9sZXJhbmNlICYmIE1hdGguYWJzKGRlbHRhSykgPCB0b2xlcmFuY2UpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgCiAgICAvLyBTdG9yZSBwYXJhbWV0ZXJzIGZvciBpbmZvIHBhbmVsCiAgICBjb25zdCB0YXUgPSAxIC8gazsgLy8gdGltZSBjb25zdGFudAogICAgY29uc3QgdEhhbGYgPSBNYXRoLmxvZygyKSAvIGs7IC8vIGhhbGYtdGltZQogICAgY29uc3QgcGxhdGVhdSA9IDEgKyBBOyAvLyBwbGF0ZWF1IHZhbHVlCiAgICAKICAgIC8vIENyZWF0ZSBmaXQgZnVuY3Rpb24KICAgIGZpdEZ1bmN0aW9uID0gKHQpID0+IHsKICAgICAgY29uc3QgdFNoaWZ0ZWQgPSB0IC0gdDA7CiAgICAgIGlmICh0U2hpZnRlZCA8IDApIHJldHVybiAxOyAvLyBCZWZvcmUgYWN0aXZhdGlvbgogICAgICByZXR1cm4gMSArIEEgKiAoMSAtIE1hdGguZXhwKC1rICogdFNoaWZ0ZWQpKTsKICAgIH07CiAgICAKICAgIC8vIEF0dGFjaCBwYXJhbWV0ZXJzIHRvIGZ1bmN0aW9uIGZvciBpbmZvIHBhbmVsCiAgICBmaXRGdW5jdGlvbi5wYXJhbXMgPSB7CiAgICAgIEE6IEEsCiAgICAgIGs6IGssCiAgICAgIHQwOiB0MCwKICAgICAgdGF1OiB0YXUsCiAgICAgIHRIYWxmOiB0SGFsZiwKICAgICAgcGxhdGVhdTogcGxhdGVhdQogICAgfTsKICB9IGVsc2UgewogICAgcmV0dXJuIG51bGw7CiAgfQogIAogIHJldHVybiBmaXRGdW5jdGlvbjsKfQoKZnVuY3Rpb24gbm9ybWFsaXplTWVhbkFuZEVycm9yKHRpbWVQb2ludHMsIG1lYW5zLCBlcnJvcnMsIGJhc2VsaW5lRW5kVGltZSA9IDI0LCBjdXRvZmZUaW1lID0gMzYwKSB7CiAgLy8gTm9ybWFsaXplIG1lYW4gYW5kIGVycm9yIGRhdGE6IGNhbGN1bGF0ZSBiYXNlbGluZSBmcm9tIDAtYmFzZWxpbmVFbmRUaW1lLCB0aGVuIHBsb3Qgb25seSBwb2ludHMgYWZ0ZXIgYmFzZWxpbmVFbmRUaW1lCiAgLy8gZGl2aWRlZCBieSBiYXNlbGluZSwgdXAgdG8gY3V0b2ZmVGltZS4gQmFzZWxpbmUgcGVyaW9kIGlzIE5PVCBpbmNsdWRlZCBpbiB0aGUgcGxvdC4KICAvLyBSZXR1cm5zIHsgZmlsdGVyZWRUaW1lUG9pbnRzLCBub3JtYWxpemVkTWVhbnMsIG5vcm1hbGl6ZWRFcnJvcnMgfSAtIGZpbHRlcmVkIGFycmF5cwogIC8vIEZpcnN0IGNhbGN1bGF0ZSBiYXNlbGluZSBmcm9tIG1lYW5zCiAgY29uc3QgYmFzZWxpbmVWYWx1ZXMgPSBbXTsKICBmb3IgKGxldCBpID0gMDsgaSA8IHRpbWVQb2ludHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICh0aW1lUG9pbnRzW2ldICE9PSBudWxsICYmIG1lYW5zW2ldICE9PSBudWxsICYmIHRpbWVQb2ludHNbaV0gPD0gYmFzZWxpbmVFbmRUaW1lKSB7CiAgICAgIGJhc2VsaW5lVmFsdWVzLnB1c2gobWVhbnNbaV0pOwogICAgfQogIH0KICAKICBpZiAoYmFzZWxpbmVWYWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4geyBmaWx0ZXJlZFRpbWVQb2ludHM6IHRpbWVQb2ludHMsIG5vcm1hbGl6ZWRNZWFuczogbWVhbnMsIG5vcm1hbGl6ZWRFcnJvcnM6IGVycm9ycyB9OwogIH0KICAKICBjb25zdCBiYXNlbGluZSA9IGJhc2VsaW5lVmFsdWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gYmFzZWxpbmVWYWx1ZXMubGVuZ3RoOwogIAogIGlmIChiYXNlbGluZSA9PT0gMCkgewogICAgcmV0dXJuIHsgZmlsdGVyZWRUaW1lUG9pbnRzOiB0aW1lUG9pbnRzLCBub3JtYWxpemVkTWVhbnM6IG1lYW5zLCBub3JtYWxpemVkRXJyb3JzOiBlcnJvcnMgfTsKICB9CiAgCiAgLy8gRmlsdGVyIGFuZCBub3JtYWxpemU6IG9ubHkgaW5jbHVkZSBwb2ludHMgd2hlcmUgYmFzZWxpbmVFbmRUaW1lIDwgdGltZSA8PSBjdXRvZmZUaW1lCiAgY29uc3QgZmlsdGVyZWRUaW1lUG9pbnRzID0gW107CiAgY29uc3Qgbm9ybWFsaXplZE1lYW5zID0gW107CiAgY29uc3Qgbm9ybWFsaXplZEVycm9ycyA9IFtdOwogIAogIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZVBvaW50cy5sZW5ndGg7IGkrKykgewogICAgY29uc3QgdGltZSA9IHRpbWVQb2ludHNbaV07CiAgICBjb25zdCBtZWFuID0gbWVhbnNbaV07CiAgICBjb25zdCBlcnJvciA9IGVycm9yc1tpXTsKICAgIAogICAgaWYgKHRpbWUgPT09IG51bGwgfHwgbWVhbiA9PT0gbnVsbCkgewogICAgICBjb250aW51ZTsKICAgIH0KICAgIAogICAgLy8gT25seSBpbmNsdWRlIHBvaW50cyBhZnRlciBiYXNlbGluZUVuZFRpbWUgYW5kIHVwIHRvIGN1dG9mZlRpbWUgKGJhc2VsaW5lIE5PVCBpbmNsdWRlZCkKICAgIGlmICh0aW1lID4gYmFzZWxpbmVFbmRUaW1lICYmIHRpbWUgPD0gY3V0b2ZmVGltZSkgewogICAgICAvLyBTdWJ0cmFjdCBiYXNlbGluZUVuZFRpbWUgdG8gYnJpbmcgZmlyc3QgcG9pbnQgdG8geD0wICh0aW1lIGFmdGVyIGluamVjdGlvbikKICAgICAgZmlsdGVyZWRUaW1lUG9pbnRzLnB1c2godGltZSAtIGJhc2VsaW5lRW5kVGltZSk7CiAgICAgIG5vcm1hbGl6ZWRNZWFucy5wdXNoKG1lYW4gLyBiYXNlbGluZSk7CiAgICAgIC8vIEVycm9ycyBzY2FsZSBwcm9wb3J0aW9uYWxseQogICAgICBub3JtYWxpemVkRXJyb3JzLnB1c2goZXJyb3IgIT09IG51bGwgPyBlcnJvciAvIGJhc2VsaW5lIDogbnVsbCk7CiAgICB9CiAgfQogIAogIHJldHVybiB7IGZpbHRlcmVkVGltZVBvaW50cywgbm9ybWFsaXplZE1lYW5zLCBub3JtYWxpemVkRXJyb3JzIH07Cn0KCmZ1bmN0aW9uIHVwZGF0ZUNoYXJ0KCkgewogIC8vIEd1YXJkOiBlbnN1cmUgdmlld2VyRGF0YSBpcyBsb2FkZWQKICBpZiAoIXZpZXdlckRhdGEgfHwgIWFsbFdlbGxzRGF0YSB8fCBPYmplY3Qua2V5cyhhbGxXZWxsc0RhdGEpLmxlbmd0aCA9PT0gMCkgewogICAgY29uc29sZS53YXJuKCJ2aWV3ZXJEYXRhIG5vdCBsb2FkZWQgeWV0LCBza2lwcGluZyBjaGFydCB1cGRhdGUiKTsKICAgIHJldHVybjsKICB9CiAgCiAgY29uc3QgY3R4ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIndlbGwtY2hhcnQiKS5nZXRDb250ZXh0KCIyZCIpOwoKICAvLyBTVEVQIDE6IENoZWNrIGlmIG5vcm1hbGl6YXRpb24gdXNpbmcgZml0dGVkIGJhc2VsaW5lIGlzIGVuYWJsZWQgKG11c3QgYmUgZmlyc3QpCiAgY29uc3Qgbm9ybWFsaXplQmFzZWxpbmVUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibm9ybWFsaXplLWJhc2VsaW5lLXRvZ2dsZSIpOwogIGNvbnN0IG5vcm1hbGl6ZUJhc2VsaW5lID0gbm9ybWFsaXplQmFzZWxpbmVUb2dnbGUgPyBub3JtYWxpemVCYXNlbGluZVRvZ2dsZS5jaGVja2VkIDogZmFsc2U7CiAgCiAgLy8gU1RFUCAyOiBDaGVjayBpZiB0cmlwbGljYXRlIGdyb3VwaW5nIGlzIGVuYWJsZWQgKHJlcXVpcmVzIFN0ZXAgMSkKICBjb25zdCBncm91cFRyaXBsaWNhdGVzVG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImdyb3VwLXRyaXBsaWNhdGVzLXRvZ2dsZSIpOwogIGNvbnN0IGdyb3VwVHJpcGxpY2F0ZXMgPSBncm91cFRyaXBsaWNhdGVzVG9nZ2xlID8gZ3JvdXBUcmlwbGljYXRlc1RvZ2dsZS5jaGVja2VkIDogZmFsc2U7CiAgCiAgLy8gRW5mb3JjZSB3b3JrZmxvdzogU3RlcCAyIChncm91cGluZykgcmVxdWlyZXMgU3RlcCAxIChub3JtYWxpemF0aW9uKQogIGlmIChncm91cFRyaXBsaWNhdGVzICYmICFub3JtYWxpemVCYXNlbGluZSkgewogICAgLy8gRGlzYWJsZSBncm91cGluZyBpZiBub3JtYWxpemF0aW9uIGlzIG5vdCBlbmFibGVkCiAgICBpZiAoZ3JvdXBUcmlwbGljYXRlc1RvZ2dsZSkgewogICAgICBncm91cFRyaXBsaWNhdGVzVG9nZ2xlLmNoZWNrZWQgPSBmYWxzZTsKICAgIH0KICAgIGdyb3VwVHJpcGxpY2F0ZXMgPSBmYWxzZTsKICB9CiAgCiAgLy8gU1RFUCAwOiBDaGVjayBpZiBpbmRpdmlkdWFsIHdlbGxzIHNob3VsZCBiZSBzaG93bgogIC8vIFN0ZXAgMCBvbmx5IHNob3dzIHdoZW4gTk8gb3RoZXIgcHJvY2Vzc2luZyBzdGVwcyAoMS0yKSBhcmUgZW5hYmxlZAogIGNvbnN0IHNob3dJbmRpdmlkdWFsV2VsbHNUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic2hvdy1pbmRpdmlkdWFsLXdlbGxzLXRvZ2dsZSIpOwogIGNvbnN0IHN0ZXAwUmVxdWVzdGVkID0gc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZSA/IHNob3dJbmRpdmlkdWFsV2VsbHNUb2dnbGUuY2hlY2tlZCA6IHRydWU7CiAgY29uc3QgYW55UHJvY2Vzc2luZ1N0ZXBFbmFibGVkID0gbm9ybWFsaXplQmFzZWxpbmUgfHwgZ3JvdXBUcmlwbGljYXRlczsKICAvLyBTaG93IFN0ZXAgMCBpZiByZXF1ZXN0ZWQgQU5EIG5vIG90aGVyIHN0ZXBzIGVuYWJsZWQKICAvLyBJZiBubyBzdGVwcyBhcmUgZW5hYmxlZCBhdCBhbGwsIGRlZmF1bHQgdG8gc2hvd2luZyBTdGVwIDAgKHJhdyBkYXRhKSBhcyBmYWxsYmFjawogIGNvbnN0IHNob3dJbmRpdmlkdWFsV2VsbHMgPSAoc3RlcDBSZXF1ZXN0ZWQgJiYgIWFueVByb2Nlc3NpbmdTdGVwRW5hYmxlZCkgfHwgKCFhbnlQcm9jZXNzaW5nU3RlcEVuYWJsZWQpOwogIAogIC8vIFNob3cvaGlkZSBTdGVwIDAgd2FybmluZwogIGNvbnN0IHN0ZXAwV2FybmluZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzdGVwMC13YXJuaW5nIik7CiAgaWYgKHN0ZXAwV2FybmluZykgewogICAgc3RlcDBXYXJuaW5nLnN0eWxlLmRpc3BsYXkgPSAoc3RlcDBSZXF1ZXN0ZWQgJiYgYW55UHJvY2Vzc2luZ1N0ZXBFbmFibGVkKSA/ICJibG9jayIgOiAibm9uZSI7CiAgfQogIAogIC8vIERpc2FibGUgU3RlcCAwIGNoZWNrYm94IGlmIG90aGVyIHN0ZXBzICgxLTIpIGFyZSBlbmFibGVkICh2aXN1YWwgZmVlZGJhY2spCiAgaWYgKHNob3dJbmRpdmlkdWFsV2VsbHNUb2dnbGUpIHsKICAgIHNob3dJbmRpdmlkdWFsV2VsbHNUb2dnbGUuZGlzYWJsZWQgPSBhbnlQcm9jZXNzaW5nU3RlcEVuYWJsZWQ7CiAgfQogIAogIC8vIEdldCBub3JtYWxpemF0aW9uIGJhc2VsaW5lIHBhcmFtZXRlcnMKICBjb25zdCBub3JtYWxpemVCYXNlbGluZUVuZElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm5vcm1hbGl6ZS1iYXNlbGluZS1lbmQtdGltZSIpOwogIGNvbnN0IG5vcm1hbGl6ZUJhc2VsaW5lRW5kVGltZSA9IG5vcm1hbGl6ZUJhc2VsaW5lRW5kSW5wdXQgPyBwYXJzZUZsb2F0KG5vcm1hbGl6ZUJhc2VsaW5lRW5kSW5wdXQudmFsdWUpIHx8IDI0IDogMjQ7CiAgCiAgLy8gR2V0IGJhc2VsaW5lIGZpdHRpbmcgbWV0aG9kIGFuZCBwYXJhbWV0ZXJzCiAgY29uc3QgYmFzZWxpbmVNZXRob2RTZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtbWV0aG9kLXNlbGVjdCIpOwogIGNvbnN0IGJhc2VsaW5lTWV0aG9kID0gYmFzZWxpbmVNZXRob2RTZWxlY3QgPyBiYXNlbGluZU1ldGhvZFNlbGVjdC52YWx1ZSA6ICJsb3dlc3MiOwogIGNvbnN0IGJhc2VsaW5lRnJhY0lucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJhc2VsaW5lLWZyYWMtaW5wdXQiKTsKICBjb25zdCBiYXNlbGluZUZyYWMgPSBiYXNlbGluZUZyYWNJbnB1dCA/IHBhcnNlRmxvYXQoYmFzZWxpbmVGcmFjSW5wdXQudmFsdWUpIHx8IDAuNSA6IDAuNTsKICBjb25zdCBiYXNlbGluZVBvbHlPcmRlcklucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJhc2VsaW5lLXBvbHktb3JkZXItaW5wdXQiKTsKICBjb25zdCBiYXNlbGluZVBvbHlPcmRlciA9IGJhc2VsaW5lUG9seU9yZGVySW5wdXQgPyBwYXJzZUludChiYXNlbGluZVBvbHlPcmRlcklucHV0LnZhbHVlKSB8fCAxIDogMTsKICAKICAvLyBHZXQgbm9ybWFsaXphdGlvbiBtb2RlCiAgY29uc3Qgbm9ybWFsaXphdGlvbk1vZGVTZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibm9ybWFsaXphdGlvbi1tb2RlLXNlbGVjdCIpOwogIGNvbnN0IG5vcm1hbGl6YXRpb25Nb2RlID0gbm9ybWFsaXphdGlvbk1vZGVTZWxlY3QgPyBub3JtYWxpemF0aW9uTW9kZVNlbGVjdC52YWx1ZSA6ICJkZWx0YV9mX292ZXJfZiI7CiAgCiAgLy8gU2hvdy9oaWRlIG5vcm1hbGl6YXRpb24gYmFzZWxpbmUgcGFyYW1ldGVycwogIGNvbnN0IG5vcm1hbGl6ZUJhc2VsaW5lUGFyYW1ldGVyc0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJub3JtYWxpemUtYmFzZWxpbmUtcGFyYW1ldGVycyIpOwogIGlmIChub3JtYWxpemVCYXNlbGluZVBhcmFtZXRlcnNEaXYgJiYgbm9ybWFsaXplQmFzZWxpbmVUb2dnbGUpIHsKICAgIG5vcm1hbGl6ZUJhc2VsaW5lUGFyYW1ldGVyc0Rpdi5zdHlsZS5kaXNwbGF5ID0gbm9ybWFsaXplQmFzZWxpbmUgPyAiYmxvY2siIDogIm5vbmUiOwogIH0KICAKICAvLyBTVEVQIDM6IENoZWNrIGlmIGN1dG9mZiBpcyBlbmFibGVkCiAgY29uc3QgY3V0b2ZmQmFzZWxpbmVUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3V0b2ZmLWJhc2VsaW5lLXRvZ2dsZSIpOwogIGNvbnN0IGN1dG9mZkJhc2VsaW5lID0gY3V0b2ZmQmFzZWxpbmVUb2dnbGUgPyBjdXRvZmZCYXNlbGluZVRvZ2dsZS5jaGVja2VkIDogZmFsc2U7CiAgY29uc3QgY3V0b2ZmQmFzZWxpbmVUaW1lSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3V0b2ZmLWJhc2VsaW5lLXRpbWUiKTsKICBjb25zdCBjdXRvZmZCYXNlbGluZVRpbWUgPSBjdXRvZmZCYXNlbGluZVRpbWVJbnB1dCA/IHBhcnNlRmxvYXQoY3V0b2ZmQmFzZWxpbmVUaW1lSW5wdXQudmFsdWUpIHx8IDM2MCA6IDM2MDsKICAKICAvLyBTaG93L2hpZGUgY3V0b2ZmIHBhcmFtZXRlcnMKICBjb25zdCBjdXRvZmZCYXNlbGluZVBhcmFtZXRlcnNEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3V0b2ZmLWJhc2VsaW5lLXBhcmFtZXRlcnMiKTsKICBpZiAoY3V0b2ZmQmFzZWxpbmVQYXJhbWV0ZXJzRGl2ICYmIGN1dG9mZkJhc2VsaW5lVG9nZ2xlKSB7CiAgICBjdXRvZmZCYXNlbGluZVBhcmFtZXRlcnNEaXYuc3R5bGUuZGlzcGxheSA9IGN1dG9mZkJhc2VsaW5lID8gImJsb2NrIiA6ICJub25lIjsKICB9CiAgCiAgLy8gU1RFUCA0OiBDaGVjayBpZiByZWdyZXNzaW9uIGlzIGVuYWJsZWQKICBjb25zdCBmaXRSZWdyZXNzaW9uVG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZpdC1yZWdyZXNzaW9uLXRvZ2dsZSIpOwogIGNvbnN0IGZpdFJlZ3Jlc3Npb24gPSBmaXRSZWdyZXNzaW9uVG9nZ2xlID8gZml0UmVncmVzc2lvblRvZ2dsZS5jaGVja2VkIDogZmFsc2U7CiAgY29uc3QgcmVncmVzc2lvblR5cGVTZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi10eXBlLXNlbGVjdCIpOwogIGNvbnN0IHJlZ3Jlc3Npb25UeXBlID0gcmVncmVzc2lvblR5cGVTZWxlY3QgPyByZWdyZXNzaW9uVHlwZVNlbGVjdC52YWx1ZSA6ICJtb25vLWV4cG9uZW50aWFsIjsKICBjb25zdCBwb2x5bm9taWFsT3JkZXJJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwb2x5bm9taWFsLW9yZGVyLWlucHV0Iik7CiAgY29uc3QgcG9seW5vbWlhbE9yZGVyID0gcG9seW5vbWlhbE9yZGVySW5wdXQgPyBwYXJzZUludChwb2x5bm9taWFsT3JkZXJJbnB1dC52YWx1ZSkgfHwgMiA6IDI7CiAgCiAgLy8gU2hvdy9oaWRlIHJlZ3Jlc3Npb24gcGFyYW1ldGVycwogIGNvbnN0IGZpdFJlZ3Jlc3Npb25QYXJhbWV0ZXJzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZpdC1yZWdyZXNzaW9uLXBhcmFtZXRlcnMiKTsKICBpZiAoZml0UmVncmVzc2lvblBhcmFtZXRlcnNEaXYgJiYgZml0UmVncmVzc2lvblRvZ2dsZSkgewogICAgZml0UmVncmVzc2lvblBhcmFtZXRlcnNEaXYuc3R5bGUuZGlzcGxheSA9IGZpdFJlZ3Jlc3Npb24gPyAiYmxvY2siIDogIm5vbmUiOwogIH0KICAKICAvLyBVcGRhdGUgcmVncmVzc2lvbiB0eXBlIHBhcmFtcyB0byBzaG93L2hpZGUgaW5mbyBwYW5lbCB3aGVuIHJlZ3Jlc3Npb24gaXMgdG9nZ2xlZAogIGlmIChmaXRSZWdyZXNzaW9uKSB7CiAgICB1cGRhdGVSZWdyZXNzaW9uVHlwZVBhcmFtcyh0cnVlKTsgLy8gU2tpcCBjaGFydCB1cGRhdGUgc2luY2Ugd2UncmUgYWxyZWFkeSB1cGRhdGluZwogIH0gZWxzZSB7CiAgICAvLyBIaWRlIGluZm8gcGFuZWwgd2hlbiByZWdyZXNzaW9uIGlzIGRpc2FibGVkCiAgICBjb25zdCBpbmZvUGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi1pbmZvLXBhbmVsIik7CiAgICBpZiAoaW5mb1BhbmVsKSB7CiAgICAgIGluZm9QYW5lbC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgfQogIH0KCiAgaWYgKHNlbGVjdGVkV2VsbHMuc2l6ZSA9PT0gMCkgewogICAgLy8gQ2xlYXIgdGhlIGNoYXJ0IGlmIG5vIHdlbGxzIHNlbGVjdGVkCiAgICAvLyBEZXRlcm1pbmUgeS1heGlzIGxhYmVsIGJhc2VkIG9uIHByb2Nlc3Npbmcgc3RlcHMKICAgIGxldCB5QXhpc0xhYmVsID0gIkZsdW9yZXNjZW5jZSAoRkkpIjsKICAgIGlmIChub3JtYWxpemVCYXNlbGluZSkgewogICAgICBpZiAobm9ybWFsaXphdGlvbk1vZGUgPT09ICdkZWx0YV9mX292ZXJfZicpIHsKICAgICAgICB5QXhpc0xhYmVsID0gIs6URi9GIChOb3JtYWxpemVkKSI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgeUF4aXNMYWJlbCA9ICJGL0bigoAgKE5vcm1hbGl6ZWQpIjsKICAgICAgfQogICAgfQogICAgaWYgKGNoYXJ0KSB7CiAgICAgIC8vIFRyYW5zZm9ybSBleGlzdGluZyBjaGFydAogICAgICBjaGFydC5kYXRhLmRhdGFzZXRzID0gW107CiAgICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLngudGl0bGUudGV4dCA9ICJUaW1lIChzKSI7CiAgICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLnkudGl0bGUudGV4dCA9IHlBeGlzTGFiZWw7CiAgICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLnkubWluID0gdW5kZWZpbmVkOwogICAgICBjaGFydC5vcHRpb25zLnBsdWdpbnMudGl0bGUudGV4dCA9ICJTZWxlY3Qgd2VsbHMgdG8gZGlzcGxheSBkYXRhIjsKICAgICAgY2hhcnQudXBkYXRlKCdub25lJyk7IC8vIFVwZGF0ZSB3aXRob3V0IGFuaW1hdGlvbgogICAgfSBlbHNlIHsKICAgICAgLy8gQ3JlYXRlIG5ldyBjaGFydCBvbmx5IGlmIGl0IGRvZXNuJ3QgZXhpc3QKICAgICAgY2hhcnQgPSBuZXcgQ2hhcnQoY3R4LCB7CiAgICAgICAgdHlwZTogImxpbmUiLAogICAgICAgIGRhdGE6IHsgZGF0YXNldHM6IFtdIH0sCiAgICAgICAgb3B0aW9uczogewogICAgICAgICAgcmVzcG9uc2l2ZTogdHJ1ZSwKICAgICAgICAgIG1haW50YWluQXNwZWN0UmF0aW86IGZhbHNlLAogICAgICAgICAgc2NhbGVzOiB7CiAgICAgICAgICAgIHg6IHsgCiAgICAgICAgICAgICAgdHlwZTogImxpbmVhciIsIAogICAgICAgICAgICAgIHRpdGxlOiB7IGRpc3BsYXk6IHRydWUsIHRleHQ6ICJUaW1lIChzKSIgfSAKICAgICAgICAgICAgfSwKICAgICAgICAgICAgeTogeyAKICAgICAgICAgICAgICB0aXRsZTogeyBkaXNwbGF5OiB0cnVlLCB0ZXh0OiB5QXhpc0xhYmVsIH0sCiAgICAgICAgICAgICAgbWluOiB1bmRlZmluZWQKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIHBsdWdpbnM6IHsKICAgICAgICAgICAgbGVnZW5kOiB7IGRpc3BsYXk6IGZhbHNlIH0sCiAgICAgICAgICAgIHRpdGxlOiB7IGRpc3BsYXk6IHRydWUsIHRleHQ6ICJTZWxlY3Qgd2VsbHMgdG8gZGlzcGxheSBkYXRhIiB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIHJldHVybjsKICB9CgogIGNvbnN0IGRhdGFzZXRzID0gW107CiAgY29uc3QgY29sb3JzID0gWwogICAgInJnYmEoNTQsIDE2MiwgMjM1LCAxLjApIiwKICAgICJyZ2JhKDI1NSwgOTksIDEzMiwgMS4wKSIsCiAgICAicmdiYSgyNTUsIDIwNiwgODYsIDEuMCkiLAogICAgInJnYmEoNzUsIDE5MiwgMTkyLCAxLjApIiwKICAgICJyZ2JhKDE1MywgMTAyLCAyNTUsIDEuMCkiLAogICAgInJnYmEoMjU1LCAxNTksIDY0LCAxLjApIiwKICAgICJyZ2JhKDE5OSwgMTk5LCAxOTksIDEuMCkiLAogICAgInJnYmEoODMsIDEwMiwgMjU1LCAxLjApIgogIF07CiAgCiAgbGV0IGNvbG9ySWR4ID0gMDsKICAKICAvLyBTVEVQIDA6IEFkZCBpbmRpdmlkdWFsIHdlbGxzIChyYXcgZGF0YSwgYmVmb3JlIGFueSBwcm9jZXNzaW5nKSBpZiBlbmFibGVkCiAgaWYgKHNob3dJbmRpdmlkdWFsV2VsbHMpIHsKICAgIEFycmF5LmZyb20oc2VsZWN0ZWRXZWxscykuZm9yRWFjaChrZXkgPT4gewogICAgICBjb25zdCBbcGxhdGVJZCwgd2VsbElkXSA9IGtleS5zcGxpdCgiOiIpOwogICAgICBjb25zdCBjb2x1bW4gPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAgIAogICAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZENvbHVtbnMgaWYgYW55IGFyZSBzZXQKICAgICAgaWYgKGVuYWJsZWRDb2x1bW5zLnNpemUgPiAwICYmICFlbmFibGVkQ29sdW1ucy5oYXMoY29sdW1uKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAKICAgICAgLy8gRmlsdGVyIGJ5IGVuYWJsZWRXZWxscyBpZiBhbnkgYXJlIHNldAogICAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgICAgIGlmIChlbmFibGVkV2VsbHMuc2l6ZSA+IDAgJiYgIWVuYWJsZWRXZWxscy5oYXMod2VsbElkKSAmJiAhZW5hYmxlZFdlbGxzLmhhcyhub3JtYWxpemVkV2VsbElkKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAKICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICAgIGNvbnN0IHdlbGxEYXRhID0gd2VsbHNbbm9ybWFsaXplZFdlbGxJZF0gfHwgd2VsbHNbd2VsbElkXTsKICAgICAgaWYgKHdlbGxEYXRhKSB7CiAgICAgICAgY29uc3QgcGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gcGxhdGVJZCk7CiAgICAgICAgY29uc3QgZmlsZW5hbWUgPSBwbGF0ZSA/IChwbGF0ZS5maWxlIHx8IHBsYXRlLmlkKSA6IHBsYXRlSWQ7CiAgICAgICAgY29uc3QgY29uZmlnID0gdmlld2VyRGF0YS5jb25maWcgfHwge307CiAgICAgICAgY29uc3Qgd2VsbExhYmVscyA9IGNvbmZpZy53ZWxsX2xhYmVscyB8fCB7fTsKICAgICAgICBjb25zdCByb3dMZXR0ZXIgPSBnZXRSb3dMZXR0ZXIod2VsbElkKTsKICAgICAgICBjb25zdCBpc0NvbnRyb2wgPSBpc0NvbnRyb2xXZWxsKHdlbGxJZCk7CiAgICAgICAgY29uc3QgbGFiZWwgPSB3ZWxsTGFiZWxzW3Jvd0xldHRlcl0gfHwgd2VsbERhdGEubGFiZWwgfHwgd2VsbERhdGEuY29udGVudCB8fCBgV2VsbCAke3dlbGxJZH1gOwogICAgICAgIGNvbnN0IGZvcm1hdHRlZExhYmVsID0gZm9ybWF0TGFiZWwobGFiZWwpOwogICAgICAgIAogICAgICAgIC8vIFVzZSByYXcgZGF0YSAobm90IHByb2Nlc3NlZCkgZm9yIFN0ZXAgMAogICAgICAgIGNvbnN0IGNvbG9yID0gY29sb3JzW2NvbG9ySWR4ICUlIGNvbG9ycy5sZW5ndGhdOwogICAgICAgIGNvbG9ySWR4Kys7CiAgICAgICAgCiAgICAgICAgLy8gQWRkICJDb250cm9sIiBzdWZmaXggZm9yIGNvbnRyb2wgd2VsbHMKICAgICAgICBjb25zdCBkaXNwbGF5TGFiZWwgPSBpc0NvbnRyb2wgCiAgICAgICAgICA/IGAke3dlbGxJZH0gLSAke2Zvcm1hdHRlZExhYmVsfSBDb250cm9sIENvbCAke2NvbHVtbn1gCiAgICAgICAgICA6IGAke3dlbGxJZH0gLSAke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59YDsKICAgICAgICAKICAgICAgICBkYXRhc2V0cy5wdXNoKHsKICAgICAgICAgIGxhYmVsOiBkaXNwbGF5TGFiZWwsCiAgICAgICAgICBkYXRhOiB3ZWxsRGF0YS50aW1lX3MubWFwKCh0LCBpKSA9PiAoeyB4OiB0LCB5OiB3ZWxsRGF0YS52YWx1ZXNbaV0gfSkpLmZpbHRlcihkID0+IGQueSAhPT0gbnVsbCAmJiBkLnggIT09IG51bGwpLAogICAgICAgICAgYm9yZGVyQ29sb3I6IGNvbG9yLnJlcGxhY2UoIjEuMCIsICIwLjUiKSwgLy8gTGlnaHRlciBjb2xvciBmb3IgcmF3IGRhdGEKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogInRyYW5zcGFyZW50IiwKICAgICAgICAgIHRlbnNpb246IDAuMTUsCiAgICAgICAgICBwb2ludFJhZGl1czogMS41LAogICAgICAgICAgYm9yZGVyV2lkdGg6IDEsCiAgICAgICAgICBib3JkZXJEYXNoOiBbMywgM10sIC8vIERhc2hlZCBsaW5lIGZvciByYXcgZGF0YQogICAgICAgICAgZmlsbDogZmFsc2UKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfQogIAoKICAvLyBHcm91cCBzZWxlY3RlZCB3ZWxscyBieSB0cmlwbGljYXRlIGdyb3VwIG9yIGluZGl2aWR1YWwgd2VsbAogIGNvbnN0IGdyb3VwZWRTZWxlY3Rpb25zID0ge307CiAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICAKICAvLyBncm91cFRyaXBsaWNhdGVzIGFscmVhZHkgZGVmaW5lZCBhYm92ZQogIAogIC8vIEZpcnN0IHBhc3M6IGlkZW50aWZ5IGFsbCB0cmlwbGljYXRlIGdyb3VwcyBmcm9tIHNlbGVjdGVkIHdlbGxzCiAgLy8gT25seSBncm91cCBpbnRvIHRyaXBsaWNhdGVzIGlmIFN0ZXAgMiBpcyBlbmFibGVkCiAgY29uc3QgdHJpcGxpY2F0ZUdyb3Vwc0ZvdW5kID0gbmV3IE1hcCgpOyAvLyBncm91cEtleSAtPiB7IG5hbWUsIGNvbHVtbiwgd2VsbHM6IFNldCBvZiB3ZWxsSWRzIH0KICAKICBBcnJheS5mcm9tKHNlbGVjdGVkV2VsbHMpLmZvckVhY2goa2V5ID0+IHsKICAgIGNvbnN0IFtwbGF0ZUlkLCB3ZWxsSWRdID0ga2V5LnNwbGl0KCI6Iik7CiAgICBjb25zdCBjb2x1bW4gPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAKICAgIC8vIEZpbHRlciBieSBlbmFibGVkQ29sdW1ucyBpZiBhbnkgYXJlIHNldAogICAgaWYgKGVuYWJsZWRDb2x1bW5zLnNpemUgPiAwICYmICFlbmFibGVkQ29sdW1ucy5oYXMoY29sdW1uKSkgewogICAgICByZXR1cm47IC8vIFNraXAgd2VsbHMgZnJvbSBkaXNhYmxlZCBjb2x1bW5zCiAgICB9CiAgICAKICAgIC8vIEZpbHRlciBieSBlbmFibGVkV2VsbHMgaWYgYW55IGFyZSBzZXQgKGV4Y2x1ZGUgd2VsbHMpCiAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCkgJiYgIWVuYWJsZWRXZWxscy5oYXMobm9ybWFsaXplZFdlbGxJZCkpIHsKICAgICAgcmV0dXJuOyAvLyBTa2lwIGV4Y2x1ZGVkIHdlbGxzCiAgICB9CiAgICAKICAgIGNvbnN0IGlzQ29udHJvbCA9IGlzQ29udHJvbFdlbGwod2VsbElkKTsKICAgIAogICAgLy8gQ29udHJvbHMgYXJlIGFsd2F5cyBoYW5kbGVkIGFzIGluZGl2aWR1YWwgd2VsbHMgKG5vIGdyb3VwaW5nKQogICAgaWYgKGlzQ29udHJvbCkgewogICAgICByZXR1cm47IC8vIFNraXAgY29udHJvbHMgLSB0aGV5J2xsIGJlIGhhbmRsZWQgYXMgaW5kaXZpZHVhbCB3ZWxscyBpbiB0aGUgdGhpcmQgcGFzcwogICAgfQogICAgCiAgICAvLyBTVEVQIDI6IE9ubHkgZ3JvdXAgaW50byB0cmlwbGljYXRlcyBpZiBncm91cGluZyBpcyBlbmFibGVkCiAgICBpZiAoZ3JvdXBUcmlwbGljYXRlcykgewogICAgICBjb25zdCB0cmlwbGljYXRlR3JvdXAgPSBnZXRUcmlwbGljYXRlR3JvdXAod2VsbElkLCBjb2x1bW4pOwogICAgICBpZiAodHJpcGxpY2F0ZUdyb3VwKSB7CiAgICAgICAgLy8gQ3JlYXRlIGdyb3VwIGtleSB0aGF0IGluY2x1ZGVzIGNvbHVtbiB0byBzZXBhcmF0ZSBzYW1lIHBhdHRlcm4gYWNyb3NzIGNvbHVtbnMKICAgICAgICBjb25zdCBncm91cEtleSA9IGAke3RyaXBsaWNhdGVHcm91cC5uYW1lfV9jb2wke2NvbHVtbn1gOwogICAgICAgIGlmICghdHJpcGxpY2F0ZUdyb3Vwc0ZvdW5kLmhhcyhncm91cEtleSkpIHsKICAgICAgICAgIC8vIEdldCByb3cgbGV0dGVycyBmcm9tIHRoZSB0cmlwbGljYXRlIGdyb3VwIHBhdHRlcm4KICAgICAgICAgIGNvbnN0IGdyb3VwUm93TGV0dGVycyA9IGdldFJvd0xldHRlcnNGcm9tV2VsbHModHJpcGxpY2F0ZUdyb3VwLndlbGxzKTsKICAgICAgICAgIC8vIENyZWF0ZSB3ZWxsIElEcyBmb3IgdGhpcyBjb2x1bW4gdXNpbmcgdGhlIHJvdyBwYXR0ZXJuCiAgICAgICAgICBjb25zdCB3ZWxsSWRzRm9yQ29sdW1uID0gZ3JvdXBSb3dMZXR0ZXJzLm1hcChyb3cgPT4gcm93ICsgY29sdW1uKTsKICAgICAgICAgIAogICAgICAgICAgdHJpcGxpY2F0ZUdyb3Vwc0ZvdW5kLnNldChncm91cEtleSwgewogICAgICAgICAgICBuYW1lOiB0cmlwbGljYXRlR3JvdXAubmFtZSwKICAgICAgICAgICAgY29sdW1uOiBjb2x1bW4sCiAgICAgICAgICAgIHdlbGxJZHM6IG5ldyBTZXQod2VsbElkc0ZvckNvbHVtbikKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLy8gSWYgZ3JvdXBpbmcgaXMgZGlzYWJsZWQsIHdlbGxzIHdpbGwgYmUgaGFuZGxlZCBhcyBpbmRpdmlkdWFsIHdlbGxzIGluIHRoZSB0aGlyZCBwYXNzCiAgfSk7CiAgCiAgLy8gU2Vjb25kIHBhc3M6IGJ1aWxkIGdyb3VwZWQgc2VsZWN0aW9ucyBmb3IgdHJpcGxpY2F0ZSBncm91cHMKICB0cmlwbGljYXRlR3JvdXBzRm91bmQuZm9yRWFjaCgoZ3JvdXBJbmZvLCBncm91cEtleSkgPT4gewogICAgZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldID0gewogICAgICB0eXBlOiAidHJpcGxpY2F0ZSIsCiAgICAgIHdlbGxzOiBbXSwKICAgICAgbmFtZTogZ3JvdXBJbmZvLm5hbWUKICAgIH07CiAgICAKICAgIC8vIENvbGxlY3Qgd2VsbHMgZnJvbSBkYXRhc2V0cyB0aGF0IGhhdmUgc2VsZWN0ZWQgd2VsbHMgaW4gdGhpcyB0cmlwbGljYXRlIGdyb3VwCiAgICBBcnJheS5mcm9tKHNlbGVjdGVkV2VsbHMpLmZvckVhY2goa2V5ID0+IHsKICAgICAgY29uc3QgW3BsYXRlSWQsIHdlbGxJZF0gPSBrZXkuc3BsaXQoIjoiKTsKICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7CiAgICAgIC8vIENoZWNrIGlmIHRoaXMgd2VsbCBpcyBpbiB0aGUgZ3JvdXAgKHVzaW5nIG5vcm1hbGl6ZWQgSUQpCiAgICAgIGNvbnN0IG5vcm1hbGl6ZWRXZWxsSWRzRm9yQ29sdW1uID0gQXJyYXkuZnJvbShncm91cEluZm8ud2VsbElkcykubWFwKHcgPT4gbm9ybWFsaXplV2VsbElkKHcpKTsKICAgICAgaWYgKG5vcm1hbGl6ZWRXZWxsSWRzRm9yQ29sdW1uLmluY2x1ZGVzKG5vcm1hbGl6ZWRXZWxsSWQpICYmIGNvbHVtbiA9PT0gZ3JvdXBJbmZvLmNvbHVtbikgewogICAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICAgIGNvbnN0IHdlbGxEYXRhID0gd2VsbHNbbm9ybWFsaXplZFdlbGxJZF0gfHwgd2VsbHNbd2VsbElkXTsKICAgICAgICBpZiAod2VsbERhdGEpIHsKICAgICAgICAgIC8vIENoZWNrIGlmIGFscmVhZHkgYWRkZWQKICAgICAgICAgIGNvbnN0IGV4aXN0cyA9IGdyb3VwZWRTZWxlY3Rpb25zW2dyb3VwS2V5XS53ZWxscy5zb21lKAogICAgICAgICAgICB3ID0+IHcud2VsbElkID09PSB3ZWxsSWQgJiYgdy5wbGF0ZUlkID09PSBwbGF0ZUlkCiAgICAgICAgICApOwogICAgICAgICAgaWYgKCFleGlzdHMpIHsKICAgICAgICAgICAgLy8gU1RFUCAxOiBBcHBseSBub3JtYWxpemF0aW9uIHVzaW5nIGZpdHRlZCBiYXNlbGluZSBpZiBlbmFibGVkIChtdXN0IGhhcHBlbiBiZWZvcmUgZ3JvdXBpbmcpCiAgICAgICAgICAgIGxldCBwcm9jZXNzZWRXZWxsRGF0YSA9IHdlbGxEYXRhOwogICAgICAgICAgICBpZiAobm9ybWFsaXplQmFzZWxpbmUpIHsKICAgICAgICAgICAgICBwcm9jZXNzZWRXZWxsRGF0YSA9IG5vcm1hbGl6ZVdpdGhGaXR0ZWRCYXNlbGluZSgKICAgICAgICAgICAgICAgIHByb2Nlc3NlZFdlbGxEYXRhLAogICAgICAgICAgICAgICAgbm9ybWFsaXplQmFzZWxpbmVFbmRUaW1lLAogICAgICAgICAgICAgICAgYmFzZWxpbmVNZXRob2QsCiAgICAgICAgICAgICAgICBiYXNlbGluZUZyYWMsCiAgICAgICAgICAgICAgICBiYXNlbGluZVBvbHlPcmRlciwKICAgICAgICAgICAgICAgIG5vcm1hbGl6YXRpb25Nb2RlCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoIXByb2Nlc3NlZFdlbGxEYXRhKSByZXR1cm47IC8vIFNraXAgaWYgbm9ybWFsaXphdGlvbiBmYWlsZWQKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBBZGQgdG8gZ3JvdXAgKFN0ZXAgMiBoYXBwZW5zIGhlcmUgLSBncm91cGluZykKICAgICAgICAgICAgLy8gU3RlcCAzIChhdmVyYWdpbmcpIHdpbGwgYmUgYXBwbGllZCBsYXRlcgogICAgICAgICAgICBncm91cGVkU2VsZWN0aW9uc1tncm91cEtleV0ud2VsbHMucHVzaCh7CiAgICAgICAgICAgICAgd2VsbElkOiB3ZWxsSWQsCiAgICAgICAgICAgICAgcGxhdGVJZDogcGxhdGVJZCwKICAgICAgICAgICAgICBkYXRhOiBwcm9jZXNzZWRXZWxsRGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0pOwogIAogIC8vIFRoaXJkIHBhc3M6IGhhbmRsZSBpbmRpdmlkdWFsIHdlbGxzIChza2lwIGlmIGFscmVhZHkgaW4gdHJpcGxpY2F0ZSBncm91cCkKICBBcnJheS5mcm9tKHNlbGVjdGVkV2VsbHMpLmZvckVhY2goa2V5ID0+IHsKICAgIC8vIFZlcmlmeSB0aGlzIHdlbGwgaXMgc3RpbGwgc2VsZWN0ZWQgKG1heSBoYXZlIGJlZW4gZGVzZWxlY3RlZCkKICAgIGlmICghc2VsZWN0ZWRXZWxscy5oYXMoa2V5KSkgewogICAgICByZXR1cm47IC8vIFNraXAgd2VsbHMgdGhhdCBhcmUgbm8gbG9uZ2VyIHNlbGVjdGVkCiAgICB9CiAgICAKICAgIGNvbnN0IFtwbGF0ZUlkLCB3ZWxsSWRdID0ga2V5LnNwbGl0KCI6Iik7CiAgICBjb25zdCBjb2x1bW4gPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICBjb25zdCBpc0NvbnRyb2wgPSBpc0NvbnRyb2xXZWxsKHdlbGxJZCk7CiAgICAKICAgIC8vIENvbnRyb2xzIGFyZSBhbHdheXMgaGFuZGxlZCBhcyBpbmRpdmlkdWFsIHdlbGxzIChubyBncm91cGluZykKICAgIGlmIChpc0NvbnRyb2wpIHsKICAgICAgLy8gQ29udGludWUgdG8gcHJvY2VzcyBhcyBpbmRpdmlkdWFsIHdlbGwKICAgIH0gZWxzZSB7CiAgICAgIC8vIFNURVAgMjogQ2hlY2sgaWYgdGhpcyB3ZWxsIGlzIHBhcnQgb2YgYSB0cmlwbGljYXRlIGdyb3VwIHdlJ3ZlIGFscmVhZHkgcHJvY2Vzc2VkCiAgICAgIC8vIE9ubHkgc2tpcCBpZiBncm91cGluZyBpcyBlbmFibGVkIGFuZCB0aGlzIHdlbGwgd2FzIGdyb3VwZWQKICAgICAgaWYgKGdyb3VwVHJpcGxpY2F0ZXMpIHsKICAgICAgICBjb25zdCB0cmlwbGljYXRlR3JvdXAgPSBnZXRUcmlwbGljYXRlR3JvdXAod2VsbElkLCBjb2x1bW4pOwogICAgICAgIGlmICh0cmlwbGljYXRlR3JvdXApIHsKICAgICAgICAgIC8vIEFscmVhZHkgaGFuZGxlZCBpbiB0cmlwbGljYXRlR3JvdXBzRm91bmQgLSBza2lwCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAKICAgIC8vIEZpbHRlciBieSBlbmFibGVkV2VsbHMgaWYgYW55IGFyZSBzZXQKICAgIGNvbnN0IG5vcm1hbGl6ZWRXZWxsSWQgPSBub3JtYWxpemVXZWxsSWQod2VsbElkKTsKICAgIGlmIChlbmFibGVkV2VsbHMuc2l6ZSA+IDAgJiYgIWVuYWJsZWRXZWxscy5oYXMod2VsbElkKSAmJiAhZW5hYmxlZFdlbGxzLmhhcyhub3JtYWxpemVkV2VsbElkKSkgewogICAgICByZXR1cm47IC8vIFNraXAgZXhjbHVkZWQgd2VsbHMKICAgIH0KICAgIAogICAgLy8gSW5kaXZpZHVhbCB3ZWxsIChub3QgcGFydCBvZiBhIHRyaXBsaWNhdGUgZ3JvdXApCiAgICBjb25zdCBncm91cEtleSA9IGB3ZWxsXyR7d2VsbElkfWA7CiAgICBpZiAoIWdyb3VwZWRTZWxlY3Rpb25zW2dyb3VwS2V5XSkgewogICAgICBjb25zdCBjb25maWcgPSB2aWV3ZXJEYXRhLmNvbmZpZyB8fCB7fTsKICAgICAgY29uc3Qgd2VsbExhYmVscyA9IGNvbmZpZy53ZWxsX2xhYmVscyB8fCB7fTsKICAgICAgLy8gR2V0IGxhYmVsIGZyb20gcm93LWJhc2VkIGNvbmZpZyBvciB3ZWxsIGRhdGEKICAgICAgY29uc3Qgcm93TGV0dGVyID0gZ2V0Um93TGV0dGVyKHdlbGxJZCk7CiAgICAgIGxldCBsYWJlbCA9IHdlbGxMYWJlbHNbcm93TGV0dGVyXTsKICAgICAgaWYgKCFsYWJlbCkgewogICAgICAgIGZvciAoY29uc3QgcElkIG9mIHNlbGVjdGVkRGF0YXNldHMpIHsKICAgICAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BJZF0gfHwge307CiAgICAgICAgICBjb25zdCB3ZWxsRGF0YSA9IHdlbGxzW25vcm1hbGl6ZWRXZWxsSWRdIHx8IHdlbGxzW3dlbGxJZF07CiAgICAgICAgICBpZiAod2VsbERhdGEpIHsKICAgICAgICAgICAgbGFiZWwgPSB3ZWxsRGF0YS5sYWJlbCB8fCB3ZWxsRGF0YS5jb250ZW50IHx8IGBXZWxsICR7d2VsbElkfWA7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBncm91cGVkU2VsZWN0aW9uc1tncm91cEtleV0gPSB7CiAgICAgICAgdHlwZTogInNpbmdsZSIsCiAgICAgICAgd2VsbHM6IFtdLAogICAgICAgIGxhYmVsOiBmb3JtYXRMYWJlbChsYWJlbCkgfHwgYFdlbGwgJHt3ZWxsSWR9YAogICAgICB9OwogICAgfQogICAgCiAgICAvLyBBZGQgdGhpcyB3ZWxsJ3MgZGF0YSBpZiBpdCBleGlzdHMKICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgY29uc3Qgd2VsbERhdGEgPSB3ZWxsc1tub3JtYWxpemVkV2VsbElkXSB8fCB3ZWxsc1t3ZWxsSWRdOwogICAgaWYgKHdlbGxEYXRhKSB7CiAgICAgIGNvbnN0IGV4aXN0aW5nID0gZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldLndlbGxzLmZpbmQodyA9PiB3LndlbGxJZCA9PT0gd2VsbElkICYmIHcucGxhdGVJZCA9PT0gcGxhdGVJZCk7CiAgICAgIGlmICghZXhpc3RpbmcpIHsKICAgICAgICAgIC8vIFNURVAgMTogQXBwbHkgbm9ybWFsaXphdGlvbiB1c2luZyBmaXR0ZWQgYmFzZWxpbmUgaWYgZW5hYmxlZCAobXVzdCBoYXBwZW4gYmVmb3JlIGdyb3VwaW5nKQogICAgICAgICAgbGV0IHByb2Nlc3NlZFdlbGxEYXRhID0gd2VsbERhdGE7CiAgICAgICAgICBpZiAobm9ybWFsaXplQmFzZWxpbmUpIHsKICAgICAgICAgICAgcHJvY2Vzc2VkV2VsbERhdGEgPSBub3JtYWxpemVXaXRoRml0dGVkQmFzZWxpbmUoCiAgICAgICAgICAgICAgcHJvY2Vzc2VkV2VsbERhdGEsCiAgICAgICAgICAgICAgbm9ybWFsaXplQmFzZWxpbmVFbmRUaW1lLAogICAgICAgICAgICAgIGJhc2VsaW5lTWV0aG9kLAogICAgICAgICAgICAgIGJhc2VsaW5lRnJhYywKICAgICAgICAgICAgICBiYXNlbGluZVBvbHlPcmRlciwKICAgICAgICAgICAgICBub3JtYWxpemF0aW9uTW9kZQogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoIXByb2Nlc3NlZFdlbGxEYXRhKSByZXR1cm47IC8vIFNraXAgaWYgbm9ybWFsaXphdGlvbiBmYWlsZWQKICAgICAgICAgIH0KICAgICAgICAgIC8vIFNURVAgNDogQXBwbHkgbm9ybWFsaXphdGlvbiB1c2luZyBmaXR0ZWQgYmFzZWxpbmUgaWYgZW5hYmxlZAogICAgICAgICAgaWYgKG5vcm1hbGl6ZUJhc2VsaW5lKSB7CiAgICAgICAgICAgIHByb2Nlc3NlZFdlbGxEYXRhID0gbm9ybWFsaXplV2l0aEZpdHRlZEJhc2VsaW5lKAogICAgICAgICAgICAgIHByb2Nlc3NlZFdlbGxEYXRhLAogICAgICAgICAgICAgIG5vcm1hbGl6ZUJhc2VsaW5lRW5kVGltZSwKICAgICAgICAgICAgICBiYXNlbGluZU1ldGhvZCwKICAgICAgICAgICAgICBiYXNlbGluZUZyYWMsCiAgICAgICAgICAgICAgYmFzZWxpbmVQb2x5T3JkZXIsCiAgICAgICAgICAgICAgbm9ybWFsaXphdGlvbk1vZGUKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKCFwcm9jZXNzZWRXZWxsRGF0YSkgcmV0dXJuOyAvLyBTa2lwIGlmIG5vcm1hbGl6YXRpb24gZmFpbGVkCiAgICAgICAgICB9CiAgICAgICAgICAvLyBBZGQgdG8gZ3JvdXAgKFN0ZXAgMiBoYXBwZW5zIGhlcmUgLSBncm91cGluZykKICAgICAgICAgIC8vIFN0ZXAgMyAoYXZlcmFnaW5nKSB3aWxsIGJlIGFwcGxpZWQgbGF0ZXIKICAgICAgICAgIGdyb3VwZWRTZWxlY3Rpb25zW2dyb3VwS2V5XS53ZWxscy5wdXNoKHsKICAgICAgICAgIHdlbGxJZCwgCiAgICAgICAgICBwbGF0ZUlkLCAKICAgICAgICAgIGRhdGE6IHByb2Nlc3NlZFdlbGxEYXRhCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9KTsKICAKICAvLyBDb250aW51ZSB3aXRoIGdyb3VwZWQgc2VsZWN0aW9ucyAoY29sb3JJZHggYWxyZWFkeSBpbml0aWFsaXplZCBmb3IgU3RlcCAwKQogIC8vIFByb2Nlc3MgZ3JvdXBlZCBzZWxlY3Rpb25zIHdoZW46CiAgLy8gMS4gU3RlcCAwIGlzIG5vdCBzaG93aW5nIChiZWNhdXNlIG90aGVyIHN0ZXBzIGFyZSBlbmFibGVkKSwgT1IKICAvLyAyLiBQcm9jZXNzaW5nIHN0ZXBzIGFyZSBlbmFibGVkICh3aGljaCBhdXRvbWF0aWNhbGx5IGRpc2FibGVzIFN0ZXAgMCkKICAvLyBUaGlzIGVuc3VyZXMgZGF0YSBhbHdheXMgc2hvd3MgLSBlaXRoZXIgU3RlcCAwIGluZGl2aWR1YWwgd2VsbHMgT1IgZ3JvdXBlZCBzZWxlY3Rpb25zCiAgaWYgKCFzaG93SW5kaXZpZHVhbFdlbGxzKSB7CiAgICBPYmplY3Qua2V5cyhncm91cGVkU2VsZWN0aW9ucykuZm9yRWFjaChncm91cEtleSA9PiB7CiAgICAgIGNvbnN0IGdyb3VwID0gZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldOwogICAgICAKICAgICAgLy8gRmlsdGVyIG91dCBhbnkgd2VsbHMgdGhhdCBhcmUgbm8gbG9uZ2VyIHNlbGVjdGVkIG9yIGFyZSBleGNsdWRlZAogICAgICBncm91cC53ZWxscyA9IGdyb3VwLndlbGxzLmZpbHRlcih3ID0+IHsKICAgICAgICBjb25zdCBrZXkgPSBgJHt3LnBsYXRlSWR9OiR7dy53ZWxsSWR9YDsKICAgICAgICAvLyBDaGVjayBpZiBzdGlsbCBzZWxlY3RlZAogICAgICAgIGlmICghc2VsZWN0ZWRXZWxscy5oYXMoa2V5KSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICAvLyBDaGVjayBpZiBleGNsdWRlZCB2aWEgZW5hYmxlZFdlbGxzCiAgICAgICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3LndlbGxJZCkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgICAKICAgICAgLy8gU2tpcCBncm91cHMgd2l0aCBubyB3ZWxscyBhZnRlciBmaWx0ZXJpbmcKICAgICAgaWYgKGdyb3VwLndlbGxzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybjsgLy8gU2tpcCB0byBuZXh0IGdyb3VwCiAgICAgIH0KICAgICAgCiAgICAgIGNvbnN0IGNvbG9yID0gY29sb3JzW2NvbG9ySWR4ICUlIGNvbG9ycy5sZW5ndGhdOwogICAgICBjb2xvcklkeCsrOwoKICAgIGlmIChncm91cC50eXBlID09PSAidHJpcGxpY2F0ZSIgJiYgZ3JvdXAud2VsbHMubGVuZ3RoID4gMCkgewogICAgICAvLyBTVEVQIDM6IEF2ZXJhZ2Ugd2l0aGluIHRyaXBsaWNhdGUgZ3JvdXAKICAgICAgY29uc3QgcmVzdWx0ID0gcHJvY2Vzc1dlbGxzQW5kQ2FsY3VsYXRlTWVhbigKICAgICAgICBncm91cC53ZWxscy5tYXAodyA9PiB3LmRhdGEpLAogICAgICAgIGZhbHNlLCAvLyBObyBub3JtYWxpemF0aW9uCiAgICAgICAgMCwgLy8gYmFzZWxpbmVFbmRUaW1lIG5vdCB1c2VkCiAgICAgICAgOTk5OTk5IC8vIGN1dG9mZlRpbWUgbm90IHVzZWQKICAgICAgKTsKICAgICAgY29uc3QgdGltZVBvaW50cyA9IHJlc3VsdC5maWx0ZXJlZFRpbWVQb2ludHM7CiAgICAgIGNvbnN0IG1lYW5zID0gcmVzdWx0Lm5vcm1hbGl6ZWRNZWFuczsKICAgICAgY29uc3QgZXJyb3JzID0gcmVzdWx0Lm5vcm1hbGl6ZWRFcnJvcnM7CiAgICAgIAogICAgICAvLyBDcmVhdGUgZGF0YXNldCB3aXRoIG1lYW4gYW5kIGVycm9yIGluZm9ybWF0aW9uCiAgICAgIGNvbnN0IGxpbmVEYXRhID0gdGltZVBvaW50cy5tYXAoKHQsIGkpID0+IHsKICAgICAgICBjb25zdCBwb2ludCA9IHsKICAgICAgICAgIHg6IHQsCiAgICAgICAgICB5OiBtZWFuc1tpXSwKICAgICAgICAgIGVycm9yOiBlcnJvcnNbaV0KICAgICAgICB9OwogICAgICAgIHJldHVybiBwb2ludDsKICAgICAgfSkuZmlsdGVyKGQgPT4gZC55ICE9PSBudWxsKTsKICAgICAgCiAgICAgIC8vIEdldCBncm91cCBuYW1lIGZyb20gZmlyc3Qgd2VsbCdzIHBsYXRlCiAgICAgIGNvbnN0IGZpcnN0UGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gZ3JvdXAud2VsbHNbMF0ucGxhdGVJZCk7CiAgICAgIGNvbnN0IGNvbHVtbkdyb3VwTmFtZSA9IGZpcnN0UGxhdGUgPyBmaXJzdFBsYXRlLmNvbHVtbl9ncm91cCA6ICIiOwogICAgICBjb25zdCBkYXRhc2V0Q291bnQgPSBuZXcgU2V0KGdyb3VwLndlbGxzLm1hcCh3ID0+IHcucGxhdGVJZCkpLnNpemU7CiAgICAgIGNvbnN0IHdlbGxDb3VudCA9IGdyb3VwLndlbGxzLmxlbmd0aDsKICAgICAgCiAgICAgIC8vIENyZWF0ZSBhcHByb3ByaWF0ZSBsYWJlbCBiYXNlZCBvbiBudW1iZXIgb2YgcmVwbGljYXRlcwogICAgICBsZXQgcmVwbGljYXRlTGFiZWwgPSAiIjsKICAgICAgaWYgKHdlbGxDb3VudCA9PT0gMykgewogICAgICAgIHJlcGxpY2F0ZUxhYmVsID0gInRyaXBsaWNhdGUiOwogICAgICB9IGVsc2UgaWYgKHdlbGxDb3VudCA9PT0gNikgewogICAgICAgIHJlcGxpY2F0ZUxhYmVsID0gImhleHBsaWNhdGUiOwogICAgICB9IGVsc2UgaWYgKHdlbGxDb3VudCA9PT0gOSkgewogICAgICAgIHJlcGxpY2F0ZUxhYmVsID0gIm5vbnVwbGljYXRlIjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXBsaWNhdGVMYWJlbCA9IGAke3dlbGxDb3VudH0tcGxpY2F0ZWA7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIEdldCBjb2x1bW4gbnVtYmVyIGZyb20gZmlyc3Qgd2VsbAogICAgICBjb25zdCBmaXJzdFdlbGxJZCA9IGdyb3VwLndlbGxzWzBdLndlbGxJZDsKICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZChmaXJzdFdlbGxJZCk7CiAgICAgIAogICAgICAvLyBBZGQgd2VsbCBJRHMgd2hlbiBTdGVwIDEgKG5vcm1hbGl6YXRpb24pIGlzIGVuYWJsZWQKICAgICAgbGV0IHdlbGxJZHNQcmVmaXggPSAiIjsKICAgICAgaWYgKG5vcm1hbGl6ZUJhc2VsaW5lICYmIGdyb3VwLndlbGxzLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCB3ZWxsSWRzID0gZ3JvdXAud2VsbHMubWFwKHcgPT4gdy53ZWxsSWQpLmpvaW4oIiwgIik7CiAgICAgICAgd2VsbElkc1ByZWZpeCA9IGAke3dlbGxJZHN9IC0gYDsKICAgICAgfQogICAgICAKICAgICAgY29uc3QgbGFiZWxTdWZmaXggPSBkYXRhc2V0Q291bnQgPiAxIAogICAgICAgID8gYCAoJHtyZXBsaWNhdGVMYWJlbH0sICR7ZGF0YXNldENvdW50fSBkYXRhc2V0cywgbWVhbiDCsSBTRSlgIAogICAgICAgIDogYCAoJHtyZXBsaWNhdGVMYWJlbH0sIG1lYW4gwrEgU0UpYDsKICAgICAgY29uc3QgZm9ybWF0dGVkTmFtZSA9IGZvcm1hdExhYmVsKGdyb3VwLm5hbWUpOwogICAgICBjb25zdCBsYWJlbCA9IGNvbHVtbkdyb3VwTmFtZSAKICAgICAgICA/IGAke3dlbGxJZHNQcmVmaXh9JHtmb3JtYXR0ZWROYW1lfSAoJHtjb2x1bW5Hcm91cE5hbWV9KSBDb2wgJHtjb2x1bW59JHtsYWJlbFN1ZmZpeH1gCiAgICAgICAgOiBgJHt3ZWxsSWRzUHJlZml4fSR7Zm9ybWF0dGVkTmFtZX0gQ29sICR7Y29sdW1ufSR7bGFiZWxTdWZmaXh9YDsKICAgICAgCiAgICAgIGRhdGFzZXRzLnB1c2goewogICAgICAgIGxhYmVsOiBsYWJlbCwKICAgICAgICBkYXRhOiBsaW5lRGF0YSwKICAgICAgICBib3JkZXJDb2xvcjogY29sb3IsCiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBjb2xvci5yZXBsYWNlKCIxLjAiLCAiMC4yIiksCiAgICAgICAgdGVuc2lvbjogMC4xNSwKICAgICAgICBwb2ludFJhZGl1czogMywKICAgICAgICBib3JkZXJXaWR0aDogMiwKICAgICAgICBmaWxsOiBmYWxzZQogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoZ3JvdXAudHlwZSA9PT0gInNpbmdsZSIpIHsKICAgICAgLy8gU2luZ2xlIHdlbGwgLSBjaGVjayBpZiBpdCdzIGEgZHVwbGljYXRlCiAgICAgIGNvbnN0IHdlbGxJZCA9IGdyb3VwLndlbGxzWzBdLndlbGxJZDsKICAgICAgY29uc3QgaXNEdXBsaWNhdGUgPSBpc0R1cGxpY2F0ZVdlbGwod2VsbElkKTsKICAgICAgCiAgICAgIGlmIChncm91cC53ZWxscy5sZW5ndGggPiAxICYmIGlzRHVwbGljYXRlKSB7CiAgICAgICAgLy8gRHVwbGljYXRlIHdlbGwgLSBzaG93IGVhY2ggZGF0YXNldCBzZXBhcmF0ZWx5IGZvciBjb21wYXJpc29uCiAgICAgICAgY29uc3QgbGluZVN0eWxlcyA9IFsic29saWQiLCAiZGFzaGVkIiwgImRvdHRlZCJdOwogICAgICAgIGNvbnN0IGZvcm1hdHRlZExhYmVsID0gZm9ybWF0TGFiZWwoZ3JvdXAubGFiZWwpOwogICAgICAgIAogICAgICAgIGdyb3VwLndlbGxzLmZvckVhY2goKHdlbGwsIGlkeCkgPT4gewogICAgICAgICAgY29uc3QgcGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gd2VsbC5wbGF0ZUlkKTsKICAgICAgICAgIGNvbnN0IGZpbGVuYW1lID0gcGxhdGUgPyAocGxhdGUuZmlsZSB8fCBwbGF0ZS5pZCkgOiB3ZWxsLnBsYXRlSWQ7CiAgICAgICAgICBjb25zdCBsaW5lU3R5bGUgPSBsaW5lU3R5bGVzW2lkeCAlJSBsaW5lU3R5bGVzLmxlbmd0aF07CiAgICAgICAgICAKICAgICAgICAgIC8vIFVzZSBzbGlnaHRseSBkaWZmZXJlbnQgc2hhZGVzIG9mIHRoZSBzYW1lIGNvbG9yIGZvciBkdXBsaWNhdGVzCiAgICAgICAgICBjb25zdCBiYXNlQ29sb3IgPSBjb2xvcjsKICAgICAgICAgIGNvbnN0IGFscGhhID0gMS4wIC0gKGlkeCAqIDAuMTUpOyAvLyBTbGlnaHRseSBmYWRlIGVhY2ggc3Vic2VxdWVudCBsaW5lCiAgICAgICAgICBjb25zdCBhZGp1c3RlZENvbG9yID0gYmFzZUNvbG9yLnJlcGxhY2UoIjEuMCIsIGFscGhhLnRvRml4ZWQoMSkpOwogICAgICAgICAgCiAgICAgICAgICBsZXQgdGltZVBvaW50cyA9IHdlbGwuZGF0YS50aW1lX3M7CiAgICAgICAgICBsZXQgdmFsdWVzID0gd2VsbC5kYXRhLnZhbHVlczsKICAgICAgICAgIAogICAgICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsLndlbGxJZCk7CiAgICAgICAgICAvLyBBZGQgd2VsbCBJRCB3aGVuIFN0ZXAgMSAobm9ybWFsaXphdGlvbikgaXMgZW5hYmxlZAogICAgICAgICAgY29uc3Qgd2VsbElkUHJlZml4ID0gbm9ybWFsaXplQmFzZWxpbmUgPyBgJHt3ZWxsLndlbGxJZH0gLSBgIDogIiI7CiAgICAgICAgICBkYXRhc2V0cy5wdXNoKHsKICAgICAgICAgICAgbGFiZWw6IGAke3dlbGxJZFByZWZpeH0ke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59ICgke2ZpbGVuYW1lfSlgLAogICAgICAgICAgICBkYXRhOiB0aW1lUG9pbnRzLm1hcCgodCwgaSkgPT4gewogICAgICAgICAgICAgIGNvbnN0IHBvaW50ID0geyB4OiB0LCB5OiB2YWx1ZXNbaV0gfTsKICAgICAgICAgICAgICByZXR1cm4gcG9pbnQ7CiAgICAgICAgICAgIH0pLmZpbHRlcihkID0+IGQueSAhPT0gbnVsbCksCiAgICAgICAgICAgIGJvcmRlckNvbG9yOiBhZGp1c3RlZENvbG9yLAogICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICAgIGJvcmRlckRhc2g6IGxpbmVTdHlsZSA9PT0gImRhc2hlZCIgPyBbNSwgNV0gOiBsaW5lU3R5bGUgPT09ICJkb3R0ZWQiID8gWzIsIDJdIDogW10sCiAgICAgICAgICAgIHRlbnNpb246IDAuMTUsCiAgICAgICAgICAgIHBvaW50UmFkaXVzOiAyLAogICAgICAgICAgICBib3JkZXJXaWR0aDogMS41LAogICAgICAgICAgICBmaWxsOiBmYWxzZSwKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKGdyb3VwLndlbGxzLmxlbmd0aCA+IDEpIHsKICAgICAgICAvLyBTVEVQIDM6IEF2ZXJhZ2UgbXVsdGlwbGUgZGF0YXNldHMgZm9yIHNhbWUgd2VsbCAobm90IGR1cGxpY2F0ZSkgLSBjYWxjdWxhdGUgbWVhbiBhbmQgZXJyb3IKICAgICAgICBjb25zdCByZXN1bHQgPSBwcm9jZXNzV2VsbHNBbmRDYWxjdWxhdGVNZWFuKAogICAgICAgICAgZ3JvdXAud2VsbHMubWFwKHcgPT4gdy5kYXRhKSwKICAgICAgICAgIGZhbHNlLCAvLyBObyBub3JtYWxpemF0aW9uCiAgICAgICAgICAwLCAvLyBiYXNlbGluZUVuZFRpbWUgbm90IHVzZWQKICAgICAgICAgIDk5OTk5OSAvLyBjdXRvZmZUaW1lIG5vdCB1c2VkCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0aW1lUG9pbnRzID0gcmVzdWx0LmZpbHRlcmVkVGltZVBvaW50czsKICAgICAgICBjb25zdCBtZWFucyA9IHJlc3VsdC5ub3JtYWxpemVkTWVhbnM7CiAgICAgICAgY29uc3QgZXJyb3JzID0gcmVzdWx0Lm5vcm1hbGl6ZWRFcnJvcnM7CiAgICAgICAgCiAgICAgICAgY29uc3QgbGluZURhdGEgPSB0aW1lUG9pbnRzLm1hcCgodCwgaSkgPT4gewogICAgICAgICAgY29uc3QgcG9pbnQgPSB7CiAgICAgICAgICAgIHg6IHQsCiAgICAgICAgICAgIHk6IG1lYW5zW2ldLAogICAgICAgICAgICBlcnJvcjogZXJyb3JzW2ldCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHBvaW50OwogICAgICAgIH0pLmZpbHRlcihkID0+IGQueSAhPT0gbnVsbCk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZGF0YXNldENvdW50ID0gZ3JvdXAud2VsbHMubGVuZ3RoOwogICAgICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgICAgICBjb25zdCBmb3JtYXR0ZWRMYWJlbCA9IGZvcm1hdExhYmVsKGdyb3VwLmxhYmVsKTsKICAgICAgICAvLyBBZGQgd2VsbCBJRCB3aGVuIFN0ZXAgMSAobm9ybWFsaXphdGlvbikgaXMgZW5hYmxlZAogICAgICAgIGNvbnN0IHdlbGxJZFByZWZpeCA9IG5vcm1hbGl6ZUJhc2VsaW5lID8gYCR7d2VsbElkfSAtIGAgOiAiIjsKICAgICAgICBjb25zdCBsYWJlbCA9IGAke3dlbGxJZFByZWZpeH0ke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59ICgke2RhdGFzZXRDb3VudH0gZGF0YXNldHMsIG1lYW4gwrEgU0UpYDsKICAgICAgICAKICAgICAgICBkYXRhc2V0cy5wdXNoKHsKICAgICAgICAgIGxhYmVsOiBsYWJlbCwKICAgICAgICAgIGRhdGE6IGxpbmVEYXRhLAogICAgICAgICAgYm9yZGVyQ29sb3I6IGNvbG9yLAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBjb2xvci5yZXBsYWNlKCIxLjAiLCAiMC4yIiksCiAgICAgICAgICB0ZW5zaW9uOiAwLjE1LAogICAgICAgICAgcG9pbnRSYWRpdXM6IDMsCiAgICAgICAgICBib3JkZXJXaWR0aDogMiwKICAgICAgICAgIGZpbGw6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU2luZ2xlIGRhdGFzZXQgZm9yIHRoaXMgd2VsbAogICAgICAgIC8vIFNraXAgc2hvd2luZyBwcm9jZXNzZWQgaW5kaXZpZHVhbCB3ZWxscyBpZiBTdGVwIDAgaXMgYWxyZWFkeSBzaG93aW5nIHRoZSByYXcgZGF0YQogICAgICAgIC8vIEJ1dCBvbmx5IHNraXAgaWYgU3RlcCAwIGlzIGFjdHVhbGx5IGVuYWJsZWQgKG5vdCBqdXN0IHJlcXVlc3RlZCkKICAgICAgICBpZiAoc2hvd0luZGl2aWR1YWxXZWxscyAmJiAhYW55UHJvY2Vzc2luZ1N0ZXBFbmFibGVkKSB7CiAgICAgICAgICAvLyBTdGVwIDAgYWxyZWFkeSBzaG93cyB0aGlzIHdlbGwsIHNraXAgdGhlIHByb2Nlc3NlZCB2ZXJzaW9uIHRvIGF2b2lkIGR1cGxpY2F0ZXMKICAgICAgICAgIHJldHVybjsgLy8gU2tpcCB0byBuZXh0IGdyb3VwIGluIGZvckVhY2gKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgY29uc3Qgd2VsbCA9IGdyb3VwLndlbGxzWzBdOwogICAgICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbC53ZWxsSWQpOwogICAgICAgIGNvbnN0IGZvcm1hdHRlZExhYmVsID0gZm9ybWF0TGFiZWwoZ3JvdXAubGFiZWwpOwogICAgICAgIAogICAgICAgIGxldCB0aW1lUG9pbnRzID0gd2VsbC5kYXRhLnRpbWVfczsKICAgICAgICBsZXQgdmFsdWVzID0gd2VsbC5kYXRhLnZhbHVlczsKICAgICAgICAKICAgICAgICAvLyBBZGQgd2VsbCBJRCB3aGVuIFN0ZXAgMSAobm9ybWFsaXphdGlvbikgaXMgZW5hYmxlZAogICAgICAgIGNvbnN0IHdlbGxJZFByZWZpeCA9IG5vcm1hbGl6ZUJhc2VsaW5lID8gYCR7d2VsbC53ZWxsSWR9IC0gYCA6ICIiOwogICAgICAgIGNvbnN0IGxhYmVsID0gZm9ybWF0dGVkTGFiZWwgCiAgICAgICAgICA/IGAke3dlbGxJZFByZWZpeH0ke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59YCAKICAgICAgICAgIDogYCR7d2VsbElkUHJlZml4fVdlbGwgJHt3ZWxsLndlbGxJZH0gQ29sICR7Y29sdW1ufWA7CiAgICAgICAgCiAgICAgICAgZGF0YXNldHMucHVzaCh7CiAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICBkYXRhOiB0aW1lUG9pbnRzLm1hcCgodCwgaSkgPT4gewogICAgICAgICAgICBjb25zdCBwb2ludCA9IHsgeDogdCwgeTogdmFsdWVzW2ldIH07CiAgICAgICAgICAgIHJldHVybiBwb2ludDsKICAgICAgICAgIH0pLmZpbHRlcihkID0+IGQueSAhPT0gbnVsbCksCiAgICAgICAgICBib3JkZXJDb2xvcjogY29sb3IsCiAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICB0ZW5zaW9uOiAwLjE1LAogICAgICAgICAgcG9pbnRSYWRpdXM6IDIsCiAgICAgICAgICBib3JkZXJXaWR0aDogMS41LAogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICB9KTsKICB9CgogIC8vIFNURVAgMzogQXBwbHkgY3V0b2ZmIGZpbHRlcmluZyB0byBhbGwgZGF0YXNldHMKICBsZXQgeEF4aXNNaW4gPSB1bmRlZmluZWQ7CiAgbGV0IHhBeGlzTWF4ID0gdW5kZWZpbmVkOwogIAogIGlmIChjdXRvZmZCYXNlbGluZSkgewogICAgZGF0YXNldHMuZm9yRWFjaChkYXRhc2V0ID0+IHsKICAgICAgaWYgKGRhdGFzZXQuZGF0YSAmJiBkYXRhc2V0LmRhdGEubGVuZ3RoID4gMCkgewogICAgICAgIC8vIEZpbmQgZmlyc3QgcmVhbCB0aW1lcG9pbnQgKGZpcnN0IG5vbi1udWxsIHRpbWUpCiAgICAgICAgbGV0IGZpcnN0VGltZXBvaW50ID0gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGFzZXQuZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGRhdGFzZXQuZGF0YVtpXS54ICE9PSBudWxsICYmIGlzRmluaXRlKGRhdGFzZXQuZGF0YVtpXS54KSkgewogICAgICAgICAgICBmaXJzdFRpbWVwb2ludCA9IGRhdGFzZXQuZGF0YVtpXS54OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gRGV0ZXJtaW5lIG1pbmltdW0gdGltZSB0byBpbmNsdWRlCiAgICAgICAgLy8gSWYgbm9ybWFsaXphdGlvbiBpcyBlbmFibGVkLCBleGNsdWRlIGJhc2VsaW5lIHBlcmlvZCAocG9pbnRzIGJlZm9yZSBiYXNlbGluZUVuZFRpbWUpCiAgICAgICAgLy8gT3RoZXJ3aXNlLCBleGNsdWRlIHBvaW50cyBiZWZvcmUgZmlyc3QgcmVhbCB0aW1lcG9pbnQKICAgICAgICBjb25zdCBtaW5UaW1lID0gbm9ybWFsaXplQmFzZWxpbmUgPyBub3JtYWxpemVCYXNlbGluZUVuZFRpbWUgOiAoZmlyc3RUaW1lcG9pbnQgIT09IG51bGwgPyBmaXJzdFRpbWVwb2ludCA6IC1JbmZpbml0eSk7CiAgICAgICAgCiAgICAgICAgLy8gRmlsdGVyIGRhdGEgcG9pbnRzOiBleGNsdWRlIGJlZm9yZSBtaW5UaW1lIGFuZCBhZnRlciBjdXRvZmYgdGltZQogICAgICAgIGRhdGFzZXQuZGF0YSA9IGRhdGFzZXQuZGF0YS5maWx0ZXIocG9pbnQgPT4gewogICAgICAgICAgaWYgKHBvaW50LnggPT09IG51bGwgfHwgIWlzRmluaXRlKHBvaW50LngpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICBpZiAocG9pbnQueCA8IG1pblRpbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgIGlmIChwb2ludC54ID4gY3V0b2ZmQmFzZWxpbmVUaW1lKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICAvLyBUcmFjayBtaW4vbWF4IHggdmFsdWVzIGZvciBheGlzIGFkanVzdG1lbnQKICAgICAgICBpZiAoZGF0YXNldC5kYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IHRpbWVzID0gZGF0YXNldC5kYXRhLm1hcChwID0+IHAueCkuZmlsdGVyKHQgPT4gdCAhPT0gbnVsbCAmJiBpc0Zpbml0ZSh0KSk7CiAgICAgICAgICBpZiAodGltZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBkYXRhc2V0TWluID0gTWF0aC5taW4oLi4udGltZXMpOwogICAgICAgICAgICBjb25zdCBkYXRhc2V0TWF4ID0gTWF0aC5tYXgoLi4udGltZXMpOwogICAgICAgICAgICBpZiAoeEF4aXNNaW4gPT09IHVuZGVmaW5lZCB8fCBkYXRhc2V0TWluIDwgeEF4aXNNaW4pIHsKICAgICAgICAgICAgICB4QXhpc01pbiA9IGRhdGFzZXRNaW47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHhBeGlzTWF4ID09PSB1bmRlZmluZWQgfHwgZGF0YXNldE1heCA+IHhBeGlzTWF4KSB7CiAgICAgICAgICAgICAgeEF4aXNNYXggPSBkYXRhc2V0TWF4OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9IGVsc2UgewogICAgLy8gRXZlbiBpZiBjdXRvZmYgaXMgZGlzYWJsZWQsIGNhbGN1bGF0ZSB4LWF4aXMgcmFuZ2UgZnJvbSBhbGwgZGF0YXNldHMgZm9yIHByb3BlciBkaXNwbGF5CiAgICBkYXRhc2V0cy5mb3JFYWNoKGRhdGFzZXQgPT4gewogICAgICBpZiAoZGF0YXNldC5kYXRhICYmIGRhdGFzZXQuZGF0YS5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3QgdGltZXMgPSBkYXRhc2V0LmRhdGEubWFwKHAgPT4gcC54KS5maWx0ZXIodCA9PiB0ICE9PSBudWxsICYmIGlzRmluaXRlKHQpKTsKICAgICAgICBpZiAodGltZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgY29uc3QgZGF0YXNldE1pbiA9IE1hdGgubWluKC4uLnRpbWVzKTsKICAgICAgICAgIGNvbnN0IGRhdGFzZXRNYXggPSBNYXRoLm1heCguLi50aW1lcyk7CiAgICAgICAgICBpZiAoeEF4aXNNaW4gPT09IHVuZGVmaW5lZCB8fCBkYXRhc2V0TWluIDwgeEF4aXNNaW4pIHsKICAgICAgICAgICAgeEF4aXNNaW4gPSBkYXRhc2V0TWluOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHhBeGlzTWF4ID09PSB1bmRlZmluZWQgfHwgZGF0YXNldE1heCA+IHhBeGlzTWF4KSB7CiAgICAgICAgICAgIHhBeGlzTWF4ID0gZGF0YXNldE1heDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICAKICAvLyBTVEVQIDQ6IEFkZCByZWdyZXNzaW9uIGN1cnZlcyB0byBkYXRhc2V0cwogIGlmIChmaXRSZWdyZXNzaW9uKSB7CiAgICBjb25zdCByZWdyZXNzaW9uRGF0YXNldHMgPSBbXTsKICAgIGNvbnN0IG1vbm9FeHBQYXJhbXMgPSBbXTsgLy8gU3RvcmUgcGFyYW1ldGVycyBmb3IgbW9uby1leHBvbmVudGlhbCBmaXRzCiAgICAKICAgIGRhdGFzZXRzLmZvckVhY2goZGF0YXNldCA9PiB7CiAgICAgIGlmIChkYXRhc2V0LmRhdGEgJiYgZGF0YXNldC5kYXRhLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBkYXRhc2V0IHJlcHJlc2VudHMgYSBjb250cm9sIHdlbGwKICAgICAgICAvLyBFeHRyYWN0IHdlbGxJZCBmcm9tIGxhYmVsIChmb3JtYXQ6ICJOMSAtIExhYmVsIiBvciAiTjEgLSBMYWJlbCBDb250cm9sIENvbCAxIikKICAgICAgICBsZXQgaXNDb250cm9sID0gZmFsc2U7CiAgICAgICAgY29uc3QgbGFiZWwgPSBkYXRhc2V0LmxhYmVsIHx8ICIiOwogICAgICAgIAogICAgICAgIC8vIE1ldGhvZCAxOiBDaGVjayBpZiBsYWJlbCBjb250YWlucyAiQ29udHJvbCIgKGNhc2UtaW5zZW5zaXRpdmUpCiAgICAgICAgaWYgKGxhYmVsLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoImNvbnRyb2wiKSkgewogICAgICAgICAgaXNDb250cm9sID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gTWV0aG9kIDI6IFRyeSB0byBleHRyYWN0IHdlbGxJZCBmcm9tIGxhYmVsIGFuZCBjaGVjawogICAgICAgICAgLy8gTGFiZWwgZm9ybWF0IGlzIHR5cGljYWxseTogIk4xIC0gTGFiZWwgQ29sIDEiIG9yICJOMSAtIExhYmVsIgogICAgICAgICAgY29uc3Qgd2VsbElkTWF0Y2ggPSBsYWJlbC5tYXRjaCgvXihbQS1aXVxkKylccyotLyk7CiAgICAgICAgICBpZiAod2VsbElkTWF0Y2gpIHsKICAgICAgICAgICAgY29uc3Qgd2VsbElkID0gd2VsbElkTWF0Y2hbMV07CiAgICAgICAgICAgIGlzQ29udHJvbCA9IGlzQ29udHJvbFdlbGwod2VsbElkKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gVXNlIGxpbmVhciByZWdyZXNzaW9uIGZvciBjb250cm9scywgb3RoZXJ3aXNlIHVzZSBzZWxlY3RlZCByZWdyZXNzaW9uIHR5cGUKICAgICAgICBjb25zdCByZWdyZXNzaW9uVHlwZVRvVXNlID0gaXNDb250cm9sID8gJ2xpbmVhcicgOiByZWdyZXNzaW9uVHlwZTsKICAgICAgICAKICAgICAgICAvLyBGaXQgcmVncmVzc2lvbiBjdXJ2ZQogICAgICAgIGNvbnN0IGZpdEZ1bmN0aW9uID0gZml0UmVncmVzc2lvbkN1cnZlKGRhdGFzZXQuZGF0YSwgcmVncmVzc2lvblR5cGVUb1VzZSwgcG9seW5vbWlhbE9yZGVyKTsKICAgICAgICBpZiAoZml0RnVuY3Rpb24pIHsKICAgICAgICAgIC8vIEdldCB0aW1lIHJhbmdlIGZyb20gZGF0YQogICAgICAgICAgY29uc3QgdGltZXMgPSBkYXRhc2V0LmRhdGEubWFwKHAgPT4gcC54KS5maWx0ZXIodCA9PiB0ICE9PSBudWxsICYmIGlzRmluaXRlKHQpKTsKICAgICAgICAgIGlmICh0aW1lcy5sZW5ndGggPT09IDApIHJldHVybjsKICAgICAgICAgIAogICAgICAgICAgY29uc3QgbWluVGltZSA9IE1hdGgubWluKC4uLnRpbWVzKTsKICAgICAgICAgIGNvbnN0IG1heFRpbWUgPSBNYXRoLm1heCguLi50aW1lcyk7CiAgICAgICAgICAKICAgICAgICAgIC8vIEdlbmVyYXRlIHJlZ3Jlc3Npb24gY3VydmUgcG9pbnRzCiAgICAgICAgICBjb25zdCBudW1Qb2ludHMgPSAxMDA7CiAgICAgICAgICBjb25zdCByZWdyZXNzaW9uRGF0YSA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gbnVtUG9pbnRzOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdCA9IG1pblRpbWUgKyAobWF4VGltZSAtIG1pblRpbWUpICogKGkgLyBudW1Qb2ludHMpOwogICAgICAgICAgICBjb25zdCB5ID0gZml0RnVuY3Rpb24odCk7CiAgICAgICAgICAgIGlmICh5ICE9PSBudWxsICYmIGlzRmluaXRlKHkpKSB7CiAgICAgICAgICAgICAgcmVncmVzc2lvbkRhdGEucHVzaCh7IHg6IHQsIHk6IHkgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIAogICAgICAgICAgaWYgKHJlZ3Jlc3Npb25EYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIHJlZ3Jlc3Npb24gZGF0YXNldCB3aXRoIHNhbWUgY29sb3IgYnV0IGRpZmZlcmVudCBzdHlsZQogICAgICAgICAgICBjb25zdCByZWdyZXNzaW9uQ29sb3IgPSBkYXRhc2V0LmJvcmRlckNvbG9yIHx8IGRhdGFzZXQuYmFja2dyb3VuZENvbG9yIHx8ICJyZ2JhKDEyOCwgMTI4LCAxMjgsIDEuMCkiOwogICAgICAgICAgICByZWdyZXNzaW9uRGF0YXNldHMucHVzaCh7CiAgICAgICAgICAgICAgbGFiZWw6IGAke2RhdGFzZXQubGFiZWx9ICgke3JlZ3Jlc3Npb25UeXBlVG9Vc2V9IGZpdClgLAogICAgICAgICAgICAgIGRhdGE6IHJlZ3Jlc3Npb25EYXRhLAogICAgICAgICAgICAgIGJvcmRlckNvbG9yOiByZWdyZXNzaW9uQ29sb3IsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgIGJvcmRlcldpZHRoOiAyLAogICAgICAgICAgICAgIGJvcmRlckRhc2g6IFs1LCA1XSwgLy8gRGFzaGVkIGxpbmUgZm9yIHJlZ3Jlc3Npb24KICAgICAgICAgICAgICBwb2ludFJhZGl1czogMCwgLy8gTm8gcG9pbnRzIG9uIHJlZ3Jlc3Npb24gbGluZQogICAgICAgICAgICAgIHRlbnNpb246IDAsCiAgICAgICAgICAgICAgZmlsbDogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdG9yZSBtb25vLWV4cG9uZW50aWFsIHBhcmFtZXRlcnMgZm9yIGluZm8gcGFuZWwKICAgICAgICAgICAgLy8gT25seSBzdG9yZSBpZiB1c2luZyBtb25vLWV4cG9uZW50aWFsIChub3QgZm9yIGNvbnRyb2xzIHdoaWNoIHVzZSBsaW5lYXIpCiAgICAgICAgICAgIGlmIChyZWdyZXNzaW9uVHlwZVRvVXNlID09PSAnbW9uby1leHBvbmVudGlhbCcgJiYgZml0RnVuY3Rpb24ucGFyYW1zKSB7CiAgICAgICAgICAgICAgLy8gUmVtb3ZlIHJlcGxpY2F0ZSBhbmQgZGF0YXNldCBpbmZvIGZyb20gbGFiZWwgZm9yIHJlZ3Jlc3Npb24gbGluZXMKICAgICAgICAgICAgICAvLyBQYXR0ZXJuOiByZW1vdmUgIihYLXBsaWNhdGUsIFkgZGF0YXNldHMsIG1lYW4gwrEgU0UpIiBvciBzaW1pbGFyIHBhdHRlcm5zCiAgICAgICAgICAgICAgbGV0IGNsZWFuTGFiZWwgPSBkYXRhc2V0LmxhYmVsOwogICAgICAgICAgICAgIC8vIFJlbW92ZSBwYXR0ZXJucyBjb250YWluaW5nIHBsaWNhdGUsIGRhdGFzZXRzLCBvciBtZWFuIMKxIFNFIGluIHBhcmVudGhlc2VzCiAgICAgICAgICAgICAgY2xlYW5MYWJlbCA9IGNsZWFuTGFiZWwucmVwbGFjZSgvXHMqXChbXildKig/OnBsaWNhdGV8ZGF0YXNldHN8bWVhblxzKsKxXHMqU0UpW14pXSpcKS9naSwgJycpOwogICAgICAgICAgICAgIC8vIENsZWFuIHVwIGFueSBkb3VibGUgc3BhY2VzIG9yIHRyYWlsaW5nL2xlYWRpbmcgc3BhY2VzCiAgICAgICAgICAgICAgY2xlYW5MYWJlbCA9IGNsZWFuTGFiZWwucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgIG1vbm9FeHBQYXJhbXMucHVzaCh7CiAgICAgICAgICAgICAgICBsYWJlbDogY2xlYW5MYWJlbCwKICAgICAgICAgICAgICAgIHBhcmFtczogZml0RnVuY3Rpb24ucGFyYW1zLAogICAgICAgICAgICAgICAgY29sb3I6IHJlZ3Jlc3Npb25Db2xvciAvLyBVc2UgdGhlIHNhbWUgY29sb3IgYXMgdGhlIHJlZ3Jlc3Npb24gY3VydmUKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICAKICAgIC8vIEFkZCByZWdyZXNzaW9uIGRhdGFzZXRzIHRvIHRoZSBtYWluIGRhdGFzZXRzIGFycmF5CiAgICBkYXRhc2V0cy5wdXNoKC4uLnJlZ3Jlc3Npb25EYXRhc2V0cyk7CiAgICAKICAgIC8vIFVwZGF0ZSBpbmZvIHBhbmVsIGZvciBtb25vLWV4cG9uZW50aWFsCiAgICBpZiAocmVncmVzc2lvblR5cGUgPT09ICdtb25vLWV4cG9uZW50aWFsJykgewogICAgICB1cGRhdGVNb25vRXhwb25lbnRpYWxJbmZvUGFuZWwobW9ub0V4cFBhcmFtcyk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBpbmZvUGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi1pbmZvLXBhbmVsIik7CiAgICAgIGlmIChpbmZvUGFuZWwpIHsKICAgICAgICBpbmZvUGFuZWwuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgfQogICAgfQogICAgCiAgICAvLyBSZWNhbGN1bGF0ZSB4LWF4aXMgcmFuZ2UgdG8gaW5jbHVkZSByZWdyZXNzaW9uIGN1cnZlcwogICAgaWYgKGN1dG9mZkJhc2VsaW5lKSB7CiAgICAgIGRhdGFzZXRzLmZvckVhY2goZGF0YXNldCA9PiB7CiAgICAgICAgaWYgKGRhdGFzZXQuZGF0YSAmJiBkYXRhc2V0LmRhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgY29uc3QgdGltZXMgPSBkYXRhc2V0LmRhdGEubWFwKHAgPT4gcC54KS5maWx0ZXIodCA9PiB0ICE9PSBudWxsICYmIGlzRmluaXRlKHQpKTsKICAgICAgICAgIGlmICh0aW1lcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGFzZXRNaW4gPSBNYXRoLm1pbiguLi50aW1lcyk7CiAgICAgICAgICAgIGNvbnN0IGRhdGFzZXRNYXggPSBNYXRoLm1heCguLi50aW1lcyk7CiAgICAgICAgICAgIGlmICh4QXhpc01pbiA9PT0gdW5kZWZpbmVkIHx8IGRhdGFzZXRNaW4gPCB4QXhpc01pbikgewogICAgICAgICAgICAgIHhBeGlzTWluID0gZGF0YXNldE1pbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoeEF4aXNNYXggPT09IHVuZGVmaW5lZCB8fCBkYXRhc2V0TWF4ID4geEF4aXNNYXgpIHsKICAgICAgICAgICAgICB4QXhpc01heCA9IGRhdGFzZXRNYXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KCiAgLy8gRGV0ZXJtaW5lIHktYXhpcyBsYWJlbCBiYXNlZCBvbiBwcm9jZXNzaW5nIHN0ZXBzCiAgbGV0IHlBeGlzTGFiZWwgPSAiRmx1b3Jlc2NlbmNlIChGSSkiOwogIGlmIChub3JtYWxpemVCYXNlbGluZSkgewogICAgaWYgKG5vcm1hbGl6YXRpb25Nb2RlID09PSAnZGVsdGFfZl9vdmVyX2YnKSB7CiAgICAgIHlBeGlzTGFiZWwgPSAizpRGL0YgKE5vcm1hbGl6ZWQpIjsKICAgIH0gZWxzZSB7CiAgICAgIHlBeGlzTGFiZWwgPSAiRi9G4oKAIChOb3JtYWxpemVkKSI7CiAgICB9CiAgfQoKICAvLyBUcmFuc2Zvcm0gZXhpc3RpbmcgY2hhcnQgaW5zdGVhZCBvZiByZWNyZWF0aW5nCiAgaWYgKGNoYXJ0KSB7CiAgICAvLyBDbGVhciBleGlzdGluZyBkYXRhc2V0cwogICAgd2hpbGUgKGNoYXJ0LmRhdGEuZGF0YXNldHMubGVuZ3RoID4gMCkgewogICAgICBjaGFydC5kYXRhLmRhdGFzZXRzLnBvcCgpOwogICAgfQogICAgCiAgICAvLyBBZGQgbmV3IGRhdGFzZXRzCiAgICBkYXRhc2V0cy5mb3JFYWNoKGRhdGFzZXQgPT4gewogICAgICBjaGFydC5kYXRhLmRhdGFzZXRzLnB1c2goZGF0YXNldCk7CiAgICB9KTsKICAgIAogICAgLy8gVXBkYXRlIGNoYXJ0IG9wdGlvbnMKICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLngudGl0bGUudGV4dCA9ICJUaW1lIChzKSI7CiAgICBjaGFydC5vcHRpb25zLnNjYWxlcy55LnRpdGxlLnRleHQgPSB5QXhpc0xhYmVsOwogICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueS5taW4gPSB1bmRlZmluZWQ7CiAgICAKICAgIC8vIEFkanVzdCB4LWF4aXMgcmFuZ2UgYmFzZWQgb24gZmlsdGVyZWQgZGF0YSAoU3RlcCAzKQogICAgaWYgKGN1dG9mZkJhc2VsaW5lICYmIHhBeGlzTWluICE9PSB1bmRlZmluZWQgJiYgeEF4aXNNYXggIT09IHVuZGVmaW5lZCkgewogICAgICAvLyBBZGQgc21hbGwgcGFkZGluZyAoMiUlIG9mIHJhbmdlKSBmb3IgYmV0dGVyIHZpc3VhbGl6YXRpb24KICAgICAgY29uc3QgcGFkZGluZyA9ICh4QXhpc01heCAtIHhBeGlzTWluKSAqIDAuMDI7CiAgICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLngubWluID0gTWF0aC5tYXgoMCwgeEF4aXNNaW4gLSBwYWRkaW5nKTsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueC5tYXggPSB4QXhpc01heCArIHBhZGRpbmc7CiAgICB9IGVsc2UgewogICAgICAvLyBSZXNldCB0byBhdXRvIGlmIGN1dG9mZiBpcyBkaXNhYmxlZAogICAgICBjaGFydC5vcHRpb25zLnNjYWxlcy54Lm1pbiA9IHVuZGVmaW5lZDsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueC5tYXggPSB1bmRlZmluZWQ7CiAgICB9CiAgICAKICAgIC8vIENvdW50IG9ubHkgd2VsbHMgdGhhdCBhcmUgYWN0dWFsbHkgZGlzcGxheWVkIChhY2NvdW50aW5nIGZvciBleGNsdXNpb25zKQogICAgLy8gQ291bnQgdW5pcXVlIHdlbGwgZ3JvdXBzL2RhdGFzZXRzIHRoYXQgYXJlIGFjdHVhbGx5IGRpc3BsYXllZAogICAgY29uc3QgZGlzcGxheWVkV2VsbENvdW50ID0gZGF0YXNldHMubGVuZ3RoOwogICAgY2hhcnQub3B0aW9ucy5wbHVnaW5zLnRpdGxlLnRleHQgPSBgVGltZSBDb3Vyc2UgLSAke2Rpc3BsYXllZFdlbGxDb3VudH0gd2VsbChzKSBzZWxlY3RlZGA7CiAgICBjaGFydC5vcHRpb25zLnBsdWdpbnMubGVnZW5kLmRpc3BsYXkgPSBkYXRhc2V0cy5sZW5ndGggPiAwOwogICAgCiAgICAvLyBGb3JjZSBDaGFydC5qcyB0byB1cGRhdGUgLSB1c2UgdXBkYXRlKCkgd2l0aG91dCBtb2RlIHRvIGVuc3VyZSBwcm9wZXIgcmVkcmF3CiAgICBjaGFydC51cGRhdGUoKTsKICB9IGVsc2UgewogICAgLy8gQ3JlYXRlIG5ldyBjaGFydCBvbmx5IGlmIGl0IGRvZXNuJ3QgZXhpc3QKICAgIGNoYXJ0ID0gbmV3IENoYXJ0KGN0eCwgewogICAgICB0eXBlOiAibGluZSIsCiAgICAgIGRhdGE6IHsKICAgICAgICBkYXRhc2V0czogZGF0YXNldHMKICAgICAgfSwKICAgICAgb3B0aW9uczogewogICAgICAgIHJlc3BvbnNpdmU6IHRydWUsCiAgICAgICAgbWFpbnRhaW5Bc3BlY3RSYXRpbzogZmFsc2UsCiAgICAgICAgcGFyc2luZzogZmFsc2UsCiAgICAgICAgc2NhbGVzOiB7CiAgICAgICAgICAgIHg6IHsgCiAgICAgICAgICAgICAgdHlwZTogImxpbmVhciIsIAogICAgICAgICAgICAgIHRpdGxlOiB7IAogICAgICAgICAgICAgICAgZGlzcGxheTogdHJ1ZSwKICAgICAgICAgICAgICAgIHRleHQ6ICJUaW1lIChzKSIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG1pbjogY3V0b2ZmQmFzZWxpbmUgJiYgeEF4aXNNaW4gIT09IHVuZGVmaW5lZCA/IE1hdGgubWF4KDAsIHhBeGlzTWluIC0gKHhBeGlzTWF4IC0geEF4aXNNaW4pICogMC4wMikgOiB1bmRlZmluZWQsCiAgICAgICAgICAgICAgbWF4OiBjdXRvZmZCYXNlbGluZSAmJiB4QXhpc01heCAhPT0gdW5kZWZpbmVkID8geEF4aXNNYXggKyAoeEF4aXNNYXggLSB4QXhpc01pbikgKiAwLjAyIDogdW5kZWZpbmVkCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHk6IHsgCiAgICAgICAgICAgICAgdGl0bGU6IHsgCiAgICAgICAgICAgICAgICBkaXNwbGF5OiB0cnVlLAogICAgICAgICAgICAgICAgdGV4dDogeUF4aXNMYWJlbAogICAgICAgICAgICB9LAogICAgICAgICAgICBtaW46IHVuZGVmaW5lZAogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcGx1Z2luczogewogICAgICAgICAgbGVnZW5kOiB7CiAgICAgICAgICAgIGRpc3BsYXk6IGRhdGFzZXRzLmxlbmd0aCA+IDAsIC8vIFNob3cgbGVnZW5kIHdoZW4gdGhlcmUgYXJlIGRhdGFzZXRzCiAgICAgICAgICAgIHBvc2l0aW9uOiAidG9wIiwKICAgICAgICAgICAgb25DbGljazogbnVsbCwKICAgICAgICAgICAgbGFiZWxzOiB7CiAgICAgICAgICAgICAgdXNlUG9pbnRTdHlsZTogdHJ1ZSwKICAgICAgICAgICAgICBwYWRkaW5nOiAxNSwKICAgICAgICAgICAgICBmb250OiB7CiAgICAgICAgICAgICAgICBzaXplOiAxMQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZ2VuZXJhdGVMYWJlbHM6IGZ1bmN0aW9uKGNoYXJ0KSB7CiAgICAgICAgICAgICAgICAvLyBDdXN0b20gbGFiZWwgZ2VuZXJhdGlvbiB0byBzaG93IGNvbG9yIGFuZCB3ZWxsIG5hbWUgY2xlYXJseQogICAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWwgPSBDaGFydC5kZWZhdWx0cy5wbHVnaW5zLmxlZ2VuZC5sYWJlbHMuZ2VuZXJhdGVMYWJlbHM7CiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbHMgPSBvcmlnaW5hbC5jYWxsKHRoaXMsIGNoYXJ0KTsKICAgICAgICAgICAgICAgIC8vIExhYmVscyBhbHJlYWR5IGhhdmUgdGhlIGNvcnJlY3QgdGV4dCBmcm9tIGRhdGFzZXQubGFiZWwKICAgICAgICAgICAgICAgIHJldHVybiBsYWJlbHM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgdGl0bGU6IHsKICAgICAgICAgICAgZGlzcGxheTogdHJ1ZSwKICAgICAgICAgICAgdGV4dDogYFRpbWUgQ291cnNlIC0gJHtkYXRhc2V0cy5sZW5ndGh9IHdlbGwocykgc2VsZWN0ZWRgCiAgICAgICAgICB9LAogICAgICAgICAgdG9vbHRpcDogewogICAgICAgICAgICBjYWxsYmFja3M6IHsKICAgICAgICAgICAgICBsYWJlbDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgICAgbGV0IGxhYmVsID0gY29udGV4dC5kYXRhc2V0LmxhYmVsIHx8ICIiOwogICAgICAgICAgICAgICAgaWYgKGxhYmVsKSB7CiAgICAgICAgICAgICAgICAgIGxhYmVsICs9ICI6ICI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY29udGV4dC5wYXJzZWQueSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsYWJlbCArPSBjb250ZXh0LnBhcnNlZC55LnRvRml4ZWQoMik7CiAgICAgICAgICAgICAgICAgIC8vIFNob3cgZXJyb3IgaWYgYXZhaWxhYmxlCiAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0LnJhdyAmJiBjb250ZXh0LnJhdy5lcnJvciAhPT0gdW5kZWZpbmVkICYmIGNvbnRleHQucmF3LmVycm9yICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbGFiZWwgKz0gIiDCsSAiICsgY29udGV4dC5yYXcuZXJyb3IudG9GaXhlZCgyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGxhYmVsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQp9CgovLyBJbml0aWFsaXplIHNldHRpbmdzIGRpc3BsYXkgb24gcGFnZSBsb2FkCnVwZGF0ZUN1cnJlbnRTZXR0aW5nc0Rpc3BsYXkoKTsKLy8gSW5pdGlhbGl6ZSBiYXNlbGluZSBtZXRob2QgcGFyYW1zIHRvIHNob3cvaGlkZSBMT1dFU1MvcG9seW5vbWlhbCBwYXJhbWV0ZXJzIGJhc2VkIG9uIGRlZmF1bHQgc2VsZWN0aW9uCnVwZGF0ZUJhc2VsaW5lTWV0aG9kUGFyYW1zKCk7Ci8vIEluaXRpYWxpemUgcmVncmVzc2lvbiB0eXBlIHBhcmFtcyB0byBzaG93L2hpZGUgaW5mbyBwYW5lbCBiYXNlZCBvbiBkZWZhdWx0IHNlbGVjdGlvbgovLyBTa2lwIGNoYXJ0IHVwZGF0ZSBkdXJpbmcgaW5pdGlhbGl6YXRpb24KdXBkYXRlUmVncmVzc2lvblR5cGVQYXJhbXModHJ1ZSk7Cgpsb2FkRGF0YSgpLmNhdGNoKGVyciA9PiB7CiAgY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIGxvYWQgdmlld2VyX2RhdGEuanNvbjoiLCBlcnIpOwogIGFsZXJ0KCJDb3VsZCBub3QgbG9hZCB2aWV3ZXJfZGF0YS5qc29uLiBEaWQgeW91IHJ1biB0aGUgUHl0aG9uIHNjcmlwdCBpbiB0aGUgc2FtZSBmb2xkZXI/Iik7Cn0pOwo8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+CiIiIgoKCmRlZiB3cml0ZV9odG1sKGh0bWxfcGF0aDogc3RyKToKICAgIGh0bWwgPSBIVE1MX1RFTVBMQVRFICUgewogICAgICAgICJyb3dzIjogUExBVEVfUk9XUywKICAgICAgICAiY29scyI6IFBMQVRFX0NPTFMsCiAgICB9CiAgICB3aXRoIG9wZW4oaHRtbF9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZi53cml0ZShodG1sKQoKCmRlZiB3cml0ZV93ZWJfY29tbWFuZChzY3JpcHRfZGlyOiBzdHIsIHdlYl9kaXI6IHN0cik6CiAgICAiIiIKICAgIENyZWF0ZSBhIGRvdWJsZS1jbGlja2FibGUgJ3dlYi5jb21tYW5kJyBmaWxlIGluIHRoZSBtYWluIGZvbGRlci4KICAgIE9uIG1hY09TLCAuY29tbWFuZCBmaWxlcyBjYW4gYmUgZG91YmxlLWNsaWNrZWQgdG8gcnVuIGluIFRlcm1pbmFsLgogICAgIiIiCiAgICB3ZWJfY29tbWFuZF9wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJ3ZWIuY29tbWFuZCIpCiAgICAKICAgIHdlYl9jb21tYW5kX2NvbnRlbnQgPSBmIiIiIyEvYmluL2Jhc2gKIyBEb3VibGUtY2xpY2thYmxlIHdlYiBzZXJ2ZXIgbGF1bmNoZXIgZm9yIFBsYXRlIFZpZXdlcgojIFRoaXMgZmlsZSBpcyBhdXRvLWdlbmVyYXRlZCBieSBwbGF0ZV92aWV3ZXIucHkKClBPUlQ9ODAwMAojIEdldCB0aGUgZGlyZWN0b3J5IHdoZXJlIHRoaXMgc2NyaXB0IGlzIGxvY2F0ZWQKU0NSSVBUX0RJUj0iJChjZCAiJChkaXJuYW1lICIkMCIpIiAmJiBwd2QpIgpXRUJfRElSPSIkU0NSSVBUX0RJUi93ZWIiCgojIENoYW5nZSB0byB3ZWIgZGlyZWN0b3J5CmNkICIkV0VCX0RJUiIgfHwge3sKICAgIGVjaG8gIkVycm9yOiBDb3VsZCBub3QgZmluZCB3ZWIgZGlyZWN0b3J5OiAkV0VCX0RJUiIKICAgIGVjaG8gIlBsZWFzZSBydW4gcGxhdGVfdmlld2VyLnB5IGZpcnN0IHRvIGdlbmVyYXRlIHRoZSB3ZWIgZmlsZXMuIgogICAgcmVhZCAtcCAiUHJlc3MgRW50ZXIgdG8gZXhpdC4uLiIKICAgIGV4aXQgMQp9fQoKIyBDaGVjayBpZiB2aWV3ZXJfZGF0YS5qc29uIGV4aXN0cwppZiBbICEgLWYgInZpZXdlcl9kYXRhLmpzb24iIF07IHRoZW4KICAgIGVjaG8gIldhcm5pbmc6IHZpZXdlcl9kYXRhLmpzb24gbm90IGZvdW5kISIKICAgIGVjaG8gIlBsZWFzZSBydW4gcGxhdGVfdmlld2VyLnB5IGZpcnN0IHRvIGdlbmVyYXRlIHRoZSBkYXRhIGZpbGVzLiIKICAgIGVjaG8gIiIKZmkKClVSTD0iaHR0cDovL2xvY2FsaG9zdDoke3tQT1JUfX0vaW5kZXguaHRtbCIKCmVjaG8gIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKZWNobyAiUGxhdGUgVmlld2VyIFdlYiBTZXJ2ZXIiCmVjaG8gIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKZWNobyAiU2VydmVyIHJ1bm5pbmcgYXQ6ICRVUkwiCmVjaG8gIlNlcnZpbmcgZGlyZWN0b3J5OiAkV0VCX0RJUiIKZWNobyAiIgplY2hvICJQcmVzcyBDdHJsK0MgdG8gc3RvcCB0aGUgc2VydmVyIgplY2hvICI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iCmVjaG8gIiIKCiMgVHJ5IHRvIG9wZW4gYnJvd3NlciBhdXRvbWF0aWNhbGx5IGFmdGVyIGEgc2hvcnQgZGVsYXkKKHNsZWVwIDIgJiYgaWYgY29tbWFuZCAtdiBvcGVuICY+IC9kZXYvbnVsbDsgdGhlbgogICAgb3BlbiAiJFVSTCIgMj4vZGV2L251bGwgJiYgZWNobyAiT3BlbmVkICRVUkwgaW4geW91ciBkZWZhdWx0IGJyb3dzZXIiIHx8IGVjaG8gIlBsZWFzZSBvcGVuICRVUkwgbWFudWFsbHkgaW4geW91ciBicm93c2VyIgplbGlmIGNvbW1hbmQgLXYgeGRnLW9wZW4gJj4gL2Rldi9udWxsOyB0aGVuCiAgICB4ZGctb3BlbiAiJFVSTCIgMj4vZGV2L251bGwgJiYgZWNobyAiT3BlbmVkICRVUkwgaW4geW91ciBkZWZhdWx0IGJyb3dzZXIiIHx8IGVjaG8gIlBsZWFzZSBvcGVuICRVUkwgbWFudWFsbHkgaW4geW91ciBicm93c2VyIgplbHNlCiAgICBlY2hvICJQbGVhc2Ugb3BlbiAkVVJMIG1hbnVhbGx5IGluIHlvdXIgYnJvd3NlciIKZmkpICYKCiMgVHJ5IFB5dGhvbiAzIGZpcnN0LCB0aGVuIFB5dGhvbiAyLCB0aGVuIGV4aXQgd2l0aCBlcnJvcgppZiBjb21tYW5kIC12IHB5dGhvbjMgJj4gL2Rldi9udWxsOyB0aGVuCiAgICBweXRob24zIC1tIGh0dHAuc2VydmVyICIkUE9SVCIKZWxpZiBjb21tYW5kIC12IHB5dGhvbiAmPiAvZGV2L251bGw7IHRoZW4KICAgIHB5dGhvbiAtbSBTaW1wbGVIVFRQU2VydmVyICIkUE9SVCIKZWxzZQogICAgZWNobyAiRXJyb3I6IFB5dGhvbiBub3QgZm91bmQuIFBsZWFzZSBpbnN0YWxsIFB5dGhvbiB0byBydW4gYSBsb2NhbCBzZXJ2ZXIuIgogICAgcmVhZCAtcCAiUHJlc3MgRW50ZXIgdG8gZXhpdC4uLiIKICAgIGV4aXQgMQpmaQoiIiIKICAgIAogICAgd2l0aCBvcGVuKHdlYl9jb21tYW5kX3BhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICBmLndyaXRlKHdlYl9jb21tYW5kX2NvbnRlbnQpCiAgICAKICAgICMgTWFrZSBpdCBleGVjdXRhYmxlCiAgICBvcy5jaG1vZCh3ZWJfY29tbWFuZF9wYXRoLCAwbzc1NSkKICAgIAogICAgcmV0dXJuIHdlYl9jb21tYW5kX3BhdGgKCgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBCYXNlbGluZSBJZGVudGlmaWNhdGlvbiBhbmQgTm9ybWFsaXphdGlvbiBGdW5jdGlvbnMKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgpkZWYgaWRlbnRpZnlfYmFzZWxpbmVfd2luZG93KGRmOiBwZC5EYXRhRnJhbWUsIGJhc2VsaW5lX2VuZF90aW1lOiBmbG9hdCA9IDI0LjApIC0+IERpY3Rbc3RyLCBwZC5EYXRhRnJhbWVdOgogICAgIiIiCiAgICBGb3IgZWFjaCB3ZWxsIGNvbHVtbiwgZGVmaW5lIHRoZSBiYXNlbGluZSB3aW5kb3cgYXMgYWxsIHJvd3Mgd2l0aCBUaW1lX3MgPD0gYmFzZWxpbmVfZW5kX3RpbWUuCiAgICAKICAgIFBhcmFtZXRlcnM6CiAgICAtLS0tLS0tLS0tLQogICAgZGYgOiBwZC5EYXRhRnJhbWUKICAgICAgICBMb25nLWZvcm1hdCBEYXRhRnJhbWUgd2l0aCBjb2x1bW5zIFsncGxhdGVfaWQnLCAnd2VsbCcsICdjb250ZW50JywgJ3RpbWVfcycsICd2YWx1ZSddCiAgICBiYXNlbGluZV9lbmRfdGltZSA6IGZsb2F0CiAgICAgICAgTWF4aW11bSB0aW1lIChpbiBzZWNvbmRzKSBmb3IgYmFzZWxpbmUgd2luZG93IChkZWZhdWx0OiAyNC4wKQogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIERpY3Rbc3RyLCBwZC5EYXRhRnJhbWVdCiAgICAgICAgRGljdGlvbmFyeSBtYXBwaW5nIHdlbGxfaWQgdG8gRGF0YUZyYW1lIGNvbnRhaW5pbmcgb25seSBiYXNlbGluZSBwb2ludHMgZm9yIHRoYXQgd2VsbAogICAgIiIiCiAgICBiYXNlbGluZV9kYXRhID0ge30KICAgIAogICAgZm9yIHdlbGxfaWQsIHdlbGxfZGYgaW4gZGYuZ3JvdXBieSgnd2VsbCcpOgogICAgICAgIGJhc2VsaW5lX21hc2sgPSB3ZWxsX2RmWyd0aW1lX3MnXSA8PSBiYXNlbGluZV9lbmRfdGltZQogICAgICAgIGJhc2VsaW5lX2RhdGFbd2VsbF9pZF0gPSB3ZWxsX2RmW2Jhc2VsaW5lX21hc2tdLmNvcHkoKQogICAgCiAgICByZXR1cm4gYmFzZWxpbmVfZGF0YQoKCmRlZiBmaXRfYmFzZWxpbmUoCiAgICB0aW1lOiBwZC5TZXJpZXMsCiAgICBmbHVvcmVzY2VuY2U6IHBkLlNlcmllcywKICAgIG1ldGhvZDogc3RyID0gJ2xvd2VzcycsCiAgICBmcmFjOiBmbG9hdCA9IDAuNSwKICAgIHBvbHlfb3JkZXI6IGludCA9IDEsCiAgICB3ZWxsX2lkOiBzdHIgPSBOb25lCikgLT4gcGQuU2VyaWVzOgogICAgIiIiCiAgICBGaXQgYSBzbW9vdGggYmFzZWxpbmUgZnVuY3Rpb24gb24gdGhlIGJhc2VsaW5lIHdpbmRvdyBhbmQgZXh0cmFwb2xhdGUgdG8gZnVsbCB0aW1lY291cnNlLgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIHRpbWUgOiBwZC5TZXJpZXMKICAgICAgICBUaW1lIHZhbHVlcyBmb3IgYmFzZWxpbmUgd2luZG93CiAgICBmbHVvcmVzY2VuY2UgOiBwZC5TZXJpZXMKICAgICAgICBGbHVvcmVzY2VuY2UgdmFsdWVzIGZvciBiYXNlbGluZSB3aW5kb3cKICAgIG1ldGhvZCA6IHN0cgogICAgICAgIEJhc2VsaW5lIGZpdHRpbmcgbWV0aG9kOiAnbG93ZXNzJywgJ2NvbnN0YW50Jywgb3IgJ3BvbHlub21pYWwnIChkZWZhdWx0OiAnY29uc3RhbnQnKQogICAgICAgIC0gJ2xvd2Vzcyc6IExvY2FsbHkgV2VpZ2h0ZWQgU2NhdHRlcnBsb3QgU21vb3RoaW5nLiBVc2Ugd2hlbiBiYXNlbGluZSBoYXMgZ3JhZHVhbCBkcmlmdC4KICAgICAgICAgIEJlc3QgZm9yIG5vbi1saW5lYXIgYmFzZWxpbmVzIHdpdGggc21vb3RoIHRyZW5kcy4gRm9ybXVsYTogZyh0KSA9IExPV0VTUyhGX2Jhc2VsaW5lLCB0X2Jhc2VsaW5lLCBmcmFjKQogICAgICAgIC0gJ2NvbnN0YW50JzogQ29uc3RhbnQgbWVhbiBiYXNlbGluZS4gVXNlIHdoZW4gYmFzZWxpbmUgaXMgc3RhYmxlL2ZsYXQuCiAgICAgICAgICBCZXN0IGZvciBzdGFibGUgYmFzZWxpbmVzIHdpdGggbWluaW1hbCBkcmlmdC4gRm9ybXVsYTogZyh0KSA9IG1lYW4oRl9iYXNlbGluZSkKICAgICAgICAtICdwb2x5bm9taWFsJzogUG9seW5vbWlhbCBmaXQuIFVzZSB3aGVuIGJhc2VsaW5lIGhhcyBsaW5lYXIgb3IgcG9seW5vbWlhbCBkcmlmdC4KICAgICAgICAgIEJlc3QgZm9yIGJhc2VsaW5lcyB3aXRoIGtub3duIHBvbHlub21pYWwgdHJlbmRzLiBGb3JtdWxhOiBnKHQpID0gY+KCgCArIGPigoF0ICsgY+KCgnTCsiArIC4uLgogICAgZnJhYyA6IGZsb2F0CiAgICAgICAgRnJhY3Rpb24gb2YgZGF0YSB1c2VkIGZvciBMT1dFU1Mgc21vb3RoaW5nIChkZWZhdWx0OiAwLjUpLiBIaWdoZXIgPSBzbW9vdGhlciwgbG93ZXIgPSBtb3JlIGxvY2FsLgogICAgcG9seV9vcmRlciA6IGludAogICAgICAgIFBvbHlub21pYWwgb3JkZXIgZm9yIHBvbHlub21pYWwgZml0IChkZWZhdWx0OiAxKS4gMSA9IGxpbmVhciwgMiA9IHF1YWRyYXRpYywgZXRjLgogICAgd2VsbF9pZCA6IHN0ciwgb3B0aW9uYWwKICAgICAgICBXZWxsIGlkZW50aWZpZXIgZm9yIG91dHB1dAogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIHBkLlNlcmllcwogICAgICAgIEZpdHRlZCBiYXNlbGluZSB2YWx1ZXMgZm9yIGFsbCB0aW1lcG9pbnRzIChzYW1lIGluZGV4IGFzIGlucHV0IHRpbWUpCiAgICAiIiIKICAgIGltcG9ydCBudW1weSBhcyBucAogICAgCiAgICAjIFJlbW92ZSBOYU4gdmFsdWVzCiAgICB2YWxpZF9tYXNrID0gfihwZC5pc25hKHRpbWUpIHwgcGQuaXNuYShmbHVvcmVzY2VuY2UpKQogICAgdGltZV9jbGVhbiA9IHRpbWVbdmFsaWRfbWFza10udmFsdWVzCiAgICBmbHVvX2NsZWFuID0gZmx1b3Jlc2NlbmNlW3ZhbGlkX21hc2tdLnZhbHVlcwogICAgCiAgICBpZiBsZW4odGltZV9jbGVhbikgPT0gMDoKICAgICAgICAjIE5vIHZhbGlkIGRhdGEsIHJldHVybiBOYU4gc2VyaWVzCiAgICAgICAgcmV0dXJuIHBkLlNlcmllcyhpbmRleD10aW1lLmluZGV4LCBkdHlwZT1mbG9hdCkKICAgIAogICAgaWYgbWV0aG9kID09ICdjb25zdGFudCc6CiAgICAgICAgIyAwdGgtb3JkZXIgKGNvbnN0YW50IG1lYW4gYmFzZWxpbmUpCiAgICAgICAgIyBGb3JtdWxhOiBnKHQpID0gbWVhbihGX2Jhc2VsaW5lKSBmb3IgYWxsIHQKICAgICAgICBiYXNlbGluZV92YWx1ZSA9IG5wLm1lYW4oZmx1b19jbGVhbikKICAgICAgICBiYXNlbGluZV9maXQgPSBwZC5TZXJpZXMoYmFzZWxpbmVfdmFsdWUsIGluZGV4PXRpbWUuaW5kZXgpCiAgICAKICAgIGVsaWYgbWV0aG9kID09ICdwb2x5bm9taWFsJzoKICAgICAgICAjIFBvbHlub21pYWwgZml0IHVzaW5nIG5wLnBvbHlmaXQKICAgICAgICAjIEZvcm11bGE6IGcodCkgPSBj4oKAICsgY+KCgXQgKyBj4oKCdMKyICsgLi4uIChkZXBlbmRpbmcgb24gb3JkZXIpCiAgICAgICAgY29lZmZzID0gbnAucG9seWZpdCh0aW1lX2NsZWFuLCBmbHVvX2NsZWFuLCBwb2x5X29yZGVyKQogICAgICAgIHBvbHlfZnVuYyA9IG5wLnBvbHkxZChjb2VmZnMpCiAgICAgICAgYmFzZWxpbmVfZml0ID0gcGQuU2VyaWVzKHBvbHlfZnVuYyh0aW1lLnZhbHVlcyksIGluZGV4PXRpbWUuaW5kZXgpCiAgICAKICAgIGVsaWYgbWV0aG9kID09ICdsb3dlc3MnOgogICAgICAgICMgTE9XRVNTIHNtb290aGluZwogICAgICAgICMgRm9ybXVsYTogZyh0KSA9IExPV0VTUyhGX2Jhc2VsaW5lLCB0X2Jhc2VsaW5lLCBmcmFjKSBpbnRlcnBvbGF0ZWQvZXh0cmFwb2xhdGVkCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmcm9tIHN0YXRzbW9kZWxzLm5vbnBhcmFtZXRyaWMuc21vb3RoZXJzX2xvd2VzcyBpbXBvcnQgbG93ZXNzCiAgICAgICAgICAgICMgTE9XRVNTIHJldHVybnMgYXJyYXkgb2YgW3gsIHldIHBhaXJzCiAgICAgICAgICAgIHNtb290aGVkID0gbG93ZXNzKGZsdW9fY2xlYW4sIHRpbWVfY2xlYW4sIGZyYWM9ZnJhYywgcmV0dXJuX3NvcnRlZD1GYWxzZSkKICAgICAgICAgICAgIyBJbnRlcnBvbGF0ZS9leHRyYXBvbGF0ZSB0byBmdWxsIHRpbWVjb3Vyc2UKICAgICAgICAgICAgZnJvbSBzY2lweS5pbnRlcnBvbGF0ZSBpbXBvcnQgaW50ZXJwMWQKICAgICAgICAgICAgaW50ZXJwX2Z1bmMgPSBpbnRlcnAxZCgKICAgICAgICAgICAgICAgIHRpbWVfY2xlYW4sIHNtb290aGVkLCAKICAgICAgICAgICAgICAgIGtpbmQ9J2xpbmVhcicsIAogICAgICAgICAgICAgICAgYm91bmRzX2Vycm9yPUZhbHNlLCAKICAgICAgICAgICAgICAgIGZpbGxfdmFsdWU9J2V4dHJhcG9sYXRlJwogICAgICAgICAgICApCiAgICAgICAgICAgIGJhc2VsaW5lX2ZpdCA9IHBkLlNlcmllcyhpbnRlcnBfZnVuYyh0aW1lLnZhbHVlcyksIGluZGV4PXRpbWUuaW5kZXgpCiAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgICAgICByYWlzZSBJbXBvcnRFcnJvcigKICAgICAgICAgICAgICAgICJzdGF0c21vZGVscyBpcyByZXF1aXJlZCBmb3IgTE9XRVNTIGZpdHRpbmcuICIKICAgICAgICAgICAgICAgICJJbnN0YWxsIHdpdGg6IHBpcCBpbnN0YWxsIHN0YXRzbW9kZWxzIgogICAgICAgICAgICApCiAgICAKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIlVua25vd24gYmFzZWxpbmUgbWV0aG9kOiB7bWV0aG9kfS4gQ2hvb3NlIGZyb20gJ2xvd2VzcycsICdjb25zdGFudCcsIG9yICdwb2x5bm9taWFsJyIpCiAgICAKICAgIHJldHVybiBiYXNlbGluZV9maXQKCgpkZWYgZml0X3dlbGxfYmFzZWxpbmVzKAogICAgZGY6IHBkLkRhdGFGcmFtZSwKICAgIGJhc2VsaW5lX2VuZF90aW1lOiBmbG9hdCA9IDI0LjAsCiAgICBtZXRob2Q6IHN0ciA9ICdsb3dlc3MnLAogICAgZnJhYzogZmxvYXQgPSAwLjUsCiAgICBwb2x5X29yZGVyOiBpbnQgPSAxLAogICAgY29uZmlnOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUKKSAtPiBEaWN0W3N0ciwgcGQuU2VyaWVzXToKICAgICIiIgogICAgRm9yIGVhY2ggd2VsbCwgZml0IGEgc21vb3RoIGJhc2VsaW5lIGZ1bmN0aW9uIG9uIHRoZSBiYXNlbGluZSB3aW5kb3cgT05MWSwKICAgIHRoZW4gZXh0cmFwb2xhdGUgb3ZlciB0aGUgZnVsbCB0aW1lY291cnNlLgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIGRmIDogcGQuRGF0YUZyYW1lCiAgICAgICAgTG9uZy1mb3JtYXQgRGF0YUZyYW1lIHdpdGggY29sdW1ucyBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgYmFzZWxpbmVfZW5kX3RpbWUgOiBmbG9hdAogICAgICAgIE1heGltdW0gdGltZSAoaW4gc2Vjb25kcykgZm9yIGJhc2VsaW5lIHdpbmRvdyAoZGVmYXVsdDogMjQuMCkKICAgIG1ldGhvZCA6IHN0cgogICAgICAgIEJhc2VsaW5lIGZpdHRpbmcgbWV0aG9kOiAnbG93ZXNzJywgJ2NvbnN0YW50Jywgb3IgJ3BvbHlub21pYWwnIChkZWZhdWx0OiAnY29uc3RhbnQnKQogICAgZnJhYyA6IGZsb2F0CiAgICAgICAgRnJhY3Rpb24gb2YgZGF0YSB1c2VkIGZvciBMT1dFU1Mgc21vb3RoaW5nIChkZWZhdWx0OiAwLjUpCiAgICBwb2x5X29yZGVyIDogaW50CiAgICAgICAgUG9seW5vbWlhbCBvcmRlciBmb3IgcG9seW5vbWlhbCBmaXQgKGRlZmF1bHQ6IDEpCiAgICAKICAgIFJldHVybnM6CiAgICAtLS0tLS0tLQogICAgRGljdFtzdHIsIHBkLlNlcmllc10KICAgICAgICBEaWN0aW9uYXJ5IG1hcHBpbmcgd2VsbF9pZCB0byBTZXJpZXMgb2YgZml0dGVkIGJhc2VsaW5lIHZhbHVlcyAoaW5kZXhlZCBieSB0aW1lX3MpCiAgICAiIiIKICAgIGJhc2VsaW5lX2ZpdHMgPSB7fQogICAgCiAgICAjIEZpbHRlciBvdXQgYmFkIHdlbGxzIGlmIGNvbmZpZyBpcyBwcm92aWRlZAogICAgaWYgY29uZmlnIGlzIG5vdCBOb25lOgogICAgICAgIGJhZF93ZWxsc19saXN0ID0gY29uZmlnLmdldCgiYmFkX3dlbGxzIiwgW10pCiAgICAgICAgaWYgYmFkX3dlbGxzX2xpc3Q6CiAgICAgICAgICAgIGRmID0gZGZbfmRmWyJ3ZWxsIl0uYXBwbHkobGFtYmRhIHc6IGlzX2JhZF93ZWxsKHcsIGNvbmZpZykpXQogICAgCiAgICAjIEdldCBiYXNlbGluZSB3aW5kb3dzIGZvciBlYWNoIHdlbGwKICAgIGJhc2VsaW5lX3dpbmRvd3MgPSBpZGVudGlmeV9iYXNlbGluZV93aW5kb3coZGYsIGJhc2VsaW5lX2VuZF90aW1lKQogICAgCiAgICAjIEZpdCBiYXNlbGluZSBmb3IgZWFjaCB3ZWxsCiAgICBmb3Igd2VsbF9pZCwgd2VsbF9kZiBpbiBkZi5ncm91cGJ5KCd3ZWxsJyk6CiAgICAgICAgIyBHZXQgZnVsbCB0aW1lY291cnNlIGZvciB0aGlzIHdlbGwKICAgICAgICBmdWxsX3RpbWVjb3Vyc2UgPSB3ZWxsX2RmLnNvcnRfdmFsdWVzKCd0aW1lX3MnKQogICAgICAgIAogICAgICAgICMgR2V0IGJhc2VsaW5lIHdpbmRvdwogICAgICAgIGJhc2VsaW5lX3dpbmRvdyA9IGJhc2VsaW5lX3dpbmRvd3MuZ2V0KHdlbGxfaWQpCiAgICAgICAgCiAgICAgICAgaWYgYmFzZWxpbmVfd2luZG93IGlzIE5vbmUgb3IgbGVuKGJhc2VsaW5lX3dpbmRvdykgPT0gMDoKICAgICAgICAgICAgIyBObyBiYXNlbGluZSBkYXRhLCBjcmVhdGUgTmFOIHNlcmllcwogICAgICAgICAgICBiYXNlbGluZV9maXRzW3dlbGxfaWRdID0gcGQuU2VyaWVzKAogICAgICAgICAgICAgICAgaW5kZXg9ZnVsbF90aW1lY291cnNlWyd0aW1lX3MnXSwKICAgICAgICAgICAgICAgIGR0eXBlPWZsb2F0CiAgICAgICAgICAgICkKICAgICAgICAgICAgY29udGludWUKICAgICAgICAKICAgICAgICAjIFNvcnQgYmFzZWxpbmUgd2luZG93IGJ5IHRpbWUKICAgICAgICBiYXNlbGluZV93aW5kb3cgPSBiYXNlbGluZV93aW5kb3cuc29ydF92YWx1ZXMoJ3RpbWVfcycpCiAgICAgICAgCiAgICAgICAgIyBGaXQgYmFzZWxpbmUgb24gYmFzZWxpbmUgd2luZG93IG9ubHkKICAgICAgICBiYXNlbGluZV9maXQgPSBmaXRfYmFzZWxpbmUoCiAgICAgICAgICAgIGJhc2VsaW5lX3dpbmRvd1sndGltZV9zJ10sCiAgICAgICAgICAgIGJhc2VsaW5lX3dpbmRvd1sndmFsdWUnXSwKICAgICAgICAgICAgbWV0aG9kPW1ldGhvZCwKICAgICAgICAgICAgZnJhYz1mcmFjLAogICAgICAgICAgICBwb2x5X29yZGVyPXBvbHlfb3JkZXIsCiAgICAgICAgICAgIHdlbGxfaWQ9d2VsbF9pZAogICAgICAgICkKICAgICAgICAKICAgICAgICAjIEV4dHJhcG9sYXRlIHRvIGZ1bGwgdGltZWNvdXJzZQogICAgICAgIGZ1bGxfdGltZXMgPSBmdWxsX3RpbWVjb3Vyc2VbJ3RpbWVfcyddLnZhbHVlcwogICAgICAgIAogICAgICAgICMgRm9yIGNvbnN0YW50IG1ldGhvZCwgd2UgY2FuIGNyZWF0ZSB0aGUgU2VyaWVzIGRpcmVjdGx5IHdpdGhvdXQgc2NpcHkKICAgICAgICBpZiBtZXRob2QgPT0gJ2NvbnN0YW50JzoKICAgICAgICAgICAgIyBiYXNlbGluZV9maXQgYWxyZWFkeSBjb250YWlucyB0aGUgY29uc3RhbnQgdmFsdWUKICAgICAgICAgICAgY29uc3RhbnRfdmFsdWUgPSBiYXNlbGluZV9maXQuaWxvY1swXSBpZiBsZW4oYmFzZWxpbmVfZml0KSA+IDAgZWxzZSBucC5uYW4KICAgICAgICAgICAgZXh0cmFwb2xhdGVkX2Jhc2VsaW5lID0gcGQuU2VyaWVzKAogICAgICAgICAgICAgICAgY29uc3RhbnRfdmFsdWUsCiAgICAgICAgICAgICAgICBpbmRleD1mdWxsX3RpbWVjb3Vyc2VbJ3RpbWVfcyddCiAgICAgICAgICAgICkKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIEZvciBwb2x5bm9taWFsIGFuZCBsb3dlc3MgbWV0aG9kcywgbmVlZCBpbnRlcnBvbGF0aW9uCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZyb20gc2NpcHkuaW50ZXJwb2xhdGUgaW1wb3J0IGludGVycDFkCiAgICAgICAgICAgIGV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgICAgICAgICAgICAgIHJhaXNlIEltcG9ydEVycm9yKAogICAgICAgICAgICAgICAgICAgICJzY2lweSBpcyByZXF1aXJlZCBmb3IgYmFzZWxpbmUgbWV0aG9kcyAncG9seW5vbWlhbCcgYW5kICdsb3dlc3MnLiAiCiAgICAgICAgICAgICAgICAgICAgIkluc3RhbGwgd2l0aDogcGlwIGluc3RhbGwgc2NpcHlcbiIKICAgICAgICAgICAgICAgICAgICAiT3IgdXNlIG1ldGhvZD0nY29uc3RhbnQnIHdoaWNoIGRvZXMgbm90IHJlcXVpcmUgc2NpcHkuIgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBHZXQgdW5pcXVlIHRpbWVwb2ludHMgZnJvbSBiYXNlbGluZSBmaXQKICAgICAgICAgICAgYmFzZWxpbmVfdGltZXMgPSBiYXNlbGluZV9maXQuaW5kZXgudmFsdWVzCiAgICAgICAgICAgIGJhc2VsaW5lX3ZhbHVlcyA9IGJhc2VsaW5lX2ZpdC52YWx1ZXMKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ3JlYXRlIGludGVycG9sYXRpb24gZnVuY3Rpb24KICAgICAgICAgICAgaW50ZXJwX2Z1bmMgPSBpbnRlcnAxZCgKICAgICAgICAgICAgICAgIGJhc2VsaW5lX3RpbWVzLAogICAgICAgICAgICAgICAgYmFzZWxpbmVfdmFsdWVzLAogICAgICAgICAgICAgICAga2luZD0nbGluZWFyJywKICAgICAgICAgICAgICAgIGJvdW5kc19lcnJvcj1GYWxzZSwKICAgICAgICAgICAgICAgIGZpbGxfdmFsdWU9J2V4dHJhcG9sYXRlJwogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEludGVycG9sYXRlIHRvIGZ1bGwgdGltZWNvdXJzZSB0aW1lcG9pbnRzCiAgICAgICAgICAgIGV4dHJhcG9sYXRlZF9iYXNlbGluZSA9IHBkLlNlcmllcygKICAgICAgICAgICAgICAgIGludGVycF9mdW5jKGZ1bGxfdGltZXMpLAogICAgICAgICAgICAgICAgaW5kZXg9ZnVsbF90aW1lY291cnNlWyd0aW1lX3MnXQogICAgICAgICAgICApCiAgICAgICAgCiAgICAgICAgYmFzZWxpbmVfZml0c1t3ZWxsX2lkXSA9IGV4dHJhcG9sYXRlZF9iYXNlbGluZQogICAgCiAgICByZXR1cm4gYmFzZWxpbmVfZml0cwoKCmRlZiBub3JtYWxpemVfd2VsbHMoCiAgICBkZjogcGQuRGF0YUZyYW1lLAogICAgYmFzZWxpbmVfZml0czogRGljdFtzdHIsIHBkLlNlcmllc10sCiAgICBub3JtYWxpemF0aW9uX21vZGU6IHN0ciA9ICdtdWx0aXBsaWNhdGl2ZScKKSAtPiBwZC5EYXRhRnJhbWU6CiAgICAiIiIKICAgIEZvciBlYWNoIHdlbGwgYW5kIGVhY2ggdGltZXBvaW50LCBjb21wdXRlIG5vcm1hbGl6ZWQgZmx1b3Jlc2NlbmNlIHVzaW5nIHRoZSBmaXR0ZWQgYmFzZWxpbmUuCiAgICAKICAgIFBhcmFtZXRlcnM6CiAgICAtLS0tLS0tLS0tLQogICAgZGYgOiBwZC5EYXRhRnJhbWUKICAgICAgICBMb25nLWZvcm1hdCBEYXRhRnJhbWUgd2l0aCBjb2x1bW5zIFsncGxhdGVfaWQnLCAnd2VsbCcsICdjb250ZW50JywgJ3RpbWVfcycsICd2YWx1ZSddCiAgICBiYXNlbGluZV9maXRzIDogRGljdFtzdHIsIHBkLlNlcmllc10KICAgICAgICBEaWN0aW9uYXJ5IG1hcHBpbmcgd2VsbF9pZCB0byBTZXJpZXMgb2YgZml0dGVkIGJhc2VsaW5lIHZhbHVlcwogICAgbm9ybWFsaXphdGlvbl9tb2RlIDogc3RyCiAgICAgICAgTm9ybWFsaXphdGlvbiBtb2RlIChkZWZhdWx0OiAnbXVsdGlwbGljYXRpdmUnKQogICAgICAgIC0gJ2RlbHRhX2Zfb3Zlcl9mJzogzpRGL0Ygbm9ybWFsaXphdGlvbi4gRm9ybXVsYTogRicodCkgPSAoRih0KSAtIGcodCkpIC8gZyh0KQogICAgICAgICAgVXNlIHdoZW4geW91IHdhbnQgdG8gbWVhc3VyZSByZWxhdGl2ZSBjaGFuZ2UgZnJvbSBiYXNlbGluZS4gQmVzdCBmb3IgZGV0ZWN0aW5nCiAgICAgICAgICBpbmNyZWFzZXMvZGVjcmVhc2VzIHJlbGF0aXZlIHRvIGJhc2VsaW5lLiBWYWx1ZXMgY2FuIGJlIG5lZ2F0aXZlIChiZWxvdyBiYXNlbGluZSkKICAgICAgICAgIG9yIHBvc2l0aXZlIChhYm92ZSBiYXNlbGluZSkuCiAgICAgICAgLSAnbXVsdGlwbGljYXRpdmUnOiBNdWx0aXBsaWNhdGl2ZSBub3JtYWxpemF0aW9uLiBGb3JtdWxhOiBGX25vcm0odCkgPSBGKHQpIC8gZyh0KQogICAgICAgICAgVXNlIHdoZW4geW91IHdhbnQgdG8gbm9ybWFsaXplIGJ5IGJhc2VsaW5lIHdpdGhvdXQgc3VidHJhY3RpbmcuIEJlc3QgZm9yIGZvbGQtY2hhbmdlCiAgICAgICAgICBhbmFseXNpcy4gVmFsdWVzIGFyZSBhbHdheXMgcG9zaXRpdmUgKHJhdGlvIHRvIGJhc2VsaW5lKS4KICAgIAogICAgUmV0dXJuczoKICAgIC0tLS0tLS0tCiAgICBwZC5EYXRhRnJhbWUKICAgICAgICBEYXRhRnJhbWUgd2l0aCBzYW1lIHNoYXBlIGFzIGlucHV0IGJ1dCB3aXRoIG5vcm1hbGl6ZWQgJ3ZhbHVlJyBjb2x1bW4KICAgICIiIgogICAgbm9ybV9kZiA9IGRmLmNvcHkoKQogICAgbm9ybV92YWx1ZXMgPSBbXQogICAgCiAgICBmb3IgaWR4LCByb3cgaW4gZGYuaXRlcnJvd3MoKToKICAgICAgICB3ZWxsX2lkID0gcm93Wyd3ZWxsJ10KICAgICAgICB0aW1lX3MgPSByb3dbJ3RpbWVfcyddCiAgICAgICAgdmFsdWUgPSByb3dbJ3ZhbHVlJ10KICAgICAgICAKICAgICAgICAjIEdldCBiYXNlbGluZSBmaXQgZm9yIHRoaXMgd2VsbAogICAgICAgIGJhc2VsaW5lX3NlcmllcyA9IGJhc2VsaW5lX2ZpdHMuZ2V0KHdlbGxfaWQpCiAgICAgICAgCiAgICAgICAgaWYgYmFzZWxpbmVfc2VyaWVzIGlzIE5vbmUgb3IgbGVuKGJhc2VsaW5lX3NlcmllcykgPT0gMDoKICAgICAgICAgICAgbm9ybV92YWx1ZXMuYXBwZW5kKG5wLm5hbikKICAgICAgICAgICAgY29udGludWUKICAgICAgICAKICAgICAgICAjIEZpbmQgY2xvc2VzdCB0aW1lcG9pbnQgaW4gYmFzZWxpbmUgc2VyaWVzCiAgICAgICAgYmFzZWxpbmVfdGltZXMgPSBiYXNlbGluZV9zZXJpZXMuaW5kZXgudmFsdWVzCiAgICAgICAgY2xvc2VzdF9pZHggPSBucC5hcmdtaW4obnAuYWJzKGJhc2VsaW5lX3RpbWVzIC0gdGltZV9zKSkKICAgICAgICBiYXNlbGluZV92YWx1ZSA9IGJhc2VsaW5lX3Nlcmllcy5pbG9jW2Nsb3Nlc3RfaWR4XQogICAgICAgIAogICAgICAgIGlmIHBkLmlzbmEoYmFzZWxpbmVfdmFsdWUpIG9yIGJhc2VsaW5lX3ZhbHVlID09IDA6CiAgICAgICAgICAgIG5vcm1fdmFsdWVzLmFwcGVuZChucC5uYW4pCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgCiAgICAgICAgIyBBcHBseSBub3JtYWxpemF0aW9uCiAgICAgICAgaWYgbm9ybWFsaXphdGlvbl9tb2RlID09ICdkZWx0YV9mX292ZXJfZic6CiAgICAgICAgICAgICMgzpRGL0YgPSAoRih0KSAtIGcodCkpIC8gZyh0KQogICAgICAgICAgICBub3JtX3ZhbHVlID0gKHZhbHVlIC0gYmFzZWxpbmVfdmFsdWUpIC8gYmFzZWxpbmVfdmFsdWUKICAgICAgICBlbGlmIG5vcm1hbGl6YXRpb25fbW9kZSA9PSAnbXVsdGlwbGljYXRpdmUnOgogICAgICAgICAgICAjIEZfbm9ybSh0KSA9IEYodCkgLyBnKHQpCiAgICAgICAgICAgIG5vcm1fdmFsdWUgPSB2YWx1ZSAvIGJhc2VsaW5lX3ZhbHVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgICAgIGYiVW5rbm93biBub3JtYWxpemF0aW9uX21vZGU6IHtub3JtYWxpemF0aW9uX21vZGV9LiAiCiAgICAgICAgICAgICAgICAiQ2hvb3NlIGZyb20gJ2RlbHRhX2Zfb3Zlcl9mJyBvciAnbXVsdGlwbGljYXRpdmUnIgogICAgICAgICAgICApCiAgICAgICAgCiAgICAgICAgbm9ybV92YWx1ZXMuYXBwZW5kKG5vcm1fdmFsdWUpCiAgICAKICAgIG5vcm1fZGZbJ3ZhbHVlJ10gPSBub3JtX3ZhbHVlcwogICAgcmV0dXJuIG5vcm1fZGYKCgpkZWYgZ2V0X3RyaXBsaWNhdGVfZ3JvdXBfY29sb3IoCiAgICBncm91cF9uYW1lOiBzdHIsCiAgICBjb25maWc6IERpY3Rbc3RyLCBBbnldID0gTm9uZQopIC0+IHN0cjoKICAgICIiIgogICAgR2V0IHRoZSBjb2xvciBmb3IgYSB0cmlwbGljYXRlIGdyb3VwIG5hbWUuCiAgICBNYXRjaGVzIHRoZSBjb2xvciBhc3NpZ25tZW50IGZyb20gdGhlIHdlYiBpbnRlcmZhY2UuCiAgICAKICAgIFBhcmFtZXRlcnM6CiAgICAtLS0tLS0tLS0tLQogICAgZ3JvdXBfbmFtZSA6IHN0cgogICAgICAgIE5hbWUgb2YgdGhlIHRyaXBsaWNhdGUgZ3JvdXAKICAgIGNvbmZpZyA6IERpY3Rbc3RyLCBBbnldLCBvcHRpb25hbAogICAgICAgIENvbmZpZ3VyYXRpb24gZGljdGlvbmFyeSB3aXRoICd0cmlwbGljYXRlX2dyb3Vwcycga2V5CiAgICAKICAgIFJldHVybnM6CiAgICAtLS0tLS0tLQogICAgc3RyCiAgICAgICAgSGV4IGNvbG9yIGNvZGUgZm9yIHRoZSBncm91cAogICAgIiIiCiAgICBpZiBjb25maWcgaXMgTm9uZToKICAgICAgICBzY3JpcHRfZGlyID0gb3MucGF0aC5kaXJuYW1lKG9zLnBhdGguYWJzcGF0aChfX2ZpbGVfXykpCiAgICAgICAgY29uZmlnX3BhdGggPSBvcy5wYXRoLmpvaW4oc2NyaXB0X2RpciwgInBsYXRlX2NvbmZpZy5qc29uIikKICAgICAgICBjb25maWcgPSBsb2FkX2NvbmZpZyhjb25maWdfcGF0aCkKICAgIAogICAgdHJpcGxpY2F0ZV9ncm91cHMgPSBjb25maWcuZ2V0KCJ0cmlwbGljYXRlX2dyb3VwcyIsIERFRkFVTFRfVFJJUExJQ0FURV9HUk9VUFMpCiAgICAKICAgICMgQnVpbGQgY29sb3IgbWFwOiBncm91cCBuYW1lIC0+IGNvbG9yIGluZGV4CiAgICBjb2xvcl9tYXAgPSB7fQogICAgZm9yIGlkeCwgZ3JvdXAgaW4gZW51bWVyYXRlKHRyaXBsaWNhdGVfZ3JvdXBzKToKICAgICAgICBuYW1lID0gZ3JvdXAuZ2V0KCJuYW1lIiwgIiIpLnN0cmlwKCkKICAgICAgICBpZiBuYW1lIGFuZCBuYW1lIG5vdCBpbiBjb2xvcl9tYXA6CiAgICAgICAgICAgIGNvbG9yX21hcFtuYW1lXSA9IGlkeAogICAgCiAgICAjIEdldCBjb2xvciBpbmRleCBmb3IgdGhpcyBncm91cAogICAgbm9ybWFsaXplZF9uYW1lID0gZ3JvdXBfbmFtZS5zdHJpcCgpIGlmIGdyb3VwX25hbWUgZWxzZSAiIgogICAgY29sb3JfaWR4ID0gY29sb3JfbWFwLmdldChub3JtYWxpemVkX25hbWUsIDApCiAgICAKICAgICMgUmV0dXJuIGNvbG9yIGZyb20gcGFsZXR0ZSAoY3ljbGUgaWYgbmVlZGVkKQogICAgcmV0dXJuIFRSSVBMSUNBVEVfQ09MT1JTW2NvbG9yX2lkeCAlIGxlbihUUklQTElDQVRFX0NPTE9SUyldCgoKZGVmIGJ1aWxkX2NvbmRpdGlvbl9tYXAoCiAgICBkZjogcGQuRGF0YUZyYW1lLAogICAgY29uZmlnOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUKKSAtPiBEaWN0W3N0ciwgc3RyXToKICAgICIiIgogICAgQnVpbGQgYSBtYXBwaW5nIGZyb20gd2VsbF9pZCB0byBjb25kaXRpb24gbmFtZS4KICAgIAogICAgVXNlcyB0cmlwbGljYXRlIGdyb3VwIG5hbWVzIGZyb20gY29uZmlnIHRvIGFzc2lnbiBjb25kaXRpb25zLgogICAgV2VsbHMgaW4gdGhlIHNhbWUgdHJpcGxpY2F0ZSBncm91cCAoc2FtZSByb3cgcGF0dGVybikgZ2V0IHRoZSBzYW1lIGNvbmRpdGlvbi4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBkZiA6IHBkLkRhdGFGcmFtZQogICAgICAgIExvbmctZm9ybWF0IERhdGFGcmFtZSB3aXRoIGNvbHVtbnMgWydwbGF0ZV9pZCcsICd3ZWxsJywgJ2NvbnRlbnQnLCAndGltZV9zJywgJ3ZhbHVlJ10KICAgIGNvbmZpZyA6IERpY3Rbc3RyLCBBbnldCiAgICAgICAgQ29uZmlndXJhdGlvbiBkaWN0aW9uYXJ5IHdpdGggJ3RyaXBsaWNhdGVfZ3JvdXBzJyBrZXkKICAgIAogICAgUmV0dXJuczoKICAgIC0tLS0tLS0tCiAgICBEaWN0W3N0ciwgc3RyXQogICAgICAgIERpY3Rpb25hcnkgbWFwcGluZyB3ZWxsX2lkIHRvIGNvbmRpdGlvbiBuYW1lCiAgICAiIiIKICAgIGlmIGNvbmZpZyBpcyBOb25lOgogICAgICAgIHNjcmlwdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgICAgICBjb25maWdfcGF0aCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAicGxhdGVfY29uZmlnLmpzb24iKQogICAgICAgIGNvbmZpZyA9IGxvYWRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgCiAgICBjb25kaXRpb25fbWFwID0ge30KICAgIHRyaXBsaWNhdGVfZ3JvdXBzID0gY29uZmlnLmdldCgidHJpcGxpY2F0ZV9ncm91cHMiLCBERUZBVUxUX1RSSVBMSUNBVEVfR1JPVVBTKQogICAgCiAgICAjIEJ1aWxkIG1hcHBpbmc6IHJvd19sZXR0ZXIgLT4gY29uZGl0aW9uIG5hbWUKICAgIHJvd190b19jb25kaXRpb24gPSB7fQogICAgZm9yIGdyb3VwIGluIHRyaXBsaWNhdGVfZ3JvdXBzOgogICAgICAgIGdyb3VwX25hbWUgPSBncm91cC5nZXQoIm5hbWUiLCAiIikKICAgICAgICBncm91cF93ZWxscyA9IGdyb3VwLmdldCgid2VsbHMiLCBbXSkKICAgICAgICBmb3Igd2VsbF9wYXR0ZXJuIGluIGdyb3VwX3dlbGxzOgogICAgICAgICAgICAjIEV4dHJhY3Qgcm93IGxldHRlciBmcm9tIHdlbGwgcGF0dGVybiAoZS5nLiwgIkIiIGZyb20gIkIiIG9yICJCMTMiKQogICAgICAgICAgICByb3dfbGV0dGVyID0gd2VsbF9wYXR0ZXJuWzBdIGlmIHdlbGxfcGF0dGVybiBhbmQgd2VsbF9wYXR0ZXJuWzBdLmlzYWxwaGEoKSBlbHNlICIiCiAgICAgICAgICAgIGlmIHJvd19sZXR0ZXI6CiAgICAgICAgICAgICAgICByb3dfdG9fY29uZGl0aW9uW3Jvd19sZXR0ZXJdID0gZ3JvdXBfbmFtZQogICAgCiAgICAjIE1hcCBlYWNoIHdlbGwgdG8gaXRzIGNvbmRpdGlvbiBiYXNlZCBvbiByb3cgbGV0dGVyCiAgICBmb3Igd2VsbF9pZCBpbiBkZlsnd2VsbCddLnVuaXF1ZSgpOgogICAgICAgIGlmIHdlbGxfaWQgYW5kIGxlbih3ZWxsX2lkKSA+IDA6CiAgICAgICAgICAgIHJvd19sZXR0ZXIgPSB3ZWxsX2lkWzBdIGlmIHdlbGxfaWRbMF0uaXNhbHBoYSgpIGVsc2UgIiIKICAgICAgICAgICAgY29uZGl0aW9uID0gcm93X3RvX2NvbmRpdGlvbi5nZXQocm93X2xldHRlciwgd2VsbF9pZCkgICMgRGVmYXVsdCB0byB3ZWxsX2lkIGlmIG5vdCBmb3VuZAogICAgICAgICAgICBjb25kaXRpb25fbWFwW3dlbGxfaWRdID0gY29uZGl0aW9uCiAgICAKICAgIHJldHVybiBjb25kaXRpb25fbWFwCgoKZGVmIGNvbXB1dGVfY29uZGl0aW9uX3N0YXRpc3RpY3MoCiAgICBub3JtX2RmOiBwZC5EYXRhRnJhbWUsCiAgICBjb25kaXRpb25fbWFwOiBEaWN0W3N0ciwgc3RyXQopIC0+IHBkLkRhdGFGcmFtZToKICAgICIiIgogICAgR3JvdXAgd2VsbHMgYnkgY29uZGl0aW9uIGFuZCBjb21wdXRlIG1lYW4gwrEgU0VNIGZvciBlYWNoIGNvbmRpdGlvbiBhbmQgdGltZXBvaW50LgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIG5vcm1fZGYgOiBwZC5EYXRhRnJhbWUKICAgICAgICBOb3JtYWxpemVkIERhdGFGcmFtZSB3aXRoIGNvbHVtbnMgWydwbGF0ZV9pZCcsICd3ZWxsJywgJ2NvbnRlbnQnLCAndGltZV9zJywgJ3ZhbHVlJ10KICAgIGNvbmRpdGlvbl9tYXAgOiBEaWN0W3N0ciwgc3RyXQogICAgICAgIERpY3Rpb25hcnkgbWFwcGluZyB3ZWxsX2lkIHRvIGNvbmRpdGlvbiBuYW1lCiAgICAKICAgIFJldHVybnM6CiAgICAtLS0tLS0tLQogICAgcGQuRGF0YUZyYW1lCiAgICAgICAgVGlkeSBEYXRhRnJhbWUgd2l0aCBjb2x1bW5zOiBbJ1RpbWVfcycsICdjb25kaXRpb24nLCAnbWVhbicsICdzZCcsICdzZW0nLCAnbiddCiAgICAiIiIKICAgIGltcG9ydCBudW1weSBhcyBucAogICAgCiAgICAjIEFkZCBjb25kaXRpb24gY29sdW1uCiAgICBub3JtX2RmID0gbm9ybV9kZi5jb3B5KCkKICAgIG5vcm1fZGZbJ2NvbmRpdGlvbiddID0gbm9ybV9kZlsnd2VsbCddLm1hcChjb25kaXRpb25fbWFwKQogICAgCiAgICAjIEdyb3VwIGJ5IGNvbmRpdGlvbiBhbmQgdGltZQogICAgcmVzdWx0cyA9IFtdCiAgICAKICAgIGZvciAoY29uZGl0aW9uLCB0aW1lX3MpLCBncm91cCBpbiBub3JtX2RmLmdyb3VwYnkoWydjb25kaXRpb24nLCAndGltZV9zJ10pOgogICAgICAgIHZhbHVlcyA9IGdyb3VwWyd2YWx1ZSddLmRyb3BuYSgpLnZhbHVlcwogICAgICAgIAogICAgICAgIGlmIGxlbih2YWx1ZXMpID09IDA6CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgCiAgICAgICAgbiA9IGxlbih2YWx1ZXMpCiAgICAgICAgbWVhbiA9IG5wLm1lYW4odmFsdWVzKQogICAgICAgIHNkID0gbnAuc3RkKHZhbHVlcywgZGRvZj0xKSAgIyBTYW1wbGUgc3RhbmRhcmQgZGV2aWF0aW9uCiAgICAgICAgc2VtID0gc2QgLyBucC5zcXJ0KG4pIGlmIG4gPiAwIGVsc2UgbnAubmFuCiAgICAgICAgCiAgICAgICAgcmVzdWx0cy5hcHBlbmQoewogICAgICAgICAgICAnVGltZV9zJzogdGltZV9zLAogICAgICAgICAgICAnY29uZGl0aW9uJzogY29uZGl0aW9uLAogICAgICAgICAgICAnbWVhbic6IG1lYW4sCiAgICAgICAgICAgICdzZCc6IHNkLAogICAgICAgICAgICAnc2VtJzogc2VtLAogICAgICAgICAgICAnbic6IG4KICAgICAgICB9KQogICAgCiAgICBzdGF0c19kZiA9IHBkLkRhdGFGcmFtZShyZXN1bHRzKQogICAgcmV0dXJuIHN0YXRzX2RmLnNvcnRfdmFsdWVzKFsnY29uZGl0aW9uJywgJ1RpbWVfcyddKS5yZXNldF9pbmRleChkcm9wPVRydWUpCgoKZGVmIHBsb3RfdGltZWNvdXJzZSgKICAgIHN0YXRzX2RmOiBwZC5EYXRhRnJhbWUsCiAgICBjb25kaXRpb25zOiBMaXN0W3N0cl0gPSBOb25lLAogICAgZmlnc2l6ZTogdHVwbGUgPSAoMTAsIDYpLAogICAgc2F2ZV9wYXRoOiBzdHIgPSBOb25lLAogICAgY29uZmlnOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUKKToKICAgICIiIgogICAgR2VuZXJhdGUgdGltZS1jb3Vyc2UgcGxvdHMgd2l0aCBtZWFuIMKxIFNFTSBmb3IgZWFjaCBjb25kaXRpb24uCiAgICBVc2VzIHRyaXBsaWNhdGUgZ3JvdXAgY29sb3JzIHRvIG1hdGNoIHRoZSB3ZWIgaW50ZXJmYWNlLgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIHN0YXRzX2RmIDogcGQuRGF0YUZyYW1lCiAgICAgICAgU3RhdGlzdGljcyBEYXRhRnJhbWUgd2l0aCBjb2x1bW5zIFsnVGltZV9zJywgJ2NvbmRpdGlvbicsICdtZWFuJywgJ3NlbSddCiAgICBjb25kaXRpb25zIDogTGlzdFtzdHJdLCBvcHRpb25hbAogICAgICAgIFN1YnNldCBvZiBjb25kaXRpb25zIHRvIHBsb3QuIElmIE5vbmUsIHBsb3RzIGFsbCBjb25kaXRpb25zLgogICAgZmlnc2l6ZSA6IHR1cGxlCiAgICAgICAgRmlndXJlIHNpemUgKHdpZHRoLCBoZWlnaHQpIGluIGluY2hlcyAoZGVmYXVsdDogKDEwLCA2KSkKICAgIHNhdmVfcGF0aCA6IHN0ciwgb3B0aW9uYWwKICAgICAgICBQYXRoIHRvIHNhdmUgdGhlIGZpZ3VyZS4gSWYgTm9uZSwgZGlzcGxheXMgdGhlIHBsb3QuCiAgICBjb25maWcgOiBEaWN0W3N0ciwgQW55XSwgb3B0aW9uYWwKICAgICAgICBDb25maWd1cmF0aW9uIGRpY3Rpb25hcnkgd2l0aCAndHJpcGxpY2F0ZV9ncm91cHMnIGtleQogICAgIiIiCiAgICBpbXBvcnQgbWF0cGxvdGxpYi5weXBsb3QgYXMgcGx0CiAgICAKICAgIGlmIGNvbmZpZyBpcyBOb25lOgogICAgICAgIHNjcmlwdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgICAgICBjb25maWdfcGF0aCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAicGxhdGVfY29uZmlnLmpzb24iKQogICAgICAgIGNvbmZpZyA9IGxvYWRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgCiAgICBpZiBjb25kaXRpb25zIGlzIE5vbmU6CiAgICAgICAgY29uZGl0aW9ucyA9IHN0YXRzX2RmWydjb25kaXRpb24nXS51bmlxdWUoKQogICAgCiAgICBmaWcsIGF4ID0gcGx0LnN1YnBsb3RzKGZpZ3NpemU9Zmlnc2l6ZSkKICAgIAogICAgZm9yIGlkeCwgY29uZGl0aW9uIGluIGVudW1lcmF0ZShjb25kaXRpb25zKToKICAgICAgICBjb25kX2RhdGEgPSBzdGF0c19kZltzdGF0c19kZlsnY29uZGl0aW9uJ10gPT0gY29uZGl0aW9uXS5zb3J0X3ZhbHVlcygnVGltZV9zJykKICAgICAgICAKICAgICAgICBpZiBsZW4oY29uZF9kYXRhKSA9PSAwOgogICAgICAgICAgICBjb250aW51ZQogICAgICAgIAogICAgICAgIHRpbWVzID0gY29uZF9kYXRhWydUaW1lX3MnXS52YWx1ZXMKICAgICAgICBtZWFucyA9IGNvbmRfZGF0YVsnbWVhbiddLnZhbHVlcwogICAgICAgIHNlbXMgPSBjb25kX2RhdGFbJ3NlbSddLnZhbHVlcwogICAgICAgIAogICAgICAgICMgR2V0IGNvbG9yIGZvciB0aGlzIGNvbmRpdGlvbiAodHJpcGxpY2F0ZSBncm91cCBuYW1lKQogICAgICAgICMgVXNlIHRyaXBsaWNhdGUgZ3JvdXAgY29sb3IgaWYgY29uZGl0aW9uIG1hdGNoZXMgYSBncm91cCBuYW1lLCBvdGhlcndpc2UgdXNlIGRlZmF1bHQgcGFsZXR0ZQogICAgICAgIGNvbG9yID0gZ2V0X3RyaXBsaWNhdGVfZ3JvdXBfY29sb3IoY29uZGl0aW9uLCBjb25maWcpCiAgICAgICAgCiAgICAgICAgIyBQbG90IGxpbmUKICAgICAgICBheC5wbG90KHRpbWVzLCBtZWFucywgbGFiZWw9Y29uZGl0aW9uLCBjb2xvcj1jb2xvciwgbGluZXdpZHRoPTIpCiAgICAgICAgCiAgICAgICAgIyBQbG90IGVycm9yIGJhcnMKICAgICAgICBheC5lcnJvcmJhcigKICAgICAgICAgICAgdGltZXMsIG1lYW5zLCB5ZXJyPXNlbXMsCiAgICAgICAgICAgIGNvbG9yPWNvbG9yLAogICAgICAgICAgICBhbHBoYT0wLjUsCiAgICAgICAgICAgIGNhcHNpemU9MywKICAgICAgICAgICAgY2FwdGhpY2s9MSwKICAgICAgICAgICAgZWxpbmV3aWR0aD0xCiAgICAgICAgKQogICAgCiAgICBheC5zZXRfeGxhYmVsKCdUaW1lIChzKScsIGZvbnRzaXplPTEyKQogICAgYXguc2V0X3lsYWJlbCgnzpRGL0YnLCBmb250c2l6ZT0xMikKICAgIGF4LnNldF90aXRsZSgnVGltZSBDb3Vyc2UgYnkgQ29uZGl0aW9uJywgZm9udHNpemU9MTQpCiAgICBheC5sZWdlbmQobG9jPSdiZXN0JywgZm9udHNpemU9MTApCiAgICBheC5ncmlkKFRydWUsIGFscGhhPTAuMykKICAgIAogICAgcGx0LnRpZ2h0X2xheW91dCgpCiAgICAKICAgIGlmIHNhdmVfcGF0aDoKICAgICAgICBwbHQuc2F2ZWZpZyhzYXZlX3BhdGgsIGRwaT0zMDAsIGJib3hfaW5jaGVzPSd0aWdodCcpCiAgICAgICAgcHJpbnQoZiJQbG90IHNhdmVkIHRvIHtzYXZlX3BhdGh9IikKICAgIGVsc2U6CiAgICAgICAgcGx0LnNob3coKQogICAgCiAgICBwbHQuY2xvc2UoKQoKCmRlZiBwcmludF9iYXNlbGluZV9vcHRpb25zKCk6CiAgICAiIiIKICAgIFByaW50IGRlc2NyaXB0aW9ucyBvZiBiYXNlbGluZSBmaXR0aW5nIGFuZCBub3JtYWxpemF0aW9uIG9wdGlvbnMuCiAgICAiIiIKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoIkJBU0VMSU5FIEZJVFRJTkcgT1BUSU9OUyIpCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KCJcbjEuIExPV0VTUyAoTG9jYWxseSBXZWlnaHRlZCBTY2F0dGVycGxvdCBTbW9vdGhpbmcpIikKICAgIHByaW50KCIgICBGb3JtdWxhOiBnKHQpID0gTE9XRVNTKEZfYmFzZWxpbmUsIHRfYmFzZWxpbmUsIGZyYWMpIikKICAgIHByaW50KCIgICBXaGVuIHRvIHVzZTogQmFzZWxpbmUgaGFzIGdyYWR1YWwgZHJpZnQgb3Igbm9uLWxpbmVhciB0cmVuZHMiKQogICAgcHJpbnQoIiAgIEJlc3QgZm9yOiBOb24tbGluZWFyIGJhc2VsaW5lcyB3aXRoIHNtb290aCB0cmVuZHMiKQogICAgcHJpbnQoIiAgIFBhcmFtZXRlcnM6IikKICAgIHByaW50KCIgICAgIC0gZnJhYzogRnJhY3Rpb24gb2YgZGF0YSB1c2VkIGZvciBzbW9vdGhpbmcgKGRlZmF1bHQ6IDAuNSkiKQogICAgcHJpbnQoIiAgICAgICAqIEhpZ2hlciBmcmFjICgwLjctMC45KSA9IHNtb290aGVyLCBtb3JlIGdsb2JhbCBmaXQiKQogICAgcHJpbnQoIiAgICAgICAqIExvd2VyIGZyYWMgKDAuMi0wLjQpID0gbW9yZSBsb2NhbCwgZm9sbG93cyBkYXRhIGNsb3NlbHkiKQogICAgcHJpbnQoKQogICAgcHJpbnQoIjIuIENPTlNUQU5UICgwdGgtb3JkZXIgcG9seW5vbWlhbCkiKQogICAgcHJpbnQoIiAgIEZvcm11bGE6IGcodCkgPSBtZWFuKEZfYmFzZWxpbmUpIGZvciBhbGwgdCIpCiAgICBwcmludCgiICAgV2hlbiB0byB1c2U6IEJhc2VsaW5lIGlzIHN0YWJsZS9mbGF0IHdpdGggbWluaW1hbCBkcmlmdCIpCiAgICBwcmludCgiICAgQmVzdCBmb3I6IFN0YWJsZSBiYXNlbGluZXMgd2l0aCBubyB0aW1lLWRlcGVuZGVudCB0cmVuZHMiKQogICAgcHJpbnQoIiAgIFBhcmFtZXRlcnM6IE5vbmUiKQogICAgcHJpbnQoKQogICAgcHJpbnQoIjMuIFBPTFlOT01JQUwgKDFzdC1vcmRlciBvciBoaWdoZXIpIikKICAgIHByaW50KCIgICBGb3JtdWxhOiBnKHQpID0gY+KCgCArIGPigoF0ICsgY+KCgnTCsiArIC4uLiIpCiAgICBwcmludCgiICAgV2hlbiB0byB1c2U6IEJhc2VsaW5lIGhhcyBsaW5lYXIgb3IgcG9seW5vbWlhbCBkcmlmdCIpCiAgICBwcmludCgiICAgQmVzdCBmb3I6IEJhc2VsaW5lcyB3aXRoIGtub3duIHBvbHlub21pYWwgdHJlbmRzIikKICAgIHByaW50KCIgICBQYXJhbWV0ZXJzOiIpCiAgICBwcmludCgiICAgICAtIHBvbHlfb3JkZXI6IFBvbHlub21pYWwgb3JkZXIgKGRlZmF1bHQ6IDEgPSBsaW5lYXIpIikKICAgIHByaW50KCIgICAgICAgKiBPcmRlciAxOiBMaW5lYXIgZHJpZnQgKGcodCkgPSBj4oKAICsgY+KCgXQpIikKICAgIHByaW50KCIgICAgICAgKiBPcmRlciAyOiBRdWFkcmF0aWMgZHJpZnQgKGcodCkgPSBj4oKAICsgY+KCgXQgKyBj4oKCdMKyKSIpCiAgICBwcmludCgiICAgICAgICogSGlnaGVyIG9yZGVyczogTW9yZSBjb21wbGV4IHRyZW5kcyIpCiAgICBwcmludCgpCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KCJOT1JNQUxJWkFUSU9OIE9QVElPTlMiKQogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgiXG4xLiBERUxUQV9GX09WRVJfRiAozpRGL0YpIikKICAgIHByaW50KCIgICBGb3JtdWxhOiBGJyh0KSA9IChGKHQpIC0gZyh0KSkgLyBnKHQpIikKICAgIHByaW50KCIgICBXaGVuIHRvIHVzZTogTWVhc3VyZSByZWxhdGl2ZSBjaGFuZ2UgZnJvbSBiYXNlbGluZSIpCiAgICBwcmludCgiICAgQmVzdCBmb3I6IERldGVjdGluZyBpbmNyZWFzZXMvZGVjcmVhc2VzIHJlbGF0aXZlIHRvIGJhc2VsaW5lIikKICAgIHByaW50KCIgICBJbnRlcnByZXRhdGlvbjoiKQogICAgcHJpbnQoIiAgICAgKiBGJyh0KSA9IDA6IE5vIGNoYW5nZSBmcm9tIGJhc2VsaW5lIikKICAgIHByaW50KCIgICAgICogRicodCkgPiAwOiBJbmNyZWFzZSBhYm92ZSBiYXNlbGluZSAoZS5nLiwgMC41ID0gNTAlIGluY3JlYXNlKSIpCiAgICBwcmludCgiICAgICAqIEYnKHQpIDwgMDogRGVjcmVhc2UgYmVsb3cgYmFzZWxpbmUgKGUuZy4sIC0wLjMgPSAzMCUgZGVjcmVhc2UpIikKICAgIHByaW50KCIgICBWYWx1ZXMgY2FuIGJlIG5lZ2F0aXZlIChiZWxvdyBiYXNlbGluZSkgb3IgcG9zaXRpdmUgKGFib3ZlIGJhc2VsaW5lKSIpCiAgICBwcmludCgpCiAgICBwcmludCgiMi4gTVVMVElQTElDQVRJVkUiKQogICAgcHJpbnQoIiAgIEZvcm11bGE6IEZfbm9ybSh0KSA9IEYodCkgLyBnKHQpIikKICAgIHByaW50KCIgICBXaGVuIHRvIHVzZTogTm9ybWFsaXplIGJ5IGJhc2VsaW5lIHdpdGhvdXQgc3VidHJhY3RpbmciKQogICAgcHJpbnQoIiAgIEJlc3QgZm9yOiBGb2xkLWNoYW5nZSBhbmFseXNpcyIpCiAgICBwcmludCgiICAgSW50ZXJwcmV0YXRpb246IikKICAgIHByaW50KCIgICAgICogRl9ub3JtKHQpID0gMS4wOiBObyBjaGFuZ2UgZnJvbSBiYXNlbGluZSIpCiAgICBwcmludCgiICAgICAqIEZfbm9ybSh0KSA9IDIuMDogMi1mb2xkIGluY3JlYXNlICgxMDAlIGluY3JlYXNlKSIpCiAgICBwcmludCgiICAgICAqIEZfbm9ybSh0KSA9IDAuNTogMi1mb2xkIGRlY3JlYXNlICg1MCUgb2YgYmFzZWxpbmUpIikKICAgIHByaW50KCIgICBWYWx1ZXMgYXJlIGFsd2F5cyBwb3NpdGl2ZSAocmF0aW8gdG8gYmFzZWxpbmUpIikKICAgIHByaW50KCkKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoIlNUQVRJU1RJQ1MgQ09NUFVUQVRJT04iKQogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgiXG5Gb3IgZWFjaCBjb25kaXRpb24gYW5kIHRpbWVwb2ludCwgdGhlIGZvbGxvd2luZyBzdGF0aXN0aWNzIGFyZSBjb21wdXRlZDoiKQogICAgcHJpbnQoIiAgTWVhbjogzrwodCkgPSAoMS9uKSAqIM6jIEYnKHQpIikKICAgIHByaW50KCIgICAgQXZlcmFnZSBub3JtYWxpemVkIHZhbHVlIGFjcm9zcyBhbGwgd2VsbHMgaW4gdGhlIGNvbmRpdGlvbiIpCiAgICBwcmludCgpCiAgICBwcmludCgiICBTRDogz4ModCkgPSBzcXJ0KM6jKEYnKHQpIC0gzrwodCkpwrIgLyAobi0xKSkiKQogICAgcHJpbnQoIiAgICBTYW1wbGUgc3RhbmRhcmQgZGV2aWF0aW9uIChkZG9mPTEpIGFjcm9zcyB3ZWxscyIpCiAgICBwcmludCgpCiAgICBwcmludCgiICBTRU06IFNFTSh0KSA9IM+DKHQpIC8gc3FydChuKSIpCiAgICBwcmludCgiICAgIFN0YW5kYXJkIGVycm9yIG9mIHRoZSBtZWFuID0gU0QgLyBzcXJ0KG5fd2VsbHMpIikKICAgIHByaW50KCIgICAgTm90ZTogU0VNIGlzIGNvbXB1dGVkIGFjcm9zcyB3ZWxscywgbm90IHByb3BhZ2F0ZWQgZnJvbSBiYXNlbGluZSBlcnJvciIpCiAgICBwcmludCgpCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KCkKCgpkZWYgcHJvY2Vzc19iYXNlbGluZV9ub3JtYWxpemF0aW9uKAogICAgZGY6IHBkLkRhdGFGcmFtZSwKICAgIGJhc2VsaW5lX2VuZF90aW1lOiBmbG9hdCA9IDI0LjAsCiAgICBiYXNlbGluZV9tZXRob2Q6IHN0ciA9ICdjb25zdGFudCcsCiAgICBiYXNlbGluZV9mcmFjOiBmbG9hdCA9IDAuNSwKICAgIGJhc2VsaW5lX3BvbHlfb3JkZXI6IGludCA9IDEsCiAgICBub3JtYWxpemF0aW9uX21vZGU6IHN0ciA9ICdtdWx0aXBsaWNhdGl2ZScsCiAgICBjb25maWc6IERpY3Rbc3RyLCBBbnldID0gTm9uZSwKICAgIG91dHB1dF9kaXI6IHN0ciA9IE5vbmUKKSAtPiB0dXBsZToKICAgICIiIgogICAgQ29tcGxldGUgcGlwZWxpbmU6IGJhc2VsaW5lIGlkZW50aWZpY2F0aW9uLCBmaXR0aW5nLCBub3JtYWxpemF0aW9uLCBhbmQgc3RhdGlzdGljcy4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBkZiA6IHBkLkRhdGFGcmFtZQogICAgICAgIExvbmctZm9ybWF0IERhdGFGcmFtZSB3aXRoIGNvbHVtbnMgWydwbGF0ZV9pZCcsICd3ZWxsJywgJ2NvbnRlbnQnLCAndGltZV9zJywgJ3ZhbHVlJ10KICAgIGJhc2VsaW5lX2VuZF90aW1lIDogZmxvYXQKICAgICAgICBNYXhpbXVtIHRpbWUgKGluIHNlY29uZHMpIGZvciBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQ6IDI0LjApCiAgICBiYXNlbGluZV9tZXRob2QgOiBzdHIKICAgICAgICBCYXNlbGluZSBmaXR0aW5nIG1ldGhvZDogJ2xvd2VzcycsICdjb25zdGFudCcsIG9yICdwb2x5bm9taWFsJyAoZGVmYXVsdDogJ2NvbnN0YW50JykKICAgIGJhc2VsaW5lX2ZyYWMgOiBmbG9hdAogICAgICAgIEZyYWN0aW9uIG9mIGRhdGEgdXNlZCBmb3IgTE9XRVNTIHNtb290aGluZyAoZGVmYXVsdDogMC41KQogICAgYmFzZWxpbmVfcG9seV9vcmRlciA6IGludAogICAgICAgIFBvbHlub21pYWwgb3JkZXIgZm9yIHBvbHlub21pYWwgZml0IChkZWZhdWx0OiAxKQogICAgbm9ybWFsaXphdGlvbl9tb2RlIDogc3RyCiAgICAgICAgTm9ybWFsaXphdGlvbiBtb2RlOiAnZGVsdGFfZl9vdmVyX2YnIG9yICdtdWx0aXBsaWNhdGl2ZScgKGRlZmF1bHQ6ICdtdWx0aXBsaWNhdGl2ZScpCiAgICBjb25maWcgOiBEaWN0W3N0ciwgQW55XSwgb3B0aW9uYWwKICAgICAgICBDb25maWd1cmF0aW9uIGRpY3Rpb25hcnkuIElmIE5vbmUsIGxvYWRzIGZyb20gcGxhdGVfY29uZmlnLmpzb24KICAgIG91dHB1dF9kaXIgOiBzdHIsIG9wdGlvbmFsCiAgICAgICAgRGlyZWN0b3J5IHRvIHNhdmUgb3V0cHV0cy4gSWYgTm9uZSwgdXNlcyBjdXJyZW50IGRpcmVjdG9yeS4KICAgIAogICAgUmV0dXJuczoKICAgIC0tLS0tLS0tCiAgICB0dXBsZQogICAgICAgIChub3JtX2RmLCBzdGF0c19kZiwgYmFzZWxpbmVfZml0cykKICAgICAgICAtIG5vcm1fZGY6IE5vcm1hbGl6ZWQgRGF0YUZyYW1lCiAgICAgICAgLSBzdGF0c19kZjogQ29uZGl0aW9uIHN0YXRpc3RpY3MgRGF0YUZyYW1lCiAgICAgICAgLSBiYXNlbGluZV9maXRzOiBEaWN0aW9uYXJ5IG9mIGJhc2VsaW5lIGZpdHMgcGVyIHdlbGwKICAgICIiIgogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgiQkFTRUxJTkUgSURFTlRJRklDQVRJT04gQU5EIE5PUk1BTElaQVRJT04gUElQRUxJTkUiKQogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludChmIlxuQ3VycmVudCBTZXR0aW5nczoiKQogICAgcHJpbnQoZiIgIEJhc2VsaW5lIHdpbmRvdzogVGltZV9zIDw9IHtiYXNlbGluZV9lbmRfdGltZX0gcyIpCiAgICBwcmludChmIiAgQmFzZWxpbmUgbWV0aG9kOiB7YmFzZWxpbmVfbWV0aG9kfSIpCiAgICBpZiBiYXNlbGluZV9tZXRob2QgPT0gJ2xvd2Vzcyc6CiAgICAgICAgcHJpbnQoZiIgICAgTE9XRVNTIHNtb290aGluZyBmcmFjdGlvbiAoZnJhYyk6IHtiYXNlbGluZV9mcmFjfSIpCiAgICBlbGlmIGJhc2VsaW5lX21ldGhvZCA9PSAncG9seW5vbWlhbCc6CiAgICAgICAgcHJpbnQoZiIgICAgUG9seW5vbWlhbCBvcmRlcjoge2Jhc2VsaW5lX3BvbHlfb3JkZXJ9IikKICAgIHByaW50KGYiICBOb3JtYWxpemF0aW9uIG1vZGU6IHtub3JtYWxpemF0aW9uX21vZGV9IikKICAgIHByaW50KCkKICAgIHByaW50KCJGb3IgZGV0YWlsZWQgb3B0aW9uIGRlc2NyaXB0aW9ucywgY2FsbDogcHJpbnRfYmFzZWxpbmVfb3B0aW9ucygpIikKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoKQogICAgCiAgICAjIExvYWQgY29uZmlnIGlmIG5vdCBwcm92aWRlZAogICAgaWYgY29uZmlnIGlzIE5vbmU6CiAgICAgICAgc2NyaXB0X2RpciA9IG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmFic3BhdGgoX19maWxlX18pKQogICAgICAgIGNvbmZpZ19wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJwbGF0ZV9jb25maWcuanNvbiIpCiAgICAgICAgY29uZmlnID0gbG9hZF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAKICAgICMgRmlsdGVyIG91dCBiYWQgd2VsbHMgYmVmb3JlIHByb2Nlc3NpbmcKICAgIGJhZF93ZWxsc19saXN0ID0gY29uZmlnLmdldCgiYmFkX3dlbGxzIiwgW10pCiAgICBpZiBiYWRfd2VsbHNfbGlzdDoKICAgICAgICBvcmlnaW5hbF9jb3VudCA9IGxlbihkZikKICAgICAgICBkZiA9IGRmW35kZlsid2VsbCJdLmFwcGx5KGxhbWJkYSB3OiBpc19iYWRfd2VsbCh3LCBjb25maWcpKV0KICAgICAgICBmaWx0ZXJlZF9jb3VudCA9IGxlbihkZikKICAgICAgICBpZiBvcmlnaW5hbF9jb3VudCAhPSBmaWx0ZXJlZF9jb3VudDoKICAgICAgICAgICAgcHJpbnQoZiJFeGNsdWRpbmcge29yaWdpbmFsX2NvdW50IC0gZmlsdGVyZWRfY291bnR9IGRhdGEgcG9pbnRzIGZyb20gYmFkIHdlbGxzIiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgcHJpbnQoIlN0ZXAgMTogSWRlbnRpZnlpbmcgYmFzZWxpbmUgd2luZG93cy4uLiIsIGZsdXNoPVRydWUpCiAgICBiYXNlbGluZV93aW5kb3dzID0gaWRlbnRpZnlfYmFzZWxpbmVfd2luZG93KGRmLCBiYXNlbGluZV9lbmRfdGltZSkKICAgIHByaW50KGYiICBJZGVudGlmaWVkIGJhc2VsaW5lIHdpbmRvd3MgZm9yIHtsZW4oYmFzZWxpbmVfd2luZG93cyl9IHdlbGxzIiwgZmx1c2g9VHJ1ZSkKICAgIHRvdGFsX2Jhc2VsaW5lX3BvaW50cyA9IHN1bShsZW4oYncpIGZvciBidyBpbiBiYXNlbGluZV93aW5kb3dzLnZhbHVlcygpKQogICAgcHJpbnQoZiIgIFRvdGFsIGJhc2VsaW5lIHBvaW50czoge3RvdGFsX2Jhc2VsaW5lX3BvaW50c30iLCBmbHVzaD1UcnVlKQogICAgCiAgICBwcmludCgiU3RlcCAyOiBGaXR0aW5nIGJhc2VsaW5lcy4uLiIsIGZsdXNoPVRydWUpCiAgICBiYXNlbGluZV9maXRzID0gZml0X3dlbGxfYmFzZWxpbmVzKAogICAgICAgIGRmLAogICAgICAgIGJhc2VsaW5lX2VuZF90aW1lPWJhc2VsaW5lX2VuZF90aW1lLAogICAgICAgIG1ldGhvZD1iYXNlbGluZV9tZXRob2QsCiAgICAgICAgZnJhYz1iYXNlbGluZV9mcmFjLAogICAgICAgIHBvbHlfb3JkZXI9YmFzZWxpbmVfcG9seV9vcmRlciwKICAgICAgICBjb25maWc9Y29uZmlnCiAgICApCiAgICBwcmludChmIiAgRml0dGVkIGJhc2VsaW5lcyBmb3Ige2xlbihiYXNlbGluZV9maXRzKX0gd2VsbHMiLCBmbHVzaD1UcnVlKQogICAgCiAgICBwcmludCgiU3RlcCAzOiBOb3JtYWxpemluZyB3ZWxscy4uLiIsIGZsdXNoPVRydWUpCiAgICBub3JtX2RmID0gbm9ybWFsaXplX3dlbGxzKGRmLCBiYXNlbGluZV9maXRzLCBub3JtYWxpemF0aW9uX21vZGU9bm9ybWFsaXphdGlvbl9tb2RlKQogICAgcHJpbnQoZiIgIE5vcm1hbGl6ZWQge2xlbihub3JtX2RmKX0gZGF0YSBwb2ludHMiLCBmbHVzaD1UcnVlKQogICAgCiAgICBwcmludCgiU3RlcCA0OiBCdWlsZGluZyBjb25kaXRpb24gbWFwLi4uIiwgZmx1c2g9VHJ1ZSkKICAgIGNvbmRpdGlvbl9tYXAgPSBidWlsZF9jb25kaXRpb25fbWFwKGRmLCBjb25maWc9Y29uZmlnKQogICAgcHJpbnQoZiIgIE1hcHBlZCB7bGVuKGNvbmRpdGlvbl9tYXApfSB3ZWxscyB0byBjb25kaXRpb25zIiwgZmx1c2g9VHJ1ZSkKICAgIGNvbmRpdGlvbl9jb3VudHMgPSB7fQogICAgZm9yIHdlbGxfaWQsIGNvbmRpdGlvbiBpbiBjb25kaXRpb25fbWFwLml0ZW1zKCk6CiAgICAgICAgY29uZGl0aW9uX2NvdW50c1tjb25kaXRpb25dID0gY29uZGl0aW9uX2NvdW50cy5nZXQoY29uZGl0aW9uLCAwKSArIDEKICAgIHByaW50KGYiICBDb25kaXRpb24gZGlzdHJpYnV0aW9uOiIsIGZsdXNoPVRydWUpCiAgICBmb3IgY29uZGl0aW9uLCBjb3VudCBpbiBzb3J0ZWQoY29uZGl0aW9uX2NvdW50cy5pdGVtcygpKToKICAgICAgICBwcmludChmIiAgICB7Y29uZGl0aW9ufToge2NvdW50fSB3ZWxscyIsIGZsdXNoPVRydWUpCiAgICAKICAgIHByaW50KCJTdGVwIDU6IENvbXB1dGluZyBjb25kaXRpb24gc3RhdGlzdGljcy4uLiIsIGZsdXNoPVRydWUpCiAgICBzdGF0c19kZiA9IGNvbXB1dGVfY29uZGl0aW9uX3N0YXRpc3RpY3Mobm9ybV9kZiwgY29uZGl0aW9uX21hcCkKICAgIHByaW50KGYiICBDb21wdXRlZCBzdGF0aXN0aWNzIGZvciB7bGVuKHN0YXRzX2RmKX0gY29uZGl0aW9uLXRpbWVwb2ludCBjb21iaW5hdGlvbnMiLCBmbHVzaD1UcnVlKQogICAgCiAgICAjIFNhdmUgb3V0cHV0cyBpZiBvdXRwdXRfZGlyIGlzIHByb3ZpZGVkCiAgICBpZiBvdXRwdXRfZGlyOgogICAgICAgIGVuc3VyZV9kaXIob3V0cHV0X2RpcikKICAgICAgICAKICAgICAgICBwcmludCgiU3RlcCA2OiBTYXZpbmcgb3V0cHV0cy4uLiIsIGZsdXNoPVRydWUpCiAgICAgICAgCiAgICAgICAgIyBTYXZlIG5vcm1hbGl6ZWQgZGF0YQogICAgICAgIG5vcm1fY3N2X3BhdGggPSBvcy5wYXRoLmpvaW4ob3V0cHV0X2RpciwgIm5vcm1hbGl6ZWRfZGF0YS5jc3YiKQogICAgICAgIG5vcm1fZGYudG9fY3N2KG5vcm1fY3N2X3BhdGgsIGluZGV4PUZhbHNlKQogICAgICAgIHByaW50KGYiICBTYXZlZCBub3JtYWxpemVkIGRhdGEgdG8ge25vcm1fY3N2X3BhdGh9IiwgZmx1c2g9VHJ1ZSkKICAgICAgICAKICAgICAgICAjIFNhdmUgY29uZGl0aW9uIHN0YXRpc3RpY3MKICAgICAgICBzdGF0c19jc3ZfcGF0aCA9IG9zLnBhdGguam9pbihvdXRwdXRfZGlyLCAiY29uZGl0aW9uX3N0YXRpc3RpY3MuY3N2IikKICAgICAgICBzdGF0c19kZi50b19jc3Yoc3RhdHNfY3N2X3BhdGgsIGluZGV4PUZhbHNlKQogICAgICAgIHByaW50KGYiICBTYXZlZCBjb25kaXRpb24gc3RhdGlzdGljcyB0byB7c3RhdHNfY3N2X3BhdGh9IiwgZmx1c2g9VHJ1ZSkKICAgICAgICAKICAgICAgICAjIFNhdmUgcGxvdAogICAgICAgIHBsb3RfcGF0aCA9IG9zLnBhdGguam9pbihvdXRwdXRfZGlyLCAidGltZWNvdXJzZV9wbG90LnBuZyIpCiAgICAgICAgcGxvdF90aW1lY291cnNlKHN0YXRzX2RmLCBzYXZlX3BhdGg9cGxvdF9wYXRoLCBjb25maWc9Y29uZmlnKQogICAgICAgIHByaW50KGYiICBTYXZlZCBwbG90IHRvIHtwbG90X3BhdGh9IiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgcmV0dXJuIG5vcm1fZGYsIHN0YXRzX2RmLCBiYXNlbGluZV9maXRzCgoKZGVmIHByb21wdF9iYXNlbGluZV9zZXR0aW5ncygpOgogICAgIiIiCiAgICBQcm9tcHQgdXNlciBmb3IgYmFzZWxpbmUgYW5kIG5vcm1hbGl6YXRpb24gc2V0dGluZ3MuCiAgICBSZXR1cm5zIGEgdHVwbGUgb2YgKGJhc2VsaW5lX2VuZF90aW1lLCBiYXNlbGluZV9tZXRob2QsIGJhc2VsaW5lX2ZyYWMsIGJhc2VsaW5lX3BvbHlfb3JkZXIsIG5vcm1hbGl6YXRpb25fbW9kZSkKICAgIAogICAgSWYgc3RkaW4gaXMgbm90IGF2YWlsYWJsZSAobm9uLWludGVyYWN0aXZlIG1vZGUpIG9yIGNvbW1hbmQtbGluZSBhcmd1bWVudHMgYXJlIHByb3ZpZGVkLAogICAgcmV0dXJucyBkZWZhdWx0IHZhbHVlcyBvciB2YWx1ZXMgZnJvbSBjb21tYW5kLWxpbmUgYXJndW1lbnRzLgogICAgCiAgICBDb21tYW5kLWxpbmUgYXJndW1lbnRzIChvcHRpb25hbCk6CiAgICAgICAgLS1iYXNlbGluZS1lbmQtdGltZSBGTE9BVAogICAgICAgIC0tYmFzZWxpbmUtbWV0aG9kIHtjb25zdGFudHxsb3dlc3N8cG9seW5vbWlhbH0KICAgICAgICAtLWJhc2VsaW5lLWZyYWMgRkxPQVQgKGZvciBMT1dFU1MpCiAgICAgICAgLS1iYXNlbGluZS1wb2x5LW9yZGVyIElOVCAoZm9yIHBvbHlub21pYWwpCiAgICAgICAgLS1ub3JtYWxpemF0aW9uLW1vZGUge211bHRpcGxpY2F0aXZlfGRlbHRhX2Zfb3Zlcl9mfQogICAgIiIiCiAgICBpbXBvcnQgYXJncGFyc2UKICAgIAogICAgIyBQYXJzZSBjb21tYW5kLWxpbmUgYXJndW1lbnRzIGZpcnN0CiAgICBwYXJzZXIgPSBhcmdwYXJzZS5Bcmd1bWVudFBhcnNlcihhZGRfaGVscD1GYWxzZSkgICMgRG9uJ3Qgc2hvdyBoZWxwLCB3ZSdsbCBoYW5kbGUgcHJvbXB0cwogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgnLS1iYXNlbGluZS1lbmQtdGltZScsIHR5cGU9ZmxvYXQsIGRlZmF1bHQ9Tm9uZSkKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoJy0tYmFzZWxpbmUtbWV0aG9kJywgdHlwZT1zdHIsIGNob2ljZXM9Wydjb25zdGFudCcsICdsb3dlc3MnLCAncG9seW5vbWlhbCddLCBkZWZhdWx0PU5vbmUpCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCctLWJhc2VsaW5lLWZyYWMnLCB0eXBlPWZsb2F0LCBkZWZhdWx0PU5vbmUpCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCctLWJhc2VsaW5lLXBvbHktb3JkZXInLCB0eXBlPWludCwgZGVmYXVsdD1Ob25lKQogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgnLS1ub3JtYWxpemF0aW9uLW1vZGUnLCB0eXBlPXN0ciwgY2hvaWNlcz1bJ211bHRpcGxpY2F0aXZlJywgJ2RlbHRhX2Zfb3Zlcl9mJ10sIGRlZmF1bHQ9Tm9uZSkKICAgIAogICAgIyBQYXJzZSBrbm93biBhcmdzIG9ubHkgKGlnbm9yZSB1bmtub3duIGFyZ3MgdGhhdCBtaWdodCBiZSB1c2VkIGVsc2V3aGVyZSkKICAgIGFyZ3MsIF8gPSBwYXJzZXIucGFyc2Vfa25vd25fYXJncygpCiAgICAKICAgICMgSWYgYWxsIHNldHRpbmdzIHByb3ZpZGVkIHZpYSBjb21tYW5kLWxpbmUsIHVzZSB0aGVtIChub24taW50ZXJhY3RpdmUpCiAgICBpZiBhbGwoW2FyZ3MuYmFzZWxpbmVfZW5kX3RpbWUgaXMgbm90IE5vbmUsIGFyZ3MuYmFzZWxpbmVfbWV0aG9kIGlzIG5vdCBOb25lLCAKICAgICAgICAgICAgYXJncy5ub3JtYWxpemF0aW9uX21vZGUgaXMgbm90IE5vbmVdKToKICAgICAgICBiYXNlbGluZV9lbmRfdGltZSA9IGFyZ3MuYmFzZWxpbmVfZW5kX3RpbWUKICAgICAgICBiYXNlbGluZV9tZXRob2QgPSBhcmdzLmJhc2VsaW5lX21ldGhvZAogICAgICAgIGJhc2VsaW5lX2ZyYWMgPSBhcmdzLmJhc2VsaW5lX2ZyYWMgaWYgYXJncy5iYXNlbGluZV9mcmFjIGlzIG5vdCBOb25lIGVsc2UgMC41CiAgICAgICAgYmFzZWxpbmVfcG9seV9vcmRlciA9IGFyZ3MuYmFzZWxpbmVfcG9seV9vcmRlciBpZiBhcmdzLmJhc2VsaW5lX3BvbHlfb3JkZXIgaXMgbm90IE5vbmUgZWxzZSAxCiAgICAgICAgCiAgICAgICAgcHJpbnQoIlxu4pyTIFVzaW5nIGNvbW1hbmQtbGluZSBzZXR0aW5nczoiKQogICAgICAgIHByaW50KGYiICBCYXNlbGluZSB3aW5kb3cgZW5kIHRpbWU6IHtiYXNlbGluZV9lbmRfdGltZX0gcyIpCiAgICAgICAgcHJpbnQoZiIgIEJhc2VsaW5lIG1ldGhvZDoge2Jhc2VsaW5lX21ldGhvZH0iKQogICAgICAgIGlmIGJhc2VsaW5lX21ldGhvZCA9PSAnbG93ZXNzJzoKICAgICAgICAgICAgcHJpbnQoZiIgIExPV0VTUyBzbW9vdGhpbmcgZnJhY3Rpb246IHtiYXNlbGluZV9mcmFjfSIpCiAgICAgICAgZWxpZiBiYXNlbGluZV9tZXRob2QgPT0gJ3BvbHlub21pYWwnOgogICAgICAgICAgICBwcmludChmIiAgUG9seW5vbWlhbCBvcmRlcjoge2Jhc2VsaW5lX3BvbHlfb3JkZXJ9IikKICAgICAgICBwcmludChmIiAgTm9ybWFsaXphdGlvbiBtb2RlOiB7YXJncy5ub3JtYWxpemF0aW9uX21vZGV9XG4iKQogICAgICAgIHJldHVybiBiYXNlbGluZV9lbmRfdGltZSwgYmFzZWxpbmVfbWV0aG9kLCBiYXNlbGluZV9mcmFjLCBiYXNlbGluZV9wb2x5X29yZGVyLCBhcmdzLm5vcm1hbGl6YXRpb25fbW9kZQogICAgCiAgICAjIENoZWNrIGlmIHN0ZGluIGlzIGF2YWlsYWJsZSAoaW50ZXJhY3RpdmUgbW9kZSkKICAgIGlmIG5vdCBzeXMuc3RkaW4uaXNhdHR5KCk6CiAgICAgICAgcHJpbnQoIlxu4pqg77iPICBSdW5uaW5nIGluIG5vbi1pbnRlcmFjdGl2ZSBtb2RlLiBVc2luZyBkZWZhdWx0IHNldHRpbmdzOiIpCiAgICAgICAgcHJpbnQoIiAgQmFzZWxpbmUgd2luZG93IGVuZCB0aW1lOiAyNC4wIHMiKQogICAgICAgIHByaW50KCIgIEJhc2VsaW5lIG1ldGhvZDogY29uc3RhbnQiKQogICAgICAgIHByaW50KCIgIE5vcm1hbGl6YXRpb24gbW9kZTogbXVsdGlwbGljYXRpdmVcbiIpCiAgICAgICAgcmV0dXJuIDI0LjAsICdjb25zdGFudCcsIDAuNSwgMSwgJ211bHRpcGxpY2F0aXZlJwogICAgCiAgICBwcmludCgiXG4iICsgIj0iICogNzApCiAgICBwcmludCgiQkFTRUxJTkUgQU5EIE5PUk1BTElaQVRJT04gU0VUVElOR1MiKQogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgiXG5UaGVzZSBzZXR0aW5ncyB3aWxsIGJlIHVzZWQgZm9yIENTViBnZW5lcmF0aW9uIGFuZCBub3JtYWxpemF0aW9uLiIpCiAgICBwcmludCgiWW91IGNhbiBjaGFuZ2UgdGhlbSBsYXRlciBpbiB0aGUgd2ViIGludGVyZmFjZSBmb3IgdmlzdWFsaXphdGlvbi4iKQogICAgcHJpbnQoIihQcmVzcyBFbnRlciB0byBhY2NlcHQgZGVmYXVsdHMpXG4iKQogICAgCiAgICAjIFByb21wdCBmb3IgYmFzZWxpbmUgZW5kIHRpbWUgKHVzZSBjb21tYW5kLWxpbmUgYXJnIGlmIHByb3ZpZGVkKQogICAgYmFzZWxpbmVfZW5kX3RpbWUgPSBOb25lCiAgICBpZiBhcmdzLmJhc2VsaW5lX2VuZF90aW1lIGlzIG5vdCBOb25lOgogICAgICAgIGJhc2VsaW5lX2VuZF90aW1lID0gYXJncy5iYXNlbGluZV9lbmRfdGltZQogICAgICAgIHByaW50KGYiQmFzZWxpbmUgd2luZG93IGVuZCB0aW1lOiB7YmFzZWxpbmVfZW5kX3RpbWV9IHMgKGZyb20gY29tbWFuZC1saW5lKSIpCiAgICBlbHNlOgogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGJhc2VsaW5lX2lucHV0ID0gaW5wdXQoIkJhc2VsaW5lIHdpbmRvdyBlbmQgdGltZSAoc2Vjb25kcykgW2RlZmF1bHQ6IDI0LjBdOiAiKS5zdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBub3QgYmFzZWxpbmVfaW5wdXQ6CiAgICAgICAgICAgICAgICAgICAgYmFzZWxpbmVfZW5kX3RpbWUgPSAyNC4wCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGJhc2VsaW5lX2VuZF90aW1lID0gZmxvYXQoYmFzZWxpbmVfaW5wdXQpCiAgICAgICAgICAgICAgICAgICAgaWYgYmFzZWxpbmVfZW5kX3RpbWUgPD0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoIiAg4pqg77iPICBQbGVhc2UgZW50ZXIgYSBwb3NpdGl2ZSBudW1iZXIuIikKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGV4Y2VwdCAoVmFsdWVFcnJvciwgRU9GRXJyb3IsIEtleWJvYXJkSW50ZXJydXB0KToKICAgICAgICAgICAgICAgIHByaW50KCJcbiAg4pqg77iPICBVc2luZyBkZWZhdWx0IHZhbHVlOiAyNC4wIikKICAgICAgICAgICAgICAgIGJhc2VsaW5lX2VuZF90aW1lID0gMjQuMAogICAgICAgICAgICAgICAgYnJlYWsKICAgIAogICAgIyBQcm9tcHQgZm9yIGJhc2VsaW5lIG1ldGhvZCAodXNlIGNvbW1hbmQtbGluZSBhcmcgaWYgcHJvdmlkZWQpCiAgICBpZiBhcmdzLmJhc2VsaW5lX21ldGhvZCBpcyBub3QgTm9uZToKICAgICAgICBiYXNlbGluZV9tZXRob2QgPSBhcmdzLmJhc2VsaW5lX21ldGhvZAogICAgICAgIHByaW50KGYiXG5CYXNlbGluZSBtZXRob2Q6IHtiYXNlbGluZV9tZXRob2R9IChmcm9tIGNvbW1hbmQtbGluZSkiKQogICAgZWxzZToKICAgICAgICBwcmludCgiXG5CYXNlbGluZSBmaXR0aW5nIG1ldGhvZDoiKQogICAgICAgIHByaW50KCIgIDEuIGNvbnN0YW50IC0gTWVhbiBvZiBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQpIikKICAgICAgICBwcmludCgiICAyLiBsb3dlc3MgLSBMb2NhbGx5IFdlaWdodGVkIFNjYXR0ZXJwbG90IFNtb290aGluZyIpCiAgICAgICAgcHJpbnQoIiAgMy4gcG9seW5vbWlhbCAtIFBvbHlub21pYWwgZml0IikKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBtZXRob2RfaW5wdXQgPSBpbnB1dCgiU2VsZWN0IG1ldGhvZCBbMS0zLCBkZWZhdWx0OiAxXTogIikuc3RyaXAoKQogICAgICAgICAgICAgICAgaWYgbm90IG1ldGhvZF9pbnB1dDoKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9tZXRob2QgPSAnY29uc3RhbnQnCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsaWYgbWV0aG9kX2lucHV0ID09ICcxJzoKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9tZXRob2QgPSAnY29uc3RhbnQnCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsaWYgbWV0aG9kX2lucHV0ID09ICcyJzoKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9tZXRob2QgPSAnbG93ZXNzJwogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBlbGlmIG1ldGhvZF9pbnB1dCA9PSAnMyc6CiAgICAgICAgICAgICAgICAgICAgYmFzZWxpbmVfbWV0aG9kID0gJ3BvbHlub21pYWwnCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoIiAg4pqg77iPICBQbGVhc2UgZW50ZXIgMSwgMiwgb3IgMy4iKQogICAgICAgICAgICBleGNlcHQgKEVPRkVycm9yLCBLZXlib2FyZEludGVycnVwdCk6CiAgICAgICAgICAgICAgICBwcmludCgiXG4gIOKaoO+4jyAgVXNpbmcgZGVmYXVsdCBtZXRob2Q6IGNvbnN0YW50IikKICAgICAgICAgICAgICAgIGJhc2VsaW5lX21ldGhvZCA9ICdjb25zdGFudCcKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAKICAgICMgUHJvbXB0IGZvciBMT1dFU1MgZnJhYyAoaWYgTE9XRVNTIHNlbGVjdGVkKQogICAgaWYgYXJncy5iYXNlbGluZV9mcmFjIGlzIG5vdCBOb25lOgogICAgICAgIGJhc2VsaW5lX2ZyYWMgPSBhcmdzLmJhc2VsaW5lX2ZyYWMKICAgICAgICBpZiBiYXNlbGluZV9tZXRob2QgPT0gJ2xvd2Vzcyc6CiAgICAgICAgICAgIHByaW50KGYiTE9XRVNTIHNtb290aGluZyBmcmFjdGlvbjoge2Jhc2VsaW5lX2ZyYWN9IChmcm9tIGNvbW1hbmQtbGluZSkiKQogICAgZWxzZToKICAgICAgICBiYXNlbGluZV9mcmFjID0gMC41CiAgICAgICAgaWYgYmFzZWxpbmVfbWV0aG9kID09ICdsb3dlc3MnOgogICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGZyYWNfaW5wdXQgPSBpbnB1dCgiTE9XRVNTIHNtb290aGluZyBmcmFjdGlvbiAoMC4xLTEuMCkgW2RlZmF1bHQ6IDAuNV06ICIpLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgZnJhY19pbnB1dDoKICAgICAgICAgICAgICAgICAgICAgICAgYmFzZWxpbmVfZnJhYyA9IDAuNQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2VsaW5lX2ZyYWMgPSBmbG9hdChmcmFjX2lucHV0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiBiYXNlbGluZV9mcmFjIDwgMC4xIG9yIGJhc2VsaW5lX2ZyYWMgPiAxLjA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludCgiICDimqDvuI8gIFBsZWFzZSBlbnRlciBhIHZhbHVlIGJldHdlZW4gMC4xIGFuZCAxLjAuIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGV4Y2VwdCAoVmFsdWVFcnJvciwgRU9GRXJyb3IsIEtleWJvYXJkSW50ZXJydXB0KToKICAgICAgICAgICAgICAgICAgICBwcmludCgiXG4gIOKaoO+4jyAgVXNpbmcgZGVmYXVsdCB2YWx1ZTogMC41IikKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9mcmFjID0gMC41CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgIAogICAgIyBQcm9tcHQgZm9yIHBvbHlub21pYWwgb3JkZXIgKGlmIHBvbHlub21pYWwgc2VsZWN0ZWQpCiAgICBpZiBhcmdzLmJhc2VsaW5lX3BvbHlfb3JkZXIgaXMgbm90IE5vbmU6CiAgICAgICAgYmFzZWxpbmVfcG9seV9vcmRlciA9IGFyZ3MuYmFzZWxpbmVfcG9seV9vcmRlcgogICAgICAgIGlmIGJhc2VsaW5lX21ldGhvZCA9PSAncG9seW5vbWlhbCc6CiAgICAgICAgICAgIHByaW50KGYiUG9seW5vbWlhbCBvcmRlcjoge2Jhc2VsaW5lX3BvbHlfb3JkZXJ9IChmcm9tIGNvbW1hbmQtbGluZSkiKQogICAgZWxzZToKICAgICAgICBiYXNlbGluZV9wb2x5X29yZGVyID0gMQogICAgICAgIGlmIGJhc2VsaW5lX21ldGhvZCA9PSAncG9seW5vbWlhbCc6CiAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgb3JkZXJfaW5wdXQgPSBpbnB1dCgiUG9seW5vbWlhbCBvcmRlciAoMS01KSBbZGVmYXVsdDogMV06ICIpLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgb3JkZXJfaW5wdXQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2VsaW5lX3BvbHlfb3JkZXIgPSAxCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgYmFzZWxpbmVfcG9seV9vcmRlciA9IGludChvcmRlcl9pbnB1dCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYmFzZWxpbmVfcG9seV9vcmRlciA8IDEgb3IgYmFzZWxpbmVfcG9seV9vcmRlciA+IDU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludCgiICDimqDvuI8gIFBsZWFzZSBlbnRlciBhIHZhbHVlIGJldHdlZW4gMSBhbmQgNS4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgZXhjZXB0IChWYWx1ZUVycm9yLCBFT0ZFcnJvciwgS2V5Ym9hcmRJbnRlcnJ1cHQpOgogICAgICAgICAgICAgICAgICAgIHByaW50KCJcbiAg4pqg77iPICBVc2luZyBkZWZhdWx0IHZhbHVlOiAxIikKICAgICAgICAgICAgICAgICAgICBiYXNlbGluZV9wb2x5X29yZGVyID0gMQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAKICAgICMgUHJvbXB0IGZvciBub3JtYWxpemF0aW9uIG1vZGUgKHVzZSBjb21tYW5kLWxpbmUgYXJnIGlmIHByb3ZpZGVkKQogICAgaWYgYXJncy5ub3JtYWxpemF0aW9uX21vZGUgaXMgbm90IE5vbmU6CiAgICAgICAgbm9ybWFsaXphdGlvbl9tb2RlID0gYXJncy5ub3JtYWxpemF0aW9uX21vZGUKICAgICAgICBwcmludChmIlxuTm9ybWFsaXphdGlvbiBtb2RlOiB7bm9ybWFsaXphdGlvbl9tb2RlfSAoZnJvbSBjb21tYW5kLWxpbmUpIikKICAgIGVsc2U6CiAgICAgICAgcHJpbnQoIlxuTm9ybWFsaXphdGlvbiBtb2RlOiIpCiAgICAgICAgcHJpbnQoIiAgMS4gbXVsdGlwbGljYXRpdmUgLSBGKHQpIC8gZyh0KSAoZGVmYXVsdCkiKQogICAgICAgIHByaW50KCIgIDIuIGRlbHRhX2Zfb3Zlcl9mIC0gKEYodCkgLSBnKHQpKSAvIGcodCkiKQogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG5vcm1faW5wdXQgPSBpbnB1dCgiU2VsZWN0IG1vZGUgWzEtMiwgZGVmYXVsdDogMV06ICIpLnN0cmlwKCkKICAgICAgICAgICAgICAgIGlmIG5vdCBub3JtX2lucHV0OgogICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6YXRpb25fbW9kZSA9ICdtdWx0aXBsaWNhdGl2ZScKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgZWxpZiBub3JtX2lucHV0ID09ICcxJzoKICAgICAgICAgICAgICAgICAgICBub3JtYWxpemF0aW9uX21vZGUgPSAnbXVsdGlwbGljYXRpdmUnCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsaWYgbm9ybV9pbnB1dCA9PSAnMic6CiAgICAgICAgICAgICAgICAgICAgbm9ybWFsaXphdGlvbl9tb2RlID0gJ2RlbHRhX2Zfb3Zlcl9mJwogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHByaW50KCIgIOKaoO+4jyAgUGxlYXNlIGVudGVyIDEgb3IgMi4iKQogICAgICAgICAgICBleGNlcHQgKEVPRkVycm9yLCBLZXlib2FyZEludGVycnVwdCk6CiAgICAgICAgICAgICAgICBwcmludCgiXG4gIOKaoO+4jyAgVXNpbmcgZGVmYXVsdCBtb2RlOiBtdWx0aXBsaWNhdGl2ZSIpCiAgICAgICAgICAgICAgICBub3JtYWxpemF0aW9uX21vZGUgPSAnbXVsdGlwbGljYXRpdmUnCiAgICAgICAgICAgICAgICBicmVhawogICAgCiAgICAjIE9ubHkgcHJpbnQgc3VtbWFyeSBpZiB3ZSBwcm9tcHRlZCAobm90IGlmIGFsbCBzZXR0aW5ncyBjYW1lIGZyb20gY29tbWFuZC1saW5lKQogICAgaWYgbm90IGFsbChbYXJncy5iYXNlbGluZV9lbmRfdGltZSBpcyBub3QgTm9uZSwgYXJncy5iYXNlbGluZV9tZXRob2QgaXMgbm90IE5vbmUsIAogICAgICAgICAgICAgICAgYXJncy5ub3JtYWxpemF0aW9uX21vZGUgaXMgbm90IE5vbmVdKToKICAgICAgICBwcmludCgiXG4iICsgIj0iICogNzApCiAgICAgICAgcHJpbnQoIlNFTEVDVEVEIFNFVFRJTkdTOiIpCiAgICAgICAgcHJpbnQoZiIgIEJhc2VsaW5lIHdpbmRvdyBlbmQgdGltZToge2Jhc2VsaW5lX2VuZF90aW1lfSBzIikKICAgICAgICBwcmludChmIiAgQmFzZWxpbmUgbWV0aG9kOiB7YmFzZWxpbmVfbWV0aG9kfSIpCiAgICAgICAgaWYgYmFzZWxpbmVfbWV0aG9kID09ICdsb3dlc3MnOgogICAgICAgICAgICBwcmludChmIiAgTE9XRVNTIHNtb290aGluZyBmcmFjdGlvbjoge2Jhc2VsaW5lX2ZyYWN9IikKICAgICAgICBlbGlmIGJhc2VsaW5lX21ldGhvZCA9PSAncG9seW5vbWlhbCc6CiAgICAgICAgICAgIHByaW50KGYiICBQb2x5bm9taWFsIG9yZGVyOiB7YmFzZWxpbmVfcG9seV9vcmRlcn0iKQogICAgICAgIHByaW50KGYiICBOb3JtYWxpemF0aW9uIG1vZGU6IHtub3JtYWxpemF0aW9uX21vZGV9IikKICAgICAgICBwcmludCgiPSIgKiA3MCArICJcbiIpCiAgICAKICAgIHJldHVybiBiYXNlbGluZV9lbmRfdGltZSwgYmFzZWxpbmVfbWV0aG9kLCBiYXNlbGluZV9mcmFjLCBiYXNlbGluZV9wb2x5X29yZGVyLCBub3JtYWxpemF0aW9uX21vZGUKCgpkZWYgbWFpbigpOgogICAgIyBVc2UgdGhlIGRpcmVjdG9yeSB3aGVyZSB0aGlzIHNjcmlwdCBsaXZlcyBhcyB0aGUgd29ya2luZyBkaXJlY3RvcnkKICAgIHNjcmlwdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgIG9zLmNoZGlyKHNjcmlwdF9kaXIpCiAgICAKICAgICMgUHJvbXB0IGZvciBiYXNlbGluZSBhbmQgbm9ybWFsaXphdGlvbiBzZXR0aW5ncwogICAgYmFzZWxpbmVfZW5kX3RpbWUsIGJhc2VsaW5lX21ldGhvZCwgYmFzZWxpbmVfZnJhYywgYmFzZWxpbmVfcG9seV9vcmRlciwgbm9ybWFsaXphdGlvbl9tb2RlID0gcHJvbXB0X2Jhc2VsaW5lX3NldHRpbmdzKCkKCiAgICAjIEZpbmQgRXhjZWwgZmlsZXMgaW4gdGhpcyBkaXJlY3RvcnkKICAgIGV4Y2VsX2ZpbGVzID0gWwogICAgICAgIGYgZm9yIGYgaW4gb3MubGlzdGRpcigiLiIpCiAgICAgICAgaWYgZi5sb3dlcigpLmVuZHN3aXRoKCIueGxzeCIpIGFuZCBub3QgZi5zdGFydHN3aXRoKCJ+JCIpCiAgICBdCgogICAgaWYgbm90IGV4Y2VsX2ZpbGVzOgogICAgICAgIHByaW50KCJObyAueGxzeCBmaWxlcyBmb3VuZCBpbiB0aGlzIGZvbGRlci4iLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAgICAgc3lzLmV4aXQoMSkKICAgIAogICAgIyBWYWxpZGF0ZSBmaWxlbmFtZSBmb3JtYXRzIGJlZm9yZSBwcm9jZXNzaW5nCiAgICBwcmludCgiU3RhcnRpbmcgcGxhdGUgdmlld2VyIHNjcmlwdC4uLiIsIGZsdXNoPVRydWUpCiAgICBwcmludCgiVmFsaWRhdGluZyBmaWxlbmFtZSBmb3JtYXRzLi4uIiwgZmx1c2g9VHJ1ZSkKICAgIGludmFsaWRfZmlsZXMgPSBbXQogICAgZm9yIGZuYW1lIGluIGV4Y2VsX2ZpbGVzOgogICAgICAgIHRyeToKICAgICAgICAgICAgdmFsaWRhdGVfZmlsZW5hbWVfZm9ybWF0KGZuYW1lKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yIGFzIGU6CiAgICAgICAgICAgIGludmFsaWRfZmlsZXMuYXBwZW5kKChmbmFtZSwgc3RyKGUpKSkKICAgIAogICAgaWYgaW52YWxpZF9maWxlczoKICAgICAgICBwcmludCgiXG7inYwgRVJST1I6IEludmFsaWQgZmlsZW5hbWUgZm9ybWF0KHMpIGRldGVjdGVkOiIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBmb3IgZm5hbWUsIGVycm9yX21zZyBpbiBpbnZhbGlkX2ZpbGVzOgogICAgICAgICAgICBwcmludChmIlxuRmlsZToge2ZuYW1lfSIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICAgICAgcHJpbnQoZXJyb3JfbXNnLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAgICAgcHJpbnQoIlxuUGxlYXNlIHJlbmFtZSB0aGUgZmlsZShzKSB0byBtYXRjaCB0aGUgZXhwZWN0ZWQgZm9ybWF0IGFuZCByZXJ1biB0aGUgc2NyaXB0LiIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBzeXMuZXhpdCgxKQogICAgCiAgICBwcmludChmIuKckyBBbGwge2xlbihleGNlbF9maWxlcyl9IGZpbGUocykgaGF2ZSB2YWxpZCBmaWxlbmFtZSBmb3JtYXRzIiwgZmx1c2g9VHJ1ZSkKCiAgICBhbGxfcGxhdGVzOiBEaWN0W3N0ciwgcGQuRGF0YUZyYW1lXSA9IHt9CiAgICBjc3Zfcm9vdCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAiY3N2IikKICAgIAogICAgIyBMb2FkIGNvbmZpZ3VyYXRpb24gZmlsZSBlYXJseSBzbyBpdCBjYW4gYmUgdXNlZCBmb3IgQ1NWIGdlbmVyYXRpb24KICAgIGNvbmZpZ19wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJwbGF0ZV9jb25maWcuanNvbiIpCiAgICBjb25maWcgPSBsb2FkX2NvbmZpZyhjb25maWdfcGF0aCkKICAgIAogICAgIyBUcmFjayBwbGF0ZV9pZHMgYW5kIHRoZWlyIHNvdXJjZSBmaWxlcyB0byBkZXRlY3QgZHVwbGljYXRlcwogICAgcGxhdGVfaWRfdG9fZmlsZXM6IERpY3Rbc3RyLCBMaXN0W3N0cl1dID0ge30KICAgICMgVHJhY2sgcGxhdGVfaWQgdG8gb3JpZ2luYWwgZmlsZW5hbWUgbWFwcGluZwogICAgcGxhdGVfaWRfdG9fZmlsZW5hbWU6IERpY3Rbc3RyLCBzdHJdID0ge30KCiAgICBmb3IgaWR4LCBmbmFtZSBpbiBlbnVtZXJhdGUoZXhjZWxfZmlsZXMsIDEpOgogICAgICAgIHByaW50KGYiXG5be2lkeH0ve2xlbihleGNlbF9maWxlcyl9XSBQcm9jZXNzaW5nIHtmbmFtZX0uLi4iLCBmbHVzaD1UcnVlKQogICAgICAgIHBhdGggPSBvcy5wYXRoLmpvaW4oc2NyaXB0X2RpciwgZm5hbWUpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb25nX2RmID0gcGFyc2VfcGxhdGVfZmlsZShwYXRoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJFcnJvciBwYXJzaW5nIHtmbmFtZX06IHtlfSIsIGZpbGU9c3lzLnN0ZGVyciwgZmx1c2g9VHJ1ZSkKICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgcGxhdGVfaWQgPSBsb25nX2RmWyJwbGF0ZV9pZCJdLmlsb2NbMF0KICAgICAgICAKICAgICAgICAjIFRyYWNrIHdoaWNoIGZpbGVzIHByb2R1Y2Ugd2hpY2ggcGxhdGVfaWQKICAgICAgICBpZiBwbGF0ZV9pZCBub3QgaW4gcGxhdGVfaWRfdG9fZmlsZXM6CiAgICAgICAgICAgIHBsYXRlX2lkX3RvX2ZpbGVzW3BsYXRlX2lkXSA9IFtdCiAgICAgICAgcGxhdGVfaWRfdG9fZmlsZXNbcGxhdGVfaWRdLmFwcGVuZChmbmFtZSkKICAgICAgICAKICAgICAgICAjIFRyYWNrIGZpbGVuYW1lIGZvciB0aGlzIHBsYXRlX2lkICh1c2UgZmlyc3Qgb2NjdXJyZW5jZSkKICAgICAgICBpZiBwbGF0ZV9pZCBub3QgaW4gcGxhdGVfaWRfdG9fZmlsZW5hbWU6CiAgICAgICAgICAgIHBsYXRlX2lkX3RvX2ZpbGVuYW1lW3BsYXRlX2lkXSA9IGZuYW1lCiAgICAgICAgCiAgICAgICAgIyBJZiB0aGlzIHBsYXRlX2lkIGFscmVhZHkgZXhpc3RzLCBtYWtlIGl0IHVuaXF1ZSBieSBhcHBlbmRpbmcgZmlsZW5hbWUKICAgICAgICBpZiBwbGF0ZV9pZCBpbiBhbGxfcGxhdGVzOgogICAgICAgICAgICAjIFRoaXMgaXMgYSBkdXBsaWNhdGUgLSB3ZSdsbCBoYW5kbGUgaXQgYmVsb3cKICAgICAgICAgICAgcGFzcwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGFsbF9wbGF0ZXNbcGxhdGVfaWRdID0gbG9uZ19kZgogICAgICAgICAgICB3cml0ZV9jc3ZzX2Zvcl9wbGF0ZSgKICAgICAgICAgICAgICAgIGxvbmdfZGYsIAogICAgICAgICAgICAgICAgY3N2X3Jvb3QsIAogICAgICAgICAgICAgICAgY29uZmlnLCAKICAgICAgICAgICAgICAgIGZuYW1lLAogICAgICAgICAgICAgICAgYmFzZWxpbmVfZW5kX3RpbWU9YmFzZWxpbmVfZW5kX3RpbWUsCiAgICAgICAgICAgICAgICBiYXNlbGluZV9tZXRob2Q9YmFzZWxpbmVfbWV0aG9kLAogICAgICAgICAgICAgICAgYmFzZWxpbmVfZnJhYz1iYXNlbGluZV9mcmFjLAogICAgICAgICAgICAgICAgYmFzZWxpbmVfcG9seV9vcmRlcj1iYXNlbGluZV9wb2x5X29yZGVyLAogICAgICAgICAgICAgICAgbm9ybWFsaXphdGlvbl9tb2RlPW5vcm1hbGl6YXRpb25fbW9kZQogICAgICAgICAgICApCgogICAgIyBDaGVjayBmb3IgZHVwbGljYXRlcyBhbmQgd2FybgogICAgZHVwbGljYXRlc19mb3VuZCA9IEZhbHNlCiAgICBmb3IgcGxhdGVfaWQsIGZpbGVzIGluIHBsYXRlX2lkX3RvX2ZpbGVzLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGZpbGVzKSA+IDE6CiAgICAgICAgICAgIGR1cGxpY2F0ZXNfZm91bmQgPSBUcnVlCiAgICAgICAgICAgIHByaW50KGYiXG7imqDvuI8gIFdBUk5JTkc6IER1cGxpY2F0ZSBkYXRhc2V0IGRldGVjdGVkISIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICAgICAgcHJpbnQoZiIgICBQbGF0ZSBJRCAne3BsYXRlX2lkfScgaXMgcHJvZHVjZWQgYnkgbXVsdGlwbGUgZmlsZXM6IiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgICAgICBmb3IgZiBpbiBmaWxlczoKICAgICAgICAgICAgICAgIHByaW50KGYiICAgICAtIHtmfSIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICAgICAgcHJpbnQoZiIgICBQbGVhc2UgZGVsZXRlIHRoZSBkdXBsaWNhdGUgZmlsZShzKSBhbmQgcmVydW4gdGhlIHNjcmlwdC4iLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAKICAgIGlmIGR1cGxpY2F0ZXNfZm91bmQ6CiAgICAgICAgcHJpbnQoIlxu4pqg77iPICBFUlJPUjogRHVwbGljYXRlIGRhdGFzZXRzIGZvdW5kLiBQbGVhc2UgZGVsZXRlIGR1cGxpY2F0ZXMgYW5kIHJlcnVuLiIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBwcmludCgiICAgT25seSB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBlYWNoIGR1cGxpY2F0ZSB3aWxsIGJlIGluY2x1ZGVkLiIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBzeXMuZXhpdCgxKQoKICAgIGlmIG5vdCBhbGxfcGxhdGVzOgogICAgICAgIHByaW50KCJObyBwbGF0ZXMgd2VyZSBzdWNjZXNzZnVsbHkgcGFyc2VkLiIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBzeXMuZXhpdCgxKQogICAgCiAgICBwcmludChmIlxu4pyTIFN1Y2Nlc3NmdWxseSBsb2FkZWQge2xlbihhbGxfcGxhdGVzKX0gZGF0YXNldChzKToiLCBmbHVzaD1UcnVlKQogICAgZm9yIHBsYXRlX2lkIGluIHNvcnRlZChhbGxfcGxhdGVzLmtleXMoKSk6CiAgICAgICAgcHJpbnQoZiIgICAtIHtwbGF0ZV9pZH0iLCBmbHVzaD1UcnVlKQoKICAgICMgQ29uZmlnIGFscmVhZHkgbG9hZGVkIGFib3ZlCgogICAgIyBCdWlsZCBKU09OIGZvciB2aWV3ZXIKICAgIHdlYl9kaXIgPSBvcy5wYXRoLmpvaW4oc2NyaXB0X2RpciwgIndlYiIpCiAgICBlbnN1cmVfZGlyKHdlYl9kaXIpCiAgICBqc29uX3BhdGggPSBvcy5wYXRoLmpvaW4od2ViX2RpciwgInZpZXdlcl9kYXRhLmpzb24iKQogICAgYnVpbGRfdmlld2VyX2pzb24oYWxsX3BsYXRlcywganNvbl9wYXRoLCBjb25maWcsIHBsYXRlX2lkX3RvX2ZpbGVuYW1lKQoKICAgICMgV3JpdGUgSFRNTAogICAgaHRtbF9wYXRoID0gb3MucGF0aC5qb2luKHdlYl9kaXIsICJpbmRleC5odG1sIikKICAgIHdyaXRlX2h0bWwoaHRtbF9wYXRoKQoKICAgICMgQ3JlYXRlIGRvdWJsZS1jbGlja2FibGUgd2ViLmNvbW1hbmQgZmlsZQogICAgd2ViX2NvbW1hbmRfcGF0aCA9IHdyaXRlX3dlYl9jb21tYW5kKHNjcmlwdF9kaXIsIHdlYl9kaXIpCgogICAgcHJpbnQoIkRvbmUuIiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KCJHZW5lcmF0ZWQ6IiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KGYiICBDU1ZzIGluOiB7Y3N2X3Jvb3R9IiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KGYiICBXZWIgdmlld2VyOiB7aHRtbF9wYXRofSIsIGZsdXNoPVRydWUpCiAgICBwcmludChmIiAgV2ViIGxhdW5jaGVyOiB7d2ViX2NvbW1hbmRfcGF0aH0iLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoIlxuVG8gdmlldyB0aGUgcGxhdGVzOiIsIGZsdXNoPVRydWUpCiAgICBwcmludChmIiAgRG91YmxlLWNsaWNrICd3ZWIuY29tbWFuZCcgaW4gRmluZGVyLCBvciIsIGZsdXNoPVRydWUpCiAgICBwcmludChmIiAgUnVuOiAuL3dlYi5jb21tYW5kIiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KCJUaGUgYnJvd3NlciB3aWxsIG9wZW4gYXV0b21hdGljYWxseS4iLCBmbHVzaD1UcnVlKQoKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICBtYWluKCk="
		
		-- Prompt user for baseline and normalization settings
		set baselineEndTime to "24.0"
		set baselineMethod to "constant"
		set baselineFrac to "0.5"
		set baselinePolyOrder to "1"
		set normalizationMode to "multiplicative"
		
		-- Prompt for baseline window end time
		try
			set baselineEndTimeInput to text returned of (display dialog "Baseline window end time (seconds):" default answer baselineEndTime with title "Baseline Settings" buttons {"Cancel", "OK"} default button "OK")
			if baselineEndTimeInput is not "" then
				set baselineEndTime to baselineEndTimeInput
			end if
		on error
			-- User cancelled, use default
		end try
		
		-- Prompt for baseline method
		try
			set baselineMethodChoice to choose from list {"constant", "lowess", "polynomial"} with title "Baseline Fitting Method" with prompt "Select baseline fitting method:" default items {baselineMethod} without multiple selections allowed and empty selection allowed
			if baselineMethodChoice is not false then
				set baselineMethod to item 1 of baselineMethodChoice
			end if
		on error
			-- User cancelled, use default
		end try
		
		-- Prompt for LOWESS frac if LOWESS selected
		if baselineMethod is "lowess" then
			try
				set baselineFracInput to text returned of (display dialog "LOWESS smoothing fraction (0.1-1.0):" default answer baselineFrac with title "LOWESS Settings" buttons {"Cancel", "OK"} default button "OK")
				if baselineFracInput is not "" then
					set baselineFrac to baselineFracInput
				end if
			on error
				-- User cancelled, use default
			end try
		end if
		
		-- Prompt for polynomial order if polynomial selected
		if baselineMethod is "polynomial" then
			try
				set baselinePolyOrderInput to text returned of (display dialog "Polynomial order (1-5):" default answer baselinePolyOrder with title "Polynomial Settings" buttons {"Cancel", "OK"} default button "OK")
				if baselinePolyOrderInput is not "" then
					set baselinePolyOrder to baselinePolyOrderInput
				end if
			on error
				-- User cancelled, use default
			end try
		end if
		
		-- Prompt for normalization mode
		try
			set normalizationModeChoice to choose from list {"multiplicative", "delta_f_over_f"} with title "Normalization Mode" with prompt "Select normalization mode:" default items {normalizationMode} without multiple selections allowed and empty selection allowed
			if normalizationModeChoice is not false then
				set normalizationMode to item 1 of normalizationModeChoice
			end if
		on error
			-- User cancelled, use default
		end try
		
		-- Build command-line arguments (properly quoted)
		set pythonArgs to "--baseline-end-time " & quoted form of baselineEndTime & " --baseline-method " & quoted form of baselineMethod & " --normalization-mode " & quoted form of normalizationMode
		if baselineMethod is "lowess" then
			set pythonArgs to pythonArgs & " --baseline-frac " & quoted form of baselineFrac
		end if
		if baselineMethod is "polynomial" then
			set pythonArgs to pythonArgs & " --baseline-poly-order " & quoted form of baselinePolyOrder
		end if
		
		-- Decode and execute the Python code with command-line arguments
		do shell script "cd " & quoted form of folderPath & " && echo " & quoted form of pythonCodeBase64 & " | base64 -d | python3 - " & pythonArgs
		
		display notification "Plate viewer script completed successfully!" with title "Plate Viewer"
		
	on error errMsg
		display alert "Error" message errMsg
	end try
	
	return input
end run
