-- AppleScript to run plate_viewer.py
-- The Python code is embedded directly in this script (base64 encoded)
-- Required packages will be installed automatically if needed

on run {input, parameters}
	try
		-- Get the selected folder from Finder or Automator
		if input is {} or input is missing value or (count of input) = 0 then
			set selectedFolder to choose folder with prompt "Select a folder containing .xlsx files:"
			if selectedFolder is {} then
				return
			end if
		else
			set selectedFolder to item 1 of input
		end if
		
		-- Get the folder path
		set folderPath to POSIX path of selectedFolder
		
		-- Remove trailing slash if present
		if folderPath ends with "/" then
			set folderPath to text 1 thru -2 of folderPath
		end if
		
		-- Install required Python packages if needed
		set requiredPackages to "pandas numpy scipy matplotlib openpyxl"
		
		-- Try installation with different methods (in order of preference)
		set installSuccess to false
		set lastError to ""
		
		-- Method 1: Try with --user flag (works on most systems, safest)
		try
			do shell script "python3 -m pip install --user " & requiredPackages & " 2>&1"
			set installSuccess to true
		on error installError1
			set lastError to installError1
			-- Method 2: Check Python version and try with --break-system-packages if supported
			try
				set pythonVersion to (do shell script "python3 --version 2>&1 | awk '{print $2}'")
				set pythonMajor to (do shell script "echo " & quoted form of pythonVersion & " | cut -d. -f1")
				set pythonMinor to (do shell script "echo " & quoted form of pythonVersion & " | cut -d. -f2")
				
				if (pythonMajor as integer) >= 3 and (pythonMinor as integer) >= 11 then
					-- Python 3.11+, try with --break-system-packages --user
					try
						do shell script "python3 -m pip install --break-system-packages --user " & requiredPackages & " 2>&1"
						set installSuccess to true
					on error installError2
						set lastError to installError2
						-- Try with --break-system-packages without --user
						try
							do shell script "python3 -m pip install --break-system-packages " & requiredPackages & " 2>&1"
							set installSuccess to true
						on error installError3
							set lastError to installError3
						end try
					end try
				end if
			on error
				-- Version check failed, continue to next method
			end try
			
			-- Method 3: If still not successful, try without any flags (may work if pip is configured)
			if not installSuccess then
				try
					do shell script "python3 -m pip install " & requiredPackages & " 2>&1"
					set installSuccess to true
				on error installError4
					set lastError to installError4
				end try
			end if
			
			-- If all methods failed, show warning but continue
			if not installSuccess then
				display alert "Warning" message "Could not install required packages automatically.\n\nLast error: " & lastError & "\n\nPlease install manually: " & requiredPackages & "\n\nRun: python3 -m pip install --user " & requiredPackages buttons {"Continue", "Cancel"} default button "Continue" as warning
				if button returned of result is "Cancel" then
					return
				end if
			end if
		end try
		
		-- Embedded Python code (base64 encoded)
		set pythonCodeBase64 to "+IDMgZWxzZSAiIgogICAgbnVtYmVyID0gcGFydHNbNF0gaWYgbGVuKHBhcnRzKSA+IDQgZWxzZSAiIgogICAgCiAgICAjIENvbHVtbiBncm91cCBpcyBhbHdheXMgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXIgKGZpcnN0IDMgcGFydHMpCiAgICBjb2x1bW5fZ3JvdXAgPSBmIntwcm90ZWlufV97Z2Vub3R5cGV9X3tidWZmZXJ9IgogICAgCiAgICByZXR1cm4gewogICAgICAgICJjb2x1bW5fZ3JvdXAiOiBjb2x1bW5fZ3JvdXAsCiAgICAgICAgInByb3RlaW4iOiBwcm90ZWluLAogICAgICAgICJnZW5vdHlwZSI6IGdlbm90eXBlLAogICAgICAgICJidWZmZXIiOiBidWZmZXIsCiAgICAgICAgInNjaWVudGlzdCI6IHNjaWVudGlzdCwKICAgICAgICAibnVtYmVyIjogbnVtYmVyCiAgICB9CiAgICAKICAgICMgSWYgd2UgaGF2ZSBhdCBsZWFzdCAzIHBhcnRzLCB1c2UgZmlyc3QgMyBmb3IgY29sdW1uX2dyb3VwIChwcm90ZWluX2dlbm90eXBlX2J1ZmZlcikKICAgICMgVGhpcyBoYW5kbGVzIGNhc2VzIGxpa2UgIlBMQ2JfV1RfRUdUQV9NQyIgKDQgcGFydHMpIG9yICJQTENiX1dUX0VHVEFfTUNfMTMiICg1IHBhcnRzKQogICAgcHJvdGVpbiA9IHBhcnRzWzBdCiAgICBnZW5vdHlwZSA9IHBhcnRzWzFdCiAgICBidWZmZXIgPSBwYXJ0c1syXQogICAgc2NpZW50aXN0ID0gcGFydHNbM10gaWYgbGVuKHBhcnRzKSA+IDMgZWxzZSAiIgogICAgbnVtYmVyID0gcGFydHNbNF0gaWYgbGVuKHBhcnRzKSA+IDQgZWxzZSAiIgogICAgCiAgICAjIENvbHVtbiBncm91cCBpcyBhbHdheXMgcHJvdGVpbl9nZW5vdHlwZV9idWZmZXIgKGZpcnN0IDMgcGFydHMpCiAgICBjb2x1bW5fZ3JvdXAgPSBmIntwcm90ZWlufV97Z2Vub3R5cGV9X3tidWZmZXJ9IgogICAgCiAgICByZXR1cm4gewogICAgICAgICJjb2x1bW5fZ3JvdXAiOiBjb2x1bW5fZ3JvdXAsCiAgICAgICAgInByb3RlaW4iOiBwcm90ZWluLAogICAgICAgICJnZW5vdHlwZSI6IGdlbm90eXBlLAogICAgICAgICJidWZmZXIiOiBidWZmZXIsCiAgICAgICAgInNjaWVudGlzdCI6IHNjaWVudGlzdCwKICAgICAgICAibnVtYmVyIjogbnVtYmVyCiAgICB9CiAgICAKCgpkZWYgZmluZF9oZWFkZXJfYW5kX3RpbWVfcm93cyhkZjogcGQuRGF0YUZyYW1lKSAtPiAoaW50LCBpbnQpOgogICAgIiIiCiAgICBGaW5kIHRoZSAnV2VsbCcgaGVhZGVyIHJvdyBhbmQgdGhlICdUaW1lIFtzXScgcm93LgogICAgUmV0dXJucyAoaGVhZGVyX3Jvd19pbmRleCwgdGltZV9yb3dfaW5kZXgpLgogICAgIiIiCiAgICBoZWFkZXJfcm93X2lkeCA9IE5vbmUKICAgIHRpbWVfcm93X2lkeCA9IE5vbmUKCiAgICBmb3IgaSBpbiByYW5nZShsZW4oZGYpKToKICAgICAgICBjZWxsMCA9IHN0cihkZi5pYXRbaSwgMF0pIGlmIG5vdCBwZC5pc25hKGRmLmlhdFtpLCAwXSkgZWxzZSAiIgogICAgICAgIGNlbGwxID0gc3RyKGRmLmlhdFtpLCAxXSkgaWYgbm90IHBkLmlzbmEoZGYuaWF0W2ksIDFdKSBlbHNlICIiCiAgICAgICAgaWYgY2VsbDAuc3RyaXAoKSA9PSAiV2VsbCI6CiAgICAgICAgICAgIGhlYWRlcl9yb3dfaWR4ID0gaQogICAgICAgIGlmICJUaW1lIiBpbiBjZWxsMSBhbmQgIltzXSIgaW4gY2VsbDE6CiAgICAgICAgICAgIHRpbWVfcm93X2lkeCA9IGkKCiAgICBpZiBoZWFkZXJfcm93X2lkeCBpcyBOb25lIG9yIHRpbWVfcm93X2lkeCBpcyBOb25lOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIkNvdWxkIG5vdCBmaW5kICdXZWxsJyBoZWFkZXIgcm93IG9yICdUaW1lIFtzXScgcm93IGluIEV4Y2VsIHNoZWV0LiIpCgogICAgaWYgdGltZV9yb3dfaWR4ICE9IGhlYWRlcl9yb3dfaWR4ICsgMToKICAgICAgICAjIE5vdCBmYXRhbCwgYnV0IHdhcm4gaW4gY2FzZSBmb3JtYXQgZHJpZnRzCiAgICAgICAgcHJpbnQoZiJXYXJuaW5nOiBUaW1lIHJvdyAoaW5kZXgge3RpbWVfcm93X2lkeH0pIGlzIG5vdCBkaXJlY3RseSBhZnRlciBoZWFkZXIgcm93IChpbmRleCB7aGVhZGVyX3Jvd19pZHh9KS4iLAogICAgICAgICAgICAgIGZpbGU9c3lzLnN0ZGVycikKCiAgICByZXR1cm4gaGVhZGVyX3Jvd19pZHgsIHRpbWVfcm93X2lkeAoKCmRlZiBwYXJzZV9wbGF0ZV9maWxlKHhsc3hfcGF0aDogc3RyKSAtPiBwZC5EYXRhRnJhbWU6CiAgICAiIiIKICAgIFBhcnNlIGEgc2luZ2xlIEV4Y2VsIGZpbGUgaW50byBhIGxvbmctZm9ybWF0IERhdGFGcmFtZSB3aXRoIGNvbHVtbnM6CiAgICBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgIiIiCiAgICBwcmludChmIlBhcnNpbmcge29zLnBhdGguYmFzZW5hbWUoeGxzeF9wYXRoKX0uLi4iLCBmbHVzaD1UcnVlKQogICAgdHJ5OgogICAgICAgIHByaW50KGYiICBPcGVuaW5nIEV4Y2VsIGZpbGUuLi4iLCBmbHVzaD1UcnVlKQogICAgICAgICMgRXhwbGljaXRseSB1c2Ugb3BlbnB5eGwgZW5naW5lIGZvciAueGxzeCBmaWxlcyB0byBhdm9pZCBoYW5naW5nCiAgICAgICAgeGxzID0gcGQuRXhjZWxGaWxlKHhsc3hfcGF0aCwgZW5naW5lPSdvcGVucHl4bCcpCiAgICAgICAgaWYgU0hFRVRfTkFNRV9QUkVGRVJSRUQgaW4geGxzLnNoZWV0X25hbWVzOgogICAgICAgICAgICBzaGVldF9uYW1lID0gU0hFRVRfTkFNRV9QUkVGRVJSRUQKICAgICAgICBlbHNlOgogICAgICAgICAgICBzaGVldF9uYW1lID0geGxzLnNoZWV0X25hbWVzWzBdCiAgICAgICAgICAgIHByaW50KGYiICBTaGVldCAne1NIRUVUX05BTUVfUFJFRkVSUkVEfScgbm90IGZvdW5kOyB1c2luZyBmaXJzdCBzaGVldCAne3NoZWV0X25hbWV9JyBpbnN0ZWFkLiIsIGZsdXNoPVRydWUpCiAgICAgICAgcHJpbnQoZiIgIFJlYWRpbmcgc2hlZXQgJ3tzaGVldF9uYW1lfScuLi4iLCBmbHVzaD1UcnVlKQogICAgICAgICMgVXNlIHRoZSBzYW1lIGVuZ2luZSBmb3IgcmVhZF9leGNlbAogICAgICAgIGRmID0gcGQucmVhZF9leGNlbCh4bHN4X3BhdGgsIHNoZWV0X25hbWU9c2hlZXRfbmFtZSwgaGVhZGVyPU5vbmUsIGVuZ2luZT0nb3BlbnB5eGwnKQogICAgICAgIHByaW50KGYiICBTaGVldCBsb2FkZWQ6IHtsZW4oZGYpfSByb3dzLCB7bGVuKGRmLmNvbHVtbnMpfSBjb2x1bW5zIiwgZmx1c2g9VHJ1ZSkKICAgICAgICAjIENsb3NlIHRoZSBFeGNlbEZpbGUgdG8gZnJlZSByZXNvdXJjZXMKICAgICAgICB4bHMuY2xvc2UoKQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIkZpbGUgbm90IGZvdW5kOiB7eGxzeF9wYXRofSIpCiAgICBleGNlcHQgUGVybWlzc2lvbkVycm9yOgogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIlBlcm1pc3Npb24gZGVuaWVkOiB7eGxzeF9wYXRofSAoZmlsZSBtYXkgYmUgb3BlbiBpbiBhbm90aGVyIHByb2dyYW0pIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBlcnJvcl90eXBlID0gdHlwZShlKS5fX25hbWVfXwogICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcihmIkZhaWxlZCB0byByZWFkIHt4bHN4X3BhdGh9OiB7ZXJyb3JfdHlwZX06IHtlfSIpCgogICAgcHJpbnQoZiIgIEZpbmRpbmcgaGVhZGVyIGFuZCB0aW1lIHJvd3MuLi4iLCBmbHVzaD1UcnVlKQogICAgaGVhZGVyX3Jvd19pZHgsIHRpbWVfcm93X2lkeCA9IGZpbmRfaGVhZGVyX2FuZF90aW1lX3Jvd3MoZGYpCgogICAgIyBUaW1lIHJvdzogY29sdW1uIDEgaXMgIlRpbWUgW3NdIiwgbWVhc3VyZW1lbnQgdGltZXMgc3RhcnQgZnJvbSBjb2x1bW4gMiBvbndhcmQuCiAgICB0aW1lX3JvdyA9IGRmLmlsb2NbdGltZV9yb3dfaWR4XQogICAgdGltZV92YWx1ZXMgPSB0aW1lX3Jvdy5pbG9jWzI6XS50b2xpc3QoKQogICAgIyBDbGVhbiB1cCB0aW1lcwogICAgdGltZV92YWx1ZXNfY2xlYW4gPSBbXQogICAgZm9yIHQgaW4gdGltZV92YWx1ZXM6CiAgICAgICAgaWYgcGQuaXNuYSh0KToKICAgICAgICAgICAgYnJlYWsKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRpbWVfdmFsdWVzX2NsZWFuLmFwcGVuZChmbG9hdCh0KSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAjIFN0b3AgYXQgdGhlIGZpcnN0IG5vbi1udW1lcmljIC8gd2VpcmQgdGhpbmcKICAgICAgICAgICAgYnJlYWsKCiAgICBudW1fdGltZV9wb2ludHMgPSBsZW4odGltZV92YWx1ZXNfY2xlYW4pCiAgICBpZiBudW1fdGltZV9wb2ludHMgPT0gMDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiTm8gdGltZXBvaW50cyBwYXJzZWQgaW4ge3hsc3hfcGF0aH0uIikKCiAgICBwbGF0ZV9pZCA9IG9zLnBhdGguc3BsaXRleHQob3MucGF0aC5iYXNlbmFtZSh4bHN4X3BhdGgpKVswXQoKICAgIHJlY29yZHM6IExpc3RbRGljdFtzdHIsIEFueV1dID0gW10KCiAgICAjIERhdGEgcm93czogZnJvbSB0aW1lX3Jvd19pZHggKyAxIGRvd253YXJkcyB1bnRpbCB3ZSBoaXQgZW1wdHkgIldlbGwiIGNlbGwKICAgIHByaW50KGYiICBQcm9jZXNzaW5nIGRhdGEgcm93cyAoc3RhcnRpbmcgZnJvbSByb3cge3RpbWVfcm93X2lkeCArIDF9KS4uLiIsIGZsdXNoPVRydWUpCiAgICByb3dzX3Byb2Nlc3NlZCA9IDAKICAgIGZvciBpIGluIHJhbmdlKHRpbWVfcm93X2lkeCArIDEsIGxlbihkZikpOgogICAgICAgIHdlbGwgPSBkZi5pYXRbaSwgMF0KICAgICAgICBjb250ZW50ID0gZGYuaWF0W2ksIDFdCgogICAgICAgIGlmIHBkLmlzbmEod2VsbCkgb3Igc3RyKHdlbGwpLnN0cmlwKCkgPT0gIiI6CiAgICAgICAgICAgICMgQXNzdW1lIHdlJ3ZlIHJlYWNoZWQgdGhlIGVuZCBvZiBkYXRhCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHdlbGxfaWQgPSBzdHIod2VsbCkuc3RyaXAoKQogICAgICAgIGNvbnRlbnRfc3RyID0gIiIgaWYgcGQuaXNuYShjb250ZW50KSBlbHNlIHN0cihjb250ZW50KS5zdHJpcCgpCgogICAgICAgIHJvd192YWxzID0gZGYuaWxvY1tpLCAyOjIgKyBudW1fdGltZV9wb2ludHNdLnRvbGlzdCgpCiAgICAgICAgIyBFbnN1cmUgc2FtZSBsZW5ndGggYXMgdGltZSBsaXN0CiAgICAgICAgcm93X3ZhbHMgPSByb3dfdmFsc1s6bnVtX3RpbWVfcG9pbnRzXQoKICAgICAgICBmb3IgdCwgdiBpbiB6aXAodGltZV92YWx1ZXNfY2xlYW4sIHJvd192YWxzKToKICAgICAgICAgICAgaWYgcGQuaXNuYSh2KToKICAgICAgICAgICAgICAgICMgU2tpcCBtaXNzaW5nIHZhbHVlcywgYnV0IGtlZXAgdGltZXBvaW50IGluIG92ZXJhbGwgc2NoZW1lCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB2X2Zsb2F0ID0gZmxvYXQodikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICByZWNvcmRzLmFwcGVuZCgKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAicGxhdGVfaWQiOiBwbGF0ZV9pZCwKICAgICAgICAgICAgICAgICAgICAid2VsbCI6IHdlbGxfaWQsCiAgICAgICAgICAgICAgICAgICAgImNvbnRlbnQiOiBjb250ZW50X3N0ciwKICAgICAgICAgICAgICAgICAgICAidGltZV9zIjogZmxvYXQodCksCiAgICAgICAgICAgICAgICAgICAgInZhbHVlIjogdl9mbG9hdCwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgIAogICAgICAgIHJvd3NfcHJvY2Vzc2VkICs9IDEKICAgICAgICBpZiByb3dzX3Byb2Nlc3NlZCAlIDEwMCA9PSAwOgogICAgICAgICAgICBwcmludChmIiAgICBQcm9jZXNzZWQge3Jvd3NfcHJvY2Vzc2VkfSByb3dzLi4uIiwgZmx1c2g9VHJ1ZSkKCiAgICBwcmludChmIiAgUHJvY2Vzc2VkIHtyb3dzX3Byb2Nlc3NlZH0gcm93cywgY3JlYXRlZCB7bGVuKHJlY29yZHMpfSBkYXRhIHBvaW50cyIsIGZsdXNoPVRydWUpCgogICAgaWYgbm90IHJlY29yZHM6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIk5vIGRhdGEgcm93cyBmb3VuZCBpbiB7eGxzeF9wYXRofSBhZnRlciBwYXJzaW5nLiIpCgogICAgcHJpbnQoZiIgIENyZWF0aW5nIERhdGFGcmFtZS4uLiIsIGZsdXNoPVRydWUpCiAgICBsb25nX2RmID0gcGQuRGF0YUZyYW1lLmZyb21fcmVjb3JkcyhyZWNvcmRzKQogICAgcHJpbnQoZiIgIOKckyBDb21wbGV0ZWQgcGFyc2luZyB7b3MucGF0aC5iYXNlbmFtZSh4bHN4X3BhdGgpfSIsIGZsdXNoPVRydWUpCiAgICByZXR1cm4gbG9uZ19kZgoKCmRlZiBlbnN1cmVfZGlyKHBhdGg6IHN0cik6CiAgICBvcy5tYWtlZGlycyhwYXRoLCBleGlzdF9vaz1UcnVlKQoKCmRlZiB3cml0ZV9jc3ZzX2Zvcl9wbGF0ZShsb25nX2RmOiBwZC5EYXRhRnJhbWUsIGNzdl9yb290OiBzdHIsIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lLCBmaWxlbmFtZTogc3RyID0gTm9uZSk6CiAgICAiIiIKICAgIFdyaXRlIENTViBmaWxlczoKICAgICAgLSBjc3Zfcm9vdC88cGxhdGVfaWQ+LzxwbGF0ZV9pZD5fPHdlbGw+LmNzdiAocGVyIHdlbGwsIHdpdGhvdXQgU0VNKQogICAgICAtIGNzdl9yb290Lzxjb25kaXRpb24+Xzx0cmlwbGljYXRlX25hbWU+LmNzdiAocGVyIGNvbmRpdGlvbi10cmlwbGljYXRlIGNvbWJpbmF0aW9uLCB3aXRoIG1lYW4gYW5kIFNFTSkKICAgICIiIgogICAgcGxhdGVfaWQgPSBsb25nX2RmWyJwbGF0ZV9pZCJdLmlsb2NbMF0KICAgIHByaW50KGYiICBXcml0aW5nIENTVnMgZm9yIHtwbGF0ZV9pZH0uLi4iLCBmbHVzaD1UcnVlKQoKICAgICMgTG9hZCBjb25maWcgaWYgbm90IHByb3ZpZGVkCiAgICBpZiBjb25maWcgaXMgTm9uZToKICAgICAgICBzY3JpcHRfZGlyID0gb3MucGF0aC5kaXJuYW1lKG9zLnBhdGguYWJzcGF0aChfX2ZpbGVfXykpCiAgICAgICAgY29uZmlnX3BhdGggPSBvcy5wYXRoLmpvaW4oc2NyaXB0X2RpciwgInBsYXRlX2NvbmZpZy5qc29uIikKICAgICAgICBjb25maWcgPSBsb2FkX2NvbmZpZyhjb25maWdfcGF0aCkKICAgIAogICAgIyBQYXJzZSBjb2x1bW4gaW5mbyBmcm9tIGZpbGVuYW1lIGlmIHByb3ZpZGVkCiAgICBjb2x1bW5faW5mbyA9IE5vbmUKICAgIGlmIGZpbGVuYW1lOgogICAgICAgIHRyeToKICAgICAgICAgICAgY29sdW1uX2luZm8gPSBwYXJzZV9jb2x1bW5fZ3JvdXBfZnJvbV9maWxlbmFtZShmaWxlbmFtZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAKICAgICMgR2V0IHRyaXBsaWNhdGUgZ3JvdXBzIGZyb20gY29uZmlnCiAgICB0cmlwbGljYXRlX2dyb3VwcyA9IGNvbmZpZy5nZXQoInRyaXBsaWNhdGVfZ3JvdXBzIiwgREVGQVVMVF9UUklQTElDQVRFX0dST1VQUykKICAgIGNvbnRyb2xfcm93cyA9IGNvbmZpZy5nZXQoImNvbnRyb2xfcm93cyIsIFsiTiIsICJPIl0pCiAgICAKICAgICMgQnVpbGQgbWFwcGluZzogd2VsbF9pZCAtPiB0cmlwbGljYXRlIGdyb3VwIG5hbWUKICAgICMgVXNlIG5vcm1hbGl6ZWQgd2VsbCBJRHMgZm9yIGNvbnNpc3RlbnQgbWF0Y2hpbmcKICAgIHdlbGxfdG9fZ3JvdXAgPSB7fQogICAgZm9yIGdyb3VwIGluIHRyaXBsaWNhdGVfZ3JvdXBzOgogICAgICAgIGdyb3VwX25hbWUgPSBncm91cC5nZXQoIm5hbWUiLCAiIikKICAgICAgICBncm91cF93ZWxscyA9IGdyb3VwLmdldCgid2VsbHMiLCBbXSkKICAgICAgICBmb3Igd2VsbF9wYXR0ZXJuIGluIGdyb3VwX3dlbGxzOgogICAgICAgICAgICAjIEV4dHJhY3Qgcm93IGxldHRlciBmcm9tIHdlbGwgcGF0dGVybiAoZS5nLiwgIkIiIGZyb20gIkIiIG9yICJCMTMiKQogICAgICAgICAgICByb3dfbGV0dGVyID0gd2VsbF9wYXR0ZXJuWzBdIGlmIHdlbGxfcGF0dGVybiBhbmQgd2VsbF9wYXR0ZXJuWzBdLmlzYWxwaGEoKSBlbHNlICIiCiAgICAgICAgICAgIGlmIHJvd19sZXR0ZXI6CiAgICAgICAgICAgICAgICAjIEZpbmQgYWxsIHdlbGxzIGluIHRoaXMgcm93IGFjcm9zcyBhbGwgY29sdW1ucwogICAgICAgICAgICAgICAgIyBOb3JtYWxpemUgd2VsbCBJRHMgZm9yIGNvbnNpc3RlbnQgbWF0Y2hpbmcKICAgICAgICAgICAgICAgIGZvciB3ZWxsX2lkIGluIGxvbmdfZGZbIndlbGwiXS51bmlxdWUoKToKICAgICAgICAgICAgICAgICAgICBpZiB3ZWxsX2lkOgogICAgICAgICAgICAgICAgICAgICAgICB3ZWxsX2lkX3N0ciA9IHN0cih3ZWxsX2lkKS5zdHJpcCgpCiAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRfd2VsbF9pZCA9IG5vcm1hbGl6ZV93ZWxsX2lkKHdlbGxfaWRfc3RyKQogICAgICAgICAgICAgICAgICAgICAgICAjIENoZWNrIGlmIG5vcm1hbGl6ZWQgd2VsbCBJRCBzdGFydHMgd2l0aCB0aGUgcm93IGxldHRlcgogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3JtYWxpemVkX3dlbGxfaWQgYW5kIG5vcm1hbGl6ZWRfd2VsbF9pZFswXSA9PSByb3dfbGV0dGVyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBTdG9yZSBtYXBwaW5nIHVzaW5nIG5vcm1hbGl6ZWQgd2VsbCBJRCAoY29uc2lzdGVudCBmb3JtYXQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3ZWxsX3RvX2dyb3VwW25vcm1hbGl6ZWRfd2VsbF9pZF0gPSBncm91cF9uYW1lCiAgICAKICAgICMgUGVyLXdlbGwgQ1NWcyAod2l0aG91dCBTRU0gLSBTRU0gb25seSBiZWxvbmdzIGluIHRyaXBsaWNhdGUgQ1NWcykKICAgIHBsYXRlX2ZvbGRlciA9IG9zLnBhdGguam9pbihjc3Zfcm9vdCwgcGxhdGVfaWQpCiAgICBlbnN1cmVfZGlyKHBsYXRlX2ZvbGRlcikKICAgIAogICAgd2VsbHMgPSBsb25nX2RmLmdyb3VwYnkoIndlbGwiKQogICAgcHJpbnQoZiIgICAgV3JpdGluZyB7bGVuKHdlbGxzKX0gcGVyLXdlbGwgQ1NWcy4uLiIsIGZsdXNoPVRydWUpCiAgICAKICAgICMgV3JpdGUgcGVyLXdlbGwgQ1NWcwogICAgZm9yIGlkeCwgKHdlbGxfaWQsIGcpIGluIGVudW1lcmF0ZSh3ZWxscywgMSk6CiAgICAgICAgIyBOb3JtYWxpemUgd2VsbCBJRCBmb3IgY29uc2lzdGVudCBmaWxlIG5hbWluZwogICAgICAgIG5vcm1hbGl6ZWRfd2VsbF9pZCA9IG5vcm1hbGl6ZV93ZWxsX2lkKHN0cih3ZWxsX2lkKS5zdHJpcCgpKQogICAgICAgIHNhZmVfd2VsbCA9IG5vcm1hbGl6ZWRfd2VsbF9pZC5yZXBsYWNlKCIgIiwgIiIpLnJlcGxhY2UoIjoiLCAiLSIpCiAgICAgICAgb3V0X3BhdGggPSBvcy5wYXRoLmpvaW4ocGxhdGVfZm9sZGVyLCBmIntwbGF0ZV9pZH1fe3NhZmVfd2VsbH0uY3N2IikKICAgICAgICBnX3NvcnRlZCA9IGcuc29ydF92YWx1ZXMoInRpbWVfcyIpCiAgICAgICAgCiAgICAgICAgIyBDcmVhdGUgb3V0cHV0IERhdGFGcmFtZSB3aXRoIHRpbWUgYW5kIHZhbHVlIG9ubHkgKG5vIFNFTSkKICAgICAgICBvdXRwdXRfZGYgPSBwZC5EYXRhRnJhbWUoewogICAgICAgICAgICAidGltZV9zIjogZ19zb3J0ZWRbInRpbWVfcyJdLnZhbHVlcywKICAgICAgICAgICAgInZhbHVlIjogZ19zb3J0ZWRbInZhbHVlIl0udmFsdWVzCiAgICAgICAgfSkKICAgICAgICBvdXRwdXRfZGYudG9fY3N2KG91dF9wYXRoLCBpbmRleD1GYWxzZSkKICAgICAgICAKICAgICAgICBpZiBpZHggJSA1ID09IDA6CiAgICAgICAgICAgIHByaW50KGYiICAgICAgV3JpdHRlbiB7aWR4fS97bGVuKHdlbGxzKX0gd2VsbHMuLi4iLCBmbHVzaD1UcnVlKQogICAgCiAgICAjIFdyaXRlIGNvbmRpdGlvbi1zcGVjaWZpYyBDU1ZzIChnZW5vdHlwZS1idWZmZXItdHJpcGxpY2F0ZSkKICAgICMgT25lIENTViBwZXIgY29uZGl0aW9uLXRyaXBsaWNhdGUtY29sdW1uIGNvbWJpbmF0aW9uCiAgICBpZiBjb2x1bW5faW5mbzoKICAgICAgICBwcmludChmIiAgICBXcml0aW5nIGNvbmRpdGlvbi1zcGVjaWZpYyBDU1ZzLi4uIiwgZmx1c2g9VHJ1ZSkKICAgICAgICBnZW5vdHlwZSA9IGNvbHVtbl9pbmZvLmdldCgiZ2Vub3R5cGUiLCAiIikKICAgICAgICBidWZmZXIgPSBjb2x1bW5faW5mby5nZXQoImJ1ZmZlciIsICIiKQogICAgICAgIAogICAgICAgICMgR3JvdXAgYnkgdHJpcGxpY2F0ZSBncm91cCBuYW1lIGFuZCBjb2x1bW4KICAgICAgICBmb3IgZ3JvdXAgaW4gdHJpcGxpY2F0ZV9ncm91cHM6CiAgICAgICAgICAgIGdyb3VwX25hbWUgPSBncm91cC5nZXQoIm5hbWUiLCAiIikKICAgICAgICAgICAgaWYgbm90IGdyb3VwX25hbWU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBHZXQgYWxsIHdlbGxzIGluIHRoaXMgdHJpcGxpY2F0ZSBncm91cCAoYWNyb3NzIGFsbCBjb2x1bW5zKQogICAgICAgICAgICAjIFVzZSBub3JtYWxpemVkIHdlbGwgSURzIGZvciBjb25zaXN0ZW50IG1hdGNoaW5nCiAgICAgICAgICAgIGdyb3VwX3dlbGxzID0gW10KICAgICAgICAgICAgZm9yIHdlbGxfaWQgaW4gbG9uZ19kZlsid2VsbCJdLnVuaXF1ZSgpOgogICAgICAgICAgICAgICAgd2VsbF9pZF9zdHIgPSBzdHIod2VsbF9pZCkuc3RyaXAoKQogICAgICAgICAgICAgICAgbm9ybWFsaXplZF93ZWxsX2lkID0gbm9ybWFsaXplX3dlbGxfaWQod2VsbF9pZF9zdHIpCiAgICAgICAgICAgICAgICAjIENoZWNrIHVzaW5nIG5vcm1hbGl6ZWQgd2VsbCBJRAogICAgICAgICAgICAgICAgaWYgbm9ybWFsaXplZF93ZWxsX2lkIGluIHdlbGxfdG9fZ3JvdXAgYW5kIHdlbGxfdG9fZ3JvdXBbbm9ybWFsaXplZF93ZWxsX2lkXSA9PSBncm91cF9uYW1lOgogICAgICAgICAgICAgICAgICAgIGdyb3VwX3dlbGxzLmFwcGVuZCh3ZWxsX2lkKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGdyb3VwX3dlbGxzOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR3JvdXAgd2VsbHMgYnkgY29sdW1uIG51bWJlcgogICAgICAgICAgICB3ZWxsc19ieV9jb2x1bW4gPSB7fQogICAgICAgICAgICBmb3Igd2VsbF9pZCBpbiBncm91cF93ZWxsczoKICAgICAgICAgICAgICAgICMgRXh0cmFjdCBjb2x1bW4gbnVtYmVyIGZyb20gd2VsbCBJRCAoZS5nLiwgIkIxMyIgLT4gMTMpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgY29sdW1uX251bSA9IGludCgnJy5qb2luKGZpbHRlcihzdHIuaXNkaWdpdCwgc3RyKHdlbGxfaWQpKSkpCiAgICAgICAgICAgICAgICAgICAgaWYgY29sdW1uX251bSBub3QgaW4gd2VsbHNfYnlfY29sdW1uOgogICAgICAgICAgICAgICAgICAgICAgICB3ZWxsc19ieV9jb2x1bW5bY29sdW1uX251bV0gPSBbXQogICAgICAgICAgICAgICAgICAgIHdlbGxzX2J5X2NvbHVtbltjb2x1bW5fbnVtXS5hcHBlbmQod2VsbF9pZCkKICAgICAgICAgICAgICAgIGV4Y2VwdCAoVmFsdWVFcnJvciwgQXR0cmlidXRlRXJyb3IpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENyZWF0ZSBvbmUgQ1NWIHBlciBjb2x1bW4gZm9yIHRoaXMgdHJpcGxpY2F0ZSBncm91cAogICAgICAgICAgICBmb3IgY29sdW1uX251bSBpbiBzb3J0ZWQod2VsbHNfYnlfY29sdW1uLmtleXMoKSk6CiAgICAgICAgICAgICAgICBjb2x1bW5fd2VsbHMgPSB3ZWxsc19ieV9jb2x1bW5bY29sdW1uX251bV0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBHZXQgYWxsIHRpbWUgcG9pbnRzIGZvciB0aGlzIGNvbHVtbidzIHdlbGxzCiAgICAgICAgICAgICAgICBhbGxfdGltZXMgPSBzb3J0ZWQobG9uZ19kZltsb25nX2RmWyJ3ZWxsIl0uaXNpbihjb2x1bW5fd2VsbHMpXVsidGltZV9zIl0udW5pcXVlKCkpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ2FsY3VsYXRlIG1lYW4gYW5kIFNFTSBmb3IgZWFjaCB0aW1lIHBvaW50IGFjcm9zcyB3ZWxscyBpbiB0aGlzIHRyaXBsaWNhdGUgZ3JvdXAgZm9yIHRoaXMgY29sdW1uCiAgICAgICAgICAgICAgICBtZWFuX3ZhbHVlcyA9IFtdCiAgICAgICAgICAgICAgICBzZW1fdmFsdWVzID0gW10KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIHRpbWUgaW4gYWxsX3RpbWVzOgogICAgICAgICAgICAgICAgICAgIHZhbHVlc19hdF90aW1lID0gW10KICAgICAgICAgICAgICAgICAgICBmb3Igd2VsbF9pZCBpbiBjb2x1bW5fd2VsbHM6CiAgICAgICAgICAgICAgICAgICAgICAgIHdlbGxfZGF0YSA9IGxvbmdfZGZbKGxvbmdfZGZbIndlbGwiXSA9PSB3ZWxsX2lkKSAmIChsb25nX2RmWyJ0aW1lX3MiXSA9PSB0aW1lKV0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHdlbGxfZGF0YS5lbXB0eToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlc19hdF90aW1lLmFwcGVuZCh3ZWxsX2RhdGFbInZhbHVlIl0uaWxvY1swXSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBsZW4odmFsdWVzX2F0X3RpbWUpID49IDI6CiAgICAgICAgICAgICAgICAgICAgICAgIG1lYW4gPSBzdW0odmFsdWVzX2F0X3RpbWUpIC8gbGVuKHZhbHVlc19hdF90aW1lKQogICAgICAgICAgICAgICAgICAgICAgICB2YXJpYW5jZSA9IHN1bSgodiAtIG1lYW4pICoqIDIgZm9yIHYgaW4gdmFsdWVzX2F0X3RpbWUpIC8gKGxlbih2YWx1ZXNfYXRfdGltZSkgLSAxKSAjIFNhbXBsZSB2YXJpYW5jZSB1c2luZyBCZXNzZWwncyBjb3JyZWN0aW9uL3NhbXBsZSBzdGFuZGFyZCBkZXZpYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgc3RkX2RldiA9IHZhcmlhbmNlICoqIDAuNQogICAgICAgICAgICAgICAgICAgICAgICBzZW0gPSBzdGRfZGV2IC8gKGxlbih2YWx1ZXNfYXRfdGltZSkgKiogMC41KQogICAgICAgICAgICAgICAgICAgICAgICBtZWFuX3ZhbHVlcy5hcHBlbmQobWVhbikKICAgICAgICAgICAgICAgICAgICAgICAgc2VtX3ZhbHVlcy5hcHBlbmQoc2VtKQogICAgICAgICAgICAgICAgICAgIGVsaWYgbGVuKHZhbHVlc19hdF90aW1lKSA9PSAxOgogICAgICAgICAgICAgICAgICAgICAgICBtZWFuX3ZhbHVlcy5hcHBlbmQodmFsdWVzX2F0X3RpbWVbMF0pCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbV92YWx1ZXMuYXBwZW5kKE5vbmUpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbWVhbl92YWx1ZXMuYXBwZW5kKE5vbmUpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbV92YWx1ZXMuYXBwZW5kKE5vbmUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ3JlYXRlIGNvbmRpdGlvbiBDU1YgZmlsZW5hbWU6IHBsYXRlX2lkX3RyaXBsaWNhdGVfbmFtZV9jb2x7Y29sdW1ufQogICAgICAgICAgICAgICAgIyBQbGF0ZSBJRCBhbHJlYWR5IGNvbnRhaW5zIGdlbm90eXBlIGFuZCBidWZmZXIsIHNvIGp1c3QgdXNlIHRyaXBsaWNhdGUgbmFtZQogICAgICAgICAgICAgICAgIyBLZWVwIGh5cGhlbnMgaW4gZ3JvdXAgbmFtZSAoZS5nLiwgIjI1MC0xMC0yIiksIGp1c3Qgc2FuaXRpemUgc3BhY2VzIGFuZCBjb2xvbnMKICAgICAgICAgICAgICAgIHNhZmVfZ3JvdXBfbmFtZSA9IGdyb3VwX25hbWUucmVwbGFjZSgiICIsICJfIikucmVwbGFjZSgiOiIsICItIikKICAgICAgICAgICAgICAgIGNvbmRpdGlvbl9wYXRoID0gb3MucGF0aC5qb2luKGNzdl9yb290LCBmIntwbGF0ZV9pZH1fe3NhZmVfZ3JvdXBfbmFtZX1fY29se2NvbHVtbl9udW19LmNzdiIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgV3JpdGUgY29uZGl0aW9uIENTVgogICAgICAgICAgICAgICAgY29uZGl0aW9uX2RmID0gcGQuRGF0YUZyYW1lKHsKICAgICAgICAgICAgICAgICAgICAidGltZV9zIjogYWxsX3RpbWVzLAogICAgICAgICAgICAgICAgICAgICJtZWFuIjogbWVhbl92YWx1ZXMsCiAgICAgICAgICAgICAgICAgICAgInNlbSI6IHNlbV92YWx1ZXMKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBjb25kaXRpb25fZGYudG9fY3N2KGNvbmRpdGlvbl9wYXRoLCBpbmRleD1GYWxzZSkKICAgICAgICAKICAgICAgICBwcmludChmIiAgICAgIFdyaXR0ZW4gY29uZGl0aW9uLXNwZWNpZmljIENTVnMiLCBmbHVzaD1UcnVlKQogICAgCiAgICBwcmludChmIiAg4pyTIENvbXBsZXRlZCB3cml0aW5nIENTVnMgZm9yIHtwbGF0ZV9pZH0iLCBmbHVzaD1UcnVlKQoKCmRlZiB3cml0ZV9kZWZhdWx0X2NvbmZpZyhjb25maWdfcGF0aDogc3RyKToKICAgICIiIldyaXRlIGRlZmF1bHQgY29uZmlndXJhdGlvbiBmaWxlIGZyb20gZGVmYXVsdHMuIiIiCiAgICAjIENvbnZlcnQgREVGQVVMVF9XRUxMX0xBQkVMUyB0byByb3ctYmFzZWQgZm9ybWF0CiAgICB3ZWxsX2xhYmVscyA9IHt9CiAgICBmb3Igd2VsbF9pZCwgbGFiZWwgaW4gREVGQVVMVF9XRUxMX0xBQkVMUy5pdGVtcygpOgogICAgICAgIGlmIHdlbGxfaWQgYW5kIGxlbih3ZWxsX2lkKSA+IDAgYW5kIHdlbGxfaWRbMF0uaXNhbHBoYSgpOgogICAgICAgICAgICByb3dfbGV0dGVyID0gd2VsbF9pZFswXQogICAgICAgICAgICBpZiByb3dfbGV0dGVyIG5vdCBpbiB3ZWxsX2xhYmVsczoKICAgICAgICAgICAgICAgIHdlbGxfbGFiZWxzW3Jvd19sZXR0ZXJdID0gbGFiZWwKICAgIAogICAgZGVmYXVsdF9jb25maWcgPSB7CiAgICAgICAgIndlbGxfbGFiZWxzIjogd2VsbF9sYWJlbHMsCiAgICAgICAgInRyaXBsaWNhdGVfZ3JvdXBzIjogREVGQVVMVF9UUklQTElDQVRFX0dST1VQUywKICAgICAgICAiY29udHJvbF9yb3dzIjogWyJOIiwgIk8iXQogICAgfQogICAgCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGNvbmZpZ19wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGpzb24uZHVtcChkZWZhdWx0X2NvbmZpZywgZiwgaW5kZW50PTIpCiAgICAgICAgcHJpbnQoZiIgIEdlbmVyYXRlZCBkZWZhdWx0IGNvbmZpZ3VyYXRpb24gZmlsZToge29zLnBhdGguYmFzZW5hbWUoY29uZmlnX3BhdGgpfSIsIGZsdXNoPVRydWUpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiIgIFdhcm5pbmc6IENvdWxkIG5vdCB3cml0ZSBkZWZhdWx0IGNvbmZpZyBmaWxlOiB7ZX0iLCBmbHVzaD1UcnVlKQoKCmRlZiBub3JtYWxpemVfd2VsbF9pZCh3ZWxsX2lkOiBzdHIpIC0+IHN0cjoKICAgICIiIgogICAgTm9ybWFsaXplIHdlbGwgSUQgdG8gY29uc2lzdGVudCBmb3JtYXQ6IHVwcGVyY2FzZSB3aXRoIHplcm8tcGFkZGVkIGNvbHVtbi4KICAgIEV4YW1wbGVzOiAiQjUiIC0+ICJCMDUiLCAiQjEzIiAtPiAiQjEzIiwgImI1IiAtPiAiQjA1IgogICAgIiIiCiAgICBpZiBub3Qgd2VsbF9pZDoKICAgICAgICByZXR1cm4gIiIKICAgIAogICAgd2VsbF9pZCA9IHN0cih3ZWxsX2lkKS5zdHJpcCgpLnVwcGVyKCkKICAgIAogICAgIyBNYXRjaCBwYXR0ZXJuOiBsZXR0ZXIgZm9sbG93ZWQgYnkgZGlnaXRzCiAgICBpbXBvcnQgcmUKICAgIG1hdGNoID0gcmUubWF0Y2gocideKFtBLVpdKShcZCspJCcsIHdlbGxfaWQpCiAgICBpZiBtYXRjaDoKICAgICAgICByb3cgPSBtYXRjaC5ncm91cCgxKQogICAgICAgIGNvbCA9IGludChtYXRjaC5ncm91cCgyKSkKICAgICAgICByZXR1cm4gZiJ7cm93fXtjb2w6MDJkfSIgICMgWmVyby1wYWQgdG8gMiBkaWdpdHMKICAgIAogICAgcmV0dXJuIHdlbGxfaWQKCgpkZWYgbG9hZF9jb25maWcoY29uZmlnX3BhdGg6IHN0cikgLT4gRGljdFtzdHIsIEFueV06CiAgICAiIiJMb2FkIHBsYXRlIGNvbmZpZ3VyYXRpb24gZmlsZSBpZiBpdCBleGlzdHMsIG90aGVyd2lzZSBnZW5lcmF0ZSBmcm9tIGRlZmF1bHRzLiIiIgogICAgaWYgb3MucGF0aC5leGlzdHMoY29uZmlnX3BhdGgpOgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGNvbmZpZ19wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBjb25maWcgPSBqc29uLmxvYWQoZikKICAgICAgICAgICAgICAgIHByaW50KGYiICBMb2FkZWQgY29uZmlndXJhdGlvbiBmcm9tIHtvcy5wYXRoLmJhc2VuYW1lKGNvbmZpZ19wYXRoKX0iLCBmbHVzaD1UcnVlKQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbmZpZwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiIgIFdhcm5pbmc6IENvdWxkIG5vdCBsb2FkIGNvbmZpZyBmaWxlOiB7ZX0iLCBmbHVzaD1UcnVlKQogICAgICAgICAgICAjIEdlbmVyYXRlIGRlZmF1bHQgY29uZmlnIGlmIGxvYWRpbmcgZmFpbHMKICAgICAgICAgICAgd3JpdGVfZGVmYXVsdF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgZWxzZToKICAgICAgICAjIEdlbmVyYXRlIGRlZmF1bHQgY29uZmlnIGZpbGUgaWYgaXQgZG9lc24ndCBleGlzdAogICAgICAgIHdyaXRlX2RlZmF1bHRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgICAgIHJldHVybiB7fQoKCmRlZiBidWlsZF92aWV3ZXJfanNvbihhbGxfcGxhdGVzOiBEaWN0W3N0ciwgcGQuRGF0YUZyYW1lXSwganNvbl9wYXRoOiBzdHIsIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lLCBwbGF0ZV9pZF90b19maWxlbmFtZTogRGljdFtzdHIsIHN0cl0gPSBOb25lKToKICAgICIiIgogICAgQnVpbGQgdmlld2VyX2RhdGEuanNvbiB3aXRoIHN0cnVjdHVyZToKICAgIHsKICAgICAgImNvbmZpZyI6IHsKICAgICAgICAid2VsbF9sYWJlbHMiOiB7Li4ufSwKICAgICAgICAidHJpcGxpY2F0ZV9ncm91cHMiOiBbLi4uXSwgICMgcm93LWxldHRlciBncm91cHMgKGFwcGxpZXMgdG8gYWxsIGNvbHVtbnMpCiAgICAgICAgImNvbHVtbl9ncm91cHMiOiB7Li4ufSAgIyBtYXBwaW5nIG9mIGNvbHVtbl9ncm91cCB0byBsaXN0IG9mIHBsYXRlX2lkcwogICAgICB9LAogICAgICAicGxhdGVzIjogWwogICAgICAgIHsKICAgICAgICAgICJpZCI6ICI8cGxhdGVfaWQ+IiwKICAgICAgICAgICJmaWxlIjogIjxvcmlnaW5hbF9maWxlX25hbWU+IiwKICAgICAgICAgICJjb2x1bW5fZ3JvdXAiOiAiPHByb3RlaW5fZ2Vub3R5cGVfYnVmZmVyPiIsCiAgICAgICAgICAiY29sdW1uX2luZm8iOiB7CiAgICAgICAgICAgICJwcm90ZWluIjogIi4uLiIsCiAgICAgICAgICAgICJnZW5vdHlwZSI6ICIuLi4iLAogICAgICAgICAgICAiYnVmZmVyIjogIi4uLiIsCiAgICAgICAgICAgICJzY2llbnRpc3QiOiAiLi4uIiwKICAgICAgICAgICAgIm51bWJlciI6ICIuLi4iCiAgICAgICAgICB9LAogICAgICAgICAgIndlbGxzIjogewogICAgICAgICAgICAiQjE1IjogewogICAgICAgICAgICAgICJjb250ZW50IjogIlNhbXBsZSBYMSIsCiAgICAgICAgICAgICAgImxhYmVsIjogIlNhbXBsZSBYMSIsICAjIGZyb20gY29uZmlnIGlmIGF2YWlsYWJsZQogICAgICAgICAgICAgICJ0aW1lX3MiOiBbLi4uXSwKICAgICAgICAgICAgICAidmFsdWVzIjogWy4uLl0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgLi4uCiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAuLi4KICAgICAgXQogICAgfQogICAgIiIiCiAgICBpZiBjb25maWcgaXMgTm9uZToKICAgICAgICBjb25maWcgPSB7fQogICAgaWYgcGxhdGVfaWRfdG9fZmlsZW5hbWUgaXMgTm9uZToKICAgICAgICBwbGF0ZV9pZF90b19maWxlbmFtZSA9IHt9CiAgICAKICAgICMgR2V0IGNvbnRyb2wgcm93cyBmcm9tIGNvbmZpZyAoZGVmYXVsdDogWyJOIiwgIk8iXSkKICAgIGNvbnRyb2xfcm93cyA9IGNvbmZpZy5nZXQoImNvbnRyb2xfcm93cyIsIFsiTiIsICJPIl0pCiAgICBpZiBub3QgaXNpbnN0YW5jZShjb250cm9sX3Jvd3MsIGxpc3QpOgogICAgICAgIGNvbnRyb2xfcm93cyA9IFsiTiIsICJPIl0gICMgRmFsbGJhY2sgdG8gZGVmYXVsdCBpZiBpbnZhbGlkCiAgICAKICAgICMgTWVyZ2UgZGVmYXVsdCB3ZWxsIGxhYmVscyB3aXRoIGNvbmZpZyBsYWJlbHMgKGNvbmZpZyB0YWtlcyBwcmVjZWRlbmNlKQogICAgIyBXZWxsIGxhYmVscyBhcmUgbm93IHJvdy1iYXNlZCAoZS5nLiwgIkIiOiAibGFiZWwiKSBpbnN0ZWFkIG9mIHdlbGwtc3BlY2lmaWMgKGUuZy4sICJCMTMiOiAibGFiZWwiKQogICAgIyBDb252ZXJ0IG9sZCBmb3JtYXQgdG8gbmV3IGZvcm1hdCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eQogICAgY29uZmlnX3dlbGxfbGFiZWxzID0gY29uZmlnLmdldCgid2VsbF9sYWJlbHMiLCB7fSkKICAgIHdlbGxfbGFiZWxzID0ge30KICAgIAogICAgIyBQcm9jZXNzIGNvbmZpZyBsYWJlbHMgLSBjb252ZXJ0IHdlbGwtc3BlY2lmaWMgdG8gcm93LWJhc2VkIGlmIG5lZWRlZAogICAgZm9yIGtleSwgdmFsdWUgaW4gY29uZmlnX3dlbGxfbGFiZWxzLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGtleSkgPiAxIGFuZCBrZXlbMF0uaXNhbHBoYSgpIGFuZCBrZXlbMTpdLmlzZGlnaXQoKToKICAgICAgICAgICAgIyBPbGQgZm9ybWF0OiAiQjEzIiAtPiBleHRyYWN0IHJvdyAiQiIKICAgICAgICAgICAgcm93X2xldHRlciA9IGtleVswXQogICAgICAgICAgICAjIFVzZSB0aGUgbGFzdCBub24tZW1wdHkgdmFsdWUgZm9yIGVhY2ggcm93IChpbiBjYXNlIG9mIGR1cGxpY2F0ZXMpCiAgICAgICAgICAgIGlmIHJvd19sZXR0ZXIgbm90IGluIHdlbGxfbGFiZWxzOgogICAgICAgICAgICAgICAgd2VsbF9sYWJlbHNbcm93X2xldHRlcl0gPSB2YWx1ZQogICAgICAgICAgICBlbGlmIG5vdCB3ZWxsX2xhYmVsc1tyb3dfbGV0dGVyXSBvciBub3Qgd2VsbF9sYWJlbHNbcm93X2xldHRlcl0uc3RyaXAoKToKICAgICAgICAgICAgICAgIHdlbGxfbGFiZWxzW3Jvd19sZXR0ZXJdID0gdmFsdWUKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIE5ldyBmb3JtYXQ6ICJCIiAtPiB1c2UgYXMgaXMKICAgICAgICAgICAgd2VsbF9sYWJlbHNba2V5XSA9IHZhbHVlCiAgICAKICAgICMgQWxzbyBjb252ZXJ0IERFRkFVTFRfV0VMTF9MQUJFTFMgdG8gcm93LWJhc2VkIGZvcm1hdAogICAgZGVmYXVsdF9yb3dfbGFiZWxzID0ge30KICAgIGZvciBrZXksIHZhbHVlIGluIERFRkFVTFRfV0VMTF9MQUJFTFMuaXRlbXMoKToKICAgICAgICBpZiBsZW4oa2V5KSA+IDEgYW5kIGtleVswXS5pc2FscGhhKCk6CiAgICAgICAgICAgIHJvd19sZXR0ZXIgPSBrZXlbMF0KICAgICAgICAgICAgaWYgcm93X2xldHRlciBub3QgaW4gZGVmYXVsdF9yb3dfbGFiZWxzOgogICAgICAgICAgICAgICAgZGVmYXVsdF9yb3dfbGFiZWxzW3Jvd19sZXR0ZXJdID0gdmFsdWUKICAgIAogICAgIyBNZXJnZSBkZWZhdWx0cyB3aXRoIGNvbmZpZyAoY29uZmlnIHRha2VzIHByZWNlZGVuY2UpCiAgICB3ZWxsX2xhYmVscyA9IHsqKmRlZmF1bHRfcm93X2xhYmVscywgKip3ZWxsX2xhYmVsc30KICAgIAogICAgIyBQYXJzZSBjb2x1bW4gZ3JvdXBzIGZyb20gZmlsZW5hbWVzCiAgICBjb2x1bW5fZ3JvdXBzOiBEaWN0W3N0ciwgTGlzdFtzdHJdXSA9IHt9ICAjIGNvbHVtbl9ncm91cCAtPiBsaXN0IG9mIHBsYXRlX2lkcwogICAgcGxhdGVfY29sdW1uX2luZm86IERpY3Rbc3RyLCBEaWN0W3N0ciwgc3RyXV0gPSB7fSAgIyBwbGF0ZV9pZCAtPiBjb2x1bW5faW5mbwogICAgCiAgICBmb3IgcGxhdGVfaWQsIGRmIGluIGFsbF9wbGF0ZXMuaXRlbXMoKToKICAgICAgICBmaWxlbmFtZSA9IHBsYXRlX2lkX3RvX2ZpbGVuYW1lLmdldChwbGF0ZV9pZCwgcGxhdGVfaWQgKyAiLnhsc3giKQogICAgICAgIGNvbHVtbl9pbmZvID0gcGFyc2VfY29sdW1uX2dyb3VwX2Zyb21fZmlsZW5hbWUoZmlsZW5hbWUpCiAgICAgICAgY29sdW1uX2dyb3VwID0gY29sdW1uX2luZm9bImNvbHVtbl9ncm91cCJdCiAgICAgICAgCiAgICAgICAgcGxhdGVfY29sdW1uX2luZm9bcGxhdGVfaWRdID0gY29sdW1uX2luZm8KICAgICAgICAKICAgICAgICBpZiBjb2x1bW5fZ3JvdXAgbm90IGluIGNvbHVtbl9ncm91cHM6CiAgICAgICAgICAgIGNvbHVtbl9ncm91cHNbY29sdW1uX2dyb3VwXSA9IFtdCiAgICAgICAgaWYgcGxhdGVfaWQgbm90IGluIGNvbHVtbl9ncm91cHNbY29sdW1uX2dyb3VwXToKICAgICAgICAgICAgY29sdW1uX2dyb3Vwc1tjb2x1bW5fZ3JvdXBdLmFwcGVuZChwbGF0ZV9pZCkKICAgIAogICAgIyBQcm9jZXNzIHRyaXBsaWNhdGUgZ3JvdXBzIC0gcm93IGxldHRlcnMgb25seSwgYXBwbGllcyB0byBhbGwgY29sdW1ucwogICAgIyBDb25maWcgZm9ybWF0OiB7Im5hbWUiOiAiLi4uIiwgIndlbGxzIjogWyJCIiwgIkMiLCAiRCJdfQogICAgIyBDb2x1bW4gZmllbGQgaXMgaWdub3JlZCBpZiBwcmVzZW50IChmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSkKICAgIGNvbmZpZ190cmlwbGljYXRlX2dyb3VwcyA9IGNvbmZpZy5nZXQoInRyaXBsaWNhdGVfZ3JvdXBzIiwgW10pCiAgICAKICAgIGlmIGNvbmZpZ190cmlwbGljYXRlX2dyb3VwcyBhbmQgbGVuKGNvbmZpZ190cmlwbGljYXRlX2dyb3VwcykgPiAwOgogICAgICAgICMgUHJvY2VzcyB0cmlwbGljYXRlIGdyb3VwcyAtIGFjY2VwdCByb3cgbGV0dGVycyBvbmx5IChlLmcuLCBbIkIiLCAiQyIsICJEIl0pCiAgICAgICAgIyBBbHNvIHN1cHBvcnQgYmFja3dhcmQgY29tcGF0aWJpbGl0eSB3aXRoIGZ1bGwgd2VsbCBJRHMgKGUuZy4sIFsiQjEzIiwgIkMxMyIsICJEMTMiXSkKICAgICAgICB0cmlwbGljYXRlX2dyb3VwcyA9IFtdCiAgICAgICAgZm9yIGdyb3VwIGluIGNvbmZpZ190cmlwbGljYXRlX2dyb3VwczoKICAgICAgICAgICAgd2VsbHMgPSBncm91cC5nZXQoIndlbGxzIiwgW10pCiAgICAgICAgICAgICMgRXh0cmFjdCByb3cgbGV0dGVycyBmcm9tIHdlbGxzIChoYW5kbGUgYm90aCBmb3JtYXRzKQogICAgICAgICAgICByb3dfbGV0dGVycyA9IFtdCiAgICAgICAgICAgIGZvciB3IGluIHdlbGxzOgogICAgICAgICAgICAgICAgIyBJZiBpdCdzIGEgZnVsbCB3ZWxsIElEIChlLmcuLCAiQjEzIiksIGV4dHJhY3Qgcm93IGxldHRlcgogICAgICAgICAgICAgICAgaWYgbGVuKHcpID4gMSBhbmQgd1swXS5pc2FscGhhKCkgYW5kIHdbMTpdLmlzZGlnaXQoKToKICAgICAgICAgICAgICAgICAgICByb3dfbGV0dGVyID0gd1swXQogICAgICAgICAgICAgICAgIyBJZiBpdCdzIGp1c3QgYSByb3cgbGV0dGVyIChlLmcuLCAiQiIpLCB1c2UgYXMgaXMKICAgICAgICAgICAgICAgIGVsaWYgbGVuKHcpID09IDEgYW5kIHcuaXNhbHBoYSgpOgogICAgICAgICAgICAgICAgICAgIHJvd19sZXR0ZXIgPSB3CiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlICAjIFNraXAgaW52YWxpZCBlbnRyaWVzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgRmlsdGVyIG91dCBjb250cm9sIHdlbGxzCiAgICAgICAgICAgICAgICBpZiBub3QgaXNfY29udHJvbF93ZWxsKHJvd19sZXR0ZXIsIGNvbnRyb2xfcm93cyk6CiAgICAgICAgICAgICAgICAgICAgaWYgcm93X2xldHRlciBub3QgaW4gcm93X2xldHRlcnM6CiAgICAgICAgICAgICAgICAgICAgICAgIHJvd19sZXR0ZXJzLmFwcGVuZChyb3dfbGV0dGVyKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcm93X2xldHRlcnM6CiAgICAgICAgICAgICAgICAjIFN0b3JlIHJvdyBsZXR0ZXJzIG9ubHkgLSBhcHBsaWVzIHRvIGFsbCBjb2x1bW5zCiAgICAgICAgICAgICAgICB0cmlwbGljYXRlX2dyb3Vwcy5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICJuYW1lIjogZ3JvdXAuZ2V0KCJuYW1lIiwgIiIpLAogICAgICAgICAgICAgICAgICAgICJ3ZWxscyI6IHNvcnRlZChyb3dfbGV0dGVycykgICMgU3RvcmUganVzdCByb3cgbGV0dGVycwogICAgICAgICAgICAgICAgfSkKICAgICAgICAKICAgICAgICBpZiB0cmlwbGljYXRlX2dyb3VwczoKICAgICAgICAgICAgcHJpbnQoZiIgIFVzaW5nIHtsZW4odHJpcGxpY2F0ZV9ncm91cHMpfSB0cmlwbGljYXRlIGdyb3VwKHMpIGZyb20gY29uZmlnIChyb3cgbGV0dGVycyBvbmx5LCBhcHBsaWVzIHRvIGFsbCBjb2x1bW5zKSIsIGZsdXNoPVRydWUpCiAgICBlbHNlOgogICAgICAgICMgQXV0by1nZW5lcmF0ZSBvciB1c2UgZGVmYXVsdHMKICAgICAgICAjIENvbGxlY3QgYWxsIHdlbGxzIGZyb20gYWxsIHBsYXRlcyB0byBhdXRvLWdlbmVyYXRlIHRyaXBsaWNhdGUgZ3JvdXBzCiAgICAgICAgY29udGVudF90b193ZWxsczogRGljdFtzdHIsIExpc3Rbc3RyXV0gPSB7fQogICAgICAgIAogICAgICAgIGZvciBwbGF0ZV9pZCwgZGYgaW4gYWxsX3BsYXRlcy5pdGVtcygpOgogICAgICAgICAgICBmb3Igd2VsbF9pZCwgZyBpbiBkZi5ncm91cGJ5KCJ3ZWxsIik6CiAgICAgICAgICAgICAgICBnX3NvcnRlZCA9IGcuc29ydF92YWx1ZXMoInRpbWVfcyIpCiAgICAgICAgICAgICAgICBjb250ZW50ID0gZ19zb3J0ZWRbImNvbnRlbnQiXS5pbG9jWzBdCiAgICAgICAgICAgICAgICBpZiBjb250ZW50IGFuZCBzdHIoY29udGVudCkuc3RyaXAoKToKICAgICAgICAgICAgICAgICAgICBpZiBjb250ZW50IG5vdCBpbiBjb250ZW50X3RvX3dlbGxzOgogICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50X3RvX3dlbGxzW2NvbnRlbnRdID0gW10KICAgICAgICAgICAgICAgICAgICBpZiB3ZWxsX2lkIG5vdCBpbiBjb250ZW50X3RvX3dlbGxzW2NvbnRlbnRdOgogICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50X3RvX3dlbGxzW2NvbnRlbnRdLmFwcGVuZCh3ZWxsX2lkKQogICAgICAgIAogICAgICAgICMgQXV0by1nZW5lcmF0ZSB0cmlwbGljYXRlIGdyb3VwczogZ3JvdXAgd2VsbHMgd2l0aCB0aGUgc2FtZSBjb250ZW50CiAgICAgICAgIyBFeHRyYWN0IHJvdyBwYXR0ZXJuIChlLmcuLCBCQ0QsIEVGRykgYW5kIGFwcGx5IHRvIGFsbCBjb2x1bW5zCiAgICAgICAgIyBFeGNsdWRlIGNvbnRyb2wgd2VsbHMgZnJvbSB0cmlwbGljYXRlIGdyb3VwcwogICAgICAgIGF1dG9fdHJpcGxpY2F0ZV9ncm91cHMgPSBbXQogICAgICAgIGZvciBjb250ZW50LCB3ZWxscyBpbiBjb250ZW50X3RvX3dlbGxzLml0ZW1zKCk6CiAgICAgICAgICAgICMgRmlsdGVyIG91dCBjb250cm9sIHdlbGxzCiAgICAgICAgICAgIG5vbl9jb250cm9sX3dlbGxzID0gW3cgZm9yIHcgaW4gd2VsbHMgaWYgbm90IGlzX2NvbnRyb2xfd2VsbCh3LCBjb250cm9sX3Jvd3MpXQogICAgICAgICAgICBpZiBsZW4obm9uX2NvbnRyb2xfd2VsbHMpID49IDI6ICAjIEF0IGxlYXN0IDIgbm9uLWNvbnRyb2wgd2VsbHMgd2l0aCBzYW1lIGNvbnRlbnQKICAgICAgICAgICAgICAgICMgRXh0cmFjdCByb3cgbGV0dGVycyAoZS5nLiwgWyJCMTMiLCAiQzEzIiwgIkQxMyJdIC0+IFsiQiIsICJDIiwgIkQiXSkKICAgICAgICAgICAgICAgIHJvd19sZXR0ZXJzID0gc29ydGVkKHNldChbd1swXSBmb3IgdyBpbiBub25fY29udHJvbF93ZWxscyBpZiB3IGFuZCB3WzBdLmlzYWxwaGEoKV0pKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIElmIHdlIGhhdmUgYSBwYXR0ZXJuIG9mIDMgY29uc2VjdXRpdmUgcm93cywgY3JlYXRlIGEgdHJpcGxpY2F0ZSBncm91cAogICAgICAgICAgICAgICAgIyBDaGVjayBmb3IgcGF0dGVybnMgbGlrZSBCQ0QsIEVGRywgSElKLCBldGMuCiAgICAgICAgICAgICAgICBpZiBsZW4ocm93X2xldHRlcnMpID49IDM6CiAgICAgICAgICAgICAgICAgICAgIyBTb3J0IHJvdyBsZXR0ZXJzIGFuZCBjaGVjayBpZiB0aGV5IGZvcm0gYSBjb25zZWN1dGl2ZSBwYXR0ZXJuCiAgICAgICAgICAgICAgICAgICAgcm93X2xldHRlcnNfc29ydGVkID0gc29ydGVkKHJvd19sZXR0ZXJzKQogICAgICAgICAgICAgICAgICAgICMgQ3JlYXRlIGdyb3VwIHdpdGggcm93IHBhdHRlcm4gKGFwcGxpZXMgdG8gYWxsIGNvbHVtbnMpCiAgICAgICAgICAgICAgICAgICAgYXV0b190cmlwbGljYXRlX2dyb3Vwcy5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICAgICAibmFtZSI6IGNvbnRlbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICJ3ZWxscyI6IHJvd19sZXR0ZXJzX3NvcnRlZFs6M10gICMgU3RvcmUgcm93IGxldHRlcnMgb25seQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBlbGlmIGxlbihyb3dfbGV0dGVycykgPj0gMjoKICAgICAgICAgICAgICAgICAgICAjIEZvciAyIHdlbGxzLCBzdGlsbCBjcmVhdGUgYSBncm91cAogICAgICAgICAgICAgICAgICAgIGF1dG9fdHJpcGxpY2F0ZV9ncm91cHMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiBjb250ZW50LAogICAgICAgICAgICAgICAgICAgICAgICAid2VsbHMiOiBzb3J0ZWQocm93X2xldHRlcnMpWzoyXSAgIyBTdG9yZSByb3cgbGV0dGVycyBvbmx5CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAKICAgICAgICAjIFNvcnQgdHJpcGxpY2F0ZSBncm91cHMgYnkgbmFtZQogICAgICAgIGF1dG9fdHJpcGxpY2F0ZV9ncm91cHMuc29ydChrZXk9bGFtYmRhIHg6IHguZ2V0KCJuYW1lIiwgIiIpKQogICAgICAgIAogICAgICAgIGlmIGF1dG9fdHJpcGxpY2F0ZV9ncm91cHM6CiAgICAgICAgICAgIHRyaXBsaWNhdGVfZ3JvdXBzID0gYXV0b190cmlwbGljYXRlX2dyb3VwcwogICAgICAgICAgICBwcmludChmIiAgQXV0by1nZW5lcmF0ZWQge2xlbih0cmlwbGljYXRlX2dyb3Vwcyl9IHRyaXBsaWNhdGUgZ3JvdXAocykgZnJvbSBkYXRhIChhcHBsaWVzIHRvIGFsbCBjb2x1bW5zKSIsIGZsdXNoPVRydWUpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBGYWxsIGJhY2sgdG8gZGVmYXVsdHMgLSBhbHJlYWR5IGluIHJvdyBsZXR0ZXIgZm9ybWF0CiAgICAgICAgICAgICMgRXhjbHVkZSBjb250cm9sIHdlbGxzIGZyb20gZGVmYXVsdCBncm91cHMKICAgICAgICAgICAgdHJpcGxpY2F0ZV9ncm91cHMgPSBbXQogICAgICAgICAgICBmb3IgZ3JvdXAgaW4gREVGQVVMVF9UUklQTElDQVRFX0dST1VQUzoKICAgICAgICAgICAgICAgIHdlbGxzID0gZ3JvdXAuZ2V0KCJ3ZWxscyIsIFtdKQogICAgICAgICAgICAgICAgIyBGaWx0ZXIgb3V0IGNvbnRyb2wgd2VsbHMKICAgICAgICAgICAgICAgIHJvd19sZXR0ZXJzID0gW3cgZm9yIHcgaW4gd2VsbHMgaWYgbm90IGlzX2NvbnRyb2xfd2VsbCh3LCBjb250cm9sX3Jvd3MpXQogICAgICAgICAgICAgICAgaWYgcm93X2xldHRlcnM6CiAgICAgICAgICAgICAgICAgICAgdHJpcGxpY2F0ZV9ncm91cHMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiBncm91cC5nZXQoIm5hbWUiLCAiIiksCiAgICAgICAgICAgICAgICAgICAgICAgICJ3ZWxscyI6IHNvcnRlZChyb3dfbGV0dGVycykgICMgQWxyZWFkeSByb3cgbGV0dGVycwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIGlmIHRyaXBsaWNhdGVfZ3JvdXBzOgogICAgICAgICAgICAgICAgcHJpbnQoZiIgIFVzaW5nIHtsZW4odHJpcGxpY2F0ZV9ncm91cHMpfSBkZWZhdWx0IHRyaXBsaWNhdGUgZ3JvdXAocykgKGFwcGxpZXMgdG8gYWxsIGNvbHVtbnMsIGNvbnRyb2wgd2VsbHMgZXhjbHVkZWQpIiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgIyBEZXRlY3QgZHVwbGljYXRlIHdlbGwgSURzIChzYW1lIHdlbGwgSUQgYXBwZWFycyBpbiBtdWx0aXBsZSBmaWxlcykKICAgICMgVGhpcyBtZWFucyBkdXBsaWNhdGUgY29sdW1ucyBpbiB0aGUgcGxhdGUgZ3JpZAogICAgd2VsbF9pZF90b19maWxlczogRGljdFtzdHIsIExpc3Rbc3RyXV0gPSB7fSAgIyB3ZWxsX2lkIC0+IGxpc3Qgb2YgZmlsZW5hbWVzCiAgICAKICAgIGZvciBwbGF0ZV9pZCwgZGYgaW4gYWxsX3BsYXRlcy5pdGVtcygpOgogICAgICAgIGZpbGVuYW1lID0gcGxhdGVfaWRfdG9fZmlsZW5hbWUuZ2V0KHBsYXRlX2lkLCBwbGF0ZV9pZCArICIueGxzeCIpCiAgICAgICAgIyBHZXQgYWxsIHVuaXF1ZSB3ZWxsIElEcyBmcm9tIHRoaXMgcGxhdGUKICAgICAgICB1bmlxdWVfd2VsbHMgPSBkZlsid2VsbCJdLnVuaXF1ZSgpCiAgICAgICAgZm9yIHdlbGxfaWQgaW4gdW5pcXVlX3dlbGxzOgogICAgICAgICAgICAjIE5vcm1hbGl6ZSB3ZWxsIElEIGZvciBjb25zaXN0ZW50IGR1cGxpY2F0ZSBkZXRlY3Rpb24KICAgICAgICAgICAgd2VsbF9pZF9zdHIgPSBub3JtYWxpemVfd2VsbF9pZChzdHIod2VsbF9pZCkuc3RyaXAoKSkKICAgICAgICAgICAgaWYgd2VsbF9pZF9zdHIgbm90IGluIHdlbGxfaWRfdG9fZmlsZXM6CiAgICAgICAgICAgICAgICB3ZWxsX2lkX3RvX2ZpbGVzW3dlbGxfaWRfc3RyXSA9IFtdCiAgICAgICAgICAgIGlmIGZpbGVuYW1lIG5vdCBpbiB3ZWxsX2lkX3RvX2ZpbGVzW3dlbGxfaWRfc3RyXToKICAgICAgICAgICAgICAgIHdlbGxfaWRfdG9fZmlsZXNbd2VsbF9pZF9zdHJdLmFwcGVuZChmaWxlbmFtZSkKICAgIAogICAgIyBHcm91cCBkdXBsaWNhdGVzIGJ5IGZpbGUgcGFpcnMgZm9yIGNsZWFuZXIgbWVzc2FnaW5nCiAgICBkdXBsaWNhdGVfY29sdW1uX3dhcm5pbmdzID0gW10KICAgIGZpbGVfcGFpcnNfdG9fd2VsbHM6IERpY3Rbc3RyLCBMaXN0W3N0cl1dID0ge30gICMgImZpbGUxfGZpbGUyIiAtPiBbd2VsbF9pZHNdCiAgICAKICAgIGZvciB3ZWxsX2lkLCBmaWxlcyBpbiB3ZWxsX2lkX3RvX2ZpbGVzLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGZpbGVzKSA+IDE6CiAgICAgICAgICAgICMgU29ydCBmaWxlcyBhbHBoYWJldGljYWxseSBmb3IgY29uc2lzdGVudCBvcmRlcmluZwogICAgICAgICAgICBzb3J0ZWRfZmlsZXMgPSBzb3J0ZWQoZmlsZXMpCiAgICAgICAgICAgIGZpbGVfa2V5ID0gInwiLmpvaW4oc29ydGVkX2ZpbGVzKQogICAgICAgICAgICBpZiBmaWxlX2tleSBub3QgaW4gZmlsZV9wYWlyc190b193ZWxsczoKICAgICAgICAgICAgICAgIGZpbGVfcGFpcnNfdG9fd2VsbHNbZmlsZV9rZXldID0gW10KICAgICAgICAgICAgZmlsZV9wYWlyc190b193ZWxsc1tmaWxlX2tleV0uYXBwZW5kKHdlbGxfaWQpCiAgICAKICAgICMgQnVpbGQgd2FybmluZ3MgZ3JvdXBlZCBieSBmaWxlIHBhaXJzCiAgICBmb3IgZmlsZV9rZXksIHdlbGxfaWRzIGluIGZpbGVfcGFpcnNfdG9fd2VsbHMuaXRlbXMoKToKICAgICAgICBmaWxlcyA9IGZpbGVfa2V5LnNwbGl0KCJ8IikKICAgICAgICBzb3J0ZWRfd2VsbHMgPSBzb3J0ZWQod2VsbF9pZHMpCiAgICAgICAgZHVwbGljYXRlX2NvbHVtbl93YXJuaW5ncy5hcHBlbmQoewogICAgICAgICAgICAiZmlsZXMiOiBmaWxlcywKICAgICAgICAgICAgIndlbGxfaWRzIjogc29ydGVkX3dlbGxzCiAgICAgICAgfSkKICAgICAgICAKICAgICAgICAjIENvbnNvbGUgbWVzc2FnZSAtIHNob3J0ZXIgdmVyc2lvbgogICAgICAgIGZpbGVzX3N0ciA9ICIgYW5kICIuam9pbihmaWxlcykKICAgICAgICB3ZWxsc19zdHIgPSAiLCAiLmpvaW4oc29ydGVkX3dlbGxzWzo1XSkgICMgU2hvdyBmaXJzdCA1CiAgICAgICAgaWYgbGVuKHNvcnRlZF93ZWxscykgPiA1OgogICAgICAgICAgICB3ZWxsc19zdHIgKz0gZiIsIC4uLiAoe2xlbihzb3J0ZWRfd2VsbHMpfSB0b3RhbCkiCiAgICAgICAgcHJpbnQoZiIgIOKaoO+4jyAgV0FSTklORzoge2ZpbGVzX3N0cn0gaGF2ZSBkdXBsaWNhdGUgd2VsbHM6IHt3ZWxsc19zdHJ9IiwgZmx1c2g9VHJ1ZSkKICAgICAgICBwcmludChmIiAgICAgT25seSBkYXRhIGZyb20gJ3tmaWxlc1swXX0nIChmaXJzdCBhbHBoYWJldGljYWxseSkgaXMgdXNlZC4iLCBmbHVzaD1UcnVlKQogICAgCiAgICBkYXRhID0gewogICAgICAgICJjb25maWciOiB7CiAgICAgICAgICAgICJ3ZWxsX2xhYmVscyI6IHdlbGxfbGFiZWxzLAogICAgICAgICAgICAidHJpcGxpY2F0ZV9ncm91cHMiOiB0cmlwbGljYXRlX2dyb3VwcywKICAgICAgICAgICAgImNvbHVtbl9ncm91cHMiOiBjb2x1bW5fZ3JvdXBzLAogICAgICAgICAgICAiY29udHJvbF9yb3dzIjogY29udHJvbF9yb3dzLAogICAgICAgICAgICAid2FybmluZ3MiOiB7CiAgICAgICAgICAgICAgICAiZHVwbGljYXRlX2NvbHVtbnMiOiBkdXBsaWNhdGVfY29sdW1uX3dhcm5pbmdzCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJwbGF0ZXMiOiBbXQogICAgfQogICAgCiAgICBmb3IgcGxhdGVfaWQsIGRmIGluIGFsbF9wbGF0ZXMuaXRlbXMoKToKICAgICAgICB3ZWxsc19kaWN0OiBEaWN0W3N0ciwgQW55XSA9IHt9CiAgICAgICAgZm9yIHdlbGxfaWQsIGcgaW4gZGYuZ3JvdXBieSgid2VsbCIpOgogICAgICAgICAgICAjIE5vcm1hbGl6ZSB3ZWxsIElEIHRvIGNvbnNpc3RlbnQgZm9ybWF0ICh6ZXJvLXBhZGRlZCkKICAgICAgICAgICAgbm9ybWFsaXplZF93ZWxsX2lkID0gbm9ybWFsaXplX3dlbGxfaWQod2VsbF9pZCkKICAgICAgICAgICAgZ19zb3J0ZWQgPSBnLnNvcnRfdmFsdWVzKCJ0aW1lX3MiKQogICAgICAgICAgICBjb250ZW50ID0gZ19zb3J0ZWRbImNvbnRlbnQiXS5pbG9jWzBdCiAgICAgICAgICAgICMgVXNlIHJvdy1iYXNlZCBsYWJlbCBmcm9tIGNvbmZpZyBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSB1c2UgY29udGVudAogICAgICAgICAgICAjIEV4dHJhY3Qgcm93IGxldHRlciBmcm9tIG5vcm1hbGl6ZWQgd2VsbF9pZCAoZS5nLiwgIkIxMyIgLT4gIkIiKQogICAgICAgICAgICByb3dfbGV0dGVyID0gbm9ybWFsaXplZF93ZWxsX2lkWzBdIGlmIG5vcm1hbGl6ZWRfd2VsbF9pZCBhbmQgbm9ybWFsaXplZF93ZWxsX2lkWzBdLmlzYWxwaGEoKSBlbHNlICIiCiAgICAgICAgICAgIGxhYmVsID0gd2VsbF9sYWJlbHMuZ2V0KHJvd19sZXR0ZXIsIGNvbnRlbnQpIGlmIHJvd19sZXR0ZXIgZWxzZSBjb250ZW50CiAgICAgICAgICAgIHdlbGxzX2RpY3Rbbm9ybWFsaXplZF93ZWxsX2lkXSA9IHsKICAgICAgICAgICAgICAgICJjb250ZW50IjogY29udGVudCwKICAgICAgICAgICAgICAgICJsYWJlbCI6IGxhYmVsLAogICAgICAgICAgICAgICAgInRpbWVfcyI6IGdfc29ydGVkWyJ0aW1lX3MiXS50b2xpc3QoKSwKICAgICAgICAgICAgICAgICJ2YWx1ZXMiOiBnX3NvcnRlZFsidmFsdWUiXS50b2xpc3QoKSwKICAgICAgICAgICAgfQogICAgICAgIAogICAgICAgIGZpbGVuYW1lID0gcGxhdGVfaWRfdG9fZmlsZW5hbWUuZ2V0KHBsYXRlX2lkLCBwbGF0ZV9pZCArICIueGxzeCIpCiAgICAgICAgY29sdW1uX2luZm8gPSBwbGF0ZV9jb2x1bW5faW5mby5nZXQocGxhdGVfaWQsIHBhcnNlX2NvbHVtbl9ncm91cF9mcm9tX2ZpbGVuYW1lKGZpbGVuYW1lKSkKICAgICAgICAKICAgICAgICBkYXRhWyJwbGF0ZXMiXS5hcHBlbmQoCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICJpZCI6IHBsYXRlX2lkLAogICAgICAgICAgICAgICAgImZpbGUiOiBmaWxlbmFtZSwKICAgICAgICAgICAgICAgICJjb2x1bW5fZ3JvdXAiOiBjb2x1bW5faW5mb1siY29sdW1uX2dyb3VwIl0sCiAgICAgICAgICAgICAgICAiY29sdW1uX2luZm8iOiB7CiAgICAgICAgICAgICAgICAgICAgInByb3RlaW4iOiBjb2x1bW5faW5mb1sicHJvdGVpbiJdLAogICAgICAgICAgICAgICAgICAgICJnZW5vdHlwZSI6IGNvbHVtbl9pbmZvWyJnZW5vdHlwZSJdLAogICAgICAgICAgICAgICAgICAgICJidWZmZXIiOiBjb2x1bW5faW5mb1siYnVmZmVyIl0sCiAgICAgICAgICAgICAgICAgICAgInNjaWVudGlzdCI6IGNvbHVtbl9pbmZvWyJzY2llbnRpc3QiXSwKICAgICAgICAgICAgICAgICAgICAibnVtYmVyIjogY29sdW1uX2luZm9bIm51bWJlciJdCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgIndlbGxzIjogd2VsbHNfZGljdCwKICAgICAgICAgICAgfQogICAgICAgICkKCiAgICB3aXRoIG9wZW4oanNvbl9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAganNvbi5kdW1wKGRhdGEsIGYsIGluZGVudD0yKQoKCkhUTUxfVEVNUExBVEUgPSByIiIiPCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgPG1ldGEgY2hhcnNldD0iVVRGLTgiPgogIDx0aXRsZT5QbGF0ZSBWaWV3ZXI8L3RpdGxlPgogIDxzdHlsZT4KICAgIGJvZHkgewogICAgICBmb250LWZhbWlseTogc3lzdGVtLXVpLCAtYXBwbGUtc3lzdGVtLCBCbGlua01hY1N5c3RlbUZvbnQsICJTZWdvZSBVSSIsIHNhbnMtc2VyaWY7CiAgICAgIG1hcmdpbjogMDsKICAgICAgcGFkZGluZzogMDsKICAgICAgZGlzcGxheTogZmxleDsKICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgaGVpZ2h0OiAxMDB2aDsKICAgICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIH0KICAgICNjb250ZW50LXdyYXBwZXIgewogICAgICBkaXNwbGF5OiBncmlkOwogICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDMyMHB4IDFmcjsKICAgICAgZmxleDogMTsKICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIH0KICAgIGFzaWRlIHsKICAgICAgYm9yZGVyLXJpZ2h0OiAxcHggc29saWQgI2NjYzsKICAgICAgcGFkZGluZzogMTZweDsKICAgICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgICAgYmFja2dyb3VuZDogI2Y3ZjdmNzsKICAgICAgb3ZlcmZsb3cteTogYXV0bzsKICAgIH0KICAgIG1haW4gewogICAgICBwYWRkaW5nOiAxNnB4OwogICAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgICBvdmVyZmxvdzogYXV0bzsKICAgIH0KICAgIGgxIHsKICAgICAgZm9udC1zaXplOiAxLjJyZW07CiAgICAgIG1hcmdpbi10b3A6IDA7CiAgICB9CiAgICBsYWJlbCB7CiAgICAgIGRpc3BsYXk6IGJsb2NrOwogICAgICBtYXJnaW4tYm90dG9tOiA4cHg7CiAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7CiAgICB9CiAgICBzZWxlY3QgewogICAgICB3aWR0aDogMTAwJSU7CiAgICAgIHBhZGRpbmc6IDhweDsKICAgICAgYm9yZGVyOiAxcHggc29saWQgI2RkZDsKICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgZm9udC1zaXplOiAwLjlyZW07CiAgICAgIG1hcmdpbi1ib3R0b206IDE2cHg7CiAgICB9CiAgICAjd2VsbC1pbmZvIHsKICAgICAgbWFyZ2luLXRvcDogOHB4OwogICAgICBmb250LXNpemU6IDAuOXJlbTsKICAgICAgcGFkZGluZzogOHB4OwogICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgYm9yZGVyLXJhZGl1czogNHB4OwogICAgICBib3JkZXI6IDFweCBzb2xpZCAjZGRkOwogICAgfQogICAgI3BsYXRlLWdyaWQgewogICAgICBkaXNwbGF5OiBncmlkOwogICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IGF1dG8gcmVwZWF0KCUoY29scylkLCAxZnIpOwogICAgICBncmlkLWF1dG8tcm93czogMzJweDsKICAgICAgZ2FwOiAycHg7CiAgICAgIGZvbnQtc2l6ZTogMTFweDsKICAgICAgbWFyZ2luLWJvdHRvbTogMTZweDsKICAgIH0KICAgIC5ncmlkLWhlYWRlciB7CiAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIH0KICAgIC5yb3ctbGFiZWwsIC5jb2wtbGFiZWwgewogICAgICBkaXNwbGF5OiBmbGV4OwogICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIH0KICAgIC53ZWxsIHsKICAgICAgYm9yZGVyOiAxcHggc29saWQgI2RkZDsKICAgICAgYm9yZGVyLXJhZGl1czogM3B4OwogICAgICBkaXNwbGF5OiBmbGV4OwogICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICBiYWNrZ3JvdW5kOiAjZmZmOwogICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgIGZvbnQtc2l6ZTogMTBweDsKICAgICAgcG9pbnRlci1ldmVudHM6IGF1dG87CiAgICAgIHotaW5kZXg6IDE7CiAgICB9CiAgICAud2VsbFtkYXRhLWhhcy1kYXRhPSJ0cnVlIl06bm90KC50cmlwbGljYXRlLWdyb3VwKTpub3QoLmNvbnRyb2wpIHsKICAgICAgYmFja2dyb3VuZDogI2U0ZjBmZjsKICAgICAgYm9yZGVyLWNvbG9yOiAjNmM5Y2ZmOwogICAgfQogICAgLndlbGwuc2VsZWN0ZWQgewogICAgICBvdXRsaW5lOiAycHggc29saWQgIzJhNmNmZjsKICAgICAgb3V0bGluZS1vZmZzZXQ6IC0ycHg7CiAgICAgIGJhY2tncm91bmQ6ICNlNGYwZmY7CiAgICB9CiAgICAud2VsbC5yZXBsaWNhdGUgewogICAgICBib3JkZXItc3R5bGU6IGRhc2hlZDsKICAgIH0KICAgIC53ZWxsLnRyaXBsaWNhdGUtZ3JvdXAgewogICAgICAvKiBCb3JkZXJzIGFyZSBhZGRlZCB2aWEgaW5saW5lIHN0eWxlcyBvbmx5IHdoZW4gc2VsZWN0ZWQgKi8KICAgIH0KICAgIC8qIEluZGl2aWR1YWwgY29sb3JzIHdpbGwgYmUgYXBwbGllZCB2aWEgaW5saW5lIHN0eWxlcyAqLwogICAgLndlbGwuY29udHJvbCB7CiAgICAgIGJhY2tncm91bmQ6ICNlOGY1ZTk7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7CiAgICB9CiAgICAud2VsbC5jb250cm9sW2RhdGEtaGFzLWRhdGE9InRydWUiXSB7CiAgICAgIGJhY2tncm91bmQ6ICNjOGU2Yzk7CiAgICAgIGJvcmRlci1jb2xvcjogIzZjOWNmZjsKICAgIH0KICAgIC53ZWxsLmNvbnRyb2wuc2VsZWN0ZWQgewogICAgICBiYWNrZ3JvdW5kOiAjYzhlNmM5OwogICAgICBvdXRsaW5lOiAycHggc29saWQgIzJhNmNmZjsKICAgICAgb3V0bGluZS1vZmZzZXQ6IC0ycHg7CiAgICB9CiAgICAud2VsbC1sYWJlbCB7CiAgICAgIGZvbnQtc2l6ZTogOHB4OwogICAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICAgIGJvdHRvbTogMXB4OwogICAgICBsZWZ0OiAxcHg7CiAgICAgIHJpZ2h0OiAxcHg7CiAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7CiAgICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lOwogICAgICB6LWluZGV4OiAyOwogICAgfQogICAgI2NoYXJ0LWNvbnRhaW5lciB7CiAgICAgIG1hcmdpbi10b3A6IDEycHg7CiAgICAgIGhlaWdodDogODAwcHg7CiAgICAgIG1pbi1oZWlnaHQ6IDgwMHB4OwogICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB9CiAgICBjYW52YXMgewogICAgICBtYXgtd2lkdGg6IDEwMCUlOwogICAgICBoZWlnaHQ6IDgwMHB4ICFpbXBvcnRhbnQ7CiAgICB9CiAgICAuYnRuIHsKICAgICAgcGFkZGluZzogNnB4IDEycHg7CiAgICAgIG1hcmdpbjogNHB4IDA7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNjY2M7CiAgICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgZm9udC1zaXplOiAwLjlyZW07CiAgICB9CiAgICAuYnRuOmhvdmVyIHsKICAgICAgYmFja2dyb3VuZDogI2YwZjBmMDsKICAgIH0KICAgIC5idG4tcHJpbWFyeSB7CiAgICAgIGJhY2tncm91bmQ6ICMyYTZjZmY7CiAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgYm9yZGVyLWNvbG9yOiAjMmE2Y2ZmOwogICAgfQogICAgLmJ0bi1wcmltYXJ5OmhvdmVyIHsKICAgICAgYmFja2dyb3VuZDogIzFhNWNmZjsKICAgIH0KICAgICN3YXJuaW5nLWJhbm5lciB7CiAgICAgIGJhY2tncm91bmQ6ICNmZmYzY2Q7CiAgICAgIGJvcmRlcjogMnB4IHNvbGlkICNmZmMxMDc7CiAgICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgICAgcGFkZGluZzogMTJweCAxNnB4OwogICAgICBtYXJnaW46IDE2cHg7CiAgICAgIG1hcmdpbi1ib3R0b206IDA7CiAgICAgIGZvbnQtc2l6ZTogMC45cmVtOwogICAgICBjb2xvcjogIzg1NjQwNDsKICAgICAgZGlzcGxheTogbm9uZTsKICAgIH0KICAgICN3YXJuaW5nLWJhbm5lci5zaG93IHsKICAgICAgZGlzcGxheTogYmxvY2s7CiAgICB9CiAgICAjd2FybmluZy1iYW5uZXIgaDMgewogICAgICBtYXJnaW46IDAgMCA4cHggMDsKICAgICAgZm9udC1zaXplOiAxcmVtOwogICAgICBjb2xvcjogIzg1NjQwNDsKICAgIH0KICAgICN3YXJuaW5nLWJhbm5lciB1bCB7CiAgICAgIG1hcmdpbjogOHB4IDAgMCAwOwogICAgICBwYWRkaW5nLWxlZnQ6IDIwcHg7CiAgICB9CiAgICAjd2FybmluZy1iYW5uZXIgbGkgewogICAgICBtYXJnaW46IDRweCAwOwogICAgfQogICAgaW5wdXRbdHlwZT0iY2hlY2tib3giXTpkaXNhYmxlZCB7CiAgICAgIG9wYWNpdHk6IDAuNTsKICAgICAgY3Vyc29yOiBub3QtYWxsb3dlZCAhaW1wb3J0YW50OwogICAgfQogICAgaW5wdXRbdHlwZT0iY2hlY2tib3giXTpkaXNhYmxlZCArIHNwYW4gewogICAgICBvcGFjaXR5OiAwLjY7CiAgICAgIGNvbG9yOiAjOTk5OwogICAgfQogIDwvc3R5bGU+CiAgPCEtLSBDaGFydC5qcyB2aWEgQ0ROIC0tPgogIDxzY3JpcHQgc3JjPSJodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvbnBtL2NoYXJ0LmpzIj48L3NjcmlwdD4KPC9oZWFkPgo8Ym9keT4KICA8ZGl2IGlkPSJ3YXJuaW5nLWJhbm5lciI+PC9kaXY+CiAgPGRpdiBpZD0iY29udGVudC13cmFwcGVyIj4KICA8YXNpZGU+CiAgICA8aDE+UGxhdGUgVmlld2VyPC9oMT4KICAgIDxsYWJlbD5TZWxlY3QgRGF0YXNldCBHcm91cDo8L2xhYmVsPgogICAgPHNlbGVjdCBpZD0iZGF0YXNldC1zZWxlY3QiPjwvc2VsZWN0PgogICAgPGRpdiBpZD0iZGF0YXNldC1pbmZvIiBzdHlsZT0ibWFyZ2luLXRvcDogMTZweDsgcGFkZGluZzogMTJweDsgYmFja2dyb3VuZDogd2hpdGU7IGJvcmRlci1yYWRpdXM6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsgZm9udC1zaXplOiAwLjg1cmVtOyI+CiAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsiPkRhdGFzZXQgSW5mb3JtYXRpb248L2Rpdj4KICAgICAgPGRpdiBpZD0iZGF0YXNldC1kZXRhaWxzIj5TZWxlY3QgYSBkYXRhc2V0IHRvIHZpZXcgZGV0YWlscy48L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBpZD0iY29sdW1uLWxlZ2VuZCIgc3R5bGU9Im1hcmdpbi10b3A6IDE2cHg7IHBhZGRpbmc6IDEycHg7IGJhY2tncm91bmQ6IHdoaXRlOyBib3JkZXItcmFkaXVzOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGZvbnQtc2l6ZTogMC44NXJlbTsiPgogICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7Ij5TZWxlY3QgRGF0YXNldHMgYnkgQ29sdW1uPC9kaXY+CiAgICAgIDxkaXYgaWQ9ImNvbHVtbi1sZWdlbmQtY29udGVudCIgc3R5bGU9ImZvbnQtc2l6ZTogMC44cmVtOyBjb2xvcjogIzY2NjsiPk5vIGNvbHVtbiBpbmZvcm1hdGlvbiBhdmFpbGFibGUuPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgaWQ9IndlbGwtc2VsZWN0b3IiIHN0eWxlPSJtYXJnaW4tdG9wOiAxNnB4OyBwYWRkaW5nOiAxMnB4OyBiYWNrZ3JvdW5kOiB3aGl0ZTsgYm9yZGVyLXJhZGl1czogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyI+CiAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGN1cnNvcjogcG9pbnRlcjsgZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyIgb25jbGljaz0idG9nZ2xlV2VsbFNlbGVjdG9yKCkiPgogICAgICAgIDxzcGFuIGlkPSJ3ZWxsLXNlbGVjdG9yLWFycm93IiBzdHlsZT0ibWFyZ2luLXJpZ2h0OiA4cHg7Ij7ilrw8L3NwYW4+CiAgICAgICAgPHNwYW4+U2VsZWN0IFdlbGxzIChjbGljayB0byBleGNsdWRlKTwvc3Bhbj4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgaWQ9IndlbGwtc2VsZWN0b3ItZ3JpZC1jb250YWluZXIiIHN0eWxlPSJkaXNwbGF5OiBub25lOyI+CiAgICAgICAgPGRpdiBpZD0id2VsbC1zZWxlY3Rvci1ncmlkIiBzdHlsZT0iZGlzcGxheTogZ3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiBhdXRvIHJlcGVhdCgyNCwgMWZyKTsgZ3JpZC1hdXRvLXJvd3M6IDE4cHg7IGdhcDogMXB4OyBmb250LXNpemU6IDhweDsgbWFyZ2luLXRvcDogOHB4OyI+PC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLXRvcDogMTZweDsgdGV4dC1hbGlnbjogY2VudGVyOyI+CiAgICAgICAgICBDbGljayB3ZWxscyB0byBleGNsdWRlIHRoZW0gKOKclSA9IGV4Y2x1ZGVkKQogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBzdHlsZT0ibWFyZ2luLXRvcDogMTZweDsgcGFkZGluZzogMTJweDsgYmFja2dyb3VuZDogd2hpdGU7IGJvcmRlci1yYWRpdXM6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsiPgogICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA4cHg7IGZvbnQtc2l6ZTogMC45NXJlbTsgY29sb3I6ICMzMzM7Ij5EYXRhIFByb2Nlc3NpbmcgV29ya2Zsb3c8L2Rpdj4KICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLWJvdHRvbTogMTJweDsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZjlmOWY5OyBib3JkZXItcmFkaXVzOiAzcHg7Ij4KICAgICAgICA8c3Ryb25nPlN0ZXAgMTo8L3N0cm9uZz4gTm9ybWFsaXplIHVzaW5nIGZpdHRlZCBiYXNlbGluZSAoaWYgZW5hYmxlZCk8YnI+CiAgICAgICAgPHN0cm9uZz5TdGVwIDI6PC9zdHJvbmc+IEdyb3VwIHdlbGxzIGludG8gdHJpcGxpY2F0ZSBncm91cHMgKGlmIGVuYWJsZWQpPGJyPgogICAgICAgIDxzdHJvbmc+U3RlcCAzOjwvc3Ryb25nPiBDdXRvZmYgZGF0YSBwb2ludHMgYmVmb3JlIGZpcnN0IHRpbWVwb2ludCBhbmQgYWZ0ZXIgdGltZSBwb2ludCAoaWYgZW5hYmxlZCk8YnI+CiAgICAgICAgPHN0cm9uZz5TdGVwIDQ6PC9zdHJvbmc+IEZpdCByZWdyZXNzaW9uIGN1cnZlIHRvIGRhdGEgcG9pbnRzIChpZiBlbmFibGVkKQogICAgICA8L2Rpdj4KICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBjdXJzb3I6IHBvaW50ZXI7IGZvbnQtc2l6ZTogMC45cmVtOyI+CiAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0ibm9ybWFsaXplLWJhc2VsaW5lLXRvZ2dsZSIgc3R5bGU9Im1hcmdpbi1yaWdodDogOHB4OyBjdXJzb3I6IHBvaW50ZXI7IiBvbmNoYW5nZT0idXBkYXRlQ2hhcnQoKTsiPgogICAgICAgIDxzcGFuPjxzdHJvbmc+U3RlcCAxOjwvc3Ryb25nPiBOb3JtYWxpemUgdXNpbmcgZml0dGVkIGJhc2VsaW5lPC9zcGFuPgogICAgICA8L2xhYmVsPgogICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiA0cHg7IG1hcmdpbi1ib3R0b206IDhweDsgbWFyZ2luLWxlZnQ6IDI0cHg7Ij4KICAgICAgICBGaXQgYSBiYXNlbGluZSBmdW5jdGlvbiAoTE9XRVNTLCBjb25zdGFudCwgb3IgcG9seW5vbWlhbCkgb24gdGhlIGJhc2VsaW5lIHdpbmRvdyBhbmQgbm9ybWFsaXplIGVhY2ggd2VsbCB1c2luZyB0aGUgZml0dGVkIGJhc2VsaW5lLiBTZWxlY3QgbWV0aG9kIGFuZCBwYXJhbWV0ZXJzIGluIHRoZSAiQmFzZWxpbmUgRml0dGluZyAmIE5vcm1hbGl6YXRpb24gT3B0aW9ucyIgc2VjdGlvbiBiZWxvdy4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgaWQ9Im5vcm1hbGl6ZS1iYXNlbGluZS1wYXJhbWV0ZXJzIiBzdHlsZT0iZm9udC1zaXplOiAwLjhyZW07IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyBkaXNwbGF5OiBub25lOyBtYXJnaW4tbGVmdDogMjRweDsgbWFyZ2luLWJvdHRvbTogOHB4OyI+CiAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogOHB4OyI+CiAgICAgICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICA8c3BhbiBzdHlsZT0ibWluLXdpZHRoOiAxMjBweDsiPkJhc2VsaW5lIHdpbmRvdyBlbmQgKHMpOjwvc3Bhbj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9Im51bWJlciIgaWQ9Im5vcm1hbGl6ZS1iYXNlbGluZS1lbmQtdGltZSIgdmFsdWU9IjI0IiBtaW49IjAiIHN0ZXA9IjAuMSIgc3R5bGU9IndpZHRoOiA4MHB4OyBwYWRkaW5nOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsiIG9uY2hhbmdlPSJ1cGRhdGVDaGFydCgpOyI+CiAgICAgICAgICA8L2xhYmVsPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDRweDsiPgogICAgICAgICAgQmFzZWxpbmUgZml0dGluZyBtZXRob2QgYW5kIG5vcm1hbGl6YXRpb24gbW9kZSBhcmUgc2VsZWN0ZWQgaW4gdGhlICJCYXNlbGluZSBGaXR0aW5nICYgTm9ybWFsaXphdGlvbiBPcHRpb25zIiBzZWN0aW9uIGJlbG93LgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgaWQ9ImN1cnJlbnQtc2V0dGluZ3MtZGlzcGxheSIgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICMzMzM7IG1hcmdpbi10b3A6IDhweDsgcGFkZGluZzogNnB4OyBiYWNrZ3JvdW5kOiAjZjBmMGYwOyBib3JkZXItcmFkaXVzOiAzcHg7IGJvcmRlci1sZWZ0OiAzcHggc29saWQgIzJhNmNmZjsiPgogICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogNHB4OyBjb2xvcjogIzJhNmNmZjsiPkN1cnJlbnQgU2V0dGluZ3M6PC9kaXY+CiAgICAgICAgICA8ZGl2IGlkPSJjdXJyZW50LXNldHRpbmdzLWNvbnRlbnQiIHN0eWxlPSJmb250LXNpemU6IDAuN3JlbTsgY29sb3I6ICM2NjY7Ij4KICAgICAgICAgICAgQmFzZWxpbmU6IDxzcGFuIGlkPSJjdXJyZW50LWJhc2VsaW5lLW1ldGhvZCI+Q29uc3RhbnQ8L3NwYW4+IHwgTm9ybWFsaXphdGlvbjogPHNwYW4gaWQ9ImN1cnJlbnQtbm9ybWFsaXphdGlvbi1tb2RlIj5NdWx0aXBsaWNhdGl2ZTwvc3Bhbj4gfCBDdXJ2ZSBGaXQ6IDxzcGFuIGlkPSJjdXJyZW50LXJlZ3Jlc3Npb24tdHlwZSI+TW9uby1leHBvbmVudGlhbCBwbGF0ZWF1PC9zcGFuPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGN1cnNvcjogcG9pbnRlcjsgZm9udC1zaXplOiAwLjlyZW07IG1hcmdpbi10b3A6IDEycHg7Ij4KICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJncm91cC10cmlwbGljYXRlcy10b2dnbGUiIHN0eWxlPSJtYXJnaW4tcmlnaHQ6IDhweDsgY3Vyc29yOiBwb2ludGVyOyIgb25jaGFuZ2U9InVwZGF0ZUNoYXJ0KCk7Ij4KICAgICAgICA8c3Bhbj48c3Ryb25nPlN0ZXAgMjo8L3N0cm9uZz4gR3JvdXAgd2VsbHMgaW50byB0cmlwbGljYXRlIGdyb3Vwczwvc3Bhbj4KICAgICAgPC9sYWJlbD4KICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLXRvcDogNHB4OyBtYXJnaW4tbGVmdDogMjRweDsiPgogICAgICAgIFdoZW4gZW5hYmxlZCwgd2VsbHMgdGhhdCBhcmUgcGFydCBvZiB0cmlwbGljYXRlIGdyb3VwcyAoZS5nLiwgcm93cyBCLCBDLCBEKSBhcmUgZ3JvdXBlZCB0b2dldGhlci4gV2hlbiBkaXNhYmxlZCwgZWFjaCB3ZWxsIGlzIHNob3duIGluZGl2aWR1YWxseS4gPHN0cm9uZz5Ob3RlOjwvc3Ryb25nPiBSZXF1aXJlcyBTdGVwIDEgKG5vcm1hbGl6YXRpb24pIHRvIGJlIGVuYWJsZWQuCiAgICAgIDwvZGl2PgogICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGN1cnNvcjogcG9pbnRlcjsgZm9udC1zaXplOiAwLjlyZW07IG1hcmdpbi10b3A6IDEycHg7Ij4KICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJjdXRvZmYtYmFzZWxpbmUtdG9nZ2xlIiBzdHlsZT0ibWFyZ2luLXJpZ2h0OiA4cHg7IGN1cnNvcjogcG9pbnRlcjsiIG9uY2hhbmdlPSJ1cGRhdGVDaGFydCgpOyI+CiAgICAgICAgPHNwYW4+PHN0cm9uZz5TdGVwIDM6PC9zdHJvbmc+IEN1dG9mZiBkYXRhIHBvaW50cyBiZWZvcmUgZmlyc3QgdGltZXBvaW50IGFuZCBhZnRlciB0aW1lIHBvaW50PC9zcGFuPgogICAgICA8L2xhYmVsPgogICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiA0cHg7IG1hcmdpbi1sZWZ0OiAyNHB4OyI+CiAgICAgICAgV2hlbiBlbmFibGVkLCBkYXRhIHBvaW50cyBiZWZvcmUgdGhlIGZpcnN0IHJlYWwgdGltZXBvaW50IGFuZCBhZnRlciB0aGUgY3V0b2ZmIHRpbWUgd2lsbCBiZSBleGNsdWRlZCBmcm9tIHRoZSBncmFwaCBkaXNwbGF5LgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0iY3V0b2ZmLWJhc2VsaW5lLXBhcmFtZXRlcnMiIHN0eWxlPSJmb250LXNpemU6IDAuOHJlbTsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZjlmOWY5OyBib3JkZXItcmFkaXVzOiAzcHg7IGRpc3BsYXk6IG5vbmU7IG1hcmdpbi1sZWZ0OiAyNHB4OyBtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDEyMHB4OyI+Q3V0b2ZmIHRpbWUgKHMpOjwvc3Bhbj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9Im51bWJlciIgaWQ9ImN1dG9mZi1iYXNlbGluZS10aW1lIiB2YWx1ZT0iMzYwIiBtaW49IjAiIHN0ZXA9IjEiIHN0eWxlPSJ3aWR0aDogODBweDsgcGFkZGluZzogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7IiBvbmNoYW5nZT0idXBkYXRlQ2hhcnQoKTsiPgogICAgICAgICAgPC9sYWJlbD4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiA0cHg7Ij4KICAgICAgICAgIERhdGEgcG9pbnRzIGJlZm9yZSB0aGUgZmlyc3QgcmVhbCB0aW1lcG9pbnQgYW5kIGFmdGVyIHRoaXMgdGltZSB3aWxsIGJlIGV4Y2x1ZGVkIChkZWZhdWx0OiA2IG1pbnV0ZXMgPSAzNjAgc2Vjb25kcykuCiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGN1cnNvcjogcG9pbnRlcjsgZm9udC1zaXplOiAwLjlyZW07IG1hcmdpbi10b3A6IDEycHg7Ij4KICAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJmaXQtcmVncmVzc2lvbi10b2dnbGUiIHN0eWxlPSJtYXJnaW4tcmlnaHQ6IDhweDsgY3Vyc29yOiBwb2ludGVyOyIgb25jaGFuZ2U9InVwZGF0ZVJlZ3Jlc3Npb25UeXBlUGFyYW1zKHRydWUpOyB1cGRhdGVDaGFydCgpOyI+CiAgICAgICAgPHNwYW4+PHN0cm9uZz5TdGVwIDQ6PC9zdHJvbmc+IEZpdCByZWdyZXNzaW9uIGN1cnZlIHRvIGRhdGEgcG9pbnRzPC9zcGFuPgogICAgICA8L2xhYmVsPgogICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tdG9wOiA0cHg7IG1hcmdpbi1sZWZ0OiAyNHB4OyI+CiAgICAgICAgV2hlbiBlbmFibGVkLCBhIHJlZ3Jlc3Npb24gY3VydmUgd2lsbCBiZSBmaXR0ZWQgdG8gdGhlIGRhdGEgcG9pbnRzIGFuZCBkaXNwbGF5ZWQgb24gdGhlIGdyYXBoLgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0iZml0LXJlZ3Jlc3Npb24tcGFyYW1ldGVycyIgc3R5bGU9ImZvbnQtc2l6ZTogMC44cmVtOyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsgZGlzcGxheTogbm9uZTsgbWFyZ2luLWxlZnQ6IDI0cHg7IG1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgPHNwYW4gc3R5bGU9Im1pbi13aWR0aDogMTQwcHg7Ij5SZWdyZXNzaW9uIHR5cGU6PC9zcGFuPgogICAgICAgICAgICA8c2VsZWN0IGlkPSJyZWdyZXNzaW9uLXR5cGUtc2VsZWN0IiBzdHlsZT0iZmxleDogMTsgcGFkZGluZzogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtc2l6ZTogMC44NXJlbTsiIG9uY2hhbmdlPSJ1cGRhdGVSZWdyZXNzaW9uVHlwZVBhcmFtcygpOyI+CiAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibGluZWFyIj5MaW5lYXI8L29wdGlvbj4KICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJwb2x5bm9taWFsIj5Qb2x5bm9taWFsPC9vcHRpb24+CiAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iZXhwb25lbnRpYWwiPkV4cG9uZW50aWFsPC9vcHRpb24+CiAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibG9nYXJpdGhtaWMiPkxvZ2FyaXRobWljPC9vcHRpb24+CiAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibW9uby1leHBvbmVudGlhbCIgc2VsZWN0ZWQ+TW9uby1leHBvbmVudGlhbCAocmlzZSB0byBwbGF0ZWF1KTwvb3B0aW9uPgogICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBpZD0icmVncmVzc2lvbi1wb2x5bm9taWFsLW9yZGVyIiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogOHB4OyBkaXNwbGF5OiBub25lOyI+CiAgICAgICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICA8c3BhbiBzdHlsZT0ibWluLXdpZHRoOiAxNDBweDsiPlBvbHlub21pYWwgb3JkZXI6PC9zcGFuPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBpZD0icG9seW5vbWlhbC1vcmRlci1pbnB1dCIgdmFsdWU9IjIiIG1pbj0iMiIgbWF4PSI1IiBzdGVwPSIxIiBzdHlsZT0id2lkdGg6IDgwcHg7IHBhZGRpbmc6IDRweDsgYm9yZGVyOiAxcHggc29saWQgI2RkZDsgYm9yZGVyLXJhZGl1czogM3B4OyBmb250LWZhbWlseTogbW9ub3NwYWNlOyIgb25jaGFuZ2U9InVwZGF0ZUNoYXJ0KCk7Ij4KICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLXRvcDogNHB4OyI+CiAgICAgICAgICBUaGUgcmVncmVzc2lvbiBjdXJ2ZSB3aWxsIGJlIG92ZXJsYWlkIG9uIHRoZSBkYXRhIHBvaW50cy4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJyZWdyZXNzaW9uLWluZm8tcGFuZWwiIHN0eWxlPSJtYXJnaW4tdG9wOiAxMnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNlOGY0ZmQ7IGJvcmRlci1yYWRpdXM6IDNweDsgYm9yZGVyOiAxcHggc29saWQgIzJhNmNmZjsgZGlzcGxheTogbm9uZTsiPgogICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyBjb2xvcjogIzJhNmNmZjsiPk1vbm8tZXhwb25lbnRpYWwgRml0IFBhcmFtZXRlcnM8L2Rpdj4KICAgICAgICAgIDxkaXYgaWQ9InJlZ3Jlc3Npb24taW5mby1jb250ZW50IiBzdHlsZT0iZm9udC1zaXplOiAwLjc1cmVtOyBmb250LWZhbWlseTogbW9ub3NwYWNlOyI+CiAgICAgICAgICAgIDwhLS0gUGFyYW1ldGVycyB3aWxsIGJlIHBvcHVsYXRlZCBoZXJlIC0tPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tdG9wOiAxNnB4OyBwYWRkaW5nOiAxMnB4OyBiYWNrZ3JvdW5kOiB3aGl0ZTsgYm9yZGVyLXJhZGl1czogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyI+CiAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGN1cnNvcjogcG9pbnRlcjsgZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyBmb250LXNpemU6IDAuOTVyZW07IGNvbG9yOiAjMzMzOyIgb25jbGljaz0idG9nZ2xlQmFzZWxpbmVPcHRpb25zKCkiPgogICAgICAgIDxzcGFuIGlkPSJiYXNlbGluZS1vcHRpb25zLWFycm93IiBzdHlsZT0ibWFyZ2luLXJpZ2h0OiA4cHg7Ij7ilrw8L3NwYW4+CiAgICAgICAgPHNwYW4+QmFzZWxpbmUgRml0dGluZyAmIE5vcm1hbGl6YXRpb24gT3B0aW9uczwvc3Bhbj4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgaWQ9ImJhc2VsaW5lLW9wdGlvbnMtY29udGVudCIgc3R5bGU9ImRpc3BsYXk6IG5vbmU7IGZvbnQtc2l6ZTogMC44cmVtOyI+CiAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogMTZweDsgcGFkZGluZzogOHB4OyBiYWNrZ3JvdW5kOiAjZThmNGZkOyBib3JkZXItcmFkaXVzOiAzcHg7IGJvcmRlcjogMXB4IHNvbGlkICMyYTZjZmY7Ij4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsgY29sb3I6ICMyYTZjZmY7Ij5TZWxlY3QgQmFzZWxpbmUgRml0dGluZyBNZXRob2Q8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDhweDsiPgogICAgICAgICAgICA8bGFiZWwgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDRweDsgZm9udC1zaXplOiAwLjg1cmVtOyI+CiAgICAgICAgICAgICAgPHNwYW4gc3R5bGU9Im1pbi13aWR0aDogMTQwcHg7Ij5NZXRob2Q6PC9zcGFuPgogICAgICAgICAgICAgIDxzZWxlY3QgaWQ9ImJhc2VsaW5lLW1ldGhvZC1zZWxlY3QiIHN0eWxlPSJmbGV4OiAxOyBwYWRkaW5nOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1zaXplOiAwLjg1cmVtOyIgb25jaGFuZ2U9InVwZGF0ZUJhc2VsaW5lTWV0aG9kUGFyYW1zKCk7Ij4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9Imxvd2VzcyI+TE9XRVNTPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJjb25zdGFudCIgc2VsZWN0ZWQ+Q29uc3RhbnQ8L29wdGlvbj4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9InBvbHlub21pYWwiPlBvbHlub21pYWw8L29wdGlvbj4KICAgICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgICAgPC9sYWJlbD4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBpZD0iYmFzZWxpbmUtbG93ZXNzLXBhcmFtcyIgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7IGRpc3BsYXk6IG5vbmU7Ij4KICAgICAgICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBtYXJnaW4tYm90dG9tOiA0cHg7IGZvbnQtc2l6ZTogMC44NXJlbTsiPgogICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDE0MHB4OyI+U21vb3RoaW5nIGZyYWN0aW9uIChmcmFjKTo8L3NwYW4+CiAgICAgICAgICAgICAgPGlucHV0IHR5cGU9Im51bWJlciIgaWQ9ImJhc2VsaW5lLWZyYWMtaW5wdXQiIHZhbHVlPSIwLjUiIG1pbj0iMC4xIiBtYXg9IjEuMCIgc3RlcD0iMC4xIiBzdHlsZT0iZmxleDogMTsgcGFkZGluZzogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7IGZvbnQtc2l6ZTogMC44NXJlbTsiPgogICAgICAgICAgICA8L2xhYmVsPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyBtYXJnaW4tbGVmdDogMTQwcHg7IG1hcmdpbi10b3A6IDJweDsiPgogICAgICAgICAgICAgIEhpZ2hlciA9IHNtb290aGVyICgwLjctMC45KSwgTG93ZXIgPSBtb3JlIGxvY2FsICgwLjItMC40KQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBpZD0iYmFzZWxpbmUtcG9seW5vbWlhbC1wYXJhbXMiIHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyBkaXNwbGF5OiBub25lOyI+CiAgICAgICAgICAgIDxsYWJlbCBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNHB4OyBmb250LXNpemU6IDAuODVyZW07Ij4KICAgICAgICAgICAgICA8c3BhbiBzdHlsZT0ibWluLXdpZHRoOiAxNDBweDsiPlBvbHlub21pYWwgb3JkZXI6PC9zcGFuPgogICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJudW1iZXIiIGlkPSJiYXNlbGluZS1wb2x5LW9yZGVyLWlucHV0IiB2YWx1ZT0iMSIgbWluPSIxIiBtYXg9IjUiIHN0ZXA9IjEiIHN0eWxlPSJmbGV4OiAxOyBwYWRkaW5nOiA0cHg7IGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsgZm9udC1zaXplOiAwLjg1cmVtOyI+CiAgICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi1sZWZ0OiAxNDBweDsgbWFyZ2luLXRvcDogMnB4OyI+CiAgICAgICAgICAgICAgMSA9IGxpbmVhciwgMiA9IHF1YWRyYXRpYywgMysgPSBoaWdoZXIgb3JkZXIKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxNnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNlOGY0ZmQ7IGJvcmRlci1yYWRpdXM6IDNweDsgYm9yZGVyOiAxcHggc29saWQgIzJhNmNmZjsiPgogICAgICAgICAgPGRpdiBzdHlsZT0iZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLWJvdHRvbTogOHB4OyBjb2xvcjogIzJhNmNmZjsiPlNlbGVjdCBOb3JtYWxpemF0aW9uIE1ldGhvZDwvZGl2PgogICAgICAgICAgPGRpdj4KICAgICAgICAgICAgPGxhYmVsIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBtYXJnaW4tYm90dG9tOiA0cHg7IGZvbnQtc2l6ZTogMC44NXJlbTsiPgogICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJtaW4td2lkdGg6IDE0MHB4OyI+Tm9ybWFsaXphdGlvbiBtb2RlOjwvc3Bhbj4KICAgICAgICAgICAgICA8c2VsZWN0IGlkPSJub3JtYWxpemF0aW9uLW1vZGUtc2VsZWN0IiBzdHlsZT0iZmxleDogMTsgcGFkZGluZzogNHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtc2l6ZTogMC44NXJlbTsiIG9uY2hhbmdlPSJ1cGRhdGVDdXJyZW50U2V0dGluZ3NEaXNwbGF5KCk7Ij4KICAgICAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9ImRlbHRhX2Zfb3Zlcl9mIj7OlEYvRiAoRGVsdGEgRiBvdmVyIEYpPC9vcHRpb24+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJtdWx0aXBsaWNhdGl2ZSIgc2VsZWN0ZWQ+TXVsdGlwbGljYXRpdmU8L29wdGlvbj4KICAgICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgICAgPC9sYWJlbD4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE2cHg7Ij4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsgY29sb3I6ICMyYTZjZmY7Ij5CYXNlbGluZSBGaXR0aW5nIE1ldGhvZHM8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDRweDsiPjEuIExPV0VTUyAoTG9jYWxseSBXZWlnaHRlZCBTY2F0dGVycGxvdCBTbW9vdGhpbmcpPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkZvcm11bGE6PC9zdHJvbmc+IGcodCkgPSBMT1dFU1MoRl9iYXNlbGluZSwgdF9iYXNlbGluZSwgZnJhYykKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPldoZW4gdG8gdXNlOjwvc3Ryb25nPiBCYXNlbGluZSBoYXMgZ3JhZHVhbCBkcmlmdCBvciBub24tbGluZWFyIHRyZW5kcwogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+QmVzdCBmb3I6PC9zdHJvbmc+IE5vbi1saW5lYXIgYmFzZWxpbmVzIHdpdGggc21vb3RoIHRyZW5kcwogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+UGFyYW1ldGVyczo8L3N0cm9uZz4KICAgICAgICAgICAgICA8dWwgc3R5bGU9Im1hcmdpbjogNHB4IDAgMCAyMHB4OyBwYWRkaW5nLWxlZnQ6IDA7Ij4KICAgICAgICAgICAgICAgIDxsaT48c3Ryb25nPmZyYWM6PC9zdHJvbmc+IEZyYWN0aW9uIG9mIGRhdGEgdXNlZCBmb3Igc21vb3RoaW5nIChkZWZhdWx0OiAwLjUpCiAgICAgICAgICAgICAgICAgIDx1bCBzdHlsZT0ibWFyZ2luOiAycHggMCAwIDIwcHg7IHBhZGRpbmctbGVmdDogMDsiPgogICAgICAgICAgICAgICAgICAgIDxsaT5IaWdoZXIgZnJhYyAoMC43LTAuOSkgPSBzbW9vdGhlciwgbW9yZSBnbG9iYWwgZml0PC9saT4KICAgICAgICAgICAgICAgICAgICA8bGk+TG93ZXIgZnJhYyAoMC4yLTAuNCkgPSBtb3JlIGxvY2FsLCBmb2xsb3dzIGRhdGEgY2xvc2VseTwvbGk+CiAgICAgICAgICAgICAgICAgIDwvdWw+CiAgICAgICAgICAgICAgICA8L2xpPgogICAgICAgICAgICAgIDwvdWw+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxMnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4yLiBDT05TVEFOVCAoMHRoLW9yZGVyIHBvbHlub21pYWwpPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkZvcm11bGE6PC9zdHJvbmc+IGcodCkgPSBtZWFuKEZfYmFzZWxpbmUpIGZvciBhbGwgdAogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+V2hlbiB0byB1c2U6PC9zdHJvbmc+IEJhc2VsaW5lIGlzIHN0YWJsZS9mbGF0IHdpdGggbWluaW1hbCBkcmlmdAogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+QmVzdCBmb3I6PC9zdHJvbmc+IFN0YWJsZSBiYXNlbGluZXMgd2l0aCBubyB0aW1lLWRlcGVuZGVudCB0cmVuZHMKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5QYXJhbWV0ZXJzOjwvc3Ryb25nPiBOb25lCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAxMnB4OyBwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXdlaWdodDogNjAwOyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4zLiBQT0xZTk9NSUFMICgxc3Qtb3JkZXIgb3IgaGlnaGVyKTwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5Gb3JtdWxhOjwvc3Ryb25nPiBnKHQpID0gY+KCgCArIGPigoF0ICsgY+KCgnTCsiArIC4uLgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+V2hlbiB0byB1c2U6PC9zdHJvbmc+IEJhc2VsaW5lIGhhcyBsaW5lYXIgb3IgcG9seW5vbWlhbCBkcmlmdAogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+QmVzdCBmb3I6PC9zdHJvbmc+IEJhc2VsaW5lcyB3aXRoIGtub3duIHBvbHlub21pYWwgdHJlbmRzCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5QYXJhbWV0ZXJzOjwvc3Ryb25nPgogICAgICAgICAgICAgIDx1bCBzdHlsZT0ibWFyZ2luOiA0cHggMCAwIDIwcHg7IHBhZGRpbmctbGVmdDogMDsiPgogICAgICAgICAgICAgICAgPGxpPjxzdHJvbmc+cG9seV9vcmRlcjo8L3N0cm9uZz4gUG9seW5vbWlhbCBvcmRlciAoZGVmYXVsdDogMSA9IGxpbmVhcikKICAgICAgICAgICAgICAgICAgPHVsIHN0eWxlPSJtYXJnaW46IDJweCAwIDAgMjBweDsgcGFkZGluZy1sZWZ0OiAwOyI+CiAgICAgICAgICAgICAgICAgICAgPGxpPk9yZGVyIDE6IExpbmVhciBkcmlmdCAoZyh0KSA9IGPigoAgKyBj4oKBdCk8L2xpPgogICAgICAgICAgICAgICAgICAgIDxsaT5PcmRlciAyOiBRdWFkcmF0aWMgZHJpZnQgKGcodCkgPSBj4oKAICsgY+KCgXQgKyBj4oKCdMKyKTwvbGk+CiAgICAgICAgICAgICAgICAgICAgPGxpPkhpZ2hlciBvcmRlcnM6IE1vcmUgY29tcGxleCB0cmVuZHM8L2xpPgogICAgICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICAgICAgPC9saT4KICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDE2cHg7Ij4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsgY29sb3I6ICMyYTZjZmY7Ij5Ob3JtYWxpemF0aW9uIE1ldGhvZHM8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDRweDsiPjEuIERFTFRBX0ZfT1ZFUl9GICjOlEYvRik8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+Rm9ybXVsYTo8L3N0cm9uZz4gRicodCkgPSAoRih0KSAtIGcodCkpIC8gZyh0KQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+V2hlbiB0byB1c2U6PC9zdHJvbmc+IE1lYXN1cmUgcmVsYXRpdmUgY2hhbmdlIGZyb20gYmFzZWxpbmUKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkJlc3QgZm9yOjwvc3Ryb25nPiBEZXRlY3RpbmcgaW5jcmVhc2VzL2RlY3JlYXNlcyByZWxhdGl2ZSB0byBiYXNlbGluZQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+SW50ZXJwcmV0YXRpb246PC9zdHJvbmc+CiAgICAgICAgICAgICAgPHVsIHN0eWxlPSJtYXJnaW46IDRweCAwIDAgMjBweDsgcGFkZGluZy1sZWZ0OiAwOyI+CiAgICAgICAgICAgICAgICA8bGk+RicodCkgPSAwOiBObyBjaGFuZ2UgZnJvbSBiYXNlbGluZTwvbGk+CiAgICAgICAgICAgICAgICA8bGk+RicodCkgPiAwOiBJbmNyZWFzZSBhYm92ZSBiYXNlbGluZSAoZS5nLiwgMC41ID0gNTAlJSBpbmNyZWFzZSk8L2xpPgogICAgICAgICAgICAgICAgPGxpPkYnKHQpIDwgMDogRGVjcmVhc2UgYmVsb3cgYmFzZWxpbmUgKGUuZy4sIC0wLjMgPSAzMCUlIGRlY3JlYXNlKTwvbGk+CiAgICAgICAgICAgICAgPC91bD4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyI+CiAgICAgICAgICAgICAgVmFsdWVzIGNhbiBiZSBuZWdhdGl2ZSAoYmVsb3cgYmFzZWxpbmUpIG9yIHBvc2l0aXZlIChhYm92ZSBiYXNlbGluZSkKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogI2Y5ZjlmOTsgYm9yZGVyLXJhZGl1czogM3B4OyI+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDRweDsiPjIuIE1VTFRJUExJQ0FUSVZFPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkZvcm11bGE6PC9zdHJvbmc+IEZfbm9ybSh0KSA9IEYodCkgLyBnKHQpCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTJweDsgbWFyZ2luLWJvdHRvbTogNHB4OyI+CiAgICAgICAgICAgICAgPHN0cm9uZz5XaGVuIHRvIHVzZTo8L3N0cm9uZz4gTm9ybWFsaXplIGJ5IGJhc2VsaW5lIHdpdGhvdXQgc3VidHJhY3RpbmcKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBtYXJnaW4tYm90dG9tOiA0cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPkJlc3QgZm9yOjwvc3Ryb25nPiBGb2xkLWNoYW5nZSBhbmFseXNpcwogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IG1hcmdpbi1ib3R0b206IDRweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+SW50ZXJwcmV0YXRpb246PC9zdHJvbmc+CiAgICAgICAgICAgICAgPHVsIHN0eWxlPSJtYXJnaW46IDRweCAwIDAgMjBweDsgcGFkZGluZy1sZWZ0OiAwOyI+CiAgICAgICAgICAgICAgICA8bGk+Rl9ub3JtKHQpID0gMS4wOiBObyBjaGFuZ2UgZnJvbSBiYXNlbGluZTwvbGk+CiAgICAgICAgICAgICAgICA8bGk+Rl9ub3JtKHQpID0gMi4wOiAyLWZvbGQgaW5jcmVhc2UgKDEwMCUlIGluY3JlYXNlKTwvbGk+CiAgICAgICAgICAgICAgICA8bGk+Rl9ub3JtKHQpID0gMC41OiAyLWZvbGQgZGVjcmVhc2UgKDUwJSUgb2YgYmFzZWxpbmUpPC9saT4KICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7Ij4KICAgICAgICAgICAgICBWYWx1ZXMgYXJlIGFsd2F5cyBwb3NpdGl2ZSAocmF0aW8gdG8gYmFzZWxpbmUpCiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdj4KICAgICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtd2VpZ2h0OiA2MDA7IG1hcmdpbi1ib3R0b206IDhweDsgY29sb3I6ICMyYTZjZmY7Ij5TdGF0aXN0aWNzIENvbXB1dGF0aW9uPC9kaXY+CiAgICAgICAgICA8ZGl2IHN0eWxlPSJwYWRkaW5nOiA4cHg7IGJhY2tncm91bmQ6ICNmOWY5Zjk7IGJvcmRlci1yYWRpdXM6IDNweDsiPgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA4cHg7Ij4KICAgICAgICAgICAgICBGb3IgZWFjaCBjb25kaXRpb24gYW5kIHRpbWVwb2ludCwgdGhlIGZvbGxvd2luZyBzdGF0aXN0aWNzIGFyZSBjb21wdXRlZDoKICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDZweDsiPgogICAgICAgICAgICAgIDxzdHJvbmc+TWVhbjo8L3N0cm9uZz4gzrwodCkgPSAoMS9uKSDDlyDOoyBGJyh0KQogICAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyI+CiAgICAgICAgICAgICAgICBBdmVyYWdlIG5vcm1hbGl6ZWQgdmFsdWUgYWNyb3NzIGFsbCB3ZWxscyBpbiB0aGUgY29uZGl0aW9uCiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA2cHg7Ij4KICAgICAgICAgICAgICA8c3Ryb25nPlNEOjwvc3Ryb25nPiDPgyh0KSA9IHNxcnQozqMoRicodCkgLSDOvCh0KSnCsiAvIChuLTEpKQogICAgICAgICAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbi1sZWZ0OiAxMnB4OyBmb250LXNpemU6IDAuNzVyZW07IGNvbG9yOiAjNjY2OyI+CiAgICAgICAgICAgICAgICBTYW1wbGUgc3RhbmRhcmQgZGV2aWF0aW9uIChkZG9mPTEpIGFjcm9zcyB3ZWxscwogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICA8c3Ryb25nPlNFTTo8L3N0cm9uZz4gU0VNKHQpID0gz4ModCkgLyBzcXJ0KG4pCiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IGZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7Ij4KICAgICAgICAgICAgICAgIFN0YW5kYXJkIGVycm9yIG9mIHRoZSBtZWFuID0gU0QgLyBzcXJ0KG5fd2VsbHMpCiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDEycHg7IGZvbnQtc2l6ZTogMC43NXJlbTsgY29sb3I6ICM2NjY7IG1hcmdpbi10b3A6IDRweDsiPgogICAgICAgICAgICAgICAgPHN0cm9uZz5Ob3RlOjwvc3Ryb25nPiBTRU0gaXMgY29tcHV0ZWQgYWNyb3NzIHdlbGxzLCBub3QgcHJvcGFnYXRlZCBmcm9tIGJhc2VsaW5lIGVycm9yCiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXByaW1hcnkiIG9uY2xpY2s9InVwZGF0ZUNoYXJ0KCkiIHN0eWxlPSJtYXJnaW4tdG9wOiAxNnB4OyI+VXBkYXRlIENoYXJ0PC9idXR0b24+CiAgICA8YnV0dG9uIGNsYXNzPSJidG4iIG9uY2xpY2s9ImNsZWFyU2VsZWN0aW9uKCkiPkNsZWFyIFNlbGVjdGlvbjwvYnV0dG9uPgogICAgPGRpdiBpZD0id2VsbC1pbmZvIiBzdHlsZT0ibWFyZ2luLXRvcDogMTZweDsiPkNsaWNrIHdlbGxzIG9uIHRoZSBwbGF0ZSB0byBhZGQgdGhlbSB0byB0aGUgY2hhcnQuPC9kaXY+CiAgPC9hc2lkZT4KICA8bWFpbj4KICAgIDxkaXYgaWQ9InBsYXRlLWdyaWQiPjwvZGl2PgogICAgPGRpdiBpZD0iY2hhcnQtY29udGFpbmVyIj4KICAgICAgPGNhbnZhcyBpZD0id2VsbC1jaGFydCI+PC9jYW52YXM+CiAgICA8L2Rpdj4KICA8L21haW4+CiAgPC9kaXY+Cgo8c2NyaXB0Pgpjb25zdCBQTEFURV9ST1dTID0gIiUocm93cylzIi5zcGxpdCgiIik7CmNvbnN0IFBMQVRFX0NPTFMgPSAlKGNvbHMpZDsKCmxldCB2aWV3ZXJEYXRhID0gbnVsbDsKbGV0IGNoYXJ0ID0gbnVsbDsKbGV0IHNlbGVjdGVkV2VsbHMgPSBuZXcgU2V0KCk7IC8vIFNldCBvZiB7cGxhdGVJZDp3ZWxsSWR9IHN0cmluZ3MKbGV0IGFsbFdlbGxzRGF0YSA9IHt9OyAvLyBDb21iaW5lZCB3ZWxscyBmcm9tIGFsbCBwbGF0ZXM6IHtwbGF0ZUlkOiB7d2VsbElkOiB7Li4ufX19CmxldCBzZWxlY3RlZERhdGFzZXRJZCA9IG51bGw7IC8vIEN1cnJlbnRseSBzZWxlY3RlZCBkYXRhc2V0IElECmxldCBlbmFibGVkRGF0YXNldHMgPSBuZXcgU2V0KCk7IC8vIFNldCBvZiBlbmFibGVkIGRhdGFzZXQgSURzIChlbXB0eSA9IGFsbCBlbmFibGVkKQpsZXQgZW5hYmxlZFdlbGxzID0gbmV3IFNldCgpOyAvLyBTZXQgb2YgZW5hYmxlZCB3ZWxsIElEcyAoZW1wdHkgPSBhbGwgZW5hYmxlZCkKbGV0IGVuYWJsZWRDb2x1bW5zID0gbmV3IFNldCgpOyAvLyBTZXQgb2YgZW5hYmxlZCBjb2x1bW4gbnVtYmVycyAoZW1wdHkgPSBhbGwgZW5hYmxlZCkKCi8vIFJlZ2lzdGVyIGVycm9yIGJhciBwbHVnaW4gZ2xvYmFsbHkKQ2hhcnQucmVnaXN0ZXIoewogIGlkOiAiZXJyb3JCYXJzIiwKICBhZnRlckRhdGFzZXRzRHJhdzogKGNoYXJ0KSA9PiB7CiAgICBjb25zdCBjdHggPSBjaGFydC5jdHg7CiAgICBjaGFydC5kYXRhLmRhdGFzZXRzLmZvckVhY2goKGRhdGFzZXQsIGRhdGFzZXRJbmRleCkgPT4gewogICAgICBpZiAoIWRhdGFzZXQuZGF0YSB8fCBkYXRhc2V0LmRhdGEubGVuZ3RoID09PSAwKSByZXR1cm47CiAgICAgIAogICAgICAvLyBDaGVjayBpZiBhbnkgZGF0YSBwb2ludCBoYXMgZXJyb3IgaW5mb3JtYXRpb24KICAgICAgY29uc3QgaGFzRXJyb3JzID0gZGF0YXNldC5kYXRhLnNvbWUoZCA9PiBkICYmIGQuZXJyb3IgIT09IHVuZGVmaW5lZCAmJiBkLmVycm9yICE9PSBudWxsKTsKICAgICAgaWYgKCFoYXNFcnJvcnMpIHJldHVybjsKICAgICAgCiAgICAgIGNvbnN0IG1ldGEgPSBjaGFydC5nZXREYXRhc2V0TWV0YShkYXRhc2V0SW5kZXgpOwogICAgICBjdHguc2F2ZSgpOwogICAgICBjdHguc3Ryb2tlU3R5bGUgPSBkYXRhc2V0LmJvcmRlckNvbG9yIHx8ICJyZ2JhKDAsMCwwLDAuNSkiOwogICAgICBjdHgubGluZVdpZHRoID0gMTsKICAgICAgCiAgICAgIG1ldGEuZGF0YS5mb3JFYWNoKChwb2ludCwgaW5kZXgpID0+IHsKICAgICAgICBpZiAoIXBvaW50IHx8ICFkYXRhc2V0LmRhdGFbaW5kZXhdIHx8IGRhdGFzZXQuZGF0YVtpbmRleF0uZXJyb3IgPT09IHVuZGVmaW5lZCB8fCBkYXRhc2V0LmRhdGFbaW5kZXhdLmVycm9yID09PSBudWxsKSByZXR1cm47CiAgICAgICAgCiAgICAgICAgY29uc3QgeCA9IHBvaW50Lng7CiAgICAgICAgY29uc3QgeSA9IHBvaW50Lnk7CiAgICAgICAgY29uc3QgZXJyb3IgPSBkYXRhc2V0LmRhdGFbaW5kZXhdLmVycm9yOwogICAgICAgIGNvbnN0IHlTY2FsZSA9IGNoYXJ0LnNjYWxlcy55OwogICAgICAgIGNvbnN0IGVycm9yUGl4ZWxzID0gTWF0aC5hYnMoeVNjYWxlLmdldFBpeGVsRm9yVmFsdWUoeSArIGVycm9yKSAtIHlTY2FsZS5nZXRQaXhlbEZvclZhbHVlKHkpKTsKICAgICAgICAKICAgICAgICAvLyBEcmF3IHZlcnRpY2FsIGVycm9yIGJhcgogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKHgsIHkgLSBlcnJvclBpeGVscyk7CiAgICAgICAgY3R4LmxpbmVUbyh4LCB5ICsgZXJyb3JQaXhlbHMpOwogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAKICAgICAgICAvLyBEcmF3IGhvcml6b250YWwgY2FwcwogICAgICAgIGNvbnN0IGNhcFdpZHRoID0gNDsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyh4IC0gY2FwV2lkdGgsIHkgLSBlcnJvclBpeGVscyk7CiAgICAgICAgY3R4LmxpbmVUbyh4ICsgY2FwV2lkdGgsIHkgLSBlcnJvclBpeGVscyk7CiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICBjdHgubW92ZVRvKHggLSBjYXBXaWR0aCwgeSArIGVycm9yUGl4ZWxzKTsKICAgICAgICBjdHgubGluZVRvKHggKyBjYXBXaWR0aCwgeSArIGVycm9yUGl4ZWxzKTsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgIH0pOwogICAgICAKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgIH0pOwogIH0KfSk7CgovLyBSZWdpc3RlciBiYXNlbGluZSBsYWJlbCBwbHVnaW4gdG8gZGlzcGxheSBiYXNlbGluZSBudW1iZXJzIG9uIHRoZSBjaGFydApDaGFydC5yZWdpc3Rlcih7CiAgaWQ6ICJiYXNlbGluZUxhYmVscyIsCiAgYWZ0ZXJEYXRhc2V0c0RyYXc6IChjaGFydCkgPT4gewogICAgY29uc3QgY3R4ID0gY2hhcnQuY3R4OwogICAgY29uc3QgeFNjYWxlID0gY2hhcnQuc2NhbGVzLng7CiAgICBjb25zdCB5U2NhbGUgPSBjaGFydC5zY2FsZXMueTsKICAgIAogICAgY2hhcnQuZGF0YS5kYXRhc2V0cy5mb3JFYWNoKChkYXRhc2V0LCBkYXRhc2V0SW5kZXgpID0+IHsKICAgICAgLy8gT25seSBwcm9jZXNzIGJhc2VsaW5lIGxpbmVzIChpZGVudGlmaWVkIGJ5IGhhdmluZyBleGFjdGx5IDIgcG9pbnRzIGFuZCBvcmRlciA9PT0gMTAwMCkKICAgICAgaWYgKCFkYXRhc2V0LmRhdGEgfHwgZGF0YXNldC5kYXRhLmxlbmd0aCAhPT0gMiB8fCBkYXRhc2V0Lm9yZGVyICE9PSAxMDAwKSByZXR1cm47CiAgICAgIAogICAgICAvLyBFeHRyYWN0IGJhc2VsaW5lIHZhbHVlIGZyb20gbGFiZWwgKGZvcm1hdDogImxhYmVsIChiYXNlbGluZTogdmFsdWUpIikKICAgICAgY29uc3QgYmFzZWxpbmVNYXRjaCA9IGRhdGFzZXQubGFiZWwubWF0Y2goL1woYmFzZWxpbmU6XHMqKFtcZC5dKylcKS8pOwogICAgICBpZiAoIWJhc2VsaW5lTWF0Y2gpIHJldHVybjsKICAgICAgCiAgICAgIGNvbnN0IGJhc2VsaW5lVmFsdWUgPSBwYXJzZUZsb2F0KGJhc2VsaW5lTWF0Y2hbMV0pOwogICAgICBpZiAoaXNOYU4oYmFzZWxpbmVWYWx1ZSkpIHJldHVybjsKICAgICAgCiAgICAgIC8vIEdldCB0aGUgeSBwb3NpdGlvbiBvZiB0aGUgYmFzZWxpbmUKICAgICAgY29uc3QgYmFzZWxpbmVZID0gZGF0YXNldC5kYXRhWzBdLnk7CiAgICAgIGNvbnN0IHlQaXhlbCA9IHlTY2FsZS5nZXRQaXhlbEZvclZhbHVlKGJhc2VsaW5lWSk7CiAgICAgIAogICAgICAvLyBQb3NpdGlvbiB0ZXh0IGF0IHRoZSByaWdodCBlZGdlIG9mIHRoZSBjaGFydCwgc2xpZ2h0bHkgb2Zmc2V0IGZyb20gdGhlIGxpbmUKICAgICAgY29uc3QgY2hhcnRBcmVhID0gY2hhcnQuY2hhcnRBcmVhOwogICAgICBjb25zdCB0ZXh0WCA9IGNoYXJ0QXJlYS5yaWdodCAtIDEwOyAvLyAxMHB4IGZyb20gcmlnaHQgZWRnZQogICAgICBjb25zdCB0ZXh0WSA9IHlQaXhlbCAtIDU7IC8vIDVweCBhYm92ZSB0aGUgbGluZQogICAgICAKICAgICAgY3R4LnNhdmUoKTsKICAgICAgY3R4LmZvbnQgPSAiMTJweCBBcmlhbCI7CiAgICAgIGN0eC5maWxsU3R5bGUgPSBkYXRhc2V0LmJvcmRlckNvbG9yIHx8ICJyZ2JhKDEyOCwgMTI4LCAxMjgsIDAuNykiOwogICAgICBjdHgudGV4dEFsaWduID0gInJpZ2h0IjsKICAgICAgY3R4LnRleHRCYXNlbGluZSA9ICJib3R0b20iOwogICAgICAKICAgICAgLy8gRHJhdyBiYWNrZ3JvdW5kIHJlY3RhbmdsZSBmb3IgYmV0dGVyIHJlYWRhYmlsaXR5CiAgICAgIGNvbnN0IHRleHQgPSBiYXNlbGluZVZhbHVlLnRvRml4ZWQoMik7CiAgICAgIGNvbnN0IHRleHRNZXRyaWNzID0gY3R4Lm1lYXN1cmVUZXh0KHRleHQpOwogICAgICBjb25zdCBwYWRkaW5nID0gNDsKICAgICAgY3R4LmZpbGxTdHlsZSA9ICJyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuOCkiOwogICAgICBjdHguZmlsbFJlY3QoCiAgICAgICAgdGV4dFggLSB0ZXh0TWV0cmljcy53aWR0aCAtIHBhZGRpbmcsCiAgICAgICAgdGV4dFkgLSAxMiAtIHBhZGRpbmcsCiAgICAgICAgdGV4dE1ldHJpY3Mud2lkdGggKyBwYWRkaW5nICogMiwKICAgICAgICAxMiArIHBhZGRpbmcgKiAyCiAgICAgICk7CiAgICAgIAogICAgICAvLyBEcmF3IHRoZSB0ZXh0CiAgICAgIGN0eC5maWxsU3R5bGUgPSBkYXRhc2V0LmJvcmRlckNvbG9yIHx8ICJyZ2JhKDEyOCwgMTI4LCAxMjgsIDAuOSkiOwogICAgICBjdHguZmlsbFRleHQodGV4dCwgdGV4dFgsIHRleHRZKTsKICAgICAgCiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICB9KTsKICB9Cn0pOwoKZnVuY3Rpb24gZGlzcGxheVdhcm5pbmdzKCkgewogIGNvbnN0IHdhcm5pbmdCYW5uZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgid2FybmluZy1iYW5uZXIiKTsKICBpZiAoIXdhcm5pbmdCYW5uZXIgfHwgIXZpZXdlckRhdGEgfHwgIXZpZXdlckRhdGEuY29uZmlnKSB7CiAgICByZXR1cm47CiAgfQogIAogIGNvbnN0IHdhcm5pbmdzID0gdmlld2VyRGF0YS5jb25maWcud2FybmluZ3MgfHwge307CiAgY29uc3QgZHVwbGljYXRlQ29sdW1ucyA9IHdhcm5pbmdzLmR1cGxpY2F0ZV9jb2x1bW5zIHx8IFtdOwogIAogIGlmIChkdXBsaWNhdGVDb2x1bW5zLmxlbmd0aCA9PT0gMCkgewogICAgd2FybmluZ0Jhbm5lci5jbGFzc0xpc3QucmVtb3ZlKCJzaG93Iik7CiAgICByZXR1cm47CiAgfQogIAogIC8vIEJ1aWxkIHdhcm5pbmcgbWVzc2FnZSAtIHNob3J0ZXIgdmVyc2lvbgogIGxldCBodG1sID0gJzxoMz7imqDvuI8gV2FybmluZzogRHVwbGljYXRlIFdlbGxzIERldGVjdGVkPC9oMz4nOwogIAogIGR1cGxpY2F0ZUNvbHVtbnMuZm9yRWFjaCh3YXJuaW5nID0+IHsKICAgIGNvbnN0IGZpbGVzID0gd2FybmluZy5maWxlcyB8fCBbXTsKICAgIGNvbnN0IHdlbGxJZHMgPSB3YXJuaW5nLndlbGxfaWRzIHx8IFtdOwogICAgY29uc3QgZmlsZXNTdHIgPSBmaWxlcy5qb2luKCIgYW5kICIpOwogICAgY29uc3Qgd2VsbHNTdHIgPSB3ZWxsSWRzLmxlbmd0aCA8PSAxMCAKICAgICAgPyB3ZWxsSWRzLmpvaW4oIiwgIikKICAgICAgOiB3ZWxsSWRzLnNsaWNlKDAsIDEwKS5qb2luKCIsICIpICsgYCwgLi4uICgke3dlbGxJZHMubGVuZ3RofSB0b3RhbClgOwogICAgCiAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiA4cHg7Ij48c3Ryb25nPiR7ZmlsZXNTdHJ9PC9zdHJvbmc+IGhhdmUgZHVwbGljYXRlIHdlbGxzOiAke3dlbGxzU3RyfTwvZGl2PmA7CiAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSJtYXJnaW4tbGVmdDogMTZweDsgZm9udC1zaXplOiAwLjg1cmVtOyBjb2xvcjogIzY2NjsgbWFyZ2luLWJvdHRvbTogMTJweDsiPk9ubHkgZGF0YSBmcm9tICc8c3Ryb25nPiR7ZmlsZXNbMF19PC9zdHJvbmc+JyAoZmlyc3QgYWxwaGFiZXRpY2FsbHkpIGlzIHVzZWQuPC9kaXY+YDsKICB9KTsKICAKICB3YXJuaW5nQmFubmVyLmlubmVySFRNTCA9IGh0bWw7CiAgd2FybmluZ0Jhbm5lci5jbGFzc0xpc3QuYWRkKCJzaG93Iik7Cn0KCmFzeW5jIGZ1bmN0aW9uIGxvYWREYXRhKCkgewogIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKCJ2aWV3ZXJfZGF0YS5qc29uIik7CiAgdmlld2VyRGF0YSA9IGF3YWl0IHJlcy5qc29uKCk7CiAgY29tYmluZUFsbFdlbGxzKCk7CiAgLy8gSW5pdGlhbGl6ZSB0cmlwbGljYXRlIGdyb3VwIGNvbG9ycyBiZWZvcmUgcmVuZGVyaW5nCiAgaW5pdGlhbGl6ZVRyaXBsaWNhdGVHcm91cENvbG9ycygpOwogIGRpc3BsYXlXYXJuaW5ncygpOwogIGluaXREYXRhc2V0U2VsZWN0KCk7CiAgcmVuZGVyUGxhdGVHcmlkKCk7Cn0KCmZ1bmN0aW9uIGNvbWJpbmVBbGxXZWxscygpIHsKICAvLyBDb21iaW5lIGFsbCB3ZWxscyBmcm9tIGFsbCBwbGF0ZXMgaW50byBhIHNpbmdsZSBzdHJ1Y3R1cmUKICBhbGxXZWxsc0RhdGEgPSB7fTsKICB2aWV3ZXJEYXRhLnBsYXRlcy5mb3JFYWNoKHBsYXRlID0+IHsKICAgIGFsbFdlbGxzRGF0YVtwbGF0ZS5pZF0gPSBwbGF0ZS53ZWxsczsKICB9KTsKfQoKZnVuY3Rpb24gaW5pdERhdGFzZXRTZWxlY3QoKSB7CiAgY29uc3Qgc2VsZWN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImRhdGFzZXQtc2VsZWN0Iik7CiAgc2VsZWN0LmlubmVySFRNTCA9ICIiOwogIAogIC8vIEdyb3VwIHBsYXRlcyBieSBjb2x1bW5fZ3JvdXAKICBjb25zdCBwbGF0ZXNCeUdyb3VwID0ge307CiAgdmlld2VyRGF0YS5wbGF0ZXMuZm9yRWFjaChwbGF0ZSA9PiB7CiAgICBjb25zdCBncm91cCA9IHBsYXRlLmNvbHVtbl9ncm91cCB8fCAiT3RoZXIiOwogICAgaWYgKCFwbGF0ZXNCeUdyb3VwW2dyb3VwXSkgewogICAgICBwbGF0ZXNCeUdyb3VwW2dyb3VwXSA9IFtdOwogICAgfQogICAgcGxhdGVzQnlHcm91cFtncm91cF0ucHVzaChwbGF0ZSk7CiAgfSk7CiAgCiAgLy8gU29ydCBncm91cHMgYWxwaGFiZXRpY2FsbHkKICBjb25zdCBzb3J0ZWRHcm91cHMgPSBPYmplY3Qua2V5cyhwbGF0ZXNCeUdyb3VwKS5zb3J0KCk7CiAgCiAgLy8gQ3JlYXRlIG9wdGlvbnMgZm9yIGVhY2ggZ3JvdXAgKHRoZSBncm91cCBpdHNlbGYgaXMgc2VsZWN0YWJsZSkKICBzb3J0ZWRHcm91cHMuZm9yRWFjaChncm91cE5hbWUgPT4gewogICAgY29uc3QgcGxhdGVzID0gcGxhdGVzQnlHcm91cFtncm91cE5hbWVdOwogICAgCiAgICBjb25zdCBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKTsKICAgIC8vIFVzZSBzcGVjaWFsIHByZWZpeCB0byBpZGVudGlmeSBncm91cCBzZWxlY3Rpb25zCiAgICBvcHRpb24udmFsdWUgPSBgZ3JvdXA6JHtncm91cE5hbWV9YDsKICAgIAogICAgLy8gQ3JlYXRlIGZyaWVuZGx5IG5hbWUgZnJvbSBmaXJzdCBwbGF0ZSdzIGNvbHVtbiBpbmZvCiAgICBjb25zdCBmaXJzdFBsYXRlID0gcGxhdGVzWzBdOwogICAgY29uc3QgY29sdW1uSW5mbyA9IGZpcnN0UGxhdGUuY29sdW1uX2luZm8gfHwge307CiAgICBjb25zdCBwYXJ0cyA9IFtdOwogICAgaWYgKGNvbHVtbkluZm8ucHJvdGVpbikgcGFydHMucHVzaChjb2x1bW5JbmZvLnByb3RlaW4pOwogICAgaWYgKGNvbHVtbkluZm8uZ2Vub3R5cGUpIHBhcnRzLnB1c2goY29sdW1uSW5mby5nZW5vdHlwZSk7CiAgICBpZiAoY29sdW1uSW5mby5idWZmZXIpIHBhcnRzLnB1c2goY29sdW1uSW5mby5idWZmZXIpOwogICAgCiAgICAvLyBBZGQgY291bnQgaWYgbXVsdGlwbGUgZGF0YXNldHMKICAgIGlmIChwbGF0ZXMubGVuZ3RoID4gMSkgewogICAgICBvcHRpb24udGV4dENvbnRlbnQgPSBwYXJ0cy5sZW5ndGggPiAwIAogICAgICAgID8gYCR7cGFydHMuam9pbigiIC0gIil9ICgke3BsYXRlcy5sZW5ndGh9IGRhdGFzZXRzKWAKICAgICAgICA6IGAke2dyb3VwTmFtZX0gKCR7cGxhdGVzLmxlbmd0aH0gZGF0YXNldHMpYDsKICAgIH0gZWxzZSB7CiAgICAgIG9wdGlvbi50ZXh0Q29udGVudCA9IHBhcnRzLmxlbmd0aCA+IDAgCiAgICAgICAgPyBwYXJ0cy5qb2luKCIgLSAiKQogICAgICAgIDogZ3JvdXBOYW1lOwogICAgfQogICAgCiAgICBzZWxlY3QuYXBwZW5kQ2hpbGQob3B0aW9uKTsKICB9KTsKICAKICAvLyBTZWxlY3QgZmlyc3QgZ3JvdXAgYnkgZGVmYXVsdAogIGlmIChzb3J0ZWRHcm91cHMubGVuZ3RoID4gMCkgewogICAgc2VsZWN0ZWREYXRhc2V0SWQgPSBgZ3JvdXA6JHtzb3J0ZWRHcm91cHNbMF19YDsKICAgIHNlbGVjdC52YWx1ZSA9IHNlbGVjdGVkRGF0YXNldElkOwogIH0KICAKICBzZWxlY3QuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgKCkgPT4gewogICAgc2VsZWN0ZWREYXRhc2V0SWQgPSBzZWxlY3QudmFsdWU7CiAgICAvLyBDbGVhbiB1cCBzZWxlY3RlZCB3ZWxscyAtIG9ubHkga2VlcCB3ZWxscyBmcm9tIHNlbGVjdGVkIGRhdGFzZXRzCiAgICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogICAgY29uc3QgbmV3U2VsZWN0ZWRXZWxscyA9IG5ldyBTZXQoKTsKICAgIHNlbGVjdGVkV2VsbHMuZm9yRWFjaChrZXkgPT4gewogICAgICBjb25zdCBbcGxhdGVJZF0gPSBrZXkuc3BsaXQoIjoiKTsKICAgICAgaWYgKHNlbGVjdGVkRGF0YXNldHMuaW5jbHVkZXMocGxhdGVJZCkpIHsKICAgICAgICBuZXdTZWxlY3RlZFdlbGxzLmFkZChrZXkpOwogICAgICB9CiAgICB9KTsKICAgIHNlbGVjdGVkV2VsbHMgPSBuZXdTZWxlY3RlZFdlbGxzOwogICAgLy8gUmVzZXQgZW5hYmxlZCBkYXRhc2V0cy93ZWxscy9jb2x1bW5zIHdoZW4gY2hhbmdpbmcgZGF0YXNldCBncm91cAogICAgZW5hYmxlZERhdGFzZXRzLmNsZWFyKCk7CiAgICBlbmFibGVkV2VsbHMuY2xlYXIoKTsKICAgIGVuYWJsZWRDb2x1bW5zLmNsZWFyKCk7CiAgICAKICAgIHJlbmRlclBsYXRlR3JpZCgpOwogICAgdXBkYXRlV2VsbEluZm8oKTsKICAgIHVwZGF0ZURhdGFzZXRJbmZvKCk7CiAgICByZW5kZXJXZWxsU2VsZWN0b3JHcmlkKCk7CiAgfSk7CiAgCiAgLy8gVXBkYXRlIGluZm8gb24gaW5pdGlhbCBsb2FkCiAgdXBkYXRlRGF0YXNldEluZm8oKTsKfQoKZnVuY3Rpb24gdXBkYXRlRGF0YXNldEluZm8oKSB7CiAgY29uc3QgaW5mb0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJkYXRhc2V0LWRldGFpbHMiKTsKICBpZiAoIWluZm9EaXYgfHwgIXNlbGVjdGVkRGF0YXNldElkKSB7CiAgICBpZiAoaW5mb0RpdikgewogICAgICBpbmZvRGl2LnRleHRDb250ZW50ID0gIlNlbGVjdCBhIGRhdGFzZXQgdG8gdmlldyBkZXRhaWxzLiI7CiAgICB9CiAgICByZXR1cm47CiAgfQogIAogIGNvbnN0IHNlbGVjdGVkRGF0YXNldHMgPSBnZXRTZWxlY3RlZERhdGFzZXRzKCk7CiAgaWYgKHNlbGVjdGVkRGF0YXNldHMubGVuZ3RoID09PSAwKSB7CiAgICBpbmZvRGl2LnRleHRDb250ZW50ID0gIk5vIGRhdGFzZXQgc2VsZWN0ZWQuIjsKICAgIHJldHVybjsKICB9CiAgCiAgLy8gR2V0IG1ldGFkYXRhIGZyb20gZmlyc3QgZGF0YXNldAogIGNvbnN0IGZpcnN0UGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gc2VsZWN0ZWREYXRhc2V0c1swXSk7CiAgaWYgKCFmaXJzdFBsYXRlKSB7CiAgICBpbmZvRGl2LnRleHRDb250ZW50ID0gIkRhdGFzZXQgaW5mb3JtYXRpb24gbm90IGF2YWlsYWJsZS4iOwogICAgcmV0dXJuOwogIH0KICAKICBjb25zdCBjb2x1bW5JbmZvID0gZmlyc3RQbGF0ZS5jb2x1bW5faW5mbyB8fCB7fTsKICBjb25zdCBhbGxQbGF0ZXMgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maWx0ZXIocCA9PiBzZWxlY3RlZERhdGFzZXRzLmluY2x1ZGVzKHAuaWQpKTsKICAKICAvLyBCdWlsZCBpbmZvIEhUTUwKICBsZXQgaHRtbCA9ICIiOwogIAogIGlmIChjb2x1bW5JbmZvLnByb3RlaW4pIHsKICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDRweDsiPjxzdHJvbmc+UHJvdGVpbjo8L3N0cm9uZz4gJHtjb2x1bW5JbmZvLnByb3RlaW59PC9kaXY+YDsKICB9CiAgaWYgKGNvbHVtbkluZm8uZ2Vub3R5cGUpIHsKICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDRweDsiPjxzdHJvbmc+R2Vub3R5cGU6PC9zdHJvbmc+ICR7Y29sdW1uSW5mby5nZW5vdHlwZX08L2Rpdj5gOwogIH0KICBpZiAoY29sdW1uSW5mby5idWZmZXIpIHsKICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9Im1hcmdpbi1ib3R0b206IDRweDsiPjxzdHJvbmc+QnVmZmVyOjwvc3Ryb25nPiAke2NvbHVtbkluZm8uYnVmZmVyfTwvZGl2PmA7CiAgfQogIGlmIChjb2x1bW5JbmZvLnNjaWVudGlzdCkgewogICAgaHRtbCArPSBgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogNHB4OyI+PHN0cm9uZz5TY2llbnRpc3Q6PC9zdHJvbmc+ICR7Y29sdW1uSW5mby5zY2llbnRpc3R9PC9kaXY+YDsKICB9CiAgCiAgaHRtbCArPSBgPGRpdiBzdHlsZT0ibWFyZ2luLXRvcDogOHB4OyBwYWRkaW5nLXRvcDogOHB4OyBib3JkZXItdG9wOiAxcHggc29saWQgI2RkZDsiPmA7CiAgaHRtbCArPSBgPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbTogNHB4OyI+PHN0cm9uZz5EYXRhc2V0czo8L3N0cm9uZz4gJHthbGxQbGF0ZXMubGVuZ3RofTwvZGl2PmA7CiAgaHRtbCArPSBgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAwLjhyZW07IGNvbG9yOiAjNjY2OyI+YDsKICBhbGxQbGF0ZXMuZm9yRWFjaCgocGxhdGUsIGlkeCkgPT4gewogICAgaHRtbCArPSBgJHtpZHggKyAxfS4gJHtwbGF0ZS5maWxlIHx8IHBsYXRlLmlkfWA7CiAgICBpZiAocGxhdGUuY29sdW1uX2luZm8gJiYgcGxhdGUuY29sdW1uX2luZm8ubnVtYmVyKSB7CiAgICAgIGh0bWwgKz0gYCAoJHtwbGF0ZS5jb2x1bW5faW5mby5udW1iZXJ9KWA7CiAgICB9CiAgICBodG1sICs9ICI8YnI+IjsKICB9KTsKICBodG1sICs9IGA8L2Rpdj48L2Rpdj5gOwogIAogIGluZm9EaXYuaW5uZXJIVE1MID0gaHRtbDsKfQoKZnVuY3Rpb24gZ2V0U2VsZWN0ZWREYXRhc2V0cygpIHsKICAvLyBSZXR1cm4gYWxsIGRhdGFzZXRzIGluIHRoZSBzZWxlY3RlZCBncm91cCwgZmlsdGVyZWQgYnkgZW5hYmxlZERhdGFzZXRzCiAgaWYgKCFzZWxlY3RlZERhdGFzZXRJZCkgewogICAgcmV0dXJuIFtdOwogIH0KICAKICBsZXQgZGF0YXNldHMgPSBbXTsKICAKICAvLyBDaGVjayBpZiBpdCdzIGEgZ3JvdXAgc2VsZWN0aW9uIChmb3JtYXQ6ICJncm91cDpHUk9VUF9OQU1FIikKICBpZiAoc2VsZWN0ZWREYXRhc2V0SWQuc3RhcnRzV2l0aCgiZ3JvdXA6IikpIHsKICAgIGNvbnN0IGdyb3VwTmFtZSA9IHNlbGVjdGVkRGF0YXNldElkLnN1YnN0cmluZyg2KTsgLy8gUmVtb3ZlICJncm91cDoiIHByZWZpeAogICAgY29uc3Qgc2VsZWN0ZWRQbGF0ZXMgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maWx0ZXIocCA9PiBwLmNvbHVtbl9ncm91cCA9PT0gZ3JvdXBOYW1lKTsKICAgIGRhdGFzZXRzID0gc2VsZWN0ZWRQbGF0ZXMubWFwKHAgPT4gcC5pZCk7CiAgfSBlbHNlIHsKICAgIC8vIE90aGVyd2lzZSwgaXQncyBhIHNpbmdsZSBkYXRhc2V0IHNlbGVjdGlvbiAobGVnYWN5IHN1cHBvcnQpCiAgICBjb25zdCBwbGF0ZSA9IHZpZXdlckRhdGEucGxhdGVzLmZpbmQocCA9PiBwLmlkID09PSBzZWxlY3RlZERhdGFzZXRJZCk7CiAgICBpZiAocGxhdGUpIHsKICAgICAgZGF0YXNldHMgPSBbc2VsZWN0ZWREYXRhc2V0SWRdOwogICAgfQogIH0KICAKICAvLyBGaWx0ZXIgYnkgZW5hYmxlZERhdGFzZXRzIGlmIGFueSBhcmUgc2V0CiAgaWYgKGVuYWJsZWREYXRhc2V0cy5zaXplID4gMCkgewogICAgcmV0dXJuIGRhdGFzZXRzLmZpbHRlcihpZCA9PiBlbmFibGVkRGF0YXNldHMuaGFzKGlkKSk7CiAgfQogIAogIHJldHVybiBkYXRhc2V0czsKfQoKZnVuY3Rpb24gdG9nZ2xlV2VsbFNlbGVjdG9yKCkgewogIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ3ZWxsLXNlbGVjdG9yLWdyaWQtY29udGFpbmVyIik7CiAgY29uc3QgYXJyb3cgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgid2VsbC1zZWxlY3Rvci1hcnJvdyIpOwogIGlmIChjb250YWluZXIuc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiKSB7CiAgICBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICBhcnJvdy50ZXh0Q29udGVudCA9ICLilrIiOwogICAgcmVuZGVyV2VsbFNlbGVjdG9yR3JpZCgpOwogIH0gZWxzZSB7CiAgICBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIGFycm93LnRleHRDb250ZW50ID0gIuKWvCI7CiAgfQp9CgpmdW5jdGlvbiB0b2dnbGVCYXNlbGluZU9wdGlvbnMoKSB7CiAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJhc2VsaW5lLW9wdGlvbnMtY29udGVudCIpOwogIGNvbnN0IGFycm93ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJhc2VsaW5lLW9wdGlvbnMtYXJyb3ciKTsKICBpZiAoY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPT09ICJub25lIikgewogICAgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgYXJyb3cudGV4dENvbnRlbnQgPSAi4payIjsKICB9IGVsc2UgewogICAgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICBhcnJvdy50ZXh0Q29udGVudCA9ICLilrwiOwogIH0KfQoKZnVuY3Rpb24gdXBkYXRlQmFzZWxpbmVNZXRob2RQYXJhbXMoKSB7CiAgY29uc3QgbWV0aG9kID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImJhc2VsaW5lLW1ldGhvZC1zZWxlY3QiKS52YWx1ZTsKICBjb25zdCBsb3dlc3NQYXJhbXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtbG93ZXNzLXBhcmFtcyIpOwogIGNvbnN0IHBvbHlub21pYWxQYXJhbXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtcG9seW5vbWlhbC1wYXJhbXMiKTsKICAKICBpZiAobWV0aG9kID09PSAibG93ZXNzIikgewogICAgbG93ZXNzUGFyYW1zLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgcG9seW5vbWlhbFBhcmFtcy5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogIH0gZWxzZSBpZiAobWV0aG9kID09PSAicG9seW5vbWlhbCIpIHsKICAgIGxvd2Vzc1BhcmFtcy5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgcG9seW5vbWlhbFBhcmFtcy5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICB9IGVsc2UgewogICAgLy8gY29uc3RhbnQKICAgIGxvd2Vzc1BhcmFtcy5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgcG9seW5vbWlhbFBhcmFtcy5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogIH0KICAKICB1cGRhdGVDdXJyZW50U2V0dGluZ3NEaXNwbGF5KCk7Cn0KCmZ1bmN0aW9uIHVwZGF0ZVJlZ3Jlc3Npb25UeXBlUGFyYW1zKHNraXBDaGFydFVwZGF0ZSkgewogIGNvbnN0IHJlZ3Jlc3Npb25UeXBlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlZ3Jlc3Npb24tdHlwZS1zZWxlY3QiKS52YWx1ZTsKICBjb25zdCBwb2x5bm9taWFsT3JkZXJEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi1wb2x5bm9taWFsLW9yZGVyIik7CiAgY29uc3QgaW5mb1BhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlZ3Jlc3Npb24taW5mby1wYW5lbCIpOwogIGNvbnN0IGZpdFJlZ3Jlc3Npb25Ub2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZml0LXJlZ3Jlc3Npb24tdG9nZ2xlIik7CiAgCiAgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAicG9seW5vbWlhbCIgJiYgcG9seW5vbWlhbE9yZGVyRGl2KSB7CiAgICBwb2x5bm9taWFsT3JkZXJEaXYuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgfSBlbHNlIGlmIChwb2x5bm9taWFsT3JkZXJEaXYpIHsKICAgIHBvbHlub21pYWxPcmRlckRpdi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogIH0KICAKICAvLyBTaG93L2hpZGUgaW5mbyBwYW5lbCBmb3IgbW9uby1leHBvbmVudGlhbCAob25seSBpZiByZWdyZXNzaW9uIHRvZ2dsZSBpcyBjaGVja2VkKQogIGlmIChpbmZvUGFuZWwpIHsKICAgIGNvbnN0IGlzUmVncmVzc2lvbkVuYWJsZWQgPSBmaXRSZWdyZXNzaW9uVG9nZ2xlICYmIGZpdFJlZ3Jlc3Npb25Ub2dnbGUuY2hlY2tlZDsKICAgIGlmIChyZWdyZXNzaW9uVHlwZSA9PT0gIm1vbm8tZXhwb25lbnRpYWwiICYmIGlzUmVncmVzc2lvbkVuYWJsZWQpIHsKICAgICAgaW5mb1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgfSBlbHNlIHsKICAgICAgaW5mb1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICB9CiAgfQogIAogIHVwZGF0ZUN1cnJlbnRTZXR0aW5nc0Rpc3BsYXkoKTsKICAKICAvLyBVcGRhdGUgY2hhcnQgd2hlbiByZWdyZXNzaW9uIHR5cGUgY2hhbmdlcyAodW5sZXNzIHNraXBwZWQgZm9yIGluaXRpYWxpemF0aW9uKQogIGlmICghc2tpcENoYXJ0VXBkYXRlKSB7CiAgICB1cGRhdGVDaGFydCgpOwogIH0KfQoKZnVuY3Rpb24gdXBkYXRlQ3VycmVudFNldHRpbmdzRGlzcGxheSgpIHsKICBjb25zdCBiYXNlbGluZU1ldGhvZFNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJiYXNlbGluZS1tZXRob2Qtc2VsZWN0Iik7CiAgY29uc3Qgbm9ybWFsaXphdGlvbk1vZGVTZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibm9ybWFsaXphdGlvbi1tb2RlLXNlbGVjdCIpOwogIGNvbnN0IHJlZ3Jlc3Npb25UeXBlU2VsZWN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlZ3Jlc3Npb24tdHlwZS1zZWxlY3QiKTsKICAKICBjb25zdCBiYXNlbGluZU1ldGhvZEVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImN1cnJlbnQtYmFzZWxpbmUtbWV0aG9kIik7CiAgY29uc3Qgbm9ybWFsaXphdGlvbk1vZGVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXJyZW50LW5vcm1hbGl6YXRpb24tbW9kZSIpOwogIGNvbnN0IHJlZ3Jlc3Npb25UeXBlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3VycmVudC1yZWdyZXNzaW9uLXR5cGUiKTsKICAKICBpZiAoYmFzZWxpbmVNZXRob2RFbCAmJiBiYXNlbGluZU1ldGhvZFNlbGVjdCkgewogICAgY29uc3QgbWV0aG9kID0gYmFzZWxpbmVNZXRob2RTZWxlY3QudmFsdWU7CiAgICBiYXNlbGluZU1ldGhvZEVsLnRleHRDb250ZW50ID0gbWV0aG9kLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbWV0aG9kLnNsaWNlKDEpOwogIH0KICAKICBpZiAobm9ybWFsaXphdGlvbk1vZGVFbCAmJiBub3JtYWxpemF0aW9uTW9kZVNlbGVjdCkgewogICAgY29uc3QgbW9kZSA9IG5vcm1hbGl6YXRpb25Nb2RlU2VsZWN0LnZhbHVlOwogICAgbm9ybWFsaXphdGlvbk1vZGVFbC50ZXh0Q29udGVudCA9IG1vZGUgPT09ICJkZWx0YV9mX292ZXJfZiIgPyAizpRGL0YiIDogIk11bHRpcGxpY2F0aXZlIjsKICB9CiAgCiAgaWYgKHJlZ3Jlc3Npb25UeXBlRWwgJiYgcmVncmVzc2lvblR5cGVTZWxlY3QpIHsKICAgIGNvbnN0IHR5cGUgPSByZWdyZXNzaW9uVHlwZVNlbGVjdC52YWx1ZTsKICAgIGNvbnN0IHR5cGVMYWJlbHMgPSB7CiAgICAgICJsaW5lYXIiOiAiTGluZWFyIiwKICAgICAgInBvbHlub21pYWwiOiAiUG9seW5vbWlhbCIsCiAgICAgICJleHBvbmVudGlhbCI6ICJFeHBvbmVudGlhbCIsCiAgICAgICJsb2dhcml0aG1pYyI6ICJMb2dhcml0aG1pYyIsCiAgICAgICJtb25vLWV4cG9uZW50aWFsIjogIk1vbm8tZXhwb25lbnRpYWwgcGxhdGVhdSIKICAgIH07CiAgICByZWdyZXNzaW9uVHlwZUVsLnRleHRDb250ZW50ID0gdHlwZUxhYmVsc1t0eXBlXSB8fCB0eXBlOwogIH0KfQoKZnVuY3Rpb24gcGFyc2VMYWJlbEZvckxlZ2VuZChsYWJlbCkgewogIC8vIFBhcnNlIGxhYmVsIGZvcm1hdDogIkUxNywgRjE3LCBHMTcsIEUxNCwgRzE0IC0gNTAwLTEwLTIgKFBMQ2VfV1RfQ2EpIENvbCAxNyAoNS1wbGljYXRlLCAyIGRhdGFzZXRzLCBtZWFuIMKxIFNFKSIKICAvLyBFeHRyYWN0IG1haW4gaGVhZGluZyAoZS5nLiwgIjUwMC0xMC0yIikgYW5kIHJldHVybiByZXN0IGFzIGRldGFpbHMKICAKICBpZiAoIWxhYmVsKSByZXR1cm4geyBtYWluSGVhZGluZzogbGFiZWwsIGRldGFpbHM6ICIiIH07CiAgCiAgLy8gUGF0dGVybiB0byBtYXRjaDogbnVtYmVyLW51bWJlci1udW1iZXIgKHRoZSBtYWluIGhlYWRpbmcgbGlrZSAiNTAwLTEwLTIiKQogIGNvbnN0IG1haW5IZWFkaW5nTWF0Y2ggPSBsYWJlbC5tYXRjaCgvXGIoXGQrLVxkKy1cZCspXGIvKTsKICAKICBpZiAobWFpbkhlYWRpbmdNYXRjaCkgewogICAgY29uc3QgbWFpbkhlYWRpbmcgPSBtYWluSGVhZGluZ01hdGNoWzFdOwogICAgY29uc3QgbWF0Y2hJbmRleCA9IG1haW5IZWFkaW5nTWF0Y2guaW5kZXg7CiAgICAKICAgIC8vIEdldCBwYXJ0cyBiZWZvcmUgYW5kIGFmdGVyIHRoZSBtYWluIGhlYWRpbmcKICAgIGNvbnN0IGJlZm9yZSA9IGxhYmVsLnN1YnN0cmluZygwLCBtYXRjaEluZGV4KS50cmltKCk7CiAgICBjb25zdCBhZnRlciA9IGxhYmVsLnN1YnN0cmluZyhtYXRjaEluZGV4ICsgbWFpbkhlYWRpbmcubGVuZ3RoKS50cmltKCk7CiAgICAKICAgIC8vIENvbWJpbmUgYmVmb3JlIGFuZCBhZnRlcgogICAgbGV0IGRldGFpbHMgPSAoYmVmb3JlICsgIiAiICsgYWZ0ZXIpLnRyaW0oKTsKICAgIC8vIENsZWFuIHVwIGV4dHJhIHNwYWNlcyBhbmQgZGFzaGVzCiAgICBkZXRhaWxzID0gZGV0YWlscy5yZXBsYWNlKC9ccyotXHMqL2csICIgLSAiKS5yZXBsYWNlKC9ccysvZywgIiAiKS50cmltKCk7CiAgICAvLyBSZW1vdmUgbGVhZGluZy90cmFpbGluZyBkYXNoZXMgYW5kIGNsZWFuIHVwCiAgICBkZXRhaWxzID0gZGV0YWlscy5yZXBsYWNlKC9eLVxzKi8sICIiKS5yZXBsYWNlKC9ccyotJC8sICIiKS50cmltKCk7CiAgICAKICAgIHJldHVybiB7IG1haW5IZWFkaW5nOiBtYWluSGVhZGluZywgZGV0YWlsczogZGV0YWlscyB9OwogIH0KICAKICAvLyBJZiBubyBwYXR0ZXJuIG1hdGNoLCByZXR1cm4gb3JpZ2luYWwgYXMgbWFpbiBoZWFkaW5nCiAgcmV0dXJuIHsgbWFpbkhlYWRpbmc6IGxhYmVsLCBkZXRhaWxzOiAiIiB9Owp9CgpmdW5jdGlvbiB1cGRhdGVNb25vRXhwb25lbnRpYWxJbmZvUGFuZWwobW9ub0V4cFBhcmFtcykgewogIGNvbnN0IGluZm9QYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZWdyZXNzaW9uLWluZm8tcGFuZWwiKTsKICBjb25zdCBpbmZvQ29udGVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZWdyZXNzaW9uLWluZm8tY29udGVudCIpOwogIAogIGlmICghaW5mb1BhbmVsIHx8ICFpbmZvQ29udGVudCkgewogICAgcmV0dXJuOwogIH0KICAKICBpZiAobW9ub0V4cFBhcmFtcy5sZW5ndGggPT09IDApIHsKICAgIGluZm9Db250ZW50LmlubmVySFRNTCA9ICI8ZGl2IHN0eWxlPSdjb2xvcjogIzY2NjsnPk5vIGZpdHMgYXZhaWxhYmxlLiBTZWxlY3Qgd2VsbHMgYW5kIGVuYWJsZSByZWdyZXNzaW9uLjwvZGl2PiI7CiAgICByZXR1cm47CiAgfQogIAogIC8vIEJ1aWxkIEhUTUwgZm9yIHBhcmFtZXRlcnMKICBsZXQgaHRtbCA9ICIiOwogIAogIC8vIE1vZGVsIGVxdWF0aW9uCiAgaHRtbCArPSAiPGRpdiBzdHlsZT0nbWFyZ2luLWJvdHRvbTogOHB4OyBwYWRkaW5nOiA0cHg7IGJhY2tncm91bmQ6IHdoaXRlOyBib3JkZXItcmFkaXVzOiAycHg7Jz4iOwogIGh0bWwgKz0gIjxzdHJvbmc+TW9kZWw6PC9zdHJvbmc+IHkodCkgPSAxICsgQSgxIC0gZTxzdXA+LWsodC104oKAKTwvc3VwPikiOwogIGh0bWwgKz0gIjwvZGl2PiI7CiAgCiAgLy8gUGFyYW1ldGVycyBmb3IgZWFjaCBmaXQKICBtb25vRXhwUGFyYW1zLmZvckVhY2goKGZpdCwgaWR4KSA9PiB7CiAgICBjb25zdCBwID0gZml0LnBhcmFtczsKICAgIGNvbnN0IGJvcmRlckNvbG9yID0gZml0LmNvbG9yIHx8ICcjMmE2Y2ZmJzsgLy8gVXNlIGRhdGFzZXQgY29sb3Igb3IgZGVmYXVsdCBibHVlCiAgICAKICAgIC8vIFBhcnNlIGxhYmVsIHRvIGV4dHJhY3QgbWFpbiBoZWFkaW5nIGFuZCBkZXRhaWxzCiAgICBjb25zdCBwYXJzZWQgPSBwYXJzZUxhYmVsRm9yTGVnZW5kKGZpdC5sYWJlbCk7CiAgICAKICAgIGh0bWwgKz0gYDxkaXYgc3R5bGU9J21hcmdpbi1ib3R0b206IDEycHg7IHBhZGRpbmc6IDhweDsgYmFja2dyb3VuZDogd2hpdGU7IGJvcmRlci1yYWRpdXM6IDJweDsgYm9yZGVyLWxlZnQ6IDNweCBzb2xpZCAke2JvcmRlckNvbG9yfTsnPmA7CiAgICAKICAgIC8vIE1haW4gaGVhZGluZyBpbiBjYXJkIGNvbG9yCiAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSdjb2xvcjogJHtib3JkZXJDb2xvcn07IGZvbnQtd2VpZ2h0OiA2MDA7IGZvbnQtc2l6ZTogMC45cmVtOyBtYXJnaW4tYm90dG9tOiA0cHg7Jz4ke3BhcnNlZC5tYWluSGVhZGluZ308L2Rpdj5gOwogICAgCiAgICAvLyBEZXRhaWxzIGluIGdyYXkgYmVsb3cKICAgIGlmIChwYXJzZWQuZGV0YWlscykgewogICAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSdjb2xvcjogIzY2NjsgZm9udC1zaXplOiAwLjdyZW07IG1hcmdpbi1ib3R0b206IDhweDsgbGluZS1oZWlnaHQ6IDEuMzsnPiR7cGFyc2VkLmRldGFpbHN9PC9kaXY+YDsKICAgIH0KICAgIAogICAgLy8gUGFyYW1ldGVycyBncmlkCiAgICBodG1sICs9IGA8ZGl2IHN0eWxlPSdkaXNwbGF5OiBncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmciAxZnI7IGdhcDogNHB4OyBmb250LXNpemU6IDAuN3JlbTsgbWFyZ2luLXRvcDogOHB4Oyc+YDsKICAgIAogICAgLy8gTGVmdCBjb2x1bW4KICAgIGh0bWwgKz0gYDxkaXY+PHN0cm9uZz5BIChhbXBsaXR1ZGUpOjwvc3Ryb25nPiAke3AuQS50b0ZpeGVkKDQpfTwvZGl2PmA7CiAgICBodG1sICs9IGA8ZGl2PjxzdHJvbmc+ayAocmF0ZSBjb25zdGFudCk6PC9zdHJvbmc+ICR7cC5rLnRvRml4ZWQoNil9IHPigbvCuTwvZGl2PmA7CiAgICBodG1sICs9IGA8ZGl2PjxzdHJvbmc+z4QgKHRpbWUgY29uc3RhbnQpOjwvc3Ryb25nPiAke3AudGF1LnRvRml4ZWQoMil9IHM8L2Rpdj5gOwogICAgCiAgICAvLyBSaWdodCBjb2x1bW4KICAgIGh0bWwgKz0gYDxkaXY+PHN0cm9uZz504oKAIChzdGFydCB0aW1lKTo8L3N0cm9uZz4gJHtwLnQwLnRvRml4ZWQoMil9IHM8L2Rpdj5gOwogICAgaHRtbCArPSBgPGRpdj48c3Ryb25nPnTigoEv4oKCIChoYWxmLXRpbWUpOjwvc3Ryb25nPiAke3AudEhhbGYudG9GaXhlZCgyKX0gczwvZGl2PmA7CiAgICBodG1sICs9IGA8ZGl2PjxzdHJvbmc+UGxhdGVhdTo8L3N0cm9uZz4gJHtwLnBsYXRlYXUudG9GaXhlZCg0KX08L2Rpdj5gOwogICAgCiAgICBodG1sICs9IGA8L2Rpdj48L2Rpdj5gOwogIH0pOwogIAogIGluZm9Db250ZW50LmlubmVySFRNTCA9IGh0bWw7Cn0KCmZ1bmN0aW9uIHJlbmRlcldlbGxTZWxlY3RvckdyaWQoKSB7CiAgY29uc3QgZ3JpZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ3ZWxsLXNlbGVjdG9yLWdyaWQiKTsKICBpZiAoIWdyaWQgfHwgIXNlbGVjdGVkRGF0YXNldElkKSB7CiAgICByZXR1cm47CiAgfQogIAogIGNvbnN0IHNlbGVjdGVkRGF0YXNldHMgPSBnZXRTZWxlY3RlZERhdGFzZXRzKCk7CiAgaWYgKHNlbGVjdGVkRGF0YXNldHMubGVuZ3RoID09PSAwKSB7CiAgICBncmlkLmlubmVySFRNTCA9ICI8ZGl2IHN0eWxlPSdjb2xvcjogIzY2NjsgZm9udC1zaXplOiAwLjhyZW07IHBhZGRpbmc6IDhweDsnPk5vIGRhdGFzZXRzIHNlbGVjdGVkLjwvZGl2PiI7CiAgICByZXR1cm47CiAgfQogIAogIGdyaWQuaW5uZXJIVE1MID0gIiI7CiAgCiAgLy8gQ29sbGVjdCBhbGwgdW5pcXVlIHdlbGwgSURzIGZyb20gc2VsZWN0ZWQgZGF0YXNldHMKICBjb25zdCBhbGxXZWxsc1NldCA9IG5ldyBTZXQoKTsKICBzZWxlY3RlZERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgIE9iamVjdC5rZXlzKHdlbGxzKS5mb3JFYWNoKHdlbGxJZCA9PiB7CiAgICAgIGFsbFdlbGxzU2V0LmFkZCh3ZWxsSWQpOwogICAgfSk7CiAgfSk7CiAgCiAgLy8gVG9wLWxlZnQgY29ybmVyCiAgY29uc3QgY29ybmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgY29ybmVyLmNsYXNzTmFtZSA9ICJ3ZWxsLXNlbGVjdG9yLWhlYWRlciI7CiAgZ3JpZC5hcHBlbmRDaGlsZChjb3JuZXIpOwogIAogIC8vIENvbHVtbiBoZWFkZXJzCiAgZm9yIChsZXQgYyA9IDE7IGMgPD0gUExBVEVfQ09MUzsgYysrKSB7CiAgICBjb25zdCBoZWFkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGhlYWRlci5jbGFzc05hbWUgPSAid2VsbC1zZWxlY3Rvci1oZWFkZXIiOwogICAgaGVhZGVyLnRleHRDb250ZW50ID0gYzsKICAgIGdyaWQuYXBwZW5kQ2hpbGQoaGVhZGVyKTsKICB9CiAgCiAgLy8gUm93cwogIFBMQVRFX1JPV1MuZm9yRWFjaChyb3dMZXR0ZXIgPT4gewogICAgLy8gUm93IGxhYmVsCiAgICBjb25zdCByb3dMYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgcm93TGFiZWwuY2xhc3NOYW1lID0gIndlbGwtc2VsZWN0b3ItaGVhZGVyIjsKICAgIHJvd0xhYmVsLnRleHRDb250ZW50ID0gcm93TGV0dGVyOwogICAgZ3JpZC5hcHBlbmRDaGlsZChyb3dMYWJlbCk7CiAgICAKICAgIC8vIFdlbGxzCiAgICBmb3IgKGxldCBjb2wgPSAxOyBjb2wgPD0gUExBVEVfQ09MUzsgY29sKyspIHsKICAgICAgY29uc3Qgd2VsbElkID0gcm93TGV0dGVyICsgU3RyaW5nKGNvbCk7CiAgICAgIGNvbnN0IGNlbGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgY2VsbC5jbGFzc05hbWUgPSAid2VsbC1zZWxlY3Rvci1jZWxsIjsKICAgICAgCiAgICAgIGNvbnN0IGhhc0RhdGEgPSBhbGxXZWxsc1NldC5oYXMod2VsbElkKTsKICAgICAgY29uc3QgaXNFeGNsdWRlZCA9IGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3ZWxsSWQpOwogICAgICAKICAgICAgaWYgKGhhc0RhdGEpIHsKICAgICAgICBjZWxsLmNsYXNzTGlzdC5hZGQoImhhcy1kYXRhIik7CiAgICAgICAgaWYgKGlzRXhjbHVkZWQpIHsKICAgICAgICAgIC8vIFVzZSBpbmxpbmUgc3R5bGVzIHdpdGggcmdiIHRvIGF2b2lkIGhleCBlc2NhcGluZyBpc3N1ZXMKICAgICAgICAgIGNlbGwuc3R5bGUuYmFja2dyb3VuZCA9ICJyZ2IoMjU1LCAyMDQsIDIwNCkiOwogICAgICAgICAgY2VsbC5zdHlsZS5ib3JkZXJDb2xvciA9ICJyZ2IoMjU1LCAxMDcsIDEwNykiOwogICAgICAgICAgY2VsbC5zdHlsZS5jb2xvciA9ICJyZ2IoMjA0LCAwLCAwKSI7CiAgICAgICAgICBjZWxsLnN0eWxlLmZvbnRXZWlnaHQgPSAiYm9sZCI7CiAgICAgICAgICBjZWxsLnRleHRDb250ZW50ID0gIuKclSI7CiAgICAgICAgICBjZWxsLnRpdGxlID0gYFdlbGwgJHt3ZWxsSWR9IC0gRVhDTFVERUQgKGNsaWNrIHRvIGluY2x1ZGUpYDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2VsbC50ZXh0Q29udGVudCA9IGNvbDsKICAgICAgICAgIGNlbGwudGl0bGUgPSBgV2VsbCAke3dlbGxJZH0gLSBDbGljayB0byBleGNsdWRlYDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgY2VsbC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgICAgICAgIHRvZ2dsZVdlbGxFeGNsdXNpb24od2VsbElkKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjZWxsLnN0eWxlLmJhY2tncm91bmQgPSAiI2YyZjJmMiI7CiAgICAgICAgY2VsbC5zdHlsZS5jdXJzb3IgPSAiZGVmYXVsdCI7CiAgICAgICAgY2VsbC5zdHlsZS5vcGFjaXR5ID0gIjAuNSI7CiAgICAgIH0KICAgICAgCiAgICAgIGdyaWQuYXBwZW5kQ2hpbGQoY2VsbCk7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIHRvZ2dsZVdlbGxFeGNsdXNpb24od2VsbElkKSB7CiAgaWYgKGVuYWJsZWRXZWxscy5zaXplID09PSAwKSB7CiAgICAvLyBJZiBubyBleGNsdXNpb25zIHlldCwgZmlyc3QgY29sbGVjdCBhbGwgYXZhaWxhYmxlIHdlbGxzCiAgICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogICAgY29uc3QgYWxsV2VsbHNTZXQgPSBuZXcgU2V0KCk7CiAgICBzZWxlY3RlZERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICBPYmplY3Qua2V5cyh3ZWxscykuZm9yRWFjaCh3SWQgPT4gewogICAgICAgIGFsbFdlbGxzU2V0LmFkZCh3SWQpOwogICAgICB9KTsKICAgIH0pOwogICAgLy8gRW5hYmxlIGFsbCBleGNlcHQgdGhlIG9uZSBiZWluZyBjbGlja2VkCiAgICBhbGxXZWxsc1NldC5mb3JFYWNoKHdJZCA9PiB7CiAgICAgIGlmICh3SWQgIT09IHdlbGxJZCkgewogICAgICAgIGVuYWJsZWRXZWxscy5hZGQod0lkKTsKICAgICAgfQogICAgfSk7CiAgfSBlbHNlIHsKICAgIC8vIFRvZ2dsZSB0aGlzIHNwZWNpZmljIHdlbGwKICAgIGlmIChlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCkpIHsKICAgICAgZW5hYmxlZFdlbGxzLmRlbGV0ZSh3ZWxsSWQpOwogICAgfSBlbHNlIHsKICAgICAgZW5hYmxlZFdlbGxzLmFkZCh3ZWxsSWQpOwogICAgfQogICAgCiAgICAvLyBJZiBhbGwgd2VsbHMgYXJlIGVuYWJsZWQsIGNsZWFyIHRoZSBzZXQgKG1lYW5pbmcgYWxsIGFyZSBlbmFibGVkKQogICAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICAgIGNvbnN0IGFsbFdlbGxzU2V0ID0gbmV3IFNldCgpOwogICAgc2VsZWN0ZWREYXRhc2V0cy5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBjb25zdCB3ZWxscyA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSB8fCB7fTsKICAgICAgT2JqZWN0LmtleXMod2VsbHMpLmZvckVhY2god0lkID0+IHsKICAgICAgICBhbGxXZWxsc1NldC5hZGQod0lkKTsKICAgICAgfSk7CiAgICB9KTsKICAgIAogICAgLy8gQ2hlY2sgaWYgYWxsIHdlbGxzIGFyZSBlbmFibGVkCiAgICBsZXQgYWxsRW5hYmxlZCA9IHRydWU7CiAgICBhbGxXZWxsc1NldC5mb3JFYWNoKHdJZCA9PiB7CiAgICAgIGlmICghZW5hYmxlZFdlbGxzLmhhcyh3SWQpKSB7CiAgICAgICAgYWxsRW5hYmxlZCA9IGZhbHNlOwogICAgICB9CiAgICB9KTsKICAgIAogICAgaWYgKGFsbEVuYWJsZWQpIHsKICAgICAgZW5hYmxlZFdlbGxzLmNsZWFyKCk7IC8vIENsZWFyIG1lYW5zIGFsbCBlbmFibGVkCiAgICB9CiAgfQogIAogIHJlbmRlcldlbGxTZWxlY3RvckdyaWQoKTsKICByZW5kZXJQbGF0ZUdyaWQoKTsKICB1cGRhdGVXZWxsSW5mbygpOwp9CgpmdW5jdGlvbiBnZXRBbGxEYXRhc2V0c0luR3JvdXAoKSB7CiAgLy8gR2V0IGFsbCBkYXRhc2V0cyBpbiB0aGUgc2VsZWN0ZWQgZ3JvdXAgKGJlZm9yZSBmaWx0ZXJpbmcgYnkgZW5hYmxlZERhdGFzZXRzKQogIGlmICghc2VsZWN0ZWREYXRhc2V0SWQpIHsKICAgIHJldHVybiBbXTsKICB9CiAgCiAgaWYgKHNlbGVjdGVkRGF0YXNldElkLnN0YXJ0c1dpdGgoImdyb3VwOiIpKSB7CiAgICBjb25zdCBncm91cE5hbWUgPSBzZWxlY3RlZERhdGFzZXRJZC5zdWJzdHJpbmcoNik7CiAgICBjb25zdCBzZWxlY3RlZFBsYXRlcyA9IHZpZXdlckRhdGEucGxhdGVzLmZpbHRlcihwID0+IHAuY29sdW1uX2dyb3VwID09PSBncm91cE5hbWUpOwogICAgcmV0dXJuIHNlbGVjdGVkUGxhdGVzLm1hcChwID0+IHAuaWQpOwogIH0gZWxzZSB7CiAgICBjb25zdCBwbGF0ZSA9IHZpZXdlckRhdGEucGxhdGVzLmZpbmQocCA9PiBwLmlkID09PSBzZWxlY3RlZERhdGFzZXRJZCk7CiAgICByZXR1cm4gcGxhdGUgPyBbc2VsZWN0ZWREYXRhc2V0SWRdIDogW107CiAgfQp9CgpmdW5jdGlvbiBpbml0aWFsaXplVHJpcGxpY2F0ZUdyb3VwQ29sb3JzKCkgewogIC8vIEluaXRpYWxpemUgY29sb3IgbWFwIGlmIG5lZWRlZCAoZG9uJ3QgcmVzZXQgLSBrZWVwIGNvbnNpc3RlbnQgY29sb3JzKQogIC8vIFRoaXMgZW5zdXJlcyBhbGwgd2VsbHMgd2l0aCB0aGUgc2FtZSB0cmlwbGljYXRlIGdyb3VwIG5hbWUgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgLy8gRm9yIGV4YW1wbGUsIGFsbCB3ZWxscyBpbiByb3dzIEIsIEMsIEQgd2l0aCBncm91cCBuYW1lICIyNTAtMTAtMiIgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgaWYgKE9iamVjdC5rZXlzKHRyaXBsaWNhdGVHcm91cENvbG9yTWFwKS5sZW5ndGggPT09IDAgJiYgdmlld2VyRGF0YSAmJiB2aWV3ZXJEYXRhLmNvbmZpZykgewogICAgY29uc3QgdHJpcGxpY2F0ZUdyb3VwcyA9IHZpZXdlckRhdGEuY29uZmlnLnRyaXBsaWNhdGVfZ3JvdXBzIHx8IFtdOwogICAgbGV0IGNvbG9ySW5kZXggPSAwOwogICAgdHJpcGxpY2F0ZUdyb3Vwcy5mb3JFYWNoKGdyb3VwID0+IHsKICAgICAgY29uc3QgbmFtZSA9IFN0cmluZyhncm91cC5uYW1lIHx8ICIiKS50cmltKCk7CiAgICAgIGlmIChuYW1lICYmICF0cmlwbGljYXRlR3JvdXBDb2xvck1hcFtuYW1lXSkgewogICAgICAgIHRyaXBsaWNhdGVHcm91cENvbG9yTWFwW25hbWVdID0gVFJJUExJQ0FURV9DT0xPUlNbY29sb3JJbmRleCAlJSBUUklQTElDQVRFX0NPTE9SUy5sZW5ndGhdOwogICAgICAgIGNvbG9ySW5kZXgrKzsKICAgICAgfQogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiByZW5kZXJQbGF0ZUdyaWQoKSB7CiAgY29uc3QgZ3JpZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwbGF0ZS1ncmlkIik7CiAgZ3JpZC5pbm5lckhUTUwgPSAiIjsKICAKICAvLyBJbml0aWFsaXplIGNvbG9yIG1hcCBpZiBuZWVkZWQgKGRvbid0IHJlc2V0IC0ga2VlcCBjb25zaXN0ZW50IGNvbG9ycykKICAvLyBUaGlzIGVuc3VyZXMgYWxsIHdlbGxzIHdpdGggdGhlIHNhbWUgdHJpcGxpY2F0ZSBncm91cCBuYW1lIGdldCB0aGUgc2FtZSBjb2xvcgogIGlmIChPYmplY3Qua2V5cyh0cmlwbGljYXRlR3JvdXBDb2xvck1hcCkubGVuZ3RoID09PSAwKSB7CiAgICBpbml0aWFsaXplVHJpcGxpY2F0ZUdyb3VwQ29sb3JzKCk7CiAgfQoKICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogIGNvbnN0IGFsbEdyb3VwRGF0YXNldHMgPSBnZXRBbGxEYXRhc2V0c0luR3JvdXAoKTsKICAKICAvLyBCdWlsZCBjb2x1bW4gaW5mbyBtYXA6IGNvbHVtbiAtPiB7IGdlbm90eXBlLCBidWZmZXIsIHNjaWVudGlzdCB9CiAgLy8gVXNlIGFsbCBkYXRhc2V0cyBpbiBncm91cCB0byBzaG93IGFsbCBhdmFpbGFibGUgY29sdW1uIGdyb3VwcwogIGNvbnN0IGNvbHVtbkluZm9NYXAgPSB7fTsgLy8gY29sdW1uIC0+IHsgZ2Vub3R5cGUsIGJ1ZmZlciwgc2NpZW50aXN0IH0KICAKICBhbGxHcm91cERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICBjb25zdCBwbGF0ZSA9IHZpZXdlckRhdGEucGxhdGVzLmZpbmQocCA9PiBwLmlkID09PSBwbGF0ZUlkKTsKICAgIGlmICghcGxhdGUgfHwgIXBsYXRlLmNvbHVtbl9pbmZvKSByZXR1cm47CiAgICAKICAgIGNvbnN0IGNvbHVtbkluZm8gPSBwbGF0ZS5jb2x1bW5faW5mbzsKICAgIC8vIEZpbmQgd2hpY2ggY29sdW1ucyBoYXZlIGRhdGEgZm9yIHRoaXMgcGxhdGUKICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgT2JqZWN0LmtleXMod2VsbHMpLmZvckVhY2god2VsbElkID0+IHsKICAgICAgY29uc3QgY29sID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgICBpZiAoIWNvbHVtbkluZm9NYXBbY29sXSkgewogICAgICAgIGNvbHVtbkluZm9NYXBbY29sXSA9IHsKICAgICAgICAgIGdlbm90eXBlOiBjb2x1bW5JbmZvLmdlbm90eXBlIHx8ICIiLAogICAgICAgICAgYnVmZmVyOiBjb2x1bW5JbmZvLmJ1ZmZlciB8fCAiIiwKICAgICAgICAgIHNjaWVudGlzdDogY29sdW1uSW5mby5zY2llbnRpc3QgfHwgIiIKICAgICAgICB9OwogICAgICB9CiAgICB9KTsKICB9KTsKCiAgLy8gVG9wLWxlZnQgYmxhbmsKICBjb25zdCBjb3JuZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICBjb3JuZXIuY2xhc3NOYW1lID0gImdyaWQtaGVhZGVyIjsKICBncmlkLmFwcGVuZENoaWxkKGNvcm5lcik7CgogIC8vIENvbHVtbiBudW1iZXIgbGFiZWxzCiAgZm9yIChsZXQgYyA9IDE7IGMgPD0gUExBVEVfQ09MUzsgYysrKSB7CiAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGRpdi5jbGFzc05hbWUgPSAiZ3JpZC1oZWFkZXIgY29sLWxhYmVsIjsKICAgIGRpdi50ZXh0Q29udGVudCA9IGM7CiAgICBncmlkLmFwcGVuZENoaWxkKGRpdik7CiAgfQoKICBjb25zdCB3ZWxsQ291bnRzID0ge307IC8vIFRyYWNrIGhvdyBtYW55IGRhdGFzZXRzIGhhdmUgZGF0YSBmb3IgZWFjaCB3ZWxsCgogIC8vIENvdW50IGRhdGFzZXRzIHBlciB3ZWxsLCBmaWx0ZXJpbmcgYnkgZW5hYmxlZCB3ZWxscwogIC8vIE5vcm1hbGl6ZSB3ZWxsIElEcyB0byBlbnN1cmUgY29uc2lzdGVudCBtYXRjaGluZyAoemVyby1wYWRkZWQgZm9ybWF0KQogIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgT2JqZWN0LmtleXMod2VsbHMpLmZvckVhY2god2VsbElkID0+IHsKICAgICAgLy8gTm9ybWFsaXplIHdlbGwgSUQgdG8gemVyby1wYWRkZWQgZm9ybWF0IChlLmcuLCAiQjUiIC0+ICJCMDUiLCAiQjEzIiAtPiAiQjEzIikKICAgICAgY29uc3Qgbm9ybWFsaXplZFdlbGxJZCA9IG5vcm1hbGl6ZVdlbGxJZCh3ZWxsSWQpOwogICAgICAKICAgICAgLy8gRmlsdGVyIGJ5IGVuYWJsZWRXZWxscyBpZiBhbnkgYXJlIHNldCAoY2hlY2sgYm90aCBvcmlnaW5hbCBhbmQgbm9ybWFsaXplZCkKICAgICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3ZWxsSWQpICYmICFlbmFibGVkV2VsbHMuaGFzKG5vcm1hbGl6ZWRXZWxsSWQpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIAogICAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZENvbHVtbnMgaWYgYW55IGFyZSBzZXQKICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgICBpZiAoZW5hYmxlZENvbHVtbnMuc2l6ZSA+IDAgJiYgIWVuYWJsZWRDb2x1bW5zLmhhcyhjb2x1bW4pKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIAogICAgICBpZiAoIXdlbGxDb3VudHNbbm9ybWFsaXplZFdlbGxJZF0pIHsKICAgICAgICB3ZWxsQ291bnRzW25vcm1hbGl6ZWRXZWxsSWRdID0gbmV3IFNldCgpOyAvLyBVc2UgU2V0IHRvIGF2b2lkIGR1cGxpY2F0ZXMKICAgICAgfQogICAgICB3ZWxsQ291bnRzW25vcm1hbGl6ZWRXZWxsSWRdLmFkZChwbGF0ZUlkKTsKICAgIH0pOwogIH0pOwogIAogIC8vIENvbnZlcnQgU2V0cyB0byBhcnJheXMgZm9yIGVhc2llciB1c2UKICBPYmplY3Qua2V5cyh3ZWxsQ291bnRzKS5mb3JFYWNoKHdlbGxJZCA9PiB7CiAgICB3ZWxsQ291bnRzW3dlbGxJZF0gPSBBcnJheS5mcm9tKHdlbGxDb3VudHNbd2VsbElkXSk7CiAgfSk7CgogIC8vIFJvd3MKICBQTEFURV9ST1dTLmZvckVhY2gocm93TGV0dGVyID0+IHsKICAgIC8vIFJvdyBsYWJlbAogICAgY29uc3QgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGxhYmVsLmNsYXNzTmFtZSA9ICJncmlkLWhlYWRlciByb3ctbGFiZWwiOwogICAgbGFiZWwudGV4dENvbnRlbnQgPSByb3dMZXR0ZXI7CiAgICBncmlkLmFwcGVuZENoaWxkKGxhYmVsKTsKCiAgICAvLyBXZWxscwogICAgZm9yIChsZXQgY29sID0gMTsgY29sIDw9IFBMQVRFX0NPTFM7IGNvbCsrKSB7CiAgICAgIGNvbnN0IHdlbGxJZCA9IHJvd0xldHRlciArIFN0cmluZyhjb2wpOwogICAgICBjb25zdCBub3JtYWxpemVkV2VsbElkID0gbm9ybWFsaXplV2VsbElkKHdlbGxJZCk7IC8vIE5vcm1hbGl6ZSB0byB6ZXJvLXBhZGRlZCBmb3JtYXQgZm9yIG1hdGNoaW5nCiAgICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBkaXYuY2xhc3NOYW1lID0gIndlbGwiOwogICAgICBjb25zdCBoYXNEYXRhID0gd2VsbENvdW50cy5oYXNPd25Qcm9wZXJ0eShub3JtYWxpemVkV2VsbElkKTsKICAgICAgZGl2LmRhdGFzZXQud2VsbElkID0gd2VsbElkOwogICAgICBkaXYuZGF0YXNldC5oYXNEYXRhID0gaGFzRGF0YSA/ICJ0cnVlIiA6ICJmYWxzZSI7CiAgICAgIAogICAgICBpZiAoaGFzRGF0YSkgewogICAgICAgIGNvbnN0IHBsYXRlcyA9IHdlbGxDb3VudHNbbm9ybWFsaXplZFdlbGxJZF07CiAgICAgICAgCiAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyB3ZWxsIGlzIGEgY29udHJvbCB3ZWxsIChjb25maWd1cmFibGUgdmlhIGNvbnRyb2xfcm93cykKICAgICAgICBjb25zdCBpc0NvbnRyb2wgPSBpc0NvbnRyb2xXZWxsKHdlbGxJZCk7CiAgICAgICAgCiAgICAgICAgLy8gR2V0IGxhYmVsIGZyb20gcm93LWJhc2VkIGNvbmZpZyBvciBjb250ZW50CiAgICAgICAgLy8gVHJ5IHRvIGZpbmQgdGhlIGFjdHVhbCB3ZWxsIElEIGluIHRoZSBkYXRhIHVzaW5nIG5vcm1hbGl6ZWQgZm9ybWF0CiAgICAgICAgY29uc3QgZmlyc3RQbGF0ZUlkID0gcGxhdGVzWzBdOwogICAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW2ZpcnN0UGxhdGVJZF0gfHwge307CiAgICAgICAgLy8gVHJ5IG5vcm1hbGl6ZWQgSUQgZmlyc3QsIHRoZW4gc2VhcmNoIGZvciBtYXRjaGluZyB3ZWxsIHVzaW5nIG5vcm1hbGl6ZWQgZm9ybWF0CiAgICAgICAgbGV0IGFjdHVhbFdlbGxJZCA9IG5vcm1hbGl6ZWRXZWxsSWQ7CiAgICAgICAgaWYgKCF3ZWxsc1thY3R1YWxXZWxsSWRdKSB7CiAgICAgICAgICAvLyBTZWFyY2ggZm9yIG1hdGNoaW5nIHdlbGwgSUQgdXNpbmcgbm9ybWFsaXplZCBmb3JtYXQKICAgICAgICAgIGNvbnN0IG1hdGNoaW5nS2V5ID0gT2JqZWN0LmtleXMod2VsbHMpLmZpbmQoa2V5ID0+IAogICAgICAgICAgICBub3JtYWxpemVXZWxsSWQoa2V5KSA9PT0gbm9ybWFsaXplZFdlbGxJZAogICAgICAgICAgKTsKICAgICAgICAgIGlmIChtYXRjaGluZ0tleSkgewogICAgICAgICAgICBhY3R1YWxXZWxsSWQgPSBtYXRjaGluZ0tleTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3Qgd2VsbERhdGEgPSB3ZWxsc1thY3R1YWxXZWxsSWRdOwogICAgICAgIGlmICghd2VsbERhdGEpIHsKICAgICAgICAgIC8vIFdlbGwgZGF0YSBub3QgZm91bmQsIHNraXAgdGhpcyB3ZWxsCiAgICAgICAgICBkaXYuc3R5bGUuY3Vyc29yID0gImRlZmF1bHQiOwogICAgICAgICAgZGl2LnN0eWxlLmJhY2tncm91bmQgPSAiI2YyZjJmMiI7CiAgICAgICAgICBncmlkLmFwcGVuZENoaWxkKGRpdik7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgY29uc3QgY29uZmlnID0gdmlld2VyRGF0YS5jb25maWcgfHwge307CiAgICAgICAgY29uc3Qgd2VsbExhYmVscyA9IGNvbmZpZy53ZWxsX2xhYmVscyB8fCB7fTsKICAgICAgICAvLyBFeHRyYWN0IHJvdyBsZXR0ZXIgZnJvbSB3ZWxsSWQgKGUuZy4sICJCMTMiIC0+ICJCIikKICAgICAgICBjb25zdCByb3dMZXR0ZXIgPSBnZXRSb3dMZXR0ZXIod2VsbElkKTsKICAgICAgICAKICAgICAgICAvLyBDb3VudCB1bmlxdWUgZGF0YXNldHMgdGhhdCBhY3R1YWxseSBoYXZlIGRhdGEgZm9yIHRoaXMgd2VsbAogICAgICAgIGNvbnN0IHVuaXF1ZVBsYXRlcyA9IHBsYXRlcy5maWx0ZXIocGxhdGVJZCA9PiB7CiAgICAgICAgICBjb25zdCBwbGF0ZVdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBwbGF0ZSBoYXMgZGF0YSBmb3IgdGhpcyB3ZWxsIHVzaW5nIG5vcm1hbGl6ZWQgZm9ybWF0CiAgICAgICAgICByZXR1cm4gcGxhdGVXZWxsc1thY3R1YWxXZWxsSWRdIHx8IAogICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKHBsYXRlV2VsbHMpLnNvbWUoa2V5ID0+IG5vcm1hbGl6ZVdlbGxJZChrZXkpID09PSBub3JtYWxpemVkV2VsbElkKTsKICAgICAgICB9KTsKICAgICAgICBjb25zdCBkYXRhc2V0Q291bnQgPSB1bmlxdWVQbGF0ZXMubGVuZ3RoOwogICAgICAgIAogICAgICAgIC8vIEZvciBjb250cm9sIHdlbGxzOiBtYWluIHRleHQgaXMgIkNvbnRyb2wiLCBsYWJlbCBiZWxvdyBpcyB0aGUgY29udHJvbCBsYWJlbAogICAgICAgIC8vIEZvciBub24tY29udHJvbCB3ZWxsczogbWFpbiB0ZXh0IGlzIHBsYXRlIGNvdW50IG9yIHdlbGwgSUQsIGxhYmVsIGJlbG93IGlzIHRoZSBjb25maWd1cmVkIGxhYmVsCiAgICAgICAgbGV0IG1haW5UZXh0LCBsYWJlbDsKICAgICAgICBpZiAoaXNDb250cm9sKSB7CiAgICAgICAgICBtYWluVGV4dCA9ICJDb250cm9sIjsKICAgICAgICAgIC8vIEdldCB0aGUgY29udHJvbCBsYWJlbCBmcm9tIGNvbmZpZyBvciB3ZWxsIGRhdGEgYW5kIGZvcm1hdCBpdAogICAgICAgICAgbGFiZWwgPSB3ZWxsTGFiZWxzW3Jvd0xldHRlcl0gfHwgd2VsbERhdGEubGFiZWwgfHwgd2VsbERhdGEuY29udGVudCB8fCAiIjsKICAgICAgICAgIGlmIChsYWJlbCkgewogICAgICAgICAgICBsYWJlbCA9IGZvcm1hdExhYmVsKGxhYmVsKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gU2hvdyBkYXRhc2V0IGNvdW50IGlmIG1vcmUgdGhhbiAxLCBvdGhlcndpc2Ugc2hvdyB3ZWxsIElECiAgICAgICAgICBtYWluVGV4dCA9IGRhdGFzZXRDb3VudCA+IDEgPyBgJHtkYXRhc2V0Q291bnR9YCA6IHdlbGxJZDsKICAgICAgICAgIC8vIFVzZSByb3ctYmFzZWQgbGFiZWwgaWYgYXZhaWxhYmxlLCBvdGhlcndpc2UgdXNlIHdlbGwncyBsYWJlbCBvciBjb250ZW50CiAgICAgICAgICBsYWJlbCA9IHdlbGxMYWJlbHNbcm93TGV0dGVyXSB8fCB3ZWxsRGF0YS5sYWJlbCB8fCB3ZWxsRGF0YS5jb250ZW50IHx8ICIiOwogICAgICAgICAgLy8gRm9ybWF0IGxhYmVsIChyZW1vdmUgdU0sIGZvcm1hdCBhcyBudW1iZXItbnVtYmVyLW51bWJlcikKICAgICAgICAgIGlmIChsYWJlbCkgewogICAgICAgICAgICBsYWJlbCA9IGZvcm1hdExhYmVsKGxhYmVsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZGl2LnRleHRDb250ZW50ID0gbWFpblRleHQ7CiAgICAgICAgZGl2LnN0eWxlLmN1cnNvciA9ICJwb2ludGVyIjsKICAgICAgICBkaXYuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJhdXRvIjsKICAgICAgICBkaXYuc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogICAgICAgIGRpdi5zdHlsZS56SW5kZXggPSAiMSI7CiAgICAgICAgCiAgICAgICAgLy8gQWRkIHZpc3VhbCBpbmRpY2F0b3IgZm9yIGR1cGxpY2F0ZSB3ZWxscwogICAgICAgIGlmIChpc0R1cGxpY2F0ZVdlbGwod2VsbElkKSkgewogICAgICAgICAgZGl2LnN0eWxlLmJvcmRlcldpZHRoID0gIjJweCI7CiAgICAgICAgICBkaXYuc3R5bGUuYm9yZGVyU3R5bGUgPSAiZG91YmxlIjsKICAgICAgICAgIGRpdi50aXRsZSA9IChkaXYudGl0bGUgfHwgIiIpICsgIiDimqDvuI8gRHVwbGljYXRlIHdlbGwgLSBjbGljayB0byBjb21wYXJlIGRhdGFzZXRzIjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKGxhYmVsKSB7CiAgICAgICAgICBjb25zdCBsYWJlbERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgbGFiZWxEaXYuY2xhc3NOYW1lID0gIndlbGwtbGFiZWwiOwogICAgICAgICAgbGFiZWxEaXYudGV4dENvbnRlbnQgPSBsYWJlbDsKICAgICAgICAgIGxhYmVsRGl2LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAibm9uZSI7CiAgICAgICAgICBkaXYuYXBwZW5kQ2hpbGQobGFiZWxEaXYpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBkaXYuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoZSkgPT4gewogICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIHRvZ2dsZVdlbGxTZWxlY3Rpb24od2VsbElkLCBwbGF0ZXMpOwogICAgICAgIH0pOwogICAgICAgIGlmIChpc0NvbnRyb2wpIHsKICAgICAgICAgIGRpdi5jbGFzc0xpc3QuYWRkKCJjb250cm9sIik7CiAgICAgICAgICBkaXYudGl0bGUgPSAiQ29udHJvbCB3ZWxsIChpbmRlcGVuZGVudGx5IHNlbGVjdGFibGUpIjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyB3ZWxsIGlzIHBhcnQgb2YgYSB0cmlwbGljYXRlIGdyb3VwIChjb250cm9scyBhcmUgbmV2ZXIgaW4gdHJpcGxpY2F0ZSBncm91cHMpCiAgICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgICAgIGNvbnN0IHRyaXBsaWNhdGVHcm91cCA9IGdldFRyaXBsaWNhdGVHcm91cCh3ZWxsSWQsIGNvbHVtbik7CiAgICAgICAgCiAgICAgICAgLy8gQWRkIHZpc3VhbCBpbmRpY2F0b3IgZm9yIHRyaXBsaWNhdGUgZ3JvdXBzIHdpdGggZGlzdGluY3QgY29sb3JzCiAgICAgICAgLy8gQWxsIHdlbGxzIGluIHRoZSBzYW1lIHRyaXBsaWNhdGUgZ3JvdXAgKHNhbWUgbmFtZSkgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgICAgICAgLy8gRm9yIGV4YW1wbGUsIGFsbCB3ZWxscyBpbiByb3dzIEIsIEMsIEQgd2l0aCBncm91cCBuYW1lICIyNTAtMTAtMiIgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgICAgICAgLy8gQm9yZGVycy9zdHJva2VzIG9ubHkgYXBwZWFyIHdoZW4gc2VsZWN0ZWQKICAgICAgICBpZiAodHJpcGxpY2F0ZUdyb3VwICYmIHRyaXBsaWNhdGVHcm91cC5uYW1lKSB7CiAgICAgICAgICBkaXYuY2xhc3NMaXN0LmFkZCgidHJpcGxpY2F0ZS1ncm91cCIpOwogICAgICAgICAgZGl2LnRpdGxlID0gYFRyaXBsaWNhdGUgZ3JvdXA6ICR7dHJpcGxpY2F0ZUdyb3VwLm5hbWV9IChjbGljayB0byBzZWxlY3QgYWxsKWA7CiAgICAgICAgICAKICAgICAgICAgIC8vIEFwcGx5IGRpc3RpbmN0IGNvbG9yIGZvciB0aGlzIHRyaXBsaWNhdGUgZ3JvdXAgKGJhY2tncm91bmQgb25seSwgbm8gYm9yZGVyIHVubGVzcyBzZWxlY3RlZCkKICAgICAgICAgIC8vIEFsbCB3ZWxscyB3aXRoIHRoZSBzYW1lIGdyb3VwIG5hbWUgd2lsbCBnZXQgdGhlIHNhbWUgY29sb3IKICAgICAgICAgIC8vIFRoaXMgZW5zdXJlcyBCLCBDLCBEIHJvd3MgYWxsIGdldCB0aGUgc2FtZSBjb2xvciBmb3IgdGhlIHNhbWUgdHJpcGxpY2F0ZSBncm91cAogICAgICAgICAgY29uc3QgZ3JvdXBOYW1lID0gU3RyaW5nKHRyaXBsaWNhdGVHcm91cC5uYW1lIHx8ICIiKS50cmltKCk7IC8vIE5vcm1hbGl6ZSBncm91cCBuYW1lCiAgICAgICAgICBjb25zdCBjb2xvciA9IGdldFRyaXBsaWNhdGVHcm91cENvbG9yKGdyb3VwTmFtZSk7CiAgICAgICAgICBpZiAoY29sb3IgJiYgY29sb3IuYmdIYXNEYXRhKSB7CiAgICAgICAgICAgIC8vIFNldCBiYWNrZ3JvdW5kIGNvbG9yIG9ubHkgLSBib3JkZXJzIHdpbGwgYmUgYWRkZWQgd2hlbiBzZWxlY3RlZAogICAgICAgICAgICBjb25zdCBiZ0NvbG9yID0gaGFzRGF0YSA/IGNvbG9yLmJnSGFzRGF0YSA6IGNvbG9yLmJnOwogICAgICAgICAgICBkaXYuc3R5bGUuc2V0UHJvcGVydHkoImJhY2tncm91bmQtY29sb3IiLCBiZ0NvbG9yLCAiaW1wb3J0YW50Iik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIEhpZ2hsaWdodCBpZiBzZWxlY3RlZCAoY2hlY2sgaWYgYW55IHNlbGVjdGVkIGRhdGFzZXQgaGFzIHRoaXMgd2VsbCBzZWxlY3RlZCkKICAgICAgICAvLyBBbHNvIGNoZWNrIGlmIHRoaXMgd2VsbCBpcyBwYXJ0IG9mIGEgdHJpcGxpY2F0ZSBncm91cCB0aGF0J3Mgc2VsZWN0ZWQKICAgICAgICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogICAgICAgIGxldCBpc1NlbGVjdGVkID0gZmFsc2U7CiAgICAgICAgCiAgICAgICAgaWYgKHRyaXBsaWNhdGVHcm91cCkgewogICAgICAgICAgLy8gQ2hlY2sgaWYgYW55IHdlbGwgaW4gdGhpcyB0cmlwbGljYXRlIGdyb3VwIChzYW1lIHJvdyBwYXR0ZXJuLCBzYW1lIGNvbHVtbikgaXMgc2VsZWN0ZWQKICAgICAgICAgIGNvbnN0IGdyb3VwUm93TGV0dGVycyA9IGdldFJvd0xldHRlcnNGcm9tV2VsbHModHJpcGxpY2F0ZUdyb3VwLndlbGxzKTsKICAgICAgICAgIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgICAgICAgZ3JvdXBSb3dMZXR0ZXJzLmZvckVhY2gocm93TGV0dGVyID0+IHsKICAgICAgICAgICAgICBjb25zdCB3SWQgPSByb3dMZXR0ZXIgKyBjb2x1bW47CiAgICAgICAgICAgICAgaWYgKHBsYXRlcy5pbmNsdWRlcyhwbGF0ZUlkKSkgewogICAgICAgICAgICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHt3SWR9YDsKICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZFdlbGxzLmhhcyhrZXkpKSB7CiAgICAgICAgICAgICAgICAgIGlzU2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBzcGVjaWZpYyB3ZWxsIGlzIHNlbGVjdGVkCiAgICAgICAgICBpc1NlbGVjdGVkID0gc2VsZWN0ZWREYXRhc2V0cy5zb21lKHBsYXRlSWQgPT4gewogICAgICAgICAgICBpZiAocGxhdGVzLmluY2x1ZGVzKHBsYXRlSWQpKSB7CiAgICAgICAgICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHt3ZWxsSWR9YDsKICAgICAgICAgICAgICByZXR1cm4gc2VsZWN0ZWRXZWxscy5oYXMoa2V5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKGlzU2VsZWN0ZWQpIHsKICAgICAgICAgIGRpdi5jbGFzc0xpc3QuYWRkKCJzZWxlY3RlZCIpOwogICAgICAgICAgLy8gVXBkYXRlIGJhY2tncm91bmQgY29sb3IgYW5kIGFkZCBib3JkZXIgZm9yIHNlbGVjdGVkIHRyaXBsaWNhdGUgZ3JvdXBzCiAgICAgICAgICBpZiAodHJpcGxpY2F0ZUdyb3VwICYmIHRyaXBsaWNhdGVHcm91cC5uYW1lKSB7CiAgICAgICAgICAgIGNvbnN0IGdyb3VwTmFtZSA9IFN0cmluZyh0cmlwbGljYXRlR3JvdXAubmFtZSB8fCAiIikudHJpbSgpOyAvLyBOb3JtYWxpemUgZ3JvdXAgbmFtZQogICAgICAgICAgICBjb25zdCBjb2xvciA9IGdldFRyaXBsaWNhdGVHcm91cENvbG9yKGdyb3VwTmFtZSk7CiAgICAgICAgICAgIGlmIChjb2xvcikgewogICAgICAgICAgICAgIGRpdi5zdHlsZS5zZXRQcm9wZXJ0eSgiYmFja2dyb3VuZC1jb2xvciIsIGNvbG9yLmJnSGFzRGF0YSwgImltcG9ydGFudCIpOwogICAgICAgICAgICAgIC8vIEFkZCBib3JkZXIgd2hlbiBzZWxlY3RlZAogICAgICAgICAgICAgIGRpdi5zdHlsZS5zZXRQcm9wZXJ0eSgiYm9yZGVyLWNvbG9yIiwgY29sb3IuYm9yZGVyLCAiaW1wb3J0YW50Iik7CiAgICAgICAgICAgICAgZGl2LnN0eWxlLnNldFByb3BlcnR5KCJib3JkZXItd2lkdGgiLCAiMnB4IiwgImltcG9ydGFudCIpOwogICAgICAgICAgICAgIGRpdi5zdHlsZS5zZXRQcm9wZXJ0eSgiYm9yZGVyLXN0eWxlIiwgInNvbGlkIiwgImltcG9ydGFudCIpOwogICAgICAgICAgICAgIGRpdi5zdHlsZS5zZXRQcm9wZXJ0eSgib3V0bGluZSIsIGAycHggc29saWQgJHtjb2xvci5ib3JkZXJ9YCwgImltcG9ydGFudCIpOwogICAgICAgICAgICAgIGRpdi5zdHlsZS5zZXRQcm9wZXJ0eSgib3V0bGluZS1vZmZzZXQiLCAiLTJweCIsICJpbXBvcnRhbnQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBkaXYuc3R5bGUuY3Vyc29yID0gImRlZmF1bHQiOwogICAgICAgIGRpdi5zdHlsZS5iYWNrZ3JvdW5kID0gIiNmMmYyZjIiOwogICAgICB9CiAgICAgIGdyaWQuYXBwZW5kQ2hpbGQoZGl2KTsKICAgIH0KICB9KTsKICAKICAvLyBVcGRhdGUgY29sdW1uIGxlZ2VuZCB3aXRoIGRhdGFzZXQgbWFwcGluZyAodXNlIGFsbCBkYXRhc2V0cyBpbiBncm91cCkKICB1cGRhdGVDb2x1bW5MZWdlbmQoY29sdW1uSW5mb01hcCwgYWxsR3JvdXBEYXRhc2V0cyk7Cn0KCmZ1bmN0aW9uIHVwZGF0ZUNvbHVtbkxlZ2VuZChjb2x1bW5JbmZvTWFwLCBhbGxEYXRhc2V0cykgewogIGNvbnN0IGxlZ2VuZERpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjb2x1bW4tbGVnZW5kLWNvbnRlbnQiKTsKICBpZiAoIWxlZ2VuZERpdikgcmV0dXJuOwogIAogIC8vIEJ1aWxkIG1hcDogY29sdW1uIC0+IHsgZGF0YXNldHM6IFNldCwgaW5mbzogeyBnZW5vdHlwZSwgYnVmZmVyLCBzY2llbnRpc3QgfSB9CiAgY29uc3QgY29sdW1uRGF0YSA9IHt9OyAvLyBjb2x1bW4gLT4geyBkYXRhc2V0czogU2V0LCBpbmZvOiB7fSB9CiAgCiAgLy8gRmluZCB3aGljaCBkYXRhc2V0cyBoYXZlIGRhdGEgaW4gZWFjaCBjb2x1bW4KICBmb3IgKGxldCBjb2wgPSAxOyBjb2wgPD0gUExBVEVfQ09MUzsgY29sKyspIHsKICAgIGNvbnN0IGluZm8gPSBjb2x1bW5JbmZvTWFwW2NvbF07CiAgICBpZiAoIWluZm8pIGNvbnRpbnVlOwogICAgCiAgICBjb2x1bW5EYXRhW2NvbF0gPSB7CiAgICAgIGRhdGFzZXRzOiBuZXcgU2V0KCksCiAgICAgIGluZm86IHsKICAgICAgICBnZW5vdHlwZTogaW5mby5nZW5vdHlwZSB8fCAiIiwKICAgICAgICBidWZmZXI6IGluZm8uYnVmZmVyIHx8ICIiLAogICAgICAgIHNjaWVudGlzdDogaW5mby5zY2llbnRpc3QgfHwgIiIKICAgICAgfQogICAgfTsKICAgIAogICAgLy8gRmluZCBhbGwgZGF0YXNldHMgdGhhdCBoYXZlIGRhdGEgaW4gdGhpcyBjb2x1bW4KICAgIGFsbERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGNvbnN0IHdlbGxzID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdIHx8IHt9OwogICAgICBjb25zdCBoYXNEYXRhSW5Db2x1bW4gPSBPYmplY3Qua2V5cyh3ZWxscykuc29tZSh3ZWxsSWQgPT4gewogICAgICAgIGNvbnN0IHdlbGxDb2wgPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAgICAgcmV0dXJuIHdlbGxDb2wgPT09IGNvbDsKICAgICAgfSk7CiAgICAgIAogICAgICBpZiAoaGFzRGF0YUluQ29sdW1uKSB7CiAgICAgICAgY29sdW1uRGF0YVtjb2xdLmRhdGFzZXRzLmFkZChwbGF0ZUlkKTsKICAgICAgfQogICAgfSk7CiAgfQogIAogIGlmIChPYmplY3Qua2V5cyhjb2x1bW5EYXRhKS5sZW5ndGggPT09IDApIHsKICAgIGxlZ2VuZERpdi5pbm5lckhUTUwgPSAiPGRpdiBzdHlsZT0nY29sb3I6ICM2NjY7IGZvbnQtc2l6ZTogMC44cmVtOyc+Tm8gY29sdW1uIGluZm9ybWF0aW9uIGF2YWlsYWJsZS48L2Rpdj4iOwogICAgcmV0dXJuOwogIH0KICAKICAvLyBCdWlsZCBIVE1MIHdpdGggaW5kaXZpZHVhbCBjb2x1bW4gY2hlY2tib3hlcwogIGxlZ2VuZERpdi5pbm5lckhUTUwgPSAiIjsKICAKICAvLyBTb3J0IGNvbHVtbnMgbnVtZXJpY2FsbHkKICBjb25zdCBzb3J0ZWRDb2x1bW5zID0gT2JqZWN0LmtleXMoY29sdW1uRGF0YSkubWFwKE51bWJlcikuc29ydCgoYSwgYikgPT4gYSAtIGIpOwogIAogIHNvcnRlZENvbHVtbnMuZm9yRWFjaChjb2wgPT4gewogICAgY29uc3QgY29sRGF0YSA9IGNvbHVtbkRhdGFbY29sXTsKICAgIGNvbnN0IGNvbERhdGFzZXRzID0gQXJyYXkuZnJvbShjb2xEYXRhLmRhdGFzZXRzKTsKICAgIAogICAgaWYgKGNvbERhdGFzZXRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOyAvLyBTa2lwIGNvbHVtbnMgd2l0aCBubyBkYXRhCiAgICAKICAgIC8vIENoZWNrIGlmIHRoaXMgY29sdW1uIGlzIGVuYWJsZWQgKGVtcHR5IHNldCA9IGFsbCBlbmFibGVkLCBvciBjb2x1bW4gaXMgaW4gdGhlIHNldCkKICAgIGNvbnN0IGNvbHVtbkVuYWJsZWQgPSBlbmFibGVkQ29sdW1ucy5zaXplID09PSAwIHx8IGVuYWJsZWRDb2x1bW5zLmhhcyhjb2wpOwogICAgCiAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGRpdi5zdHlsZS5tYXJnaW5Cb3R0b20gPSAiNnB4IjsKICAgIGRpdi5zdHlsZS5wYWRkaW5nID0gIjZweCI7CiAgICBkaXYuc3R5bGUuYmFja2dyb3VuZCA9ICIjZjlmOWY5IjsKICAgIGRpdi5zdHlsZS5ib3JkZXJSYWRpdXMgPSAiM3B4IjsKICAgIAogICAgY29uc3QgY2hlY2tib3ggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgY2hlY2tib3gudHlwZSA9ICJjaGVja2JveCI7CiAgICBjaGVja2JveC5pZCA9IGBjb2x1bW4tJHtjb2x9YDsKICAgIGNoZWNrYm94LmNoZWNrZWQgPSBjb2x1bW5FbmFibGVkOwogICAgY2hlY2tib3guc3R5bGUubWFyZ2luUmlnaHQgPSAiOHB4IjsKICAgIGNoZWNrYm94LnN0eWxlLmN1cnNvciA9ICJwb2ludGVyIjsKICAgIGNoZWNrYm94LmRhdGFzZXQuY29sdW1uID0gY29sOwogICAgY2hlY2tib3guZGF0YXNldC5kYXRhc2V0cyA9IEpTT04uc3RyaW5naWZ5KGNvbERhdGFzZXRzKTsKICAgIAogICAgY2hlY2tib3guYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgKGUpID0+IHsKICAgICAgY29uc3QgY29sdW1uID0gcGFyc2VJbnQoZS50YXJnZXQuZGF0YXNldC5jb2x1bW4pOwogICAgICBjb25zdCBhbGxHcm91cERhdGFzZXRzID0gZ2V0QWxsRGF0YXNldHNJbkdyb3VwKCk7CiAgICAgIAogICAgICAvLyBHZXQgYWxsIGNvbHVtbnMgdGhhdCBoYXZlIGRhdGEKICAgICAgY29uc3QgYWxsQ29sdW1uc1dpdGhEYXRhID0gbmV3IFNldCgpOwogICAgICBhbGxHcm91cERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICAgICAgT2JqZWN0LmtleXMod2VsbHMpLmZvckVhY2god2VsbElkID0+IHsKICAgICAgICAgIGNvbnN0IGNvbCA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgICAgICAgIGFsbENvbHVtbnNXaXRoRGF0YS5hZGQoY29sKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIAogICAgICBpZiAoZS50YXJnZXQuY2hlY2tlZCkgewogICAgICAgIC8vIEVuYWJsaW5nOiBhZGQgY29sdW1uIHRvIGVuYWJsZWQgc2V0CiAgICAgICAgZW5hYmxlZENvbHVtbnMuYWRkKGNvbHVtbik7CiAgICAgICAgCiAgICAgICAgLy8gSWYgYWxsIGNvbHVtbnMgYXJlIG5vdyBlbmFibGVkLCBjbGVhciB0aGUgc2V0IChtZWFuaW5nIGFsbCBlbmFibGVkKQogICAgICAgIGlmIChBcnJheS5mcm9tKGFsbENvbHVtbnNXaXRoRGF0YSkuZXZlcnkoY29sID0+IGVuYWJsZWRDb2x1bW5zLmhhcyhjb2wpKSkgewogICAgICAgICAgZW5hYmxlZENvbHVtbnMuY2xlYXIoKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gRGlzYWJsaW5nOiBpZiBzZXQgaXMgZW1wdHkgKGFsbCBlbmFibGVkKSwgcG9wdWxhdGUgaXQgd2l0aCBhbGwgY29sdW1ucyBleGNlcHQgdGhlIG9uZSBiZWluZyB1bmNoZWNrZWQKICAgICAgICBpZiAoZW5hYmxlZENvbHVtbnMuc2l6ZSA9PT0gMCkgewogICAgICAgICAgLy8gQ3VycmVudGx5IGFsbCBhcmUgZW5hYmxlZCwgc28gZW5hYmxlIGFsbCBjb2x1bW5zIGV4Y2VwdCB0aGUgb25lIGJlaW5nIHVuY2hlY2tlZAogICAgICAgICAgYWxsQ29sdW1uc1dpdGhEYXRhLmZvckVhY2goY29sID0+IHsKICAgICAgICAgICAgaWYgKGNvbCAhPT0gY29sdW1uKSB7CiAgICAgICAgICAgICAgZW5hYmxlZENvbHVtbnMuYWRkKGNvbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBTb21lIGNvbHVtbnMgYXJlIGFscmVhZHkgZGlzYWJsZWQsIHJlbW92ZSB0aGlzIG9uZSBmcm9tIGVuYWJsZWQgc2V0CiAgICAgICAgICBlbmFibGVkQ29sdW1ucy5kZWxldGUoY29sdW1uKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgCiAgICAgIHJlbmRlclBsYXRlR3JpZCgpOwogICAgICB1cGRhdGVXZWxsSW5mbygpOwogICAgICB1cGRhdGVDaGFydCgpOwogICAgfSk7CiAgICAKICAgIGNvbnN0IGxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGFiZWwiKTsKICAgIGxhYmVsLmh0bWxGb3IgPSBgY29sdW1uLSR7Y29sfWA7CiAgICBsYWJlbC5zdHlsZS5jdXJzb3IgPSAicG9pbnRlciI7CiAgICBsYWJlbC5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOwogICAgbGFiZWwuc3R5bGUuYWxpZ25JdGVtcyA9ICJjZW50ZXIiOwogICAgbGFiZWwuc3R5bGUuZm9udFdlaWdodCA9ICI2MDAiOwogICAgCiAgICBsYWJlbC5hcHBlbmRDaGlsZChjaGVja2JveCk7CiAgICBjb25zdCBsYWJlbFRleHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICBsYWJlbFRleHQudGV4dENvbnRlbnQgPSBgQ29sdW1uICR7Y29sfWA7CiAgICBsYWJlbC5hcHBlbmRDaGlsZChsYWJlbFRleHQpOwogICAgCiAgICBkaXYuYXBwZW5kQ2hpbGQobGFiZWwpOwogICAgCiAgICBjb25zdCBkZXRhaWxzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBkZXRhaWxzLnN0eWxlLmZvbnRTaXplID0gIjAuNzVyZW0iOwogICAgZGV0YWlscy5zdHlsZS5tYXJnaW5MZWZ0ID0gIjI0cHgiOwogICAgZGV0YWlscy5zdHlsZS5tYXJnaW5Ub3AgPSAiNHB4IjsKICAgIAogICAgaWYgKGNvbERhdGEuaW5mby5nZW5vdHlwZSkgewogICAgICBjb25zdCBnZW5EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgZ2VuRGl2LnN0eWxlLm1hcmdpbkJvdHRvbSA9ICIycHgiOwogICAgICBnZW5EaXYuaW5uZXJIVE1MID0gYDxzdHJvbmc+R2Vub3R5cGU6PC9zdHJvbmc+ICR7Y29sRGF0YS5pbmZvLmdlbm90eXBlfWA7CiAgICAgIGRldGFpbHMuYXBwZW5kQ2hpbGQoZ2VuRGl2KTsKICAgIH0KICAgIGlmIChjb2xEYXRhLmluZm8uYnVmZmVyKSB7CiAgICAgIGNvbnN0IGJ1ZkRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBidWZEaXYuc3R5bGUubWFyZ2luQm90dG9tID0gIjJweCI7CiAgICAgIGJ1ZkRpdi5pbm5lckhUTUwgPSBgPHN0cm9uZz5CdWZmZXI6PC9zdHJvbmc+ICR7Y29sRGF0YS5pbmZvLmJ1ZmZlcn1gOwogICAgICBkZXRhaWxzLmFwcGVuZENoaWxkKGJ1ZkRpdik7CiAgICB9CiAgICBpZiAoY29sRGF0YS5pbmZvLnNjaWVudGlzdCkgewogICAgICBjb25zdCBzY2lEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgc2NpRGl2LmlubmVySFRNTCA9IGA8c3Ryb25nPlNjaWVudGlzdDo8L3N0cm9uZz4gJHtjb2xEYXRhLmluZm8uc2NpZW50aXN0fWA7CiAgICAgIGRldGFpbHMuYXBwZW5kQ2hpbGQoc2NpRGl2KTsKICAgIH0KICAgIAogICAgaWYgKGNvbERhdGFzZXRzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgY291bnREaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgY291bnREaXYuc3R5bGUubWFyZ2luVG9wID0gIjRweCI7CiAgICAgIGNvdW50RGl2LnN0eWxlLmZvbnRTaXplID0gIjAuN3JlbSI7CiAgICAgIGNvdW50RGl2LnN0eWxlLmNvbG9yID0gIiM2NjYiOwogICAgICBjb3VudERpdi50ZXh0Q29udGVudCA9IGAke2NvbERhdGFzZXRzLmxlbmd0aH0gZGF0YXNldCR7Y29sRGF0YXNldHMubGVuZ3RoICE9PSAxID8gInMiIDogIiJ9YDsKICAgICAgZGV0YWlscy5hcHBlbmRDaGlsZChjb3VudERpdik7CiAgICB9CiAgICAKICAgIGRpdi5hcHBlbmRDaGlsZChkZXRhaWxzKTsKICAgIGxlZ2VuZERpdi5hcHBlbmRDaGlsZChkaXYpOwogIH0pOwp9CgpmdW5jdGlvbiB0b2dnbGVXZWxsU2VsZWN0aW9uKHdlbGxJZCwgcGxhdGVJZHMpIHsKICAvLyBUb2dnbGUgc2VsZWN0aW9uIGZvciBhbGwgc2VsZWN0ZWQgZGF0YXNldHMKICBpZiAoIXNlbGVjdGVkRGF0YXNldElkKSByZXR1cm47CiAgCiAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICBjb25zdCBjb2x1bW4gPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgY29uc3QgaXNDb250cm9sID0gaXNDb250cm9sV2VsbCh3ZWxsSWQpOwogIAogIC8vIENvbnRyb2wgd2VsbHM6IGFsbG93IGluZGl2aWR1YWwgc2VsZWN0aW9uIChjYW4gc2VsZWN0IGVhY2ggd2VsbCBzZXBhcmF0ZWx5KQogIGlmIChpc0NvbnRyb2wpIHsKICAgIC8vIENoZWNrIGlmIHRoaXMgc3BlY2lmaWMgY29udHJvbCB3ZWxsIGlzIGFscmVhZHkgc2VsZWN0ZWQKICAgIGxldCBpc1NlbGVjdGVkID0gZmFsc2U7CiAgICBzZWxlY3RlZERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGlmIChwbGF0ZUlkcy5pbmNsdWRlcyhwbGF0ZUlkKSkgewogICAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7d2VsbElkfWA7CiAgICAgICAgaWYgKHNlbGVjdGVkV2VsbHMuaGFzKGtleSkpIHsKICAgICAgICAgIGlzU2VsZWN0ZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICAKICAgIC8vIFRvZ2dsZSBqdXN0IHRoaXMgaW5kaXZpZHVhbCBjb250cm9sIHdlbGwgYWNyb3NzIGFsbCBzZWxlY3RlZCBkYXRhc2V0cwogICAgbGV0IGFueUNoYW5nZWQgPSBmYWxzZTsKICAgIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgLy8gT25seSB0b2dnbGUgaWYgdGhpcyBwbGF0ZSBoYXMgZGF0YSBmb3IgdGhpcyB3ZWxsCiAgICAgIGlmIChwbGF0ZUlkcy5pbmNsdWRlcyhwbGF0ZUlkKSkgewogICAgICAgIC8vIEZpbHRlciBieSBlbmFibGVkV2VsbHMgaWYgYW55IGFyZSBzZXQKICAgICAgICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCkpIHsKICAgICAgICAgIHJldHVybjsgLy8gU2tpcCBleGNsdWRlZCB3ZWxscwogICAgICAgIH0KICAgICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke3dlbGxJZH1gOwogICAgICAgIGlmIChpc1NlbGVjdGVkKSB7CiAgICAgICAgICBzZWxlY3RlZFdlbGxzLmRlbGV0ZShrZXkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxlY3RlZFdlbGxzLmFkZChrZXkpOwogICAgICAgIH0KICAgICAgICBhbnlDaGFuZ2VkID0gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgICAKICAgIGlmIChhbnlDaGFuZ2VkKSB7CiAgICAgIHJlbmRlclBsYXRlR3JpZCgpOwogICAgICB1cGRhdGVXZWxsSW5mbygpOwogICAgICB1cGRhdGVDaGFydCgpOwogICAgfQogICAgcmV0dXJuOwogIH0KICAKICAvLyBGb3IgZHVwbGljYXRlIHdlbGxzLCBhdXRvbWF0aWNhbGx5IHNlbGVjdCBhbGwgZGF0YXNldHMgZm9yIGNvbXBhcmlzb24KICBpZiAoaXNEdXBsaWNhdGVXZWxsKHdlbGxJZCkpIHsKICAgIC8vIEZpbmQgYWxsIGRhdGFzZXRzIHRoYXQgaGF2ZSB0aGlzIHdlbGwKICAgIGNvbnN0IGFsbEdyb3VwRGF0YXNldHMgPSBnZXRBbGxEYXRhc2V0c0luR3JvdXAoKTsKICAgIGNvbnN0IGRhdGFzZXRzV2l0aFdlbGwgPSBhbGxHcm91cERhdGFzZXRzLmZpbHRlcihwbGF0ZUlkID0+IHsKICAgICAgcmV0dXJuIGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSAmJiBhbGxXZWxsc0RhdGFbcGxhdGVJZF1bd2VsbElkXTsKICAgIH0pOwogICAgCiAgICAvLyBDaGVjayBpZiBhbnkgZGF0YXNldCBmb3IgdGhpcyB3ZWxsIGlzIGFscmVhZHkgc2VsZWN0ZWQKICAgIGxldCBpc0FueVNlbGVjdGVkID0gZGF0YXNldHNXaXRoV2VsbC5zb21lKHBsYXRlSWQgPT4gewogICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke3dlbGxJZH1gOwogICAgICByZXR1cm4gc2VsZWN0ZWRXZWxscy5oYXMoa2V5KTsKICAgIH0pOwogICAgCiAgICAvLyBUb2dnbGUgYWxsIGRhdGFzZXRzIGZvciB0aGlzIGR1cGxpY2F0ZSB3ZWxsCiAgICBsZXQgYW55Q2hhbmdlZCA9IGZhbHNlOwogICAgZGF0YXNldHNXaXRoV2VsbC5mb3JFYWNoKHBsYXRlSWQgPT4gewogICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke3dlbGxJZH1gOwogICAgICBpZiAoaXNBbnlTZWxlY3RlZCkgewogICAgICAgIHNlbGVjdGVkV2VsbHMuZGVsZXRlKGtleSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VsZWN0ZWRXZWxscy5hZGQoa2V5KTsKICAgICAgfQogICAgICBhbnlDaGFuZ2VkID0gdHJ1ZTsKICAgIH0pOwogICAgCiAgICBpZiAoYW55Q2hhbmdlZCkgewogICAgICByZW5kZXJQbGF0ZUdyaWQoKTsKICAgICAgdXBkYXRlV2VsbEluZm8oKTsKICAgICAgdXBkYXRlQ2hhcnQoKTsKICAgIH0KICAgIHJldHVybjsKICB9CiAgCiAgLy8gRm9yIG5vbi1jb250cm9sIHdlbGxzLCBjaGVjayB0cmlwbGljYXRlIGdyb3VwcwogIGNvbnN0IHRyaXBsaWNhdGVHcm91cCA9IGdldFRyaXBsaWNhdGVHcm91cCh3ZWxsSWQsIGNvbHVtbik7CiAgCiAgbGV0IGFueUNoYW5nZWQgPSBmYWxzZTsKICAKICAvLyBDaGVjayBpZiB0cmlwbGljYXRlIGdyb3VwIGlzIHNlbGVjdGVkIChjaGVjayBpZiBBTEwgd2VsbHMgaW4gdGhlIGdyb3VwIGFyZSBzZWxlY3RlZCkKICBsZXQgaXNHcm91cFNlbGVjdGVkID0gZmFsc2U7CiAgaWYgKHRyaXBsaWNhdGVHcm91cCkgewogICAgY29uc3QgZ3JvdXBSb3dMZXR0ZXJzID0gZ2V0Um93TGV0dGVyc0Zyb21XZWxscyh0cmlwbGljYXRlR3JvdXAud2VsbHMpOwogICAgLy8gQ291bnQgaG93IG1hbnkgd2VsbHMgaW4gdGhlIGdyb3VwIGFyZSBzZWxlY3RlZAogICAgbGV0IHNlbGVjdGVkQ291bnQgPSAwOwogICAgbGV0IHRvdGFsQ291bnQgPSAwOwogICAgCiAgICBzZWxlY3RlZERhdGFzZXRzLmZvckVhY2gocGxhdGVJZCA9PiB7CiAgICAgIGdyb3VwUm93TGV0dGVycy5mb3JFYWNoKHJvd0xldHRlciA9PiB7CiAgICAgICAgY29uc3Qgd0lkID0gcm93TGV0dGVyICsgY29sdW1uOwogICAgICAgIGNvbnN0IGtleSA9IGAke3BsYXRlSWR9OiR7d0lkfWA7CiAgICAgICAgY29uc3QgaGFzRGF0YSA9IGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSAmJiBhbGxXZWxsc0RhdGFbcGxhdGVJZF1bd0lkXTsKICAgICAgICBpZiAoaGFzRGF0YSkgewogICAgICAgICAgdG90YWxDb3VudCsrOwogICAgICAgICAgaWYgKHNlbGVjdGVkV2VsbHMuaGFzKGtleSkpIHsKICAgICAgICAgICAgc2VsZWN0ZWRDb3VudCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICAgIAogICAgLy8gQ29uc2lkZXIgZ3JvdXAgc2VsZWN0ZWQgaWYgYXQgbGVhc3Qgb25lIHdlbGwgaXMgc2VsZWN0ZWQgKGZvciB0b2dnbGUgYmVoYXZpb3IpCiAgICAvLyBUaGlzIGFsbG93cyBjbGlja2luZyB0byB0b2dnbGUgdGhlIHdob2xlIGdyb3VwCiAgICBpc0dyb3VwU2VsZWN0ZWQgPSBzZWxlY3RlZENvdW50ID4gMDsKICB9IGVsc2UgewogICAgLy8gRm9yIG5vbi10cmlwbGljYXRlIHdlbGxzLCBjaGVjayBpZiB0aGlzIHNwZWNpZmljIHdlbGwgaXMgc2VsZWN0ZWQKICAgIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgaWYgKHBsYXRlSWRzLmluY2x1ZGVzKHBsYXRlSWQpKSB7CiAgICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHt3ZWxsSWR9YDsKICAgICAgICBpZiAoc2VsZWN0ZWRXZWxscy5oYXMoa2V5KSkgewogICAgICAgICAgaXNHcm91cFNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICAKICAvLyBUb2dnbGUgc2VsZWN0aW9uOiBpZiBncm91cC93ZWxsIGlzIHNlbGVjdGVkLCByZW1vdmUgYWxsOyBvdGhlcndpc2UgYWRkIGFsbAogIGlmICh0cmlwbGljYXRlR3JvdXApIHsKICAgIC8vIEdldCByb3cgbGV0dGVycyBmcm9tIHRoZSB0cmlwbGljYXRlIGdyb3VwIHBhdHRlcm4KICAgIGNvbnN0IGdyb3VwUm93TGV0dGVycyA9IGdldFJvd0xldHRlcnNGcm9tV2VsbHModHJpcGxpY2F0ZUdyb3VwLndlbGxzKTsKICAgIAogICAgLy8gVG9nZ2xlIGFsbCB3ZWxscyBpbiB0aGUgdHJpcGxpY2F0ZSBncm91cCAoc2FtZSByb3cgcGF0dGVybiwgc2FtZSBjb2x1bW4pIGFjcm9zcyBhbGwgc2VsZWN0ZWQgZGF0YXNldHMKICAgIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgZ3JvdXBSb3dMZXR0ZXJzLmZvckVhY2gocm93TGV0dGVyID0+IHsKICAgICAgICBjb25zdCB3SWQgPSByb3dMZXR0ZXIgKyBjb2x1bW47CiAgICAgICAgY29uc3Qga2V5ID0gYCR7cGxhdGVJZH06JHt3SWR9YDsKICAgICAgICBjb25zdCBoYXNEYXRhID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdICYmIGFsbFdlbGxzRGF0YVtwbGF0ZUlkXVt3SWRdOwogICAgICAgIGlmIChoYXNEYXRhKSB7CiAgICAgICAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZFdlbGxzIGlmIGFueSBhcmUgc2V0CiAgICAgICAgICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdJZCkpIHsKICAgICAgICAgICAgcmV0dXJuOyAvLyBTa2lwIGV4Y2x1ZGVkIHdlbGxzCiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNHcm91cFNlbGVjdGVkKSB7CiAgICAgICAgICAgIHNlbGVjdGVkV2VsbHMuZGVsZXRlKGtleSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxlY3RlZFdlbGxzLmFkZChrZXkpOwogICAgICAgICAgfQogICAgICAgICAgYW55Q2hhbmdlZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH0gZWxzZSB7CiAgICAvLyBUb2dnbGUgaW5kaXZpZHVhbCB3ZWxsIGFjcm9zcyBhbGwgc2VsZWN0ZWQgZGF0YXNldHMKICAgIHNlbGVjdGVkRGF0YXNldHMuZm9yRWFjaChwbGF0ZUlkID0+IHsKICAgICAgLy8gT25seSB0b2dnbGUgaWYgdGhpcyBwbGF0ZSBoYXMgZGF0YSBmb3IgdGhpcyB3ZWxsCiAgICAgIGlmIChwbGF0ZUlkcy5pbmNsdWRlcyhwbGF0ZUlkKSkgewogICAgICAgIC8vIEZpbHRlciBieSBlbmFibGVkV2VsbHMgaWYgYW55IGFyZSBzZXQKICAgICAgICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCkpIHsKICAgICAgICAgIHJldHVybjsgLy8gU2tpcCBleGNsdWRlZCB3ZWxscwogICAgICAgIH0KICAgICAgICBjb25zdCBrZXkgPSBgJHtwbGF0ZUlkfToke3dlbGxJZH1gOwogICAgICAgIGlmIChpc0dyb3VwU2VsZWN0ZWQpIHsKICAgICAgICAgIHNlbGVjdGVkV2VsbHMuZGVsZXRlKGtleSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGVjdGVkV2VsbHMuYWRkKGtleSk7CiAgICAgICAgfQogICAgICAgIGFueUNoYW5nZWQgPSB0cnVlOwogICAgICB9CiAgICB9KTsKICB9CiAgCiAgaWYgKGFueUNoYW5nZWQpIHsKICAgIHJlbmRlclBsYXRlR3JpZCgpOwogICAgdXBkYXRlV2VsbEluZm8oKTsKICB9Cn0KCmZ1bmN0aW9uIGNsZWFyU2VsZWN0aW9uKCkgewogIHNlbGVjdGVkV2VsbHMuY2xlYXIoKTsKICByZW5kZXJQbGF0ZUdyaWQoKTsKICB1cGRhdGVDaGFydCgpOwp9CgpmdW5jdGlvbiB1cGRhdGVXZWxsSW5mbygpIHsKICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ3ZWxsLWluZm8iKTsKICBpZiAoc2VsZWN0ZWRXZWxscy5zaXplID09PSAwKSB7CiAgICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogICAgY29uc3QgZGF0YXNldENvdW50ID0gc2VsZWN0ZWREYXRhc2V0cy5sZW5ndGg7CiAgICBpZiAoZGF0YXNldENvdW50ID4gMSkgewogICAgICBlbC50ZXh0Q29udGVudCA9IGBTZWxlY3RlZCBncm91cCB3aXRoICR7ZGF0YXNldENvdW50fSBkYXRhc2V0cy4gQ2xpY2sgd2VsbHMgb24gdGhlIHBsYXRlIHRvIGFkZCB0aGVtIHRvIHRoZSBjaGFydC5gOwogICAgfSBlbHNlIHsKICAgICAgZWwudGV4dENvbnRlbnQgPSAiQ2xpY2sgd2VsbHMgb24gdGhlIHBsYXRlIHRvIGFkZCB0aGVtIHRvIHRoZSBjaGFydC4iOwogICAgfQogICAgcmV0dXJuOwogIH0KICBjb25zdCBzZWxlY3RlZERhdGFzZXRzID0gZ2V0U2VsZWN0ZWREYXRhc2V0cygpOwogIGNvbnN0IGRhdGFzZXRDb3VudCA9IHNlbGVjdGVkRGF0YXNldHMubGVuZ3RoOwogIGNvbnN0IHVuaXF1ZVdlbGxzID0gbmV3IFNldChBcnJheS5mcm9tKHNlbGVjdGVkV2VsbHMpLm1hcChrZXkgPT4ga2V5LnNwbGl0KCI6IilbMV0pKTsKICBjb25zdCB3ZWxsQ291bnQgPSB1bmlxdWVXZWxscy5zaXplOwogIGlmIChkYXRhc2V0Q291bnQgPiAxKSB7CiAgICBlbC50ZXh0Q29udGVudCA9IGAke3dlbGxDb3VudH0gd2VsbChzKSBzZWxlY3RlZCBhY3Jvc3MgJHtkYXRhc2V0Q291bnR9IGRhdGFzZXRzLiBDbGljayAiVXBkYXRlIENoYXJ0IiB0byBkaXNwbGF5LmA7CiAgfSBlbHNlIHsKICAgIGVsLnRleHRDb250ZW50ID0gYCR7d2VsbENvdW50fSB3ZWxsKHMpIHNlbGVjdGVkLiBDbGljayAiVXBkYXRlIENoYXJ0IiB0byBkaXNwbGF5LmA7CiAgfQp9CgpmdW5jdGlvbiBpc0NvbnRyb2xXZWxsKHdlbGxJZCkgewogIC8vIENvbnRyb2wgd2VsbHMgYXJlIGNvbmZpZ3VyYWJsZSB2aWEgY29udHJvbF9yb3dzIGluIGNvbmZpZyAoZGVmYXVsdDogWyJOIiwgIk8iXSkKICBjb25zdCBjb25maWcgPSB2aWV3ZXJEYXRhLmNvbmZpZyB8fCB7fTsKICBjb25zdCBjb250cm9sUm93cyA9IGNvbmZpZy5jb250cm9sX3Jvd3MgfHwgWyJOIiwgIk8iXTsKICBjb25zdCByb3dMZXR0ZXIgPSB3ZWxsSWQucmVwbGFjZSgvWzAtOV0vZywgJycpOwogIHJldHVybiBjb250cm9sUm93cy5pbmNsdWRlcyhyb3dMZXR0ZXIpOwp9CgpmdW5jdGlvbiBmb3JtYXRMYWJlbChsYWJlbCkgewogIC8vIEZvcm1hdCBsYWJlbHM6IHJlbW92ZSAidU0iIGFuZCBjb252ZXJ0IHRvICJudW1iZXItbnVtYmVyLW51bWJlciIgZm9ybWF0CiAgLy8gRXhhbXBsZXM6ICIyNTAgdU0gMTAtMiIgLT4gIjI1MC0xMC0yIiwgIjUwMCB1TSA1LTIiIC0+ICI1MDAtNS0yIgogIGlmICghbGFiZWwpIHJldHVybiBsYWJlbDsKICAKICAvLyBSZW1vdmUgInVNIiAoY2FzZSBpbnNlbnNpdGl2ZSkgYW5kIGV4dHJhIHNwYWNlcwogIGxldCBmb3JtYXR0ZWQgPSBsYWJlbC5yZXBsYWNlKC9ccyp1TVxzKi9naSwgJyAnKS5yZXBsYWNlKC9ccysvZywgJyAnKS50cmltKCk7CiAgCiAgLy8gRXh0cmFjdCBudW1iZXJzIGFuZCBoeXBoZW5zLCByZXBsYWNlIHNwYWNlcyB3aXRoIGh5cGhlbnMKICAvLyBNYXRjaCBwYXR0ZXJuOiBudW1iZXIocykgZm9sbG93ZWQgYnkgb3B0aW9uYWwgc3BhY2UvaHlwaGVuIGFuZCBtb3JlIG51bWJlcnMKICBmb3JtYXR0ZWQgPSBmb3JtYXR0ZWQucmVwbGFjZSgvKFxkKylccyotXHMqKFxkKykvZywgJyQxLSQyJyk7IC8vIEhhbmRsZSBleGlzdGluZyBoeXBoZW5zCiAgZm9ybWF0dGVkID0gZm9ybWF0dGVkLnJlcGxhY2UoLyhcZCspXHMrKFxkKykvZywgJyQxLSQyJyk7IC8vIFJlcGxhY2Ugc3BhY2VzIGJldHdlZW4gbnVtYmVycyB3aXRoIGh5cGhlbnMKICAKICByZXR1cm4gZm9ybWF0dGVkOwp9CgpmdW5jdGlvbiBnZXRSb3dMZXR0ZXIod2VsbElkKSB7CiAgLy8gRXh0cmFjdCByb3cgbGV0dGVyIGZyb20gd2VsbCBJRCAoZS5nLiwgIkIxMyIgLT4gIkIiKQogIHJldHVybiB3ZWxsSWQucmVwbGFjZSgvWzAtOV0vZywgJycpOwp9CgpmdW5jdGlvbiBnZXRUcmlwbGljYXRlR3JvdXAod2VsbElkLCBjb2x1bW4pIHsKICAvLyBDb250cm9sIHdlbGxzIHNob3VsZCBuZXZlciBiZSBwYXJ0IG9mIHRyaXBsaWNhdGUgZ3JvdXBzCiAgaWYgKGlzQ29udHJvbFdlbGwod2VsbElkKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIAogIGNvbnN0IGNvbmZpZyA9IHZpZXdlckRhdGEuY29uZmlnIHx8IHt9OwogIGNvbnN0IHRyaXBsaWNhdGVHcm91cHMgPSBjb25maWcudHJpcGxpY2F0ZV9ncm91cHMgfHwgW107CiAgY29uc3Qgcm93TGV0dGVyID0gZ2V0Um93TGV0dGVyKHdlbGxJZCk7CiAgCiAgLy8gRmluZCBncm91cCB0aGF0IG1hdGNoZXMgdGhlIHJvdyBwYXR0ZXJuIChCQ0QsIEVGRywgZXRjLikgLSBhcHBsaWVzIHRvIGFsbCBjb2x1bW5zCiAgcmV0dXJuIHRyaXBsaWNhdGVHcm91cHMuZmluZChncm91cCA9PiB7CiAgICBpZiAoIWdyb3VwLndlbGxzIHx8IGdyb3VwLndlbGxzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAKICAgIC8vIEV4dHJhY3Qgcm93IGxldHRlcnMgZnJvbSB0aGUgZ3JvdXAncyB3ZWxscwogICAgY29uc3QgZ3JvdXBSb3dMZXR0ZXJzID0gZ2V0Um93TGV0dGVyc0Zyb21XZWxscyhncm91cC53ZWxscyk7CiAgICAKICAgIC8vIENoZWNrIGlmIHRoaXMgd2VsbCdzIHJvdyBsZXR0ZXIgbWF0Y2hlcyBhbnkgcm93IGluIHRoZSBncm91cCBwYXR0ZXJuCiAgICAvLyBHcm91cHMgYXBwbHkgdG8gYWxsIGNvbHVtbnMsIHNvIG5vIGNvbHVtbiBjaGVjayBuZWVkZWQKICAgIHJldHVybiBncm91cFJvd0xldHRlcnMuaW5jbHVkZXMocm93TGV0dGVyKTsKICB9KTsKfQoKZnVuY3Rpb24gbm9ybWFsaXplV2VsbElkKHdlbGxJZCkgewogIC8vIE5vcm1hbGl6ZSB3ZWxsIElEIHRvIGNvbnNpc3RlbnQgZm9ybWF0OiB1cHBlcmNhc2Ugd2l0aCB6ZXJvLXBhZGRlZCBjb2x1bW4gKGUuZy4sICJCNSIgLT4gIkIwNSIsICJCMTMiIC0+ICJCMTMiKQogIGNvbnN0IG1hdGNoID0gU3RyaW5nKHdlbGxJZCkudHJpbSgpLnRvVXBwZXJDYXNlKCkubWF0Y2goL14oW0EtWl0pKFxkKykkLyk7CiAgaWYgKG1hdGNoKSB7CiAgICBjb25zdCByb3cgPSBtYXRjaFsxXTsKICAgIGNvbnN0IGNvbCA9IHBhcnNlSW50KG1hdGNoWzJdKTsKICAgIHJldHVybiByb3cgKyBTdHJpbmcoY29sKS5wYWRTdGFydCgyLCAnMCcpOwogIH0KICByZXR1cm4gU3RyaW5nKHdlbGxJZCkudHJpbSgpLnRvVXBwZXJDYXNlKCk7Cn0KCmZ1bmN0aW9uIGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKSB7CiAgLy8gRXh0cmFjdCBjb2x1bW4gbnVtYmVyIGZyb20gd2VsbCBJRCAoZS5nLiwgIkIxMyIgLT4gMTMpCiAgcmV0dXJuIHBhcnNlSW50KHdlbGxJZC5yZXBsYWNlKC9bQS1aXS9nLCAnJykpOwp9CgpmdW5jdGlvbiBnZXRSb3dMZXR0ZXJzRnJvbVdlbGxzKHdlbGxzKSB7CiAgLy8gRXh0cmFjdCByb3cgbGV0dGVycyBmcm9tIHdlbGxzIGFycmF5CiAgLy8gV2VsbHMgY2FuIGJlIGVpdGhlciByb3cgbGV0dGVycyAoZS5nLiwgWyJCIiwgIkMiLCAiRCJdKSBvciBmdWxsIHdlbGwgSURzIChlLmcuLCBbIkIxMyIsICJDMTMiLCAiRDEzIl0pCiAgcmV0dXJuIHdlbGxzLm1hcCh3ID0+IHsKICAgIC8vIElmIGl0J3MgYSBmdWxsIHdlbGwgSUQsIGV4dHJhY3Qgcm93IGxldHRlcjsgb3RoZXJ3aXNlIGFzc3VtZSBpdCdzIGFscmVhZHkgYSByb3cgbGV0dGVyCiAgICBpZiAody5sZW5ndGggPiAxICYmIC9eW0EtWl0vLnRlc3QodykgJiYgL1swLTldLy50ZXN0KHcpKSB7CiAgICAgIHJldHVybiBnZXRSb3dMZXR0ZXIodyk7CiAgICB9CiAgICByZXR1cm4gdzsgLy8gQWxyZWFkeSBhIHJvdyBsZXR0ZXIKICB9KTsKfQoKLy8gQ29sb3IgcGFsZXR0ZSBmb3IgdHJpcGxpY2F0ZSBncm91cHMgLSBlYWNoIGdyb3VwIGdldHMgYSBkaXN0aW5jdCBjb2xvcgpjb25zdCBUUklQTElDQVRFX0NPTE9SUyA9IFsKICB7IGJvcmRlcjogIiNmZjZiNmIiLCBiZzogIiNmZmUwZTAiLCBiZ1NlbGVjdGVkOiAiI2ZmY2NjYyIsIGJnSGFzRGF0YTogIiNmZmU4ZTgiIH0sIC8vIFJlZAogIHsgYm9yZGVyOiAiIzRlY2RjNCIsIGJnOiAiI2UwZjdmNSIsIGJnU2VsZWN0ZWQ6ICIjY2NmMGVkIiwgYmdIYXNEYXRhOiAiI2U4ZjlmNyIgfSwgLy8gVGVhbAogIHsgYm9yZGVyOiAiIzQ1YjdkMSIsIGJnOiAiI2UwZjJmNyIsIGJnU2VsZWN0ZWQ6ICIjY2NlOGYwIiwgYmdIYXNEYXRhOiAiI2U4ZjVmYSIgfSwgLy8gQmx1ZQogIHsgYm9yZGVyOiAiI2Y5Y2EyNCIsIGJnOiAiI2ZmZjllMCIsIGJnU2VsZWN0ZWQ6ICIjZmZmM2NjIiwgYmdIYXNEYXRhOiAiI2ZmZmJlOCIgfSwgLy8gWWVsbG93CiAgeyBib3JkZXI6ICIjNmM1Y2U3IiwgYmc6ICIjZWRlYWY3IiwgYmdTZWxlY3RlZDogIiNkZGQ0ZjAiLCBiZ0hhc0RhdGE6ICIjZjBlY2Y5IiB9LCAvLyBQdXJwbGUKICB7IGJvcmRlcjogIiNhMjliZmUiLCBiZzogIiNlZGVhZjciLCBiZ1NlbGVjdGVkOiAiI2RkZDRmMCIsIGJnSGFzRGF0YTogIiNmMGVjZjkiIH0sIC8vIExpZ2h0IFB1cnBsZQogIHsgYm9yZGVyOiAiI2ZkNzlhOCIsIGJnOiAiI2ZmZTBlZCIsIGJnU2VsZWN0ZWQ6ICIjZmZjY2UwIiwgYmdIYXNEYXRhOiAiI2ZmZThmMCIgfSwgLy8gUGluawogIHsgYm9yZGVyOiAiIzAwYjg5NCIsIGJnOiAiI2UwZjVmMCIsIGJnU2VsZWN0ZWQ6ICIjY2NlZGU1IiwgYmdIYXNEYXRhOiAiI2U4ZjdmMiIgfSwgLy8gR3JlZW4KICB7IGJvcmRlcjogIiNlMTcwNTUiLCBiZzogIiNmZmUwZDkiLCBiZ1NlbGVjdGVkOiAiI2ZmY2NiYiIsIGJnSGFzRGF0YTogIiNmZmU4ZTAiIH0sIC8vIE9yYW5nZQogIHsgYm9yZGVyOiAiIzc0YjlmZiIsIGJnOiAiI2UwZjBmZiIsIGJnU2VsZWN0ZWQ6ICIjY2NlMGZmIiwgYmdIYXNEYXRhOiAiI2U4ZjVmZiIgfSwgLy8gTGlnaHQgQmx1ZQogIHsgYm9yZGVyOiAiIzU1ZWZjNCIsIGJnOiAiI2UwZmFmNSIsIGJnU2VsZWN0ZWQ6ICIjY2NmNWViIiwgYmdIYXNEYXRhOiAiI2U4ZmJmNyIgfSwgLy8gTWludAogIHsgYm9yZGVyOiAiI2ZkY2I2ZSIsIGJnOiAiI2ZmZjVlMCIsIGJnU2VsZWN0ZWQ6ICIjZmZlYmNjIiwgYmdIYXNEYXRhOiAiI2ZmZjhlOCIgfSAgLy8gTGlnaHQgT3JhbmdlCl07CgovLyBNYXAgdHJpcGxpY2F0ZSBncm91cCBuYW1lcyB0byBjb2xvcnMgKGNvbnNpc3RlbnQgYWNyb3NzIHRoZSBhcHApCmxldCB0cmlwbGljYXRlR3JvdXBDb2xvck1hcCA9IHt9OwoKZnVuY3Rpb24gZ2V0VHJpcGxpY2F0ZUdyb3VwQ29sb3IoZ3JvdXBOYW1lKSB7CiAgaWYgKCFncm91cE5hbWUpIHJldHVybiBudWxsOwogIAogIC8vIEVuc3VyZSBjb2xvciBtYXAgaXMgaW5pdGlhbGl6ZWQKICBpbml0aWFsaXplVHJpcGxpY2F0ZUdyb3VwQ29sb3JzKCk7CiAgCiAgLy8gTm9ybWFsaXplIGdyb3VwIG5hbWUgdG8gZW5zdXJlIGNvbnNpc3RlbnQgbG9va3VwCiAgY29uc3Qgbm9ybWFsaXplZE5hbWUgPSBTdHJpbmcoZ3JvdXBOYW1lKS50cmltKCk7CiAgCiAgLy8gUmV0dXJuIHRoZSBjb2xvciBmb3IgdGhpcyBncm91cCBuYW1lIChzYW1lIGNvbG9yIGZvciBhbGwgd2VsbHMgaW4gdGhlIGdyb3VwKQogIC8vIEFsbCB3ZWxscyB3aXRoIHRoZSBzYW1lIGdyb3VwIG5hbWUgd2lsbCBnZXQgdGhlIHNhbWUgY29sb3IKICAvLyBGb3IgZXhhbXBsZSwgYWxsIHdlbGxzIGluIHJvd3MgQiwgQywgRCB3aXRoIGdyb3VwICIyNTAtMTAtMiIgZ2V0IHRoZSBzYW1lIGNvbG9yCiAgcmV0dXJuIHRyaXBsaWNhdGVHcm91cENvbG9yTWFwW25vcm1hbGl6ZWROYW1lXSB8fCBUUklQTElDQVRFX0NPTE9SU1swXTsKfQoKZnVuY3Rpb24gaXNEdXBsaWNhdGVXZWxsKHdlbGxJZCkgewogIC8vIENoZWNrIGlmIHRoaXMgd2VsbCBJRCBpcyBpbiB0aGUgZHVwbGljYXRlIHdhcm5pbmdzCiAgaWYgKCF2aWV3ZXJEYXRhIHx8ICF2aWV3ZXJEYXRhLmNvbmZpZyB8fCAhdmlld2VyRGF0YS5jb25maWcud2FybmluZ3MpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgY29uc3Qgd2FybmluZ3MgPSB2aWV3ZXJEYXRhLmNvbmZpZy53YXJuaW5ncy5kdXBsaWNhdGVfY29sdW1ucyB8fCBbXTsKICByZXR1cm4gd2FybmluZ3Muc29tZSh3YXJuaW5nID0+IHsKICAgIGNvbnN0IHdlbGxJZHMgPSB3YXJuaW5nLndlbGxfaWRzIHx8IFtdOwogICAgcmV0dXJuIHdlbGxJZHMuaW5jbHVkZXMod2VsbElkKTsKICB9KTsKfQoKZnVuY3Rpb24gZ2V0RHVwbGljYXRlRmlsZXMod2VsbElkKSB7CiAgLy8gR2V0IHRoZSBsaXN0IG9mIGZpbGVzIHRoYXQgaGF2ZSB0aGlzIGR1cGxpY2F0ZSB3ZWxsCiAgaWYgKCF2aWV3ZXJEYXRhIHx8ICF2aWV3ZXJEYXRhLmNvbmZpZyB8fCAhdmlld2VyRGF0YS5jb25maWcud2FybmluZ3MpIHsKICAgIHJldHVybiBbXTsKICB9CiAgY29uc3Qgd2FybmluZ3MgPSB2aWV3ZXJEYXRhLmNvbmZpZy53YXJuaW5ncy5kdXBsaWNhdGVfY29sdW1ucyB8fCBbXTsKICBmb3IgKGNvbnN0IHdhcm5pbmcgb2Ygd2FybmluZ3MpIHsKICAgIGNvbnN0IHdlbGxJZHMgPSB3YXJuaW5nLndlbGxfaWRzIHx8IFtdOwogICAgaWYgKHdlbGxJZHMuaW5jbHVkZXMod2VsbElkKSkgewogICAgICByZXR1cm4gd2FybmluZy5maWxlcyB8fCBbXTsKICAgIH0KICB9CiAgcmV0dXJuIFtdOwp9CgpmdW5jdGlvbiBnZXRBbGxVbmlxdWVUaW1lUG9pbnRzKHdlbGxzKSB7CiAgLy8gQ29sbGVjdCBhbGwgdW5pcXVlIHRpbWUgcG9pbnRzIGZyb20gYWxsIHdlbGxzCiAgY29uc3QgYWxsVGltZVBvaW50cyA9IG5ldyBTZXQoKTsKICB3ZWxscy5mb3JFYWNoKHdlbGwgPT4gewogICAgaWYgKHdlbGwudGltZV9zKSB7CiAgICAgIHdlbGwudGltZV9zLmZvckVhY2godCA9PiB7CiAgICAgICAgaWYgKHQgIT09IG51bGwgJiYgdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBhbGxUaW1lUG9pbnRzLmFkZCh0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0pOwogIHJldHVybiBBcnJheS5mcm9tKGFsbFRpbWVQb2ludHMpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKfQoKZnVuY3Rpb24gY2FsY3VsYXRlTWVhbkFuZEVycm9yKHdlbGxzLCB0aW1lUG9pbnRzKSB7CiAgLy8gQ2FsY3VsYXRlIG1lYW4gYW5kIHN0YW5kYXJkIGVycm9yIGZvciB0cmlwbGljYXRlcyBhdCBlYWNoIHRpbWUgcG9pbnQKICBjb25zdCBtZWFucyA9IFtdOwogIGNvbnN0IGVycm9ycyA9IFtdOwogIAogIHRpbWVQb2ludHMuZm9yRWFjaCgodGltZSwgaWR4KSA9PiB7CiAgICBjb25zdCB2YWx1ZXMgPSB3ZWxscy5tYXAodyA9PiB7CiAgICAgIGNvbnN0IHRpbWVJZHggPSB3LnRpbWVfcy5pbmRleE9mKHRpbWUpOwogICAgICByZXR1cm4gdGltZUlkeCA+PSAwID8gdy52YWx1ZXNbdGltZUlkeF0gOiBudWxsOwogICAgfSkuZmlsdGVyKHYgPT4gdiAhPT0gbnVsbCk7CiAgICAKICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIG1lYW5zLnB1c2gobnVsbCk7CiAgICAgIGVycm9ycy5wdXNoKG51bGwpOwogICAgICByZXR1cm47CiAgICB9CiAgICAKICAgIGNvbnN0IG1lYW4gPSB2YWx1ZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyB2YWx1ZXMubGVuZ3RoOwogICAgLy8gVXNlIHNhbXBsZSB2YXJpYW5jZSAoZGl2aWRlIGJ5IG4tMSkgZm9yIHByb3BlciBTRU0gY2FsY3VsYXRpb24KICAgIGNvbnN0IG4gPSB2YWx1ZXMubGVuZ3RoOwogICAgY29uc3QgdmFyaWFuY2UgPSBuID4gMSAKICAgICAgPyB2YWx1ZXMucmVkdWNlKChzdW0sIHZhbCkgPT4gc3VtICsgTWF0aC5wb3codmFsIC0gbWVhbiwgMiksIDApIC8gKG4gLSAxKQogICAgICA6IDA7CiAgICBjb25zdCBzdGREZXYgPSBNYXRoLnNxcnQodmFyaWFuY2UpOwogICAgY29uc3Qgc3RkRXJyb3IgPSBzdGREZXYgLyBNYXRoLnNxcnQobik7CiAgICAKICAgIG1lYW5zLnB1c2gobWVhbik7CiAgICBlcnJvcnMucHVzaChzdGRFcnJvcik7CiAgfSk7CiAgCiAgcmV0dXJuIHsgbWVhbnMsIGVycm9ycyB9Owp9CgpmdW5jdGlvbiBwcm9jZXNzV2VsbHNBbmRDYWxjdWxhdGVNZWFuKHdlbGxzLCBpc05vcm1hbGl6ZWQgPSBmYWxzZSwgYmFzZWxpbmVFbmRUaW1lID0gMjQsIGN1dG9mZlRpbWUgPSAzNjApIHsKICAvLyBXT1JLRkxPVzogQWx3YXlzIHByb2Nlc3MgZWFjaCB3ZWxsIGluZGl2aWR1YWxseSBmaXJzdCwgdGhlbiBhdmVyYWdlCiAgLy8gSWYgbm9ybWFsaXplZDogbm9ybWFsaXplIGVhY2ggd2VsbCB0byBpdHMgT1dOIGJhc2VsaW5lIGZpcnN0LCB0aGVuIGNhbGN1bGF0ZSBtZWFuIGFuZCBlcnJvcgogIC8vIElmIG5vdCBub3JtYWxpemVkOiBwcm9jZXNzIGVhY2ggd2VsbCBpbmRpdmlkdWFsbHkgKG5vIG5vcm1hbGl6YXRpb24pLCB0aGVuIGNhbGN1bGF0ZSBtZWFuIGFuZCBlcnJvcgogIC8vIFRoaXMgZW5zdXJlcyBjb3JyZWN0IG5vcm1hbGl6YXRpb24gZXZlbiB3aGVuIGNvbWJpbmluZyB3ZWxscyBmcm9tIGRpZmZlcmVudCBjb2x1bW5zIHdpdGggZGlmZmVyZW50IGJhc2VsaW5lcwogIC8vIFJldHVybnMgeyBmaWx0ZXJlZFRpbWVQb2ludHMsIG1lYW5zLCBlcnJvcnMsIG9yaWdpbmFsTWVhbnMgfQogIAogIC8vIFN0ZXAgMTogUHJvY2VzcyBlYWNoIHdlbGwgaW5kaXZpZHVhbGx5IChub3JtYWxpemUgaWYgZW5hYmxlZCwgb3RoZXJ3aXNlIHVzZSByYXcgZGF0YSkKICBjb25zdCBwcm9jZXNzZWRXZWxscyA9IHdlbGxzLm1hcCh3ZWxsID0+IHsKICAgIGNvbnN0IGZpbHRlcmVkVGltZVBvaW50cyA9IFtdOwogICAgY29uc3QgcHJvY2Vzc2VkVmFsdWVzID0gW107CiAgICBjb25zdCBvcmlnaW5hbFZhbHVlcyA9IFtdOwogICAgCiAgICBpZiAoIXdlbGwudGltZV9zIHx8ICF3ZWxsLnZhbHVlcykgewogICAgICByZXR1cm4geyB0aW1lUG9pbnRzOiBbXSwgdmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgICB9CiAgICAKICAgIGlmIChpc05vcm1hbGl6ZWQpIHsKICAgICAgLy8gTm9ybWFsaXplIHRoaXMgd2VsbCBieSBpdHMgb3duIGJhc2VsaW5lCiAgICAgIGNvbnN0IGJhc2VsaW5lVmFsdWVzID0gW107CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbC50aW1lX3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB0aW1lID0gd2VsbC50aW1lX3NbaV07CiAgICAgICAgY29uc3QgdmFsID0gd2VsbC52YWx1ZXNbaV07CiAgICAgICAgaWYgKHRpbWUgIT09IG51bGwgJiYgdmFsICE9PSBudWxsICYmIHRpbWUgPD0gYmFzZWxpbmVFbmRUaW1lKSB7CiAgICAgICAgICBiYXNlbGluZVZhbHVlcy5wdXNoKHZhbCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIAogICAgICBpZiAoYmFzZWxpbmVWYWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgLy8gTm8gYmFzZWxpbmUgZGF0YSBmb3IgdGhpcyB3ZWxsLCBza2lwIGl0CiAgICAgICAgcmV0dXJuIHsgdGltZVBvaW50czogW10sIHZhbHVlczogW10sIG9yaWdpbmFsVmFsdWVzOiBbXSB9OwogICAgICB9CiAgICAgIAogICAgICBjb25zdCB3ZWxsQmFzZWxpbmUgPSBiYXNlbGluZVZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIGJhc2VsaW5lVmFsdWVzLmxlbmd0aDsKICAgICAgCiAgICAgIGlmICh3ZWxsQmFzZWxpbmUgPT09IDAgfHwgIWlzRmluaXRlKHdlbGxCYXNlbGluZSkpIHsKICAgICAgICAvLyBJbnZhbGlkIGJhc2VsaW5lIGZvciB0aGlzIHdlbGwsIHNraXAgaXQKICAgICAgICByZXR1cm4geyB0aW1lUG9pbnRzOiBbXSwgdmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgICAgIH0KICAgICAgCiAgICAgIC8vIE5vcm1hbGl6ZSBhbmQgZmlsdGVyOiBvbmx5IGluY2x1ZGUgcG9pbnRzIGFmdGVyIGJhc2VsaW5lRW5kVGltZSBhbmQgdXAgdG8gY3V0b2ZmVGltZQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdlbGwudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgdGltZSA9IHdlbGwudGltZV9zW2ldOwogICAgICAgIGNvbnN0IHZhbCA9IHdlbGwudmFsdWVzW2ldOwogICAgICAgIAogICAgICAgIGlmICh0aW1lID09PSBudWxsIHx8IHZhbCA9PT0gbnVsbCkgY29udGludWU7CiAgICAgICAgCiAgICAgICAgLy8gT25seSBpbmNsdWRlIHBvaW50cyBhZnRlciBiYXNlbGluZUVuZFRpbWUgYW5kIHVwIHRvIGN1dG9mZlRpbWUKICAgICAgICBpZiAodGltZSA+IGJhc2VsaW5lRW5kVGltZSAmJiB0aW1lIDw9IGN1dG9mZlRpbWUpIHsKICAgICAgICAgIC8vIFN1YnRyYWN0IGJhc2VsaW5lRW5kVGltZSB0byBicmluZyBmaXJzdCBwb2ludCB0byB4PTAgKHRpbWUgYWZ0ZXIgaW5qZWN0aW9uKQogICAgICAgICAgZmlsdGVyZWRUaW1lUG9pbnRzLnB1c2godGltZSAtIGJhc2VsaW5lRW5kVGltZSk7CiAgICAgICAgICAvLyBEaXZpZGUgYnkgdGhpcyB3ZWxsJ3Mgb3duIGJhc2VsaW5lCiAgICAgICAgICBwcm9jZXNzZWRWYWx1ZXMucHVzaCh2YWwgLyB3ZWxsQmFzZWxpbmUpOwogICAgICAgICAgb3JpZ2luYWxWYWx1ZXMucHVzaCh2YWwpOyAvLyBTdG9yZSBvcmlnaW5hbCB2YWx1ZQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gTm90IG5vcm1hbGl6ZWQ6IHVzZSBhbGwgcmF3IGRhdGEgcG9pbnRzCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbC50aW1lX3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB0aW1lID0gd2VsbC50aW1lX3NbaV07CiAgICAgICAgY29uc3QgdmFsID0gd2VsbC52YWx1ZXNbaV07CiAgICAgICAgCiAgICAgICAgaWYgKHRpbWUgPT09IG51bGwgfHwgdmFsID09PSBudWxsKSBjb250aW51ZTsKICAgICAgICAKICAgICAgICBmaWx0ZXJlZFRpbWVQb2ludHMucHVzaCh0aW1lKTsKICAgICAgICBwcm9jZXNzZWRWYWx1ZXMucHVzaCh2YWwpOwogICAgICAgIG9yaWdpbmFsVmFsdWVzLnB1c2godmFsKTsgLy8gU3RvcmUgb3JpZ2luYWwgdmFsdWUgKHNhbWUgYXMgcHJvY2Vzc2VkIHdoZW4gbm90IG5vcm1hbGl6ZWQpCiAgICAgIH0KICAgIH0KICAgIAogICAgcmV0dXJuIHsgdGltZVBvaW50czogZmlsdGVyZWRUaW1lUG9pbnRzLCB2YWx1ZXM6IHByb2Nlc3NlZFZhbHVlcywgb3JpZ2luYWxWYWx1ZXM6IG9yaWdpbmFsVmFsdWVzIH07CiAgfSkuZmlsdGVyKHdlbGwgPT4gd2VsbC50aW1lUG9pbnRzLmxlbmd0aCA+IDApOyAvLyBGaWx0ZXIgb3V0IHdlbGxzIHdpdGggbm8gZGF0YQogIAogIC8vIFN0ZXAgMjogRmluZCBhbGwgdW5pcXVlIHRpbWUgcG9pbnRzIGFjcm9zcyBhbGwgcHJvY2Vzc2VkIHdlbGxzCiAgY29uc3QgYWxsVGltZVBvaW50cyA9IG5ldyBTZXQoKTsKICBwcm9jZXNzZWRXZWxscy5mb3JFYWNoKHdlbGwgPT4gewogICAgd2VsbC50aW1lUG9pbnRzLmZvckVhY2godCA9PiB7CiAgICAgIGlmICh0ICE9PSBudWxsKSBhbGxUaW1lUG9pbnRzLmFkZCh0KTsKICAgIH0pOwogIH0pOwogIAogIGNvbnN0IHNvcnRlZFRpbWVQb2ludHMgPSBBcnJheS5mcm9tKGFsbFRpbWVQb2ludHMpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKICAKICAvLyBTdGVwIDM6IENhbGN1bGF0ZSBtZWFuIGFuZCBlcnJvciBhdCBlYWNoIHRpbWUgcG9pbnQgZnJvbSBwcm9jZXNzZWQgdmFsdWVzCiAgLy8gQWxzbyB0cmFjayBvcmlnaW5hbCB2YWx1ZXMgZm9yIHRvb2x0aXAgZGlzcGxheQogIGNvbnN0IG1lYW5zID0gW107CiAgY29uc3QgZXJyb3JzID0gW107CiAgY29uc3Qgb3JpZ2luYWxNZWFucyA9IFtdOwogIAogIHNvcnRlZFRpbWVQb2ludHMuZm9yRWFjaCh0aW1lID0+IHsKICAgIGNvbnN0IHZhbHVlcyA9IFtdOwogICAgY29uc3Qgb3JpZ1ZhbHVlcyA9IFtdOwogICAgcHJvY2Vzc2VkV2VsbHMuZm9yRWFjaCh3ZWxsID0+IHsKICAgICAgY29uc3QgdGltZUlkeCA9IHdlbGwudGltZVBvaW50cy5pbmRleE9mKHRpbWUpOwogICAgICBpZiAodGltZUlkeCA+PSAwICYmIHdlbGwudmFsdWVzW3RpbWVJZHhdICE9PSBudWxsKSB7CiAgICAgICAgdmFsdWVzLnB1c2god2VsbC52YWx1ZXNbdGltZUlkeF0pOwogICAgICAgIGlmICh3ZWxsLm9yaWdpbmFsVmFsdWVzICYmIHdlbGwub3JpZ2luYWxWYWx1ZXNbdGltZUlkeF0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgb3JpZ1ZhbHVlcy5wdXNoKHdlbGwub3JpZ2luYWxWYWx1ZXNbdGltZUlkeF0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICAKICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIG1lYW5zLnB1c2gobnVsbCk7CiAgICAgIGVycm9ycy5wdXNoKG51bGwpOwogICAgICBvcmlnaW5hbE1lYW5zLnB1c2gobnVsbCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIAogICAgY29uc3QgbWVhbiA9IHZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIHZhbHVlcy5sZW5ndGg7CiAgICAvLyBVc2Ugc2FtcGxlIHZhcmlhbmNlIChkaXZpZGUgYnkgbi0xKSBmb3IgcHJvcGVyIFNFTSBjYWxjdWxhdGlvbgogICAgY29uc3QgbiA9IHZhbHVlcy5sZW5ndGg7CiAgICBjb25zdCB2YXJpYW5jZSA9IG4gPiAxIAogICAgICA/IHZhbHVlcy5yZWR1Y2UoKHN1bSwgdmFsKSA9PiBzdW0gKyBNYXRoLnBvdyh2YWwgLSBtZWFuLCAyKSwgMCkgLyAobiAtIDEpCiAgICAgIDogMDsKICAgIGNvbnN0IHN0ZERldiA9IE1hdGguc3FydCh2YXJpYW5jZSk7CiAgICBjb25zdCBzdGRFcnJvciA9IHN0ZERldiAvIE1hdGguc3FydChuKTsKICAgIAogICAgbWVhbnMucHVzaChtZWFuKTsKICAgIGVycm9ycy5wdXNoKHN0ZEVycm9yKTsKICAgIAogICAgLy8gQ2FsY3VsYXRlIG1lYW4gb2Ygb3JpZ2luYWwgdmFsdWVzCiAgICBpZiAob3JpZ1ZhbHVlcy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG9yaWdNZWFuID0gb3JpZ1ZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIG9yaWdWYWx1ZXMubGVuZ3RoOwogICAgICBvcmlnaW5hbE1lYW5zLnB1c2gob3JpZ01lYW4pOwogICAgfSBlbHNlIHsKICAgICAgb3JpZ2luYWxNZWFucy5wdXNoKG51bGwpOwogICAgfQogIH0pOwogIAogIHJldHVybiB7IGZpbHRlcmVkVGltZVBvaW50czogc29ydGVkVGltZVBvaW50cywgbm9ybWFsaXplZE1lYW5zOiBtZWFucywgbm9ybWFsaXplZEVycm9yczogZXJyb3JzLCBvcmlnaW5hbE1lYW5zOiBvcmlnaW5hbE1lYW5zIH07Cn0KCi8vIEtlZXAgb2xkIGZ1bmN0aW9uIG5hbWUgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCBidXQgaXQgbm93IHVzZXMgdGhlIHVuaWZpZWQgd29ya2Zsb3cKZnVuY3Rpb24gY2FsY3VsYXRlTWVhbkFuZEVycm9yRnJvbU5vcm1hbGl6ZWQod2VsbHMsIGJhc2VsaW5lRW5kVGltZSA9IDI0LCBjdXRvZmZUaW1lID0gMzYwKSB7CiAgcmV0dXJuIHByb2Nlc3NXZWxsc0FuZENhbGN1bGF0ZU1lYW4od2VsbHMsIHRydWUsIGJhc2VsaW5lRW5kVGltZSwgY3V0b2ZmVGltZSk7Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZURhdGEodGltZVBvaW50cywgdmFsdWVzLCBiYXNlbGluZUVuZFRpbWUgPSAyNCwgY3V0b2ZmVGltZSA9IDM2MCkgewogIC8vIE5vcm1hbGl6ZSBkYXRhOiBjYWxjdWxhdGUgYmFzZWxpbmUgZnJvbSAwLWJhc2VsaW5lRW5kVGltZSwgdGhlbiBwbG90IG9ubHkgcG9pbnRzIGFmdGVyIGJhc2VsaW5lRW5kVGltZQogIC8vIGRpdmlkZWQgYnkgYmFzZWxpbmUsIHVwIHRvIGN1dG9mZlRpbWUuIEJhc2VsaW5lIHBlcmlvZCBpcyBOT1QgaW5jbHVkZWQgaW4gdGhlIHBsb3QuCiAgLy8gUmV0dXJucyB7IGZpbHRlcmVkVGltZVBvaW50cywgbm9ybWFsaXplZFZhbHVlcywgb3JpZ2luYWxWYWx1ZXMgfSAtIGZpbHRlcmVkIGFycmF5cwogIGlmICghdGltZVBvaW50cyB8fCAhdmFsdWVzIHx8IHRpbWVQb2ludHMubGVuZ3RoICE9PSB2YWx1ZXMubGVuZ3RoKSB7CiAgICAvLyBJZiBpbnZhbGlkIGlucHV0LCByZXR1cm4gZW1wdHkgZmlsdGVyZWQgYXJyYXlzCiAgICByZXR1cm4geyBmaWx0ZXJlZFRpbWVQb2ludHM6IFtdLCBub3JtYWxpemVkVmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgfQogIAogIC8vIEZpbmQgYmFzZWxpbmU6IGF2ZXJhZ2Ugb2YgYWxsIHZhbHVlcyB3aGVyZSB0aW1lIDw9IGJhc2VsaW5lRW5kVGltZQogIGNvbnN0IGJhc2VsaW5lVmFsdWVzID0gW107CiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aW1lUG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAodGltZVBvaW50c1tpXSAhPT0gbnVsbCAmJiB2YWx1ZXNbaV0gIT09IG51bGwgJiYgdGltZVBvaW50c1tpXSA8PSBiYXNlbGluZUVuZFRpbWUpIHsKICAgICAgYmFzZWxpbmVWYWx1ZXMucHVzaCh2YWx1ZXNbaV0pOwogICAgfQogIH0KICAKICBpZiAoYmFzZWxpbmVWYWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAvLyBObyBiYXNlbGluZSBkYXRhIGZvdW5kLCByZXR1cm4gZW1wdHkgZmlsdGVyZWQgYXJyYXlzIChjYW4ndCBub3JtYWxpemUgd2l0aG91dCBiYXNlbGluZSkKICAgIHJldHVybiB7IGZpbHRlcmVkVGltZVBvaW50czogW10sIG5vcm1hbGl6ZWRWYWx1ZXM6IFtdLCBvcmlnaW5hbFZhbHVlczogW10gfTsKICB9CiAgCiAgY29uc3QgYmFzZWxpbmUgPSBiYXNlbGluZVZhbHVlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIGJhc2VsaW5lVmFsdWVzLmxlbmd0aDsKICAKICBpZiAoYmFzZWxpbmUgPT09IDAgfHwgIWlzRmluaXRlKGJhc2VsaW5lKSkgewogICAgLy8gQXZvaWQgZGl2aXNpb24gYnkgemVybyBvciBpbnZhbGlkIGJhc2VsaW5lCiAgICByZXR1cm4geyBmaWx0ZXJlZFRpbWVQb2ludHM6IFtdLCBub3JtYWxpemVkVmFsdWVzOiBbXSwgb3JpZ2luYWxWYWx1ZXM6IFtdIH07CiAgfQogIAogIC8vIEZpbHRlciBhbmQgbm9ybWFsaXplOiBvbmx5IGluY2x1ZGUgcG9pbnRzIHdoZXJlIGJhc2VsaW5lRW5kVGltZSA8IHRpbWUgPD0gY3V0b2ZmVGltZQogIC8vIEVWRVJZIHBvaW50IGFmdGVyIGJhc2VsaW5lRW5kVGltZSBpcyBkaXZpZGVkIGJ5IHRoZSBTQU1FIGJhc2VsaW5lIGF2ZXJhZ2UKICBjb25zdCBmaWx0ZXJlZFRpbWVQb2ludHMgPSBbXTsKICBjb25zdCBub3JtYWxpemVkVmFsdWVzID0gW107CiAgY29uc3Qgb3JpZ2luYWxWYWx1ZXMgPSBbXTsKICAKICBmb3IgKGxldCBpID0gMDsgaSA8IHRpbWVQb2ludHMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHRpbWUgPSB0aW1lUG9pbnRzW2ldOwogICAgY29uc3QgdmFsID0gdmFsdWVzW2ldOwogICAgCiAgICBpZiAodGltZSA9PT0gbnVsbCB8fCB2YWwgPT09IG51bGwpIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICAKICAgIC8vIE9ubHkgaW5jbHVkZSBwb2ludHMgYWZ0ZXIgYmFzZWxpbmVFbmRUaW1lIGFuZCB1cCB0byBjdXRvZmZUaW1lIChiYXNlbGluZSBOT1QgaW5jbHVkZWQpCiAgICBpZiAodGltZSA+IGJhc2VsaW5lRW5kVGltZSAmJiB0aW1lIDw9IGN1dG9mZlRpbWUpIHsKICAgICAgLy8gU3VidHJhY3QgYmFzZWxpbmVFbmRUaW1lIHRvIGJyaW5nIGZpcnN0IHBvaW50IHRvIHg9MCAodGltZSBhZnRlciBpbmplY3Rpb24pCiAgICAgIGZpbHRlcmVkVGltZVBvaW50cy5wdXNoKHRpbWUgLSBiYXNlbGluZUVuZFRpbWUpOwogICAgICAvLyBEaXZpZGUgRVZFUlkgdGltZSBwb2ludCBieSB0aGUgU0FNRSBiYXNlbGluZSBhdmVyYWdlCiAgICAgIG5vcm1hbGl6ZWRWYWx1ZXMucHVzaCh2YWwgLyBiYXNlbGluZSk7CiAgICAgIG9yaWdpbmFsVmFsdWVzLnB1c2godmFsKTsgLy8gU3RvcmUgb3JpZ2luYWwgdmFsdWUgZm9yIHRvb2x0aXAKICAgIH0KICB9CiAgCiAgcmV0dXJuIHsgZmlsdGVyZWRUaW1lUG9pbnRzLCBub3JtYWxpemVkVmFsdWVzLCBvcmlnaW5hbFZhbHVlcyB9Owp9CgovLyBGaXQgYmFzZWxpbmUgZnVuY3Rpb24gdXNpbmcgc3BlY2lmaWVkIG1ldGhvZApmdW5jdGlvbiBmaXRCYXNlbGluZUZ1bmN0aW9uKHRpbWVQb2ludHMsIHZhbHVlcywgbWV0aG9kID0gJ2xvd2VzcycsIGZyYWMgPSAwLjUsIHBvbHlPcmRlciA9IDEpIHsKICAvLyBFeHRyYWN0IGJhc2VsaW5lIHdpbmRvdyAodGltZSA8PSBiYXNlbGluZUVuZFRpbWUgd2lsbCBiZSBoYW5kbGVkIGJ5IGNhbGxlcikKICAvLyBUaGlzIGZ1bmN0aW9uIGZpdHMgb24gdGhlIHByb3ZpZGVkIHBvaW50cyBhbmQgcmV0dXJucyBhIGZ1bmN0aW9uIGcodCkgdGhhdCBjYW4gYmUgZXZhbHVhdGVkIGF0IGFueSB0aW1lCiAgCiAgaWYgKCF0aW1lUG9pbnRzIHx8ICF2YWx1ZXMgfHwgdGltZVBvaW50cy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBudWxsOwogIH0KICAKICAvLyBGaWx0ZXIgb3V0IE5hTiB2YWx1ZXMKICBjb25zdCB2YWxpZERhdGEgPSBbXTsKICBmb3IgKGxldCBpID0gMDsgaSA8IHRpbWVQb2ludHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICh0aW1lUG9pbnRzW2ldICE9PSBudWxsICYmIHZhbHVlc1tpXSAhPT0gbnVsbCAmJiAhaXNOYU4odGltZVBvaW50c1tpXSkgJiYgIWlzTmFOKHZhbHVlc1tpXSkpIHsKICAgICAgdmFsaWREYXRhLnB1c2goeyB0OiB0aW1lUG9pbnRzW2ldLCB2OiB2YWx1ZXNbaV0gfSk7CiAgICB9CiAgfQogIAogIGlmICh2YWxpZERhdGEubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgdmFsaWREYXRhLnNvcnQoKGEsIGIpID0+IGEudCAtIGIudCk7CiAgY29uc3QgdGltZXMgPSB2YWxpZERhdGEubWFwKGQgPT4gZC50KTsKICBjb25zdCB2YWxzID0gdmFsaWREYXRhLm1hcChkID0+IGQudik7CiAgCiAgaWYgKG1ldGhvZCA9PT0gJ2NvbnN0YW50JykgewogICAgLy8gQ29uc3RhbnQgYmFzZWxpbmU6IGcodCkgPSBtZWFuKEZfYmFzZWxpbmUpCiAgICBjb25zdCBiYXNlbGluZVZhbHVlID0gdmFscy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIHZhbHMubGVuZ3RoOwogICAgcmV0dXJuICh0KSA9PiBiYXNlbGluZVZhbHVlOwogIH0gZWxzZSBpZiAobWV0aG9kID09PSAncG9seW5vbWlhbCcpIHsKICAgIC8vIFBvbHlub21pYWwgZml0OiBnKHQpID0gY+KCgCArIGPigoF0ICsgY+KCgnTCsiArIC4uLgogICAgLy8gU2ltcGxlIHBvbHlub21pYWwgcmVncmVzc2lvbgogICAgY29uc3QgbiA9IHRpbWVzLmxlbmd0aDsKICAgIGNvbnN0IFggPSBbXTsKICAgIGNvbnN0IHkgPSB2YWxzOwogICAgCiAgICAvLyBCdWlsZCBkZXNpZ24gbWF0cml4CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCByb3cgPSBbXTsKICAgICAgZm9yIChsZXQgcCA9IHBvbHlPcmRlcjsgcCA+PSAwOyBwLS0pIHsKICAgICAgICByb3cucHVzaChNYXRoLnBvdyh0aW1lc1tpXSwgcCkpOwogICAgICB9CiAgICAgIFgucHVzaChyb3cpOwogICAgfQogICAgCiAgICAvLyBTb2x2ZSB1c2luZyBub3JtYWwgZXF1YXRpb25zOiAoWCdYKV4oLTEpWCd5CiAgICAvLyBTaW1wbGlmaWVkIGZvciBzbWFsbCBvcmRlcnMKICAgIGxldCBjb2VmZnM7CiAgICBpZiAocG9seU9yZGVyID09PSAxKSB7CiAgICAgIC8vIExpbmVhcjogeSA9IGEgKyBiKnQKICAgICAgY29uc3Qgc3VtVCA9IHRpbWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgICBjb25zdCBzdW1UMiA9IHRpbWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIgKiBiLCAwKTsKICAgICAgY29uc3Qgc3VtWSA9IHkucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICAgIGNvbnN0IHN1bVRZID0gdGltZXMucmVkdWNlKChzdW0sIHQsIGkpID0+IHN1bSArIHQgKiB5W2ldLCAwKTsKICAgICAgY29uc3QgbiA9IHRpbWVzLmxlbmd0aDsKICAgICAgCiAgICAgIGNvbnN0IGRldCA9IG4gKiBzdW1UMiAtIHN1bVQgKiBzdW1UOwogICAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgICAgLy8gRmFsbGJhY2sgdG8gY29uc3RhbnQKICAgICAgICBjb25zdCBtZWFuID0gc3VtWSAvIG47CiAgICAgICAgcmV0dXJuICh0KSA9PiBtZWFuOwogICAgICB9CiAgICAgIAogICAgICBjb25zdCBhID0gKHN1bVkgKiBzdW1UMiAtIHN1bVQgKiBzdW1UWSkgLyBkZXQ7CiAgICAgIGNvbnN0IGIgPSAobiAqIHN1bVRZIC0gc3VtVCAqIHN1bVkpIC8gZGV0OwogICAgICBjb2VmZnMgPSBbYiwgYV07IC8vIFtjMSwgYzBdIGZvciBwb2x5MWQgZm9ybWF0CiAgICB9IGVsc2UgewogICAgICAvLyBIaWdoZXIgb3JkZXIgLSB1c2Ugc2ltcGxlIGxlYXN0IHNxdWFyZXMKICAgICAgLy8gRm9yIHNpbXBsaWNpdHksIHVzZSBhIGJhc2ljIGltcGxlbWVudGF0aW9uCiAgICAgIGNvbnN0IG1lYW5UID0gc3VtVCAvIG47CiAgICAgIGNvbnN0IG1lYW5ZID0gc3VtWSAvIG47CiAgICAgIC8vIEZhbGxiYWNrIHRvIGNvbnN0YW50IGZvciBub3cgaWYgb3JkZXIgPiAxCiAgICAgIGNvbnN0IG1lYW4gPSBtZWFuWTsKICAgICAgcmV0dXJuICh0KSA9PiBtZWFuOwogICAgfQogICAgCiAgICByZXR1cm4gKHQpID0+IHsKICAgICAgbGV0IHJlc3VsdCA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29lZmZzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVzdWx0ICs9IGNvZWZmc1tpXSAqIE1hdGgucG93KHQsIGNvZWZmcy5sZW5ndGggLSAxIC0gaSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfSBlbHNlIGlmIChtZXRob2QgPT09ICdsb3dlc3MnKSB7CiAgICAvLyBMT1dFU1Mgc21vb3RoaW5nIC0gc2ltcGxpZmllZCBpbXBsZW1lbnRhdGlvbgogICAgLy8gRm9yIGEgcHJvcGVyIExPV0VTUywgd2UnZCBuZWVkIGEgbGlicmFyeSwgYnV0IHdlIGNhbiBhcHByb3hpbWF0ZSB3aXRoIG1vdmluZyBhdmVyYWdlCiAgICAvLyBUaGlzIGlzIGEgc2ltcGxpZmllZCB2ZXJzaW9uIC0gZm9yIHByb2R1Y3Rpb24sIGNvbnNpZGVyIHVzaW5nIGEgbGlicmFyeSBsaWtlIHJlZ3Jlc3Npb24uanMKICAgIAogICAgLy8gVXNlIGEgc2ltcGxlIG1vdmluZyBhdmVyYWdlIHdpdGggd2VpZ2h0ZWQgd2luZG93IGFzIGFwcHJveGltYXRpb24KICAgIGNvbnN0IHdpbmRvd1NpemUgPSBNYXRoLm1heCgxLCBNYXRoLmZsb29yKGZyYWMgKiB0aW1lcy5sZW5ndGgpKTsKICAgIGNvbnN0IHNtb290aGVkID0gW107CiAgICAKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZXMubGVuZ3RoOyBpKyspIHsKICAgICAgbGV0IHN1bSA9IDA7CiAgICAgIGxldCB3ZWlnaHRTdW0gPSAwOwogICAgICBjb25zdCBjZW50ZXIgPSB0aW1lc1tpXTsKICAgICAgCiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGltZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5hYnModGltZXNbal0gLSBjZW50ZXIpOwogICAgICAgIGNvbnN0IG1heERpc3QgPSBNYXRoLm1heCguLi50aW1lcy5tYXAodCA9PiBNYXRoLmFicyh0IC0gY2VudGVyKSkpOwogICAgICAgIGNvbnN0IHdlaWdodCA9IGRpc3QgPCBtYXhEaXN0ICogZnJhYyA/IE1hdGgucG93KDEgLSAoZGlzdCAvIChtYXhEaXN0ICogZnJhYykpLCAzKSA6IDA7IC8vIFRyaWN1YmUgd2VpZ2h0CiAgICAgICAgCiAgICAgICAgc3VtICs9IHZhbHNbal0gKiB3ZWlnaHQ7CiAgICAgICAgd2VpZ2h0U3VtICs9IHdlaWdodDsKICAgICAgfQogICAgICAKICAgICAgc21vb3RoZWQucHVzaCh3ZWlnaHRTdW0gPiAwID8gc3VtIC8gd2VpZ2h0U3VtIDogdmFsc1tpXSk7CiAgICB9CiAgICAKICAgIC8vIFJldHVybiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uCiAgICByZXR1cm4gKHQpID0+IHsKICAgICAgaWYgKHQgPD0gdGltZXNbMF0pIHJldHVybiBzbW9vdGhlZFswXTsKICAgICAgaWYgKHQgPj0gdGltZXNbdGltZXMubGVuZ3RoIC0gMV0pIHJldHVybiBzbW9vdGhlZFtzbW9vdGhlZC5sZW5ndGggLSAxXTsKICAgICAgCiAgICAgIC8vIExpbmVhciBpbnRlcnBvbGF0aW9uCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZXMubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgaWYgKHQgPj0gdGltZXNbaV0gJiYgdCA8PSB0aW1lc1tpICsgMV0pIHsKICAgICAgICAgIGNvbnN0IHJhdGlvID0gKHQgLSB0aW1lc1tpXSkgLyAodGltZXNbaSArIDFdIC0gdGltZXNbaV0pOwogICAgICAgICAgcmV0dXJuIHNtb290aGVkW2ldICogKDEgLSByYXRpbykgKyBzbW9vdGhlZFtpICsgMV0gKiByYXRpbzsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHNtb290aGVkW3Ntb290aGVkLmxlbmd0aCAtIDFdOwogICAgfTsKICB9CiAgCiAgcmV0dXJuIG51bGw7Cn0KCi8vIE5vcm1hbGl6ZSB3ZWxsIGRhdGEgdXNpbmcgZml0dGVkIGJhc2VsaW5lIChTdGVwIDQpCmZ1bmN0aW9uIG5vcm1hbGl6ZVdpdGhGaXR0ZWRCYXNlbGluZSh3ZWxsRGF0YSwgYmFzZWxpbmVFbmRUaW1lLCBtZXRob2QsIGZyYWMsIHBvbHlPcmRlciwgbm9ybWFsaXphdGlvbk1vZGUpIHsKICBpZiAoIXdlbGxEYXRhIHx8ICF3ZWxsRGF0YS50aW1lX3MgfHwgIXdlbGxEYXRhLnZhbHVlcykgewogICAgcmV0dXJuIHdlbGxEYXRhOwogIH0KICAKICAvLyBFeHRyYWN0IGJhc2VsaW5lIHdpbmRvdwogIGNvbnN0IGJhc2VsaW5lVGltZXMgPSBbXTsKICBjb25zdCBiYXNlbGluZVZhbHVlcyA9IFtdOwogIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbERhdGEudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCB0aW1lID0gd2VsbERhdGEudGltZV9zW2ldOwogICAgY29uc3QgdmFsID0gd2VsbERhdGEudmFsdWVzW2ldOwogICAgaWYgKHRpbWUgIT09IG51bGwgJiYgdmFsICE9PSBudWxsICYmIHRpbWUgPD0gYmFzZWxpbmVFbmRUaW1lKSB7CiAgICAgIGJhc2VsaW5lVGltZXMucHVzaCh0aW1lKTsKICAgICAgYmFzZWxpbmVWYWx1ZXMucHVzaCh2YWwpOwogICAgfQogIH0KICAKICBpZiAoYmFzZWxpbmVUaW1lcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB3ZWxsRGF0YTsgLy8gTm8gYmFzZWxpbmUgZGF0YQogIH0KICAKICAvLyBGaXQgYmFzZWxpbmUgZnVuY3Rpb24KICBjb25zdCBiYXNlbGluZUZ1bmMgPSBmaXRCYXNlbGluZUZ1bmN0aW9uKGJhc2VsaW5lVGltZXMsIGJhc2VsaW5lVmFsdWVzLCBtZXRob2QsIGZyYWMsIHBvbHlPcmRlcik7CiAgaWYgKCFiYXNlbGluZUZ1bmMpIHsKICAgIHJldHVybiB3ZWxsRGF0YTsKICB9CiAgCiAgLy8gTm9ybWFsaXplIGFsbCB0aW1lcG9pbnRzIHVzaW5nIGZpdHRlZCBiYXNlbGluZQogIGNvbnN0IG5vcm1hbGl6ZWRUaW1lcyA9IFtdOwogIGNvbnN0IG5vcm1hbGl6ZWRWYWx1ZXMgPSBbXTsKICBjb25zdCBvcmlnaW5hbFZhbHVlcyA9IFtdOwogIAogIGZvciAobGV0IGkgPSAwOyBpIDwgd2VsbERhdGEudGltZV9zLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCB0aW1lID0gd2VsbERhdGEudGltZV9zW2ldOwogICAgY29uc3QgdmFsdWUgPSB3ZWxsRGF0YS52YWx1ZXNbaV07CiAgICAKICAgIGlmICh0aW1lID09PSBudWxsIHx8IHZhbHVlID09PSBudWxsKSBjb250aW51ZTsKICAgIAogICAgY29uc3QgYmFzZWxpbmVWYWx1ZSA9IGJhc2VsaW5lRnVuYyh0aW1lKTsKICAgIGlmIChiYXNlbGluZVZhbHVlID09PSAwIHx8ICFpc0Zpbml0ZShiYXNlbGluZVZhbHVlKSkgY29udGludWU7CiAgICAKICAgIGxldCBub3JtVmFsdWU7CiAgICBpZiAobm9ybWFsaXphdGlvbk1vZGUgPT09ICdkZWx0YV9mX292ZXJfZicpIHsKICAgICAgLy8gzpRGL0YgPSAoRih0KSAtIGcodCkpIC8gZyh0KQogICAgICBub3JtVmFsdWUgPSAodmFsdWUgLSBiYXNlbGluZVZhbHVlKSAvIGJhc2VsaW5lVmFsdWU7CiAgICB9IGVsc2UgewogICAgICAvLyBNdWx0aXBsaWNhdGl2ZTogRl9ub3JtKHQpID0gRih0KSAvIGcodCkKICAgICAgbm9ybVZhbHVlID0gdmFsdWUgLyBiYXNlbGluZVZhbHVlOwogICAgfQogICAgCiAgICBub3JtYWxpemVkVGltZXMucHVzaCh0aW1lKTsKICAgIG5vcm1hbGl6ZWRWYWx1ZXMucHVzaChub3JtVmFsdWUpOwogICAgb3JpZ2luYWxWYWx1ZXMucHVzaCh2YWx1ZSk7CiAgfQogIAogIGlmIChub3JtYWxpemVkVGltZXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgcmV0dXJuIHsKICAgIHRpbWVfczogbm9ybWFsaXplZFRpbWVzLAogICAgdmFsdWVzOiBub3JtYWxpemVkVmFsdWVzLAogICAgb3JpZ2luYWxWYWx1ZXM6IG9yaWdpbmFsVmFsdWVzLAogICAgbGFiZWw6IHdlbGxEYXRhLmxhYmVsLAogICAgY29udGVudDogd2VsbERhdGEuY29udGVudAogIH07Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZVdlbGxEYXRhKHdlbGxEYXRhLCBpc05vcm1hbGl6ZWQsIGJhc2VsaW5lRW5kVGltZSA9IDI0LCBjdXRvZmZUaW1lID0gMzYwKSB7CiAgLy8gU1RFUCAzOiBOb3JtYWxpemUgYSBzaW5nbGUgd2VsbCdzIGRhdGEgb2JqZWN0IChpZiBub3JtYWxpemF0aW9uIGlzIGVuYWJsZWQpCiAgLy8gVGhpcyBoYXBwZW5zIEFGVEVSIGJhc2VsaW5lIGFsaWdubWVudCBhbmQgZ3JvdXBpbmcgaW50byB0cmlwbGljYXRlcwogIC8vIFJldHVybnMgYSBuZXcgd2VsbCBkYXRhIG9iamVjdCB3aXRoIG5vcm1hbGl6ZWQgdGltZV9zIGFuZCB2YWx1ZXMgKG9yIG9yaWdpbmFsIGlmIG5vdCBub3JtYWxpemVkKQogIGlmICghd2VsbERhdGEgfHwgIXdlbGxEYXRhLnRpbWVfcyB8fCAhd2VsbERhdGEudmFsdWVzKSB7CiAgICByZXR1cm4gd2VsbERhdGE7IC8vIFJldHVybiBhcy1pcyBpZiBpbnZhbGlkCiAgfQogIAogIGlmICghaXNOb3JtYWxpemVkKSB7CiAgICAvLyBOb3Qgbm9ybWFsaXppbmcgLSByZXR1cm4gb3JpZ2luYWwgZGF0YQogICAgcmV0dXJuIHsKICAgICAgdGltZV9zOiB3ZWxsRGF0YS50aW1lX3MsCiAgICAgIHZhbHVlczogd2VsbERhdGEudmFsdWVzLAogICAgICBsYWJlbDogd2VsbERhdGEubGFiZWwsCiAgICAgIGNvbnRlbnQ6IHdlbGxEYXRhLmNvbnRlbnQsCiAgICAgIG9yaWdpbmFsVmFsdWVzOiB3ZWxsRGF0YS5vcmlnaW5hbFZhbHVlcyB8fCB3ZWxsRGF0YS52YWx1ZXMKICAgIH07CiAgfQogIAogIC8vIE5vcm1hbGl6ZSB0aGlzIHdlbGwKICBjb25zdCBub3JtYWxpemVkID0gbm9ybWFsaXplRGF0YSh3ZWxsRGF0YS50aW1lX3MsIHdlbGxEYXRhLnZhbHVlcywgYmFzZWxpbmVFbmRUaW1lLCBjdXRvZmZUaW1lKTsKICAKICBpZiAobm9ybWFsaXplZC5maWx0ZXJlZFRpbWVQb2ludHMubGVuZ3RoID09PSAwKSB7CiAgICAvLyBObyBkYXRhIGFmdGVyIG5vcm1hbGl6YXRpb24gLSByZXR1cm4gbnVsbCB0byBpbmRpY2F0ZSB0aGlzIHdlbGwgc2hvdWxkIGJlIHNraXBwZWQKICAgIHJldHVybiBudWxsOwogIH0KICAKICAvLyBSZXR1cm4gbm9ybWFsaXplZCB3ZWxsIGRhdGEKICByZXR1cm4gewogICAgdGltZV9zOiBub3JtYWxpemVkLmZpbHRlcmVkVGltZVBvaW50cywKICAgIHZhbHVlczogbm9ybWFsaXplZC5ub3JtYWxpemVkVmFsdWVzLAogICAgb3JpZ2luYWxWYWx1ZXM6IG5vcm1hbGl6ZWQub3JpZ2luYWxWYWx1ZXMsIC8vIFN0b3JlIGZvciB0b29sdGlwIGRpc3BsYXkKICAgIGxhYmVsOiB3ZWxsRGF0YS5sYWJlbCwKICAgIGNvbnRlbnQ6IHdlbGxEYXRhLmNvbnRlbnQKICB9Owp9CgoKLy8gRml0IHJlZ3Jlc3Npb24gY3VydmUgdG8gZGF0YSBwb2ludHMgKFN0ZXAgNCkKZnVuY3Rpb24gZml0UmVncmVzc2lvbkN1cnZlKGRhdGFQb2ludHMsIHJlZ3Jlc3Npb25UeXBlID0gJ21vbm8tZXhwb25lbnRpYWwnLCBwb2x5bm9taWFsT3JkZXIgPSAyKSB7CiAgLy8gZGF0YVBvaW50cyBpcyBhbiBhcnJheSBvZiB7eCwgeX0gb2JqZWN0cwogIGlmICghZGF0YVBvaW50cyB8fCBkYXRhUG9pbnRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIAogIC8vIEZpbHRlciB2YWxpZCBwb2ludHMKICBjb25zdCB2YWxpZFBvaW50cyA9IGRhdGFQb2ludHMuZmlsdGVyKHAgPT4gcC54ICE9PSBudWxsICYmIHAueSAhPT0gbnVsbCAmJiBpc0Zpbml0ZShwLngpICYmIGlzRmluaXRlKHAueSkpOwogIGlmICh2YWxpZFBvaW50cy5sZW5ndGggPCAyKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgLy8gU29ydCBieSB4CiAgdmFsaWRQb2ludHMuc29ydCgoYSwgYikgPT4gYS54IC0gYi54KTsKICBjb25zdCB4ID0gdmFsaWRQb2ludHMubWFwKHAgPT4gcC54KTsKICBjb25zdCB5ID0gdmFsaWRQb2ludHMubWFwKHAgPT4gcC55KTsKICAKICBsZXQgZml0RnVuY3Rpb247CiAgCiAgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAnbGluZWFyJykgewogICAgLy8gTGluZWFyOiB5ID0gYSArIGIqeAogICAgY29uc3QgbiA9IHgubGVuZ3RoOwogICAgY29uc3Qgc3VtWCA9IHgucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICBjb25zdCBzdW1ZID0geS5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTsKICAgIGNvbnN0IHN1bVhZID0geC5yZWR1Y2UoKHN1bSwgeGksIGkpID0+IHN1bSArIHhpICogeVtpXSwgMCk7CiAgICBjb25zdCBzdW1YMiA9IHgucmVkdWNlKChzdW0sIHhpKSA9PiBzdW0gKyB4aSAqIHhpLCAwKTsKICAgIAogICAgY29uc3QgZGV0ID0gbiAqIHN1bVgyIC0gc3VtWCAqIHN1bVg7CiAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgIC8vIEZhbGxiYWNrIHRvIGNvbnN0YW50CiAgICAgIGNvbnN0IG1lYW4gPSBzdW1ZIC8gbjsKICAgICAgZml0RnVuY3Rpb24gPSAodCkgPT4gbWVhbjsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGEgPSAoc3VtWSAqIHN1bVgyIC0gc3VtWCAqIHN1bVhZKSAvIGRldDsKICAgICAgY29uc3QgYiA9IChuICogc3VtWFkgLSBzdW1YICogc3VtWSkgLyBkZXQ7CiAgICAgIGZpdEZ1bmN0aW9uID0gKHQpID0+IGEgKyBiICogdDsKICAgIH0KICB9IGVsc2UgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAncG9seW5vbWlhbCcpIHsKICAgIC8vIFBvbHlub21pYWw6IHkgPSBjMCArIGMxKnggKyBjMip4XjIgKyAuLi4gKyBjbip4Xm4KICAgIGNvbnN0IG4gPSB4Lmxlbmd0aDsKICAgIGNvbnN0IG9yZGVyID0gTWF0aC5taW4ocG9seW5vbWlhbE9yZGVyLCBuIC0gMSk7IC8vIENhbid0IGZpdCBvcmRlciA+PSBuIHBvaW50cwogICAgCiAgICAvLyBCdWlsZCBkZXNpZ24gbWF0cml4CiAgICBjb25zdCBYID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCByb3cgPSBbXTsKICAgICAgZm9yIChsZXQgcCA9IG9yZGVyOyBwID49IDA7IHAtLSkgewogICAgICAgIHJvdy5wdXNoKE1hdGgucG93KHhbaV0sIHApKTsKICAgICAgfQogICAgICBYLnB1c2gocm93KTsKICAgIH0KICAgIAogICAgLy8gU29sdmUgdXNpbmcgbm9ybWFsIGVxdWF0aW9uczogKFgnWCleKC0xKVgneQogICAgLy8gU2ltcGxpZmllZCBmb3Igc21hbGwgb3JkZXJzCiAgICBsZXQgY29lZmZzOwogICAgaWYgKG9yZGVyID09PSAxKSB7CiAgICAgIC8vIExpbmVhciBjYXNlCiAgICAgIGNvbnN0IHN1bVggPSB4LnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgICBjb25zdCBzdW1YMiA9IHgucmVkdWNlKChzdW0sIHhpKSA9PiBzdW0gKyB4aSAqIHhpLCAwKTsKICAgICAgY29uc3Qgc3VtWSA9IHkucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICAgIGNvbnN0IHN1bVhZID0geC5yZWR1Y2UoKHN1bSwgeGksIGkpID0+IHN1bSArIHhpICogeVtpXSwgMCk7CiAgICAgIGNvbnN0IGRldCA9IG4gKiBzdW1YMiAtIHN1bVggKiBzdW1YOwogICAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgICAgY29lZmZzID0gW3N1bVkgLyBuLCAwXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBhID0gKHN1bVkgKiBzdW1YMiAtIHN1bVggKiBzdW1YWSkgLyBkZXQ7CiAgICAgICAgY29uc3QgYiA9IChuICogc3VtWFkgLSBzdW1YICogc3VtWSkgLyBkZXQ7CiAgICAgICAgY29lZmZzID0gW2EsIGJdOyAvLyBbYzAsIGMxXQogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBIaWdoZXIgb3JkZXIgLSB1c2Ugc2ltcGxlIGxlYXN0IHNxdWFyZXMgYXBwcm94aW1hdGlvbgogICAgICAvLyBGb3Igc2ltcGxpY2l0eSwgdXNlIGEgYmFzaWMgaW1wbGVtZW50YXRpb24KICAgICAgY29uc3QgbWVhblkgPSB5LnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gbjsKICAgICAgY29lZmZzID0gW21lYW5ZXTsKICAgICAgZm9yIChsZXQgcCA9IDE7IHAgPD0gb3JkZXI7IHArKykgewogICAgICAgIGNvZWZmcy5wdXNoKDApOwogICAgICB9CiAgICB9CiAgICAKICAgIGZpdEZ1bmN0aW9uID0gKHQpID0+IHsKICAgICAgbGV0IHJlc3VsdCA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29lZmZzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVzdWx0ICs9IGNvZWZmc1tpXSAqIE1hdGgucG93KHQsIGNvZWZmcy5sZW5ndGggLSAxIC0gaSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfSBlbHNlIGlmIChyZWdyZXNzaW9uVHlwZSA9PT0gJ2V4cG9uZW50aWFsJykgewogICAgLy8gRXhwb25lbnRpYWw6IHkgPSBhICogZV4oYip4KSBvciB5ID0gYSAqIGJeeAogICAgLy8gVHJhbnNmb3JtIHRvIGxpbmVhcjogbG4oeSkgPSBsbihhKSArIGIqeAogICAgY29uc3QgbG9nWSA9IHkubWFwKHlpID0+IHlpID4gMCA/IE1hdGgubG9nKHlpKSA6IG51bGwpLmZpbHRlcihseSA9PiBseSAhPT0gbnVsbCk7CiAgICBpZiAobG9nWS5sZW5ndGggPCAyKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgCiAgICBjb25zdCBuID0geC5sZW5ndGg7CiAgICBjb25zdCBzdW1YID0geC5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTsKICAgIGNvbnN0IHN1bUxvZ1kgPSBsb2dZLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgY29uc3Qgc3VtWExvZ1kgPSB4LnNsaWNlKDAsIGxvZ1kubGVuZ3RoKS5yZWR1Y2UoKHN1bSwgeGksIGkpID0+IHN1bSArIHhpICogbG9nWVtpXSwgMCk7CiAgICBjb25zdCBzdW1YMiA9IHguc2xpY2UoMCwgbG9nWS5sZW5ndGgpLnJlZHVjZSgoc3VtLCB4aSkgPT4gc3VtICsgeGkgKiB4aSwgMCk7CiAgICAKICAgIGNvbnN0IGRldCA9IGxvZ1kubGVuZ3RoICogc3VtWDIgLSBzdW1YICogc3VtWDsKICAgIGlmIChNYXRoLmFicyhkZXQpIDwgMWUtMTApIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICAKICAgIGNvbnN0IGxuQSA9IChzdW1Mb2dZICogc3VtWDIgLSBzdW1YICogc3VtWExvZ1kpIC8gZGV0OwogICAgY29uc3QgYiA9IChsb2dZLmxlbmd0aCAqIHN1bVhMb2dZIC0gc3VtWCAqIHN1bUxvZ1kpIC8gZGV0OwogICAgY29uc3QgYSA9IE1hdGguZXhwKGxuQSk7CiAgICAKICAgIGZpdEZ1bmN0aW9uID0gKHQpID0+IGEgKiBNYXRoLmV4cChiICogdCk7CiAgfSBlbHNlIGlmIChyZWdyZXNzaW9uVHlwZSA9PT0gJ2xvZ2FyaXRobWljJykgewogICAgLy8gTG9nYXJpdGhtaWM6IHkgPSBhICsgYipsbih4KQogICAgLy8gRmlsdGVyIG91dCBub24tcG9zaXRpdmUgeCB2YWx1ZXMKICAgIGNvbnN0IHZhbGlkSW5kaWNlcyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB4Lmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh4W2ldID4gMCkgewogICAgICAgIHZhbGlkSW5kaWNlcy5wdXNoKGkpOwogICAgICB9CiAgICB9CiAgICAKICAgIGlmICh2YWxpZEluZGljZXMubGVuZ3RoIDwgMikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIAogICAgY29uc3QgbG9nWCA9IHZhbGlkSW5kaWNlcy5tYXAoaSA9PiBNYXRoLmxvZyh4W2ldKSk7CiAgICBjb25zdCB2YWxpZFkgPSB2YWxpZEluZGljZXMubWFwKGkgPT4geVtpXSk7CiAgICBjb25zdCBuID0gdmFsaWRJbmRpY2VzLmxlbmd0aDsKICAgIAogICAgY29uc3Qgc3VtTG9nWCA9IGxvZ1gucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgICBjb25zdCBzdW1ZID0gdmFsaWRZLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApOwogICAgY29uc3Qgc3VtTG9nWFkgPSBsb2dYLnJlZHVjZSgoc3VtLCBseGksIGkpID0+IHN1bSArIGx4aSAqIHZhbGlkWVtpXSwgMCk7CiAgICBjb25zdCBzdW1Mb2dYMiA9IGxvZ1gucmVkdWNlKChzdW0sIGx4aSkgPT4gc3VtICsgbHhpICogbHhpLCAwKTsKICAgIAogICAgY29uc3QgZGV0ID0gbiAqIHN1bUxvZ1gyIC0gc3VtTG9nWCAqIHN1bUxvZ1g7CiAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTEwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgCiAgICBjb25zdCBhID0gKHN1bVkgKiBzdW1Mb2dYMiAtIHN1bUxvZ1ggKiBzdW1Mb2dYWSkgLyBkZXQ7CiAgICBjb25zdCBiID0gKG4gKiBzdW1Mb2dYWSAtIHN1bUxvZ1ggKiBzdW1ZKSAvIGRldDsKICAgIAogICAgZml0RnVuY3Rpb24gPSAodCkgPT4gdCA+IDAgPyBhICsgYiAqIE1hdGgubG9nKHQpIDogbnVsbDsKICB9IGVsc2UgaWYgKHJlZ3Jlc3Npb25UeXBlID09PSAnbW9uby1leHBvbmVudGlhbCcpIHsKICAgIC8vIE1vbm8tZXhwb25lbnRpYWwgcmlzZSB0byBwbGF0ZWF1OiB5KHQpID0gMSArIEEoMSAtIGVeKC1rKHQgLSB04oKAKSkpCiAgICAvLyBGb3Igbm9ybWFsaXplZCBkYXRhLCBiYXNlbGluZSDiiYggMSwgc28gd2UgZml4IHTigoAgPSAwIChvciBmaXJzdCB0aW1lcG9pbnQpCiAgICAvLyB5KHQpID0gMSArIEEoMSAtIGVeKC1rKnQpKQogICAgCiAgICAvLyBGaW5kIHTigoAgYXMgdGhlIGZpcnN0IHRpbWVwb2ludCAob3IgMCBpZiBkYXRhIHN0YXJ0cyBhdCAwKQogICAgY29uc3QgdDAgPSBNYXRoLm1pbiguLi54KTsKICAgIGNvbnN0IHhTaGlmdGVkID0geC5tYXAoeGkgPT4geGkgLSB0MCk7CiAgICAKICAgIC8vIEluaXRpYWwgcGFyYW1ldGVyIGVzdGltYXRlcwogICAgLy8gQTogYW1wbGl0dWRlID0gbWF4KHkpIC0gMSAoc2luY2UgYmFzZWxpbmUgaXMgbm9ybWFsaXplZCB0byAxKQogICAgY29uc3QgeU1heCA9IE1hdGgubWF4KC4uLnkpOwogICAgY29uc3QgeU1pbiA9IE1hdGgubWluKC4uLnkpOwogICAgbGV0IEEgPSBNYXRoLm1heCgwLCB5TWF4IC0gMSk7IC8vIEFtcGxpdHVkZSBzaG91bGQgYmUgcG9zaXRpdmUKICAgIAogICAgLy8gazogcmF0ZSBjb25zdGFudCAtIGVzdGltYXRlIGZyb20gcmlzZSB0aW1lCiAgICAvLyBGaW5kIHRpbWVwb2ludCB3aGVyZSBzaWduYWwgcmVhY2hlcyB+NjMlJSBvZiBhbXBsaXR1ZGUgKDEgLSAxL2Ug4omIIDAuNjMyKQogICAgY29uc3QgdGltZVNwYW4gPSBNYXRoLm1heCguLi54U2hpZnRlZCkgLSBNYXRoLm1pbiguLi54U2hpZnRlZCk7CiAgICBjb25zdCB0YXJnZXRZID0gMSArIEEgKiAwLjYzMjsKICAgIGxldCBrID0gMC4wMTsgLy8gRGVmYXVsdCBpbml0aWFsIGd1ZXNzCiAgICBpZiAoQSA+IDAuMDEgJiYgdGltZVNwYW4gPiAwKSB7CiAgICAgIC8vIEZpbmQgY2xvc2VzdCBwb2ludCB0byB0YXJnZXQKICAgICAgbGV0IGNsb3Nlc3RJZHggPSAwOwogICAgICBsZXQgbWluRGlmZiA9IE1hdGguYWJzKHlbMF0gLSB0YXJnZXRZKTsKICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCB5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgZGlmZiA9IE1hdGguYWJzKHlbaV0gLSB0YXJnZXRZKTsKICAgICAgICBpZiAoZGlmZiA8IG1pbkRpZmYpIHsKICAgICAgICAgIG1pbkRpZmYgPSBkaWZmOwogICAgICAgICAgY2xvc2VzdElkeCA9IGk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIEVzdGltYXRlIGsgZnJvbTogMSAtIGVeKC1rKnQpID0gMC42MzIgPT4gayDiiYggMS90CiAgICAgIGlmICh4U2hpZnRlZFtjbG9zZXN0SWR4XSA+IDApIHsKICAgICAgICBrID0gMSAvIHhTaGlmdGVkW2Nsb3Nlc3RJZHhdOwogICAgICAgIGsgPSBNYXRoLm1heCgxZS02LCBNYXRoLm1pbigxMCwgaykpOyAvLyBCb3VuZCBiZXR3ZWVuIDFlLTYgYW5kIDEwCiAgICAgIH0KICAgIH0KICAgIAogICAgLy8gVXNlIHNpbXBsZSBpdGVyYXRpdmUgbm9ubGluZWFyIGxlYXN0IHNxdWFyZXMgKEdhdXNzLU5ld3RvbikKICAgIC8vIE1pbmltaXplIHN1bSBvZiBzcXVhcmVkIHJlc2lkdWFsczogzqMoeSAtICgxICsgQSgxIC0gZV4oLWsqdCkpKSnCsgogICAgY29uc3QgbWF4SXRlcmF0aW9ucyA9IDEwMDsKICAgIGNvbnN0IHRvbGVyYW5jZSA9IDFlLTY7CiAgICAKICAgIGZvciAobGV0IGl0ZXIgPSAwOyBpdGVyIDwgbWF4SXRlcmF0aW9uczsgaXRlcisrKSB7CiAgICAgIC8vIENhbGN1bGF0ZSByZXNpZHVhbHMgYW5kIEphY29iaWFuCiAgICAgIGxldCBzdW1SZXNpZHVhbCA9IDA7CiAgICAgIGxldCBzdW1SZXNpZHVhbEEgPSAwOwogICAgICBsZXQgc3VtUmVzaWR1YWxLID0gMDsKICAgICAgbGV0IHN1bUpBQSA9IDA7CiAgICAgIGxldCBzdW1KQUsgPSAwOwogICAgICBsZXQgc3VtSktLID0gMDsKICAgICAgCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgeFNoaWZ0ZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB0ID0geFNoaWZ0ZWRbaV07CiAgICAgICAgY29uc3QgeU9icyA9IHlbaV07CiAgICAgICAgY29uc3QgeVByZWQgPSAxICsgQSAqICgxIC0gTWF0aC5leHAoLWsgKiB0KSk7CiAgICAgICAgY29uc3QgcmVzaWR1YWwgPSB5T2JzIC0geVByZWQ7CiAgICAgICAgCiAgICAgICAgLy8gUGFydGlhbCBkZXJpdmF0aXZlcwogICAgICAgIGNvbnN0IGRBID0gMSAtIE1hdGguZXhwKC1rICogdCk7CiAgICAgICAgY29uc3QgZEsgPSBBICogdCAqIE1hdGguZXhwKC1rICogdCk7CiAgICAgICAgCiAgICAgICAgc3VtUmVzaWR1YWwgKz0gcmVzaWR1YWw7CiAgICAgICAgc3VtUmVzaWR1YWxBICs9IHJlc2lkdWFsICogZEE7CiAgICAgICAgc3VtUmVzaWR1YWxLICs9IHJlc2lkdWFsICogZEs7CiAgICAgICAgc3VtSkFBICs9IGRBICogZEE7CiAgICAgICAgc3VtSkFLICs9IGRBICogZEs7CiAgICAgICAgc3VtSktLICs9IGRLICogZEs7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIFNvbHZlIG5vcm1hbCBlcXVhdGlvbnM6IEpeVCAqIEogKiBkZWx0YSA9IEpeVCAqIHJlc2lkdWFsCiAgICAgIGNvbnN0IGRldCA9IHN1bUpBQSAqIHN1bUpLSyAtIHN1bUpBSyAqIHN1bUpBSzsKICAgICAgaWYgKE1hdGguYWJzKGRldCkgPCAxZS0xMCkgYnJlYWs7CiAgICAgIAogICAgICBjb25zdCBkZWx0YUEgPSAoc3VtUmVzaWR1YWxBICogc3VtSktLIC0gc3VtUmVzaWR1YWxLICogc3VtSkFLKSAvIGRldDsKICAgICAgY29uc3QgZGVsdGFLID0gKHN1bVJlc2lkdWFsSyAqIHN1bUpBQSAtIHN1bVJlc2lkdWFsQSAqIHN1bUpBSykgLyBkZXQ7CiAgICAgIAogICAgICAvLyBVcGRhdGUgcGFyYW1ldGVycyB3aXRoIGRhbXBpbmcKICAgICAgY29uc3QgZGFtcGluZyA9IDAuNTsKICAgICAgQSA9IE1hdGgubWF4KDAsIEEgKyBkYW1waW5nICogZGVsdGFBKTsKICAgICAgayA9IE1hdGgubWF4KDFlLTYsIE1hdGgubWluKDEwLCBrICsgZGFtcGluZyAqIGRlbHRhSykpOwogICAgICAKICAgICAgLy8gSWYgcGFyYW1ldGVycyBkaWRuJ3QgY2hhbmdlIG11Y2gsIHdlJ3JlIGRvbmUKICAgICAgaWYgKE1hdGguYWJzKGRlbHRhQSkgPCB0b2xlcmFuY2UgJiYgTWF0aC5hYnMoZGVsdGFLKSA8IHRvbGVyYW5jZSkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICAKICAgIC8vIFN0b3JlIHBhcmFtZXRlcnMgZm9yIGluZm8gcGFuZWwKICAgIGNvbnN0IHRhdSA9IDEgLyBrOyAvLyB0aW1lIGNvbnN0YW50CiAgICBjb25zdCB0SGFsZiA9IE1hdGgubG9nKDIpIC8gazsgLy8gaGFsZi10aW1lCiAgICBjb25zdCBwbGF0ZWF1ID0gMSArIEE7IC8vIHBsYXRlYXUgdmFsdWUKICAgIAogICAgLy8gQ3JlYXRlIGZpdCBmdW5jdGlvbgogICAgZml0RnVuY3Rpb24gPSAodCkgPT4gewogICAgICBjb25zdCB0U2hpZnRlZCA9IHQgLSB0MDsKICAgICAgaWYgKHRTaGlmdGVkIDwgMCkgcmV0dXJuIDE7IC8vIEJlZm9yZSBhY3RpdmF0aW9uCiAgICAgIHJldHVybiAxICsgQSAqICgxIC0gTWF0aC5leHAoLWsgKiB0U2hpZnRlZCkpOwogICAgfTsKICAgIAogICAgLy8gQXR0YWNoIHBhcmFtZXRlcnMgdG8gZnVuY3Rpb24gZm9yIGluZm8gcGFuZWwKICAgIGZpdEZ1bmN0aW9uLnBhcmFtcyA9IHsKICAgICAgQTogQSwKICAgICAgazogaywKICAgICAgdDA6IHQwLAogICAgICB0YXU6IHRhdSwKICAgICAgdEhhbGY6IHRIYWxmLAogICAgICBwbGF0ZWF1OiBwbGF0ZWF1CiAgICB9OwogIH0gZWxzZSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgCiAgcmV0dXJuIGZpdEZ1bmN0aW9uOwp9CgpmdW5jdGlvbiBub3JtYWxpemVNZWFuQW5kRXJyb3IodGltZVBvaW50cywgbWVhbnMsIGVycm9ycywgYmFzZWxpbmVFbmRUaW1lID0gMjQsIGN1dG9mZlRpbWUgPSAzNjApIHsKICAvLyBOb3JtYWxpemUgbWVhbiBhbmQgZXJyb3IgZGF0YTogY2FsY3VsYXRlIGJhc2VsaW5lIGZyb20gMC1iYXNlbGluZUVuZFRpbWUsIHRoZW4gcGxvdCBvbmx5IHBvaW50cyBhZnRlciBiYXNlbGluZUVuZFRpbWUKICAvLyBkaXZpZGVkIGJ5IGJhc2VsaW5lLCB1cCB0byBjdXRvZmZUaW1lLiBCYXNlbGluZSBwZXJpb2QgaXMgTk9UIGluY2x1ZGVkIGluIHRoZSBwbG90LgogIC8vIFJldHVybnMgeyBmaWx0ZXJlZFRpbWVQb2ludHMsIG5vcm1hbGl6ZWRNZWFucywgbm9ybWFsaXplZEVycm9ycyB9IC0gZmlsdGVyZWQgYXJyYXlzCiAgLy8gRmlyc3QgY2FsY3VsYXRlIGJhc2VsaW5lIGZyb20gbWVhbnMKICBjb25zdCBiYXNlbGluZVZhbHVlcyA9IFtdOwogIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZVBvaW50cy5sZW5ndGg7IGkrKykgewogICAgaWYgKHRpbWVQb2ludHNbaV0gIT09IG51bGwgJiYgbWVhbnNbaV0gIT09IG51bGwgJiYgdGltZVBvaW50c1tpXSA8PSBiYXNlbGluZUVuZFRpbWUpIHsKICAgICAgYmFzZWxpbmVWYWx1ZXMucHVzaChtZWFuc1tpXSk7CiAgICB9CiAgfQogIAogIGlmIChiYXNlbGluZVZhbHVlcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB7IGZpbHRlcmVkVGltZVBvaW50czogdGltZVBvaW50cywgbm9ybWFsaXplZE1lYW5zOiBtZWFucywgbm9ybWFsaXplZEVycm9yczogZXJyb3JzIH07CiAgfQogIAogIGNvbnN0IGJhc2VsaW5lID0gYmFzZWxpbmVWYWx1ZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyBiYXNlbGluZVZhbHVlcy5sZW5ndGg7CiAgCiAgaWYgKGJhc2VsaW5lID09PSAwKSB7CiAgICByZXR1cm4geyBmaWx0ZXJlZFRpbWVQb2ludHM6IHRpbWVQb2ludHMsIG5vcm1hbGl6ZWRNZWFuczogbWVhbnMsIG5vcm1hbGl6ZWRFcnJvcnM6IGVycm9ycyB9OwogIH0KICAKICAvLyBGaWx0ZXIgYW5kIG5vcm1hbGl6ZTogb25seSBpbmNsdWRlIHBvaW50cyB3aGVyZSBiYXNlbGluZUVuZFRpbWUgPCB0aW1lIDw9IGN1dG9mZlRpbWUKICBjb25zdCBmaWx0ZXJlZFRpbWVQb2ludHMgPSBbXTsKICBjb25zdCBub3JtYWxpemVkTWVhbnMgPSBbXTsKICBjb25zdCBub3JtYWxpemVkRXJyb3JzID0gW107CiAgCiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aW1lUG9pbnRzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCB0aW1lID0gdGltZVBvaW50c1tpXTsKICAgIGNvbnN0IG1lYW4gPSBtZWFuc1tpXTsKICAgIGNvbnN0IGVycm9yID0gZXJyb3JzW2ldOwogICAgCiAgICBpZiAodGltZSA9PT0gbnVsbCB8fCBtZWFuID09PSBudWxsKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQogICAgCiAgICAvLyBPbmx5IGluY2x1ZGUgcG9pbnRzIGFmdGVyIGJhc2VsaW5lRW5kVGltZSBhbmQgdXAgdG8gY3V0b2ZmVGltZSAoYmFzZWxpbmUgTk9UIGluY2x1ZGVkKQogICAgaWYgKHRpbWUgPiBiYXNlbGluZUVuZFRpbWUgJiYgdGltZSA8PSBjdXRvZmZUaW1lKSB7CiAgICAgIC8vIFN1YnRyYWN0IGJhc2VsaW5lRW5kVGltZSB0byBicmluZyBmaXJzdCBwb2ludCB0byB4PTAgKHRpbWUgYWZ0ZXIgaW5qZWN0aW9uKQogICAgICBmaWx0ZXJlZFRpbWVQb2ludHMucHVzaCh0aW1lIC0gYmFzZWxpbmVFbmRUaW1lKTsKICAgICAgbm9ybWFsaXplZE1lYW5zLnB1c2gobWVhbiAvIGJhc2VsaW5lKTsKICAgICAgLy8gRXJyb3JzIHNjYWxlIHByb3BvcnRpb25hbGx5CiAgICAgIG5vcm1hbGl6ZWRFcnJvcnMucHVzaChlcnJvciAhPT0gbnVsbCA/IGVycm9yIC8gYmFzZWxpbmUgOiBudWxsKTsKICAgIH0KICB9CiAgCiAgcmV0dXJuIHsgZmlsdGVyZWRUaW1lUG9pbnRzLCBub3JtYWxpemVkTWVhbnMsIG5vcm1hbGl6ZWRFcnJvcnMgfTsKfQoKZnVuY3Rpb24gdXBkYXRlQ2hhcnQoKSB7CiAgLy8gR3VhcmQ6IGVuc3VyZSB2aWV3ZXJEYXRhIGlzIGxvYWRlZAogIGlmICghdmlld2VyRGF0YSB8fCAhYWxsV2VsbHNEYXRhIHx8IE9iamVjdC5rZXlzKGFsbFdlbGxzRGF0YSkubGVuZ3RoID09PSAwKSB7CiAgICBjb25zb2xlLndhcm4oInZpZXdlckRhdGEgbm90IGxvYWRlZCB5ZXQsIHNraXBwaW5nIGNoYXJ0IHVwZGF0ZSIpOwogICAgcmV0dXJuOwogIH0KICAKICBjb25zdCBjdHggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgid2VsbC1jaGFydCIpLmdldENvbnRleHQoIjJkIik7CgogIC8vIFNURVAgMTogQ2hlY2sgaWYgbm9ybWFsaXphdGlvbiB1c2luZyBmaXR0ZWQgYmFzZWxpbmUgaXMgZW5hYmxlZCAobXVzdCBiZSBmaXJzdCkKICBjb25zdCBub3JtYWxpemVCYXNlbGluZVRvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJub3JtYWxpemUtYmFzZWxpbmUtdG9nZ2xlIik7CiAgY29uc3Qgbm9ybWFsaXplQmFzZWxpbmUgPSBub3JtYWxpemVCYXNlbGluZVRvZ2dsZSA/IG5vcm1hbGl6ZUJhc2VsaW5lVG9nZ2xlLmNoZWNrZWQgOiBmYWxzZTsKICAKICAvLyBTVEVQIDI6IENoZWNrIGlmIHRyaXBsaWNhdGUgZ3JvdXBpbmcgaXMgZW5hYmxlZCAocmVxdWlyZXMgU3RlcCAxKQogIGNvbnN0IGdyb3VwVHJpcGxpY2F0ZXNUb2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZ3JvdXAtdHJpcGxpY2F0ZXMtdG9nZ2xlIik7CiAgY29uc3QgZ3JvdXBUcmlwbGljYXRlcyA9IGdyb3VwVHJpcGxpY2F0ZXNUb2dnbGUgPyBncm91cFRyaXBsaWNhdGVzVG9nZ2xlLmNoZWNrZWQgOiBmYWxzZTsKICAKICAvLyBFbmZvcmNlIHdvcmtmbG93OiBTdGVwIDIgKGdyb3VwaW5nKSByZXF1aXJlcyBTdGVwIDEgKG5vcm1hbGl6YXRpb24pCiAgaWYgKGdyb3VwVHJpcGxpY2F0ZXMgJiYgIW5vcm1hbGl6ZUJhc2VsaW5lKSB7CiAgICAvLyBEaXNhYmxlIGdyb3VwaW5nIGlmIG5vcm1hbGl6YXRpb24gaXMgbm90IGVuYWJsZWQKICAgIGlmIChncm91cFRyaXBsaWNhdGVzVG9nZ2xlKSB7CiAgICAgIGdyb3VwVHJpcGxpY2F0ZXNUb2dnbGUuY2hlY2tlZCA9IGZhbHNlOwogICAgfQogICAgZ3JvdXBUcmlwbGljYXRlcyA9IGZhbHNlOwogIH0KICAKICAvLyBTVEVQIDA6IENoZWNrIGlmIGluZGl2aWR1YWwgd2VsbHMgc2hvdWxkIGJlIHNob3duCiAgLy8gU3RlcCAwIG9ubHkgc2hvd3Mgd2hlbiBOTyBvdGhlciBwcm9jZXNzaW5nIHN0ZXBzICgxLTIpIGFyZSBlbmFibGVkCiAgY29uc3Qgc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzaG93LWluZGl2aWR1YWwtd2VsbHMtdG9nZ2xlIik7CiAgY29uc3Qgc3RlcDBSZXF1ZXN0ZWQgPSBzaG93SW5kaXZpZHVhbFdlbGxzVG9nZ2xlID8gc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZS5jaGVja2VkIDogdHJ1ZTsKICBjb25zdCBhbnlQcm9jZXNzaW5nU3RlcEVuYWJsZWQgPSBub3JtYWxpemVCYXNlbGluZSB8fCBncm91cFRyaXBsaWNhdGVzOwogIC8vIFNob3cgU3RlcCAwIGlmIHJlcXVlc3RlZCBBTkQgbm8gb3RoZXIgc3RlcHMgZW5hYmxlZAogIC8vIElmIG5vIHN0ZXBzIGFyZSBlbmFibGVkIGF0IGFsbCwgZGVmYXVsdCB0byBzaG93aW5nIFN0ZXAgMCAocmF3IGRhdGEpIGFzIGZhbGxiYWNrCiAgY29uc3Qgc2hvd0luZGl2aWR1YWxXZWxscyA9IChzdGVwMFJlcXVlc3RlZCAmJiAhYW55UHJvY2Vzc2luZ1N0ZXBFbmFibGVkKSB8fCAoIWFueVByb2Nlc3NpbmdTdGVwRW5hYmxlZCk7CiAgCiAgLy8gU2hvdy9oaWRlIFN0ZXAgMCB3YXJuaW5nCiAgY29uc3Qgc3RlcDBXYXJuaW5nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInN0ZXAwLXdhcm5pbmciKTsKICBpZiAoc3RlcDBXYXJuaW5nKSB7CiAgICBzdGVwMFdhcm5pbmcuc3R5bGUuZGlzcGxheSA9IChzdGVwMFJlcXVlc3RlZCAmJiBhbnlQcm9jZXNzaW5nU3RlcEVuYWJsZWQpID8gImJsb2NrIiA6ICJub25lIjsKICB9CiAgCiAgLy8gRGlzYWJsZSBTdGVwIDAgY2hlY2tib3ggaWYgb3RoZXIgc3RlcHMgKDEtMikgYXJlIGVuYWJsZWQgKHZpc3VhbCBmZWVkYmFjaykKICBpZiAoc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZSkgewogICAgc2hvd0luZGl2aWR1YWxXZWxsc1RvZ2dsZS5kaXNhYmxlZCA9IGFueVByb2Nlc3NpbmdTdGVwRW5hYmxlZDsKICB9CiAgCiAgLy8gR2V0IG5vcm1hbGl6YXRpb24gYmFzZWxpbmUgcGFyYW1ldGVycwogIGNvbnN0IG5vcm1hbGl6ZUJhc2VsaW5lRW5kSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibm9ybWFsaXplLWJhc2VsaW5lLWVuZC10aW1lIik7CiAgY29uc3Qgbm9ybWFsaXplQmFzZWxpbmVFbmRUaW1lID0gbm9ybWFsaXplQmFzZWxpbmVFbmRJbnB1dCA/IHBhcnNlRmxvYXQobm9ybWFsaXplQmFzZWxpbmVFbmRJbnB1dC52YWx1ZSkgfHwgMjQgOiAyNDsKICAKICAvLyBHZXQgYmFzZWxpbmUgZml0dGluZyBtZXRob2QgYW5kIHBhcmFtZXRlcnMKICBjb25zdCBiYXNlbGluZU1ldGhvZFNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJiYXNlbGluZS1tZXRob2Qtc2VsZWN0Iik7CiAgY29uc3QgYmFzZWxpbmVNZXRob2QgPSBiYXNlbGluZU1ldGhvZFNlbGVjdCA/IGJhc2VsaW5lTWV0aG9kU2VsZWN0LnZhbHVlIDogImxvd2VzcyI7CiAgY29uc3QgYmFzZWxpbmVGcmFjSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtZnJhYy1pbnB1dCIpOwogIGNvbnN0IGJhc2VsaW5lRnJhYyA9IGJhc2VsaW5lRnJhY0lucHV0ID8gcGFyc2VGbG9hdChiYXNlbGluZUZyYWNJbnB1dC52YWx1ZSkgfHwgMC41IDogMC41OwogIGNvbnN0IGJhc2VsaW5lUG9seU9yZGVySW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYmFzZWxpbmUtcG9seS1vcmRlci1pbnB1dCIpOwogIGNvbnN0IGJhc2VsaW5lUG9seU9yZGVyID0gYmFzZWxpbmVQb2x5T3JkZXJJbnB1dCA/IHBhcnNlSW50KGJhc2VsaW5lUG9seU9yZGVySW5wdXQudmFsdWUpIHx8IDEgOiAxOwogIAogIC8vIEdldCBub3JtYWxpemF0aW9uIG1vZGUKICBjb25zdCBub3JtYWxpemF0aW9uTW9kZVNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJub3JtYWxpemF0aW9uLW1vZGUtc2VsZWN0Iik7CiAgY29uc3Qgbm9ybWFsaXphdGlvbk1vZGUgPSBub3JtYWxpemF0aW9uTW9kZVNlbGVjdCA/IG5vcm1hbGl6YXRpb25Nb2RlU2VsZWN0LnZhbHVlIDogImRlbHRhX2Zfb3Zlcl9mIjsKICAKICAvLyBTaG93L2hpZGUgbm9ybWFsaXphdGlvbiBiYXNlbGluZSBwYXJhbWV0ZXJzCiAgY29uc3Qgbm9ybWFsaXplQmFzZWxpbmVQYXJhbWV0ZXJzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm5vcm1hbGl6ZS1iYXNlbGluZS1wYXJhbWV0ZXJzIik7CiAgaWYgKG5vcm1hbGl6ZUJhc2VsaW5lUGFyYW1ldGVyc0RpdiAmJiBub3JtYWxpemVCYXNlbGluZVRvZ2dsZSkgewogICAgbm9ybWFsaXplQmFzZWxpbmVQYXJhbWV0ZXJzRGl2LnN0eWxlLmRpc3BsYXkgPSBub3JtYWxpemVCYXNlbGluZSA/ICJibG9jayIgOiAibm9uZSI7CiAgfQogIAogIC8vIFNURVAgMzogQ2hlY2sgaWYgY3V0b2ZmIGlzIGVuYWJsZWQKICBjb25zdCBjdXRvZmZCYXNlbGluZVRvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXRvZmYtYmFzZWxpbmUtdG9nZ2xlIik7CiAgY29uc3QgY3V0b2ZmQmFzZWxpbmUgPSBjdXRvZmZCYXNlbGluZVRvZ2dsZSA/IGN1dG9mZkJhc2VsaW5lVG9nZ2xlLmNoZWNrZWQgOiBmYWxzZTsKICBjb25zdCBjdXRvZmZCYXNlbGluZVRpbWVJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXRvZmYtYmFzZWxpbmUtdGltZSIpOwogIGNvbnN0IGN1dG9mZkJhc2VsaW5lVGltZSA9IGN1dG9mZkJhc2VsaW5lVGltZUlucHV0ID8gcGFyc2VGbG9hdChjdXRvZmZCYXNlbGluZVRpbWVJbnB1dC52YWx1ZSkgfHwgMzYwIDogMzYwOwogIAogIC8vIFNob3cvaGlkZSBjdXRvZmYgcGFyYW1ldGVycwogIGNvbnN0IGN1dG9mZkJhc2VsaW5lUGFyYW1ldGVyc0RpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXRvZmYtYmFzZWxpbmUtcGFyYW1ldGVycyIpOwogIGlmIChjdXRvZmZCYXNlbGluZVBhcmFtZXRlcnNEaXYgJiYgY3V0b2ZmQmFzZWxpbmVUb2dnbGUpIHsKICAgIGN1dG9mZkJhc2VsaW5lUGFyYW1ldGVyc0Rpdi5zdHlsZS5kaXNwbGF5ID0gY3V0b2ZmQmFzZWxpbmUgPyAiYmxvY2siIDogIm5vbmUiOwogIH0KICAKICAvLyBTVEVQIDQ6IENoZWNrIGlmIHJlZ3Jlc3Npb24gaXMgZW5hYmxlZAogIGNvbnN0IGZpdFJlZ3Jlc3Npb25Ub2dnbGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZml0LXJlZ3Jlc3Npb24tdG9nZ2xlIik7CiAgY29uc3QgZml0UmVncmVzc2lvbiA9IGZpdFJlZ3Jlc3Npb25Ub2dnbGUgPyBmaXRSZWdyZXNzaW9uVG9nZ2xlLmNoZWNrZWQgOiBmYWxzZTsKICBjb25zdCByZWdyZXNzaW9uVHlwZVNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZWdyZXNzaW9uLXR5cGUtc2VsZWN0Iik7CiAgY29uc3QgcmVncmVzc2lvblR5cGUgPSByZWdyZXNzaW9uVHlwZVNlbGVjdCA/IHJlZ3Jlc3Npb25UeXBlU2VsZWN0LnZhbHVlIDogIm1vbm8tZXhwb25lbnRpYWwiOwogIGNvbnN0IHBvbHlub21pYWxPcmRlcklucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInBvbHlub21pYWwtb3JkZXItaW5wdXQiKTsKICBjb25zdCBwb2x5bm9taWFsT3JkZXIgPSBwb2x5bm9taWFsT3JkZXJJbnB1dCA/IHBhcnNlSW50KHBvbHlub21pYWxPcmRlcklucHV0LnZhbHVlKSB8fCAyIDogMjsKICAKICAvLyBTaG93L2hpZGUgcmVncmVzc2lvbiBwYXJhbWV0ZXJzCiAgY29uc3QgZml0UmVncmVzc2lvblBhcmFtZXRlcnNEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZml0LXJlZ3Jlc3Npb24tcGFyYW1ldGVycyIpOwogIGlmIChmaXRSZWdyZXNzaW9uUGFyYW1ldGVyc0RpdiAmJiBmaXRSZWdyZXNzaW9uVG9nZ2xlKSB7CiAgICBmaXRSZWdyZXNzaW9uUGFyYW1ldGVyc0Rpdi5zdHlsZS5kaXNwbGF5ID0gZml0UmVncmVzc2lvbiA/ICJibG9jayIgOiAibm9uZSI7CiAgfQogIAogIC8vIFVwZGF0ZSByZWdyZXNzaW9uIHR5cGUgcGFyYW1zIHRvIHNob3cvaGlkZSBpbmZvIHBhbmVsIHdoZW4gcmVncmVzc2lvbiBpcyB0b2dnbGVkCiAgaWYgKGZpdFJlZ3Jlc3Npb24pIHsKICAgIHVwZGF0ZVJlZ3Jlc3Npb25UeXBlUGFyYW1zKHRydWUpOyAvLyBTa2lwIGNoYXJ0IHVwZGF0ZSBzaW5jZSB3ZSdyZSBhbHJlYWR5IHVwZGF0aW5nCiAgfSBlbHNlIHsKICAgIC8vIEhpZGUgaW5mbyBwYW5lbCB3aGVuIHJlZ3Jlc3Npb24gaXMgZGlzYWJsZWQKICAgIGNvbnN0IGluZm9QYW5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyZWdyZXNzaW9uLWluZm8tcGFuZWwiKTsKICAgIGlmIChpbmZvUGFuZWwpIHsKICAgICAgaW5mb1BhbmVsLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICB9CiAgfQoKICBpZiAoc2VsZWN0ZWRXZWxscy5zaXplID09PSAwKSB7CiAgICAvLyBDbGVhciB0aGUgY2hhcnQgaWYgbm8gd2VsbHMgc2VsZWN0ZWQKICAgIC8vIERldGVybWluZSB5LWF4aXMgbGFiZWwgYmFzZWQgb24gcHJvY2Vzc2luZyBzdGVwcwogICAgbGV0IHlBeGlzTGFiZWwgPSAiRmx1b3Jlc2NlbmNlIChGSSkiOwogICAgaWYgKG5vcm1hbGl6ZUJhc2VsaW5lKSB7CiAgICAgIGlmIChub3JtYWxpemF0aW9uTW9kZSA9PT0gJ2RlbHRhX2Zfb3Zlcl9mJykgewogICAgICAgIHlBeGlzTGFiZWwgPSAizpRGL0YgKE5vcm1hbGl6ZWQpIjsKICAgICAgfSBlbHNlIHsKICAgICAgICB5QXhpc0xhYmVsID0gIkYvRuKCgCAoTm9ybWFsaXplZCkiOwogICAgICB9CiAgICB9CiAgICBpZiAoY2hhcnQpIHsKICAgICAgLy8gVHJhbnNmb3JtIGV4aXN0aW5nIGNoYXJ0CiAgICAgIGNoYXJ0LmRhdGEuZGF0YXNldHMgPSBbXTsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueC50aXRsZS50ZXh0ID0gIlRpbWUgKHMpIjsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueS50aXRsZS50ZXh0ID0geUF4aXNMYWJlbDsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueS5taW4gPSB1bmRlZmluZWQ7CiAgICAgIGNoYXJ0Lm9wdGlvbnMucGx1Z2lucy50aXRsZS50ZXh0ID0gIlNlbGVjdCB3ZWxscyB0byBkaXNwbGF5IGRhdGEiOwogICAgICBjaGFydC51cGRhdGUoJ25vbmUnKTsgLy8gVXBkYXRlIHdpdGhvdXQgYW5pbWF0aW9uCiAgICB9IGVsc2UgewogICAgICAvLyBDcmVhdGUgbmV3IGNoYXJ0IG9ubHkgaWYgaXQgZG9lc24ndCBleGlzdAogICAgICBjaGFydCA9IG5ldyBDaGFydChjdHgsIHsKICAgICAgICB0eXBlOiAibGluZSIsCiAgICAgICAgZGF0YTogeyBkYXRhc2V0czogW10gfSwKICAgICAgICBvcHRpb25zOiB7CiAgICAgICAgICByZXNwb25zaXZlOiB0cnVlLAogICAgICAgICAgbWFpbnRhaW5Bc3BlY3RSYXRpbzogZmFsc2UsCiAgICAgICAgICBzY2FsZXM6IHsKICAgICAgICAgICAgeDogeyAKICAgICAgICAgICAgICB0eXBlOiAibGluZWFyIiwgCiAgICAgICAgICAgICAgdGl0bGU6IHsgZGlzcGxheTogdHJ1ZSwgdGV4dDogIlRpbWUgKHMpIiB9IAogICAgICAgICAgICB9LAogICAgICAgICAgICB5OiB7IAogICAgICAgICAgICAgIHRpdGxlOiB7IGRpc3BsYXk6IHRydWUsIHRleHQ6IHlBeGlzTGFiZWwgfSwKICAgICAgICAgICAgICBtaW46IHVuZGVmaW5lZAogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgcGx1Z2luczogewogICAgICAgICAgICBsZWdlbmQ6IHsgZGlzcGxheTogZmFsc2UgfSwKICAgICAgICAgICAgdGl0bGU6IHsgZGlzcGxheTogdHJ1ZSwgdGV4dDogIlNlbGVjdCB3ZWxscyB0byBkaXNwbGF5IGRhdGEiIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuOwogIH0KCiAgY29uc3QgZGF0YXNldHMgPSBbXTsKICBjb25zdCBjb2xvcnMgPSBbCiAgICAicmdiYSg1NCwgMTYyLCAyMzUsIDEuMCkiLAogICAgInJnYmEoMjU1LCA5OSwgMTMyLCAxLjApIiwKICAgICJyZ2JhKDI1NSwgMjA2LCA4NiwgMS4wKSIsCiAgICAicmdiYSg3NSwgMTkyLCAxOTIsIDEuMCkiLAogICAgInJnYmEoMTUzLCAxMDIsIDI1NSwgMS4wKSIsCiAgICAicmdiYSgyNTUsIDE1OSwgNjQsIDEuMCkiLAogICAgInJnYmEoMTk5LCAxOTksIDE5OSwgMS4wKSIsCiAgICAicmdiYSg4MywgMTAyLCAyNTUsIDEuMCkiCiAgXTsKICAKICBsZXQgY29sb3JJZHggPSAwOwogIAogIC8vIFNURVAgMDogQWRkIGluZGl2aWR1YWwgd2VsbHMgKHJhdyBkYXRhLCBiZWZvcmUgYW55IHByb2Nlc3NpbmcpIGlmIGVuYWJsZWQKICBpZiAoc2hvd0luZGl2aWR1YWxXZWxscykgewogICAgQXJyYXkuZnJvbShzZWxlY3RlZFdlbGxzKS5mb3JFYWNoKGtleSA9PiB7CiAgICAgIGNvbnN0IFtwbGF0ZUlkLCB3ZWxsSWRdID0ga2V5LnNwbGl0KCI6Iik7CiAgICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgICAgCiAgICAgIC8vIEZpbHRlciBieSBlbmFibGVkQ29sdW1ucyBpZiBhbnkgYXJlIHNldAogICAgICBpZiAoZW5hYmxlZENvbHVtbnMuc2l6ZSA+IDAgJiYgIWVuYWJsZWRDb2x1bW5zLmhhcyhjb2x1bW4pKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIAogICAgICAvLyBGaWx0ZXIgYnkgZW5hYmxlZFdlbGxzIGlmIGFueSBhcmUgc2V0CiAgICAgIGlmIChlbmFibGVkV2VsbHMuc2l6ZSA+IDAgJiYgIWVuYWJsZWRXZWxscy5oYXMod2VsbElkKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAKICAgICAgaWYgKGFsbFdlbGxzRGF0YVtwbGF0ZUlkXSAmJiBhbGxXZWxsc0RhdGFbcGxhdGVJZF1bd2VsbElkXSkgewogICAgICAgIGNvbnN0IHdlbGxEYXRhID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdW3dlbGxJZF07CiAgICAgICAgY29uc3QgcGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gcGxhdGVJZCk7CiAgICAgICAgY29uc3QgZmlsZW5hbWUgPSBwbGF0ZSA/IChwbGF0ZS5maWxlIHx8IHBsYXRlLmlkKSA6IHBsYXRlSWQ7CiAgICAgICAgY29uc3QgY29uZmlnID0gdmlld2VyRGF0YS5jb25maWcgfHwge307CiAgICAgICAgY29uc3Qgd2VsbExhYmVscyA9IGNvbmZpZy53ZWxsX2xhYmVscyB8fCB7fTsKICAgICAgICBjb25zdCByb3dMZXR0ZXIgPSBnZXRSb3dMZXR0ZXIod2VsbElkKTsKICAgICAgICBjb25zdCBpc0NvbnRyb2wgPSBpc0NvbnRyb2xXZWxsKHdlbGxJZCk7CiAgICAgICAgY29uc3QgbGFiZWwgPSB3ZWxsTGFiZWxzW3Jvd0xldHRlcl0gfHwgd2VsbERhdGEubGFiZWwgfHwgd2VsbERhdGEuY29udGVudCB8fCBgV2VsbCAke3dlbGxJZH1gOwogICAgICAgIGNvbnN0IGZvcm1hdHRlZExhYmVsID0gZm9ybWF0TGFiZWwobGFiZWwpOwogICAgICAgIAogICAgICAgIC8vIFVzZSByYXcgZGF0YSAobm90IHByb2Nlc3NlZCkgZm9yIFN0ZXAgMAogICAgICAgIGNvbnN0IGNvbG9yID0gY29sb3JzW2NvbG9ySWR4ICUlIGNvbG9ycy5sZW5ndGhdOwogICAgICAgIGNvbG9ySWR4Kys7CiAgICAgICAgCiAgICAgICAgLy8gQWRkICJDb250cm9sIiBzdWZmaXggZm9yIGNvbnRyb2wgd2VsbHMKICAgICAgICBjb25zdCBkaXNwbGF5TGFiZWwgPSBpc0NvbnRyb2wgCiAgICAgICAgICA/IGAke3dlbGxJZH0gLSAke2Zvcm1hdHRlZExhYmVsfSBDb250cm9sIENvbCAke2NvbHVtbn1gCiAgICAgICAgICA6IGAke3dlbGxJZH0gLSAke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59YDsKICAgICAgICAKICAgICAgICBkYXRhc2V0cy5wdXNoKHsKICAgICAgICAgIGxhYmVsOiBkaXNwbGF5TGFiZWwsCiAgICAgICAgICBkYXRhOiB3ZWxsRGF0YS50aW1lX3MubWFwKCh0LCBpKSA9PiAoeyB4OiB0LCB5OiB3ZWxsRGF0YS52YWx1ZXNbaV0gfSkpLmZpbHRlcihkID0+IGQueSAhPT0gbnVsbCAmJiBkLnggIT09IG51bGwpLAogICAgICAgICAgYm9yZGVyQ29sb3I6IGNvbG9yLnJlcGxhY2UoIjEuMCIsICIwLjUiKSwgLy8gTGlnaHRlciBjb2xvciBmb3IgcmF3IGRhdGEKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogInRyYW5zcGFyZW50IiwKICAgICAgICAgIHRlbnNpb246IDAuMTUsCiAgICAgICAgICBwb2ludFJhZGl1czogMS41LAogICAgICAgICAgYm9yZGVyV2lkdGg6IDEsCiAgICAgICAgICBib3JkZXJEYXNoOiBbMywgM10sIC8vIERhc2hlZCBsaW5lIGZvciByYXcgZGF0YQogICAgICAgICAgZmlsbDogZmFsc2UKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfQogIAoKICAvLyBHcm91cCBzZWxlY3RlZCB3ZWxscyBieSB0cmlwbGljYXRlIGdyb3VwIG9yIGluZGl2aWR1YWwgd2VsbAogIGNvbnN0IGdyb3VwZWRTZWxlY3Rpb25zID0ge307CiAgY29uc3Qgc2VsZWN0ZWREYXRhc2V0cyA9IGdldFNlbGVjdGVkRGF0YXNldHMoKTsKICAKICAvLyBncm91cFRyaXBsaWNhdGVzIGFscmVhZHkgZGVmaW5lZCBhYm92ZQogIAogIC8vIEZpcnN0IHBhc3M6IGlkZW50aWZ5IGFsbCB0cmlwbGljYXRlIGdyb3VwcyBmcm9tIHNlbGVjdGVkIHdlbGxzCiAgLy8gT25seSBncm91cCBpbnRvIHRyaXBsaWNhdGVzIGlmIFN0ZXAgMiBpcyBlbmFibGVkCiAgY29uc3QgdHJpcGxpY2F0ZUdyb3Vwc0ZvdW5kID0gbmV3IE1hcCgpOyAvLyBncm91cEtleSAtPiB7IG5hbWUsIGNvbHVtbiwgd2VsbHM6IFNldCBvZiB3ZWxsSWRzIH0KICAKICBBcnJheS5mcm9tKHNlbGVjdGVkV2VsbHMpLmZvckVhY2goa2V5ID0+IHsKICAgIGNvbnN0IFtwbGF0ZUlkLCB3ZWxsSWRdID0ga2V5LnNwbGl0KCI6Iik7CiAgICBjb25zdCBjb2x1bW4gPSBnZXRDb2x1bW5Gcm9tV2VsbElkKHdlbGxJZCk7CiAgICAKICAgIC8vIEZpbHRlciBieSBlbmFibGVkQ29sdW1ucyBpZiBhbnkgYXJlIHNldAogICAgaWYgKGVuYWJsZWRDb2x1bW5zLnNpemUgPiAwICYmICFlbmFibGVkQ29sdW1ucy5oYXMoY29sdW1uKSkgewogICAgICByZXR1cm47IC8vIFNraXAgd2VsbHMgZnJvbSBkaXNhYmxlZCBjb2x1bW5zCiAgICB9CiAgICAKICAgIC8vIEZpbHRlciBieSBlbmFibGVkV2VsbHMgaWYgYW55IGFyZSBzZXQgKGV4Y2x1ZGUgd2VsbHMpCiAgICBpZiAoZW5hYmxlZFdlbGxzLnNpemUgPiAwICYmICFlbmFibGVkV2VsbHMuaGFzKHdlbGxJZCkpIHsKICAgICAgcmV0dXJuOyAvLyBTa2lwIGV4Y2x1ZGVkIHdlbGxzCiAgICB9CiAgICAKICAgIGNvbnN0IGlzQ29udHJvbCA9IGlzQ29udHJvbFdlbGwod2VsbElkKTsKICAgIAogICAgLy8gQ29udHJvbHMgYXJlIGFsd2F5cyBoYW5kbGVkIGFzIGluZGl2aWR1YWwgd2VsbHMgKG5vIGdyb3VwaW5nKQogICAgaWYgKGlzQ29udHJvbCkgewogICAgICByZXR1cm47IC8vIFNraXAgY29udHJvbHMgLSB0aGV5J2xsIGJlIGhhbmRsZWQgYXMgaW5kaXZpZHVhbCB3ZWxscyBpbiB0aGUgdGhpcmQgcGFzcwogICAgfQogICAgCiAgICAvLyBTVEVQIDI6IE9ubHkgZ3JvdXAgaW50byB0cmlwbGljYXRlcyBpZiBncm91cGluZyBpcyBlbmFibGVkCiAgICBpZiAoZ3JvdXBUcmlwbGljYXRlcykgewogICAgICBjb25zdCB0cmlwbGljYXRlR3JvdXAgPSBnZXRUcmlwbGljYXRlR3JvdXAod2VsbElkLCBjb2x1bW4pOwogICAgICBpZiAodHJpcGxpY2F0ZUdyb3VwKSB7CiAgICAgICAgLy8gQ3JlYXRlIGdyb3VwIGtleSB0aGF0IGluY2x1ZGVzIGNvbHVtbiB0byBzZXBhcmF0ZSBzYW1lIHBhdHRlcm4gYWNyb3NzIGNvbHVtbnMKICAgICAgICBjb25zdCBncm91cEtleSA9IGAke3RyaXBsaWNhdGVHcm91cC5uYW1lfV9jb2wke2NvbHVtbn1gOwogICAgICAgIGlmICghdHJpcGxpY2F0ZUdyb3Vwc0ZvdW5kLmhhcyhncm91cEtleSkpIHsKICAgICAgICAgIC8vIEdldCByb3cgbGV0dGVycyBmcm9tIHRoZSB0cmlwbGljYXRlIGdyb3VwIHBhdHRlcm4KICAgICAgICAgIGNvbnN0IGdyb3VwUm93TGV0dGVycyA9IGdldFJvd0xldHRlcnNGcm9tV2VsbHModHJpcGxpY2F0ZUdyb3VwLndlbGxzKTsKICAgICAgICAgIC8vIENyZWF0ZSB3ZWxsIElEcyBmb3IgdGhpcyBjb2x1bW4gdXNpbmcgdGhlIHJvdyBwYXR0ZXJuCiAgICAgICAgICBjb25zdCB3ZWxsSWRzRm9yQ29sdW1uID0gZ3JvdXBSb3dMZXR0ZXJzLm1hcChyb3cgPT4gcm93ICsgY29sdW1uKTsKICAgICAgICAgIAogICAgICAgICAgdHJpcGxpY2F0ZUdyb3Vwc0ZvdW5kLnNldChncm91cEtleSwgewogICAgICAgICAgICBuYW1lOiB0cmlwbGljYXRlR3JvdXAubmFtZSwKICAgICAgICAgICAgY29sdW1uOiBjb2x1bW4sCiAgICAgICAgICAgIHdlbGxJZHM6IG5ldyBTZXQod2VsbElkc0ZvckNvbHVtbikKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLy8gSWYgZ3JvdXBpbmcgaXMgZGlzYWJsZWQsIHdlbGxzIHdpbGwgYmUgaGFuZGxlZCBhcyBpbmRpdmlkdWFsIHdlbGxzIGluIHRoZSB0aGlyZCBwYXNzCiAgfSk7CiAgCiAgLy8gU2Vjb25kIHBhc3M6IGJ1aWxkIGdyb3VwZWQgc2VsZWN0aW9ucyBmb3IgdHJpcGxpY2F0ZSBncm91cHMKICB0cmlwbGljYXRlR3JvdXBzRm91bmQuZm9yRWFjaCgoZ3JvdXBJbmZvLCBncm91cEtleSkgPT4gewogICAgZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldID0gewogICAgICB0eXBlOiAidHJpcGxpY2F0ZSIsCiAgICAgIHdlbGxzOiBbXSwKICAgICAgbmFtZTogZ3JvdXBJbmZvLm5hbWUKICAgIH07CiAgICAKICAgIC8vIENvbGxlY3Qgd2VsbHMgZnJvbSBkYXRhc2V0cyB0aGF0IGhhdmUgc2VsZWN0ZWQgd2VsbHMgaW4gdGhpcyB0cmlwbGljYXRlIGdyb3VwCiAgICBBcnJheS5mcm9tKHNlbGVjdGVkV2VsbHMpLmZvckVhY2goa2V5ID0+IHsKICAgICAgY29uc3QgW3BsYXRlSWQsIHdlbGxJZF0gPSBrZXkuc3BsaXQoIjoiKTsKICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsSWQpOwogICAgICBpZiAoZ3JvdXBJbmZvLndlbGxJZHMuaGFzKHdlbGxJZCkgJiYgY29sdW1uID09PSBncm91cEluZm8uY29sdW1uKSB7CiAgICAgICAgY29uc3Qgd2VsbHMgPSBhbGxXZWxsc0RhdGFbcGxhdGVJZF0gfHwge307CiAgICAgICAgaWYgKHdlbGxzW3dlbGxJZF0pIHsKICAgICAgICAgIC8vIENoZWNrIGlmIGFscmVhZHkgYWRkZWQKICAgICAgICAgIGNvbnN0IGV4aXN0cyA9IGdyb3VwZWRTZWxlY3Rpb25zW2dyb3VwS2V5XS53ZWxscy5zb21lKAogICAgICAgICAgICB3ID0+IHcud2VsbElkID09PSB3ZWxsSWQgJiYgdy5wbGF0ZUlkID09PSBwbGF0ZUlkCiAgICAgICAgICApOwogICAgICAgICAgaWYgKCFleGlzdHMpIHsKICAgICAgICAgICAgLy8gU1RFUCAxOiBBcHBseSBub3JtYWxpemF0aW9uIHVzaW5nIGZpdHRlZCBiYXNlbGluZSBpZiBlbmFibGVkIChtdXN0IGhhcHBlbiBiZWZvcmUgZ3JvdXBpbmcpCiAgICAgICAgICAgIGxldCBwcm9jZXNzZWRXZWxsRGF0YSA9IHdlbGxzW3dlbGxJZF07CiAgICAgICAgICAgIGlmIChub3JtYWxpemVCYXNlbGluZSkgewogICAgICAgICAgICAgIHByb2Nlc3NlZFdlbGxEYXRhID0gbm9ybWFsaXplV2l0aEZpdHRlZEJhc2VsaW5lKAogICAgICAgICAgICAgICAgcHJvY2Vzc2VkV2VsbERhdGEsCiAgICAgICAgICAgICAgICBub3JtYWxpemVCYXNlbGluZUVuZFRpbWUsCiAgICAgICAgICAgICAgICBiYXNlbGluZU1ldGhvZCwKICAgICAgICAgICAgICAgIGJhc2VsaW5lRnJhYywKICAgICAgICAgICAgICAgIGJhc2VsaW5lUG9seU9yZGVyLAogICAgICAgICAgICAgICAgbm9ybWFsaXphdGlvbk1vZGUKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICghcHJvY2Vzc2VkV2VsbERhdGEpIHJldHVybjsgLy8gU2tpcCBpZiBub3JtYWxpemF0aW9uIGZhaWxlZAogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEFkZCB0byBncm91cCAoU3RlcCAyIGhhcHBlbnMgaGVyZSAtIGdyb3VwaW5nKQogICAgICAgICAgICAvLyBTdGVwIDMgKGF2ZXJhZ2luZykgd2lsbCBiZSBhcHBsaWVkIGxhdGVyCiAgICAgICAgICAgIGdyb3VwZWRTZWxlY3Rpb25zW2dyb3VwS2V5XS53ZWxscy5wdXNoKHsKICAgICAgICAgICAgICB3ZWxsSWQ6IHdlbGxJZCwKICAgICAgICAgICAgICBwbGF0ZUlkOiBwbGF0ZUlkLAogICAgICAgICAgICAgIGRhdGE6IHByb2Nlc3NlZFdlbGxEYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSk7CiAgCiAgLy8gVGhpcmQgcGFzczogaGFuZGxlIGluZGl2aWR1YWwgd2VsbHMgKHNraXAgaWYgYWxyZWFkeSBpbiB0cmlwbGljYXRlIGdyb3VwKQogIEFycmF5LmZyb20oc2VsZWN0ZWRXZWxscykuZm9yRWFjaChrZXkgPT4gewogICAgLy8gVmVyaWZ5IHRoaXMgd2VsbCBpcyBzdGlsbCBzZWxlY3RlZCAobWF5IGhhdmUgYmVlbiBkZXNlbGVjdGVkKQogICAgaWYgKCFzZWxlY3RlZFdlbGxzLmhhcyhrZXkpKSB7CiAgICAgIHJldHVybjsgLy8gU2tpcCB3ZWxscyB0aGF0IGFyZSBubyBsb25nZXIgc2VsZWN0ZWQKICAgIH0KICAgIAogICAgY29uc3QgW3BsYXRlSWQsIHdlbGxJZF0gPSBrZXkuc3BsaXQoIjoiKTsKICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgIGNvbnN0IGlzQ29udHJvbCA9IGlzQ29udHJvbFdlbGwod2VsbElkKTsKICAgIAogICAgLy8gQ29udHJvbHMgYXJlIGFsd2F5cyBoYW5kbGVkIGFzIGluZGl2aWR1YWwgd2VsbHMgKG5vIGdyb3VwaW5nKQogICAgaWYgKGlzQ29udHJvbCkgewogICAgICAvLyBDb250aW51ZSB0byBwcm9jZXNzIGFzIGluZGl2aWR1YWwgd2VsbAogICAgfSBlbHNlIHsKICAgICAgLy8gU1RFUCAyOiBDaGVjayBpZiB0aGlzIHdlbGwgaXMgcGFydCBvZiBhIHRyaXBsaWNhdGUgZ3JvdXAgd2UndmUgYWxyZWFkeSBwcm9jZXNzZWQKICAgICAgLy8gT25seSBza2lwIGlmIGdyb3VwaW5nIGlzIGVuYWJsZWQgYW5kIHRoaXMgd2VsbCB3YXMgZ3JvdXBlZAogICAgICBpZiAoZ3JvdXBUcmlwbGljYXRlcykgewogICAgICAgIGNvbnN0IHRyaXBsaWNhdGVHcm91cCA9IGdldFRyaXBsaWNhdGVHcm91cCh3ZWxsSWQsIGNvbHVtbik7CiAgICAgICAgaWYgKHRyaXBsaWNhdGVHcm91cCkgewogICAgICAgICAgLy8gQWxyZWFkeSBoYW5kbGVkIGluIHRyaXBsaWNhdGVHcm91cHNGb3VuZCAtIHNraXAKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIAogICAgLy8gRmlsdGVyIGJ5IGVuYWJsZWRXZWxscyBpZiBhbnkgYXJlIHNldAogICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3ZWxsSWQpKSB7CiAgICAgIHJldHVybjsgLy8gU2tpcCBleGNsdWRlZCB3ZWxscwogICAgfQogICAgCiAgICAvLyBJbmRpdmlkdWFsIHdlbGwgKG5vdCBwYXJ0IG9mIGEgdHJpcGxpY2F0ZSBncm91cCkKICAgIGNvbnN0IGdyb3VwS2V5ID0gYHdlbGxfJHt3ZWxsSWR9YDsKICAgIGlmICghZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldKSB7CiAgICAgIGNvbnN0IGNvbmZpZyA9IHZpZXdlckRhdGEuY29uZmlnIHx8IHt9OwogICAgICBjb25zdCB3ZWxsTGFiZWxzID0gY29uZmlnLndlbGxfbGFiZWxzIHx8IHt9OwogICAgICAvLyBHZXQgbGFiZWwgZnJvbSByb3ctYmFzZWQgY29uZmlnIG9yIHdlbGwgZGF0YQogICAgICBjb25zdCByb3dMZXR0ZXIgPSBnZXRSb3dMZXR0ZXIod2VsbElkKTsKICAgICAgbGV0IGxhYmVsID0gd2VsbExhYmVsc1tyb3dMZXR0ZXJdOwogICAgICBpZiAoIWxhYmVsKSB7CiAgICAgICAgZm9yIChjb25zdCBwSWQgb2Ygc2VsZWN0ZWREYXRhc2V0cykgewogICAgICAgICAgaWYgKGFsbFdlbGxzRGF0YVtwSWRdICYmIGFsbFdlbGxzRGF0YVtwSWRdW3dlbGxJZF0pIHsKICAgICAgICAgICAgbGFiZWwgPSBhbGxXZWxsc0RhdGFbcElkXVt3ZWxsSWRdLmxhYmVsIHx8IGFsbFdlbGxzRGF0YVtwSWRdW3dlbGxJZF0uY29udGVudCB8fCBgV2VsbCAke3dlbGxJZH1gOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldID0gewogICAgICAgIHR5cGU6ICJzaW5nbGUiLAogICAgICAgIHdlbGxzOiBbXSwKICAgICAgICBsYWJlbDogZm9ybWF0TGFiZWwobGFiZWwpIHx8IGBXZWxsICR7d2VsbElkfWAKICAgICAgfTsKICAgIH0KICAgIAogICAgLy8gQWRkIHRoaXMgd2VsbCdzIGRhdGEgaWYgaXQgZXhpc3RzCiAgICBpZiAoYWxsV2VsbHNEYXRhW3BsYXRlSWRdICYmIGFsbFdlbGxzRGF0YVtwbGF0ZUlkXVt3ZWxsSWRdKSB7CiAgICAgIGNvbnN0IGV4aXN0aW5nID0gZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldLndlbGxzLmZpbmQodyA9PiB3LndlbGxJZCA9PT0gd2VsbElkICYmIHcucGxhdGVJZCA9PT0gcGxhdGVJZCk7CiAgICAgIGlmICghZXhpc3RpbmcpIHsKICAgICAgICAgIC8vIFNURVAgMTogQXBwbHkgbm9ybWFsaXphdGlvbiB1c2luZyBmaXR0ZWQgYmFzZWxpbmUgaWYgZW5hYmxlZCAobXVzdCBoYXBwZW4gYmVmb3JlIGdyb3VwaW5nKQogICAgICAgICAgbGV0IHByb2Nlc3NlZFdlbGxEYXRhID0gYWxsV2VsbHNEYXRhW3BsYXRlSWRdW3dlbGxJZF07CiAgICAgICAgICBpZiAobm9ybWFsaXplQmFzZWxpbmUpIHsKICAgICAgICAgICAgcHJvY2Vzc2VkV2VsbERhdGEgPSBub3JtYWxpemVXaXRoRml0dGVkQmFzZWxpbmUoCiAgICAgICAgICAgICAgcHJvY2Vzc2VkV2VsbERhdGEsCiAgICAgICAgICAgICAgbm9ybWFsaXplQmFzZWxpbmVFbmRUaW1lLAogICAgICAgICAgICAgIGJhc2VsaW5lTWV0aG9kLAogICAgICAgICAgICAgIGJhc2VsaW5lRnJhYywKICAgICAgICAgICAgICBiYXNlbGluZVBvbHlPcmRlciwKICAgICAgICAgICAgICBub3JtYWxpemF0aW9uTW9kZQogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoIXByb2Nlc3NlZFdlbGxEYXRhKSByZXR1cm47IC8vIFNraXAgaWYgbm9ybWFsaXphdGlvbiBmYWlsZWQKICAgICAgICAgIH0KICAgICAgICAgIC8vIFNURVAgNDogQXBwbHkgbm9ybWFsaXphdGlvbiB1c2luZyBmaXR0ZWQgYmFzZWxpbmUgaWYgZW5hYmxlZAogICAgICAgICAgaWYgKG5vcm1hbGl6ZUJhc2VsaW5lKSB7CiAgICAgICAgICAgIHByb2Nlc3NlZFdlbGxEYXRhID0gbm9ybWFsaXplV2l0aEZpdHRlZEJhc2VsaW5lKAogICAgICAgICAgICAgIHByb2Nlc3NlZFdlbGxEYXRhLAogICAgICAgICAgICAgIG5vcm1hbGl6ZUJhc2VsaW5lRW5kVGltZSwKICAgICAgICAgICAgICBiYXNlbGluZU1ldGhvZCwKICAgICAgICAgICAgICBiYXNlbGluZUZyYWMsCiAgICAgICAgICAgICAgYmFzZWxpbmVQb2x5T3JkZXIsCiAgICAgICAgICAgICAgbm9ybWFsaXphdGlvbk1vZGUKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKCFwcm9jZXNzZWRXZWxsRGF0YSkgcmV0dXJuOyAvLyBTa2lwIGlmIG5vcm1hbGl6YXRpb24gZmFpbGVkCiAgICAgICAgICB9CiAgICAgICAgICAvLyBBZGQgdG8gZ3JvdXAgKFN0ZXAgMiBoYXBwZW5zIGhlcmUgLSBncm91cGluZykKICAgICAgICAgIC8vIFN0ZXAgMyAoYXZlcmFnaW5nKSB3aWxsIGJlIGFwcGxpZWQgbGF0ZXIKICAgICAgICAgIGdyb3VwZWRTZWxlY3Rpb25zW2dyb3VwS2V5XS53ZWxscy5wdXNoKHsKICAgICAgICAgIHdlbGxJZCwgCiAgICAgICAgICBwbGF0ZUlkLCAKICAgICAgICAgIGRhdGE6IHByb2Nlc3NlZFdlbGxEYXRhCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9KTsKICAKICAvLyBDb250aW51ZSB3aXRoIGdyb3VwZWQgc2VsZWN0aW9ucyAoY29sb3JJZHggYWxyZWFkeSBpbml0aWFsaXplZCBmb3IgU3RlcCAwKQogIC8vIFByb2Nlc3MgZ3JvdXBlZCBzZWxlY3Rpb25zIHdoZW46CiAgLy8gMS4gU3RlcCAwIGlzIG5vdCBzaG93aW5nIChiZWNhdXNlIG90aGVyIHN0ZXBzIGFyZSBlbmFibGVkKSwgT1IKICAvLyAyLiBQcm9jZXNzaW5nIHN0ZXBzIGFyZSBlbmFibGVkICh3aGljaCBhdXRvbWF0aWNhbGx5IGRpc2FibGVzIFN0ZXAgMCkKICAvLyBUaGlzIGVuc3VyZXMgZGF0YSBhbHdheXMgc2hvd3MgLSBlaXRoZXIgU3RlcCAwIGluZGl2aWR1YWwgd2VsbHMgT1IgZ3JvdXBlZCBzZWxlY3Rpb25zCiAgaWYgKCFzaG93SW5kaXZpZHVhbFdlbGxzKSB7CiAgICBPYmplY3Qua2V5cyhncm91cGVkU2VsZWN0aW9ucykuZm9yRWFjaChncm91cEtleSA9PiB7CiAgICAgIGNvbnN0IGdyb3VwID0gZ3JvdXBlZFNlbGVjdGlvbnNbZ3JvdXBLZXldOwogICAgICAKICAgICAgLy8gRmlsdGVyIG91dCBhbnkgd2VsbHMgdGhhdCBhcmUgbm8gbG9uZ2VyIHNlbGVjdGVkIG9yIGFyZSBleGNsdWRlZAogICAgICBncm91cC53ZWxscyA9IGdyb3VwLndlbGxzLmZpbHRlcih3ID0+IHsKICAgICAgICBjb25zdCBrZXkgPSBgJHt3LnBsYXRlSWR9OiR7dy53ZWxsSWR9YDsKICAgICAgICAvLyBDaGVjayBpZiBzdGlsbCBzZWxlY3RlZAogICAgICAgIGlmICghc2VsZWN0ZWRXZWxscy5oYXMoa2V5KSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICAvLyBDaGVjayBpZiBleGNsdWRlZCB2aWEgZW5hYmxlZFdlbGxzCiAgICAgICAgaWYgKGVuYWJsZWRXZWxscy5zaXplID4gMCAmJiAhZW5hYmxlZFdlbGxzLmhhcyh3LndlbGxJZCkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgICAKICAgICAgLy8gU2tpcCBncm91cHMgd2l0aCBubyB3ZWxscyBhZnRlciBmaWx0ZXJpbmcKICAgICAgaWYgKGdyb3VwLndlbGxzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybjsgLy8gU2tpcCB0byBuZXh0IGdyb3VwCiAgICAgIH0KICAgICAgCiAgICAgIGNvbnN0IGNvbG9yID0gY29sb3JzW2NvbG9ySWR4ICUlIGNvbG9ycy5sZW5ndGhdOwogICAgICBjb2xvcklkeCsrOwoKICAgIGlmIChncm91cC50eXBlID09PSAidHJpcGxpY2F0ZSIgJiYgZ3JvdXAud2VsbHMubGVuZ3RoID4gMCkgewogICAgICAvLyBTVEVQIDM6IEF2ZXJhZ2Ugd2l0aGluIHRyaXBsaWNhdGUgZ3JvdXAKICAgICAgY29uc3QgcmVzdWx0ID0gcHJvY2Vzc1dlbGxzQW5kQ2FsY3VsYXRlTWVhbigKICAgICAgICBncm91cC53ZWxscy5tYXAodyA9PiB3LmRhdGEpLAogICAgICAgIGZhbHNlLCAvLyBObyBub3JtYWxpemF0aW9uCiAgICAgICAgMCwgLy8gYmFzZWxpbmVFbmRUaW1lIG5vdCB1c2VkCiAgICAgICAgOTk5OTk5IC8vIGN1dG9mZlRpbWUgbm90IHVzZWQKICAgICAgKTsKICAgICAgY29uc3QgdGltZVBvaW50cyA9IHJlc3VsdC5maWx0ZXJlZFRpbWVQb2ludHM7CiAgICAgIGNvbnN0IG1lYW5zID0gcmVzdWx0Lm5vcm1hbGl6ZWRNZWFuczsKICAgICAgY29uc3QgZXJyb3JzID0gcmVzdWx0Lm5vcm1hbGl6ZWRFcnJvcnM7CiAgICAgIAogICAgICAvLyBDcmVhdGUgZGF0YXNldCB3aXRoIG1lYW4gYW5kIGVycm9yIGluZm9ybWF0aW9uCiAgICAgIGNvbnN0IGxpbmVEYXRhID0gdGltZVBvaW50cy5tYXAoKHQsIGkpID0+IHsKICAgICAgICBjb25zdCBwb2ludCA9IHsKICAgICAgICAgIHg6IHQsCiAgICAgICAgICB5OiBtZWFuc1tpXSwKICAgICAgICAgIGVycm9yOiBlcnJvcnNbaV0KICAgICAgICB9OwogICAgICAgIHJldHVybiBwb2ludDsKICAgICAgfSkuZmlsdGVyKGQgPT4gZC55ICE9PSBudWxsKTsKICAgICAgCiAgICAgIC8vIEdldCBncm91cCBuYW1lIGZyb20gZmlyc3Qgd2VsbCdzIHBsYXRlCiAgICAgIGNvbnN0IGZpcnN0UGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gZ3JvdXAud2VsbHNbMF0ucGxhdGVJZCk7CiAgICAgIGNvbnN0IGNvbHVtbkdyb3VwTmFtZSA9IGZpcnN0UGxhdGUgPyBmaXJzdFBsYXRlLmNvbHVtbl9ncm91cCA6ICIiOwogICAgICBjb25zdCBkYXRhc2V0Q291bnQgPSBuZXcgU2V0KGdyb3VwLndlbGxzLm1hcCh3ID0+IHcucGxhdGVJZCkpLnNpemU7CiAgICAgIGNvbnN0IHdlbGxDb3VudCA9IGdyb3VwLndlbGxzLmxlbmd0aDsKICAgICAgCiAgICAgIC8vIENyZWF0ZSBhcHByb3ByaWF0ZSBsYWJlbCBiYXNlZCBvbiBudW1iZXIgb2YgcmVwbGljYXRlcwogICAgICBsZXQgcmVwbGljYXRlTGFiZWwgPSAiIjsKICAgICAgaWYgKHdlbGxDb3VudCA9PT0gMykgewogICAgICAgIHJlcGxpY2F0ZUxhYmVsID0gInRyaXBsaWNhdGUiOwogICAgICB9IGVsc2UgaWYgKHdlbGxDb3VudCA9PT0gNikgewogICAgICAgIHJlcGxpY2F0ZUxhYmVsID0gImhleHBsaWNhdGUiOwogICAgICB9IGVsc2UgaWYgKHdlbGxDb3VudCA9PT0gOSkgewogICAgICAgIHJlcGxpY2F0ZUxhYmVsID0gIm5vbnVwbGljYXRlIjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXBsaWNhdGVMYWJlbCA9IGAke3dlbGxDb3VudH0tcGxpY2F0ZWA7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIEdldCBjb2x1bW4gbnVtYmVyIGZyb20gZmlyc3Qgd2VsbAogICAgICBjb25zdCBmaXJzdFdlbGxJZCA9IGdyb3VwLndlbGxzWzBdLndlbGxJZDsKICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZChmaXJzdFdlbGxJZCk7CiAgICAgIAogICAgICAvLyBBZGQgd2VsbCBJRHMgd2hlbiBTdGVwIDEgKG5vcm1hbGl6YXRpb24pIGlzIGVuYWJsZWQKICAgICAgbGV0IHdlbGxJZHNQcmVmaXggPSAiIjsKICAgICAgaWYgKG5vcm1hbGl6ZUJhc2VsaW5lICYmIGdyb3VwLndlbGxzLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCB3ZWxsSWRzID0gZ3JvdXAud2VsbHMubWFwKHcgPT4gdy53ZWxsSWQpLmpvaW4oIiwgIik7CiAgICAgICAgd2VsbElkc1ByZWZpeCA9IGAke3dlbGxJZHN9IC0gYDsKICAgICAgfQogICAgICAKICAgICAgY29uc3QgbGFiZWxTdWZmaXggPSBkYXRhc2V0Q291bnQgPiAxIAogICAgICAgID8gYCAoJHtyZXBsaWNhdGVMYWJlbH0sICR7ZGF0YXNldENvdW50fSBkYXRhc2V0cywgbWVhbiDCsSBTRSlgIAogICAgICAgIDogYCAoJHtyZXBsaWNhdGVMYWJlbH0sIG1lYW4gwrEgU0UpYDsKICAgICAgY29uc3QgZm9ybWF0dGVkTmFtZSA9IGZvcm1hdExhYmVsKGdyb3VwLm5hbWUpOwogICAgICBjb25zdCBsYWJlbCA9IGNvbHVtbkdyb3VwTmFtZSAKICAgICAgICA/IGAke3dlbGxJZHNQcmVmaXh9JHtmb3JtYXR0ZWROYW1lfSAoJHtjb2x1bW5Hcm91cE5hbWV9KSBDb2wgJHtjb2x1bW59JHtsYWJlbFN1ZmZpeH1gCiAgICAgICAgOiBgJHt3ZWxsSWRzUHJlZml4fSR7Zm9ybWF0dGVkTmFtZX0gQ29sICR7Y29sdW1ufSR7bGFiZWxTdWZmaXh9YDsKICAgICAgCiAgICAgIGRhdGFzZXRzLnB1c2goewogICAgICAgIGxhYmVsOiBsYWJlbCwKICAgICAgICBkYXRhOiBsaW5lRGF0YSwKICAgICAgICBib3JkZXJDb2xvcjogY29sb3IsCiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBjb2xvci5yZXBsYWNlKCIxLjAiLCAiMC4yIiksCiAgICAgICAgdGVuc2lvbjogMC4xNSwKICAgICAgICBwb2ludFJhZGl1czogMywKICAgICAgICBib3JkZXJXaWR0aDogMiwKICAgICAgICBmaWxsOiBmYWxzZQogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoZ3JvdXAudHlwZSA9PT0gInNpbmdsZSIpIHsKICAgICAgLy8gU2luZ2xlIHdlbGwgLSBjaGVjayBpZiBpdCdzIGEgZHVwbGljYXRlCiAgICAgIGNvbnN0IHdlbGxJZCA9IGdyb3VwLndlbGxzWzBdLndlbGxJZDsKICAgICAgY29uc3QgaXNEdXBsaWNhdGUgPSBpc0R1cGxpY2F0ZVdlbGwod2VsbElkKTsKICAgICAgCiAgICAgIGlmIChncm91cC53ZWxscy5sZW5ndGggPiAxICYmIGlzRHVwbGljYXRlKSB7CiAgICAgICAgLy8gRHVwbGljYXRlIHdlbGwgLSBzaG93IGVhY2ggZGF0YXNldCBzZXBhcmF0ZWx5IGZvciBjb21wYXJpc29uCiAgICAgICAgY29uc3QgbGluZVN0eWxlcyA9IFsic29saWQiLCAiZGFzaGVkIiwgImRvdHRlZCJdOwogICAgICAgIGNvbnN0IGZvcm1hdHRlZExhYmVsID0gZm9ybWF0TGFiZWwoZ3JvdXAubGFiZWwpOwogICAgICAgIAogICAgICAgIGdyb3VwLndlbGxzLmZvckVhY2goKHdlbGwsIGlkeCkgPT4gewogICAgICAgICAgY29uc3QgcGxhdGUgPSB2aWV3ZXJEYXRhLnBsYXRlcy5maW5kKHAgPT4gcC5pZCA9PT0gd2VsbC5wbGF0ZUlkKTsKICAgICAgICAgIGNvbnN0IGZpbGVuYW1lID0gcGxhdGUgPyAocGxhdGUuZmlsZSB8fCBwbGF0ZS5pZCkgOiB3ZWxsLnBsYXRlSWQ7CiAgICAgICAgICBjb25zdCBsaW5lU3R5bGUgPSBsaW5lU3R5bGVzW2lkeCAlJSBsaW5lU3R5bGVzLmxlbmd0aF07CiAgICAgICAgICAKICAgICAgICAgIC8vIFVzZSBzbGlnaHRseSBkaWZmZXJlbnQgc2hhZGVzIG9mIHRoZSBzYW1lIGNvbG9yIGZvciBkdXBsaWNhdGVzCiAgICAgICAgICBjb25zdCBiYXNlQ29sb3IgPSBjb2xvcjsKICAgICAgICAgIGNvbnN0IGFscGhhID0gMS4wIC0gKGlkeCAqIDAuMTUpOyAvLyBTbGlnaHRseSBmYWRlIGVhY2ggc3Vic2VxdWVudCBsaW5lCiAgICAgICAgICBjb25zdCBhZGp1c3RlZENvbG9yID0gYmFzZUNvbG9yLnJlcGxhY2UoIjEuMCIsIGFscGhhLnRvRml4ZWQoMSkpOwogICAgICAgICAgCiAgICAgICAgICBsZXQgdGltZVBvaW50cyA9IHdlbGwuZGF0YS50aW1lX3M7CiAgICAgICAgICBsZXQgdmFsdWVzID0gd2VsbC5kYXRhLnZhbHVlczsKICAgICAgICAgIAogICAgICAgICAgY29uc3QgY29sdW1uID0gZ2V0Q29sdW1uRnJvbVdlbGxJZCh3ZWxsLndlbGxJZCk7CiAgICAgICAgICAvLyBBZGQgd2VsbCBJRCB3aGVuIFN0ZXAgMSAobm9ybWFsaXphdGlvbikgaXMgZW5hYmxlZAogICAgICAgICAgY29uc3Qgd2VsbElkUHJlZml4ID0gbm9ybWFsaXplQmFzZWxpbmUgPyBgJHt3ZWxsLndlbGxJZH0gLSBgIDogIiI7CiAgICAgICAgICBkYXRhc2V0cy5wdXNoKHsKICAgICAgICAgICAgbGFiZWw6IGAke3dlbGxJZFByZWZpeH0ke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59ICgke2ZpbGVuYW1lfSlgLAogICAgICAgICAgICBkYXRhOiB0aW1lUG9pbnRzLm1hcCgodCwgaSkgPT4gewogICAgICAgICAgICAgIGNvbnN0IHBvaW50ID0geyB4OiB0LCB5OiB2YWx1ZXNbaV0gfTsKICAgICAgICAgICAgICByZXR1cm4gcG9pbnQ7CiAgICAgICAgICAgIH0pLmZpbHRlcihkID0+IGQueSAhPT0gbnVsbCksCiAgICAgICAgICAgIGJvcmRlckNvbG9yOiBhZGp1c3RlZENvbG9yLAogICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICAgIGJvcmRlckRhc2g6IGxpbmVTdHlsZSA9PT0gImRhc2hlZCIgPyBbNSwgNV0gOiBsaW5lU3R5bGUgPT09ICJkb3R0ZWQiID8gWzIsIDJdIDogW10sCiAgICAgICAgICAgIHRlbnNpb246IDAuMTUsCiAgICAgICAgICAgIHBvaW50UmFkaXVzOiAyLAogICAgICAgICAgICBib3JkZXJXaWR0aDogMS41LAogICAgICAgICAgICBmaWxsOiBmYWxzZSwKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKGdyb3VwLndlbGxzLmxlbmd0aCA+IDEpIHsKICAgICAgICAvLyBTVEVQIDM6IEF2ZXJhZ2UgbXVsdGlwbGUgZGF0YXNldHMgZm9yIHNhbWUgd2VsbCAobm90IGR1cGxpY2F0ZSkgLSBjYWxjdWxhdGUgbWVhbiBhbmQgZXJyb3IKICAgICAgICBjb25zdCByZXN1bHQgPSBwcm9jZXNzV2VsbHNBbmRDYWxjdWxhdGVNZWFuKAogICAgICAgICAgZ3JvdXAud2VsbHMubWFwKHcgPT4gdy5kYXRhKSwKICAgICAgICAgIGZhbHNlLCAvLyBObyBub3JtYWxpemF0aW9uCiAgICAgICAgICAwLCAvLyBiYXNlbGluZUVuZFRpbWUgbm90IHVzZWQKICAgICAgICAgIDk5OTk5OSAvLyBjdXRvZmZUaW1lIG5vdCB1c2VkCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0aW1lUG9pbnRzID0gcmVzdWx0LmZpbHRlcmVkVGltZVBvaW50czsKICAgICAgICBjb25zdCBtZWFucyA9IHJlc3VsdC5ub3JtYWxpemVkTWVhbnM7CiAgICAgICAgY29uc3QgZXJyb3JzID0gcmVzdWx0Lm5vcm1hbGl6ZWRFcnJvcnM7CiAgICAgICAgCiAgICAgICAgY29uc3QgbGluZURhdGEgPSB0aW1lUG9pbnRzLm1hcCgodCwgaSkgPT4gewogICAgICAgICAgY29uc3QgcG9pbnQgPSB7CiAgICAgICAgICAgIHg6IHQsCiAgICAgICAgICAgIHk6IG1lYW5zW2ldLAogICAgICAgICAgICBlcnJvcjogZXJyb3JzW2ldCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHBvaW50OwogICAgICAgIH0pLmZpbHRlcihkID0+IGQueSAhPT0gbnVsbCk7CiAgICAgICAgCiAgICAgICAgY29uc3QgZGF0YXNldENvdW50ID0gZ3JvdXAud2VsbHMubGVuZ3RoOwogICAgICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbElkKTsKICAgICAgICBjb25zdCBmb3JtYXR0ZWRMYWJlbCA9IGZvcm1hdExhYmVsKGdyb3VwLmxhYmVsKTsKICAgICAgICAvLyBBZGQgd2VsbCBJRCB3aGVuIFN0ZXAgMSAobm9ybWFsaXphdGlvbikgaXMgZW5hYmxlZAogICAgICAgIGNvbnN0IHdlbGxJZFByZWZpeCA9IG5vcm1hbGl6ZUJhc2VsaW5lID8gYCR7d2VsbElkfSAtIGAgOiAiIjsKICAgICAgICBjb25zdCBsYWJlbCA9IGAke3dlbGxJZFByZWZpeH0ke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59ICgke2RhdGFzZXRDb3VudH0gZGF0YXNldHMsIG1lYW4gwrEgU0UpYDsKICAgICAgICAKICAgICAgICBkYXRhc2V0cy5wdXNoKHsKICAgICAgICAgIGxhYmVsOiBsYWJlbCwKICAgICAgICAgIGRhdGE6IGxpbmVEYXRhLAogICAgICAgICAgYm9yZGVyQ29sb3I6IGNvbG9yLAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBjb2xvci5yZXBsYWNlKCIxLjAiLCAiMC4yIiksCiAgICAgICAgICB0ZW5zaW9uOiAwLjE1LAogICAgICAgICAgcG9pbnRSYWRpdXM6IDMsCiAgICAgICAgICBib3JkZXJXaWR0aDogMiwKICAgICAgICAgIGZpbGw6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU2luZ2xlIGRhdGFzZXQgZm9yIHRoaXMgd2VsbAogICAgICAgIC8vIFNraXAgc2hvd2luZyBwcm9jZXNzZWQgaW5kaXZpZHVhbCB3ZWxscyBpZiBTdGVwIDAgaXMgYWxyZWFkeSBzaG93aW5nIHRoZSByYXcgZGF0YQogICAgICAgIC8vIEJ1dCBvbmx5IHNraXAgaWYgU3RlcCAwIGlzIGFjdHVhbGx5IGVuYWJsZWQgKG5vdCBqdXN0IHJlcXVlc3RlZCkKICAgICAgICBpZiAoc2hvd0luZGl2aWR1YWxXZWxscyAmJiAhYW55UHJvY2Vzc2luZ1N0ZXBFbmFibGVkKSB7CiAgICAgICAgICAvLyBTdGVwIDAgYWxyZWFkeSBzaG93cyB0aGlzIHdlbGwsIHNraXAgdGhlIHByb2Nlc3NlZCB2ZXJzaW9uIHRvIGF2b2lkIGR1cGxpY2F0ZXMKICAgICAgICAgIHJldHVybjsgLy8gU2tpcCB0byBuZXh0IGdyb3VwIGluIGZvckVhY2gKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgY29uc3Qgd2VsbCA9IGdyb3VwLndlbGxzWzBdOwogICAgICAgIGNvbnN0IGNvbHVtbiA9IGdldENvbHVtbkZyb21XZWxsSWQod2VsbC53ZWxsSWQpOwogICAgICAgIGNvbnN0IGZvcm1hdHRlZExhYmVsID0gZm9ybWF0TGFiZWwoZ3JvdXAubGFiZWwpOwogICAgICAgIAogICAgICAgIGxldCB0aW1lUG9pbnRzID0gd2VsbC5kYXRhLnRpbWVfczsKICAgICAgICBsZXQgdmFsdWVzID0gd2VsbC5kYXRhLnZhbHVlczsKICAgICAgICAKICAgICAgICAvLyBBZGQgd2VsbCBJRCB3aGVuIFN0ZXAgMSAobm9ybWFsaXphdGlvbikgaXMgZW5hYmxlZAogICAgICAgIGNvbnN0IHdlbGxJZFByZWZpeCA9IG5vcm1hbGl6ZUJhc2VsaW5lID8gYCR7d2VsbC53ZWxsSWR9IC0gYCA6ICIiOwogICAgICAgIGNvbnN0IGxhYmVsID0gZm9ybWF0dGVkTGFiZWwgCiAgICAgICAgICA/IGAke3dlbGxJZFByZWZpeH0ke2Zvcm1hdHRlZExhYmVsfSBDb2wgJHtjb2x1bW59YCAKICAgICAgICAgIDogYCR7d2VsbElkUHJlZml4fVdlbGwgJHt3ZWxsLndlbGxJZH0gQ29sICR7Y29sdW1ufWA7CiAgICAgICAgCiAgICAgICAgZGF0YXNldHMucHVzaCh7CiAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICBkYXRhOiB0aW1lUG9pbnRzLm1hcCgodCwgaSkgPT4gewogICAgICAgICAgICBjb25zdCBwb2ludCA9IHsgeDogdCwgeTogdmFsdWVzW2ldIH07CiAgICAgICAgICAgIHJldHVybiBwb2ludDsKICAgICAgICAgIH0pLmZpbHRlcihkID0+IGQueSAhPT0gbnVsbCksCiAgICAgICAgICBib3JkZXJDb2xvcjogY29sb3IsCiAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICB0ZW5zaW9uOiAwLjE1LAogICAgICAgICAgcG9pbnRSYWRpdXM6IDIsCiAgICAgICAgICBib3JkZXJXaWR0aDogMS41LAogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICB9KTsKICB9CgogIC8vIFNURVAgMzogQXBwbHkgY3V0b2ZmIGZpbHRlcmluZyB0byBhbGwgZGF0YXNldHMKICBsZXQgeEF4aXNNaW4gPSB1bmRlZmluZWQ7CiAgbGV0IHhBeGlzTWF4ID0gdW5kZWZpbmVkOwogIAogIGlmIChjdXRvZmZCYXNlbGluZSkgewogICAgZGF0YXNldHMuZm9yRWFjaChkYXRhc2V0ID0+IHsKICAgICAgaWYgKGRhdGFzZXQuZGF0YSAmJiBkYXRhc2V0LmRhdGEubGVuZ3RoID4gMCkgewogICAgICAgIC8vIEZpbmQgZmlyc3QgcmVhbCB0aW1lcG9pbnQgKGZpcnN0IG5vbi1udWxsIHRpbWUpCiAgICAgICAgbGV0IGZpcnN0VGltZXBvaW50ID0gbnVsbDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGFzZXQuZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGRhdGFzZXQuZGF0YVtpXS54ICE9PSBudWxsICYmIGlzRmluaXRlKGRhdGFzZXQuZGF0YVtpXS54KSkgewogICAgICAgICAgICBmaXJzdFRpbWVwb2ludCA9IGRhdGFzZXQuZGF0YVtpXS54OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gRGV0ZXJtaW5lIG1pbmltdW0gdGltZSB0byBpbmNsdWRlCiAgICAgICAgLy8gSWYgbm9ybWFsaXphdGlvbiBpcyBlbmFibGVkLCBleGNsdWRlIGJhc2VsaW5lIHBlcmlvZCAocG9pbnRzIGJlZm9yZSBiYXNlbGluZUVuZFRpbWUpCiAgICAgICAgLy8gT3RoZXJ3aXNlLCBleGNsdWRlIHBvaW50cyBiZWZvcmUgZmlyc3QgcmVhbCB0aW1lcG9pbnQKICAgICAgICBjb25zdCBtaW5UaW1lID0gbm9ybWFsaXplQmFzZWxpbmUgPyBub3JtYWxpemVCYXNlbGluZUVuZFRpbWUgOiAoZmlyc3RUaW1lcG9pbnQgIT09IG51bGwgPyBmaXJzdFRpbWVwb2ludCA6IC1JbmZpbml0eSk7CiAgICAgICAgCiAgICAgICAgLy8gRmlsdGVyIGRhdGEgcG9pbnRzOiBleGNsdWRlIGJlZm9yZSBtaW5UaW1lIGFuZCBhZnRlciBjdXRvZmYgdGltZQogICAgICAgIGRhdGFzZXQuZGF0YSA9IGRhdGFzZXQuZGF0YS5maWx0ZXIocG9pbnQgPT4gewogICAgICAgICAgaWYgKHBvaW50LnggPT09IG51bGwgfHwgIWlzRmluaXRlKHBvaW50LngpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICBpZiAocG9pbnQueCA8IG1pblRpbWUpIHJldHVybiBmYWxzZTsKICAgICAgICAgIGlmIChwb2ludC54ID4gY3V0b2ZmQmFzZWxpbmVUaW1lKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICAvLyBUcmFjayBtaW4vbWF4IHggdmFsdWVzIGZvciBheGlzIGFkanVzdG1lbnQKICAgICAgICBpZiAoZGF0YXNldC5kYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IHRpbWVzID0gZGF0YXNldC5kYXRhLm1hcChwID0+IHAueCkuZmlsdGVyKHQgPT4gdCAhPT0gbnVsbCAmJiBpc0Zpbml0ZSh0KSk7CiAgICAgICAgICBpZiAodGltZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBkYXRhc2V0TWluID0gTWF0aC5taW4oLi4udGltZXMpOwogICAgICAgICAgICBjb25zdCBkYXRhc2V0TWF4ID0gTWF0aC5tYXgoLi4udGltZXMpOwogICAgICAgICAgICBpZiAoeEF4aXNNaW4gPT09IHVuZGVmaW5lZCB8fCBkYXRhc2V0TWluIDwgeEF4aXNNaW4pIHsKICAgICAgICAgICAgICB4QXhpc01pbiA9IGRhdGFzZXRNaW47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHhBeGlzTWF4ID09PSB1bmRlZmluZWQgfHwgZGF0YXNldE1heCA+IHhBeGlzTWF4KSB7CiAgICAgICAgICAgICAgeEF4aXNNYXggPSBkYXRhc2V0TWF4OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9IGVsc2UgewogICAgLy8gRXZlbiBpZiBjdXRvZmYgaXMgZGlzYWJsZWQsIGNhbGN1bGF0ZSB4LWF4aXMgcmFuZ2UgZnJvbSBhbGwgZGF0YXNldHMgZm9yIHByb3BlciBkaXNwbGF5CiAgICBkYXRhc2V0cy5mb3JFYWNoKGRhdGFzZXQgPT4gewogICAgICBpZiAoZGF0YXNldC5kYXRhICYmIGRhdGFzZXQuZGF0YS5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3QgdGltZXMgPSBkYXRhc2V0LmRhdGEubWFwKHAgPT4gcC54KS5maWx0ZXIodCA9PiB0ICE9PSBudWxsICYmIGlzRmluaXRlKHQpKTsKICAgICAgICBpZiAodGltZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgY29uc3QgZGF0YXNldE1pbiA9IE1hdGgubWluKC4uLnRpbWVzKTsKICAgICAgICAgIGNvbnN0IGRhdGFzZXRNYXggPSBNYXRoLm1heCguLi50aW1lcyk7CiAgICAgICAgICBpZiAoeEF4aXNNaW4gPT09IHVuZGVmaW5lZCB8fCBkYXRhc2V0TWluIDwgeEF4aXNNaW4pIHsKICAgICAgICAgICAgeEF4aXNNaW4gPSBkYXRhc2V0TWluOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHhBeGlzTWF4ID09PSB1bmRlZmluZWQgfHwgZGF0YXNldE1heCA+IHhBeGlzTWF4KSB7CiAgICAgICAgICAgIHhBeGlzTWF4ID0gZGF0YXNldE1heDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICAKICAvLyBTVEVQIDQ6IEFkZCByZWdyZXNzaW9uIGN1cnZlcyB0byBkYXRhc2V0cwogIGlmIChmaXRSZWdyZXNzaW9uKSB7CiAgICBjb25zdCByZWdyZXNzaW9uRGF0YXNldHMgPSBbXTsKICAgIGNvbnN0IG1vbm9FeHBQYXJhbXMgPSBbXTsgLy8gU3RvcmUgcGFyYW1ldGVycyBmb3IgbW9uby1leHBvbmVudGlhbCBmaXRzCiAgICAKICAgIGRhdGFzZXRzLmZvckVhY2goZGF0YXNldCA9PiB7CiAgICAgIGlmIChkYXRhc2V0LmRhdGEgJiYgZGF0YXNldC5kYXRhLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBkYXRhc2V0IHJlcHJlc2VudHMgYSBjb250cm9sIHdlbGwKICAgICAgICAvLyBFeHRyYWN0IHdlbGxJZCBmcm9tIGxhYmVsIChmb3JtYXQ6ICJOMSAtIExhYmVsIiBvciAiTjEgLSBMYWJlbCBDb250cm9sIENvbCAxIikKICAgICAgICBsZXQgaXNDb250cm9sID0gZmFsc2U7CiAgICAgICAgY29uc3QgbGFiZWwgPSBkYXRhc2V0LmxhYmVsIHx8ICIiOwogICAgICAgIAogICAgICAgIC8vIE1ldGhvZCAxOiBDaGVjayBpZiBsYWJlbCBjb250YWlucyAiQ29udHJvbCIgKGNhc2UtaW5zZW5zaXRpdmUpCiAgICAgICAgaWYgKGxhYmVsLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoImNvbnRyb2wiKSkgewogICAgICAgICAgaXNDb250cm9sID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gTWV0aG9kIDI6IFRyeSB0byBleHRyYWN0IHdlbGxJZCBmcm9tIGxhYmVsIGFuZCBjaGVjawogICAgICAgICAgLy8gTGFiZWwgZm9ybWF0IGlzIHR5cGljYWxseTogIk4xIC0gTGFiZWwgQ29sIDEiIG9yICJOMSAtIExhYmVsIgogICAgICAgICAgY29uc3Qgd2VsbElkTWF0Y2ggPSBsYWJlbC5tYXRjaCgvXihbQS1aXVxkKylccyotLyk7CiAgICAgICAgICBpZiAod2VsbElkTWF0Y2gpIHsKICAgICAgICAgICAgY29uc3Qgd2VsbElkID0gd2VsbElkTWF0Y2hbMV07CiAgICAgICAgICAgIGlzQ29udHJvbCA9IGlzQ29udHJvbFdlbGwod2VsbElkKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gVXNlIGxpbmVhciByZWdyZXNzaW9uIGZvciBjb250cm9scywgb3RoZXJ3aXNlIHVzZSBzZWxlY3RlZCByZWdyZXNzaW9uIHR5cGUKICAgICAgICBjb25zdCByZWdyZXNzaW9uVHlwZVRvVXNlID0gaXNDb250cm9sID8gJ2xpbmVhcicgOiByZWdyZXNzaW9uVHlwZTsKICAgICAgICAKICAgICAgICAvLyBGaXQgcmVncmVzc2lvbiBjdXJ2ZQogICAgICAgIGNvbnN0IGZpdEZ1bmN0aW9uID0gZml0UmVncmVzc2lvbkN1cnZlKGRhdGFzZXQuZGF0YSwgcmVncmVzc2lvblR5cGVUb1VzZSwgcG9seW5vbWlhbE9yZGVyKTsKICAgICAgICBpZiAoZml0RnVuY3Rpb24pIHsKICAgICAgICAgIC8vIEdldCB0aW1lIHJhbmdlIGZyb20gZGF0YQogICAgICAgICAgY29uc3QgdGltZXMgPSBkYXRhc2V0LmRhdGEubWFwKHAgPT4gcC54KS5maWx0ZXIodCA9PiB0ICE9PSBudWxsICYmIGlzRmluaXRlKHQpKTsKICAgICAgICAgIGlmICh0aW1lcy5sZW5ndGggPT09IDApIHJldHVybjsKICAgICAgICAgIAogICAgICAgICAgY29uc3QgbWluVGltZSA9IE1hdGgubWluKC4uLnRpbWVzKTsKICAgICAgICAgIGNvbnN0IG1heFRpbWUgPSBNYXRoLm1heCguLi50aW1lcyk7CiAgICAgICAgICAKICAgICAgICAgIC8vIEdlbmVyYXRlIHJlZ3Jlc3Npb24gY3VydmUgcG9pbnRzCiAgICAgICAgICBjb25zdCBudW1Qb2ludHMgPSAxMDA7CiAgICAgICAgICBjb25zdCByZWdyZXNzaW9uRGF0YSA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gbnVtUG9pbnRzOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdCA9IG1pblRpbWUgKyAobWF4VGltZSAtIG1pblRpbWUpICogKGkgLyBudW1Qb2ludHMpOwogICAgICAgICAgICBjb25zdCB5ID0gZml0RnVuY3Rpb24odCk7CiAgICAgICAgICAgIGlmICh5ICE9PSBudWxsICYmIGlzRmluaXRlKHkpKSB7CiAgICAgICAgICAgICAgcmVncmVzc2lvbkRhdGEucHVzaCh7IHg6IHQsIHk6IHkgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIAogICAgICAgICAgaWYgKHJlZ3Jlc3Npb25EYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIHJlZ3Jlc3Npb24gZGF0YXNldCB3aXRoIHNhbWUgY29sb3IgYnV0IGRpZmZlcmVudCBzdHlsZQogICAgICAgICAgICBjb25zdCByZWdyZXNzaW9uQ29sb3IgPSBkYXRhc2V0LmJvcmRlckNvbG9yIHx8IGRhdGFzZXQuYmFja2dyb3VuZENvbG9yIHx8ICJyZ2JhKDEyOCwgMTI4LCAxMjgsIDEuMCkiOwogICAgICAgICAgICByZWdyZXNzaW9uRGF0YXNldHMucHVzaCh7CiAgICAgICAgICAgICAgbGFiZWw6IGAke2RhdGFzZXQubGFiZWx9ICgke3JlZ3Jlc3Npb25UeXBlVG9Vc2V9IGZpdClgLAogICAgICAgICAgICAgIGRhdGE6IHJlZ3Jlc3Npb25EYXRhLAogICAgICAgICAgICAgIGJvcmRlckNvbG9yOiByZWdyZXNzaW9uQ29sb3IsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgIGJvcmRlcldpZHRoOiAyLAogICAgICAgICAgICAgIGJvcmRlckRhc2g6IFs1LCA1XSwgLy8gRGFzaGVkIGxpbmUgZm9yIHJlZ3Jlc3Npb24KICAgICAgICAgICAgICBwb2ludFJhZGl1czogMCwgLy8gTm8gcG9pbnRzIG9uIHJlZ3Jlc3Npb24gbGluZQogICAgICAgICAgICAgIHRlbnNpb246IDAsCiAgICAgICAgICAgICAgZmlsbDogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTdG9yZSBtb25vLWV4cG9uZW50aWFsIHBhcmFtZXRlcnMgZm9yIGluZm8gcGFuZWwKICAgICAgICAgICAgLy8gT25seSBzdG9yZSBpZiB1c2luZyBtb25vLWV4cG9uZW50aWFsIChub3QgZm9yIGNvbnRyb2xzIHdoaWNoIHVzZSBsaW5lYXIpCiAgICAgICAgICAgIGlmIChyZWdyZXNzaW9uVHlwZVRvVXNlID09PSAnbW9uby1leHBvbmVudGlhbCcgJiYgZml0RnVuY3Rpb24ucGFyYW1zKSB7CiAgICAgICAgICAgICAgLy8gUmVtb3ZlIHJlcGxpY2F0ZSBhbmQgZGF0YXNldCBpbmZvIGZyb20gbGFiZWwgZm9yIHJlZ3Jlc3Npb24gbGluZXMKICAgICAgICAgICAgICAvLyBQYXR0ZXJuOiByZW1vdmUgIihYLXBsaWNhdGUsIFkgZGF0YXNldHMsIG1lYW4gwrEgU0UpIiBvciBzaW1pbGFyIHBhdHRlcm5zCiAgICAgICAgICAgICAgbGV0IGNsZWFuTGFiZWwgPSBkYXRhc2V0LmxhYmVsOwogICAgICAgICAgICAgIC8vIFJlbW92ZSBwYXR0ZXJucyBjb250YWluaW5nIHBsaWNhdGUsIGRhdGFzZXRzLCBvciBtZWFuIMKxIFNFIGluIHBhcmVudGhlc2VzCiAgICAgICAgICAgICAgY2xlYW5MYWJlbCA9IGNsZWFuTGFiZWwucmVwbGFjZSgvXHMqXChbXildKig/OnBsaWNhdGV8ZGF0YXNldHN8bWVhblxzKsKxXHMqU0UpW14pXSpcKS9naSwgJycpOwogICAgICAgICAgICAgIC8vIENsZWFuIHVwIGFueSBkb3VibGUgc3BhY2VzIG9yIHRyYWlsaW5nL2xlYWRpbmcgc3BhY2VzCiAgICAgICAgICAgICAgY2xlYW5MYWJlbCA9IGNsZWFuTGFiZWwucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwogICAgICAgICAgICAgIAogICAgICAgICAgICAgIG1vbm9FeHBQYXJhbXMucHVzaCh7CiAgICAgICAgICAgICAgICBsYWJlbDogY2xlYW5MYWJlbCwKICAgICAgICAgICAgICAgIHBhcmFtczogZml0RnVuY3Rpb24ucGFyYW1zLAogICAgICAgICAgICAgICAgY29sb3I6IHJlZ3Jlc3Npb25Db2xvciAvLyBVc2UgdGhlIHNhbWUgY29sb3IgYXMgdGhlIHJlZ3Jlc3Npb24gY3VydmUKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICAKICAgIC8vIEFkZCByZWdyZXNzaW9uIGRhdGFzZXRzIHRvIHRoZSBtYWluIGRhdGFzZXRzIGFycmF5CiAgICBkYXRhc2V0cy5wdXNoKC4uLnJlZ3Jlc3Npb25EYXRhc2V0cyk7CiAgICAKICAgIC8vIFVwZGF0ZSBpbmZvIHBhbmVsIGZvciBtb25vLWV4cG9uZW50aWFsCiAgICBpZiAocmVncmVzc2lvblR5cGUgPT09ICdtb25vLWV4cG9uZW50aWFsJykgewogICAgICB1cGRhdGVNb25vRXhwb25lbnRpYWxJbmZvUGFuZWwobW9ub0V4cFBhcmFtcyk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBpbmZvUGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVncmVzc2lvbi1pbmZvLXBhbmVsIik7CiAgICAgIGlmIChpbmZvUGFuZWwpIHsKICAgICAgICBpbmZvUGFuZWwuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgfQogICAgfQogICAgCiAgICAvLyBSZWNhbGN1bGF0ZSB4LWF4aXMgcmFuZ2UgdG8gaW5jbHVkZSByZWdyZXNzaW9uIGN1cnZlcwogICAgaWYgKGN1dG9mZkJhc2VsaW5lKSB7CiAgICAgIGRhdGFzZXRzLmZvckVhY2goZGF0YXNldCA9PiB7CiAgICAgICAgaWYgKGRhdGFzZXQuZGF0YSAmJiBkYXRhc2V0LmRhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgY29uc3QgdGltZXMgPSBkYXRhc2V0LmRhdGEubWFwKHAgPT4gcC54KS5maWx0ZXIodCA9PiB0ICE9PSBudWxsICYmIGlzRmluaXRlKHQpKTsKICAgICAgICAgIGlmICh0aW1lcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGFzZXRNaW4gPSBNYXRoLm1pbiguLi50aW1lcyk7CiAgICAgICAgICAgIGNvbnN0IGRhdGFzZXRNYXggPSBNYXRoLm1heCguLi50aW1lcyk7CiAgICAgICAgICAgIGlmICh4QXhpc01pbiA9PT0gdW5kZWZpbmVkIHx8IGRhdGFzZXRNaW4gPCB4QXhpc01pbikgewogICAgICAgICAgICAgIHhBeGlzTWluID0gZGF0YXNldE1pbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoeEF4aXNNYXggPT09IHVuZGVmaW5lZCB8fCBkYXRhc2V0TWF4ID4geEF4aXNNYXgpIHsKICAgICAgICAgICAgICB4QXhpc01heCA9IGRhdGFzZXRNYXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KCiAgLy8gRGV0ZXJtaW5lIHktYXhpcyBsYWJlbCBiYXNlZCBvbiBwcm9jZXNzaW5nIHN0ZXBzCiAgbGV0IHlBeGlzTGFiZWwgPSAiRmx1b3Jlc2NlbmNlIChGSSkiOwogIGlmIChub3JtYWxpemVCYXNlbGluZSkgewogICAgaWYgKG5vcm1hbGl6YXRpb25Nb2RlID09PSAnZGVsdGFfZl9vdmVyX2YnKSB7CiAgICAgIHlBeGlzTGFiZWwgPSAizpRGL0YgKE5vcm1hbGl6ZWQpIjsKICAgIH0gZWxzZSB7CiAgICAgIHlBeGlzTGFiZWwgPSAiRi9G4oKAIChOb3JtYWxpemVkKSI7CiAgICB9CiAgfQoKICAvLyBUcmFuc2Zvcm0gZXhpc3RpbmcgY2hhcnQgaW5zdGVhZCBvZiByZWNyZWF0aW5nCiAgaWYgKGNoYXJ0KSB7CiAgICAvLyBDbGVhciBleGlzdGluZyBkYXRhc2V0cwogICAgd2hpbGUgKGNoYXJ0LmRhdGEuZGF0YXNldHMubGVuZ3RoID4gMCkgewogICAgICBjaGFydC5kYXRhLmRhdGFzZXRzLnBvcCgpOwogICAgfQogICAgCiAgICAvLyBBZGQgbmV3IGRhdGFzZXRzCiAgICBkYXRhc2V0cy5mb3JFYWNoKGRhdGFzZXQgPT4gewogICAgICBjaGFydC5kYXRhLmRhdGFzZXRzLnB1c2goZGF0YXNldCk7CiAgICB9KTsKICAgIAogICAgLy8gVXBkYXRlIGNoYXJ0IG9wdGlvbnMKICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLngudGl0bGUudGV4dCA9ICJUaW1lIChzKSI7CiAgICBjaGFydC5vcHRpb25zLnNjYWxlcy55LnRpdGxlLnRleHQgPSB5QXhpc0xhYmVsOwogICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueS5taW4gPSB1bmRlZmluZWQ7CiAgICAKICAgIC8vIEFkanVzdCB4LWF4aXMgcmFuZ2UgYmFzZWQgb24gZmlsdGVyZWQgZGF0YSAoU3RlcCAzKQogICAgaWYgKGN1dG9mZkJhc2VsaW5lICYmIHhBeGlzTWluICE9PSB1bmRlZmluZWQgJiYgeEF4aXNNYXggIT09IHVuZGVmaW5lZCkgewogICAgICAvLyBBZGQgc21hbGwgcGFkZGluZyAoMiUlIG9mIHJhbmdlKSBmb3IgYmV0dGVyIHZpc3VhbGl6YXRpb24KICAgICAgY29uc3QgcGFkZGluZyA9ICh4QXhpc01heCAtIHhBeGlzTWluKSAqIDAuMDI7CiAgICAgIGNoYXJ0Lm9wdGlvbnMuc2NhbGVzLngubWluID0gTWF0aC5tYXgoMCwgeEF4aXNNaW4gLSBwYWRkaW5nKTsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueC5tYXggPSB4QXhpc01heCArIHBhZGRpbmc7CiAgICB9IGVsc2UgewogICAgICAvLyBSZXNldCB0byBhdXRvIGlmIGN1dG9mZiBpcyBkaXNhYmxlZAogICAgICBjaGFydC5vcHRpb25zLnNjYWxlcy54Lm1pbiA9IHVuZGVmaW5lZDsKICAgICAgY2hhcnQub3B0aW9ucy5zY2FsZXMueC5tYXggPSB1bmRlZmluZWQ7CiAgICB9CiAgICAKICAgIC8vIENvdW50IG9ubHkgd2VsbHMgdGhhdCBhcmUgYWN0dWFsbHkgZGlzcGxheWVkIChhY2NvdW50aW5nIGZvciBleGNsdXNpb25zKQogICAgLy8gQ291bnQgdW5pcXVlIHdlbGwgZ3JvdXBzL2RhdGFzZXRzIHRoYXQgYXJlIGFjdHVhbGx5IGRpc3BsYXllZAogICAgY29uc3QgZGlzcGxheWVkV2VsbENvdW50ID0gZGF0YXNldHMubGVuZ3RoOwogICAgY2hhcnQub3B0aW9ucy5wbHVnaW5zLnRpdGxlLnRleHQgPSBgVGltZSBDb3Vyc2UgLSAke2Rpc3BsYXllZFdlbGxDb3VudH0gd2VsbChzKSBzZWxlY3RlZGA7CiAgICBjaGFydC5vcHRpb25zLnBsdWdpbnMubGVnZW5kLmRpc3BsYXkgPSBkYXRhc2V0cy5sZW5ndGggPiAwOwogICAgCiAgICAvLyBGb3JjZSBDaGFydC5qcyB0byB1cGRhdGUgLSB1c2UgdXBkYXRlKCkgd2l0aG91dCBtb2RlIHRvIGVuc3VyZSBwcm9wZXIgcmVkcmF3CiAgICBjaGFydC51cGRhdGUoKTsKICB9IGVsc2UgewogICAgLy8gQ3JlYXRlIG5ldyBjaGFydCBvbmx5IGlmIGl0IGRvZXNuJ3QgZXhpc3QKICAgIGNoYXJ0ID0gbmV3IENoYXJ0KGN0eCwgewogICAgICB0eXBlOiAibGluZSIsCiAgICAgIGRhdGE6IHsKICAgICAgICBkYXRhc2V0czogZGF0YXNldHMKICAgICAgfSwKICAgICAgb3B0aW9uczogewogICAgICAgIHJlc3BvbnNpdmU6IHRydWUsCiAgICAgICAgbWFpbnRhaW5Bc3BlY3RSYXRpbzogZmFsc2UsCiAgICAgICAgcGFyc2luZzogZmFsc2UsCiAgICAgICAgc2NhbGVzOiB7CiAgICAgICAgICAgIHg6IHsgCiAgICAgICAgICAgICAgdHlwZTogImxpbmVhciIsIAogICAgICAgICAgICAgIHRpdGxlOiB7IAogICAgICAgICAgICAgICAgZGlzcGxheTogdHJ1ZSwKICAgICAgICAgICAgICAgIHRleHQ6ICJUaW1lIChzKSIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG1pbjogY3V0b2ZmQmFzZWxpbmUgJiYgeEF4aXNNaW4gIT09IHVuZGVmaW5lZCA/IE1hdGgubWF4KDAsIHhBeGlzTWluIC0gKHhBeGlzTWF4IC0geEF4aXNNaW4pICogMC4wMikgOiB1bmRlZmluZWQsCiAgICAgICAgICAgICAgbWF4OiBjdXRvZmZCYXNlbGluZSAmJiB4QXhpc01heCAhPT0gdW5kZWZpbmVkID8geEF4aXNNYXggKyAoeEF4aXNNYXggLSB4QXhpc01pbikgKiAwLjAyIDogdW5kZWZpbmVkCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHk6IHsgCiAgICAgICAgICAgICAgdGl0bGU6IHsgCiAgICAgICAgICAgICAgICBkaXNwbGF5OiB0cnVlLAogICAgICAgICAgICAgICAgdGV4dDogeUF4aXNMYWJlbAogICAgICAgICAgICB9LAogICAgICAgICAgICBtaW46IHVuZGVmaW5lZAogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcGx1Z2luczogewogICAgICAgICAgbGVnZW5kOiB7CiAgICAgICAgICAgIGRpc3BsYXk6IGRhdGFzZXRzLmxlbmd0aCA+IDAsIC8vIFNob3cgbGVnZW5kIHdoZW4gdGhlcmUgYXJlIGRhdGFzZXRzCiAgICAgICAgICAgIHBvc2l0aW9uOiAidG9wIiwKICAgICAgICAgICAgb25DbGljazogbnVsbCwKICAgICAgICAgICAgbGFiZWxzOiB7CiAgICAgICAgICAgICAgdXNlUG9pbnRTdHlsZTogdHJ1ZSwKICAgICAgICAgICAgICBwYWRkaW5nOiAxNSwKICAgICAgICAgICAgICBmb250OiB7CiAgICAgICAgICAgICAgICBzaXplOiAxMQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZ2VuZXJhdGVMYWJlbHM6IGZ1bmN0aW9uKGNoYXJ0KSB7CiAgICAgICAgICAgICAgICAvLyBDdXN0b20gbGFiZWwgZ2VuZXJhdGlvbiB0byBzaG93IGNvbG9yIGFuZCB3ZWxsIG5hbWUgY2xlYXJseQogICAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWwgPSBDaGFydC5kZWZhdWx0cy5wbHVnaW5zLmxlZ2VuZC5sYWJlbHMuZ2VuZXJhdGVMYWJlbHM7CiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbHMgPSBvcmlnaW5hbC5jYWxsKHRoaXMsIGNoYXJ0KTsKICAgICAgICAgICAgICAgIC8vIExhYmVscyBhbHJlYWR5IGhhdmUgdGhlIGNvcnJlY3QgdGV4dCBmcm9tIGRhdGFzZXQubGFiZWwKICAgICAgICAgICAgICAgIHJldHVybiBsYWJlbHM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgdGl0bGU6IHsKICAgICAgICAgICAgZGlzcGxheTogdHJ1ZSwKICAgICAgICAgICAgdGV4dDogYFRpbWUgQ291cnNlIC0gJHtkYXRhc2V0cy5sZW5ndGh9IHdlbGwocykgc2VsZWN0ZWRgCiAgICAgICAgICB9LAogICAgICAgICAgdG9vbHRpcDogewogICAgICAgICAgICBjYWxsYmFja3M6IHsKICAgICAgICAgICAgICBsYWJlbDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgICAgbGV0IGxhYmVsID0gY29udGV4dC5kYXRhc2V0LmxhYmVsIHx8ICIiOwogICAgICAgICAgICAgICAgaWYgKGxhYmVsKSB7CiAgICAgICAgICAgICAgICAgIGxhYmVsICs9ICI6ICI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY29udGV4dC5wYXJzZWQueSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsYWJlbCArPSBjb250ZXh0LnBhcnNlZC55LnRvRml4ZWQoMik7CiAgICAgICAgICAgICAgICAgIC8vIFNob3cgZXJyb3IgaWYgYXZhaWxhYmxlCiAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0LnJhdyAmJiBjb250ZXh0LnJhdy5lcnJvciAhPT0gdW5kZWZpbmVkICYmIGNvbnRleHQucmF3LmVycm9yICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbGFiZWwgKz0gIiDCsSAiICsgY29udGV4dC5yYXcuZXJyb3IudG9GaXhlZCgyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGxhYmVsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQp9CgovLyBJbml0aWFsaXplIHNldHRpbmdzIGRpc3BsYXkgb24gcGFnZSBsb2FkCnVwZGF0ZUN1cnJlbnRTZXR0aW5nc0Rpc3BsYXkoKTsKLy8gSW5pdGlhbGl6ZSBiYXNlbGluZSBtZXRob2QgcGFyYW1zIHRvIHNob3cvaGlkZSBMT1dFU1MvcG9seW5vbWlhbCBwYXJhbWV0ZXJzIGJhc2VkIG9uIGRlZmF1bHQgc2VsZWN0aW9uCnVwZGF0ZUJhc2VsaW5lTWV0aG9kUGFyYW1zKCk7Ci8vIEluaXRpYWxpemUgcmVncmVzc2lvbiB0eXBlIHBhcmFtcyB0byBzaG93L2hpZGUgaW5mbyBwYW5lbCBiYXNlZCBvbiBkZWZhdWx0IHNlbGVjdGlvbgovLyBTa2lwIGNoYXJ0IHVwZGF0ZSBkdXJpbmcgaW5pdGlhbGl6YXRpb24KdXBkYXRlUmVncmVzc2lvblR5cGVQYXJhbXModHJ1ZSk7Cgpsb2FkRGF0YSgpLmNhdGNoKGVyciA9PiB7CiAgY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIGxvYWQgdmlld2VyX2RhdGEuanNvbjoiLCBlcnIpOwogIGFsZXJ0KCJDb3VsZCBub3QgbG9hZCB2aWV3ZXJfZGF0YS5qc29uLiBEaWQgeW91IHJ1biB0aGUgUHl0aG9uIHNjcmlwdCBpbiB0aGUgc2FtZSBmb2xkZXI/Iik7Cn0pOwo8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+CiIiIgoKCmRlZiB3cml0ZV9odG1sKGh0bWxfcGF0aDogc3RyKToKICAgIGh0bWwgPSBIVE1MX1RFTVBMQVRFICUgewogICAgICAgICJyb3dzIjogUExBVEVfUk9XUywKICAgICAgICAiY29scyI6IFBMQVRFX0NPTFMsCiAgICB9CiAgICB3aXRoIG9wZW4oaHRtbF9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZi53cml0ZShodG1sKQoKCmRlZiB3cml0ZV93ZWJfY29tbWFuZChzY3JpcHRfZGlyOiBzdHIsIHdlYl9kaXI6IHN0cik6CiAgICAiIiIKICAgIENyZWF0ZSBhIGRvdWJsZS1jbGlja2FibGUgJ3dlYi5jb21tYW5kJyBmaWxlIGluIHRoZSBtYWluIGZvbGRlci4KICAgIE9uIG1hY09TLCAuY29tbWFuZCBmaWxlcyBjYW4gYmUgZG91YmxlLWNsaWNrZWQgdG8gcnVuIGluIFRlcm1pbmFsLgogICAgIiIiCiAgICB3ZWJfY29tbWFuZF9wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJ3ZWIuY29tbWFuZCIpCiAgICAKICAgIHdlYl9jb21tYW5kX2NvbnRlbnQgPSBmIiIiIyEvYmluL2Jhc2gKIyBEb3VibGUtY2xpY2thYmxlIHdlYiBzZXJ2ZXIgbGF1bmNoZXIgZm9yIFBsYXRlIFZpZXdlcgojIFRoaXMgZmlsZSBpcyBhdXRvLWdlbmVyYXRlZCBieSBwbGF0ZV92aWV3ZXIucHkKClBPUlQ9ODAwMApXRUJfRElSPSJ7d2ViX2Rpcn0iCgojIENoYW5nZSB0byB3ZWIgZGlyZWN0b3J5CmNkICIkV0VCX0RJUiIgfHwge3sKICAgIGVjaG8gIkVycm9yOiBDb3VsZCBub3QgZmluZCB3ZWIgZGlyZWN0b3J5OiAkV0VCX0RJUiIKICAgIGVjaG8gIlBsZWFzZSBydW4gcGxhdGVfdmlld2VyLnB5IGZpcnN0IHRvIGdlbmVyYXRlIHRoZSB3ZWIgZmlsZXMuIgogICAgcmVhZCAtcCAiUHJlc3MgRW50ZXIgdG8gZXhpdC4uLiIKICAgIGV4aXQgMQp9fQoKIyBDaGVjayBpZiB2aWV3ZXJfZGF0YS5qc29uIGV4aXN0cwppZiBbICEgLWYgInZpZXdlcl9kYXRhLmpzb24iIF07IHRoZW4KICAgIGVjaG8gIldhcm5pbmc6IHZpZXdlcl9kYXRhLmpzb24gbm90IGZvdW5kISIKICAgIGVjaG8gIlBsZWFzZSBydW4gcGxhdGVfdmlld2VyLnB5IGZpcnN0IHRvIGdlbmVyYXRlIHRoZSBkYXRhIGZpbGVzLiIKICAgIGVjaG8gIiIKZmkKClVSTD0iaHR0cDovL2xvY2FsaG9zdDoke3tQT1JUfX0vaW5kZXguaHRtbCIKCmVjaG8gIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKZWNobyAiUGxhdGUgVmlld2VyIFdlYiBTZXJ2ZXIiCmVjaG8gIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKZWNobyAiU2VydmVyIHJ1bm5pbmcgYXQ6ICRVUkwiCmVjaG8gIlNlcnZpbmcgZGlyZWN0b3J5OiAkV0VCX0RJUiIKZWNobyAiIgplY2hvICJQcmVzcyBDdHJsK0MgdG8gc3RvcCB0aGUgc2VydmVyIgplY2hvICI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iCmVjaG8gIiIKCiMgVHJ5IHRvIG9wZW4gYnJvd3NlciBhdXRvbWF0aWNhbGx5IGFmdGVyIGEgc2hvcnQgZGVsYXkKKHNsZWVwIDIgJiYgaWYgY29tbWFuZCAtdiBvcGVuICY+IC9kZXYvbnVsbDsgdGhlbgogICAgb3BlbiAiJFVSTCIgMj4vZGV2L251bGwgJiYgZWNobyAiT3BlbmVkICRVUkwgaW4geW91ciBkZWZhdWx0IGJyb3dzZXIiIHx8IGVjaG8gIlBsZWFzZSBvcGVuICRVUkwgbWFudWFsbHkgaW4geW91ciBicm93c2VyIgplbGlmIGNvbW1hbmQgLXYgeGRnLW9wZW4gJj4gL2Rldi9udWxsOyB0aGVuCiAgICB4ZGctb3BlbiAiJFVSTCIgMj4vZGV2L251bGwgJiYgZWNobyAiT3BlbmVkICRVUkwgaW4geW91ciBkZWZhdWx0IGJyb3dzZXIiIHx8IGVjaG8gIlBsZWFzZSBvcGVuICRVUkwgbWFudWFsbHkgaW4geW91ciBicm93c2VyIgplbHNlCiAgICBlY2hvICJQbGVhc2Ugb3BlbiAkVVJMIG1hbnVhbGx5IGluIHlvdXIgYnJvd3NlciIKZmkpICYKCiMgVHJ5IFB5dGhvbiAzIGZpcnN0LCB0aGVuIFB5dGhvbiAyLCB0aGVuIGV4aXQgd2l0aCBlcnJvcgppZiBjb21tYW5kIC12IHB5dGhvbjMgJj4gL2Rldi9udWxsOyB0aGVuCiAgICBweXRob24zIC1tIGh0dHAuc2VydmVyICIkUE9SVCIKZWxpZiBjb21tYW5kIC12IHB5dGhvbiAmPiAvZGV2L251bGw7IHRoZW4KICAgIHB5dGhvbiAtbSBTaW1wbGVIVFRQU2VydmVyICIkUE9SVCIKZWxzZQogICAgZWNobyAiRXJyb3I6IFB5dGhvbiBub3QgZm91bmQuIFBsZWFzZSBpbnN0YWxsIFB5dGhvbiB0byBydW4gYSBsb2NhbCBzZXJ2ZXIuIgogICAgcmVhZCAtcCAiUHJlc3MgRW50ZXIgdG8gZXhpdC4uLiIKICAgIGV4aXQgMQpmaQoiIiIKICAgIAogICAgd2l0aCBvcGVuKHdlYl9jb21tYW5kX3BhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICBmLndyaXRlKHdlYl9jb21tYW5kX2NvbnRlbnQpCiAgICAKICAgICMgTWFrZSBpdCBleGVjdXRhYmxlCiAgICBvcy5jaG1vZCh3ZWJfY29tbWFuZF9wYXRoLCAwbzc1NSkKICAgIAogICAgcmV0dXJuIHdlYl9jb21tYW5kX3BhdGgKCgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBCYXNlbGluZSBJZGVudGlmaWNhdGlvbiBhbmQgTm9ybWFsaXphdGlvbiBGdW5jdGlvbnMKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgpkZWYgaWRlbnRpZnlfYmFzZWxpbmVfd2luZG93KGRmOiBwZC5EYXRhRnJhbWUsIGJhc2VsaW5lX2VuZF90aW1lOiBmbG9hdCA9IDI0LjApIC0+IERpY3Rbc3RyLCBwZC5EYXRhRnJhbWVdOgogICAgIiIiCiAgICBGb3IgZWFjaCB3ZWxsIGNvbHVtbiwgZGVmaW5lIHRoZSBiYXNlbGluZSB3aW5kb3cgYXMgYWxsIHJvd3Mgd2l0aCBUaW1lX3MgPD0gYmFzZWxpbmVfZW5kX3RpbWUuCiAgICAKICAgIFBhcmFtZXRlcnM6CiAgICAtLS0tLS0tLS0tLQogICAgZGYgOiBwZC5EYXRhRnJhbWUKICAgICAgICBMb25nLWZvcm1hdCBEYXRhRnJhbWUgd2l0aCBjb2x1bW5zIFsncGxhdGVfaWQnLCAnd2VsbCcsICdjb250ZW50JywgJ3RpbWVfcycsICd2YWx1ZSddCiAgICBiYXNlbGluZV9lbmRfdGltZSA6IGZsb2F0CiAgICAgICAgTWF4aW11bSB0aW1lIChpbiBzZWNvbmRzKSBmb3IgYmFzZWxpbmUgd2luZG93IChkZWZhdWx0OiAyNC4wKQogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIERpY3Rbc3RyLCBwZC5EYXRhRnJhbWVdCiAgICAgICAgRGljdGlvbmFyeSBtYXBwaW5nIHdlbGxfaWQgdG8gRGF0YUZyYW1lIGNvbnRhaW5pbmcgb25seSBiYXNlbGluZSBwb2ludHMgZm9yIHRoYXQgd2VsbAogICAgIiIiCiAgICBiYXNlbGluZV9kYXRhID0ge30KICAgIAogICAgZm9yIHdlbGxfaWQsIHdlbGxfZGYgaW4gZGYuZ3JvdXBieSgnd2VsbCcpOgogICAgICAgIGJhc2VsaW5lX21hc2sgPSB3ZWxsX2RmWyd0aW1lX3MnXSA8PSBiYXNlbGluZV9lbmRfdGltZQogICAgICAgIGJhc2VsaW5lX2RhdGFbd2VsbF9pZF0gPSB3ZWxsX2RmW2Jhc2VsaW5lX21hc2tdLmNvcHkoKQogICAgCiAgICByZXR1cm4gYmFzZWxpbmVfZGF0YQoKCmRlZiBmaXRfYmFzZWxpbmUoCiAgICB0aW1lOiBwZC5TZXJpZXMsCiAgICBmbHVvcmVzY2VuY2U6IHBkLlNlcmllcywKICAgIG1ldGhvZDogc3RyID0gJ2xvd2VzcycsCiAgICBmcmFjOiBmbG9hdCA9IDAuNSwKICAgIHBvbHlfb3JkZXI6IGludCA9IDEsCiAgICB3ZWxsX2lkOiBzdHIgPSBOb25lCikgLT4gcGQuU2VyaWVzOgogICAgIiIiCiAgICBGaXQgYSBzbW9vdGggYmFzZWxpbmUgZnVuY3Rpb24gb24gdGhlIGJhc2VsaW5lIHdpbmRvdyBhbmQgZXh0cmFwb2xhdGUgdG8gZnVsbCB0aW1lY291cnNlLgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIHRpbWUgOiBwZC5TZXJpZXMKICAgICAgICBUaW1lIHZhbHVlcyBmb3IgYmFzZWxpbmUgd2luZG93CiAgICBmbHVvcmVzY2VuY2UgOiBwZC5TZXJpZXMKICAgICAgICBGbHVvcmVzY2VuY2UgdmFsdWVzIGZvciBiYXNlbGluZSB3aW5kb3cKICAgIG1ldGhvZCA6IHN0cgogICAgICAgIEJhc2VsaW5lIGZpdHRpbmcgbWV0aG9kOiAnbG93ZXNzJywgJ2NvbnN0YW50Jywgb3IgJ3BvbHlub21pYWwnIChkZWZhdWx0OiAnY29uc3RhbnQnKQogICAgICAgIC0gJ2xvd2Vzcyc6IExvY2FsbHkgV2VpZ2h0ZWQgU2NhdHRlcnBsb3QgU21vb3RoaW5nLiBVc2Ugd2hlbiBiYXNlbGluZSBoYXMgZ3JhZHVhbCBkcmlmdC4KICAgICAgICAgIEJlc3QgZm9yIG5vbi1saW5lYXIgYmFzZWxpbmVzIHdpdGggc21vb3RoIHRyZW5kcy4gRm9ybXVsYTogZyh0KSA9IExPV0VTUyhGX2Jhc2VsaW5lLCB0X2Jhc2VsaW5lLCBmcmFjKQogICAgICAgIC0gJ2NvbnN0YW50JzogQ29uc3RhbnQgbWVhbiBiYXNlbGluZS4gVXNlIHdoZW4gYmFzZWxpbmUgaXMgc3RhYmxlL2ZsYXQuCiAgICAgICAgICBCZXN0IGZvciBzdGFibGUgYmFzZWxpbmVzIHdpdGggbWluaW1hbCBkcmlmdC4gRm9ybXVsYTogZyh0KSA9IG1lYW4oRl9iYXNlbGluZSkKICAgICAgICAtICdwb2x5bm9taWFsJzogUG9seW5vbWlhbCBmaXQuIFVzZSB3aGVuIGJhc2VsaW5lIGhhcyBsaW5lYXIgb3IgcG9seW5vbWlhbCBkcmlmdC4KICAgICAgICAgIEJlc3QgZm9yIGJhc2VsaW5lcyB3aXRoIGtub3duIHBvbHlub21pYWwgdHJlbmRzLiBGb3JtdWxhOiBnKHQpID0gY+KCgCArIGPigoF0ICsgY+KCgnTCsiArIC4uLgogICAgZnJhYyA6IGZsb2F0CiAgICAgICAgRnJhY3Rpb24gb2YgZGF0YSB1c2VkIGZvciBMT1dFU1Mgc21vb3RoaW5nIChkZWZhdWx0OiAwLjUpLiBIaWdoZXIgPSBzbW9vdGhlciwgbG93ZXIgPSBtb3JlIGxvY2FsLgogICAgcG9seV9vcmRlciA6IGludAogICAgICAgIFBvbHlub21pYWwgb3JkZXIgZm9yIHBvbHlub21pYWwgZml0IChkZWZhdWx0OiAxKS4gMSA9IGxpbmVhciwgMiA9IHF1YWRyYXRpYywgZXRjLgogICAgd2VsbF9pZCA6IHN0ciwgb3B0aW9uYWwKICAgICAgICBXZWxsIGlkZW50aWZpZXIgZm9yIG91dHB1dAogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIHBkLlNlcmllcwogICAgICAgIEZpdHRlZCBiYXNlbGluZSB2YWx1ZXMgZm9yIGFsbCB0aW1lcG9pbnRzIChzYW1lIGluZGV4IGFzIGlucHV0IHRpbWUpCiAgICAiIiIKICAgIGltcG9ydCBudW1weSBhcyBucAogICAgCiAgICAjIFJlbW92ZSBOYU4gdmFsdWVzCiAgICB2YWxpZF9tYXNrID0gfihwZC5pc25hKHRpbWUpIHwgcGQuaXNuYShmbHVvcmVzY2VuY2UpKQogICAgdGltZV9jbGVhbiA9IHRpbWVbdmFsaWRfbWFza10udmFsdWVzCiAgICBmbHVvX2NsZWFuID0gZmx1b3Jlc2NlbmNlW3ZhbGlkX21hc2tdLnZhbHVlcwogICAgCiAgICBpZiBsZW4odGltZV9jbGVhbikgPT0gMDoKICAgICAgICAjIE5vIHZhbGlkIGRhdGEsIHJldHVybiBOYU4gc2VyaWVzCiAgICAgICAgcmV0dXJuIHBkLlNlcmllcyhpbmRleD10aW1lLmluZGV4LCBkdHlwZT1mbG9hdCkKICAgIAogICAgaWYgbWV0aG9kID09ICdjb25zdGFudCc6CiAgICAgICAgIyAwdGgtb3JkZXIgKGNvbnN0YW50IG1lYW4gYmFzZWxpbmUpCiAgICAgICAgIyBGb3JtdWxhOiBnKHQpID0gbWVhbihGX2Jhc2VsaW5lKSBmb3IgYWxsIHQKICAgICAgICBiYXNlbGluZV92YWx1ZSA9IG5wLm1lYW4oZmx1b19jbGVhbikKICAgICAgICBiYXNlbGluZV9maXQgPSBwZC5TZXJpZXMoYmFzZWxpbmVfdmFsdWUsIGluZGV4PXRpbWUuaW5kZXgpCiAgICAKICAgIGVsaWYgbWV0aG9kID09ICdwb2x5bm9taWFsJzoKICAgICAgICAjIFBvbHlub21pYWwgZml0IHVzaW5nIG5wLnBvbHlmaXQKICAgICAgICAjIEZvcm11bGE6IGcodCkgPSBj4oKAICsgY+KCgXQgKyBj4oKCdMKyICsgLi4uIChkZXBlbmRpbmcgb24gb3JkZXIpCiAgICAgICAgY29lZmZzID0gbnAucG9seWZpdCh0aW1lX2NsZWFuLCBmbHVvX2NsZWFuLCBwb2x5X29yZGVyKQogICAgICAgIHBvbHlfZnVuYyA9IG5wLnBvbHkxZChjb2VmZnMpCiAgICAgICAgYmFzZWxpbmVfZml0ID0gcGQuU2VyaWVzKHBvbHlfZnVuYyh0aW1lLnZhbHVlcyksIGluZGV4PXRpbWUuaW5kZXgpCiAgICAKICAgIGVsaWYgbWV0aG9kID09ICdsb3dlc3MnOgogICAgICAgICMgTE9XRVNTIHNtb290aGluZwogICAgICAgICMgRm9ybXVsYTogZyh0KSA9IExPV0VTUyhGX2Jhc2VsaW5lLCB0X2Jhc2VsaW5lLCBmcmFjKSBpbnRlcnBvbGF0ZWQvZXh0cmFwb2xhdGVkCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmcm9tIHN0YXRzbW9kZWxzLm5vbnBhcmFtZXRyaWMuc21vb3RoZXJzX2xvd2VzcyBpbXBvcnQgbG93ZXNzCiAgICAgICAgICAgICMgTE9XRVNTIHJldHVybnMgYXJyYXkgb2YgW3gsIHldIHBhaXJzCiAgICAgICAgICAgIHNtb290aGVkID0gbG93ZXNzKGZsdW9fY2xlYW4sIHRpbWVfY2xlYW4sIGZyYWM9ZnJhYywgcmV0dXJuX3NvcnRlZD1GYWxzZSkKICAgICAgICAgICAgIyBJbnRlcnBvbGF0ZS9leHRyYXBvbGF0ZSB0byBmdWxsIHRpbWVjb3Vyc2UKICAgICAgICAgICAgZnJvbSBzY2lweS5pbnRlcnBvbGF0ZSBpbXBvcnQgaW50ZXJwMWQKICAgICAgICAgICAgaW50ZXJwX2Z1bmMgPSBpbnRlcnAxZCgKICAgICAgICAgICAgICAgIHRpbWVfY2xlYW4sIHNtb290aGVkLCAKICAgICAgICAgICAgICAgIGtpbmQ9J2xpbmVhcicsIAogICAgICAgICAgICAgICAgYm91bmRzX2Vycm9yPUZhbHNlLCAKICAgICAgICAgICAgICAgIGZpbGxfdmFsdWU9J2V4dHJhcG9sYXRlJwogICAgICAgICAgICApCiAgICAgICAgICAgIGJhc2VsaW5lX2ZpdCA9IHBkLlNlcmllcyhpbnRlcnBfZnVuYyh0aW1lLnZhbHVlcyksIGluZGV4PXRpbWUuaW5kZXgpCiAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgICAgICByYWlzZSBJbXBvcnRFcnJvcigKICAgICAgICAgICAgICAgICJzdGF0c21vZGVscyBpcyByZXF1aXJlZCBmb3IgTE9XRVNTIGZpdHRpbmcuICIKICAgICAgICAgICAgICAgICJJbnN0YWxsIHdpdGg6IHBpcCBpbnN0YWxsIHN0YXRzbW9kZWxzIgogICAgICAgICAgICApCiAgICAKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIlVua25vd24gYmFzZWxpbmUgbWV0aG9kOiB7bWV0aG9kfS4gQ2hvb3NlIGZyb20gJ2xvd2VzcycsICdjb25zdGFudCcsIG9yICdwb2x5bm9taWFsJyIpCiAgICAKICAgIHJldHVybiBiYXNlbGluZV9maXQKCgpkZWYgZml0X3dlbGxfYmFzZWxpbmVzKAogICAgZGY6IHBkLkRhdGFGcmFtZSwKICAgIGJhc2VsaW5lX2VuZF90aW1lOiBmbG9hdCA9IDI0LjAsCiAgICBtZXRob2Q6IHN0ciA9ICdsb3dlc3MnLAogICAgZnJhYzogZmxvYXQgPSAwLjUsCiAgICBwb2x5X29yZGVyOiBpbnQgPSAxCikgLT4gRGljdFtzdHIsIHBkLlNlcmllc106CiAgICAiIiIKICAgIEZvciBlYWNoIHdlbGwsIGZpdCBhIHNtb290aCBiYXNlbGluZSBmdW5jdGlvbiBvbiB0aGUgYmFzZWxpbmUgd2luZG93IE9OTFksCiAgICB0aGVuIGV4dHJhcG9sYXRlIG92ZXIgdGhlIGZ1bGwgdGltZWNvdXJzZS4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBkZiA6IHBkLkRhdGFGcmFtZQogICAgICAgIExvbmctZm9ybWF0IERhdGFGcmFtZSB3aXRoIGNvbHVtbnMgWydwbGF0ZV9pZCcsICd3ZWxsJywgJ2NvbnRlbnQnLCAndGltZV9zJywgJ3ZhbHVlJ10KICAgIGJhc2VsaW5lX2VuZF90aW1lIDogZmxvYXQKICAgICAgICBNYXhpbXVtIHRpbWUgKGluIHNlY29uZHMpIGZvciBiYXNlbGluZSB3aW5kb3cgKGRlZmF1bHQ6IDI0LjApCiAgICBtZXRob2QgOiBzdHIKICAgICAgICBCYXNlbGluZSBmaXR0aW5nIG1ldGhvZDogJ2xvd2VzcycsICdjb25zdGFudCcsIG9yICdwb2x5bm9taWFsJyAoZGVmYXVsdDogJ2NvbnN0YW50JykKICAgIGZyYWMgOiBmbG9hdAogICAgICAgIEZyYWN0aW9uIG9mIGRhdGEgdXNlZCBmb3IgTE9XRVNTIHNtb290aGluZyAoZGVmYXVsdDogMC41KQogICAgcG9seV9vcmRlciA6IGludAogICAgICAgIFBvbHlub21pYWwgb3JkZXIgZm9yIHBvbHlub21pYWwgZml0IChkZWZhdWx0OiAxKQogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIERpY3Rbc3RyLCBwZC5TZXJpZXNdCiAgICAgICAgRGljdGlvbmFyeSBtYXBwaW5nIHdlbGxfaWQgdG8gU2VyaWVzIG9mIGZpdHRlZCBiYXNlbGluZSB2YWx1ZXMgKGluZGV4ZWQgYnkgdGltZV9zKQogICAgIiIiCiAgICBiYXNlbGluZV9maXRzID0ge30KICAgIAogICAgIyBHZXQgYmFzZWxpbmUgd2luZG93cyBmb3IgZWFjaCB3ZWxsCiAgICBiYXNlbGluZV93aW5kb3dzID0gaWRlbnRpZnlfYmFzZWxpbmVfd2luZG93KGRmLCBiYXNlbGluZV9lbmRfdGltZSkKICAgIAogICAgIyBGaXQgYmFzZWxpbmUgZm9yIGVhY2ggd2VsbAogICAgZm9yIHdlbGxfaWQsIHdlbGxfZGYgaW4gZGYuZ3JvdXBieSgnd2VsbCcpOgogICAgICAgICMgR2V0IGZ1bGwgdGltZWNvdXJzZSBmb3IgdGhpcyB3ZWxsCiAgICAgICAgZnVsbF90aW1lY291cnNlID0gd2VsbF9kZi5zb3J0X3ZhbHVlcygndGltZV9zJykKICAgICAgICAKICAgICAgICAjIEdldCBiYXNlbGluZSB3aW5kb3cKICAgICAgICBiYXNlbGluZV93aW5kb3cgPSBiYXNlbGluZV93aW5kb3dzLmdldCh3ZWxsX2lkKQogICAgICAgIAogICAgICAgIGlmIGJhc2VsaW5lX3dpbmRvdyBpcyBOb25lIG9yIGxlbihiYXNlbGluZV93aW5kb3cpID09IDA6CiAgICAgICAgICAgICMgTm8gYmFzZWxpbmUgZGF0YSwgY3JlYXRlIE5hTiBzZXJpZXMKICAgICAgICAgICAgYmFzZWxpbmVfZml0c1t3ZWxsX2lkXSA9IHBkLlNlcmllcygKICAgICAgICAgICAgICAgIGluZGV4PWZ1bGxfdGltZWNvdXJzZVsndGltZV9zJ10sCiAgICAgICAgICAgICAgICBkdHlwZT1mbG9hdAogICAgICAgICAgICApCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgCiAgICAgICAgIyBTb3J0IGJhc2VsaW5lIHdpbmRvdyBieSB0aW1lCiAgICAgICAgYmFzZWxpbmVfd2luZG93ID0gYmFzZWxpbmVfd2luZG93LnNvcnRfdmFsdWVzKCd0aW1lX3MnKQogICAgICAgIAogICAgICAgICMgRml0IGJhc2VsaW5lIG9uIGJhc2VsaW5lIHdpbmRvdyBvbmx5CiAgICAgICAgYmFzZWxpbmVfZml0ID0gZml0X2Jhc2VsaW5lKAogICAgICAgICAgICBiYXNlbGluZV93aW5kb3dbJ3RpbWVfcyddLAogICAgICAgICAgICBiYXNlbGluZV93aW5kb3dbJ3ZhbHVlJ10sCiAgICAgICAgICAgIG1ldGhvZD1tZXRob2QsCiAgICAgICAgICAgIGZyYWM9ZnJhYywKICAgICAgICAgICAgcG9seV9vcmRlcj1wb2x5X29yZGVyLAogICAgICAgICAgICB3ZWxsX2lkPXdlbGxfaWQKICAgICAgICApCiAgICAgICAgCiAgICAgICAgIyBFeHRyYXBvbGF0ZSB0byBmdWxsIHRpbWVjb3Vyc2UKICAgICAgICAjIEludGVycG9sYXRlIGJhc2VsaW5lIGZpdCB0byBhbGwgdGltZXBvaW50cyBpbiBmdWxsIHRpbWVjb3Vyc2UKICAgICAgICBmcm9tIHNjaXB5LmludGVycG9sYXRlIGltcG9ydCBpbnRlcnAxZAogICAgICAgIAogICAgICAgICMgR2V0IHVuaXF1ZSB0aW1lcG9pbnRzIGZyb20gYmFzZWxpbmUgZml0CiAgICAgICAgYmFzZWxpbmVfdGltZXMgPSBiYXNlbGluZV9maXQuaW5kZXgudmFsdWVzCiAgICAgICAgYmFzZWxpbmVfdmFsdWVzID0gYmFzZWxpbmVfZml0LnZhbHVlcwogICAgICAgIAogICAgICAgICMgQ3JlYXRlIGludGVycG9sYXRpb24gZnVuY3Rpb24KICAgICAgICBpbnRlcnBfZnVuYyA9IGludGVycDFkKAogICAgICAgICAgICBiYXNlbGluZV90aW1lcywKICAgICAgICAgICAgYmFzZWxpbmVfdmFsdWVzLAogICAgICAgICAgICBraW5kPSdsaW5lYXInLAogICAgICAgICAgICBib3VuZHNfZXJyb3I9RmFsc2UsCiAgICAgICAgICAgIGZpbGxfdmFsdWU9J2V4dHJhcG9sYXRlJwogICAgICAgICkKICAgICAgICAKICAgICAgICAjIEludGVycG9sYXRlIHRvIGZ1bGwgdGltZWNvdXJzZSB0aW1lcG9pbnRzCiAgICAgICAgZnVsbF90aW1lcyA9IGZ1bGxfdGltZWNvdXJzZVsndGltZV9zJ10udmFsdWVzCiAgICAgICAgZXh0cmFwb2xhdGVkX2Jhc2VsaW5lID0gcGQuU2VyaWVzKAogICAgICAgICAgICBpbnRlcnBfZnVuYyhmdWxsX3RpbWVzKSwKICAgICAgICAgICAgaW5kZXg9ZnVsbF90aW1lY291cnNlWyd0aW1lX3MnXQogICAgICAgICkKICAgICAgICAKICAgICAgICBiYXNlbGluZV9maXRzW3dlbGxfaWRdID0gZXh0cmFwb2xhdGVkX2Jhc2VsaW5lCiAgICAKICAgIHJldHVybiBiYXNlbGluZV9maXRzCgoKZGVmIG5vcm1hbGl6ZV93ZWxscygKICAgIGRmOiBwZC5EYXRhRnJhbWUsCiAgICBiYXNlbGluZV9maXRzOiBEaWN0W3N0ciwgcGQuU2VyaWVzXSwKICAgIG5vcm1hbGl6YXRpb25fbW9kZTogc3RyID0gJ211bHRpcGxpY2F0aXZlJwopIC0+IHBkLkRhdGFGcmFtZToKICAgICIiIgogICAgRm9yIGVhY2ggd2VsbCBhbmQgZWFjaCB0aW1lcG9pbnQsIGNvbXB1dGUgbm9ybWFsaXplZCBmbHVvcmVzY2VuY2UgdXNpbmcgdGhlIGZpdHRlZCBiYXNlbGluZS4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBkZiA6IHBkLkRhdGFGcmFtZQogICAgICAgIExvbmctZm9ybWF0IERhdGFGcmFtZSB3aXRoIGNvbHVtbnMgWydwbGF0ZV9pZCcsICd3ZWxsJywgJ2NvbnRlbnQnLCAndGltZV9zJywgJ3ZhbHVlJ10KICAgIGJhc2VsaW5lX2ZpdHMgOiBEaWN0W3N0ciwgcGQuU2VyaWVzXQogICAgICAgIERpY3Rpb25hcnkgbWFwcGluZyB3ZWxsX2lkIHRvIFNlcmllcyBvZiBmaXR0ZWQgYmFzZWxpbmUgdmFsdWVzCiAgICBub3JtYWxpemF0aW9uX21vZGUgOiBzdHIKICAgICAgICBOb3JtYWxpemF0aW9uIG1vZGUgKGRlZmF1bHQ6ICdtdWx0aXBsaWNhdGl2ZScpCiAgICAgICAgLSAnZGVsdGFfZl9vdmVyX2YnOiDOlEYvRiBub3JtYWxpemF0aW9uLiBGb3JtdWxhOiBGJyh0KSA9IChGKHQpIC0gZyh0KSkgLyBnKHQpCiAgICAgICAgICBVc2Ugd2hlbiB5b3Ugd2FudCB0byBtZWFzdXJlIHJlbGF0aXZlIGNoYW5nZSBmcm9tIGJhc2VsaW5lLiBCZXN0IGZvciBkZXRlY3RpbmcKICAgICAgICAgIGluY3JlYXNlcy9kZWNyZWFzZXMgcmVsYXRpdmUgdG8gYmFzZWxpbmUuIFZhbHVlcyBjYW4gYmUgbmVnYXRpdmUgKGJlbG93IGJhc2VsaW5lKQogICAgICAgICAgb3IgcG9zaXRpdmUgKGFib3ZlIGJhc2VsaW5lKS4KICAgICAgICAtICdtdWx0aXBsaWNhdGl2ZSc6IE11bHRpcGxpY2F0aXZlIG5vcm1hbGl6YXRpb24uIEZvcm11bGE6IEZfbm9ybSh0KSA9IEYodCkgLyBnKHQpCiAgICAgICAgICBVc2Ugd2hlbiB5b3Ugd2FudCB0byBub3JtYWxpemUgYnkgYmFzZWxpbmUgd2l0aG91dCBzdWJ0cmFjdGluZy4gQmVzdCBmb3IgZm9sZC1jaGFuZ2UKICAgICAgICAgIGFuYWx5c2lzLiBWYWx1ZXMgYXJlIGFsd2F5cyBwb3NpdGl2ZSAocmF0aW8gdG8gYmFzZWxpbmUpLgogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIHBkLkRhdGFGcmFtZQogICAgICAgIERhdGFGcmFtZSB3aXRoIHNhbWUgc2hhcGUgYXMgaW5wdXQgYnV0IHdpdGggbm9ybWFsaXplZCAndmFsdWUnIGNvbHVtbgogICAgIiIiCiAgICBub3JtX2RmID0gZGYuY29weSgpCiAgICBub3JtX3ZhbHVlcyA9IFtdCiAgICAKICAgIGZvciBpZHgsIHJvdyBpbiBkZi5pdGVycm93cygpOgogICAgICAgIHdlbGxfaWQgPSByb3dbJ3dlbGwnXQogICAgICAgIHRpbWVfcyA9IHJvd1sndGltZV9zJ10KICAgICAgICB2YWx1ZSA9IHJvd1sndmFsdWUnXQogICAgICAgIAogICAgICAgICMgR2V0IGJhc2VsaW5lIGZpdCBmb3IgdGhpcyB3ZWxsCiAgICAgICAgYmFzZWxpbmVfc2VyaWVzID0gYmFzZWxpbmVfZml0cy5nZXQod2VsbF9pZCkKICAgICAgICAKICAgICAgICBpZiBiYXNlbGluZV9zZXJpZXMgaXMgTm9uZSBvciBsZW4oYmFzZWxpbmVfc2VyaWVzKSA9PSAwOgogICAgICAgICAgICBub3JtX3ZhbHVlcy5hcHBlbmQobnAubmFuKQogICAgICAgICAgICBjb250aW51ZQogICAgICAgIAogICAgICAgICMgRmluZCBjbG9zZXN0IHRpbWVwb2ludCBpbiBiYXNlbGluZSBzZXJpZXMKICAgICAgICBiYXNlbGluZV90aW1lcyA9IGJhc2VsaW5lX3Nlcmllcy5pbmRleC52YWx1ZXMKICAgICAgICBjbG9zZXN0X2lkeCA9IG5wLmFyZ21pbihucC5hYnMoYmFzZWxpbmVfdGltZXMgLSB0aW1lX3MpKQogICAgICAgIGJhc2VsaW5lX3ZhbHVlID0gYmFzZWxpbmVfc2VyaWVzLmlsb2NbY2xvc2VzdF9pZHhdCiAgICAgICAgCiAgICAgICAgaWYgcGQuaXNuYShiYXNlbGluZV92YWx1ZSkgb3IgYmFzZWxpbmVfdmFsdWUgPT0gMDoKICAgICAgICAgICAgbm9ybV92YWx1ZXMuYXBwZW5kKG5wLm5hbikKICAgICAgICAgICAgY29udGludWUKICAgICAgICAKICAgICAgICAjIEFwcGx5IG5vcm1hbGl6YXRpb24KICAgICAgICBpZiBub3JtYWxpemF0aW9uX21vZGUgPT0gJ2RlbHRhX2Zfb3Zlcl9mJzoKICAgICAgICAgICAgIyDOlEYvRiA9IChGKHQpIC0gZyh0KSkgLyBnKHQpCiAgICAgICAgICAgIG5vcm1fdmFsdWUgPSAodmFsdWUgLSBiYXNlbGluZV92YWx1ZSkgLyBiYXNlbGluZV92YWx1ZQogICAgICAgIGVsaWYgbm9ybWFsaXphdGlvbl9tb2RlID09ICdtdWx0aXBsaWNhdGl2ZSc6CiAgICAgICAgICAgICMgRl9ub3JtKHQpID0gRih0KSAvIGcodCkKICAgICAgICAgICAgbm9ybV92YWx1ZSA9IHZhbHVlIC8gYmFzZWxpbmVfdmFsdWUKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAgICAgZiJVbmtub3duIG5vcm1hbGl6YXRpb25fbW9kZToge25vcm1hbGl6YXRpb25fbW9kZX0uICIKICAgICAgICAgICAgICAgICJDaG9vc2UgZnJvbSAnZGVsdGFfZl9vdmVyX2YnIG9yICdtdWx0aXBsaWNhdGl2ZSciCiAgICAgICAgICAgICkKICAgICAgICAKICAgICAgICBub3JtX3ZhbHVlcy5hcHBlbmQobm9ybV92YWx1ZSkKICAgIAogICAgbm9ybV9kZlsndmFsdWUnXSA9IG5vcm1fdmFsdWVzCiAgICByZXR1cm4gbm9ybV9kZgoKCmRlZiBnZXRfdHJpcGxpY2F0ZV9ncm91cF9jb2xvcigKICAgIGdyb3VwX25hbWU6IHN0ciwKICAgIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lCikgLT4gc3RyOgogICAgIiIiCiAgICBHZXQgdGhlIGNvbG9yIGZvciBhIHRyaXBsaWNhdGUgZ3JvdXAgbmFtZS4KICAgIE1hdGNoZXMgdGhlIGNvbG9yIGFzc2lnbm1lbnQgZnJvbSB0aGUgd2ViIGludGVyZmFjZS4KICAgIAogICAgUGFyYW1ldGVyczoKICAgIC0tLS0tLS0tLS0tCiAgICBncm91cF9uYW1lIDogc3RyCiAgICAgICAgTmFtZSBvZiB0aGUgdHJpcGxpY2F0ZSBncm91cAogICAgY29uZmlnIDogRGljdFtzdHIsIEFueV0sIG9wdGlvbmFsCiAgICAgICAgQ29uZmlndXJhdGlvbiBkaWN0aW9uYXJ5IHdpdGggJ3RyaXBsaWNhdGVfZ3JvdXBzJyBrZXkKICAgIAogICAgUmV0dXJuczoKICAgIC0tLS0tLS0tCiAgICBzdHIKICAgICAgICBIZXggY29sb3IgY29kZSBmb3IgdGhlIGdyb3VwCiAgICAiIiIKICAgIGlmIGNvbmZpZyBpcyBOb25lOgogICAgICAgIHNjcmlwdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgICAgICBjb25maWdfcGF0aCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAicGxhdGVfY29uZmlnLmpzb24iKQogICAgICAgIGNvbmZpZyA9IGxvYWRfY29uZmlnKGNvbmZpZ19wYXRoKQogICAgCiAgICB0cmlwbGljYXRlX2dyb3VwcyA9IGNvbmZpZy5nZXQoInRyaXBsaWNhdGVfZ3JvdXBzIiwgREVGQVVMVF9UUklQTElDQVRFX0dST1VQUykKICAgIAogICAgIyBCdWlsZCBjb2xvciBtYXA6IGdyb3VwIG5hbWUgLT4gY29sb3IgaW5kZXgKICAgIGNvbG9yX21hcCA9IHt9CiAgICBmb3IgaWR4LCBncm91cCBpbiBlbnVtZXJhdGUodHJpcGxpY2F0ZV9ncm91cHMpOgogICAgICAgIG5hbWUgPSBncm91cC5nZXQoIm5hbWUiLCAiIikuc3RyaXAoKQogICAgICAgIGlmIG5hbWUgYW5kIG5hbWUgbm90IGluIGNvbG9yX21hcDoKICAgICAgICAgICAgY29sb3JfbWFwW25hbWVdID0gaWR4CiAgICAKICAgICMgR2V0IGNvbG9yIGluZGV4IGZvciB0aGlzIGdyb3VwCiAgICBub3JtYWxpemVkX25hbWUgPSBncm91cF9uYW1lLnN0cmlwKCkgaWYgZ3JvdXBfbmFtZSBlbHNlICIiCiAgICBjb2xvcl9pZHggPSBjb2xvcl9tYXAuZ2V0KG5vcm1hbGl6ZWRfbmFtZSwgMCkKICAgIAogICAgIyBSZXR1cm4gY29sb3IgZnJvbSBwYWxldHRlIChjeWNsZSBpZiBuZWVkZWQpCiAgICByZXR1cm4gVFJJUExJQ0FURV9DT0xPUlNbY29sb3JfaWR4ICUgbGVuKFRSSVBMSUNBVEVfQ09MT1JTKV0KCgpkZWYgYnVpbGRfY29uZGl0aW9uX21hcCgKICAgIGRmOiBwZC5EYXRhRnJhbWUsCiAgICBjb25maWc6IERpY3Rbc3RyLCBBbnldID0gTm9uZQopIC0+IERpY3Rbc3RyLCBzdHJdOgogICAgIiIiCiAgICBCdWlsZCBhIG1hcHBpbmcgZnJvbSB3ZWxsX2lkIHRvIGNvbmRpdGlvbiBuYW1lLgogICAgCiAgICBVc2VzIHRyaXBsaWNhdGUgZ3JvdXAgbmFtZXMgZnJvbSBjb25maWcgdG8gYXNzaWduIGNvbmRpdGlvbnMuCiAgICBXZWxscyBpbiB0aGUgc2FtZSB0cmlwbGljYXRlIGdyb3VwIChzYW1lIHJvdyBwYXR0ZXJuKSBnZXQgdGhlIHNhbWUgY29uZGl0aW9uLgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIGRmIDogcGQuRGF0YUZyYW1lCiAgICAgICAgTG9uZy1mb3JtYXQgRGF0YUZyYW1lIHdpdGggY29sdW1ucyBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgY29uZmlnIDogRGljdFtzdHIsIEFueV0KICAgICAgICBDb25maWd1cmF0aW9uIGRpY3Rpb25hcnkgd2l0aCAndHJpcGxpY2F0ZV9ncm91cHMnIGtleQogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIERpY3Rbc3RyLCBzdHJdCiAgICAgICAgRGljdGlvbmFyeSBtYXBwaW5nIHdlbGxfaWQgdG8gY29uZGl0aW9uIG5hbWUKICAgICIiIgogICAgaWYgY29uZmlnIGlzIE5vbmU6CiAgICAgICAgc2NyaXB0X2RpciA9IG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmFic3BhdGgoX19maWxlX18pKQogICAgICAgIGNvbmZpZ19wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJwbGF0ZV9jb25maWcuanNvbiIpCiAgICAgICAgY29uZmlnID0gbG9hZF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAKICAgIGNvbmRpdGlvbl9tYXAgPSB7fQogICAgdHJpcGxpY2F0ZV9ncm91cHMgPSBjb25maWcuZ2V0KCJ0cmlwbGljYXRlX2dyb3VwcyIsIERFRkFVTFRfVFJJUExJQ0FURV9HUk9VUFMpCiAgICAKICAgICMgQnVpbGQgbWFwcGluZzogcm93X2xldHRlciAtPiBjb25kaXRpb24gbmFtZQogICAgcm93X3RvX2NvbmRpdGlvbiA9IHt9CiAgICBmb3IgZ3JvdXAgaW4gdHJpcGxpY2F0ZV9ncm91cHM6CiAgICAgICAgZ3JvdXBfbmFtZSA9IGdyb3VwLmdldCgibmFtZSIsICIiKQogICAgICAgIGdyb3VwX3dlbGxzID0gZ3JvdXAuZ2V0KCJ3ZWxscyIsIFtdKQogICAgICAgIGZvciB3ZWxsX3BhdHRlcm4gaW4gZ3JvdXBfd2VsbHM6CiAgICAgICAgICAgICMgRXh0cmFjdCByb3cgbGV0dGVyIGZyb20gd2VsbCBwYXR0ZXJuIChlLmcuLCAiQiIgZnJvbSAiQiIgb3IgIkIxMyIpCiAgICAgICAgICAgIHJvd19sZXR0ZXIgPSB3ZWxsX3BhdHRlcm5bMF0gaWYgd2VsbF9wYXR0ZXJuIGFuZCB3ZWxsX3BhdHRlcm5bMF0uaXNhbHBoYSgpIGVsc2UgIiIKICAgICAgICAgICAgaWYgcm93X2xldHRlcjoKICAgICAgICAgICAgICAgIHJvd190b19jb25kaXRpb25bcm93X2xldHRlcl0gPSBncm91cF9uYW1lCiAgICAKICAgICMgTWFwIGVhY2ggd2VsbCB0byBpdHMgY29uZGl0aW9uIGJhc2VkIG9uIHJvdyBsZXR0ZXIKICAgIGZvciB3ZWxsX2lkIGluIGRmWyd3ZWxsJ10udW5pcXVlKCk6CiAgICAgICAgaWYgd2VsbF9pZCBhbmQgbGVuKHdlbGxfaWQpID4gMDoKICAgICAgICAgICAgcm93X2xldHRlciA9IHdlbGxfaWRbMF0gaWYgd2VsbF9pZFswXS5pc2FscGhhKCkgZWxzZSAiIgogICAgICAgICAgICBjb25kaXRpb24gPSByb3dfdG9fY29uZGl0aW9uLmdldChyb3dfbGV0dGVyLCB3ZWxsX2lkKSAgIyBEZWZhdWx0IHRvIHdlbGxfaWQgaWYgbm90IGZvdW5kCiAgICAgICAgICAgIGNvbmRpdGlvbl9tYXBbd2VsbF9pZF0gPSBjb25kaXRpb24KICAgIAogICAgcmV0dXJuIGNvbmRpdGlvbl9tYXAKCgpkZWYgY29tcHV0ZV9jb25kaXRpb25fc3RhdGlzdGljcygKICAgIG5vcm1fZGY6IHBkLkRhdGFGcmFtZSwKICAgIGNvbmRpdGlvbl9tYXA6IERpY3Rbc3RyLCBzdHJdCikgLT4gcGQuRGF0YUZyYW1lOgogICAgIiIiCiAgICBHcm91cCB3ZWxscyBieSBjb25kaXRpb24gYW5kIGNvbXB1dGUgbWVhbiDCsSBTRU0gZm9yIGVhY2ggY29uZGl0aW9uIGFuZCB0aW1lcG9pbnQuCiAgICAKICAgIFBhcmFtZXRlcnM6CiAgICAtLS0tLS0tLS0tLQogICAgbm9ybV9kZiA6IHBkLkRhdGFGcmFtZQogICAgICAgIE5vcm1hbGl6ZWQgRGF0YUZyYW1lIHdpdGggY29sdW1ucyBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgY29uZGl0aW9uX21hcCA6IERpY3Rbc3RyLCBzdHJdCiAgICAgICAgRGljdGlvbmFyeSBtYXBwaW5nIHdlbGxfaWQgdG8gY29uZGl0aW9uIG5hbWUKICAgIAogICAgUmV0dXJuczoKICAgIC0tLS0tLS0tCiAgICBwZC5EYXRhRnJhbWUKICAgICAgICBUaWR5IERhdGFGcmFtZSB3aXRoIGNvbHVtbnM6IFsnVGltZV9zJywgJ2NvbmRpdGlvbicsICdtZWFuJywgJ3NkJywgJ3NlbScsICduJ10KICAgICIiIgogICAgaW1wb3J0IG51bXB5IGFzIG5wCiAgICAKICAgICMgQWRkIGNvbmRpdGlvbiBjb2x1bW4KICAgIG5vcm1fZGYgPSBub3JtX2RmLmNvcHkoKQogICAgbm9ybV9kZlsnY29uZGl0aW9uJ10gPSBub3JtX2RmWyd3ZWxsJ10ubWFwKGNvbmRpdGlvbl9tYXApCiAgICAKICAgICMgR3JvdXAgYnkgY29uZGl0aW9uIGFuZCB0aW1lCiAgICByZXN1bHRzID0gW10KICAgIAogICAgZm9yIChjb25kaXRpb24sIHRpbWVfcyksIGdyb3VwIGluIG5vcm1fZGYuZ3JvdXBieShbJ2NvbmRpdGlvbicsICd0aW1lX3MnXSk6CiAgICAgICAgdmFsdWVzID0gZ3JvdXBbJ3ZhbHVlJ10uZHJvcG5hKCkudmFsdWVzCiAgICAgICAgCiAgICAgICAgaWYgbGVuKHZhbHVlcykgPT0gMDoKICAgICAgICAgICAgY29udGludWUKICAgICAgICAKICAgICAgICBuID0gbGVuKHZhbHVlcykKICAgICAgICBtZWFuID0gbnAubWVhbih2YWx1ZXMpCiAgICAgICAgc2QgPSBucC5zdGQodmFsdWVzLCBkZG9mPTEpICAjIFNhbXBsZSBzdGFuZGFyZCBkZXZpYXRpb24KICAgICAgICBzZW0gPSBzZCAvIG5wLnNxcnQobikgaWYgbiA+IDAgZWxzZSBucC5uYW4KICAgICAgICAKICAgICAgICByZXN1bHRzLmFwcGVuZCh7CiAgICAgICAgICAgICdUaW1lX3MnOiB0aW1lX3MsCiAgICAgICAgICAgICdjb25kaXRpb24nOiBjb25kaXRpb24sCiAgICAgICAgICAgICdtZWFuJzogbWVhbiwKICAgICAgICAgICAgJ3NkJzogc2QsCiAgICAgICAgICAgICdzZW0nOiBzZW0sCiAgICAgICAgICAgICduJzogbgogICAgICAgIH0pCiAgICAKICAgIHN0YXRzX2RmID0gcGQuRGF0YUZyYW1lKHJlc3VsdHMpCiAgICByZXR1cm4gc3RhdHNfZGYuc29ydF92YWx1ZXMoWydjb25kaXRpb24nLCAnVGltZV9zJ10pLnJlc2V0X2luZGV4KGRyb3A9VHJ1ZSkKCgpkZWYgcGxvdF90aW1lY291cnNlKAogICAgc3RhdHNfZGY6IHBkLkRhdGFGcmFtZSwKICAgIGNvbmRpdGlvbnM6IExpc3Rbc3RyXSA9IE5vbmUsCiAgICBmaWdzaXplOiB0dXBsZSA9ICgxMCwgNiksCiAgICBzYXZlX3BhdGg6IHN0ciA9IE5vbmUsCiAgICBjb25maWc6IERpY3Rbc3RyLCBBbnldID0gTm9uZQopOgogICAgIiIiCiAgICBHZW5lcmF0ZSB0aW1lLWNvdXJzZSBwbG90cyB3aXRoIG1lYW4gwrEgU0VNIGZvciBlYWNoIGNvbmRpdGlvbi4KICAgIFVzZXMgdHJpcGxpY2F0ZSBncm91cCBjb2xvcnMgdG8gbWF0Y2ggdGhlIHdlYiBpbnRlcmZhY2UuCiAgICAKICAgIFBhcmFtZXRlcnM6CiAgICAtLS0tLS0tLS0tLQogICAgc3RhdHNfZGYgOiBwZC5EYXRhRnJhbWUKICAgICAgICBTdGF0aXN0aWNzIERhdGFGcmFtZSB3aXRoIGNvbHVtbnMgWydUaW1lX3MnLCAnY29uZGl0aW9uJywgJ21lYW4nLCAnc2VtJ10KICAgIGNvbmRpdGlvbnMgOiBMaXN0W3N0cl0sIG9wdGlvbmFsCiAgICAgICAgU3Vic2V0IG9mIGNvbmRpdGlvbnMgdG8gcGxvdC4gSWYgTm9uZSwgcGxvdHMgYWxsIGNvbmRpdGlvbnMuCiAgICBmaWdzaXplIDogdHVwbGUKICAgICAgICBGaWd1cmUgc2l6ZSAod2lkdGgsIGhlaWdodCkgaW4gaW5jaGVzIChkZWZhdWx0OiAoMTAsIDYpKQogICAgc2F2ZV9wYXRoIDogc3RyLCBvcHRpb25hbAogICAgICAgIFBhdGggdG8gc2F2ZSB0aGUgZmlndXJlLiBJZiBOb25lLCBkaXNwbGF5cyB0aGUgcGxvdC4KICAgIGNvbmZpZyA6IERpY3Rbc3RyLCBBbnldLCBvcHRpb25hbAogICAgICAgIENvbmZpZ3VyYXRpb24gZGljdGlvbmFyeSB3aXRoICd0cmlwbGljYXRlX2dyb3Vwcycga2V5CiAgICAiIiIKICAgIGltcG9ydCBtYXRwbG90bGliLnB5cGxvdCBhcyBwbHQKICAgIAogICAgaWYgY29uZmlnIGlzIE5vbmU6CiAgICAgICAgc2NyaXB0X2RpciA9IG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmFic3BhdGgoX19maWxlX18pKQogICAgICAgIGNvbmZpZ19wYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsICJwbGF0ZV9jb25maWcuanNvbiIpCiAgICAgICAgY29uZmlnID0gbG9hZF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAKICAgIGlmIGNvbmRpdGlvbnMgaXMgTm9uZToKICAgICAgICBjb25kaXRpb25zID0gc3RhdHNfZGZbJ2NvbmRpdGlvbiddLnVuaXF1ZSgpCiAgICAKICAgIGZpZywgYXggPSBwbHQuc3VicGxvdHMoZmlnc2l6ZT1maWdzaXplKQogICAgCiAgICBmb3IgaWR4LCBjb25kaXRpb24gaW4gZW51bWVyYXRlKGNvbmRpdGlvbnMpOgogICAgICAgIGNvbmRfZGF0YSA9IHN0YXRzX2RmW3N0YXRzX2RmWydjb25kaXRpb24nXSA9PSBjb25kaXRpb25dLnNvcnRfdmFsdWVzKCdUaW1lX3MnKQogICAgICAgIAogICAgICAgIGlmIGxlbihjb25kX2RhdGEpID09IDA6CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgCiAgICAgICAgdGltZXMgPSBjb25kX2RhdGFbJ1RpbWVfcyddLnZhbHVlcwogICAgICAgIG1lYW5zID0gY29uZF9kYXRhWydtZWFuJ10udmFsdWVzCiAgICAgICAgc2VtcyA9IGNvbmRfZGF0YVsnc2VtJ10udmFsdWVzCiAgICAgICAgCiAgICAgICAgIyBHZXQgY29sb3IgZm9yIHRoaXMgY29uZGl0aW9uICh0cmlwbGljYXRlIGdyb3VwIG5hbWUpCiAgICAgICAgIyBVc2UgdHJpcGxpY2F0ZSBncm91cCBjb2xvciBpZiBjb25kaXRpb24gbWF0Y2hlcyBhIGdyb3VwIG5hbWUsIG90aGVyd2lzZSB1c2UgZGVmYXVsdCBwYWxldHRlCiAgICAgICAgY29sb3IgPSBnZXRfdHJpcGxpY2F0ZV9ncm91cF9jb2xvcihjb25kaXRpb24sIGNvbmZpZykKICAgICAgICAKICAgICAgICAjIFBsb3QgbGluZQogICAgICAgIGF4LnBsb3QodGltZXMsIG1lYW5zLCBsYWJlbD1jb25kaXRpb24sIGNvbG9yPWNvbG9yLCBsaW5ld2lkdGg9MikKICAgICAgICAKICAgICAgICAjIFBsb3QgZXJyb3IgYmFycwogICAgICAgIGF4LmVycm9yYmFyKAogICAgICAgICAgICB0aW1lcywgbWVhbnMsIHllcnI9c2VtcywKICAgICAgICAgICAgY29sb3I9Y29sb3IsCiAgICAgICAgICAgIGFscGhhPTAuNSwKICAgICAgICAgICAgY2Fwc2l6ZT0zLAogICAgICAgICAgICBjYXB0aGljaz0xLAogICAgICAgICAgICBlbGluZXdpZHRoPTEKICAgICAgICApCiAgICAKICAgIGF4LnNldF94bGFiZWwoJ1RpbWUgKHMpJywgZm9udHNpemU9MTIpCiAgICBheC5zZXRfeWxhYmVsKCfOlEYvRicsIGZvbnRzaXplPTEyKQogICAgYXguc2V0X3RpdGxlKCdUaW1lIENvdXJzZSBieSBDb25kaXRpb24nLCBmb250c2l6ZT0xNCkKICAgIGF4LmxlZ2VuZChsb2M9J2Jlc3QnLCBmb250c2l6ZT0xMCkKICAgIGF4LmdyaWQoVHJ1ZSwgYWxwaGE9MC4zKQogICAgCiAgICBwbHQudGlnaHRfbGF5b3V0KCkKICAgIAogICAgaWYgc2F2ZV9wYXRoOgogICAgICAgIHBsdC5zYXZlZmlnKHNhdmVfcGF0aCwgZHBpPTMwMCwgYmJveF9pbmNoZXM9J3RpZ2h0JykKICAgICAgICBwcmludChmIlBsb3Qgc2F2ZWQgdG8ge3NhdmVfcGF0aH0iKQogICAgZWxzZToKICAgICAgICBwbHQuc2hvdygpCiAgICAKICAgIHBsdC5jbG9zZSgpCgoKZGVmIHByaW50X2Jhc2VsaW5lX29wdGlvbnMoKToKICAgICIiIgogICAgUHJpbnQgZGVzY3JpcHRpb25zIG9mIGJhc2VsaW5lIGZpdHRpbmcgYW5kIG5vcm1hbGl6YXRpb24gb3B0aW9ucy4KICAgICIiIgogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgiQkFTRUxJTkUgRklUVElORyBPUFRJT05TIikKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoIlxuMS4gTE9XRVNTIChMb2NhbGx5IFdlaWdodGVkIFNjYXR0ZXJwbG90IFNtb290aGluZykiKQogICAgcHJpbnQoIiAgIEZvcm11bGE6IGcodCkgPSBMT1dFU1MoRl9iYXNlbGluZSwgdF9iYXNlbGluZSwgZnJhYykiKQogICAgcHJpbnQoIiAgIFdoZW4gdG8gdXNlOiBCYXNlbGluZSBoYXMgZ3JhZHVhbCBkcmlmdCBvciBub24tbGluZWFyIHRyZW5kcyIpCiAgICBwcmludCgiICAgQmVzdCBmb3I6IE5vbi1saW5lYXIgYmFzZWxpbmVzIHdpdGggc21vb3RoIHRyZW5kcyIpCiAgICBwcmludCgiICAgUGFyYW1ldGVyczoiKQogICAgcHJpbnQoIiAgICAgLSBmcmFjOiBGcmFjdGlvbiBvZiBkYXRhIHVzZWQgZm9yIHNtb290aGluZyAoZGVmYXVsdDogMC41KSIpCiAgICBwcmludCgiICAgICAgICogSGlnaGVyIGZyYWMgKDAuNy0wLjkpID0gc21vb3RoZXIsIG1vcmUgZ2xvYmFsIGZpdCIpCiAgICBwcmludCgiICAgICAgICogTG93ZXIgZnJhYyAoMC4yLTAuNCkgPSBtb3JlIGxvY2FsLCBmb2xsb3dzIGRhdGEgY2xvc2VseSIpCiAgICBwcmludCgpCiAgICBwcmludCgiMi4gQ09OU1RBTlQgKDB0aC1vcmRlciBwb2x5bm9taWFsKSIpCiAgICBwcmludCgiICAgRm9ybXVsYTogZyh0KSA9IG1lYW4oRl9iYXNlbGluZSkgZm9yIGFsbCB0IikKICAgIHByaW50KCIgICBXaGVuIHRvIHVzZTogQmFzZWxpbmUgaXMgc3RhYmxlL2ZsYXQgd2l0aCBtaW5pbWFsIGRyaWZ0IikKICAgIHByaW50KCIgICBCZXN0IGZvcjogU3RhYmxlIGJhc2VsaW5lcyB3aXRoIG5vIHRpbWUtZGVwZW5kZW50IHRyZW5kcyIpCiAgICBwcmludCgiICAgUGFyYW1ldGVyczogTm9uZSIpCiAgICBwcmludCgpCiAgICBwcmludCgiMy4gUE9MWU5PTUlBTCAoMXN0LW9yZGVyIG9yIGhpZ2hlcikiKQogICAgcHJpbnQoIiAgIEZvcm11bGE6IGcodCkgPSBj4oKAICsgY+KCgXQgKyBj4oKCdMKyICsgLi4uIikKICAgIHByaW50KCIgICBXaGVuIHRvIHVzZTogQmFzZWxpbmUgaGFzIGxpbmVhciBvciBwb2x5bm9taWFsIGRyaWZ0IikKICAgIHByaW50KCIgICBCZXN0IGZvcjogQmFzZWxpbmVzIHdpdGgga25vd24gcG9seW5vbWlhbCB0cmVuZHMiKQogICAgcHJpbnQoIiAgIFBhcmFtZXRlcnM6IikKICAgIHByaW50KCIgICAgIC0gcG9seV9vcmRlcjogUG9seW5vbWlhbCBvcmRlciAoZGVmYXVsdDogMSA9IGxpbmVhcikiKQogICAgcHJpbnQoIiAgICAgICAqIE9yZGVyIDE6IExpbmVhciBkcmlmdCAoZyh0KSA9IGPigoAgKyBj4oKBdCkiKQogICAgcHJpbnQoIiAgICAgICAqIE9yZGVyIDI6IFF1YWRyYXRpYyBkcmlmdCAoZyh0KSA9IGPigoAgKyBj4oKBdCArIGPigoJ0wrIpIikKICAgIHByaW50KCIgICAgICAgKiBIaWdoZXIgb3JkZXJzOiBNb3JlIGNvbXBsZXggdHJlbmRzIikKICAgIHByaW50KCkKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoIk5PUk1BTElaQVRJT04gT1BUSU9OUyIpCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KCJcbjEuIERFTFRBX0ZfT1ZFUl9GICjOlEYvRikiKQogICAgcHJpbnQoIiAgIEZvcm11bGE6IEYnKHQpID0gKEYodCkgLSBnKHQpKSAvIGcodCkiKQogICAgcHJpbnQoIiAgIFdoZW4gdG8gdXNlOiBNZWFzdXJlIHJlbGF0aXZlIGNoYW5nZSBmcm9tIGJhc2VsaW5lIikKICAgIHByaW50KCIgICBCZXN0IGZvcjogRGV0ZWN0aW5nIGluY3JlYXNlcy9kZWNyZWFzZXMgcmVsYXRpdmUgdG8gYmFzZWxpbmUiKQogICAgcHJpbnQoIiAgIEludGVycHJldGF0aW9uOiIpCiAgICBwcmludCgiICAgICAqIEYnKHQpID0gMDogTm8gY2hhbmdlIGZyb20gYmFzZWxpbmUiKQogICAgcHJpbnQoIiAgICAgKiBGJyh0KSA+IDA6IEluY3JlYXNlIGFib3ZlIGJhc2VsaW5lIChlLmcuLCAwLjUgPSA1MCUgaW5jcmVhc2UpIikKICAgIHByaW50KCIgICAgICogRicodCkgPCAwOiBEZWNyZWFzZSBiZWxvdyBiYXNlbGluZSAoZS5nLiwgLTAuMyA9IDMwJSBkZWNyZWFzZSkiKQogICAgcHJpbnQoIiAgIFZhbHVlcyBjYW4gYmUgbmVnYXRpdmUgKGJlbG93IGJhc2VsaW5lKSBvciBwb3NpdGl2ZSAoYWJvdmUgYmFzZWxpbmUpIikKICAgIHByaW50KCkKICAgIHByaW50KCIyLiBNVUxUSVBMSUNBVElWRSIpCiAgICBwcmludCgiICAgRm9ybXVsYTogRl9ub3JtKHQpID0gRih0KSAvIGcodCkiKQogICAgcHJpbnQoIiAgIFdoZW4gdG8gdXNlOiBOb3JtYWxpemUgYnkgYmFzZWxpbmUgd2l0aG91dCBzdWJ0cmFjdGluZyIpCiAgICBwcmludCgiICAgQmVzdCBmb3I6IEZvbGQtY2hhbmdlIGFuYWx5c2lzIikKICAgIHByaW50KCIgICBJbnRlcnByZXRhdGlvbjoiKQogICAgcHJpbnQoIiAgICAgKiBGX25vcm0odCkgPSAxLjA6IE5vIGNoYW5nZSBmcm9tIGJhc2VsaW5lIikKICAgIHByaW50KCIgICAgICogRl9ub3JtKHQpID0gMi4wOiAyLWZvbGQgaW5jcmVhc2UgKDEwMCUgaW5jcmVhc2UpIikKICAgIHByaW50KCIgICAgICogRl9ub3JtKHQpID0gMC41OiAyLWZvbGQgZGVjcmVhc2UgKDUwJSBvZiBiYXNlbGluZSkiKQogICAgcHJpbnQoIiAgIFZhbHVlcyBhcmUgYWx3YXlzIHBvc2l0aXZlIChyYXRpbyB0byBiYXNlbGluZSkiKQogICAgcHJpbnQoKQogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgiU1RBVElTVElDUyBDT01QVVRBVElPTiIpCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KCJcbkZvciBlYWNoIGNvbmRpdGlvbiBhbmQgdGltZXBvaW50LCB0aGUgZm9sbG93aW5nIHN0YXRpc3RpY3MgYXJlIGNvbXB1dGVkOiIpCiAgICBwcmludCgiICBNZWFuOiDOvCh0KSA9ICgxL24pICogzqMgRicodCkiKQogICAgcHJpbnQoIiAgICBBdmVyYWdlIG5vcm1hbGl6ZWQgdmFsdWUgYWNyb3NzIGFsbCB3ZWxscyBpbiB0aGUgY29uZGl0aW9uIikKICAgIHByaW50KCkKICAgIHByaW50KCIgIFNEOiDPgyh0KSA9IHNxcnQozqMoRicodCkgLSDOvCh0KSnCsiAvIChuLTEpKSIpCiAgICBwcmludCgiICAgIFNhbXBsZSBzdGFuZGFyZCBkZXZpYXRpb24gKGRkb2Y9MSkgYWNyb3NzIHdlbGxzIikKICAgIHByaW50KCkKICAgIHByaW50KCIgIFNFTTogU0VNKHQpID0gz4ModCkgLyBzcXJ0KG4pIikKICAgIHByaW50KCIgICAgU3RhbmRhcmQgZXJyb3Igb2YgdGhlIG1lYW4gPSBTRCAvIHNxcnQobl93ZWxscykiKQogICAgcHJpbnQoIiAgICBOb3RlOiBTRU0gaXMgY29tcHV0ZWQgYWNyb3NzIHdlbGxzLCBub3QgcHJvcGFnYXRlZCBmcm9tIGJhc2VsaW5lIGVycm9yIikKICAgIHByaW50KCkKICAgIHByaW50KCI9IiAqIDcwKQogICAgcHJpbnQoKQoKCmRlZiBwcm9jZXNzX2Jhc2VsaW5lX25vcm1hbGl6YXRpb24oCiAgICBkZjogcGQuRGF0YUZyYW1lLAogICAgYmFzZWxpbmVfZW5kX3RpbWU6IGZsb2F0ID0gMjQuMCwKICAgIGJhc2VsaW5lX21ldGhvZDogc3RyID0gJ2NvbnN0YW50JywKICAgIGJhc2VsaW5lX2ZyYWM6IGZsb2F0ID0gMC41LAogICAgYmFzZWxpbmVfcG9seV9vcmRlcjogaW50ID0gMSwKICAgIG5vcm1hbGl6YXRpb25fbW9kZTogc3RyID0gJ211bHRpcGxpY2F0aXZlJywKICAgIGNvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lLAogICAgb3V0cHV0X2Rpcjogc3RyID0gTm9uZQopIC0+IHR1cGxlOgogICAgIiIiCiAgICBDb21wbGV0ZSBwaXBlbGluZTogYmFzZWxpbmUgaWRlbnRpZmljYXRpb24sIGZpdHRpbmcsIG5vcm1hbGl6YXRpb24sIGFuZCBzdGF0aXN0aWNzLgogICAgCiAgICBQYXJhbWV0ZXJzOgogICAgLS0tLS0tLS0tLS0KICAgIGRmIDogcGQuRGF0YUZyYW1lCiAgICAgICAgTG9uZy1mb3JtYXQgRGF0YUZyYW1lIHdpdGggY29sdW1ucyBbJ3BsYXRlX2lkJywgJ3dlbGwnLCAnY29udGVudCcsICd0aW1lX3MnLCAndmFsdWUnXQogICAgYmFzZWxpbmVfZW5kX3RpbWUgOiBmbG9hdAogICAgICAgIE1heGltdW0gdGltZSAoaW4gc2Vjb25kcykgZm9yIGJhc2VsaW5lIHdpbmRvdyAoZGVmYXVsdDogMjQuMCkKICAgIGJhc2VsaW5lX21ldGhvZCA6IHN0cgogICAgICAgIEJhc2VsaW5lIGZpdHRpbmcgbWV0aG9kOiAnbG93ZXNzJywgJ2NvbnN0YW50Jywgb3IgJ3BvbHlub21pYWwnIChkZWZhdWx0OiAnY29uc3RhbnQnKQogICAgYmFzZWxpbmVfZnJhYyA6IGZsb2F0CiAgICAgICAgRnJhY3Rpb24gb2YgZGF0YSB1c2VkIGZvciBMT1dFU1Mgc21vb3RoaW5nIChkZWZhdWx0OiAwLjUpCiAgICBiYXNlbGluZV9wb2x5X29yZGVyIDogaW50CiAgICAgICAgUG9seW5vbWlhbCBvcmRlciBmb3IgcG9seW5vbWlhbCBmaXQgKGRlZmF1bHQ6IDEpCiAgICBub3JtYWxpemF0aW9uX21vZGUgOiBzdHIKICAgICAgICBOb3JtYWxpemF0aW9uIG1vZGU6ICdkZWx0YV9mX292ZXJfZicgb3IgJ211bHRpcGxpY2F0aXZlJyAoZGVmYXVsdDogJ211bHRpcGxpY2F0aXZlJykKICAgIGNvbmZpZyA6IERpY3Rbc3RyLCBBbnldLCBvcHRpb25hbAogICAgICAgIENvbmZpZ3VyYXRpb24gZGljdGlvbmFyeS4gSWYgTm9uZSwgbG9hZHMgZnJvbSBwbGF0ZV9jb25maWcuanNvbgogICAgb3V0cHV0X2RpciA6IHN0ciwgb3B0aW9uYWwKICAgICAgICBEaXJlY3RvcnkgdG8gc2F2ZSBvdXRwdXRzLiBJZiBOb25lLCB1c2VzIGN1cnJlbnQgZGlyZWN0b3J5LgogICAgCiAgICBSZXR1cm5zOgogICAgLS0tLS0tLS0KICAgIHR1cGxlCiAgICAgICAgKG5vcm1fZGYsIHN0YXRzX2RmLCBiYXNlbGluZV9maXRzKQogICAgICAgIC0gbm9ybV9kZjogTm9ybWFsaXplZCBEYXRhRnJhbWUKICAgICAgICAtIHN0YXRzX2RmOiBDb25kaXRpb24gc3RhdGlzdGljcyBEYXRhRnJhbWUKICAgICAgICAtIGJhc2VsaW5lX2ZpdHM6IERpY3Rpb25hcnkgb2YgYmFzZWxpbmUgZml0cyBwZXIgd2VsbAogICAgIiIiCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KCJCQVNFTElORSBJREVOVElGSUNBVElPTiBBTkQgTk9STUFMSVpBVElPTiBQSVBFTElORSIpCiAgICBwcmludCgiPSIgKiA3MCkKICAgIHByaW50KGYiXG5DdXJyZW50IFNldHRpbmdzOiIpCiAgICBwcmludChmIiAgQmFzZWxpbmUgd2luZG93OiBUaW1lX3MgPD0ge2Jhc2VsaW5lX2VuZF90aW1lfSBzIikKICAgIHByaW50KGYiICBCYXNlbGluZSBtZXRob2Q6IHtiYXNlbGluZV9tZXRob2R9IikKICAgIGlmIGJhc2VsaW5lX21ldGhvZCA9PSAnbG93ZXNzJzoKICAgICAgICBwcmludChmIiAgICBMT1dFU1Mgc21vb3RoaW5nIGZyYWN0aW9uIChmcmFjKToge2Jhc2VsaW5lX2ZyYWN9IikKICAgIGVsaWYgYmFzZWxpbmVfbWV0aG9kID09ICdwb2x5bm9taWFsJzoKICAgICAgICBwcmludChmIiAgICBQb2x5bm9taWFsIG9yZGVyOiB7YmFzZWxpbmVfcG9seV9vcmRlcn0iKQogICAgcHJpbnQoZiIgIE5vcm1hbGl6YXRpb24gbW9kZToge25vcm1hbGl6YXRpb25fbW9kZX0iKQogICAgcHJpbnQoKQogICAgcHJpbnQoIkZvciBkZXRhaWxlZCBvcHRpb24gZGVzY3JpcHRpb25zLCBjYWxsOiBwcmludF9iYXNlbGluZV9vcHRpb25zKCkiKQogICAgcHJpbnQoIj0iICogNzApCiAgICBwcmludCgpCiAgICAKICAgIHByaW50KCJTdGVwIDE6IElkZW50aWZ5aW5nIGJhc2VsaW5lIHdpbmRvd3MuLi4iLCBmbHVzaD1UcnVlKQogICAgYmFzZWxpbmVfd2luZG93cyA9IGlkZW50aWZ5X2Jhc2VsaW5lX3dpbmRvdyhkZiwgYmFzZWxpbmVfZW5kX3RpbWUpCiAgICBwcmludChmIiAgSWRlbnRpZmllZCBiYXNlbGluZSB3aW5kb3dzIGZvciB7bGVuKGJhc2VsaW5lX3dpbmRvd3MpfSB3ZWxscyIsIGZsdXNoPVRydWUpCiAgICB0b3RhbF9iYXNlbGluZV9wb2ludHMgPSBzdW0obGVuKGJ3KSBmb3IgYncgaW4gYmFzZWxpbmVfd2luZG93cy52YWx1ZXMoKSkKICAgIHByaW50KGYiICBUb3RhbCBiYXNlbGluZSBwb2ludHM6IHt0b3RhbF9iYXNlbGluZV9wb2ludHN9IiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgcHJpbnQoIlN0ZXAgMjogRml0dGluZyBiYXNlbGluZXMuLi4iLCBmbHVzaD1UcnVlKQogICAgYmFzZWxpbmVfZml0cyA9IGZpdF93ZWxsX2Jhc2VsaW5lcygKICAgICAgICBkZiwKICAgICAgICBiYXNlbGluZV9lbmRfdGltZT1iYXNlbGluZV9lbmRfdGltZSwKICAgICAgICBtZXRob2Q9YmFzZWxpbmVfbWV0aG9kLAogICAgICAgIGZyYWM9YmFzZWxpbmVfZnJhYywKICAgICAgICBwb2x5X29yZGVyPWJhc2VsaW5lX3BvbHlfb3JkZXIKICAgICkKICAgIHByaW50KGYiICBGaXR0ZWQgYmFzZWxpbmVzIGZvciB7bGVuKGJhc2VsaW5lX2ZpdHMpfSB3ZWxscyIsIGZsdXNoPVRydWUpCiAgICAKICAgIHByaW50KCJTdGVwIDM6IE5vcm1hbGl6aW5nIHdlbGxzLi4uIiwgZmx1c2g9VHJ1ZSkKICAgIG5vcm1fZGYgPSBub3JtYWxpemVfd2VsbHMoZGYsIGJhc2VsaW5lX2ZpdHMsIG5vcm1hbGl6YXRpb25fbW9kZT1ub3JtYWxpemF0aW9uX21vZGUpCiAgICBwcmludChmIiAgTm9ybWFsaXplZCB7bGVuKG5vcm1fZGYpfSBkYXRhIHBvaW50cyIsIGZsdXNoPVRydWUpCiAgICAKICAgIHByaW50KCJTdGVwIDQ6IEJ1aWxkaW5nIGNvbmRpdGlvbiBtYXAuLi4iLCBmbHVzaD1UcnVlKQogICAgY29uZGl0aW9uX21hcCA9IGJ1aWxkX2NvbmRpdGlvbl9tYXAoZGYsIGNvbmZpZz1jb25maWcpCiAgICBwcmludChmIiAgTWFwcGVkIHtsZW4oY29uZGl0aW9uX21hcCl9IHdlbGxzIHRvIGNvbmRpdGlvbnMiLCBmbHVzaD1UcnVlKQogICAgY29uZGl0aW9uX2NvdW50cyA9IHt9CiAgICBmb3Igd2VsbF9pZCwgY29uZGl0aW9uIGluIGNvbmRpdGlvbl9tYXAuaXRlbXMoKToKICAgICAgICBjb25kaXRpb25fY291bnRzW2NvbmRpdGlvbl0gPSBjb25kaXRpb25fY291bnRzLmdldChjb25kaXRpb24sIDApICsgMQogICAgcHJpbnQoZiIgIENvbmRpdGlvbiBkaXN0cmlidXRpb246IiwgZmx1c2g9VHJ1ZSkKICAgIGZvciBjb25kaXRpb24sIGNvdW50IGluIHNvcnRlZChjb25kaXRpb25fY291bnRzLml0ZW1zKCkpOgogICAgICAgIHByaW50KGYiICAgIHtjb25kaXRpb259OiB7Y291bnR9IHdlbGxzIiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgcHJpbnQoIlN0ZXAgNTogQ29tcHV0aW5nIGNvbmRpdGlvbiBzdGF0aXN0aWNzLi4uIiwgZmx1c2g9VHJ1ZSkKICAgIHN0YXRzX2RmID0gY29tcHV0ZV9jb25kaXRpb25fc3RhdGlzdGljcyhub3JtX2RmLCBjb25kaXRpb25fbWFwKQogICAgcHJpbnQoZiIgIENvbXB1dGVkIHN0YXRpc3RpY3MgZm9yIHtsZW4oc3RhdHNfZGYpfSBjb25kaXRpb24tdGltZXBvaW50IGNvbWJpbmF0aW9ucyIsIGZsdXNoPVRydWUpCiAgICAKICAgICMgU2F2ZSBvdXRwdXRzIGlmIG91dHB1dF9kaXIgaXMgcHJvdmlkZWQKICAgIGlmIG91dHB1dF9kaXI6CiAgICAgICAgZW5zdXJlX2RpcihvdXRwdXRfZGlyKQogICAgICAgIAogICAgICAgIHByaW50KCJTdGVwIDY6IFNhdmluZyBvdXRwdXRzLi4uIiwgZmx1c2g9VHJ1ZSkKICAgICAgICAKICAgICAgICAjIFNhdmUgbm9ybWFsaXplZCBkYXRhCiAgICAgICAgbm9ybV9jc3ZfcGF0aCA9IG9zLnBhdGguam9pbihvdXRwdXRfZGlyLCAibm9ybWFsaXplZF9kYXRhLmNzdiIpCiAgICAgICAgbm9ybV9kZi50b19jc3Yobm9ybV9jc3ZfcGF0aCwgaW5kZXg9RmFsc2UpCiAgICAgICAgcHJpbnQoZiIgIFNhdmVkIG5vcm1hbGl6ZWQgZGF0YSB0byB7bm9ybV9jc3ZfcGF0aH0iLCBmbHVzaD1UcnVlKQogICAgICAgIAogICAgICAgICMgU2F2ZSBjb25kaXRpb24gc3RhdGlzdGljcwogICAgICAgIHN0YXRzX2Nzdl9wYXRoID0gb3MucGF0aC5qb2luKG91dHB1dF9kaXIsICJjb25kaXRpb25fc3RhdGlzdGljcy5jc3YiKQogICAgICAgIHN0YXRzX2RmLnRvX2NzdihzdGF0c19jc3ZfcGF0aCwgaW5kZXg9RmFsc2UpCiAgICAgICAgcHJpbnQoZiIgIFNhdmVkIGNvbmRpdGlvbiBzdGF0aXN0aWNzIHRvIHtzdGF0c19jc3ZfcGF0aH0iLCBmbHVzaD1UcnVlKQogICAgICAgIAogICAgICAgICMgU2F2ZSBwbG90CiAgICAgICAgcGxvdF9wYXRoID0gb3MucGF0aC5qb2luKG91dHB1dF9kaXIsICJ0aW1lY291cnNlX3Bsb3QucG5nIikKICAgICAgICBwbG90X3RpbWVjb3Vyc2Uoc3RhdHNfZGYsIHNhdmVfcGF0aD1wbG90X3BhdGgsIGNvbmZpZz1jb25maWcpCiAgICAgICAgcHJpbnQoZiIgIFNhdmVkIHBsb3QgdG8ge3Bsb3RfcGF0aH0iLCBmbHVzaD1UcnVlKQogICAgCiAgICByZXR1cm4gbm9ybV9kZiwgc3RhdHNfZGYsIGJhc2VsaW5lX2ZpdHMKCgpkZWYgbWFpbigpOgogICAgIyBVc2UgdGhlIGRpcmVjdG9yeSB3aGVyZSB0aGlzIHNjcmlwdCBsaXZlcyBhcyB0aGUgd29ya2luZyBkaXJlY3RvcnkKICAgIHNjcmlwdF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgIG9zLmNoZGlyKHNjcmlwdF9kaXIpCgogICAgIyBGaW5kIEV4Y2VsIGZpbGVzIGluIHRoaXMgZGlyZWN0b3J5CiAgICBleGNlbF9maWxlcyA9IFsKICAgICAgICBmIGZvciBmIGluIG9zLmxpc3RkaXIoIi4iKQogICAgICAgIGlmIGYubG93ZXIoKS5lbmRzd2l0aCgiLnhsc3giKSBhbmQgbm90IGYuc3RhcnRzd2l0aCgifiQiKQogICAgXQoKICAgIGlmIG5vdCBleGNlbF9maWxlczoKICAgICAgICBwcmludCgiTm8gLnhsc3ggZmlsZXMgZm91bmQgaW4gdGhpcyBmb2xkZXIuIiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgIHN5cy5leGl0KDEpCiAgICAKICAgICMgVmFsaWRhdGUgZmlsZW5hbWUgZm9ybWF0cyBiZWZvcmUgcHJvY2Vzc2luZwogICAgcHJpbnQoIlN0YXJ0aW5nIHBsYXRlIHZpZXdlciBzY3JpcHQuLi4iLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoIlZhbGlkYXRpbmcgZmlsZW5hbWUgZm9ybWF0cy4uLiIsIGZsdXNoPVRydWUpCiAgICBpbnZhbGlkX2ZpbGVzID0gW10KICAgIGZvciBmbmFtZSBpbiBleGNlbF9maWxlczoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHZhbGlkYXRlX2ZpbGVuYW1lX2Zvcm1hdChmbmFtZSkKICAgICAgICBleGNlcHQgVmFsdWVFcnJvciBhcyBlOgogICAgICAgICAgICBpbnZhbGlkX2ZpbGVzLmFwcGVuZCgoZm5hbWUsIHN0cihlKSkpCiAgICAKICAgIGlmIGludmFsaWRfZmlsZXM6CiAgICAgICAgcHJpbnQoIlxu4p2MIEVSUk9SOiBJbnZhbGlkIGZpbGVuYW1lIGZvcm1hdChzKSBkZXRlY3RlZDoiLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAgICAgZm9yIGZuYW1lLCBlcnJvcl9tc2cgaW4gaW52YWxpZF9maWxlczoKICAgICAgICAgICAgcHJpbnQoZiJcbkZpbGU6IHtmbmFtZX0iLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAgICAgICAgIHByaW50KGVycm9yX21zZywgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgIHByaW50KCJcblBsZWFzZSByZW5hbWUgdGhlIGZpbGUocykgdG8gbWF0Y2ggdGhlIGV4cGVjdGVkIGZvcm1hdCBhbmQgcmVydW4gdGhlIHNjcmlwdC4iLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAgICAgc3lzLmV4aXQoMSkKICAgIAogICAgcHJpbnQoZiLinJMgQWxsIHtsZW4oZXhjZWxfZmlsZXMpfSBmaWxlKHMpIGhhdmUgdmFsaWQgZmlsZW5hbWUgZm9ybWF0cyIsIGZsdXNoPVRydWUpCgogICAgYWxsX3BsYXRlczogRGljdFtzdHIsIHBkLkRhdGFGcmFtZV0gPSB7fQogICAgY3N2X3Jvb3QgPSBvcy5wYXRoLmpvaW4oc2NyaXB0X2RpciwgImNzdiIpCiAgICAKICAgICMgTG9hZCBjb25maWd1cmF0aW9uIGZpbGUgZWFybHkgc28gaXQgY2FuIGJlIHVzZWQgZm9yIENTViBnZW5lcmF0aW9uCiAgICBjb25maWdfcGF0aCA9IG9zLnBhdGguam9pbihzY3JpcHRfZGlyLCAicGxhdGVfY29uZmlnLmpzb24iKQogICAgY29uZmlnID0gbG9hZF9jb25maWcoY29uZmlnX3BhdGgpCiAgICAKICAgICMgVHJhY2sgcGxhdGVfaWRzIGFuZCB0aGVpciBzb3VyY2UgZmlsZXMgdG8gZGV0ZWN0IGR1cGxpY2F0ZXMKICAgIHBsYXRlX2lkX3RvX2ZpbGVzOiBEaWN0W3N0ciwgTGlzdFtzdHJdXSA9IHt9CiAgICAjIFRyYWNrIHBsYXRlX2lkIHRvIG9yaWdpbmFsIGZpbGVuYW1lIG1hcHBpbmcKICAgIHBsYXRlX2lkX3RvX2ZpbGVuYW1lOiBEaWN0W3N0ciwgc3RyXSA9IHt9CgogICAgZm9yIGlkeCwgZm5hbWUgaW4gZW51bWVyYXRlKGV4Y2VsX2ZpbGVzLCAxKToKICAgICAgICBwcmludChmIlxuW3tpZHh9L3tsZW4oZXhjZWxfZmlsZXMpfV0gUHJvY2Vzc2luZyB7Zm5hbWV9Li4uIiwgZmx1c2g9VHJ1ZSkKICAgICAgICBwYXRoID0gb3MucGF0aC5qb2luKHNjcmlwdF9kaXIsIGZuYW1lKQogICAgICAgIHRyeToKICAgICAgICAgICAgbG9uZ19kZiA9IHBhcnNlX3BsYXRlX2ZpbGUocGF0aCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiRXJyb3IgcGFyc2luZyB7Zm5hbWV9OiB7ZX0iLCBmaWxlPXN5cy5zdGRlcnIsIGZsdXNoPVRydWUpCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHBsYXRlX2lkID0gbG9uZ19kZlsicGxhdGVfaWQiXS5pbG9jWzBdCiAgICAgICAgCiAgICAgICAgIyBUcmFjayB3aGljaCBmaWxlcyBwcm9kdWNlIHdoaWNoIHBsYXRlX2lkCiAgICAgICAgaWYgcGxhdGVfaWQgbm90IGluIHBsYXRlX2lkX3RvX2ZpbGVzOgogICAgICAgICAgICBwbGF0ZV9pZF90b19maWxlc1twbGF0ZV9pZF0gPSBbXQogICAgICAgIHBsYXRlX2lkX3RvX2ZpbGVzW3BsYXRlX2lkXS5hcHBlbmQoZm5hbWUpCiAgICAgICAgCiAgICAgICAgIyBUcmFjayBmaWxlbmFtZSBmb3IgdGhpcyBwbGF0ZV9pZCAodXNlIGZpcnN0IG9jY3VycmVuY2UpCiAgICAgICAgaWYgcGxhdGVfaWQgbm90IGluIHBsYXRlX2lkX3RvX2ZpbGVuYW1lOgogICAgICAgICAgICBwbGF0ZV9pZF90b19maWxlbmFtZVtwbGF0ZV9pZF0gPSBmbmFtZQogICAgICAgIAogICAgICAgICMgSWYgdGhpcyBwbGF0ZV9pZCBhbHJlYWR5IGV4aXN0cywgbWFrZSBpdCB1bmlxdWUgYnkgYXBwZW5kaW5nIGZpbGVuYW1lCiAgICAgICAgaWYgcGxhdGVfaWQgaW4gYWxsX3BsYXRlczoKICAgICAgICAgICAgIyBUaGlzIGlzIGEgZHVwbGljYXRlIC0gd2UnbGwgaGFuZGxlIGl0IGJlbG93CiAgICAgICAgICAgIHBhc3MKICAgICAgICBlbHNlOgogICAgICAgICAgICBhbGxfcGxhdGVzW3BsYXRlX2lkXSA9IGxvbmdfZGYKICAgICAgICAgICAgd3JpdGVfY3N2c19mb3JfcGxhdGUobG9uZ19kZiwgY3N2X3Jvb3QsIGNvbmZpZywgZm5hbWUpCgogICAgIyBDaGVjayBmb3IgZHVwbGljYXRlcyBhbmQgd2FybgogICAgZHVwbGljYXRlc19mb3VuZCA9IEZhbHNlCiAgICBmb3IgcGxhdGVfaWQsIGZpbGVzIGluIHBsYXRlX2lkX3RvX2ZpbGVzLml0ZW1zKCk6CiAgICAgICAgaWYgbGVuKGZpbGVzKSA+IDE6CiAgICAgICAgICAgIGR1cGxpY2F0ZXNfZm91bmQgPSBUcnVlCiAgICAgICAgICAgIHByaW50KGYiXG7imqDvuI8gIFdBUk5JTkc6IER1cGxpY2F0ZSBkYXRhc2V0IGRldGVjdGVkISIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICAgICAgcHJpbnQoZiIgICBQbGF0ZSBJRCAne3BsYXRlX2lkfScgaXMgcHJvZHVjZWQgYnkgbXVsdGlwbGUgZmlsZXM6IiwgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgICAgICBmb3IgZiBpbiBmaWxlczoKICAgICAgICAgICAgICAgIHByaW50KGYiICAgICAtIHtmfSIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICAgICAgcHJpbnQoZiIgICBQbGVhc2UgZGVsZXRlIHRoZSBkdXBsaWNhdGUgZmlsZShzKSBhbmQgcmVydW4gdGhlIHNjcmlwdC4iLCBmaWxlPXN5cy5zdGRlcnIpCiAgICAKICAgIGlmIGR1cGxpY2F0ZXNfZm91bmQ6CiAgICAgICAgcHJpbnQoIlxu4pqg77iPICBFUlJPUjogRHVwbGljYXRlIGRhdGFzZXRzIGZvdW5kLiBQbGVhc2UgZGVsZXRlIGR1cGxpY2F0ZXMgYW5kIHJlcnVuLiIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBwcmludCgiICAgT25seSB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBlYWNoIGR1cGxpY2F0ZSB3aWxsIGJlIGluY2x1ZGVkLiIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBzeXMuZXhpdCgxKQoKICAgIGlmIG5vdCBhbGxfcGxhdGVzOgogICAgICAgIHByaW50KCJObyBwbGF0ZXMgd2VyZSBzdWNjZXNzZnVsbHkgcGFyc2VkLiIsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBzeXMuZXhpdCgxKQogICAgCiAgICBwcmludChmIlxu4pyTIFN1Y2Nlc3NmdWxseSBsb2FkZWQge2xlbihhbGxfcGxhdGVzKX0gZGF0YXNldChzKToiLCBmbHVzaD1UcnVlKQogICAgZm9yIHBsYXRlX2lkIGluIHNvcnRlZChhbGxfcGxhdGVzLmtleXMoKSk6CiAgICAgICAgcHJpbnQoZiIgICAtIHtwbGF0ZV9pZH0iLCBmbHVzaD1UcnVlKQoKICAgICMgQ29uZmlnIGFscmVhZHkgbG9hZGVkIGFib3ZlCgogICAgIyBCdWlsZCBKU09OIGZvciB2aWV3ZXIKICAgIHdlYl9kaXIgPSBvcy5wYXRoLmpvaW4oc2NyaXB0X2RpciwgIndlYiIpCiAgICBlbnN1cmVfZGlyKHdlYl9kaXIpCiAgICBqc29uX3BhdGggPSBvcy5wYXRoLmpvaW4od2ViX2RpciwgInZpZXdlcl9kYXRhLmpzb24iKQogICAgYnVpbGRfdmlld2VyX2pzb24oYWxsX3BsYXRlcywganNvbl9wYXRoLCBjb25maWcsIHBsYXRlX2lkX3RvX2ZpbGVuYW1lKQoKICAgICMgV3JpdGUgSFRNTAogICAgaHRtbF9wYXRoID0gb3MucGF0aC5qb2luKHdlYl9kaXIsICJpbmRleC5odG1sIikKICAgIHdyaXRlX2h0bWwoaHRtbF9wYXRoKQoKICAgICMgQ3JlYXRlIGRvdWJsZS1jbGlja2FibGUgd2ViLmNvbW1hbmQgZmlsZQogICAgd2ViX2NvbW1hbmRfcGF0aCA9IHdyaXRlX3dlYl9jb21tYW5kKHNjcmlwdF9kaXIsIHdlYl9kaXIpCgogICAgcHJpbnQoIkRvbmUuIiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KCJHZW5lcmF0ZWQ6IiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KGYiICBDU1ZzIGluOiB7Y3N2X3Jvb3R9IiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KGYiICBXZWIgdmlld2VyOiB7aHRtbF9wYXRofSIsIGZsdXNoPVRydWUpCiAgICBwcmludChmIiAgV2ViIGxhdW5jaGVyOiB7d2ViX2NvbW1hbmRfcGF0aH0iLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoIlxuVG8gdmlldyB0aGUgcGxhdGVzOiIsIGZsdXNoPVRydWUpCiAgICBwcmludChmIiAgRG91YmxlLWNsaWNrICd3ZWIuY29tbWFuZCcgaW4gRmluZGVyLCBvciIsIGZsdXNoPVRydWUpCiAgICBwcmludChmIiAgUnVuOiAuL3dlYi5jb21tYW5kIiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KCJUaGUgYnJvd3NlciB3aWxsIG9wZW4gYXV0b21hdGljYWxseS4iLCBmbHVzaD1UcnVlKQoKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICBtYWluKCk="
		
		-- Decode and execute the Python code
		do shell script "cd " & quoted form of folderPath & " && echo " & quoted form of pythonCodeBase64 & " | base64 -d | python3"
		
		display notification "Plate viewer script completed successfully!" with title "Plate Viewer"
		
	on error errMsg
		display alert "Error" message errMsg
	end try
	
	return input
end run
